/**
 * Ders Deƒüerlendirme Sistemi
 * -------------------------
 * Bu script ders deƒüerlendirme kriterlerini ve √∂ƒürenci notlarƒ±nƒ±
 * y√∂netmek i√ßin kullanƒ±lan web uygulamasƒ±nƒ± kontrol eder.
 * 
 * @version 2.0.0
 * @author Ders Deƒüerlendirme Sistemi Geli≈ütirme Ekibi
 */

'use strict';

// =====================================================
// SABITLER VE GLOBAL DEƒûI≈ûKENLER
// =====================================================

// =====================================================
// IndexedDB OTOMATIK KAYIT Sƒ∞STEMƒ∞
// =====================================================

/**
 * IndexedDB tabanlƒ± otomatik kayƒ±t y√∂netimi
 * Export/Import sistemini kullanarak tam veri tutarlƒ±lƒ±ƒüƒ± saƒülar
 */
class MudekAutoSaveManager {
    constructor() {
        this.dbName = 'MudekCourseDatabase';
        this.dbVersion = 1;
        this.storeName = 'courseData';
        this.db = null;
        this.isInitialized = false;
        this.lastSaveTime = null;
        this.autoSaveInterval = null;
        this.saveInProgress = false;
        this.floatingButton = null;
        this.clearButton = null;
        
        // Event listeners i√ßin
        this.changeDetectors = new Set();
        this.hasUnsavedChanges = false;
        
        // Timer i√ßin
        this.nextSaveTime = null;
        this.timerInterval = null;
        this.autoSaveIntervalMs = 10000; // 10 saniye
        
        // Electron ortamƒ± kontrol√º
        this.isElectron = typeof window !== 'undefined' && window.isElectron;
        this.electronFilePath = null;
        
        // Debug: Ortam kontrol√º
        console.log('üîç Ortam kontrol√º:', {
            isElectron: this.isElectron,
            hasElectronAPI: typeof window.electronAPI !== 'undefined',
            userAgent: navigator.userAgent.includes('Electron')
        });
        
        this.init();
    }

    /**
     * G√ºvenli toast mesajƒ± g√∂ster (hem browser hem Electron)
     */
    showToastSafe(message, type = 'info', duration = 3000) {
        try {
            if (this.isElectron && typeof window.electronToastFunction === 'function') {
                // Electron ortamƒ±nda g√ºvenli toast fonksiyonu
                window.electronToastFunction(message, type, duration);
            } else if (this.isElectron && typeof window.electronToast === 'function') {
                // Electron preload toast
                window.electronToast(message, type, duration);
            } else if (typeof window.showToast === 'function') {
                // Browser ortamƒ±nda normal toast
                window.showToast(message, type, duration);
            } else {
                // Son fallback
                console.log(`[${type.toUpperCase()}] ${message}`);
            }
        } catch (error) {
            console.error('Toast g√∂sterme hatasƒ±:', error);
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
    }

    showToast(message, type = 'info', duration = 3000) {
        // Uyumluluk i√ßin alias
        this.showToastSafe(message, type, duration);
    }

    /**
     * Otomatik kayƒ±t sistemini ba≈ülat
     */
    async init() {
        console.log('üöÄ MudekAutoSaveManager.init() ba≈ülatƒ±lƒ±yor...');
        try {
            // Her iki ortamda da IndexedDB'yi ba≈ülat
            console.log('üîÑ IndexedDB a√ßƒ±lƒ±yor...');
            this.db = await this.openDatabase();
            console.log('‚úÖ IndexedDB sistemi ba≈ülatƒ±ldƒ±');
            
            if (this.isElectron) {
                // Electron ortamƒ±nda ek olarak dosya sistemi de ba≈ülat
                console.log('üîÑ Electron dosya sistemi ba≈ülatƒ±lƒ±yor...');
                await this.initElectronFileSystem();
                console.log('‚úÖ Electron dosya sistemi ek olarak ba≈ülatƒ±ldƒ±');
            }
            
            this.isInitialized = true;
            console.log('‚úÖ Sistem inicializasyonu tamamlandƒ±');
            
            // Floating butonlarƒ± olu≈ütur (ortama g√∂re farklƒ±)
            console.log('üîÑ Floating butonlar olu≈üturuluyor...');
            this.createFloatingButtons();
            console.log('‚úÖ Floating butonlar olu≈üturuldu');
            
            // Otomatik kayƒ±t ba≈ülat (10 saniye)
            console.log('üîÑ Otomatik kayƒ±t ba≈ülatƒ±lƒ±yor...');
            this.startAutoSave();
            console.log('‚úÖ Otomatik kayƒ±t ba≈ülatƒ±ldƒ±');
            
            // Sayfa y√ºklendiƒüinde veriyi restore et
            console.log('üîÑ Veri restore ediliyor...');
            await this.autoRestore();
            console.log('‚úÖ Veri restore edildi');
            
            // Change detection ba≈ülat
            console.log('üîÑ Change detection ba≈ülatƒ±lƒ±yor...');
            this.setupChangeDetection();
            console.log('‚úÖ Change detection ba≈ülatƒ±ldƒ±');
            
            console.log('üéâ MudekAutoSaveManager ba≈üarƒ±yla ba≈ülatƒ±ldƒ±!');
            
        } catch (error) {
            console.error('‚ùå Otomatik kayƒ±t sistemi ba≈ülatma hatasƒ±:', error);
            console.error('‚ùå Hata detaylarƒ±:', error.stack);
            // Fallback: localStorage kulun
            this.fallbackToLocalStorage();
        }
    }

    /**
     * Electron dosya sistemi ba≈ülatma
     */
    async initElectronFileSystem() {
        if (!window.electronAPI) {
            throw new Error('Electron API bulunamadƒ±');
        }
        
        try {
            const pathResult = await window.electronAPI.getAutoSavePath();
            if (pathResult.success) {
                this.electronFilePath = pathResult.filePath;
                this.electronBackupDir = pathResult.backupDir;
                console.log('üìÅ Electron otomatik kayƒ±t dosyasƒ±:', this.electronFilePath);
                console.log('üìÇ Yedek klas√∂r√º konumu: Documents/MUDEK Backups');
            } else {
                throw new Error(pathResult.error || 'Dosya yolu alƒ±namadƒ±');
            }
        } catch (error) {
            throw new Error('Electron dosya sistemi ba≈ülatƒ±lamadƒ±: ' + error.message);
        }
    }

    /**
     * IndexedDB veritabanƒ±nƒ± a√ß
     */
    openDatabase() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.dbName, this.dbVersion);
            
            request.onerror = () => reject(request.error);
            request.onsuccess = () => resolve(request.result);
            
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                
                // Store olu≈ütur
                if (!db.objectStoreNames.contains(this.storeName)) {
                    const store = db.createObjectStore(this.storeName, { keyPath: 'id' });
                    store.createIndex('timestamp', 'timestamp', { unique: false });
                    store.createIndex('type', 'type', { unique: false });
                }
            };
        });
    }

    /**
     * Veriyi kaydet (Electron dosya sistemi veya IndexedDB)
     */
    async saveData(manual = false) {
        if (!this.isInitialized || this.saveInProgress) {
            return false;
        }

        try {
            this.saveInProgress = true;
            this.updateFloatingButton('saving');

            // Mevcut export sistemini kullan
            const exportData = createExportData();
            
            let result;
            // Otomatik kayƒ±t: Electron'da dosya sistemi, Browser'da IndexedDB
            // Manuel kayƒ±t: Her iki sistemde de √ßalƒ±≈üƒ±r
            if (this.isElectron && !manual) {
                // Otomatik kayƒ±t: Electron dosya sistemi (daha g√ºvenli)
                result = await this.saveToElectronFile(exportData, false);
            } else if (this.isElectron && manual) {
                // Manuel kayƒ±t: Kullanƒ±cƒ± buton ile hangisini se√ßerse
                result = true; // Buton methodlarƒ± kendi kayƒ±tlarƒ±nƒ± yapar
                return result;
            } else {
                // Browser ortamƒ±nda: IndexedDB kullan
                result = await this.saveToIndexedDB(exportData, manual);
            }
            
            if (result) {
                this.lastSaveTime = new Date();
                this.hasUnsavedChanges = false;
                this.updateFloatingButton('saved');
                
                // Timer'ƒ± sƒ±fƒ±rla
                this.restartTimer();
                
                // Clear button status'unu g√ºncelle
                this.updateClearButtonStatus();
                
                console.log(`üíæ ${manual ? 'Manuel' : 'Otomatik'} kayƒ±t tamamlandƒ±:`, this.lastSaveTime);
            }
            
            return result;
            
        } catch (error) {
            console.error('‚ùå Kayƒ±t hatasƒ±:', error);
            this.updateFloatingButton('error');
            
            if (manual) {
                this.showToast('‚ùå Kayƒ±t i≈ülemi ba≈üarƒ±sƒ±z!', 'error');
            }
            
            return false;
        } finally {
            this.saveInProgress = false;
        }
    }

    /**
     * Electron dosya sistemine kaydet
     */
    async saveToElectronFile(exportData, manual = false) {
        try {
            const saveData = {
                content: exportData,
                type: manual ? 'manual' : 'auto'
            };
            
            const result = await window.electronAPI.saveAutoData(saveData);
            
            if (result.success) {
                // Dosya yolunu kƒ±salt (sadece dosya adƒ± ve 2 √ºst klas√∂r)
                const shortPath = this.getShortFilePath(result.filePath);
                
                if (manual) {
                    this.showToast(
                        `üíæ Veriler ba≈üarƒ±yla kaydedildi!\n\nüìÅ Konum: ${shortPath}\n\nüí° ƒ∞pucu: Men√º > Dosya > Yedek Klas√∂r√ºn√º A√ß ile eri≈üebilirsiniz`, 
                        'success', 
                        8000
                    );
                } else {
                    console.log('üìÅ Otomatik kayƒ±t:', shortPath);
                }
                return true;
            } else {
                throw new Error(result.error || 'Electron dosya kayƒ±t hatasƒ±');
            }
        } catch (error) {
            console.error('‚ùå Electron dosya kayƒ±t hatasƒ±:', error);
            if (manual) {
                this.showToast('‚ùå Dosya kayƒ±t hatasƒ±: ' + error.message, 'error');
            }
            return false;
        }
    }

    /**
     * IndexedDB'ye kaydet
     */
    async saveToIndexedDB(exportData, manual = false) {
        try {
            const saveRecord = {
                id: 'current',
                data: exportData,
                timestamp: new Date().toISOString(),
                type: manual ? 'manual' : 'auto',
                version: this.dbVersion
            };

            const transaction = this.db.transaction([this.storeName], 'readwrite');
            const store = transaction.objectStore(this.storeName);
            
            await this.promisifyRequest(store.put(saveRecord));
            
            if (manual) {
                this.showToast('üíæ Veriler ba≈üarƒ±yla kaydedildi!', 'success');
            }
            return true;
        } catch (error) {
            console.error('‚ùå IndexedDB kayƒ±t hatasƒ±:', error);
            if (manual) {
                this.showToast('‚ùå IndexedDB kayƒ±t hatasƒ±!', 'error');
            }
            return false;
        }
    }

    /**
     * Dosya yolunu kƒ±salt (kullanƒ±cƒ± dostu g√∂r√ºn√ºm i√ßin)
     */
    getShortFilePath(fullPath) {
        if (!fullPath) return '';
        
        const normalized = fullPath.replace(/\\/g, '/');
        
        // MUDEK Backups klas√∂r√ºn√º √∂zel olarak g√∂ster
        if (normalized.includes('MUDEK Backups')) {
            const parts = normalized.split('/');
            const mudekIndex = parts.findIndex(part => part === 'MUDEK Backups');
            if (mudekIndex >= 0) {
                const relevantParts = parts.slice(mudekIndex);
                return 'Documents/' + relevantParts.join('/');
            }
        }
        
        const parts = normalized.split('/');
        if (parts.length <= 3) {
            return fullPath;
        }
        
        // Son 3 par√ßayƒ± al: ...parent/folder/file.json
        const shortParts = parts.slice(-3);
        return '...' + '/' + shortParts.join('/');
    }

    /**
     * Veriyi y√ºkle (Electron dosya sistemi veya IndexedDB)
     */
    async loadData() {
        if (!this.isInitialized) {
            return null;
        }

        try {
            if (this.isElectron) {
                return await this.loadFromElectronFile();
            } else {
                return await this.loadFromIndexedDB();
            }
        } catch (error) {
            console.error('‚ùå Veri y√ºkleme hatasƒ±:', error);
            return null;
        }
    }

    /**
     * Electron dosya sisteminden y√ºkle
     */
    async loadFromElectronFile() {
        try {
            const result = await window.electronAPI.loadAutoData();
            
            if (result.success && result.data) {
                const shortPath = this.getShortFilePath(result.filePath);
                console.log('üìñ Electron dosyasƒ±ndan veri y√ºklendi:', shortPath);
                console.log('üìÖ Kayƒ±t zamanƒ±:', new Date(result.timestamp));
                return result.data;
            }
            
            return null;
        } catch (error) {
            console.error('‚ùå Electron dosya y√ºkleme hatasƒ±:', error);
            return null;
        }
    }

    /**
     * IndexedDB'den y√ºkle
     */
    async loadFromIndexedDB() {
        try {
            const transaction = this.db.transaction([this.storeName], 'readonly');
            const store = transaction.objectStore(this.storeName);
            const request = store.get('current');
            
            const result = await this.promisifyRequest(request);
            
            if (result && result.data) {
                console.log('üìñ IndexedDB\'den veri y√ºklendi:', new Date(result.timestamp));
                return result.data;
            }
            
            return null;
        } catch (error) {
            console.error('‚ùå IndexedDB veri y√ºkleme hatasƒ±:', error);
            return null;
        }
    }

    /**
     * Sayfa y√ºklendiƒüinde otomatik veri restore
     */
    async autoRestore() {
        // Sadece veri yoksa restore et
        if (APP_STATE.courseData && Object.keys(APP_STATE.courseData).length > 0) {
            console.log('üîÑ Mevcut veri bulundu, otomatik restore atlandƒ±');
            return;
        }

        const savedData = await this.loadData();
        if (savedData) {
            try {
                // Mevcut import sistemini kullan - jsonContent'e veriyi yerle≈ütir ve applyJsonData √ßaƒüƒ±r
                if (typeof jsonContent !== 'undefined' && jsonContent) {
                    jsonContent.value = JSON.stringify(savedData, null, 2);
                    
                    // applyJsonData fonksiyonunu √ßaƒüƒ±r
                    if (typeof applyJsonData === 'function') {
                        applyJsonData();
                        this.showToast('üìñ Kaydedilmi≈ü veriler otomatik y√ºklendi', 'success');
                    }
                } else {
                    // Direkt restore (jsonContent yoksa)
                    this.directRestore(savedData);
                }
                
            } catch (error) {
                console.error('‚ùå Otomatik restore hatasƒ±:', error);
                this.showToast('‚ö†Ô∏è Kaydedilmi≈ü veri y√ºklenirken hata olu≈ütu', 'warning');
            }
        }
    }

    /**
     * Direkt veri restore (jsonContent olmadan)
     */
    directRestore(savedData) {
        APP_STATE.courseData = savedData;
        
        if (savedData.dersOgrenme√áiktilari && Array.isArray(savedData.dersOgrenme√áiktilari)) {
            APP_STATE.learningOutcomes = savedData.dersOgrenme√áiktilari;
            if (typeof renderOutcomes === 'function') renderOutcomes();
        }
        
        if (savedData.programCiktilari && Array.isArray(savedData.programCiktilari)) {
            APP_STATE.programOutcomes = savedData.programCiktilari;
            if (typeof renderProgramOutcomes === 'function') renderProgramOutcomes();
        }
        
        if (typeof updateCourseInfo === 'function') updateCourseInfo();
        if (typeof renderCourseDetails === 'function') renderCourseDetails();
        
        // Assessment tree
        if (savedData.degerlendirmeAgaci) {
            APP_STATE.assessmentTree = savedData.degerlendirmeAgaci;
        } else if (savedData.assessmentTree) {
            APP_STATE.assessmentTree = savedData.assessmentTree;
        }
        
        // √ñƒürenci verileri
        if (savedData.ogrenciler && Array.isArray(savedData.ogrenciler)) {
            APP_STATE.studentData = savedData.ogrenciler.map(student => ({
                studentId: student.ogrenciNo,
                name: student.ad,
                surname: student.soyad,
                status: student.durum || 'Aktif',
                grup: student.grup || 'A',
                email: student.email || '',
                tcKimlik: student.tcKimlik || '',
                telefon: student.telefon || ''
            }));
        }
        
        // Not verileri
        if (savedData.ogrenciNotlari && typeof savedData.ogrenciNotlari === 'object') {
            APP_STATE.gradesData = {};
            if (typeof loadStudentGradesNewFormat === 'function') {
                loadStudentGradesNewFormat(savedData);
            }
        }
        
        if (typeof renderTree === 'function') renderTree();
        
        this.showToast('üìñ Kaydedilmi≈ü veriler otomatik y√ºklendi', 'success');
    }

    /**
     * Otomatik kayƒ±t sistemini ba≈ülat
     */
    startAutoSave() {
        if (this.autoSaveInterval) {
            clearInterval(this.autoSaveInterval);
        }
        if (this.timerInterval) {
            clearInterval(this.timerInterval);
        }
        
        this.autoSaveInterval = setInterval(() => {
            if (this.hasUnsavedChanges && APP_STATE.courseData) {
                this.saveData(false);
            }
        }, this.autoSaveIntervalMs);
        
        // Timer'ƒ± ba≈ülat
        this.startTimer();
        
        console.log('‚è∞ Otomatik kayƒ±t sistemi ba≈ülatƒ±ldƒ± (10 saniye aralƒ±k)');
    }

    /**
     * Timer'ƒ± ba≈ülat
     */
    startTimer() {
        this.nextSaveTime = Date.now() + this.autoSaveIntervalMs;
        
        this.timerInterval = setInterval(() => {
            this.updateTimer();
        }, 100); // Her 100ms'de g√ºncelle (daha smooth)
        
        this.updateTimer();
    }

    /**
     * Timer'ƒ± g√ºncelle
     */
    updateTimer() {
        const timerElement = this.floatingButton?.querySelector('.save-timer');
        if (!timerElement) return;

        const now = Date.now();
        const timeLeft = Math.max(0, this.nextSaveTime - now);
        const secondsLeft = Math.ceil(timeLeft / 1000);

        if (this.hasUnsavedChanges && secondsLeft > 0) {
            timerElement.textContent = `${secondsLeft}s`;
            timerElement.classList.add('show');
            
            // Son 3 saniyede pulse efekti
            if (secondsLeft <= 3) {
                timerElement.classList.add('pulse');
            } else {
                timerElement.classList.remove('pulse');
            }
        } else {
            timerElement.classList.remove('show', 'pulse');
        }

        // Timer sƒ±fƒ±rlandƒ±ƒüƒ±nda yeni timer ba≈ülat
        if (timeLeft <= 0) {
            this.nextSaveTime = Date.now() + this.autoSaveIntervalMs;
        }
    }

    /**
     * Timer'ƒ± yeniden ba≈ülat (deƒüi≈üiklik olduƒüunda)
     */
    restartTimer() {
        this.nextSaveTime = Date.now() + this.autoSaveIntervalMs;
        this.updateTimer();
    }

    /**
     * Temizle butonunun status'unu g√ºncelle
     */
    async updateClearButtonStatus() {
        if (!this.clearButton) return;

        const statusElement = this.clearButton.querySelector('.clear-status');
        if (!statusElement) return;

        try {
            let hasData = false;
            let dataDetails = [];
            
            // Electron dosya kontrol√º (√∂nce bu kontrol edilir)
            if (this.isElectron) {
                try {
                    const result = await window.electronAPI.checkAutoDataExists();
                    if (result.success && result.exists) {
                        hasData = true;
                        const size = (result.size / 1024).toFixed(1);
                        const shortPath = this.getShortFilePath(result.filePath);
                        dataDetails.push(`üìÅ Yedek Dosyasƒ± (${size} KB)`);
                    }
                } catch (error) {
                    console.error('‚ùå Electron dosya kontrol√º hatasƒ±:', error);
                }
            } else {
                // Browser ortamƒ±nda IndexedDB kontrol√º
                const hasIndexedDBData = await this.checkIndexedDBData();
                if (hasIndexedDBData) {
                    hasData = true;
                    dataDetails.push('üóÑÔ∏è IndexedDB');
                }
            }
            
            // LocalStorage kontrol√º (her ortamda)
            const hasLocalStorageData = this.checkLocalStorageData();
            if (hasLocalStorageData) {
                hasData = true;
                const lsKeys = this.getLocalStorageDataKeys();
                dataDetails.push(`üíæ LocalStorage (${lsKeys.length})`);
            }
            
            if (hasData) {
                // Temizlenecek veri var
                statusElement.textContent = dataDetails.length > 0 ? 
                    `Veri mevcut (${dataDetails.length})` : 'Veri mevcut';
                statusElement.title = dataDetails.join('\n');
                this.clearButton.style.background = 'linear-gradient(135deg, #ff6b6b, #ee5a52)';
                this.clearButton.style.opacity = '0.85';
            } else {
                // Temizlenecek veri yok
                statusElement.textContent = 'Veri yok';
                statusElement.title = 'Temizlenecek veri bulunamadƒ±';
                this.clearButton.style.background = 'linear-gradient(135deg, #95a5a6, #7f8c8d)';
                this.clearButton.style.opacity = '0.6';
            }
        } catch (error) {
            console.error('‚ùå Clear button status g√ºncellemesi hatasƒ±:', error);
            statusElement.textContent = 'Kontrol hatasƒ±';
        }
    }

    /**
     * IndexedDB'de veri olup olmadƒ±ƒüƒ±nƒ± kontrol et
     */
    async checkIndexedDBData() {
        if (!this.isInitialized || !this.db) return false;

        try {
            const transaction = this.db.transaction([this.storeName], 'readonly');
            const store = transaction.objectStore(this.storeName);
            const request = store.get('current');
            
            const result = await this.promisifyRequest(request);
            return result && result.data;
        } catch (error) {
            console.error('‚ùå IndexedDB veri kontrol hatasƒ±:', error);
            return false;
        }
    }

    /**
     * LocalStorage'da veri olup olmadƒ±ƒüƒ±nƒ± kontrol et
     */
    checkLocalStorageData() {
        try {
            const backupData = localStorage.getItem('mudek-course-data-backup');
            const oldData = localStorage.getItem('mudek-course-data');
            const courseData = localStorage.getItem('courseData');
            const studentData = localStorage.getItem('studentData');
            
            return !!(backupData || oldData || courseData || studentData);
        } catch (error) {
            console.error('‚ùå LocalStorage veri kontrol hatasƒ±:', error);
            return false;
        }
    }

    /**
     * LocalStorage'daki veri key'lerini d√∂nd√ºr
     */
    getLocalStorageDataKeys() {
        const keys = ['mudek-course-data-backup', 'mudek-course-data', 'courseData', 'studentData'];
        const foundKeys = [];
        
        try {
            keys.forEach(key => {
                if (localStorage.getItem(key)) {
                    foundKeys.push(key);
                }
            });
        } catch (error) {
            console.error('‚ùå LocalStorage key kontrol hatasƒ±:', error);
        }
        
        return foundKeys;
    }

    /**
     * Change detection sistemi
     */
    setupChangeDetection() {
        // DOM deƒüi≈üikliklerini izle
        const treeContainer = document.getElementById('treeContainer');
        if (treeContainer) {
            const observer = new MutationObserver(() => {
                this.hasUnsavedChanges = true;
                this.updateFloatingButton('unsaved');
                this.restartTimer();
            });
            
            observer.observe(treeContainer, {
                childList: true,
                subtree: true,
                attributes: true,
                attributeFilter: ['data-weight', 'data-points']
            });
        }
        
        // Input deƒüi≈üikliklerini izle
        document.addEventListener('input', (e) => {
            if (e.target.matches('input, textarea, select')) {
                this.hasUnsavedChanges = true;
                this.updateFloatingButton('unsaved');
                this.restartTimer();
            }
        });
        
        // Form submit olaylarƒ±nƒ± izle [[memory:146162273345585106]]
        document.addEventListener('submit', (e) => {
            e.preventDefault();
            this.hasUnsavedChanges = true;
            this.updateFloatingButton('unsaved');
            this.restartTimer();
        });
    }

    /**
     * Ortama g√∂re floating butonlarƒ± olu≈ütur
     */
    createFloatingButtons() {
        if (this.isElectron) {
            // Electron ortamƒ±nda 2 buton: Tek Kaydet (hem dosya hem DB) + Temizle
            this.createUnifiedSaveButton();
            this.createClearButton();
        } else {
            // Browser ortamƒ±nda 2 buton: IndexedDB Kaydet + Temizle
            this.createIndexedDBSaveButton();
            this.createClearButton();
        }
    }

    /**
     * Electron dosya kayƒ±t butonu olu≈ütur
     */
    createElectronSaveButton() {
        this.electronSaveButton = document.createElement('div');
        this.electronSaveButton.id = 'electronSaveFloatingButton';
        this.electronSaveButton.innerHTML = `
            <div class="save-button-content">
                <div class="save-top-row">
                    <i class="fas fa-folder-open"></i>
                    <span class="save-text">Dosyaya</span>
                    <span class="save-timer"></span>
                </div>
                <div class="save-status">Hazƒ±r</div>
            </div>
        `;
        
        this.electronSaveButton.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 12px 16px;
            box-shadow: 0 4px 20px rgba(33, 150, 243, 0.4);
            cursor: pointer;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 500;
            font-size: 13px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
            backdrop-filter: blur(10px);
            min-width: 100px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        `;

        document.body.appendChild(this.electronSaveButton);
        
        this.electronSaveButton.addEventListener('click', (e) => {
            e.preventDefault();
            this.saveToElectronFileManual();
        });
        
        this.floatingButton = this.electronSaveButton; // Uyumluluk i√ßin
    }

    /**
     * Birle≈üik kayƒ±t butonu olu≈ütur (Electron i√ßin - hem dosya hem DB)
     */
    createUnifiedSaveButton() {
        this.unifiedSaveButton = document.createElement('div');
        this.unifiedSaveButton.id = 'unifiedSaveFloatingButton';
        this.unifiedSaveButton.innerHTML = `
            <div class="save-button-content">
                <div class="save-top-row">
                    <i class="fas fa-save"></i>
                    <span class="save-text">Kaydet</span>
                    <span class="save-timer"></span>
                </div>
                <div class="save-status">Hazƒ±r</div>
            </div>
        `;
        
        this.unifiedSaveButton.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 12px 16px;
            box-shadow: 0 4px 20px rgba(76, 175, 80, 0.4);
            cursor: pointer;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 500;
            font-size: 13px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
            backdrop-filter: blur(10px);
            min-width: 100px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        `;

        document.body.appendChild(this.unifiedSaveButton);
        
        this.unifiedSaveButton.addEventListener('click', (e) => {
            e.preventDefault();
            this.saveUnifiedManual();
        });
        
        this.floatingButton = this.unifiedSaveButton; // Ana buton olarak ata
        console.log('üíæ Birle≈üik kayƒ±t butonu olu≈üturuldu (Electron)');
    }

    /**
     * IndexedDB kayƒ±t butonu olu≈ütur
     */
    createIndexedDBSaveButton() {
        this.indexedDBButton = document.createElement('div');
        this.indexedDBButton.id = 'indexedDBSaveFloatingButton';
        this.indexedDBButton.innerHTML = `
            <div class="save-button-content">
                <div class="save-top-row">
                    <i class="fas fa-database"></i>
                    <span class="save-text">${this.isElectron ? 'Veritabanƒ±' : 'Kaydet'}</span>
                    <span class="save-timer"></span>
                </div>
                <div class="save-status">Hazƒ±r</div>
            </div>
        `;
        
        // Pozisyon: Electron'da ikinci sƒ±rada, Browser'da ilk sƒ±rada
        const topPosition = this.isElectron ? '80px' : '20px';
        
        this.indexedDBButton.style.cssText = `
            position: fixed;
            top: ${topPosition};
            right: 20px;
            z-index: 9999;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 12px 16px;
            box-shadow: 0 4px 20px rgba(76, 175, 80, 0.4);
            cursor: pointer;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 500;
            font-size: 13px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
            backdrop-filter: blur(10px);
            min-width: 100px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        `;

        document.body.appendChild(this.indexedDBButton);
        
        this.indexedDBButton.addEventListener('click', (e) => {
            e.preventDefault();
            this.saveToIndexedDBManual();
        });
        
        // Browser ortamƒ±nda ana floating button olarak ata
        if (!this.isElectron) {
            this.floatingButton = this.indexedDBButton;
        }
        
        console.log('üíæ IndexedDB kayƒ±t butonu olu≈üturuldu');
    }

    /**
     * Electron dosyaya manuel kayƒ±t
     */
    async saveToElectronFileManual() {
        if (!this.isElectron || !this.isInitialized) {
            this.showToast('‚ùå Electron dosya sistemi kullanƒ±lamƒ±yor!', 'error');
            return;
        }

        const exportData = createExportData();
        const result = await this.saveToElectronFile(exportData, true);
        
        if (result) {
            this.updateElectronButtonStatus('saved');
            setTimeout(() => this.updateElectronButtonStatus('ready'), 3000);
        } else {
            this.updateElectronButtonStatus('error');
            setTimeout(() => this.updateElectronButtonStatus('ready'), 3000);
        }
    }

    /**
     * IndexedDB'ye manuel kayƒ±t
     */
    async saveToIndexedDBManual() {
        if (!this.db) {
            this.showToast('‚ùå IndexedDB kullanƒ±lamƒ±yor!', 'error');
            return;
        }

        const exportData = createExportData();
        const result = await this.saveToIndexedDB(exportData, true);
        
        if (result) {
            this.updateIndexedDBButtonStatus('saved');
            setTimeout(() => this.updateIndexedDBButtonStatus('ready'), 3000);
        } else {
            this.updateIndexedDBButtonStatus('error');
            setTimeout(() => this.updateIndexedDBButtonStatus('ready'), 3000);
        }
    }

    /**
     * Birle≈üik kayƒ±t (Electron - hem dosya hem DB)
     */
    async saveUnifiedManual() {
        if (!this.isElectron || !this.isInitialized) {
            this.showToast('‚ùå Sistem hazƒ±r deƒüil!', 'error');
            return;
        }

        console.log('üöÄ Birle≈üik kayƒ±t ba≈ülatƒ±lƒ±yor...');
        this.updateUnifiedButtonStatus('saving');

        try {
            const exportData = createExportData();
            
            // Veritabanƒ± lock kontrol√º
            const dbLockCheck = await this.checkDatabaseLock();
            if (!dbLockCheck.success) {
                this.showToast(`‚ö†Ô∏è ${dbLockCheck.message}`, 'warning');
                // Dosyaya devam et ama uyar
            }

            // 1. Dosyaya kaydet
            console.log('üíæ Dosyaya kaydediliyor...');
            const fileResult = await this.saveToElectronFile(exportData, true);
            
            // 2. IndexedDB'ye kaydet (veritabanƒ± kullanƒ±labilirse)
            console.log('üóÑÔ∏è Veritabanƒ±na kaydediliyor...');
            let dbResult = true;
            if (this.db && dbLockCheck.success) {
                dbResult = await this.saveToIndexedDB(exportData, false); // silent
            }

            if (fileResult && dbResult) {
                this.showToast('‚úÖ Hem dosyaya hem veritabanƒ±na kaydedildi!', 'success', 5000);
                this.updateUnifiedButtonStatus('saved');
            } else if (fileResult) {
                this.showToast('‚ö†Ô∏è Dosyaya kaydedildi, veritabanƒ± hatasƒ±!', 'warning', 5000);
                this.updateUnifiedButtonStatus('partial');
            } else {
                this.showToast('‚ùå Kayƒ±t i≈ülemi ba≈üarƒ±sƒ±z!', 'error');
                this.updateUnifiedButtonStatus('error');
            }

        } catch (error) {
            console.error('‚ùå Birle≈üik kayƒ±t hatasƒ±:', error);
            this.showToast(`‚ùå Kayƒ±t hatasƒ±: ${error.message}`, 'error');
            this.updateUnifiedButtonStatus('error');
        }

        // 3 saniye sonra normal duruma d√∂n
        setTimeout(() => this.updateUnifiedButtonStatus('ready'), 3000);
    }

    /**
     * Veritabanƒ± lock durumunu kontrol et
     */
    async checkDatabaseLock() {
        try {
            if (!this.db) {
                return {
                    success: false,
                    message: 'Veritabanƒ± baƒülantƒ±sƒ± yok'
                };
            }

            // Hƒ±zlƒ± test i≈ülemi yapmaya √ßalƒ±≈ü
            const transaction = this.db.transaction(['courseData'], 'readwrite');
            const store = transaction.objectStore('courseData');
            
            // Test verisi ile lock kontrol√º
            const testKey = 'lockTest_' + Date.now();
            await new Promise((resolve, reject) => {
                const request = store.put({ test: true }, testKey);
                request.onsuccess = () => {
                    // Test verisini sil
                    const deleteRequest = store.delete(testKey);
                    deleteRequest.onsuccess = () => resolve();
                    deleteRequest.onerror = () => reject(deleteRequest.error);
                };
                request.onerror = () => reject(request.error);
            });

            return {
                success: true,
                message: 'Veritabanƒ± kullanƒ±labilir'
            };

        } catch (error) {
            console.warn('‚ö†Ô∏è Veritabanƒ± lock kontrol√º:', error);
            
            if (error.name === 'InvalidStateError' || error.name === 'TransactionInactiveError') {
                return {
                    success: false,
                    message: 'Veritabanƒ± ba≈üka bir uygulama tarafƒ±ndan kullanƒ±lƒ±yor'
                };
            } else if (error.name === 'QuotaExceededError') {
                return {
                    success: false,
                    message: 'Veritabanƒ± alanƒ± dolu'
                };
            } else {
                return {
                    success: false,
                    message: 'Veritabanƒ± ge√ßici olarak kullanƒ±lamƒ±yor'
                };
            }
        }
    }

    /**
     * Electron buton durumunu g√ºncelle
     */
    updateElectronButtonStatus(status) {
        if (!this.electronSaveButton) return;
        
        const statusElement = this.electronSaveButton.querySelector('.save-status');
        const timerElement = this.electronSaveButton.querySelector('.save-timer');
        
        switch (status) {
            case 'saving':
                this.electronSaveButton.style.setProperty('background', 'linear-gradient(135deg, #FF9800, #F57C00)', 'important');
                this.electronSaveButton.style.setProperty('box-shadow', '0 4px 20px rgba(255, 152, 0, 0.4)', 'important');
                statusElement.textContent = 'Kaydediyor...';
                if (timerElement) timerElement.textContent = '';
                break;
            case 'saved':
                this.electronSaveButton.style.setProperty('background', 'linear-gradient(135deg, #4CAF50, #388E3C)', 'important');
                this.electronSaveButton.style.setProperty('box-shadow', '0 0 20px rgba(76, 175, 80, 0.6)', 'important');
                statusElement.textContent = 'Kaydedildi!';
                if (timerElement) timerElement.textContent = '';
                break;
            case 'unsaved':
                this.electronSaveButton.style.setProperty('background', 'linear-gradient(135deg, #FFC107, #FF8F00)', 'important');
                this.electronSaveButton.style.setProperty('box-shadow', '0 4px 20px rgba(255, 193, 7, 0.4)', 'important');
                statusElement.textContent = 'Deƒüi≈üiklik Var';
                break;
            case 'error':
                this.electronSaveButton.style.setProperty('background', 'linear-gradient(135deg, #f44336, #d32f2f)', 'important');
                this.electronSaveButton.style.setProperty('box-shadow', '0 4px 20px rgba(244, 67, 54, 0.4)', 'important');
                statusElement.textContent = 'Hata!';
                if (timerElement) timerElement.textContent = '';
                break;
            case 'ready':
            default:
                this.electronSaveButton.style.setProperty('background', 'linear-gradient(135deg, #2196F3, #1976D2)', 'important');
                this.electronSaveButton.style.setProperty('box-shadow', '0 4px 20px rgba(33, 150, 243, 0.4)', 'important');
                statusElement.textContent = 'Hazƒ±r';
                break;
        }
    }

    /**
     * Birle≈üik buton durumunu g√ºncelle
     */
    updateUnifiedButtonStatus(status) {
        if (!this.unifiedSaveButton) return;
        
        const statusElement = this.unifiedSaveButton.querySelector('.save-status');
        const timerElement = this.unifiedSaveButton.querySelector('.save-timer');
        
        switch (status) {
            case 'saving':
                this.unifiedSaveButton.style.setProperty('background', 'linear-gradient(135deg, #FF9800, #F57C00)', 'important');
                this.unifiedSaveButton.style.setProperty('box-shadow', '0 4px 20px rgba(255, 152, 0, 0.4)', 'important');
                statusElement.textContent = 'Kaydediyor...';
                if (timerElement) timerElement.textContent = '';
                break;
            case 'saved':
                this.unifiedSaveButton.style.setProperty('background', 'linear-gradient(135deg, #4CAF50, #388E3C)', 'important');
                this.unifiedSaveButton.style.setProperty('box-shadow', '0 0 20px rgba(76, 175, 80, 0.6)', 'important');
                statusElement.textContent = 'Kaydedildi!';
                if (timerElement) timerElement.textContent = '';
                break;
            case 'partial':
                this.unifiedSaveButton.style.setProperty('background', 'linear-gradient(135deg, #FF9800, #F57C00)', 'important');
                this.unifiedSaveButton.style.setProperty('box-shadow', '0 4px 20px rgba(255, 152, 0, 0.4)', 'important');
                statusElement.textContent = 'Kƒ±smi Kayƒ±t';
                if (timerElement) timerElement.textContent = '';
                break;
            case 'error':
                this.unifiedSaveButton.style.setProperty('background', 'linear-gradient(135deg, #f44336, #d32f2f)', 'important');
                this.unifiedSaveButton.style.setProperty('box-shadow', '0 4px 20px rgba(244, 67, 54, 0.4)', 'important');
                statusElement.textContent = 'Hata!';
                if (timerElement) timerElement.textContent = '';
                break;
            case 'unsaved':
                this.unifiedSaveButton.style.setProperty('background', 'linear-gradient(135deg, #FFC107, #FF8F00)', 'important');
                this.unifiedSaveButton.style.setProperty('box-shadow', '0 4px 20px rgba(255, 193, 7, 0.4)', 'important');
                statusElement.textContent = 'Deƒüi≈üiklik Var';
                break;
            case 'ready':
            default:
                this.unifiedSaveButton.style.setProperty('background', 'linear-gradient(135deg, #4CAF50, #45a049)', 'important');
                this.unifiedSaveButton.style.setProperty('box-shadow', '0 4px 20px rgba(76, 175, 80, 0.4)', 'important');
                statusElement.textContent = 'Hazƒ±r';
                break;
        }
    }

    /**
     * IndexedDB buton durumunu g√ºncelle
     */
    updateIndexedDBButtonStatus(status) {
        if (!this.indexedDBButton) return;
        
        const statusElement = this.indexedDBButton.querySelector('.save-status');
        const timerElement = this.indexedDBButton.querySelector('.save-timer');
        
        switch (status) {
            case 'saving':
                this.indexedDBButton.style.setProperty('background', 'linear-gradient(135deg, #FF9800, #F57C00)', 'important');
                this.indexedDBButton.style.setProperty('box-shadow', '0 4px 20px rgba(255, 152, 0, 0.4)', 'important');
                statusElement.textContent = 'Kaydediyor...';
                if (timerElement) timerElement.textContent = '';
                break;
            case 'saved':
                this.indexedDBButton.style.setProperty('background', 'linear-gradient(135deg, #4CAF50, #388E3C)', 'important');
                this.indexedDBButton.style.setProperty('box-shadow', '0 0 20px rgba(76, 175, 80, 0.6)', 'important');
                statusElement.textContent = 'Kaydedildi!';
                if (timerElement) timerElement.textContent = '';
                break;
            case 'unsaved':
                this.indexedDBButton.style.setProperty('background', 'linear-gradient(135deg, #FFC107, #FF8F00)', 'important');
                this.indexedDBButton.style.setProperty('box-shadow', '0 4px 20px rgba(255, 193, 7, 0.4)', 'important');
                statusElement.textContent = 'Deƒüi≈üiklik Var';
                break;
            case 'error':
                this.indexedDBButton.style.setProperty('background', 'linear-gradient(135deg, #f44336, #d32f2f)', 'important');
                this.indexedDBButton.style.setProperty('box-shadow', '0 4px 20px rgba(244, 67, 54, 0.4)', 'important');
                statusElement.textContent = 'Hata!';
                if (timerElement) timerElement.textContent = '';
                break;
            case 'ready':
            default:
                this.indexedDBButton.style.setProperty('background', 'linear-gradient(135deg, #4CAF50, #45a049)', 'important');
                this.indexedDBButton.style.setProperty('box-shadow', '0 4px 20px rgba(76, 175, 80, 0.4)', 'important');
                statusElement.textContent = 'Hazƒ±r';
                break;
        }
    }

    /**
     * Floating button durumunu g√ºncelle (uyumluluk i√ßin)
     */
    updateFloatingButton(status) {
        if (this.isElectron) {
            // Electron ortamƒ±nda birle≈üik buton varsa onu g√ºncelle
            if (this.unifiedSaveButton) {
                this.updateUnifiedButtonStatus(status);
            } else {
                // Fallback: Eski sistem
                this.updateElectronButtonStatus(status);
                this.updateIndexedDBButtonStatus(status);
            }
        } else {
            // Browser ortamƒ±nda IndexedDB butonunu g√ºncelle
            this.updateIndexedDBButtonStatus(status);
        }
    }

    // *** ESKƒ∞ createFloatingButton FONKSƒ∞YONU TAMAMEN KALDIRILDI ***
    // Artƒ±k createFloatingButtons() kullanƒ±lƒ±yor

    createClearButton() {
        this.clearButton = document.createElement('div');
        this.clearButton.id = 'autoClearFloatingButton';
        this.clearButton.innerHTML = `
            <div class="clear-button-content">
                <div class="clear-top-row">
                    <i class="fas fa-trash-alt"></i>
                    <span class="clear-text">Temizle</span>
                </div>
                <div class="clear-status">Veri mevcut</div>
            </div>
        `;
        
        // Pozisyon: Electron'da 2. sƒ±rada (80px), Browser'da 2. sƒ±rada (80px)
        const topPosition = '80px';
        
        this.clearButton.style.cssText = `
            position: fixed;
            top: ${topPosition};
            left: 20px;
            z-index: 9999;
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 12px 16px;
            box-shadow: 0 4px 20px rgba(238, 90, 82, 0.4);
            cursor: pointer;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 500;
            font-size: 13px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
            backdrop-filter: blur(10px);
            min-width: 100px;
            text-align: center;
            opacity: 0.85;
            display: flex;
            align-items: center;
            justify-content: center;
        `;
        
        // CSS animasyonlarƒ± ekle
        const style = document.createElement('style');
        style.textContent = `
            #autoSaveFloatingButton:hover {
                transform: translateY(-2px) !important;
            }
            
            #autoSaveFloatingButton.saving {
                background: linear-gradient(135deg, #FF9800, #F57C00) !important;
                box-shadow: 0 4px 20px rgba(255, 152, 0, 0.4) !important;
                animation: pulse 1.5s infinite !important;
            }
            
            #autoSaveFloatingButton.saved {
                background: linear-gradient(135deg, #4CAF50, #388E3C) !important;
                box-shadow: 0 4px 20px rgba(76, 175, 80, 0.4) !important;
                animation: success-glow 0.5s ease-out !important;
            }
            
            #autoSaveFloatingButton.unsaved {
                background: linear-gradient(135deg, #FFC107, #FFB300) !important;
                box-shadow: 0 4px 20px rgba(255, 193, 7, 0.4) !important;
                animation: gentle-glow 2s infinite !important;
            }
            
            #autoSaveFloatingButton.ready {
                background: linear-gradient(135deg, #4CAF50, #45a049) !important;
                box-shadow: 0 4px 20px rgba(76, 175, 80, 0.3) !important;
                animation: none !important;
            }
            
            #autoSaveFloatingButton.error {
                background: linear-gradient(135deg, #f44336, #d32f2f) !important;
                box-shadow: 0 4px 20px rgba(244, 67, 54, 0.4) !important;
                animation: shake 0.5s !important;
            }
            
            @media (max-width: 768px) {
                #autoSaveFloatingButton {
                    top: 15px;
                    right: 15px;
                    padding: 10px 14px;
                    font-size: 12px;
                    min-width: 90px;
                }
                
                .save-button-content {
                    gap: 2px;
                }
                
                .save-top-row {
                    gap: 4px;
                    font-size: 12px;
                }
                
                .save-text {
                    font-size: 11px;
                }
                
                .save-timer {
                    font-size: 9px;
                    padding: 1px 3px;
                }
                
                .save-status {
                    font-size: 9px;
                }
            }
            
            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.7; }
            }
            
            @keyframes gentle-glow {
                0%, 100% { box-shadow: 0 4px 20px rgba(255, 193, 7, 0.4); }
                50% { box-shadow: 0 4px 25px rgba(255, 193, 7, 0.6); }
            }
            
            @keyframes success-glow {
                0% { 
                    box-shadow: 0 4px 20px rgba(76, 175, 80, 0.3);
                    transform: scale(1);
                }
                50% { 
                    box-shadow: 0 6px 30px rgba(76, 175, 80, 0.6);
                    transform: scale(1.05);
                }
                100% { 
                    box-shadow: 0 4px 20px rgba(76, 175, 80, 0.3);
                    transform: scale(1);
                }
            }
            
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-5px); }
                75% { transform: translateX(5px); }
            }
            
            .save-button-content {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 3px;
                width: 100%;
                height: 100%;
            }
            
            .save-top-row {
                display: flex;
                align-items: center;
                gap: 6px;
                font-size: 13px;
            }
            
            .save-status {
                font-size: 10px;
                opacity: 0.8;
                text-align: center;
            }
            
            .save-timer {
                font-size: 10px;
                font-weight: 700;
                opacity: 0;
                color: rgba(255, 255, 255, 0.9);
                background: rgba(0, 0, 0, 0.2);
                padding: 1px 4px;
                border-radius: 8px;
                transition: all 0.3s ease;
                transform: scale(0.8);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .save-timer.show {
                opacity: 1;
                transform: scale(1);
            }
            
            .save-timer.pulse {
                animation: timer-pulse 1s infinite;
            }
            
            @keyframes timer-pulse {
                0%, 100% { opacity: 0.9; transform: scale(1); }
                50% { opacity: 1; transform: scale(1.05); }
            }
        `;
        
        document.head.appendChild(style);
        document.body.appendChild(this.floatingButton);
        
        // Click event - [[memory:146162273345585106]] uygun ≈üekilde type="button" davranƒ±≈üƒ±
        this.floatingButton.addEventListener('click', (e) => {
            e.preventDefault();
            this.saveData(true);
        });

        // √áift tƒ±k ile kayƒ±t durumu bilgisi
        this.floatingButton.addEventListener('dblclick', (e) => {
            e.preventDefault();
            this.showSaveInfo();
        });

        // Saƒü tƒ±k men√ºs√º artƒ±k gerekmiyor - ayrƒ± clear button var
        
        this.updateFloatingButton('ready');
    }

    /**
     * Floating temizleme butonu olu≈ütur
     */
    createClearButton() {
        this.clearButton = document.createElement('div');
        this.clearButton.id = 'autoClearFloatingButton';
        this.clearButton.innerHTML = `
            <div class="clear-button-content">
                <div class="clear-top-row">
                    <i class="fas fa-trash-alt"></i>
                    <span class="clear-text">Temizle</span>
                </div>
                <div class="clear-status">Veri mevcut</div>
            </div>
        `;
        
        // CSS stilleri - kaydet butonu ile aynƒ± boyutlarda
        this.clearButton.style.cssText = `
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 9998;
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 12px 16px;
            box-shadow: 0 4px 20px rgba(238, 90, 82, 0.3);
            cursor: pointer;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 500;
            font-size: 13px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
            backdrop-filter: blur(10px);
            min-width: 100px;
            text-align: center;
            opacity: 0.85;
            display: flex;
            align-items: center;
            justify-content: center;
        `;
        
        // CSS animasyonlarƒ± ekle (sadece bir kez)
        const clearStyle = document.createElement('style');
        clearStyle.id = 'clearButtonStyles';
        if (!document.getElementById('clearButtonStyles')) {
            clearStyle.textContent = `
                #autoClearFloatingButton:hover {
                    opacity: 1;
                    transform: translateY(-2px);
                    box-shadow: 0 6px 25px rgba(238, 90, 82, 0.4);
                }
                
                #autoClearFloatingButton.clearing {
                    background: linear-gradient(135deg, #ffa726, #ff9800);
                    animation: clear-pulse 1.5s infinite;
                }
                
                #autoClearFloatingButton.confirm {
                    background: linear-gradient(135deg, #ff5722, #d84315);
                    animation: clear-shake 0.5s;
                }
                
                @keyframes clear-pulse {
                    0%, 100% { opacity: 0.8; }
                    50% { opacity: 1; }
                }
                
                @keyframes clear-shake {
                    0%, 100% { transform: translateX(0); }
                    25% { transform: translateX(-3px); }
                    75% { transform: translateX(3px); }
                }
                
                .clear-button-content {
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    gap: 3px;
                    width: 100%;
                    height: 100%;
                }
                
                .clear-top-row {
                    display: flex;
                    align-items: center;
                    gap: 6px;
                    font-size: 13px;
                }
                
                .clear-status {
                    font-size: 10px;
                    opacity: 0.8;
                    text-align: center;
                }
                
                @media (max-width: 768px) {
                    #autoClearFloatingButton {
                        top: 15px;
                        left: 15px;
                        padding: 10px 14px;
                        font-size: 12px;
                        min-width: 90px;
                    }
                    
                    .clear-button-content {
                        gap: 2px;
                    }
                    
                    .clear-top-row {
                        gap: 4px;
                        font-size: 12px;
                    }
                    
                    .clear-text {
                        font-size: 11px;
                    }
                    
                    .clear-status {
                        font-size: 9px;
                    }
                }
            `;
            
            document.head.appendChild(clearStyle);
        }
        
        document.body.appendChild(this.clearButton);
        
        // Click event - [[memory:146162273345585106]] uygun ≈üekilde type="button" davranƒ±≈üƒ±
        this.clearButton.addEventListener('click', (e) => {
            e.preventDefault();
            this.clearAllSavedData();
        });
        
        // ƒ∞lk status g√ºncellemesi
        this.updateClearButtonStatus();
        
        console.log('üóëÔ∏è Floating temizleme butonu olu≈üturuldu');
    }

    /**
     * Saƒü tƒ±k context men√ºs√ºn√º g√∂ster
     */
    showContextMenu(event) {
        // Mevcut context menu'larƒ± kaldƒ±r
        const existingMenu = document.getElementById('autoSaveContextMenu');
        if (existingMenu) {
            existingMenu.remove();
        }

        // Context menu olu≈ütur
        const contextMenu = document.createElement('div');
        contextMenu.id = 'autoSaveContextMenu';
        contextMenu.innerHTML = `
            <div class="context-menu-item" data-action="manual-save">
                <i class="fas fa-save"></i>
                <span>Manuel Kayƒ±t</span>
            </div>
            <div class="context-menu-item" data-action="clear-data">
                <i class="fas fa-trash-alt"></i>
                <span>Kaydedilmi≈ü Verileri Temizle</span>
            </div>
            <div class="context-menu-item" data-action="info">
                <i class="fas fa-info-circle"></i>
                <span>Kayƒ±t Durumu</span>
            </div>
        `;

        // Context menu stilini ayarla
        contextMenu.style.cssText = `
            position: fixed;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 10000;
            min-width: 200px;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        `;

        // Pozisyonu ayarla (√ºst k√∂≈üe i√ßin)
        const buttonRect = this.floatingButton.getBoundingClientRect();
        contextMenu.style.right = `${window.innerWidth - buttonRect.left + 10}px`;
        contextMenu.style.top = `${buttonRect.bottom + 10}px`;

        // CSS stillerini ekle
        const style = document.createElement('style');
        style.textContent = `
            .context-menu-item {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 12px 16px;
                cursor: pointer;
                transition: background-color 0.2s ease;
                font-size: 14px;
                color: #333;
                border-bottom: 1px solid #f0f0f0;
            }
            
            .context-menu-item:last-child {
                border-bottom: none;
            }
            
            .context-menu-item:hover {
                background-color: #f5f5f5;
            }
            
            .context-menu-item[data-action="clear-data"]:hover {
                background-color: #fff5f5;
                color: #d73527;
            }
            
            .context-menu-item i {
                width: 16px;
                text-align: center;
                color: #666;
            }
            
            .context-menu-item[data-action="clear-data"] i {
                color: #ff6b6b;
            }
        `;
        
        document.head.appendChild(style);
        document.body.appendChild(contextMenu);

        // Event listeners ekle
        contextMenu.addEventListener('click', (e) => {
            const item = e.target.closest('.context-menu-item');
            if (!item) return;

            const action = item.dataset.action;
            
            switch (action) {
                case 'manual-save':
                    this.saveData(true);
                    break;
                    
                case 'clear-data':
                    this.clearAllSavedData();
                    break;
                    
                case 'info':
                    this.showSaveInfo();
                    break;
            }
            
            // Men√ºy√º kapat
            contextMenu.remove();
        });

        // Dƒ±≈üarƒ± tƒ±klayƒ±nca kapat
        const closeMenu = (e) => {
            if (!contextMenu.contains(e.target)) {
                contextMenu.remove();
                document.removeEventListener('click', closeMenu);
            }
        };

        setTimeout(() => {
            document.addEventListener('click', closeMenu);
        }, 100);
    }

    /**
     * Kayƒ±t durumu bilgisini g√∂ster
     */
    showSaveInfo() {
        const hasData = this.lastSaveTime !== null;
        const status = hasData 
            ? `Son kayƒ±t: ${this.lastSaveTime.toLocaleString('tr-TR')}`
            : 'Hen√ºz kayƒ±t yapƒ±lmamƒ±≈ü';
        
        const dbStatus = this.isInitialized ? 'IndexedDB aktif' : 'LocalStorage fallback';
        
        this.showToast(
            `üìä Otomatik Kayƒ±t Durumu:\n${status}\nüîß ${dbStatus}`,
            'info'
        );
    }

    // *** ESKƒ∞ updateFloatingButton FONKSƒ∞YONU KALDIRILDI ***
    // Modern updateFloatingButton fonksiyonu artƒ±k satƒ±r 1209'da !important ile √ßalƒ±≈üƒ±yor

    /**
     * Promise wrapper for IndexedDB requests
     */
    promisifyRequest(request) {
        return new Promise((resolve, reject) => {
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }

    /**
     * LocalStorage fallback
     */
    fallbackToLocalStorage() {
        console.warn('‚ö†Ô∏è IndexedDB kullanƒ±lamƒ±yor, localStorage fallback aktif');
        
        // Basit localStorage implementasyonu
        this.saveData = async (manual = false) => {
            try {
                const exportData = createExportData();
                localStorage.setItem('mudek-course-data-backup', JSON.stringify({
                    data: exportData,
                    timestamp: new Date().toISOString(),
                    type: manual ? 'manual' : 'auto'
                }));
                
                this.hasUnsavedChanges = false;
                this.updateFloatingButton('saved');
                this.restartTimer();
                this.updateClearButtonStatus();
                console.log('üíæ LocalStorage fallback kayƒ±t tamamlandƒ±');
                
                if (manual) {
                    this.showToast('üíæ Veriler localStorage\'a kaydedildi', 'success');
                }
                
                return true;
            } catch (error) {
                console.error('‚ùå LocalStorage fallback hatasƒ±:', error);
                return false;
            }
        };
        
        this.loadData = async () => {
            try {
                const saved = localStorage.getItem('mudek-course-data-backup');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    return parsed.data;
                }
                return null;
            } catch (error) {
                console.error('‚ùå LocalStorage fallback y√ºkleme hatasƒ±:', error);
                return null;
            }
        };
        
        this.createFloatingButtons();
        this.createClearButton();
        this.startAutoSave();
        this.autoRestore();
        this.setupChangeDetection();
    }

    /**
     * Toast mesajƒ± g√∂ster
     */
    showToast(message, type = 'info') {
        if (typeof showModernToast === 'function') {
            showModernToast(message, type);
        } else if (typeof showToast === 'function') {
            showToast(message, type);
        } else {
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
    }

    /**
     * Kaydedilmi≈ü t√ºm verileri temizle (g√ºvenlik onayƒ± ile)
     */
    async clearAllSavedData() {
        // Confirm modal g√∂ster (Promise d√∂nd√ºr√ºyor!)
        if (typeof showModernConfirm === 'function') {
            try {
                const result = await showModernConfirm(
                    'üóëÔ∏è T√ºm Verileri Temizle',
                    '‚ö†Ô∏è Bu i≈ülem t√ºm verileri kalƒ±cƒ± olarak silecek!\n\n' +
                    '‚Ä¢ IndexedDB\'deki otomatik kayƒ±tlar silinecek\n' +
                    '‚Ä¢ LocalStorage yedekleri temizlenecek\n' +
                    '‚Ä¢ Sayfa yenilenecek (t√ºm veriler kaybolacak)\n\n' +
                    '‚ùó Bu i≈ülem geri alƒ±namaz! Temiz bir sayfa ile ba≈ülayacaksƒ±nƒ±z!\n\n' +
                    'Devam etmek istediƒüinizden emin misiniz?'
                );
                
                console.log('üî¥ Modal sonucu:', result);
                
                if (result === true) {
                    console.log('üî¥ Modal onaylandƒ±, temizleme ba≈ülƒ±yor...');
                    
                    // Eƒüer performClearAllData √ßalƒ±≈ümazsa, direkt reload yap
                    try {
                        await this.performClearAllData();
                    } catch (error) {
                        console.error('‚ùå performClearAllData hatasƒ±:', error);
                        console.log('üîÑ Emergency reload √ßaƒürƒ±lƒ±yor...');
                        this.showToast('‚ö†Ô∏è Hata olu≈ütu! Emergency reload...', 'error');
                        setTimeout(() => {
                            this.showToast('üö® EMERGENCY RELOAD!', 'error');
                            if (this.isElectron) {
                                this.reloadElectronApp();
                            } else {
                                window.location.reload(true);
                            }
                        }, 200);
                    }
                } else {
                    console.log('‚ùå Modal iptal edildi');
                }
            } catch (modalError) {
                console.error('‚ùå Modal error:', modalError);
                // Modal hata verirse fallback'e d√º≈ü
                this.showFallbackConfirm();
            }
        } else {
            // Modern modal yoksa fallback'e d√º≈ü
            this.showFallbackConfirm();
        }
    }

    /**
     * Fallback confirm dialog
     */
    async showFallbackConfirm() {
        // Fallback: basit confirm
        if (confirm('‚ö†Ô∏è T√ºm verileri silip sayfayƒ± yenilemek istediƒüinizden emin misiniz?\n\nBu i≈ülem geri alƒ±namaz!')) {
            console.log('üî¥ Basit modal onaylandƒ±, temizleme ba≈ülƒ±yor...');
            try {
                await this.performClearAllData();
            } catch (error) {
                console.error('‚ùå Fallback performClearAllData hatasƒ±:', error);
                console.log('üîÑ Fallback emergency reload √ßaƒürƒ±lƒ±yor...');
                this.showToast('‚ö†Ô∏è Fallback hatasƒ±! Emergency reload...', 'error');
                setTimeout(() => {
                    this.showToast('üö® FALLBACK EMERGENCY RELOAD!', 'error');
                    if (this.isElectron) {
                        this.reloadElectronApp();
                    } else {
                        window.location.reload(true);
                    }
                }, 200);
            }
        }
    }

    /**
     * Veri temizleme i≈ülemini ger√ßekle≈ütir
     */
    async performClearAllData() {
        try {
            this.updateFloatingButton('saving');
            
            // Clear button animasyonu
            if (this.clearButton) {
                this.clearButton.className = 'clearing';
            }
            
            let clearedCount = 0;
            let clearDetails = [];

            // Electron dosya sistemini temizle
            if (this.isElectron) {
                try {
                    const result = await window.electronAPI.clearAutoData();
                    if (result.success) {
                        const shortPath = this.getShortFilePath(result.filePath);
                        if (result.fileExisted) {
                            clearedCount++;
                            clearDetails.push(`üìÅ Yedek Dosyasƒ± (${shortPath})`);
                            console.log('‚úÖ Electron dosyasƒ± silindi:', shortPath);
                        } else {
                            console.log('‚ÑπÔ∏è Electron dosyasƒ± zaten mevcut deƒüildi:', shortPath);
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Electron dosya temizleme hatasƒ±:', error);
                }
            }

            // IndexedDB'yi temizle (sadece browser ortamƒ±nda)
            if (!this.isElectron && this.isInitialized && this.db) {
                try {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    await this.promisifyRequest(store.clear());
                    clearedCount++;
                    clearDetails.push('üóÑÔ∏è IndexedDB');
                    console.log('‚úÖ IndexedDB verileri temizlendi');
                } catch (error) {
                    console.error('‚ùå IndexedDB temizleme hatasƒ±:', error);
                }
            }

            // LocalStorage'ƒ± komple temizle
            try {
                const removedKeys = [];
                const keysToRemove = [
                    'mudek-course-data-backup',
                    'mudek-course-data',
                    'courseData',
                    'studentData',
                    'assessmentTree',
                    'gradesData'
                ];
                
                keysToRemove.forEach(key => {
                    if (localStorage.getItem(key)) {
                        localStorage.removeItem(key);
                        removedKeys.push(key);
                    }
                });
                
                if (removedKeys.length > 0) {
                    clearedCount++;
                    clearDetails.push(`üíæ LocalStorage (${removedKeys.length})`);
                    console.log('‚úÖ LocalStorage verileri temizlendi:', removedKeys);
                }
            } catch (error) {
                console.error('‚ùå LocalStorage temizleme hatasƒ±:', error);
            }

            // Durumu g√ºncelle
            this.hasUnsavedChanges = false;
            this.lastSaveTime = null;
            
            // Clear button'ƒ± normale d√∂nd√ºr
            if (this.clearButton) {
                this.clearButton.className = '';
            }

            // Ba≈üarƒ± mesajƒ± g√∂ster ve sayfayƒ± yenile
            let toastMessage = `üóëÔ∏è T√ºm veriler ba≈üarƒ±yla temizlendi! (${clearedCount} kaynak)`;
            if (clearDetails.length > 0) {
                toastMessage += `\n\nüìã Temizlenen:\n‚Ä¢ ${clearDetails.join('\n‚Ä¢ ')}`;
            }
            toastMessage += '\n\nüîÑ Sayfa yenileniyor...';
            
            this.showToast(toastMessage, 'success', 8000);

            console.log('üóëÔ∏è T√ºm veriler temizlendi, sayfa yenileniyor...');

        } catch (error) {
            console.error('‚ùå Veri temizleme hatasƒ±:', error);
            this.updateFloatingButton('error');
            
            // Clear button hata durumu
            if (this.clearButton) {
                this.clearButton.className = 'confirm';
                setTimeout(() => {
                    this.clearButton.className = '';
                }, 2000);
            }
            
            this.showToast('‚ùå Veri temizleme i≈ülemi ba≈üarƒ±sƒ±z!', 'error');
        } finally {
            // Her durumda uygulamayƒ± yenile (ba≈üarƒ±lƒ± olsun veya olmasƒ±n)
            console.log('üîÑ Uygulama yenileniyor...');
            this.showToast('üîÑ Uygulama yenileniyor...', 'info');
            
            setTimeout(() => {
                if (this.isElectron) {
                    // Electron'da uygulama yenileme
                    console.log('üîÑ Electron uygulamasƒ± yenileniyor...');
                    this.showToast('‚ö° Electron uygulamasƒ± yenileniyor!', 'warning');
                    this.reloadElectronApp();
                } else {
                    // Browser'da sayfa yenileme
                    console.log('üîÑ Tarayƒ±cƒ± sayfasƒ± yenileniyor...');
                    this.showToast('‚ö° Sayfa yenileniyor!', 'warning');
                    this.reloadBrowserPage();
                }
                         }, 2000); // 2 saniye bekle ki kullanƒ±cƒ± mesajlarƒ± g√∂rebilsin
        }
    }

    /**
     * Electron uygulamasƒ±nƒ± yenile
     */
    reloadElectronApp() {
        try {
            // Electron BrowserWindow'u yenile
            if (window.electronAPI && window.electronAPI.reloadWindow) {
                console.log('üîÑ Electron API ile window reload...');
                window.electronAPI.reloadWindow();
            } else if (window.location && window.location.reload) {
                console.log('üîÑ Fallback: location.reload() kullanƒ±lƒ±yor...');
                window.location.reload();
            } else {
                console.log('‚ùå Electron reload ba≈üarƒ±sƒ±z, manuel yenileme gerekiyor!');
                this.showToast('‚ùå Otomatik yenileme ba≈üarƒ±sƒ±z! Uygulamayƒ± manuel yenileyin.', 'error');
            }
        } catch (error) {
            console.error('‚ùå Electron reload hatasƒ±:', error);
            this.showToast('‚ùå Uygulama yenileme hatasƒ±!', 'error');
        }
    }

    /**
     * Browser sayfasƒ±nƒ± yenile
     */
    reloadBrowserPage() {
        try {
            // Birden fazla reload y√∂ntemi dene
            if (window.location && window.location.reload) {
                console.log('üîÑ Browser reload: location.reload(true)...');
                window.location.reload(true); // Force reload
            } else if (window.location && window.location.href) {
                console.log('üîÑ Browser reload: href yeniden atama...');
                window.location.href = window.location.href;
            } else if (window.location && window.location.replace) {
                console.log('üîÑ Browser reload: location.replace...');
                window.location.replace(window.location.href);
            } else {
                console.log('‚ùå Browser reload ba≈üarƒ±sƒ±z!');
                this.showToast('‚ùå Otomatik yenileme ba≈üarƒ±sƒ±z!', 'error');
                setTimeout(() => {
                    alert('‚ö†Ô∏è UYARI: Sayfa otomatik yenilenemedi!\n\n' +
                          'üîÑ Manuel yenileme gerekiyor:\n' +
                          '‚Ä¢ F5 tu≈üuna basƒ±n, VEYA\n' +
                          '‚Ä¢ Ctrl+F5 (tam yenileme), VEYA\n' +
                          '‚Ä¢ Tarayƒ±cƒ± yenile butonuna basƒ±n\n\n' +
                          '‚úÖ Veriler temizlendi, sadece sayfa yenilenmeli!');
                }, 1000);
            }
        } catch (error) {
            console.error('‚ùå Browser reload hatasƒ±:', error);
            this.showToast('‚ùå Sayfa yenileme hatasƒ±!', 'error');
        }
    }

    /**
     * Temizlik i≈ülemleri
     */
    destroy() {
        if (this.autoSaveInterval) {
            clearInterval(this.autoSaveInterval);
        }
        
        if (this.timerInterval) {
            clearInterval(this.timerInterval);
        }
        
        if (this.electronSaveButton) {
            this.electronSaveButton.remove();
        }
        
        if (this.indexedDBButton) {
            this.indexedDBButton.remove();
        }
        
        if (this.floatingButton) {
            this.floatingButton.remove();
        }
        
        if (this.clearButton) {
            this.clearButton.remove();
        }
        
        if (this.db) {
            this.db.close();
        }
    }
}

// Global otomatik kayƒ±t manager instance
let autoSaveManager = null;

/**
 * Deƒüerlendirme etkinlik t√ºrleri
 */
const ACTIVITY_TYPES = {
    term: [
        "Ara Sƒ±nav",
        "Laboratuvar Sƒ±navƒ±",
        "Deney",
        "Deney Sonrasƒ± Quiz",
        "Performans",
        "Quiz",
        "Rapor",
        "Rapor Sunma",
        "Makale Kritik Etme",
        "Makale Yazma",
        "Proje Hazƒ±rlama",
        "Proje Sunma",
        "Rehberli Problem √á√∂z√ºm√º",
        "Seminer",
        "S√∂zl√º Sƒ±nav",
        "√ñdev Problemleri ƒ∞√ßin √áalƒ±≈üma",
        "Proje Tasarƒ±mƒ±/Y√∂netimi",
        "Derse Katƒ±lƒ±m",
        "Ev √ñdevi"
    ],
    final: [
        "Final Sƒ±navƒ±",
        "Laboratuvar Ara Sƒ±navƒ±",
        "Makale Yazma",
        "Proje Hazƒ±rlama",
        "Proje Sunma",
        "Proje Tasarƒ±mƒ±/Y√∂netimi",
        "Quiz",
        "Rapor",
        "Rapor Hazƒ±rlama",
        "Rapor Sunma",
        "Seminer",
        "S√∂zl√º Sƒ±nav",
        "G√∂zlem"
    ],
    subItem: [
        "Soru",
        "Rubrik",
        "Test"
    ]
};

/**
 * Uygulama durum deƒüi≈ükenleri
 */
const APP_STATE = {
    courseData: null,        // Ders bilgileri
    learningOutcomes: [],    // √ñƒürenme √ßƒ±ktƒ±larƒ±
    programOutcomes: [],     // Program √ßƒ±ktƒ±larƒ±
    outcomeMatrix: null,     // √ñ√á-P√á ƒ∞li≈üki Matrisi
    assessmentTree: [],      // Deƒüerlendirme aƒüacƒ±
    selectedNode: null,      // Se√ßili d√ºƒü√ºm
	testDetailsNode: null,   // Test detaylarƒ± i√ßin ge√ßici d√ºƒü√ºm
    multipleItemsNode: null, // √áoklu √∂ƒüe eklemek i√ßin ge√ßici d√ºƒü√ºm
    multipleItemsType: '',   // Eklenecek √∂ƒüelerin tipi (soru veya rubrik)
    termWeight: 40,          // Yarƒ±yƒ±l i√ßi aƒüƒ±rlƒ±ƒüƒ±
    finalWeight: 60,         // Yarƒ±yƒ±l sonu aƒüƒ±rlƒ±ƒüƒ±
    jsonFileName: '',        // Y√ºklenen JSON dosyasƒ±nƒ±n adƒ±
    studentData: [],         // √ñƒürenci verileri
    gradesData: {},          // Not verileri
    testDetailsNode: null,   // Test detaylarƒ± i√ßin ge√ßici d√ºƒü√ºm
    currentActiveTabId: 'definition', // Aktif sekme ID'si
    currentMappingNode: null, // Haritalama d√ºzenlenen d√ºƒü√ºm
    selectedStudentId: null  // Se√ßili √∂ƒürenci ID'si (student grades view i√ßin)
};

// =====================================================
// DOM ELEMENTLERINI SE√áME
// =====================================================

// Ana konteynerlar
const treeContainer = document.getElementById('treeContainer');
const outcomesList = document.getElementById('outcomesList');
const programOutcomesList = document.getElementById('programOutcomesList');
const matrixContainer = document.getElementById('matrixContainer');
const courseDetailsContainer = document.getElementById('courseDetailsContainer');
const courseTitle = document.getElementById('courseTitle');
const courseDetails = document.getElementById('courseDetails');
const courseTerm = document.getElementById('courseTerm');
const termWeightSpan = document.getElementById('termWeight');
const finalWeightSpan = document.getElementById('finalWeight');
const termProgress = document.getElementById('termProgress');
const finalProgress = document.getElementById('finalProgress');

// Modaller
const importModal = document.getElementById('importModal');
const exportModal = document.getElementById('exportModal');
const importStudentsModal = document.getElementById('importStudentsModal');
const exportGradesModal = document.getElementById('exportGradesModal');
const testDetailsModal = document.getElementById('testDetailsModal');
const closeImportModal = document.getElementById('closeImportModal');
const closeExportModal = document.getElementById('closeExportModal');
const closeImportStudentsModal = document.getElementById('closeImportStudentsModal');
const closeExportGradesModal = document.getElementById('closeExportGradesModal');
const closeTestDetailsModal = document.getElementById('closeTestDetailsModal');

const multipleItemsModal = document.getElementById('multipleItemsModal');
const closeMultipleItemsModal = document.getElementById('closeMultipleItemsModal');
const multipleItemsTitle = document.getElementById('multipleItemsTitle');
const itemCount = document.getElementById('itemCount');
const itemType = document.getElementById('itemType');
const questionType = document.getElementById('questionType');
const rubricType = document.getElementById('rubricType');
const questionTypeContainer = document.getElementById('questionTypeContainer');
const rubricTypeContainer = document.getElementById('rubricTypeContainer');
const btnAddMultipleItems = document.getElementById('btnAddMultipleItems');

const toast = document.getElementById('toast');
const toastMessage = document.getElementById('toastMessage');

// Form ve input elementleri
const jsonContent = document.getElementById('jsonContent');
const exportJsonContent = document.getElementById('exportJsonContent');
const studentJsonContent = document.getElementById('studentJsonContent');
const exportGradesContent = document.getElementById('exportGradesContent');
const fileInput = document.getElementById('fileInput');
const selectedFileName = document.getElementById('selectedFileName');
const selectedStudentFileName = document.getElementById('selectedStudentFileName');
const studentFileInput = document.getElementById('studentFileInput');
const studentJsonInput = document.getElementById('studentJsonInput');
const studentTable = document.getElementById('studentTable');
const assessmentContainer = document.getElementById('assessmentContainer');
const gradesTable = document.getElementById('gradesTable');
const statsContent = document.getElementById('statsContent');
const chartContainer = document.getElementById('chartContainer');
const totalQuestionsInput = document.getElementById('totalQuestions');
const correctWeightInput = document.getElementById('correctWeight');
const wrongPenaltyInput = document.getElementById('wrongPenalty');

// Butonlarƒ± se√ßme
const btnImport = document.getElementById('btnImport');
const btnExport = document.getElementById('btnExport');
const btnAddTerm = document.getElementById('btnAddTerm');
const btnAddFinal = document.getElementById('btnAddFinal');
const btnAddQuestion = document.getElementById('btnAddQuestion');
const btnAddRubric = document.getElementById('btnAddRubric');
const btnRemove = document.getElementById('btnRemove');
const btnExpandAll = document.getElementById('btnExpandAll');
const btnCollapseAll = document.getElementById('btnCollapseAll');
const btnSelectFile = document.getElementById('btnSelectFile');
const btnApplyJson = document.getElementById('btnApplyJson');
const btnCopyJson = document.getElementById('btnCopyJson');
const btnSaveJson = document.getElementById('btnSaveJson');
const btnImportStudents = document.getElementById('btnImportStudents');
const btnClearStudents = document.getElementById('btnClearStudents');
const btnSelectStudentFile = document.getElementById('btnSelectStudentFile');
const btnApplyStudentJson = document.getElementById('btnApplyStudentJson');
const btnImportGrades = document.getElementById('btnImportGrades');
const btnSaveGrades = document.getElementById('btnSaveGrades');
const btnSaveGradesToFile = document.getElementById('btnSaveGradesToFile');
const btnExportGradesJSON = document.getElementById('btnExportGradesJSON');
const btnExportGradesExcel = document.getElementById('btnExportGradesExcel');
const btnCalculateGrades = document.getElementById('btnCalculateGrades');
const btnExportFinalGrades = document.getElementById('btnExportFinalGrades');
const btnCopyGrades = document.getElementById('btnCopyGrades');
const btnSaveTestDetails = document.getElementById('btnSaveTestDetails');

// Grup y√∂netimi elementleri (aktif gruplar g√∂sterimi kaldƒ±rƒ±ldƒ±)
const groupMappingModal = document.getElementById('groupMappingModal');
const mappingContainer = document.getElementById('mappingContainer');
const addMappingRowBtn = document.getElementById('addMappingRow');
const saveMappingBtn = document.getElementById('saveMappingBtn');
const mappingActivityName = document.getElementById('mappingActivityName');

// =====================================================
// GUID Sƒ∞STEMƒ∞ KALDIRILDI - Basitle≈ütirme
// =====================================================

// GUID sistemi geli≈ütirmeleri kaldƒ±rƒ±ldƒ±
// Temel ID tabanlƒ± sistem korundu

// =====================================================
// √ñƒûRENCƒ∞ Lƒ∞STESƒ∞ Y√ñNETƒ∞Mƒ∞ - KOMPAKT KONTROLLER
// =====================================================

// √ñƒürenci g√∂r√ºn√ºm ayarlarƒ±
const STUDENT_VIEW_SETTINGS = {
    visibleColumns: {
        no: true,
        studentId: true,
        name: true,
        surname: true,
        email: true,
        phone: false,  // Varsayƒ±lan olarak gizli
        tckn: false,   // Varsayƒ±lan olarak gizli
        status: true,
        groups: true,
        actions: true
    },
    maskPhone: true,  // Default maskeleme a√ßƒ±k
    maskTCKN: true,   // Default maskeleme a√ßƒ±k
    currentSearch: '',
    currentStatusFilter: '',
    currentDirectSelect: '',
    currentGroupFilter: ''
};

// Deƒüerlendirme tablosu g√∂r√ºn√ºrl√ºk ayarlarƒ±
const ASSESSMENT_VIEW_SETTINGS = {
    visibleColumns: {
        no: true,
        studentId: true,
        name: true,
        surname: true,
        email: true,
        group: true,
        answerKey: true,       // Artƒ±k varsayƒ±lan g√∂r√ºn√ºr
        activityName: true,    // Artƒ±k varsayƒ±lan g√∂r√ºn√ºr
        description: true,     // Artƒ±k varsayƒ±lan g√∂r√ºn√ºr
        maxPoints: true,
        totalPoints: true,
        outcomes: true,        // Artƒ±k varsayƒ±lan g√∂r√ºn√ºr
        earnedPoints: true,
        termGrade: true,
        finalGrade: true,
        average: true,
        letterGrade: true
    }
};

/**
 * √ñƒürenci listesi kontrol panelini ba≈ülat
 */
function initializeStudentControls() {
    try {
        // Arama ve filtreleme
        setupSearchAndFiltering();
        
        // Buton event listener'larƒ±
        setupStudentActionButtons();
        
        // Kolon kontrolleri - tek sistem kullan
        setupTableViewControls();
        
    } catch (error) {
        console.error("√ñƒürenci kontrolleri ba≈ülatƒ±lƒ±rken hata:", error);
    }
}

/**
 * Deƒüerlendirme tablosu kolon g√∂r√ºn√ºrl√ºk kontrollerini ba≈ülat
 */
function initializeAssessmentControls() {
    try {
        // Deƒüerlendirme tablosu kolon kontrolleri
        setupAssessmentTableViewControls();
        
    } catch (error) {
        console.error("Deƒüerlendirme kontrolleri ba≈ülatƒ±lƒ±rken hata:", error);
    }
}

/**
 * Deƒüerlendirme tablosu kolon kontrolleri
 */
function setupAssessmentTableViewControls() {
    const assessmentColumnToggles = document.getElementById('assessmentColumnToggles');
    if (!assessmentColumnToggles) {
        console.log('‚ùå assessmentColumnToggles elementi bulunamadƒ±!');
        return;
    }

    // Mevcut event listener'larƒ± temizle
    const existingButtons = assessmentColumnToggles.querySelectorAll('.column-toggle');
    existingButtons.forEach(button => {
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);
    });

    // Yeni event listener'larƒ± ekle
    const columnButtons = assessmentColumnToggles.querySelectorAll('.column-toggle');
    
    columnButtons.forEach((button, index) => {
        const columnKey = button.dataset.column;
        
        // Ba≈ülangƒ±√ß durumunu ayarla
        const isVisible = ASSESSMENT_VIEW_SETTINGS.visibleColumns[columnKey];
        if (isVisible) {
            button.classList.add('active');
        } else {
            button.classList.remove('active');
        }
        
        button.addEventListener('click', function() {
            const columnKey = this.dataset.column;
            
            // Durumu deƒüi≈ütir
            ASSESSMENT_VIEW_SETTINGS.visibleColumns[columnKey] = !ASSESSMENT_VIEW_SETTINGS.visibleColumns[columnKey];
            
            // Buton g√∂r√ºn√ºm√ºn√º g√ºncelle
            if (ASSESSMENT_VIEW_SETTINGS.visibleColumns[columnKey]) {
                this.classList.add('active');
            } else {
                this.classList.remove('active');
            }
            
            // Tablo kolonlarƒ±nƒ± g√ºncelle
            updateAssessmentColumnVisibility();
        });
    });
    
    // ƒ∞lk y√ºkleme sƒ±rasƒ±nda kolon g√∂r√ºn√ºrl√ºƒü√ºn√º ayarla
    updateAssessmentColumnVisibility();
}

/**
 * Deƒüerlendirme tablosu kolon g√∂r√ºn√ºrl√ºƒü√ºn√º g√ºncelle
 */
function updateAssessmentColumnVisibility() {
    // T√ºm assessment tablolarƒ±nƒ± bul (normal ve paper-order dahil)
    const assessmentTables = document.querySelectorAll('.assessment-table');
    console.log(`üîÑ Toplam ${assessmentTables.length} assessment tablosu bulundu`);
    
    assessmentTables.forEach((table, tableIndex) => {
        console.log(`üìä Tablo ${tableIndex + 1} i≈üleniyor`);
        
        Object.keys(ASSESSMENT_VIEW_SETTINGS.visibleColumns).forEach(columnKey => {
            const isVisible = ASSESSMENT_VIEW_SETTINGS.visibleColumns[columnKey];
            const columnClass = `col-${columnKey}`;
            
            // Header h√ºcreleri
            const headerCells = table.querySelectorAll(`th.${columnClass}`);
            headerCells.forEach(cell => {
                cell.style.display = isVisible ? '' : 'none';
            });
            
            // Body h√ºcreleri
            const bodyCells = table.querySelectorAll(`td.${columnClass}`);
            bodyCells.forEach(cell => {
                cell.style.display = isVisible ? '' : 'none';
            });
            
            console.log(`üîÑ ${columnKey}: ${isVisible ? 'G√∂ster' : 'Gizle'} (${headerCells.length} header, ${bodyCells.length} body)`);
        });
    });
    
    // Kolon g√∂r√ºn√ºrl√ºk g√ºncellemesi sonrasƒ±nda butonlarƒ± kontrol et
    setTimeout(() => {
        if (typeof addAutoDistributeButtonsToTables === 'function') {
            addAutoDistributeButtonsToTables();
        }
    }, 50);
}

// Bu fonksiyon setupTableViewControls() ile birle≈ütirildi ve kaldƒ±rƒ±ldƒ±

/**
 * Kolon g√∂r√ºn√ºrl√ºƒü√ºn√º g√ºncelle
 */
function updateColumnVisibility() {
    const table = document.getElementById('studentTable');
    if (!table) return;
    
    // Header ve body h√ºcrelerini g√ºncelle
    Object.keys(STUDENT_VIEW_SETTINGS.visibleColumns).forEach(columnKey => {
        const isVisible = STUDENT_VIEW_SETTINGS.visibleColumns[columnKey];
        const columnClass = `col-${columnKey}`;
        
        // Header h√ºcreleri
        const headerCells = table.querySelectorAll(`th.${columnClass}`);
        headerCells.forEach(cell => {
            cell.style.display = isVisible ? '' : 'none';
        });
        
        // Body h√ºcreleri
        const bodyCells = table.querySelectorAll(`td.${columnClass}`);
        bodyCells.forEach(cell => {
            cell.style.display = isVisible ? '' : 'none';
        });
    });
}

/**
 * √ñƒürencinin t√ºm aktivitelerdeki gruplarƒ±nƒ± getir
 */
function getStudentAllGroups(studentId) {
    const studentGroups = {};
    
    // Eƒüer courseData ve grup haritalari varsa
    if (APP_STATE.courseData?.grupHaritalari) {
        Object.keys(APP_STATE.courseData.grupHaritalari).forEach(componentId => {
            // Sadece ana etkinlikleri al (A1, A2, F1, F2 gibi - nokta i√ßermeyenler)
            if (!componentId.includes('.')) {
                const group = getStudentGroupForComponent(studentId, componentId);
                if (group) {
                    studentGroups[componentId] = group;
                }
            }
        });
    }
    
    return studentGroups;
}

/**
 * √ñƒürenci gruplarƒ±nƒ± format edilmi≈ü string olarak d√∂nd√ºr
 */
function formatStudentGroups(studentId) {
    // ogrenciNotlari.grupBilgileri formatƒ±ndan grup bilgilerini al ve tag butonlarƒ± olu≈ütur
    if (!APP_STATE.courseData?.ogrenciNotlari?.[studentId]?.grupBilgileri) {
        return '<span class="no-groups">-</span>';
    }
    
    const grupBilgileri = APP_STATE.courseData.ogrenciNotlari[studentId].grupBilgileri;
    const groupTags = [];
    
    // Ana aktiviteler i√ßin grup bilgilerini al
    Object.keys(grupBilgileri).forEach(componentId => {
        if (!componentId.includes('.')) { // Sadece ana aktiviteler
            const group = grupBilgileri[componentId];
            groupTags.push(`<span class="group-tag" data-component="${componentId}" data-group="${group}">${componentId}: ${group}</span>`);
        }
    });
    
    return groupTags.length > 0 ? groupTags.join('') : '<span class="no-groups">-</span>';
}

/**
 * Arama ve filtreleme kontrollerini ayarla
 */
function setupSearchAndFiltering() {
    const searchInput = document.getElementById('studentSearch');
    const statusFilter = document.getElementById('statusFilter');
    const clearFiltersBtn = document.getElementById('btnClearFilters');
    
    // Arama kutusu
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            STUDENT_VIEW_SETTINGS.currentSearch = this.value;
            updateStudentTableEnhanced();
        });
    }
    
    // Durum filtresi
    if (statusFilter) {
        statusFilter.addEventListener('change', function() {
            STUDENT_VIEW_SETTINGS.currentStatusFilter = this.value;
            updateStudentTableEnhanced();
        });
    }
    
    // Filtreleri temizle
    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', function() {
            STUDENT_VIEW_SETTINGS.currentSearch = '';
            STUDENT_VIEW_SETTINGS.currentStatusFilter = '';
            
            if (searchInput) searchInput.value = '';
            if (statusFilter) statusFilter.value = '';
            
            updateStudentTableEnhanced();
        });
    }
}

/**
 * Aksiyon butonlarƒ±nƒ± ayarla
 */
function setupStudentActionButtons() {
    const btnImportStudents = document.getElementById('btnImportStudents');
    const btnImportStudentsCSV = document.getElementById('btnImportStudentsCSV');
    const btnExportStudentsCSV = document.getElementById('btnExportStudentsCSV');
    const btnAddStudent = document.getElementById('btnAddStudent');
    
    if (btnImportStudents) {
        btnImportStudents.addEventListener('click', function() {
            document.getElementById('studentFileInput').click();
        });
    }
    
    if (btnImportStudentsCSV) {
        btnImportStudentsCSV.addEventListener('click', function() {
            document.getElementById('studentCSVInput').click();
        });
    }
    
    if (btnExportStudentsCSV) {
        btnExportStudentsCSV.addEventListener('click', exportStudentsToCSV);
    }
    
    if (btnAddStudent) {
        btnAddStudent.addEventListener('click', showAddStudentModal);
    }
    
    // Dosya input'larƒ±nƒ± ayarla
    const studentFileInput = document.getElementById('studentFileInput');
    const studentCSVInput = document.getElementById('studentCSVInput');
    
    if (studentFileInput) {
        studentFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                processStudentJSONFile(file);
            }
        });
    }
    
    if (studentCSVInput) {
        studentCSVInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                processStudentCSVFile(file);
            }
        });
    }
}

/**
 * Geli≈ümi≈ü √∂ƒürenci tablosunu g√ºncelle
 */
function updateStudentTableEnhanced() {
    try {
        // T√ºm √∂ƒürenci dropdown'larƒ±nƒ± g√ºncelle
        updateAllStudentDropdowns();
        
        const studentTable = document.getElementById('studentTable');
        if (!studentTable) return;
        
        const thead = studentTable.querySelector('thead');
        const tbody = studentTable.querySelector('tbody');
        
        if (!thead || !tbody) return;
        
        // √ñƒürenci verilerini filtrele
        const filteredStudents = filterStudents();
        
        // Tablo i√ßeriƒüini g√ºncelle
        tbody.innerHTML = '';
        
        if (filteredStudents.length === 0) {
            const emptyRow = document.createElement('tr');
            emptyRow.innerHTML = `<td colspan="10" class="empty-message">
                ${STUDENT_VIEW_SETTINGS.currentSearch || STUDENT_VIEW_SETTINGS.currentStatusFilter 
                    ? 'Filtrelere uygun √∂ƒürenci bulunamadƒ±' 
                    : '√ñƒürenci listesi y√ºklenmedi'}
            </td>`;
            tbody.appendChild(emptyRow);
        } else {
            filteredStudents.forEach((student, index) => {
                const row = document.createElement('tr');
                
                // Duruma g√∂re satƒ±r stili
                if (student.status === 'ƒ∞li≈üiƒüi Kesilmi≈ü') {
                    row.style.color = 'var(--text-light)';
                    row.style.backgroundColor = 'rgba(0, 0, 0, 0.05)';
                }
                
                row.innerHTML = `
                    <td class="col-no">${index + 1}</td>
                    <td class="col-studentId">${student.studentId || ''}</td>
                    <td class="col-name">${student.name || ''}</td>
                    <td class="col-surname">${student.surname || ''}</td>
                    <td class="col-email">
                        <div class="email-cell">
                            <div class="email-display">${formatEmail(student.email)}</div>
                            ${student.email ? `<button class="email-button" onclick="openEmailModal({studentId: '${student.studentId}', name: '${student.name}', surname: '${student.surname}', email: '${student.email}'})" title="E-posta G√∂nder">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                                    <polyline points="22 6 12 13 2 6"></polyline>
                                </svg>
                                E-posta
                            </button>` : ''}
                        </div>
                    </td>
                    <td class="col-phone">
                        <span class="phone-display">${formatPhoneNumber(student.telefon)}</span>
                    </td>
                    <td class="col-tckn">
                        <span class="tckn-display">${formatTCKN(student.tcKimlik)}</span>
                    </td>
                    <td class="col-status">${student.status || 'Aktif'}</td>
                    <td class="col-groups"><div class="student-groups-display">${formatStudentGroups(student.studentId)}</div></td>
                    <td class="col-actions">
                        <div class="student-actions">
                            <button class="btn btn-edit btn-sm" onclick="editStudent('${student.studentId}')" title="D√ºzenle">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                            <button class="btn btn-delete btn-sm" onclick="deleteStudent('${student.studentId}')" title="Sil">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2 2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Kolon g√∂r√ºn√ºrl√ºƒü√ºn√º g√ºncelle
        updateColumnVisibility();
        
        // Event listener'larƒ± yeniden baƒüla
        setupTableViewControls();
        
    } catch (error) {
        console.error("√ñƒürenci tablosu g√ºncellenirken hata:", error);
        showModernToast("√ñƒürenci tablosu g√ºncellenemedi!", "error");
    }
}

/**
 * √ñƒürencileri filtrele
 */
function filterStudents() {
    if (!APP_STATE.studentData || APP_STATE.studentData.length === 0) {
        return [];
    }
    
    return APP_STATE.studentData.filter(student => {
        // Doƒürudan se√ßim filtresi (en y√ºksek √∂ncelik)
        if (STUDENT_VIEW_SETTINGS.currentDirectSelect) {
            return student.studentId === STUDENT_VIEW_SETTINGS.currentDirectSelect;
        }
        
        // Arama filtresi
        if (STUDENT_VIEW_SETTINGS.currentSearch) {
            const searchTerm = STUDENT_VIEW_SETTINGS.currentSearch.toLowerCase();
            const searchableText = `${student.name} ${student.surname} ${student.studentId} ${student.email || ''}`.toLowerCase();
            if (!searchableText.includes(searchTerm)) {
                return false;
            }
        }
        
        // Durum filtresi
        if (STUDENT_VIEW_SETTINGS.currentStatusFilter) {
            const studentStatus = student.status || 'Aktif';
            if (studentStatus !== STUDENT_VIEW_SETTINGS.currentStatusFilter) {
                return false;
            }
        }
        
        // Grup filtresi
        if (STUDENT_VIEW_SETTINGS.currentGroupFilter) {
            let studentGroup = 'A'; // Varsayƒ±lan grup
            if (APP_STATE.courseData?.ogrenciNotlari?.[student.studentId]?.grupBilgileri) {
                // ƒ∞lk etkinliƒüin grup bilgisini al
                const firstActivity = Object.keys(APP_STATE.courseData.ogrenciNotlari[student.studentId].grupBilgileri)[0];
                if (firstActivity) {
                    studentGroup = APP_STATE.courseData.ogrenciNotlari[student.studentId].grupBilgileri[firstActivity];
                }
            }
            if (studentGroup !== STUDENT_VIEW_SETTINGS.currentGroupFilter) {
                return false;
            }
        }
        
        return true;
    });
}

/**
 * CSV'ye dƒ±≈üa aktar
 */
function exportStudentsToCSV() {
    try {
        const filteredStudents = filterStudents();
        if (filteredStudents.length === 0) {
            showModernToast("Dƒ±≈üa aktarƒ±lacak √∂ƒürenci bulunamadƒ±!", "warning");
            return;
        }
        
        const columnHeaders = [
            'No', '√ñƒürenci No', 'Adƒ±', 'Soyadƒ±', 'E-Posta', 'Telefon', 'TCKN', 'Durum', 'Gruplar'
        ];
        
        // CSV ba≈ülƒ±klarƒ±
        const headers = columnHeaders.join(',');
        
        // CSV satƒ±rlarƒ±
        const rows = filteredStudents.map((student, index) => {
            const values = [
                index + 1,
                student.studentId || '',
                student.name || '',
                student.surname || '',
                student.email || '',
                student.telefon || '',
                student.tcKimlik || '',
                student.status || 'Aktif',
                formatStudentGroups(student.studentId)
            ];
            return values.join(',');
        });
        
        const csvContent = [headers, ...rows].join('\n');
        
        // Dosyayƒ± indir
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `ogrenci-listesi-${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showModernToast(`${filteredStudents.length} √∂ƒürenci CSV olarak dƒ±≈üa aktarƒ±ldƒ±!`, "success");
        
    } catch (error) {
        console.error("CSV dƒ±≈üa aktarƒ±m hatasƒ±:", error);
        showModernToast("CSV dƒ±≈üa aktarƒ±mƒ± ba≈üarƒ±sƒ±z!", "error");
    }
}

// =====================================================
// √ñƒûRENCƒ∞ Y√ñNETƒ∞Mƒ∞ ƒ∞≈ûLEMLERƒ∞ - BUTON FONKSƒ∞YONLARI
// =====================================================

/**
 * JSON dosyasƒ±ndan √∂ƒürenci verilerini y√ºkle
 */
function handleStudentJSONImport() {
    console.log("üì• JSON √∂ƒürenci import ba≈ülatƒ±ldƒ±");
    
    const fileInput = document.getElementById('studentFileInput');
    fileInput.click();
}

/**
 * CSV dosyasƒ±ndan √∂ƒürenci verilerini y√ºkle
 */
function handleStudentCSVImport() {
    console.log("üì• CSV √∂ƒürenci import ba≈ülatƒ±ldƒ±");
    
    const fileInput = document.getElementById('studentCSVInput');
    fileInput.click();
}

/**
 * JSON dosyasƒ±nƒ± i≈üle
 */
function processStudentJSONFile(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const jsonData = JSON.parse(e.target.result);
            const studentData = parseJSONToStudents(jsonData);
            
            if (studentData.length > 0) {
                APP_STATE.studentData = studentData;
                
                // T√ºm GUI bile≈üenlerini g√ºncelle
                updateStudentTableEnhanced(); // Bu artƒ±k t√ºm dropdown'larƒ± g√ºncelliyor
                updateStudentGroupInfo();
                updateAssessmentStudentFilter();
                updateAssessmentView();
                
                showModernToast(`${studentData.length} √∂ƒürenci JSON'dan A grubuna y√ºklendi!`, "success");
                console.log(`‚úÖ ${studentData.length} √∂ƒürenci JSON'dan A grubuna y√ºklendi`);
            } else {
                showModernToast("JSON dosyasƒ±nda ge√ßerli √∂ƒürenci verisi bulunamadƒ±!", "warning");
            }
        } catch (error) {
            console.error("JSON i≈üleme hatasƒ±:", error);
            showModernToast("JSON dosyasƒ± i≈ülenirken hata olu≈ütu!", "error");
        }
    };
    reader.readAsText(file);
}

/**
 * JSON verisini √∂ƒürenci verilerine d√∂n√º≈üt√ºr
 */
function parseJSONToStudents(jsonData) {
    const students = [];
    
    try {
        let dataArray = [];
        
        // Farklƒ± JSON formatlarƒ±nƒ± destekle
        if (Array.isArray(jsonData)) {
            dataArray = jsonData;
        } else if (jsonData.ogrenciNotlari) {
            // MUDEK formatƒ±
            dataArray = Object.keys(jsonData.ogrenciNotlari).map(studentId => {
                const studentInfo = jsonData.ogrenciNotlari[studentId];
                return {
                    studentId: studentId,
                    name: studentInfo.ad || '',
                    surname: studentInfo.soyad || '',
                    email: studentInfo.email || '',
                    telefon: studentInfo.telefon || '',
                    tcKimlik: studentInfo.tcKimlik || '',
                    status: studentInfo.durum || 'Aktif'
                };
            });
        } else if (jsonData.students) {
            dataArray = jsonData.students;
        } else if (jsonData.ogrenciler) {
            dataArray = jsonData.ogrenciler;
        } else {
            // Tek √∂ƒürenci objesi
            dataArray = [jsonData];
        }
        
        // Her √∂ƒürenciyi normalize et
        dataArray.forEach(item => {
            const student = {
                studentId: item.studentId || item.ogrenciNo || item.no || item.id || '',
                name: item.name || item.ad || item.adi || item.firstName || '',
                surname: item.surname || item.soyad || item.soyadi || item.lastName || '',
                email: item.email || item.eposta || item.mail || '',
                telefon: item.telefon || item.phone || item.tel || item.gsm || '',
                tcKimlik: item.tcKimlik || item.tc || item.tckn || '',
                status: item.status || item.durum || 'Aktif',
                grupId: 'A' // JSON'dan y√ºklenen t√ºm √∂ƒürenciler A grubuna atanƒ±r
            };
            
            // En az √∂ƒürenci no ve ad olmalƒ±
            if (student.studentId && student.name) {
                students.push(student);
            }
        });
        
    } catch (error) {
        console.error("JSON parsing hatasƒ±:", error);
        throw error;
    }
    
    return students;
}

/**
 * CSV dosyasƒ±nƒ± i≈üle
 */
function processStudentCSVFile(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const csvText = e.target.result;
            const studentData = parseCSVToStudents(csvText);
            
            if (studentData.length > 0) {
                APP_STATE.studentData = studentData;
                
                // T√ºm GUI bile≈üenlerini g√ºncelle
                updateStudentTableEnhanced(); // Bu artƒ±k t√ºm dropdown'larƒ± g√ºncelliyor
                updateStudentGroupInfo();
                updateAssessmentStudentFilter();
                updateAssessmentView();
                
                showModernToast(`${studentData.length} √∂ƒürenci CSV'den A grubuna y√ºklendi!`, "success");
                console.log(`‚úÖ ${studentData.length} √∂ƒürenci CSV'den A grubuna y√ºklendi`);
            } else {
                showModernToast("CSV dosyasƒ±nda ge√ßerli √∂ƒürenci verisi bulunamadƒ±!", "warning");
            }
        } catch (error) {
            console.error("CSV i≈üleme hatasƒ±:", error);
            showModernToast("CSV dosyasƒ± i≈ülenirken hata olu≈ütu!", "error");
        }
    };
    reader.readAsText(file);
}

/**
 * CSV metnini √∂ƒürenci verilerine d√∂n√º≈üt√ºr
 */
function parseCSVToStudents(csvText) {
    const lines = csvText.trim().split('\n');
    if (lines.length < 2) {
        throw new Error("CSV dosyasƒ± √ßok kƒ±sa");
    }
    
    // ƒ∞lk satƒ±rƒ± ba≈ülƒ±k olarak al
    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
    const students = [];
    
    // Ba≈ülƒ±k e≈üle≈ütirmesi
    const headerMap = {
        studentId: findHeaderIndex(headers, ['√∂ƒürenci no', 'student id', 'numara', 'no', '√∂ƒürenci_no']),
        name: findHeaderIndex(headers, ['ad', 'adƒ±', 'name', 'first name', 'isim']),
        surname: findHeaderIndex(headers, ['soyad', 'soyadƒ±', 'surname', 'last name', 'soyisim']),
        email: findHeaderIndex(headers, ['e-posta', 'email', 'e-mail', 'eposta', 'mail']),
        telefon: findHeaderIndex(headers, ['telefon', 'phone', 'tel', 'gsm', 'cep']),
        tcKimlik: findHeaderIndex(headers, ['tc', 'tckn', 'tc kimlik', 'tc no', 'kimlik no']),
        status: findHeaderIndex(headers, ['durum', 'status', 'state', 'aktif'])
    };
    
    console.log("üìã CSV ba≈ülƒ±k e≈üle≈ütirmesi:", headerMap);
    
    // Veri satƒ±rlarƒ±nƒ± i≈üle
    for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        
        const values = parseCSVLine(line);
        
        const student = {
            studentId: getValue(values, headerMap.studentId),
            name: getValue(values, headerMap.name),
            surname: getValue(values, headerMap.surname),
            email: getValue(values, headerMap.email),
            telefon: getValue(values, headerMap.telefon),
            tcKimlik: getValue(values, headerMap.tcKimlik),
            status: getValue(values, headerMap.status) || 'Aktif',
            grupId: 'A' // CSV'den y√ºklenen t√ºm √∂ƒürenciler A grubuna atanƒ±r
        };
        
        // En az √∂ƒürenci no ve ad olmalƒ±
        if (student.studentId && student.name) {
            students.push(student);
        }
    }
    
    return students;
}

/**
 * CSV satƒ±rƒ±nƒ± ayrƒ±≈ütƒ±r (virg√ºl ve tƒ±rnak i≈üaretlerini dikkate alarak)
 */
function parseCSVLine(line) {
    const values = [];
    let current = '';
    let inQuotes = false;
    
    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
            inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
            values.push(current.trim());
            current = '';
        } else {
            current += char;
        }
    }
    
    values.push(current.trim());
    return values;
}

/**
 * Ba≈ülƒ±k indeksini bul
 */
function findHeaderIndex(headers, possibleNames) {
    for (let i = 0; i < headers.length; i++) {
        const header = headers[i].toLowerCase();
        if (possibleNames.some(name => header.includes(name.toLowerCase()))) {
            return i;
        }
    }
    return -1;
}

/**
 * Deƒüer al
 */
function getValue(values, index) {
    if (index >= 0 && index < values.length) {
        return values[index].replace(/"/g, '').trim();
    }
    return '';
}

/**
 * √ñƒürencileri CSV olarak dƒ±≈üa aktar (sadece g√∂r√ºnen kolonlar)
 */
function exportStudentsToCSV() {
    try {
        const filteredStudents = filterStudents();
        if (filteredStudents.length === 0) {
            showModernToast("Dƒ±≈üa aktarƒ±lacak √∂ƒürenci bulunamadƒ±!", "warning");
            return;
        }
        
        // G√∂r√ºnen kolonlarƒ± belirle
        const visibleColumns = getVisibleColumns();
        const headers = [];
        const columnKeys = [];
        
        // Ba≈ülƒ±klarƒ± olu≈ütur
        if (visibleColumns.includes('col-no')) {
            headers.push('No');
            columnKeys.push('no');
        }
        if (visibleColumns.includes('col-studentId')) {
            headers.push('√ñƒürenci No');
            columnKeys.push('studentId');
        }
        if (visibleColumns.includes('col-name')) {
            headers.push('Adƒ±');
            columnKeys.push('name');
        }
        if (visibleColumns.includes('col-surname')) {
            headers.push('Soyadƒ±');
            columnKeys.push('surname');
        }
        if (visibleColumns.includes('col-email')) {
            headers.push('E-Posta');
            columnKeys.push('email');
        }
        if (visibleColumns.includes('col-phone')) {
            headers.push('Telefon');
            columnKeys.push('phone');
        }
        if (visibleColumns.includes('col-tckn')) {
            headers.push('TCKN');
            columnKeys.push('tckn');
        }
        if (visibleColumns.includes('col-status')) {
            headers.push('Durum');
            columnKeys.push('status');
        }
        if (visibleColumns.includes('col-groups')) {
            headers.push('Gruplar');
            columnKeys.push('groups');
        }
        
        // CSV i√ßeriƒüini olu≈ütur
        const csvRows = [headers.join(',')];
        
        filteredStudents.forEach((student, index) => {
            const row = [];
            
            columnKeys.forEach(key => {
                let value = '';
                
                switch (key) {
                    case 'no':
                        value = index + 1;
                        break;
                    case 'studentId':
                        value = student.studentId || '';
                        break;
                    case 'name':
                        value = student.name || '';
                        break;
                    case 'surname':
                        value = student.surname || '';
                        break;
                    case 'email':
                        value = student.email || '';
                        break;
                    case 'phone':
                        // Maskeleme durumuna g√∂re telefon formatla
                        value = formatPhoneNumber(student.telefon);
                        break;
                    case 'tckn':
                        // Maskeleme durumuna g√∂re TCKN formatla
                        value = formatTCKN(student.tcKimlik);
                        break;
                    case 'status':
                        value = student.status || 'Aktif';
                        break;
                    case 'groups':
                        value = formatStudentGroups(student.studentId);
                        break;
                }
                
                // CSV i√ßin deƒüeri temizle
                if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                    value = `"${value.replace(/"/g, '""')}"`;
                }
                
                row.push(value);
            });
            
            csvRows.push(row.join(','));
        });
        
        const csvContent = csvRows.join('\n');
        
        // Dosyayƒ± indir
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `ogrenci-listesi-${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showModernToast(`${filteredStudents.length} √∂ƒürenci CSV olarak dƒ±≈üa aktarƒ±ldƒ±!`, "success");
        console.log(`üì§ ${filteredStudents.length} √∂ƒürenci CSV olarak dƒ±≈üa aktarƒ±ldƒ±`);
        
    } catch (error) {
        console.error("CSV dƒ±≈üa aktarƒ±m hatasƒ±:", error);
        showModernToast("CSV dƒ±≈üa aktarƒ±mƒ± ba≈üarƒ±sƒ±z!", "error");
    }
}

/**
 * G√∂r√ºnen kolonlarƒ± al
 */
function getVisibleColumns() {
    const visibleColumns = [];
    const columnToggles = document.querySelectorAll('.column-toggle.active');
    
    columnToggles.forEach(toggle => {
        const column = toggle.getAttribute('data-column');
        if (column) {
            visibleColumns.push(column);
        }
    });
    
    return visibleColumns;
}

/**
 * Yeni √∂ƒürenci ekleme modalƒ±nƒ± g√∂ster
 */
function showAddStudentModal() {
    console.log("‚ûï Yeni √∂ƒürenci ekleme modalƒ± a√ßƒ±lƒ±yor");
    
    // Yeni √∂ƒürenci modalƒ±nƒ± olu≈ütur
    const modal = createAddStudentModal();
    document.body.appendChild(modal);
    
    // Modalƒ± g√∂ster
    modal.style.display = 'flex';
    modal.classList.add('active');
    
    // Form submit event listener'ƒ± ekle
    const form = document.getElementById('addStudentForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            addNewStudent();
        });
    }
}

/**
 * Rastgele √∂ƒürenci verisi olu≈üturma fonksiyonlarƒ±
 */
const RANDOM_STUDENT_DATA = {
    names: [
        'Ahmet', 'Mehmet', 'Ali', 'Mustafa', 'Hasan', 'H√ºseyin', 'ƒ∞brahim', 'ƒ∞smail', 'Yusuf', 'S√ºleyman',
        'Fatma', 'Ay≈üe', 'Emine', 'Hatice', 'Zeynep', 'Elif', 'Meryem', 'Esra', 'B√º≈üra', 'Seda',
        'Emre', 'Serkan', 'Murat', 'Kemal', '√ñzg√ºr', 'Burak', 'Cem', 'Deniz', 'Onur', 'Barƒ±≈ü',
        'Cansu', 'Gizem', 'Merve', '√ñzlem', 'Pƒ±nar', 'Sibel', 'T√ºlay', 'Yeliz', 'Didem', 'Burcu'
    ],
    surnames: [
        'Yƒ±lmaz', 'Kaya', 'Demir', '≈ûahin', '√áelik', 'Aydƒ±n', '√ñzt√ºrk', 'Arslan', 'Doƒüan', 'Kƒ±lƒ±√ß',
        'Aslan', '√áetin', 'Kara', 'Ko√ß', 'Kurt', '√ñzkan', '≈ûim≈üek', 'G√ºne≈ü', 'Erdoƒüan', 'Yƒ±ldƒ±z',
        'Polat', 'Bulut', 'Demirta≈ü', 'Kaplan', '√áakƒ±r', '√ñzer', 'Turan', 'S√∂nmez', 'Korkmaz', 'Ta≈ü'
    ],
    domains: ['gmail.com', 'hotmail.com', 'yahoo.com', 'outlook.com', 'rteu.edu.tr', 'student.rteu.edu.tr']
};

/**
 * Rastgele √∂ƒürenci verisi olu≈ütur
 */
function generateRandomStudentData() {
    const names = RANDOM_STUDENT_DATA.names;
    const surnames = RANDOM_STUDENT_DATA.surnames;
    const domains = RANDOM_STUDENT_DATA.domains;
    
    const name = names[Math.floor(Math.random() * names.length)];
    const surname = surnames[Math.floor(Math.random() * surnames.length)];
    
    // Benzersiz √∂ƒürenci numarasƒ± olu≈ütur
    let studentId;
    do {
        studentId = Math.floor(Math.random() * 900000) + 100000; // 6 haneli numara
    } while (APP_STATE.studentData && APP_STATE.studentData.find(s => s.studentId === studentId.toString()));
    
    // E-posta olu≈ütur
    const domain = domains[Math.floor(Math.random() * domains.length)];
    const email = `${name.toLowerCase()}.${surname.toLowerCase()}@${domain}`;
    
    // Telefon numarasƒ± olu≈ütur (05XX XXX XX XX formatƒ±nda)
    const phonePrefix = ['50', '51', '52', '53', '54', '55', '56', '57', '58', '59'];
    const prefix = phonePrefix[Math.floor(Math.random() * phonePrefix.length)];
    const phone = `0${prefix}${Math.floor(Math.random() * 9000000) + 1000000}`;
    
    // TCKN olu≈ütur (11 haneli, basit algoritma)
    const tckn = generateRandomTCKN();
    
    return {
        studentId: studentId.toString(),
        name: name,
        surname: surname,
        email: email,
        phone: phone,
        tckn: tckn,
        status: 'Aktif'
    };
}

/**
 * Rastgele TCKN olu≈ütur (basit algoritma)
 */
function generateRandomTCKN() {
    // ƒ∞lk 9 haneli rastgele olu≈ütur
    let tckn = '';
    for (let i = 0; i < 9; i++) {
        tckn += Math.floor(Math.random() * 10);
    }
    
    // 10. haneyi hesapla
    let oddSum = 0, evenSum = 0;
    for (let i = 0; i < 9; i++) {
        if (i % 2 === 0) {
            oddSum += parseInt(tckn[i]);
        } else {
            evenSum += parseInt(tckn[i]);
        }
    }
    
    const tenthDigit = ((oddSum * 7) - evenSum) % 10;
    tckn += tenthDigit;
    
    // 11. haneyi hesapla
    let totalSum = 0;
    for (let i = 0; i < 10; i++) {
        totalSum += parseInt(tckn[i]);
    }
    const eleventhDigit = totalSum % 10;
    tckn += eleventhDigit;
    
    return tckn;
}

/**
 * Form alanlarƒ±nƒ± rastgele verilerle doldur
 */
function fillRandomStudentData() {
    const randomData = generateRandomStudentData();
    
    document.getElementById('addStudentId').value = randomData.studentId;
    document.getElementById('addStudentName').value = randomData.name;
    document.getElementById('addStudentSurname').value = randomData.surname;
    document.getElementById('addStudentEmail').value = randomData.email;
    document.getElementById('addStudentPhone').value = randomData.phone;
    document.getElementById('addStudentTCKN').value = randomData.tckn;
    document.getElementById('addStudentStatus').value = randomData.status;
    
    showModernToast('Rastgele √∂ƒürenci verisi olu≈üturuldu!', 'info');
    console.log('üé≤ Rastgele √∂ƒürenci verisi:', randomData);
}

/**
 * Yeni √∂ƒürenci ekleme modalƒ±nƒ± olu≈ütur
 */
function createAddStudentModal() {
    const modal = document.createElement('div');
    modal.className = 'modern-modal';
    modal.id = 'addStudentModal';
    
    modal.innerHTML = `
        <div class="modern-modal-content">
            <div class="modern-modal-header success-action">
                <h2>‚ûï Yeni √ñƒürenci Ekle</h2>
                <button class="modern-close" onclick="closeAddStudentModal()">√ó</button>
            </div>
            <div class="modern-modal-body">
                <div class="random-data-section">
                    <button type="button" class="btn btn-info btn-sm" onclick="fillRandomStudentData()" title="Test i√ßin rastgele √∂ƒürenci verisi olu≈ütur">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                            <path d="M2 17l10 5 10-5"></path>
                            <path d="M2 12l10 5 10-5"></path>
                        </svg>
                        üé≤ Rastgele Veri Olu≈ütur
                    </button>
                    <small class="text-muted">Test i√ßin hƒ±zlƒ±ca rastgele √∂ƒürenci verisi olu≈üturur</small>
                </div>
                
                <form id="addStudentForm">
                    <div class="form-group">
                        <label for="addStudentId">√ñƒürenci No: *</label>
                        <input type="text" id="addStudentId" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="addStudentName">Adƒ±: *</label>
                        <input type="text" id="addStudentName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="addStudentSurname">Soyadƒ±: *</label>
                        <input type="text" id="addStudentSurname" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="addStudentEmail">E-Posta:</label>
                        <input type="email" id="addStudentEmail">
                    </div>
                    
                    <div class="form-group">
                        <label for="addStudentPhone">Telefon:</label>
                        <input type="tel" id="addStudentPhone">
                    </div>
                    
                    <div class="form-group">
                        <label for="addStudentTCKN">TCKN:</label>
                        <input type="text" id="addStudentTCKN" maxlength="11">
                    </div>
                    
                    <div class="form-group">
                        <label for="addStudentStatus">Durum:</label>
                        <select id="addStudentStatus">
                            <option value="Aktif">Aktif</option>
                            <option value="ƒ∞li≈üiƒüi Kesilmi≈ü">ƒ∞li≈üiƒüi Kesilmi≈ü</option>
                        </select>
                    </div>
                    
                    <div class="info-message" style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); border-color: #2196f3; color: #0d47a1; margin-top: 1rem;">
                        <p><strong>‚ÑπÔ∏è Not:</strong> Yeni √∂ƒürenciler otomatik olarak <strong>A grubuna</strong> atanƒ±r.</p>
                    </div>
                </form>
            </div>
            <div class="modern-modal-footer">
                <button type="button" class="modern-confirm-btn btn-primary" onclick="addNewStudent()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="16"></line>
                        <line x1="8" y1="12" x2="16" y2="12"></line>
                    </svg>
                    √ñƒürenci Ekle (A Grubuna)
                </button>
                <button type="button" class="modern-confirm-btn btn-secondary" onclick="closeAddStudentModal()">ƒ∞ptal</button>
            </div>
        </div>
    `;
    
    return modal;
}

/**
 * Yeni √∂ƒürenci ekle
 */
function addNewStudent() {
    console.log("üíæ Yeni √∂ƒürenci ekleniyor");
    
    try {
        const studentId = document.getElementById('addStudentId').value.trim();
        const name = document.getElementById('addStudentName').value.trim();
        const surname = document.getElementById('addStudentSurname').value.trim();
        const email = document.getElementById('addStudentEmail').value.trim();
        const phone = document.getElementById('addStudentPhone').value.trim();
        const tckn = document.getElementById('addStudentTCKN').value.trim();
        const status = document.getElementById('addStudentStatus').value;
        
        // Validasyon
        if (!studentId || !name || !surname) {
            showModernToast("√ñƒürenci No, Ad ve Soyad alanlarƒ± zorunludur!", "error");
            return;
        }
        
        // Aynƒ± ID ile √∂ƒürenci var mƒ± kontrol et
        const existingStudent = APP_STATE.studentData.find(s => s.studentId === studentId);
        if (existingStudent) {
            showModernToast("Bu √∂ƒürenci numarasƒ± zaten kullanƒ±lƒ±yor!", "error");
            return;
        }
        
        // E-posta validasyonu
        if (email && !isValidEmail(email)) {
            showModernToast("Ge√ßerli bir e-posta adresi girin!", "error");
            return;
        }
        
        // TCKN validasyonu
        if (tckn && (tckn.length !== 11 || !/^\d{11}$/.test(tckn))) {
            showModernToast("TCKN 11 haneli sayƒ± olmalƒ±dƒ±r!", "error");
            return;
        }
        
        // Yeni √∂ƒürenci olu≈ütur - Her zaman A grubuna ata
        const newStudent = {
            studentId: studentId,
            name: name,
            surname: surname,
            email: email,
            telefon: phone,
            tcKimlik: tckn,
            status: status,
            grupId: 'A' // Varsayƒ±lan olarak A grubuna ata
        };
        
        // √ñƒürenciyi listeye ekle
        if (!APP_STATE.studentData) {
            APP_STATE.studentData = [];
        }
        APP_STATE.studentData.push(newStudent);
        
        // Grup bilgilerini de g√ºncelle (courseData formatƒ±nda)
        if (APP_STATE.courseData && APP_STATE.courseData.ogrenciNotlari) {
            if (!APP_STATE.courseData.ogrenciNotlari[studentId]) {
                APP_STATE.courseData.ogrenciNotlari[studentId] = {
                    grupBilgileri: {}
                };
            }
            
            // T√ºm ana aktiviteler i√ßin A grubuna ata
            if (APP_STATE.assessmentTree) {
                APP_STATE.assessmentTree.forEach(activity => {
                    if (activity.id.startsWith('A') || activity.id.startsWith('F')) {
                        APP_STATE.courseData.ogrenciNotlari[studentId].grupBilgileri[activity.id] = 'A';
                    }
                });
            }
        }
        
        // T√ºm GUI bile≈üenlerini g√ºncelle
        updateStudentTableEnhanced(); // Bu artƒ±k t√ºm dropdown'larƒ± g√ºncelliyor
        updateStudentGroupInfo();
        updateAssessmentStudentFilter();
        updateAssessmentView();
        
        // Modalƒ± kapat
        closeAddStudentModal();
        
        showModernToast(`√ñƒürenci "${name} ${surname}" A grubuna eklendi!`, "success");
        console.log(`‚úÖ Yeni √∂ƒürenci A grubuna eklendi: ${studentId}`);
        
    } catch (error) {
        console.error("√ñƒürenci ekleme hatasƒ±:", error);
        showModernToast("√ñƒürenci eklenemedi!", "error");
    }
}

/**
 * Yeni √∂ƒürenci ekleme modalƒ±nƒ± kapat
 */
function closeAddStudentModal() {
    const modal = document.getElementById('addStudentModal');
    if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('active');
        document.body.removeChild(modal);
    }
}



/**
 * √ñƒürencileri gruplarƒ±na g√∂re organize et
 */
function organizeStudentsByGroups() {
    const groupData = {};
    
    if (!APP_STATE.studentData) return groupData;
    
    APP_STATE.studentData.forEach(student => {
        const groupId = student.grupId || 'A'; // Varsayƒ±lan A grubu
        
        if (!groupData[groupId]) {
            groupData[groupId] = [];
        }
        
        groupData[groupId].push(student);
    });
    
    return groupData;
}

/**
 * Deƒüerlendirme sekmesindeki √∂ƒürenci filtresini g√ºncelle
 */
function updateAssessmentStudentFilter() {
    try {
        const filterSelect = document.getElementById('assessmentStudentFilter');
        if (!filterSelect) return;
        
        // Mevcut se√ßimi sakla
        const currentValue = filterSelect.value;
        
        // Filtreyi temizle
        filterSelect.innerHTML = '<option value="">T√ºm √ñƒürenciler</option>';
        
        if (!APP_STATE.studentData || APP_STATE.studentData.length === 0) {
            return;
        }
        
        // √ñƒürencileri sƒ±rala ve ekle
        const sortedStudents = [...APP_STATE.studentData].sort((a, b) => {
            return a.studentId.localeCompare(b.studentId);
        });
        
        sortedStudents.forEach(student => {
            const option = document.createElement('option');
            option.value = student.studentId;
            option.textContent = `${student.studentId} - ${student.name} ${student.surname}`;
            
            // Durum g√∂stergesi ekle
            if (student.status !== 'Aktif') {
                option.textContent += ' (ƒ∞li≈üiƒüi Kesilmi≈ü)';
                option.style.color = '#6c757d';
            }
            
            filterSelect.appendChild(option);
        });
        
        // √ñnceki se√ßimi geri y√ºkle
        if (currentValue && filterSelect.querySelector(`option[value="${currentValue}"]`)) {
            filterSelect.value = currentValue;
        }
        
        console.log('‚úÖ Deƒüerlendirme √∂ƒürenci filtresi g√ºncellendi');
        
    } catch (error) {
        console.error('Deƒüerlendirme √∂ƒürenci filtresi g√ºncellenirken hata:', error);
    }
}

/**
 * DEPRECATED: Eski updateAssessmentView fonksiyonu - Artƒ±k kullanƒ±lmƒ±yor
 * Yeni kompleks versiyon (satƒ±r 6301) kullanƒ±lmalƒ±
 */
function updateAssessmentViewLegacy() {
    console.warn('‚ö†Ô∏è DEPRECATED: updateAssessmentViewLegacy √ßaƒürƒ±ldƒ±, yeni updateAssessmentView kullanƒ±n');
    // Yeni kompleks versiyonu √ßaƒüƒ±r
    if (typeof updateAssessmentView === 'function') {
        return updateAssessmentView();
    }
}

/**
 * √ñƒürenci d√ºzenleme modalƒ±nƒ± a√ß
 */
function editStudent(studentId) {
    console.log(`üîµ editStudent √ßaƒüƒ±rƒ±ldƒ±: ${studentId}`);
    
    const student = APP_STATE.studentData.find(s => s.studentId === studentId);
    if (!student) {
        showModernToast("√ñƒürenci bulunamadƒ±!", "error");
        return;
    }
    
    // HTML'deki mevcut modalƒ± kullan
    const modal = document.getElementById('editStudentModal');
    if (!modal) {
        showModernToast("Modal bulunamadƒ±!", "error");
        return;
    }
    
    // Form alanlarƒ±nƒ± doldur
    document.getElementById('editStudentId').value = student.studentId || '';
    document.getElementById('editStudentName').value = student.name || '';
    document.getElementById('editStudentSurname').value = student.surname || '';
    document.getElementById('editStudentEmail').value = student.email || '';
    document.getElementById('editStudentPhone').value = student.telefon || '';
    document.getElementById('editStudentTCKN').value = student.tcKimlik || '';
    document.getElementById('editStudentStatus').value = student.status || 'Aktif';
    
    // √ñƒürenci ID'sini modal'a data attribute olarak sakla
    modal.setAttribute('data-original-student-id', studentId);
    
    // Form submit event listener'ƒ±nƒ± ekle (yalnƒ±zca bir kez)
    const form = document.getElementById('editStudentForm');
    if (form && !form.hasAttribute('data-listener-added')) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            saveStudentChanges();
        });
        form.setAttribute('data-listener-added', 'true');
        console.log(`üîó Form event listener eklendi`);
    }
    
    // Modalƒ± g√∂ster
    modal.style.display = 'flex';
    modal.classList.add('active');
    
    // Input formatlamalarƒ± ayarla
    setupEditStudentInputs();
    
    console.log(`üìù √ñƒürenci d√ºzenleme modalƒ± a√ßƒ±ldƒ±: ${studentId}`);
}

/**
 * √ñƒürenci d√ºzenleme input'larƒ±nƒ± ayarla
 */
function setupEditStudentInputs() {
    // TCKN input'una sadece sayƒ± giri≈üi
    const tcknInput = document.getElementById('editStudentTCKN');
    if (tcknInput) {
        tcknInput.addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, '');
            if (this.value.length > 11) {
                this.value = this.value.slice(0, 11);
            }
        });
    }
    
    // Telefon input'una formatla
    const phoneInput = document.getElementById('editStudentPhone');
    if (phoneInput) {
        phoneInput.addEventListener('input', function() {
            // Sadece rakamlarƒ± al
            let value = this.value.replace(/\D/g, '');
            
            // 11 haneli limit
            if (value.length > 11) {
                value = value.slice(0, 11);
            }
            
            this.value = value;
        });
    }
    
    // E-posta validasyonu
    const emailInput = document.getElementById('editStudentEmail');
    if (emailInput) {
        emailInput.addEventListener('blur', function() {
            if (this.value && !isValidEmail(this.value)) {
                this.style.borderColor = '#dc3545';
                this.title = 'Ge√ßerli bir e-posta adresi girin';
            } else {
                this.style.borderColor = '';
                this.title = '';
            }
        });
    }
}

/**
 * √ñƒürenci d√ºzenleme modalƒ±nƒ± kapat
 */
function closeEditStudentModal() {
    const modal = document.getElementById('editStudentModal');
    if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('active');
        modal.removeAttribute('data-original-student-id');
        
        // Form'u temizle
        const form = document.getElementById('editStudentForm');
        if (form) {
            form.reset();
        }
        
        // Input stillerini temizle
        const inputs = modal.querySelectorAll('input, select');
        inputs.forEach(input => {
            input.style.borderColor = '';
            input.title = '';
        });
    }
}

/**
 * √ñƒürenci deƒüi≈üikliklerini kaydet
 */
function saveStudentChanges() {
    console.log(`üíæ saveStudentChanges √ßaƒüƒ±rƒ±ldƒ±`);
    
    try {
        const modal = document.getElementById('editStudentModal');
        const originalStudentId = modal.getAttribute('data-original-student-id');
        
        console.log(`üìã Orijinal √∂ƒürenci ID: ${originalStudentId}`);
        
        if (!originalStudentId) {
            showModernToast("√ñzg√ºn √∂ƒürenci ID bulunamadƒ±!", "error");
            return;
        }
        
        const newStudentId = document.getElementById('editStudentId').value.trim();
        const name = document.getElementById('editStudentName').value.trim();
        const surname = document.getElementById('editStudentSurname').value.trim();
        const email = document.getElementById('editStudentEmail').value.trim();
        const phone = document.getElementById('editStudentPhone').value.trim();
        const tckn = document.getElementById('editStudentTCKN').value.trim();
        const status = document.getElementById('editStudentStatus').value;
        
        // Validasyon
        if (!newStudentId || !name || !surname) {
            showModernToast("√ñƒürenci No, Ad ve Soyad alanlarƒ± zorunludur!", "error");
            return;
        }
        
        // E-posta validasyonu
        if (email && !isValidEmail(email)) {
            showModernToast("Ge√ßerli bir e-posta adresi girin!", "error");
            return;
        }
        
        // TCKN validasyonu
        if (tckn && (tckn.length !== 11 || !/^\d{11}$/.test(tckn))) {
            showModernToast("TCKN 11 haneli sayƒ± olmalƒ±dƒ±r!", "error");
            return;
        }
        
        // Telefon validasyonu
        if (phone) {
            const phoneNumbers = phone.replace(/\D/g, '');
            if (phoneNumbers.length < 10 || phoneNumbers.length > 11) {
                showModernToast("Telefon numarasƒ± 10-11 haneli olmalƒ±dƒ±r!", "error");
                return;
            }
        }
        
        // Aynƒ± ID ile ba≈üka √∂ƒürenci var mƒ± kontrol et (kendisi hari√ß)
        const existingStudent = APP_STATE.studentData.find(s => 
            s.studentId === newStudentId && s.studentId !== originalStudentId
        );
        if (existingStudent) {
            showModernToast("Bu √∂ƒürenci numarasƒ± zaten kullanƒ±lƒ±yor!", "error");
            return;
        }
        
        // √ñƒürenciyi g√ºncelle
        const studentIndex = APP_STATE.studentData.findIndex(s => s.studentId === originalStudentId);
        if (studentIndex === -1) {
            showModernToast("√ñƒürenci bulunamadƒ±!", "error");
            return;
        }
        
        // √ñƒürenci verisini g√ºncelle - T√ºrk√ße key'leri kullan
        APP_STATE.studentData[studentIndex] = {
            ...APP_STATE.studentData[studentIndex],
            studentId: newStudentId,
            name: name,
            surname: surname,
            email: email,
            telefon: phone, // T√ºrk√ße key
            tcKimlik: tckn, // T√ºrk√ße key
            status: status
        };
        
        // Eƒüer √∂ƒürenci ID deƒüi≈ütiyse notlarda ve grup bilgilerinde de g√ºncelle
        if (originalStudentId !== newStudentId) {
            // Notlarƒ± g√ºncelle
            if (APP_STATE.gradesData && APP_STATE.gradesData[originalStudentId]) {
                APP_STATE.gradesData[newStudentId] = APP_STATE.gradesData[originalStudentId];
                delete APP_STATE.gradesData[originalStudentId];
            }
            
            // Grup bilgilerini g√ºncelle
            if (APP_STATE.courseData?.ogrenciNotlari) {
                if (APP_STATE.courseData.ogrenciNotlari[originalStudentId]) {
                    APP_STATE.courseData.ogrenciNotlari[newStudentId] = APP_STATE.courseData.ogrenciNotlari[originalStudentId];
                    delete APP_STATE.courseData.ogrenciNotlari[originalStudentId];
                }
            }
        }
        
        // T√ºm GUI bile≈üenlerini g√ºncelle
        updateStudentTableEnhanced(); // Bu artƒ±k t√ºm dropdown'larƒ± g√ºncelliyor
        updateStudentGroupInfo();
        updateAssessmentStudentFilter();
        updateAssessmentView();
        
        // Modalƒ± kapat
        closeEditStudentModal();
        
        showModernToast("√ñƒürenci bilgileri ba≈üarƒ±yla g√ºncellendi!", "success");
        
        console.log(`‚úÖ √ñƒürenci g√ºncellendi: ${originalStudentId} ‚Üí ${newStudentId}`);
        
    } catch (error) {
        console.error("√ñƒürenci kaydetme hatasƒ±:", error);
        showModernToast("√ñƒürenci kaydedilemedi!", "error");
    }
}

/**
 * E-posta validasyonu
 */
function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

/**
 * Telefon numarasƒ±nƒ± formatla
 */
function formatPhoneNumber(phone) {
    if (!phone) return '';
    
    // Maskeleme durumunu kontrol et
    if (STUDENT_VIEW_SETTINGS.maskPhone) {
        const numbers = phone.replace(/\D/g, '');
        if (numbers.length === 11 && numbers.startsWith('0')) {
            return `${numbers.slice(0,1)}(${numbers.slice(1,4)}) *** ** **`;
        } else if (numbers.length === 10 && numbers.startsWith('5')) {
            return `(${numbers.slice(0,3)}) *** ** **`;
        }
        return '***********';
    }
    
    // Sadece rakamlarƒ± al
    const numbers = phone.replace(/\D/g, '');
    
    // T√ºrkiye telefon formatƒ±: 0(5XX) XXX XX XX
    if (numbers.length === 11 && numbers.startsWith('0')) {
        return `${numbers.slice(0,1)}(${numbers.slice(1,4)}) ${numbers.slice(4,7)} ${numbers.slice(7,9)} ${numbers.slice(9,11)}`;
    }
    // 10 haneli format: (5XX) XXX XX XX
    else if (numbers.length === 10 && numbers.startsWith('5')) {
        return `(${numbers.slice(0,3)}) ${numbers.slice(3,6)} ${numbers.slice(6,8)} ${numbers.slice(8,10)}`;
    }
    
    return phone; // Formatlanamƒ±yorsa orijinal halini d√∂nd√ºr
}

/**
 * TCKN'yi formatla
 */
function formatTCKN(tckn) {
    if (!tckn) return '';
    
    // Maskeleme durumunu kontrol et
    if (STUDENT_VIEW_SETTINGS.maskTCKN) {
        const numbers = tckn.replace(/\D/g, '');
        if (numbers.length === 11) {
            return `${numbers.slice(0,3)} ** *** **`;
        }
        return '***********';
    }
    
    // Sadece rakamlarƒ± al
    const numbers = tckn.replace(/\D/g, '');
    
    // 11 haneli TCKN formatƒ±: XXX XX XXX XX
    if (numbers.length === 11) {
        return `${numbers.slice(0,3)} ${numbers.slice(3,5)} ${numbers.slice(5,8)} ${numbers.slice(8,11)}`;
    }
    
    return tckn; // Formatlanamƒ±yorsa orijinal halini d√∂nd√ºr
}

/**
 * E-posta formatla
 */
function formatEmail(email) {
    if (!email) return '';
    
    // E-posta uzunluƒüuna g√∂re kƒ±saltma
    if (email.length > 25) {
        const [localPart, domain] = email.split('@');
        if (localPart.length > 15) {
            return `${localPart.slice(0, 12)}...@${domain}`;
        }
    }
    
    return email;
}

/**
 * √ñƒürenci sil
 */
async function deleteStudent(studentId) {
    const student = APP_STATE.studentData.find(s => s.studentId === studentId);
    if (!student) {
        showModernToast("√ñƒürenci bulunamadƒ±!", "error");
        return;
    }
    
    const confirmed = await showModernConfirm(
        "√ñƒürenci Sil",
        `"${student.name} ${student.surname}" (${student.studentId}) adlƒ± √∂ƒürenciyi silmek istediƒüinize emin misiniz?\n\nBu i≈ülem √∂ƒürencinin t√ºm notlarƒ±nƒ± da silecektir.`,
        {
            confirmText: 'Evet, Sil',
            cancelText: 'ƒ∞ptal',
            confirmClass: 'btn-danger',
            cancelClass: 'btn-secondary',
            headerClass: 'danger-action',
            iconClass: 'danger'
        }
    );
    
    if (confirmed) {
        try {
            // √ñƒürenciyi listeden √ßƒ±kar
            APP_STATE.studentData = APP_STATE.studentData.filter(s => s.studentId !== studentId);
            
            // Notlarƒ±nƒ± da sil
            if (APP_STATE.gradesData && APP_STATE.gradesData[studentId]) {
                delete APP_STATE.gradesData[studentId];
            }
            
            // Grup atamalarƒ±nƒ± da sil
            if (APP_STATE.courseData?.grupHaritalari) {
                Object.keys(APP_STATE.courseData.grupHaritalari).forEach(activityId => {
                    if (APP_STATE.courseData.grupHaritalari[activityId] && 
                        APP_STATE.courseData.grupHaritalari[activityId][studentId]) {
                        delete APP_STATE.courseData.grupHaritalari[activityId][studentId];
                    }
                });
            }
            
            // T√ºm GUI bile≈üenlerini g√ºncelle
            updateStudentTableEnhanced(); // Bu artƒ±k t√ºm dropdown'larƒ± g√ºncelliyor
            updateStudentGroupInfo();
            updateAssessmentStudentFilter();
            updateAssessmentView();
            
            showModernToast("√ñƒürenci ba≈üarƒ±yla silindi!", "success");
            
        } catch (error) {
            console.error("√ñƒürenci silme hatasƒ±:", error);
            showModernToast("√ñƒürenci silinemedi!", "error");
        }
    }
}



/**
 * √ñƒürencinin belirli bir bile≈üen i√ßin grubunu getir
 */
function getStudentGroupForComponent(studentId, componentId) {
    if (!APP_STATE.courseData?.grupHaritalari || !APP_STATE.courseData.grupHaritalari[componentId]) {
        return null;
    }
    
    return APP_STATE.courseData.grupHaritalari[componentId][studentId] || null;
}

/**
 * √ñƒürencinin t√ºm gruplarƒ±nƒ± getir
 */
function getStudentAllGroups(studentId) {
    const groups = {};
    
    if (!APP_STATE.courseData?.grupHaritalari) {
        return groups;
    }
    
    Object.keys(APP_STATE.courseData.grupHaritalari).forEach(activityId => {
        const groupMapping = APP_STATE.courseData.grupHaritalari[activityId];
        if (groupMapping && groupMapping[studentId]) {
            groups[activityId] = groupMapping[studentId];
        }
    });
    
    return groups;
}

/**
 * Belirli bir aktivite i√ßin gruplarƒ± getir
 */
function getGroupsForActivity(activityId) {
    // 1. √ñnce Exports.json formatƒ±ndan grup bilgilerini al
    const termActivities = APP_STATE.courseData?.dersDegerlendirme?.yariyilIciEtkinlikleri || [];
    const finalActivities = APP_STATE.courseData?.dersDegerlendirme?.yariyilSonuEtkinlikleri || [];
    const allActivities = [...termActivities, ...finalActivities];
    
    const activity = allActivities.find(act => act.id === activityId);
    if (activity?.grupBilgileri?.gruplar) {
        return activity.grupBilgileri.gruplar;
    }
    
    // 2. Fallback: grupHaritalari formatƒ±ndan
    if (APP_STATE.courseData?.grupHaritalari?.[activityId]?.gruplar) {
        return APP_STATE.courseData.grupHaritalari[activityId].gruplar;
    }
    
    // 3. Mevcut √∂ƒürenci atamalarƒ±ndan grup listesini √ßƒ±kar
    if (APP_STATE.courseData?.ogrenciNotlari && APP_STATE.studentData) {
        const usedGroups = new Set();
        
        APP_STATE.studentData.forEach(student => {
            const studentGroup = APP_STATE.courseData.ogrenciNotlari[student.studentId]?.grupBilgileri?.[activityId];
            if (studentGroup) {
                usedGroups.add(studentGroup);
            }
        });
        
        if (usedGroups.size > 0) {
            return Array.from(usedGroups).sort();
        }
    }
    
    // 4. Varsayƒ±lan gruplar
    return ['A', 'B'];
}

/**
 * Belirli bir aktivite ve grup i√ßin √∂ƒürencileri getir
 */
function getStudentsInGroup(activityId, groupId) {
    if (!APP_STATE.studentData || !Array.isArray(APP_STATE.studentData)) {
        return [];
    }
    
    return APP_STATE.studentData.filter(student => {
        // 1. √ñnce grupHaritalari sistemini kontrol et
        if (APP_STATE.courseData?.grupHaritalari?.[activityId]?.[student.studentId]) {
            return APP_STATE.courseData.grupHaritalari[activityId][student.studentId] === groupId;
        }
        
        // 2. ogrenciNotlari.grupBilgileri formatƒ±nƒ± kontrol et
        if (APP_STATE.courseData?.ogrenciNotlari?.[student.studentId]?.grupBilgileri?.[activityId]) {
            const studentGroup = APP_STATE.courseData.ogrenciNotlari[student.studentId].grupBilgileri[activityId];
            return studentGroup === groupId;
        }
        
        // 3. Varsayƒ±lan grup atamasƒ± KALDIRILDI - artƒ±k hi√ßbir varsayƒ±lan atama yok
        return false;
    });
}

/**
 * Hi√ßbir gruba atanmamƒ±≈ü √∂ƒürencileri getir
 */
function getUnassignedStudents() {
    if (!APP_STATE.studentData || !Array.isArray(APP_STATE.studentData)) {
        return [];
    }
    
    return APP_STATE.studentData.filter(student => {
        // 1. grupHaritalari sistemini kontrol et
        if (APP_STATE.courseData?.grupHaritalari) {
            const activities = Object.keys(APP_STATE.courseData.grupHaritalari);
            
            // En az bir aktivitede gruba atanmƒ±≈ü mƒ± kontrol et
            const hasGroupAssignment = activities.some(activityId => {
                return APP_STATE.courseData.grupHaritalari[activityId][student.studentId];
            });
            
            if (hasGroupAssignment) {
                return false; // Atanmƒ±≈ü
            }
        }
        
        // 2. ogrenciNotlari.grupBilgileri sistemini kontrol et
        if (APP_STATE.courseData?.ogrenciNotlari?.[student.studentId]?.grupBilgileri) {
            const grupBilgileri = APP_STATE.courseData.ogrenciNotlari[student.studentId].grupBilgileri;
            
            // En az bir aktivitede gruba atanmƒ±≈ü mƒ± kontrol et
            const hasGroupAssignment = Object.keys(grupBilgileri).some(activityId => {
                return grupBilgileri[activityId] && grupBilgileri[activityId] !== '';
            });
            
            if (hasGroupAssignment) {
                return false; // Atanmƒ±≈ü
            }
        }
        
        // 3. Hi√ßbir sistemde atama yoksa atanmamƒ±≈ü
        return true;
    });
}

/**
 * Drag & Drop i≈ülevselliƒüini ayarla
 */
function setupDragAndDrop() {
    try {
        // √ñnceki event listener'larƒ± temizle
        document.querySelectorAll('.student-item[draggable="true"]').forEach(item => {
            item.replaceWith(item.cloneNode(true));
        });
        
        const studentItems = document.querySelectorAll('.student-item[draggable="true"]');
        const dropZones = document.querySelectorAll('.group-drop-zone, .unassigned-list');
        
        console.log(`üéØ Drag&Drop kurulumu: ${studentItems.length} √∂ƒürenci, ${dropZones.length} drop zone`);
        
        if (studentItems.length === 0) {
            console.warn('‚ö†Ô∏è S√ºr√ºklenebilir √∂ƒürenci bulunamadƒ±!');
            return;
        }
        
        if (dropZones.length === 0) {
            console.warn('‚ö†Ô∏è Drop zone bulunamadƒ±!');
            return;
        }
        
        // Drag ba≈ülangƒ±cƒ±
        studentItems.forEach((item, index) => {
            console.log(`üìù Event listener ekleniyor: ${index + 1}/${studentItems.length} - ${item.dataset.studentId}`);
            
            // Draggable kontrol√º
            if (!item.getAttribute('draggable')) {
                item.setAttribute('draggable', 'true');
            }
            item.addEventListener('dragstart', function(e) {
                const studentId = this.dataset.studentId;
                const sourceActivity = this.closest('[data-activity-id]')?.dataset.activityId;
                
                // Veri transferi
                e.dataTransfer.setData('text/plain', studentId);
                e.dataTransfer.setData('source-activity', sourceActivity || '');
                
                // G√∂rsel geribildirim
                this.classList.add('dragging');
                
                // T√ºm activity b√∂l√ºmlerini aktivite kontrol√º i√ßin i≈üaretle
                document.querySelectorAll('.activity-group-section').forEach(section => {
                    const sectionActivity = section.dataset.activityId;
                    if (sectionActivity === sourceActivity || !sourceActivity) {
                        section.classList.add('valid-drop-target');
                    } else {
                        section.classList.add('invalid-drop-target');
                    }
                });
                
                console.log(`üöÄ Drag started: ${studentId} from activity: ${sourceActivity || 'unassigned'}`);
            });
            
            item.addEventListener('dragend', function(e) {
                // G√∂rsel geribildirimi temizle
                this.classList.remove('dragging');
                
                // T√ºm i≈üaretlemeleri temizle
                document.querySelectorAll('.activity-group-section').forEach(section => {
                    section.classList.remove('valid-drop-target', 'invalid-drop-target');
                });
                
                // Drop zone i≈üaretlemelerini temizle
                document.querySelectorAll('.group-drop-zone, .unassigned-list').forEach(zone => {
                    zone.classList.remove('drag-over', 'drag-invalid');
                });
                
                console.log('üèÅ Drag ended');
            });
        });
        
        // Drop zone'lar
        dropZones.forEach(zone => {
            zone.addEventListener('dragover', function(e) {
                e.preventDefault();
                
                const targetActivity = zone.dataset.activity;
                const sourceActivity = e.dataTransfer.getData('source-activity');
                
                // Aktivite kontrol√º
                const isValidDrop = !targetActivity || !sourceActivity || targetActivity === sourceActivity;
                
                if (isValidDrop) {
                    this.classList.add('drag-over');
                    this.classList.remove('drag-invalid');
                } else {
                    this.classList.add('drag-invalid');
                    this.classList.remove('drag-over');
                }
            });
            
            zone.addEventListener('dragleave', function(e) {
                // Sadece ger√ßekten zone'dan √ßƒ±kƒ±ldƒ±ƒüƒ±nda temizle
                if (!this.contains(e.relatedTarget)) {
                    this.classList.remove('drag-over', 'drag-invalid');
                }
            });
            
            zone.addEventListener('drop', function(e) {
                e.preventDefault();
                
                const studentId = e.dataTransfer.getData('text/plain');
                const sourceActivity = e.dataTransfer.getData('source-activity');
                const targetActivity = this.dataset.activity;
                const groupId = this.dataset.group;
                
                // Temizlik
                this.classList.remove('drag-over', 'drag-invalid');
                
                if (!studentId) {
                    console.error('‚ùå Student ID bulunamadƒ±');
                    return;
                }
                
                // Aktivite kontrol√º - √áapraz aktivite atamasƒ± engelle
                if (targetActivity && sourceActivity && targetActivity !== sourceActivity) {
                    const student = APP_STATE.studentData.find(s => s.studentId === studentId);
                    const sourceName = getActivityName(sourceActivity);
                    const targetName = getActivityName(targetActivity);
                    
                    showModernToast(
                        `‚ùå ${student?.name || studentId} √∂ƒürencisi ${sourceName} etkinliƒüinden ${targetName} etkinliƒüine ta≈üƒ±namaz! Her etkinlik kendi i√ßinde grup atamasƒ± yapƒ±lmalƒ±dƒ±r.`,
                        "error",
                        4000
                    );
                    
                    console.log(`‚ùå Cross-activity drop prevented: ${sourceActivity} ‚Üí ${targetActivity}`);
                    return;
                }
                
                if (targetActivity && groupId) {
                    // √ñƒürenciyi gruba ata
                    assignStudentToGroup(studentId, targetActivity, groupId);
                    console.log(`‚úÖ Assigned: ${studentId} ‚Üí ${targetActivity}:${groupId}`);
                } else {
                    // √ñƒürenciyi t√ºm gruplardan √ßƒ±kar (atanmamƒ±≈ü duruma getir)
                    removeStudentFromAllGroups(studentId);
                    console.log(`‚úÖ Unassigned: ${studentId}`);
                }
                
                // G√∂r√ºn√ºm√º g√ºncelle
                updateStudentGroupInfo();
                updateStudentTableEnhanced();
            });
        });
        
        console.log('‚úÖ Drag&Drop ayarlandƒ±');
        
    } catch (error) {
        console.error("‚ùå Drag&Drop ayarlanƒ±rken hata:", error);
    }
}

/**
 * Aktivite adƒ±nƒ± ID'den al
 */
function getActivityName(activityId) {
    if (!activityId) return 'Bilinmeyen';
    
    const activity = APP_STATE.courseData?.degerlendirmeAraclari?.find(tool => tool.id === activityId);
    return activity ? activity.adi : activityId;
}

/**
 * Debug: Drag&Drop durumunu konsola yazdƒ±r
 */
function debugDragDrop() {
    console.log('üîç DRAG&DROP DEBUG:');
    console.log(`üìä S√ºr√ºklenebilir √∂ƒürenci sayƒ±sƒ±: ${document.querySelectorAll('.student-item[draggable="true"]').length}`);
    console.log(`üìä Drop zone sayƒ±sƒ±: ${document.querySelectorAll('.group-drop-zone, .unassigned-list').length}`);
    
    const studentItems = document.querySelectorAll('.student-item[draggable="true"]');
    studentItems.forEach((item, index) => {
        const hasListeners = item.ondragstart !== null;
        console.log(`üë®‚Äçüéì ${index + 1}. ${item.textContent.trim()} - Event Listeners: ${hasListeners ? '‚úÖ' : '‚ùå'}`);
    });
    
    const dropZones = document.querySelectorAll('.group-drop-zone, .unassigned-list');
    dropZones.forEach((zone, index) => {
        console.log(`üì¶ ${index + 1}. Drop Zone - Activity: ${zone.dataset.activity || 'none'}, Group: ${zone.dataset.group || 'none'}`);
    });
}

/**
 * Drag&Drop'u manuel olarak test et
 */
function testDragDrop() {
    console.log('üß™ Manual Drag&Drop Test:');
    
    const firstStudent = document.querySelector('.student-item[draggable="true"]');
    if (!firstStudent) {
        console.error('‚ùå S√ºr√ºklenebilir √∂ƒürenci bulunamadƒ±!');
        return;
    }
    
    console.log(`üéØ Test √∂ƒürencisi: ${firstStudent.textContent.trim()}`);
    console.log(`üìã Student ID: ${firstStudent.dataset.studentId}`);
    console.log(`üîÑ Draggable: ${firstStudent.getAttribute('draggable')}`);
    
    // Cursor deƒüi≈ütirme testi
    firstStudent.style.border = '2px solid red';
    firstStudent.style.background = 'yellow';
    
    setTimeout(() => {
        firstStudent.style.border = '';
        firstStudent.style.background = '';
    }, 2000);
    
    console.log('‚úÖ Test tamamlandƒ±. √ñƒürenci 2 saniye kƒ±rmƒ±zƒ± kenarlƒ±k ile i≈üaretlendi.');
}

/**
 * √ñƒürenciyi belirli bir gruba ata
 */
function assignStudentToGroup(studentId, activityId, groupId) {
    try {
        // 1. grupHaritalari formatƒ±na yaz (drag&drop i√ßin)
        if (!APP_STATE.courseData) {
            APP_STATE.courseData = {};
        }
        
        if (!APP_STATE.courseData.grupHaritalari) {
            APP_STATE.courseData.grupHaritalari = {};
        }
        
        if (!APP_STATE.courseData.grupHaritalari[activityId]) {
            APP_STATE.courseData.grupHaritalari[activityId] = {};
        }
        
        APP_STATE.courseData.grupHaritalari[activityId][studentId] = groupId;
        
        // 2. ogrenciNotlari formatƒ±na da yaz (tablo i√ßin)
        if (!APP_STATE.courseData.ogrenciNotlari) {
            APP_STATE.courseData.ogrenciNotlari = {};
        }
        
        if (!APP_STATE.courseData.ogrenciNotlari[studentId]) {
            APP_STATE.courseData.ogrenciNotlari[studentId] = {};
        }
        
        if (!APP_STATE.courseData.ogrenciNotlari[studentId].grupBilgileri) {
            APP_STATE.courseData.ogrenciNotlari[studentId].grupBilgileri = {};
        }
        
        APP_STATE.courseData.ogrenciNotlari[studentId].grupBilgileri[activityId] = groupId;
        
        const student = APP_STATE.studentData.find(s => s.studentId === studentId);
        if (student) {
            console.log(`‚úÖ ${student.name} ${student.surname} ‚Üí ${activityId} aktivitesi ${groupId} grubuna atandƒ±`);
            showModernToast(`${student.name} ${student.surname} ${groupId} grubuna atandƒ±!`, "success", 2000);
        }
        
        // √ñƒürenci tablosunu g√ºncelle
        updateStudentTableEnhanced();
        
    } catch (error) {
        console.error("√ñƒürenci grup atamasƒ± hatasƒ±:", error);
        showModernToast("Grup atamasƒ± ba≈üarƒ±sƒ±z!", "error");
    }
}

/**
 * √ñƒürenciyi t√ºm gruplardan √ßƒ±kar
 */
function removeStudentFromAllGroups(studentId) {
    try {
        // 1. grupHaritalari formatƒ±ndan √ßƒ±kar
        if (APP_STATE.courseData?.grupHaritalari) {
            Object.keys(APP_STATE.courseData.grupHaritalari).forEach(activityId => {
                if (APP_STATE.courseData.grupHaritalari[activityId][studentId]) {
                    delete APP_STATE.courseData.grupHaritalari[activityId][studentId];
                }
            });
        }
        
        // 2. ogrenciNotlari formatƒ±ndan da √ßƒ±kar
        if (APP_STATE.courseData?.ogrenciNotlari?.[studentId]?.grupBilgileri) {
            Object.keys(APP_STATE.courseData.ogrenciNotlari[studentId].grupBilgileri).forEach(activityId => {
                delete APP_STATE.courseData.ogrenciNotlari[studentId].grupBilgileri[activityId];
            });
        }
        
        const student = APP_STATE.studentData.find(s => s.studentId === studentId);
        if (student) {
            console.log(`‚úÖ ${student.name} ${student.surname} t√ºm gruplardan √ßƒ±karƒ±ldƒ±`);
            showModernToast(`${student.name} ${student.surname} t√ºm gruplardan √ßƒ±karƒ±ldƒ±!`, "info", 2000);
        }
        
        // √ñƒürenci tablosunu g√ºncelle
        updateStudentTableEnhanced();
        
    } catch (error) {
        console.error("√ñƒürenci grup √ßƒ±karma hatasƒ±:", error);
        showModernToast("Grup √ßƒ±karma ba≈üarƒ±sƒ±z!", "error");
    }
}

/**
 * Rastgele √∂ƒürenci daƒüƒ±tƒ±mƒ± (belirli bir aktivite i√ßin)
 */
function randomizeStudentsForActivity(activityId) {
    try {
        if (!APP_STATE.studentData || APP_STATE.studentData.length === 0) {
            showModernToast("√ñƒürenci verisi bulunamadƒ±!", "error");
            return;
        }
        
        const groups = getGroupsForActivity(activityId);
        if (groups.length === 0) {
            showModernToast("Grup verisi bulunamadƒ±!", "error");
            return;
        }
        
        // √ñƒürencileri karƒ±≈ütƒ±r
        const shuffledStudents = [...APP_STATE.studentData].sort(() => Math.random() - 0.5);
        
        // Gruplara daƒüƒ±t
        shuffledStudents.forEach((student, index) => {
            const groupIndex = index % groups.length;
            const groupId = groups[groupIndex];
            assignStudentToGroup(student.studentId, activityId, groupId);
        });
        
        // G√∂r√ºn√ºm√º g√ºncelle
        updateStudentGroupInfo();
        updateStudentTableEnhanced();
        
        const activity = APP_STATE.courseData?.degerlendirmeAraclari?.find(tool => tool.id === activityId);
        const activityName = activity ? activity.adi : activityId;
        showModernToast(`${activityName} i√ßin √∂ƒürenciler rastgele daƒüƒ±tƒ±ldƒ±!`, "success");
        
    } catch (error) {
        console.error("Rastgele daƒüƒ±tƒ±m hatasƒ±:", error);
        showModernToast("Rastgele daƒüƒ±tƒ±m ba≈üarƒ±sƒ±z!", "error");
    }
}

/**
 * √ñƒürenci grup bilgilerini g√ºncelle ve drag&drop ile grup y√∂netimi
 */
function updateStudentGroupInfo() {
    try {
        console.log('üîÑ updateStudentGroupInfo ba≈üladƒ±');
        
        // Filtreleme sistemi ba≈ülatƒ±lmamƒ±≈üsa ba≈ülat
        if (!document.getElementById('groupSearchInput')?.hasAttribute('data-initialized')) {
            console.log('üîß Grup filtreleme sistemi ba≈ülatƒ±lƒ±yor...');
            setTimeout(() => {
                initializeGroupFiltering();
                document.getElementById('groupSearchInput')?.setAttribute('data-initialized', 'true');
            }, 100);
        }
        
        // Etkinlik filtresini g√ºncelle
        populateGroupActivityFilter();
        
        // Filtreli g√∂r√ºn√ºm√º g√ºncelle
        updateStudentGroupInfoWithFilters();
        
        // Filtre bilgisini g√ºncelle
        updateGroupFilterInfo();
        
        console.log('‚úÖ updateStudentGroupInfo tamamlandƒ± (filtreleme ile)');
        
    } catch (error) {
        console.error("‚ùå √ñƒürenci grup bilgileri g√ºncellenirken hata:", error);
        console.error(error);
    }
}

/**
 * Eski grup bilgilerini g√ºncelle (yedek)
 */
function updateStudentGroupInfoOld() {
    try {
        console.log('üîÑ updateStudentGroupInfoOld ba≈üladƒ±');
        const container = document.getElementById('studentGroupInfoContainer');
        const card = document.getElementById('studentGroupInfoCard');
        
        console.log('üìã Container:', container ? 'bulundu' : 'bulunamadƒ±');
        console.log('üìã Card:', card ? 'bulundu' : 'bulunamadƒ±');
        console.log('üìã Student data:', APP_STATE.studentData?.length || 0, '√∂ƒürenci');
        
        if (!container || !APP_STATE.studentData || APP_STATE.studentData.length === 0) {
            console.log('‚ùå updateStudentGroupInfoOld: Gerekli veriler eksik, card gizleniyor');
            if (card) card.style.display = 'none';
            return;
        }
        
        // Aktiviteleri al - Exports.json formatƒ±ndan
        const activities = {};
        
        // Yarƒ±yƒ±l i√ßi etkinlikleri
        if (APP_STATE.courseData?.dersDegerlendirme?.yariyilIciEtkinlikleri) {
            APP_STATE.courseData.dersDegerlendirme.yariyilIciEtkinlikleri.forEach(activity => {
                activities[activity.id] = {
                    id: activity.id,
                    adi: activity.etkinlik,
                    type: 'ARA_SINAV'
                };
            });
        }
        
        // Yarƒ±yƒ±l sonu etkinlikleri
        if (APP_STATE.courseData?.dersDegerlendirme?.yariyilSonuEtkinlikleri) {
            APP_STATE.courseData.dersDegerlendirme.yariyilSonuEtkinlikleri.forEach(activity => {
                activities[activity.id] = {
                    id: activity.id,
                    adi: activity.etkinlik,
                    type: 'FINAL'
                };
            });
        }
        
        // Fallback: Eski format (degerlendirmeAraclari)
        if (Object.keys(activities).length === 0 && APP_STATE.courseData?.degerlendirmeAraclari) {
            APP_STATE.courseData.degerlendirmeAraclari.forEach(tool => {
                activities[tool.id] = {
                    id: tool.id,
                    adi: tool.adi,
                    type: tool.tur
                };
            });
        }
        
        if (Object.keys(activities).length === 0) {
            console.log('‚ùå updateStudentGroupInfo: Aktivite bulunamadƒ±, card gizleniyor');
            container.innerHTML = '<p class="empty-message">Deƒüerlendirme aracƒ± bulunamadƒ±.</p>';
            if (card) card.style.display = 'none';
            return;
        }
        
        console.log('üìã Aktiviteler:', Object.keys(activities).length);
        
        // Her aktivite i√ßin grup alanlarƒ± olu≈ütur
        let html = '';
        Object.values(activities).forEach(activity => {
            const groups = getGroupsForActivity(activity.id);
            const typeLabel = activity.type === 'ARA_SINAV' ? 'Ara Sƒ±nav' : 'Final';
            
            // Alt bile≈üenleri bul
            const mainActivity = APP_STATE.assessmentTree?.find(node => node.id === activity.id);
            const subComponents = mainActivity?.children || [];
            
            html += `
                <div class="activity-group-section" data-activity-id="${activity.id}">
                    <div class="activity-group-title">
                        <span>${activity.id} - ${activity.adi} (${typeLabel})</span>
                        <button class="btn btn-sm btn-info" onclick="randomizeStudentsForActivity('${activity.id}')" title="Rastgele Daƒüƒ±t">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M16 3h5v5"></path>
                                <path d="M8 3H3v5"></path>
                                <path d="M12 22V8"></path>
                                <path d="M16 8l5-5"></path>
                                <path d="M8 8L3 3"></path>
                            </svg>
                            Rastgele
                        </button>
                    </div>
                    
                    ${subComponents.length > 0 ? `
                    <div class="sub-components-info">
                        <h5 class="sub-components-title">Alt Bile≈üenler:</h5>
                        <div class="sub-components-list">
                            ${subComponents.map(subComponent => `
                                <div class="sub-component-item">
                                    <span class="sub-component-id">${subComponent.id}</span>
                                    <span class="sub-component-name">${subComponent.name}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="group-container">
                        ${groups.map(groupId => {
                            const groupStudents = getStudentsInGroup(activity.id, groupId);
                            return `
                                <div class="group-section">
                                    <div class="group-label">${groupId} Grubu</div>
                                    <div class="group-drop-zone" data-group="${groupId}" data-activity="${activity.id}">
                                        <div class="group-students" id="group-${activity.id}-${groupId}">
                                            ${groupStudents.map(student => `
                                                <div class="student-item" draggable="true" data-student-id="${student.studentId}" data-student-name="${student.name} ${student.surname}">
                                                    <div class="student-name">${student.name} ${student.surname}</div>
                                                    <div class="student-details">
                                                        <span class="student-id">${student.studentId}</span>
                                                        ${student.email ? `<span class="student-email">${student.email}</span>` : ''}
                                                    </div>
                                                </div>
                                            `).join('')}
                                            ${groupStudents.length === 0 ? '<div class="empty-group-message">Gruba √∂ƒürenci atanmamƒ±≈ü</div>' : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        });
        
        // Atanmamƒ±≈ü √∂ƒürenciler b√∂l√ºm√º (sadece bir kez g√∂ster)
        const unassignedStudents = getUnassignedStudents();
        if (unassignedStudents.length > 0) {
            html += `
                <div class="unassigned-students">
                    <div class="unassigned-title">Atanmamƒ±≈ü √ñƒürenciler</div>
                    <div class="unassigned-list">
                        ${unassignedStudents.map(student => `
                            <div class="student-item" draggable="true" data-student-id="${student.studentId}" data-student-name="${student.name} ${student.surname}">
                                <div class="student-name">${student.name} ${student.surname}</div>
                                <div class="student-details">
                                    <span class="student-id">${student.studentId}</span>
                                    ${student.email ? `<span class="student-email">${student.email}</span>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        console.log('üìã HTML olu≈üturuldu, container g√ºncelleniyor');
        container.innerHTML = html;
        
        // Kartƒ± g√∂ster
        if (card) {
            card.style.display = 'block';
            console.log('‚úÖ Card g√∂sterildi');
        }
        
        // Drag&drop event listener'larƒ±nƒ± ekle (DOM g√ºncellemesinden sonra)
        setTimeout(() => {
            console.log('üîÑ Drag&drop yeniden ayarlanƒ±yor...');
            setupDragAndDrop();
            debugDragDrop(); // Debug bilgileri
            console.log('‚úÖ updateStudentGroupInfo tamamlandƒ±');
        }, 100);
        
    } catch (error) {
        console.error("‚ùå √ñƒürenci grup bilgileri g√ºncellenirken hata:", error);
        console.error(error);
    }
}

// Modal dƒ±≈üƒ±na tƒ±klanƒ±nca kapanmasƒ± i√ßin
document.addEventListener('click', function(event) {
    const modal = document.getElementById('editStudentModal');
    if (event.target === modal) {
        closeEditStudentModal();
    }
});

// ESC tu≈üuyla modal kapatma
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const modal = document.getElementById('editStudentModal');
        if (modal.classList.contains('active')) {
            closeEditStudentModal();
        }
    }
});

// =====================================================
// ETKƒ∞NLƒ∞K SE√áENEK MODAL Sƒ∞STEMƒ∞
// =====================================================

/**
 * Etkinlik eklendikten sonra se√ßenek modalƒ±nƒ± g√∂ster
 * @param {string} activityType - 'term' veya 'final'
 * @param {Object} activityNode - Eklenen etkinlik d√ºƒü√ºm√º
 */
function showActivityOptionsModal(activityType, activityNode) {
    const modal = document.getElementById('activityOptionsModal');
    const title = document.getElementById('activityOptionsTitle');
    const successText = document.getElementById('activitySuccessText');
    
    if (!modal || !title || !successText) {
        console.error('Etkinlik se√ßenek modal elementleri bulunamadƒ±!');
        return;
    }
    
    // Modal i√ßeriƒüini g√ºncelle
    const activityTypeText = activityType === 'term' ? 'Yarƒ±yƒ±l i√ßi' : 'Yarƒ±yƒ±l sonu';
    
    if (activityNode === null) {
        // Etkinlik hen√ºz eklenmedi - √∂nce se√ßim yapƒ±lacak
        title.textContent = `üéØ ${activityTypeText} Etkinlik Ekleme`;
        successText.textContent = `${activityTypeText} etkinlik eklemek istiyorsunuz. Bu etkinliƒüe nasƒ±l bir i√ßerik eklemek istersiniz?`;
    } else {
        // Etkinlik zaten eklendi - eski davranƒ±≈ü
    title.textContent = `üéØ ${activityTypeText} Etkinlik Ba≈üarƒ±yla Eklendi!`;
    successText.textContent = `${activityTypeText} etkinlik ba≈üarƒ±yla olu≈üturuldu. ≈ûimdi bu etkinliƒüe soru veya rubrik eklemek ister misiniz?`;
    }
    
    // √ñ√á se√ßim alanƒ±nƒ± doldur
    populateActivityOutcomesSelect();
    
    // Modal'ƒ± g√∂ster
    modal.classList.add('active');
    modal.style.display = 'flex';
    
    // Aktif etkinlik bilgisini sakla
    window.currentActivityNode = activityNode;
    window.currentActivityType = activityType;
    
    // √ñ√á'leri y√ºkle
    populateActivityOutcomesSelect();
    
    // ƒ∞lk se√ßeneƒüi varsayƒ±lan olarak se√ß
    const firstCard = modal.querySelector('.activity-option-card');
    if (firstCard) {
        selectActivityOption(firstCard);
    }
    
    // Puan alanlarƒ±nƒ±n durumunu kontrol et
    setTimeout(() => {
        updatePointsFieldVisibility();
    }, 100);
}

/**
 * Yeni etkinlik olu≈ütur
 * @param {string} activityType - Etkinlik t√ºr√º ('term' veya 'final')
 * @returns {Object} Olu≈üturulan etkinlik node'u
 */
function createNewActivity(activityType) {
    try {
        let newNode, newId;
        
        if (activityType === 'term') {
            // Mevcut yarƒ±yƒ±l i√ßi etkinlikleri say
            const termCount = APP_STATE.assessmentTree.filter(node => node.id.startsWith('A')).length;
            newId = `A${termCount + 1}`;
            newNode = {
                id: newId,
                name: 'Yarƒ±yƒ±l ƒ∞√ßi Etkinlik',
                type: ACTIVITY_TYPES.term[0],
                weight: 0,
                points: 100,
                outcomes: [],
                description: 'Yarƒ±yƒ±l i√ßi deƒüerlendirme',
                expanded: true,
                children: []
            };
            
            // Yarƒ±yƒ±l i√ßi etkinliklerini ba≈üa ekleyin
            // Var olan yarƒ±yƒ±l i√ßi etkinliklerini bul
            const termNodes = APP_STATE.assessmentTree.filter(node => node.id.startsWith('A'));
            
            // Diƒüer t√ºm etkinlikleri al
            const otherNodes = APP_STATE.assessmentTree.filter(node => !node.id.startsWith('A'));
            
            // Yeni d√ºƒü√ºm√º yarƒ±yƒ±l i√ßi etkinliklerine ekle
            termNodes.push(newNode);
            
            // Aƒüacƒ± g√ºncelle - √∂nce t√ºm yarƒ±yƒ±l i√ßi, sonra diƒüer etkinlikler
            APP_STATE.assessmentTree = [...termNodes, ...otherNodes];
            
        } else if (activityType === 'final') {
            // Mevcut yarƒ±yƒ±l sonu etkinlikleri say
            const finalCount = APP_STATE.assessmentTree.filter(node => node.id.startsWith('F')).length;
            newId = `F${finalCount + 1}`;
            newNode = {
                id: newId,
                name: 'Yarƒ±yƒ±l Sonu Etkinlik',
                type: ACTIVITY_TYPES.final[0],
                weight: 0,
                points: 100,
                outcomes: [],
                description: 'Yarƒ±yƒ±l sonu deƒüerlendirme',
                expanded: true,
                children: []
            };
            
            // Yarƒ±yƒ±l sonu etkinliklerini sona ekle
            APP_STATE.assessmentTree.push(newNode);
        }
        
        selectNode(newNode);
        
        renderTree();
        
        // Deƒüerlendirme sekmesini g√ºncelle - CRITICAL SYNC
        updateAssessmentView();
        
        // Yeni eklenen etkinlik i√ßin otomatik grup atamasƒ±
        assignDefaultGroupsToNewActivity(newNode);
        
        // √ñƒürenci grup bilgilerini g√ºncelle
        updateStudentGroupInfoDisplay();
        
        const activityTypeText = activityType === 'term' ? 'Yarƒ±yƒ±l i√ßi' : 'Yarƒ±yƒ±l sonu';
        showModernToast(`${activityTypeText} etkinlik eklendi.`);
        
        return newNode;
        
    } catch (error) {
        console.error("Etkinlik olu≈üturulurken hata olu≈ütu:", error);
        showModernToast("Etkinlik olu≈üturulamadƒ±!", "error");
        return null;
    }
}

/**
 * Etkinlik se√ßeneƒüi se√ßimi
 * @param {HTMLElement} cardElement - Se√ßilen kart elementi
 */
function selectActivityOption(cardElement) {
    const modal = document.getElementById('activityOptionsModal');
    if (!modal) return;
    
    // T√ºm kartlarƒ± deselect et
    modal.querySelectorAll('.activity-option-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Se√ßilen kartƒ± select et
    cardElement.classList.add('selected');
    
    // Apply butonunu aktif et
    const applyBtn = document.getElementById('applyActivityOptions');
    if (applyBtn) {
        applyBtn.disabled = false;
    }
}

/**
 * Etkinlik se√ßeneklerini uygula
 */
function applyActivityOptions() {
    const modal = document.getElementById('activityOptionsModal');
    const selectedCard = modal.querySelector('.activity-option-card.selected');
    
    if (!selectedCard) {
        showModernToast("Bir se√ßenek se√ßin!", "warning");
        return;
    }
    
    const option = selectedCard.dataset.option;
    
    try {
        // Eƒüer etkinlik hen√ºz eklenmemi≈üse, √∂nce etkinliƒüi olu≈ütur
        if (window.currentActivityNode === null) {
            const newNode = createNewActivity(window.currentActivityType);
            window.currentActivityNode = newNode;
        }
        
        switch (option) {
            case 'questions':
                applyQuestionOption();
                break;
            case 'rubrics':
                applyRubricOption();
                break;
            case 'empty':
                applyEmptyOption();
                break;
            default:
                showModernToast("Ge√ßersiz se√ßenek!", "error");
                return;
        }
        
        // Modal'ƒ± kapat
        closeActivityOptionsModal();
        
    } catch (error) {
        console.error('Etkinlik se√ßeneƒüi uygulanƒ±rken hata:', error);
        showModernToast("Se√ßenek uygulanamadƒ±!", "error");
    }
}

/**
 * Soru ekleme se√ßeneƒüini uygula
 */
function applyQuestionOption() {
    const questionCount = parseInt(document.getElementById('questionCount').value) || 3;
    const questionType = document.getElementById('questionTypeSelect').value;
    const defaultPoints = parseInt(document.getElementById('questionDefaultPoints').value) || 10;
    const weightDistribution = document.getElementById('questionWeightDistribution').value;
    const selectedOutcomes = getSelectedActivityOutcomes();
    
    const parentNode = window.currentActivityNode;
    if (!parentNode.children) {
        parentNode.children = [];
    }
    
    // Mevcut alt bile≈üenlerin toplam aƒüƒ±rlƒ±ƒüƒ±nƒ± hesapla
    const existingTotalWeight = parentNode.children.reduce((sum, child) => sum + (parseFloat(child.weight) || 0), 0);
    const availableWeight = Math.max(0, 100 - existingTotalWeight);
    
    // Aƒüƒ±rlƒ±k hesaplama - mevcut bile≈üenleri dikkate al
    let weights = [];
    if (weightDistribution === 'equal') {
        const equalWeight = Math.floor(availableWeight / questionCount);
        weights = Array(questionCount).fill(equalWeight);
        // Kalan aƒüƒ±rlƒ±ƒüƒ± son √∂ƒüeye ekle
        const remainder = availableWeight - (equalWeight * questionCount);
        if (remainder > 0 && weights.length > 0) weights[weights.length - 1] += remainder;
    } else if (weightDistribution === 'random') {
        weights = generateRandomWeights(questionCount, availableWeight);
    } else {
        // Manuel - e≈üit ba≈üla, kullanƒ±cƒ± sonra deƒüi≈ütirebilir
        const equalWeight = Math.floor(availableWeight / questionCount);
        weights = Array(questionCount).fill(equalWeight);
        const remainder = availableWeight - (equalWeight * questionCount);
        if (remainder > 0 && weights.length > 0) weights[weights.length - 1] += remainder;
    }
    
    // Puan hesaplama - aƒüƒ±rlƒ±ƒüa g√∂re otomatik daƒüƒ±tƒ±m (varsayƒ±lan puan kullanƒ±lmaz)
    const totalActivityPoints = 100; // Her etkinlik 100 puan
    let points = weights.map(weight => Math.round((weight / 100) * totalActivityPoints));
    
    // Puanlarƒ±n toplamƒ±nƒ±n tam 100 olmasƒ±nƒ± saƒüla
    const currentTotal = points.reduce((a, b) => a + b, 0);
    if (currentTotal !== totalActivityPoints) {
        const diff = totalActivityPoints - currentTotal;
        // Farkƒ± en b√ºy√ºk puana ekle/√ßƒ±kar
        const maxIndex = points.indexOf(Math.max(...points));
        points[maxIndex] += diff;
        points[maxIndex] = Math.max(1, points[maxIndex]);
    }
    
    // Soru a√ßƒ±klamasƒ±nƒ± belirle
    const questionDescriptions = {
        'Soru': 'Genel deƒüerlendirme sorusu',
        '√áoktan Se√ßmeli': 'Birden fazla ≈üƒ±k arasƒ±ndan doƒüru cevabƒ±n se√ßilmesi',
        'Doƒüru/Yanlƒ±≈ü': 'ƒ∞fadenin doƒüru veya yanlƒ±≈ü olduƒüunu belirtme',
        'Kƒ±sa Cevaplƒ±': 'Kƒ±sa ve √∂z cevap gerektiren soru',
        'Bo≈üluk Doldurma': 'Metindeki bo≈üluklarƒ±n doldurulmasƒ±',
        'E≈üle≈ütirme': 'Birbirine uygun olan kavramlarƒ±n e≈üle≈ütirilmesi',
        'A√ßƒ±k U√ßlu': 'Kapsamlƒ± ve detaylƒ± cevap gerektiren soru',
        'Problem √á√∂zme': 'Matematiksel veya mantƒ±ksal problem √ß√∂z√ºm√º',
        'Kod Yazma': 'Belirli bir programlama dilinde kod yazma',
        'Kod Analiz': 'Verilen kodu analiz etme ve hata bulma',
        'Vaka Analizi': 'Verilen durumu analiz etme ve deƒüerlendirme',
        'Tasarƒ±m': '√úr√ºn, sistem veya s√ºre√ß tasarƒ±mƒ± yapma',
        'G√∂rsel ƒ∞nceleme': 'Grafik, diyagram veya g√∂rsel analizi'
    };
    
    for (let i = 0; i < questionCount; i++) {
        const childCount = parentNode.children.length;
        const newId = `${parentNode.id}.${childCount + 1}`;
        
        const newNode = {
            id: newId,
            name: `${questionType} ${childCount + 1}`,
            type: questionType,
            weight: weights[i],
            points: points[i], // Aƒüƒ±rlƒ±ƒüa g√∂re hesaplanan puan
            outcomes: selectedOutcomes.length > 0 ? selectedOutcomes : (parentNode.outcomes.length > 0 ? [parentNode.outcomes[0]] : []),
            description: questionDescriptions[questionType] || `${questionType} sorusu`,
            expanded: false
        };
        
        parentNode.children.push(newNode);
        
        // Yeni bile≈üen i√ßin default mapping atamasƒ±
        assignDefaultMappingToNewComponent(parentNode.id, newNode);
    }
    
    // Etkinliƒüin toplam puanƒ±nƒ± kontrol et ve 100'e tamamla
    ensureActivityTotalPoints(parentNode);
    
    parentNode.expanded = true;
    renderTree();
    updateAssessmentView();
    
    // D√úZELTME: Yeni sorular eklendikten sonra grup haritalamalarƒ±nƒ± g√ºncelle
    updateGroupMappingsAfterNodeAdd(parentNode.id);
    
    // √ñƒürenci grup bilgilerini g√ºncelle
    updateStudentGroupInfoDisplay();
    
    const outcomeText = selectedOutcomes.length > 0 ? ` (${selectedOutcomes.join(', ')} √ñ√áleri ile)` : '';
    const totalWeight = weights.reduce((a,b) => a+b, 0);
    const totalPoints = points.reduce((a,b) => a+b, 0);
    showModernToast(`${questionCount} adet ${questionType} sorusu eklendi! (${totalWeight}% aƒüƒ±rlƒ±k, ${totalPoints} puan)${outcomeText}`, "success");
}

/**
 * Rubrik ekleme se√ßeneƒüini uygula
 */
function applyRubricOption() {
    const rubricCount = parseInt(document.getElementById('rubricCount').value) || 2;
    const rubricType = document.getElementById('rubricTypeSelect').value;
    const defaultPoints = parseInt(document.getElementById('rubricDefaultPoints').value) || 20;
    const weightDistribution = document.getElementById('rubricWeightDistribution').value;
    const selectedOutcomes = getSelectedActivityOutcomes();
    
    const parentNode = window.currentActivityNode;
    if (!parentNode.children) {
        parentNode.children = [];
    }
    
    // Mevcut alt bile≈üenlerin toplam aƒüƒ±rlƒ±ƒüƒ±nƒ± hesapla
    const existingTotalWeight = parentNode.children.reduce((sum, child) => sum + (parseFloat(child.weight) || 0), 0);
    const availableWeight = Math.max(0, 100 - existingTotalWeight);
    
    // Aƒüƒ±rlƒ±k hesaplama - mevcut bile≈üenleri dikkate al
    let weights = [];
    if (weightDistribution === 'equal') {
        const equalWeight = Math.floor(availableWeight / rubricCount);
        weights = Array(rubricCount).fill(equalWeight);
        // Kalan aƒüƒ±rlƒ±ƒüƒ± son √∂ƒüeye ekle
        const remainder = availableWeight - (equalWeight * rubricCount);
        if (remainder > 0 && weights.length > 0) weights[weights.length - 1] += remainder;
    } else if (weightDistribution === 'random') {
        weights = generateRandomWeights(rubricCount, availableWeight);
    } else {
        // Manuel - e≈üit ba≈üla, kullanƒ±cƒ± sonra deƒüi≈ütirebilir
        const equalWeight = Math.floor(availableWeight / rubricCount);
        weights = Array(rubricCount).fill(equalWeight);
        const remainder = availableWeight - (equalWeight * rubricCount);
        if (remainder > 0 && weights.length > 0) weights[weights.length - 1] += remainder;
    }
    
    // Puan hesaplama - aƒüƒ±rlƒ±ƒüa g√∂re otomatik daƒüƒ±tƒ±m (varsayƒ±lan puan kullanƒ±lmaz)
    const totalActivityPoints = 100; // Her etkinlik 100 puan
    let points = weights.map(weight => Math.round((weight / 100) * totalActivityPoints));
    
    // Puanlarƒ±n toplamƒ±nƒ±n tam 100 olmasƒ±nƒ± saƒüla
    const currentTotal = points.reduce((a, b) => a + b, 0);
    if (currentTotal !== totalActivityPoints) {
        const diff = totalActivityPoints - currentTotal;
        // Farkƒ± en b√ºy√ºk puana ekle/√ßƒ±kar
        const maxIndex = points.indexOf(Math.max(...points));
        points[maxIndex] += diff;
        points[maxIndex] = Math.max(1, points[maxIndex]);
    }
    
    // Rubrik a√ßƒ±klamasƒ±nƒ± belirle
    const rubricDescriptions = {
        'Rubrik': 'Genel deƒüerlendirme rubriƒüi',
        'Proje Planlama': 'Proje planlama ve s√ºre√ß y√∂netimi deƒüerlendirmesi',
        'Proje Raporu': 'Proje raporu yazƒ±mƒ± ve i√ßerik kalitesi',
        'Proje Sunumu': 'Proje sunumu ve anlatƒ±m kalitesi',
        'Kod Yapƒ±sƒ±': 'Kod organizasyonu ve mimari yapƒ±',
        'Kod Kalitesi': 'Kod kalitesi, okunabilirlik ve bakƒ±m yapƒ±labilirlik',
        'Performans': 'Kodun performans ve kaynak kullanƒ±mƒ±',
        'Dok√ºmantasyon': 'Kod dok√ºmantasyonu ve yorum kalitesi',
        'Teorik Bilgi': 'Teorik bilgi ve kavramlarƒ± anlama',
        'Problem √á√∂zme': 'Problem analizi ve √ß√∂z√ºm yakla≈üƒ±mƒ±',
        'Uygulama': 'Teorik bilginin uygulamaya aktarƒ±lmasƒ±',
        'ƒ∞√ßerik': 'Sunum i√ßeriƒüi ve bilgi doƒüruluƒüu',
        'G√∂rsel Tasarƒ±m': 'Sunum g√∂rsel tasarƒ±mƒ± ve materyal kalitesi',
        'Sunum Becerisi': 'Anlatƒ±m becerisi ve ileti≈üim',
        'Zaman Y√∂netimi': 'Sunum zamanƒ±nƒ±n etkin kullanƒ±mƒ±',
        'Deney Hazƒ±rlƒ±ƒüƒ±': 'Deney √∂ncesi hazƒ±rlƒ±k ve planlama',
        'Deney Uygulamasƒ±': 'Deney prosed√ºrlerinin uygulanmasƒ±',
        'Veri Analizi': 'Verilerin analizi ve deƒüerlendirilmesi',
        'Laboratuvar Raporu': 'Laboratuvar raporu yazƒ±mƒ± ve kalitesi'
    };
    
    for (let i = 0; i < rubricCount; i++) {
        const childCount = parentNode.children.length;
        const newId = `${parentNode.id}.${childCount + 1}`;
        
        const newNode = {
            id: newId,
            name: `${rubricType} ${childCount + 1}`,
            type: rubricType,
            weight: weights[i],
            points: points[i], // Aƒüƒ±rlƒ±ƒüa g√∂re hesaplanan puan
            outcomes: selectedOutcomes.length > 0 ? selectedOutcomes : (parentNode.outcomes.length > 0 ? [parentNode.outcomes[0]] : []),
            description: rubricDescriptions[rubricType] || `${rubricType} rubriƒüi`,
            expanded: false
        };
        
        parentNode.children.push(newNode);
        
        // Yeni bile≈üen i√ßin default mapping atamasƒ±
        assignDefaultMappingToNewComponent(parentNode.id, newNode);
    }
    
    // Etkinliƒüin toplam puanƒ±nƒ± kontrol et ve 100'e tamamla
    ensureActivityTotalPoints(parentNode);
    
    parentNode.expanded = true;
    renderTree();
    updateAssessmentView();
    
    // D√úZELTME: Yeni rubrikler eklendikten sonra grup haritalamalarƒ±nƒ± g√ºncelle
    updateGroupMappingsAfterNodeAdd(parentNode.id);
    
    // √ñƒürenci grup bilgilerini g√ºncelle
    updateStudentGroupInfoDisplay();
    
    const outcomeText = selectedOutcomes.length > 0 ? ` (${selectedOutcomes.join(', ')} √ñ√áleri ile)` : '';
    const totalWeight = weights.reduce((a,b) => a+b, 0);
    const totalPoints = points.reduce((a,b) => a+b, 0);
    showModernToast(`${rubricCount} adet ${rubricType} rubriƒüi eklendi! (${totalWeight}% aƒüƒ±rlƒ±k, ${totalPoints} puan)${outcomeText}`, "success");
}

/**
 * Bo≈ü bƒ±rakma se√ßeneƒüini uygula
 */
function applyEmptyOption() {
    // Eƒüer etkinlik hen√ºz eklenmemi≈üse, √∂nce etkinliƒüi olu≈ütur
    if (window.currentActivityNode === null) {
        const newNode = createNewActivity(window.currentActivityType);
        window.currentActivityNode = newNode;
        
        if (!newNode) {
            showModernToast("Etkinlik olu≈üturulamadƒ±!", "error");
            return;
        }
    }
    
    showModernToast("Etkinlik bo≈ü bƒ±rakƒ±ldƒ±. Daha sonra manuel olarak soru/rubrik ekleyebilirsiniz.", "info");
}

/**
 * Rastgele aƒüƒ±rlƒ±k daƒüƒ±lƒ±mƒ± olu≈ütur
 * @param {number} count - √ñƒüe sayƒ±sƒ±
 * @param {number} totalWeight - Toplam aƒüƒ±rlƒ±k (varsayƒ±lan: 100)
 * @returns {Array} - Aƒüƒ±rlƒ±k dizisi (toplamƒ± totalWeight)
 */
function generateRandomWeights(count, totalWeight = 100) {
    if (count === 1) return [totalWeight];
    
    // Rastgele sayƒ±lar √ºret
    let weights = [];
    for (let i = 0; i < count - 1; i++) {
        weights.push(Math.random());
    }
    
    // Sƒ±rala
    weights.sort((a, b) => a - b);
    
    // Aralƒ±klara √ßevir
    let intervals = [];
    intervals.push(weights[0]);
    for (let i = 1; i < weights.length; i++) {
        intervals.push(weights[i] - weights[i-1]);
    }
    intervals.push(1 - weights[weights.length - 1]);
    
    // totalWeight'e √ßevir ve yuvarla
    let result = intervals.map(w => Math.max(1, Math.round(w * totalWeight)));
    
    // Toplamƒ± totalWeight yap
    let total = result.reduce((a, b) => a + b, 0);
    if (total !== totalWeight) {
        let diff = totalWeight - total;
        // Farkƒ± en b√ºy√ºk deƒüere ekle/√ßƒ±kar
        let maxIndex = result.indexOf(Math.max(...result));
        result[maxIndex] += diff;
        result[maxIndex] = Math.max(1, result[maxIndex]);
    }
    
    return result;
}

/**
 * Etkinliƒüin toplam puanƒ±nƒ±n 100 olmasƒ±nƒ± saƒüla
 * @param {Object} parentNode - Etkinlik d√ºƒü√ºm√º
 */
function ensureActivityTotalPoints(parentNode) {
    if (!parentNode || !parentNode.children || parentNode.children.length === 0) return;
    
    const totalPoints = parentNode.children.reduce((sum, child) => sum + (parseFloat(child.points) || 0), 0);
    const targetPoints = 100;
    
    if (totalPoints !== targetPoints && totalPoints > 0) {
        const diff = targetPoints - totalPoints;
        
        // Farkƒ± en b√ºy√ºk puana sahip √∂ƒüeye ekle/√ßƒ±kar
        let maxPointsIndex = 0;
        let maxPoints = parseFloat(parentNode.children[0].points) || 0;
        
        for (let i = 1; i < parentNode.children.length; i++) {
            const currentPoints = parseFloat(parentNode.children[i].points) || 0;
            if (currentPoints > maxPoints) {
                maxPoints = currentPoints;
                maxPointsIndex = i;
            }
        }
        
        // Puanƒ± g√ºncelle
        parentNode.children[maxPointsIndex].points = Math.max(1, maxPoints + diff);
        
        console.log(`üéØ Etkinlik ${parentNode.id} puan toplamƒ± ${totalPoints} -> ${targetPoints} olarak ayarlandƒ±`);
    }
}

/**
 * Etkinlik se√ßenek modalƒ±nƒ± kapat
 */
function closeActivityOptionsModal() {
    const modal = document.getElementById('activityOptionsModal');
    if (modal) {
        modal.classList.remove('active');
        modal.style.display = 'none';
        
        // Temizle
        window.currentActivityNode = null;
        window.currentActivityType = null;
        
        // NOT: √ñ√á se√ßimlerini temizleme - kullanƒ±cƒ± manuel olarak temizlemeli
        // clearAllActivityOutcomes(); // Kaldƒ±rƒ±ldƒ±: gereksiz otomatik temizlik
        
        console.log('üìã Modal kapatƒ±ldƒ± - √ñ√á se√ßimleri korundu (otomatik temizlik devre dƒ±≈üƒ±)');
        
        // Se√ßili kartlarƒ± temizle
        modal.querySelectorAll('.activity-option-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        // Apply butonunu deaktif et
        const applyBtn = document.getElementById('applyActivityOptions');
        if (applyBtn) {
            applyBtn.disabled = true;
        }
    }
}

/**
 * Count selector butonlarƒ± i√ßin event handler
 */
function updateCountValue(target, delta) {
    const input = document.getElementById(target);
    if (!input) return;
    
    const currentValue = parseInt(input.value) || 0;
    const newValue = Math.max(1, Math.min(50, currentValue + delta));
    input.value = newValue;
}

// Global fonksiyonlar
window.showActivityOptionsModal = showActivityOptionsModal;
window.selectActivityOption = selectActivityOption;
window.applyActivityOptions = applyActivityOptions;
window.closeActivityOptionsModal = closeActivityOptionsModal;
window.updateCountValue = updateCountValue;

// =====================================================
// ID Y√ñNETƒ∞Mƒ∞ Sƒ∞STEMƒ∞
// =====================================================

/**
 * Sƒ±ralƒ± ID √ºretimi
 * @param {Object} parentNode - √úst d√ºƒü√ºm
 * @returns {string} - Sƒ±ralƒ± ID
 */
function generateSequentialId(parentNode) {
    if (!parentNode || !parentNode.children) {
        return parentNode ? `${parentNode.id}.1` : '1';
    }
    
    // Mevcut ID'leri al ve sƒ±rayla d√ºzenle
    const childIds = parentNode.children.map(child => {
        const parts = child.id.split('.');
        return parseInt(parts[parts.length - 1]) || 0;
    });
    
    // En b√ºy√ºk ID'yi bul ve 1 ekle
    const maxId = childIds.length > 0 ? Math.max(...childIds) : 0;
    return `${parentNode.id}.${maxId + 1}`;
}

/**
 * T√ºm ID'leri yeniden d√ºzenle
 * @param {Object} parentNode - √úst d√ºƒü√ºm
 */
function reorderAllIds(parentNode) {
    if (!parentNode || !parentNode.children) return;
    
    const idMigrationMap = {}; // ID deƒüi≈üikliklerini takip et
    
    parentNode.children.forEach((child, index) => {
        const oldId = child.id;
        const newId = `${parentNode.id}.${index + 1}`;
        
        if (oldId !== newId) {
            // ID deƒüi≈üikliƒüini kaydet
            idMigrationMap[oldId] = newId;
            
            // Grup haritalamalarƒ±nƒ± g√ºncelle
            updateGroupMappingForId(oldId, newId);
            
            // ID'yi g√ºncelle
            child.id = newId;
            
            // Alt d√ºƒü√ºmleri de g√ºncelle
            if (child.children && child.children.length > 0) {
                reorderAllIds(child);
            }
        }
    });
    
    // Basit not migrasyonu (GUID olmadan)
    if (Object.keys(idMigrationMap).length > 0) {
        migrateGradesData(idMigrationMap);
    }
}

/**
 * Basit not migrasyonu (GUID olmadan)
 */
function migrateGradesData(idMigrationMap) {
    if (!APP_STATE.gradesData || Object.keys(idMigrationMap).length === 0) return;
    
    console.log('üîÑ Basit not migrasyon ba≈ülatƒ±lƒ±yor...', idMigrationMap);
    
    Object.keys(APP_STATE.gradesData).forEach(studentId => {
        const studentGrades = APP_STATE.gradesData[studentId];
        if (!studentGrades || typeof studentGrades !== 'object') return;
        
        // Her ID deƒüi≈üikliƒüi i√ßin
        Object.entries(idMigrationMap).forEach(([oldId, newId]) => {
            if (studentGrades.hasOwnProperty(oldId)) {
                const gradeValue = studentGrades[oldId];
                
                // Yeni ID ile sakla
                studentGrades[newId] = gradeValue;
                
                // Eski ID'yi sil
                delete studentGrades[oldId];
                
                console.log(`‚úÖ Not Migrasyon: ${studentId} - ${oldId} -> ${newId}`);
            }
        });
    });
    
    console.log('‚úÖ Basit not migrasyon tamamlandƒ±!');
}

/**
 * Grup haritalamalarƒ±nda ID referanslarƒ±nƒ± g√ºncelle
 * @param {string} oldId - Eski ID
 * @param {string} newId - Yeni ID
 */
function updateGroupMappingForId(oldId, newId) {
    if (!APP_STATE.courseData || !APP_STATE.courseData.grupHaritalari) return;
    
    Object.keys(APP_STATE.courseData.grupHaritalari).forEach(groupName => {
        const activities = APP_STATE.courseData.grupHaritalari[groupName];
        
        Object.keys(activities).forEach(activityId => {
            const questionList = activities[activityId];
            
            // Eski ID'yi yeni ID ile deƒüi≈ütir
            const index = questionList.indexOf(oldId);
            if (index !== -1) {
                questionList[index] = newId;
            }
        });
    });
}

/**
 * √ñƒüeyi yukarƒ± ta≈üƒ±
 * @param {Object} node - Ta≈üƒ±nacak d√ºƒü√ºm
 */
function moveItemUp(node) {
    const parent = findParentNode(node.id);
    if (!parent || !parent.children) return;
    
    const index = parent.children.findIndex(child => child.id === node.id);
    if (index <= 0) return; // Zaten en √ºstte
    
    // √ñƒüeleri yer deƒüi≈ütir
    [parent.children[index - 1], parent.children[index]] = 
    [parent.children[index], parent.children[index - 1]];
    
    // ID'leri yeniden d√ºzenle
    reorderAllIds(parent);
    
    // G√∂r√ºn√ºm√º g√ºncelle
    renderTree();
    updateAssessmentView();
    
    showModernToast(`"${node.name}" yukarƒ± ta≈üƒ±ndƒ±.`, "success");
}

/**
 * √ñƒüeyi a≈üaƒüƒ± ta≈üƒ±
 * @param {Object} node - Ta≈üƒ±nacak d√ºƒü√ºm
 */
function moveItemDown(node) {
    const parent = findParentNode(node.id);
    if (!parent || !parent.children) return;
    
    const index = parent.children.findIndex(child => child.id === node.id);
    if (index >= parent.children.length - 1) return; // Zaten en altta
    
    // √ñƒüeleri yer deƒüi≈ütir
    [parent.children[index], parent.children[index + 1]] = 
    [parent.children[index + 1], parent.children[index]];
    
    // ID'leri yeniden d√ºzenle
    reorderAllIds(parent);
    
    // G√∂r√ºn√ºm√º g√ºncelle
    renderTree();
    updateAssessmentView();
    
    showModernToast(`"${node.name}" a≈üaƒüƒ± ta≈üƒ±ndƒ±.`, "success");
}

/**
 * √úst d√ºƒü√ºm√º bulma
 * @param {string} nodeId - D√ºƒü√ºm ID'si
 * @returns {Object|null} - √úst d√ºƒü√ºm
 */
function findParentNode(nodeId) {
    const searchInTree = (nodes, targetId) => {
        for (const node of nodes) {
            if (node.children) {
                for (const child of node.children) {
                    if (child.id === targetId) {
                        return node;
                    }
                }
                const found = searchInTree(node.children, targetId);
                if (found) return found;
            }
        }
        return null;
    };
    
    return searchInTree(APP_STATE.assessmentTree, nodeId);
}

// =====================================================
// YARDIMCI FONKSIYONLAR
// =====================================================

/**
 * ID'ye g√∂re d√ºƒü√ºm bulma
 * @param {string} id - Aranacak d√ºƒü√ºm ID'si
 * @returns {Object|null} - Bulunan d√ºƒü√ºm veya null
 */
function findNodeById(id) {
    // Yardƒ±mcƒ± i√ß fonksiyon
    const searchNode = (node) => {
        if (node.id === id) return node;
        
        if (node.children && node.children.length > 0) {
            for (const child of node.children) {
                const found = searchNode(child);
                if (found) return found;
            }
        }
        
        return null;
    };
    
    // T√ºm aƒüa√ßta ara
    for (const rootNode of APP_STATE.assessmentTree) {
        const found = searchNode(rootNode);
        if (found) return found;
    }
    
    return null;
}

/**
 * Harf notu hesaplama - RTEU Y√∂netmeliƒüi MADDE 30'a g√∂re
 * @param {number} totalGrade - Toplam not
 * @returns {string} - Harf notu
 */
function getLetterGrade(totalGrade) {
    if (totalGrade >= 90) return 'AA';      // 90-100: M√ºkemmel (4.0)
    if (totalGrade >= 81) return 'BA';      // 81-89: √áok ƒ∞yi (3.5)
    if (totalGrade >= 73) return 'BB';      // 73-80: ƒ∞yi (3.0)
    if (totalGrade >= 66) return 'CB';      // 66-72: Orta (2.5)
    if (totalGrade >= 60) return 'CC';      // 60-65: Yeterli (2.0)
    if (totalGrade >= 50) return 'DC';      // 50-59: ≈ûartlƒ± Ba≈üarƒ±lƒ± (1.5)
    if (totalGrade >= 40) return 'DD';      // 40-49: Ba≈üarƒ±sƒ±z (1.0)
    if (totalGrade >= 30) return 'FD';      // 30-39: Ba≈üarƒ±sƒ±z (0.5)
    return 'FF';                            // 0-29: Ba≈üarƒ±sƒ±z (0.0)
}

/**
 * Harf notunun katsayƒ±sƒ±nƒ± getir - RTEU Y√∂netmeliƒüi MADDE 30'a g√∂re
 * @param {string} letterGrade - Harf notu
 * @returns {number} - Katsayƒ± deƒüeri
 */
function getLetterGradeCoefficient(letterGrade) {
    const coefficients = {
        'AA': 4.0,  // M√ºkemmel
        'BA': 3.5,  // √áok ƒ∞yi
        'BB': 3.0,  // ƒ∞yi
        'CB': 2.5,  // Orta
        'CC': 2.0,  // Yeterli
        'DC': 1.5,  // ≈ûartlƒ± Ba≈üarƒ±lƒ±
        'DD': 1.0,  // Ba≈üarƒ±sƒ±z
        'FD': 0.5,  // Ba≈üarƒ±sƒ±z
        'FF': 0.0,  // Ba≈üarƒ±sƒ±z
        'D': 0.0    // Devamsƒ±z
    };
    return coefficients[letterGrade] || 0.0;
}

/**
 * Ba≈üarƒ± durumunu kontrol et - RTEU Y√∂netmeliƒüi MADDE 30'a g√∂re
 * @param {string} letterGrade - Harf notu
 * @param {number} yano - Yarƒ±yƒ±l Akademik Not Ortalamasƒ± (isteƒüe baƒülƒ±)
 * @returns {object} - Ba≈üarƒ± durumu bilgileri
 */
function getGradeSuccessStatus(letterGrade, yano = null) {
    const directSuccess = ['AA', 'BA', 'BB', 'CB', 'CC'];
    const directFail = ['DD', 'FD', 'FF', 'D'];
    
    if (directSuccess.includes(letterGrade)) {
        return {
            isSuccessful: true,
            status: 'Ba≈üarƒ±lƒ±',
            description: 'Doƒürudan ba≈üarƒ±lƒ±'
        };
    }
    
    if (letterGrade === 'DC') {
        if (yano !== null) {
            if (yano >= 2.00) {
                return {
                    isSuccessful: true,
                    status: 'Ba≈üarƒ±lƒ±',
                    description: '≈ûartlƒ± ba≈üarƒ±lƒ± (YANO ‚â• 2.00)'
                };
            } else {
                return {
                    isSuccessful: false,
                    status: 'Ba≈üarƒ±sƒ±z',
                    description: '≈ûartlƒ± ba≈üarƒ±sƒ±z (YANO < 2.00)'
                };
            }
        } else {
            return {
                isSuccessful: null,
                status: '≈ûartlƒ±',
                description: 'YANO\'ya baƒülƒ± ba≈üarƒ± durumu'
            };
        }
    }
    
    if (directFail.includes(letterGrade)) {
        return {
            isSuccessful: false,
            status: 'Ba≈üarƒ±sƒ±z',
            description: 'Doƒürudan ba≈üarƒ±sƒ±z'
        };
    }
    
    return {
        isSuccessful: false,
        status: 'Bilinmeyen',
        description: 'Ge√ßersiz harf notu'
    };
}

/**
 * Rastgele √∂ƒürenme √ßƒ±ktƒ±larƒ± alma
 * @param {number} count - ƒ∞stenilen √ßƒ±ktƒ± sayƒ±sƒ±
 * @returns {Array} - Rastgele √∂ƒürenme √ßƒ±ktƒ±larƒ± ID'leri
 */
function getRandomOutcomes(count) {
    if (!APP_STATE.learningOutcomes || APP_STATE.learningOutcomes.length === 0) {
        return [];
    }
    
    // √ñƒürenme √ßƒ±ktƒ±larƒ±ndan rastgele se√ß
    const outcomes = [];
    const availableOutcomes = [...APP_STATE.learningOutcomes];
    
    for (let i = 0; i < Math.min(count, availableOutcomes.length); i++) {
        const randomIndex = Math.floor(Math.random() * availableOutcomes.length);
        outcomes.push(availableOutcomes[randomIndex].id);
        availableOutcomes.splice(randomIndex, 1);
    }
    
    return outcomes;
}

/**
 * Akƒ±llƒ± √∂ƒürenme √ßƒ±ktƒ±larƒ± se√ßme - JSON y√ºklendiƒüinde kullanƒ±lƒ±r
 * @param {number} count - Se√ßilecek √∂ƒürenme √ßƒ±ktƒ±sƒ± sayƒ±sƒ±
 * @returns {Array} - Se√ßilen √∂ƒürenme √ßƒ±ktƒ±larƒ±
 */
function getSmartOutcomes(count) {
    if (!APP_STATE.learningOutcomes || APP_STATE.learningOutcomes.length === 0) {
        return [];
    }
    
    // √ñƒürenme √ßƒ±ktƒ±larƒ±ndan akƒ±llƒ±ca se√ß
    const outcomes = [];
    const availableOutcomes = [...APP_STATE.learningOutcomes];
    
    for (let i = 0; i < Math.min(count, availableOutcomes.length); i++) {
        const randomIndex = Math.floor(Math.random() * availableOutcomes.length);
        outcomes.push(availableOutcomes[randomIndex].id);
        availableOutcomes.splice(randomIndex, 1);
    }
    
    return outcomes;
}

/**
 * Alt d√ºƒü√ºmlerin √∂ƒürenme √ßƒ±ktƒ±larƒ±nƒ± toplama
 * @param {Array} children - Alt d√ºƒü√ºmler
 * @param {Set} outcomeSet - √ñƒürenme √ßƒ±ktƒ±larƒ± set'i
 */
function collectChildOutcomes(children, outcomeSet) {
    children.forEach(child => {
        if (child.outcomes && child.outcomes.length) {
            child.outcomes.forEach(outcome => outcomeSet.add(outcome));
        }
        
        if (child.children && child.children.length > 0) {
            collectChildOutcomes(child.children, outcomeSet);
        }
    });
}

/**
 * Se√ßili sekmeyi deƒüi≈ütirme
 * @param {string} tabId - Sekme ID'si
 */
// ƒ∞lk switchTab fonksiyonu silindi - √ßakƒ±≈ümayƒ± √∂nlemek i√ßin (daha kapsamlƒ± versiyon var)

// ƒ∞lk modal fonksiyonlarƒ± silindi - √ßakƒ±≈ümayƒ± √∂nlemek i√ßin (daha kapsamlƒ± versiyonlar var)

// =====================================================
// AƒûA√á VE DEƒûERLENDƒ∞RME FONKSƒ∞YONLARI
// =====================================================

/**
 * D√ºƒü√ºm se√ßme
 * @param {Object} node - Se√ßilecek d√ºƒü√ºm
 */
function selectNode(node) {
    APP_STATE.selectedNode = node;
    renderTree();
}

/**
 * Yarƒ±yƒ±l i√ßi etkinlik ekleme
 */
function addTermActivity() {
    try {
        // √ñnce modal g√∂ster - etkinlik hen√ºz eklenmedi
        showActivityOptionsModal('term', null);
        
        // Otomatik kayƒ±t trigger
        if (autoSaveManager) {
            autoSaveManager.hasUnsavedChanges = true;
            autoSaveManager.updateFloatingButton('unsaved');
        }
		
    } catch (error) {
        console.error("Yarƒ±yƒ±l i√ßi etkinlik modalƒ± a√ßƒ±lƒ±rken hata olu≈ütu:", error);
        showModernToast("Modal a√ßƒ±lamadƒ±!", "error");
    }
}

/**
 * Yarƒ±yƒ±l sonu etkinlik ekleme
 */
function addFinalActivity() {
    try {
        // √ñnce modal g√∂ster - etkinlik hen√ºz eklenmedi
        showActivityOptionsModal('final', null);
        
        // Otomatik kayƒ±t trigger
        if (autoSaveManager) {
            autoSaveManager.hasUnsavedChanges = true;
            autoSaveManager.updateFloatingButton('unsaved');
        }
		
    } catch (error) {
        console.error("Yarƒ±yƒ±l sonu etkinlik modalƒ± a√ßƒ±lƒ±rken hata olu≈ütu:", error);
        showModernToast("Modal a√ßƒ±lamadƒ±!", "error");
    }
}

/**
 * D√ºƒü√ºme soru ekleme
 * @param {Object} parentNode - √úst d√ºƒü√ºm
 * @param {string} questionType - Soru tipi
 * @param {string} description - A√ßƒ±klama
 */
// ƒ∞lk addQuestionToNode fonksiyonu silindi - √ßakƒ±≈ümayƒ± √∂nlemek i√ßin

/**
 * D√ºƒü√ºme test ekleme (toplu √ßoktan se√ßmeli sorular)
 * @param {Object} parentNode - √úst d√ºƒü√ºm
 */
function addTestToNode(parentNode) {
    if (!parentNode) return;
    
    try {
        if (!parentNode.children) {
            parentNode.children = [];
        }
        
        const childCount = parentNode.children.length;
        const newId = `${parentNode.id}.${childCount + 1}`;
        
        // √ñƒürenme √ßƒ±ktƒ±larƒ± varsa ilk √∂ƒürenme √ßƒ±ktƒ±sƒ±nƒ± atayalƒ±m
        const outcome = parentNode.outcomes.length > 0 ? [parentNode.outcomes[0]] : [];
        
        const newNode = {
            id: newId,
            name: "Test Sorularƒ±",
            type: "Test",
            weight: 20, // Varsayƒ±lan aƒüƒ±rlƒ±k
            points: 100, // Varsayƒ±lan toplam puan
            outcomes: outcome,
            description: "√áoktan se√ßmeli test sorularƒ±",
            expanded: true,
            children: [],
            testDetails: {
                totalQuestions: 20,
                correctWeight: 5,
                wrongPenalty: 0
            }
        };
        
        parentNode.children.push(newNode);
        parentNode.expanded = true;
        selectNode(newNode);
        renderTree();
        
        // Deƒüerlendirme sekmesini g√ºncelle
        updateAssessmentView();
        
        // Test detaylarƒ± i√ßin modal g√∂ster
        APP_STATE.testDetailsNode = newNode;
        showTestDetailsModal();
        
        showModernToast("Test sorularƒ± eklendi.");
    } catch (error) {
        console.error("Test eklenirken hata olu≈ütu:", error);
        showModernToast("Test eklenemedi!", "error");
    }
}

// ƒ∞lk test modal fonksiyonlarƒ± silindi - √ßakƒ±≈ümayƒ± √∂nlemek i√ßin

/**
 * D√ºƒü√ºme rubrik ekleme
 * @param {Object} parentNode - √úst d√ºƒü√ºm
 * @param {string} rubricType - Rubrik tipi
 * @param {string} description - A√ßƒ±klama
 */
// ƒ∞lk addRubricToNode fonksiyonu silindi - √ßakƒ±≈ümayƒ± √∂nlemek i√ßin

/**
 * Soru ekleme fonksiyonu
 * Bir etkinliƒüe soru eklemek i√ßin kullanƒ±lƒ±r
 */
function addQuestion() {
    if (!APP_STATE.selectedNode) {
        showModernToast("L√ºtfen √∂nce bir etkinlik se√ßin.", "warning");
        return;
    }
    
    // Se√ßili d√ºƒü√ºm k√∂k deƒüilse alt d√ºƒü√ºm eklenmemeli
    if (APP_STATE.selectedNode.id.includes('.')) {
        showModernToast("Sorular sadece ana etkinliklere eklenebilir.", "warning");
        return;
    }
    
    // √áoklu soru eklemek i√ßin modal g√∂ster
    // Bu satƒ±rƒ± yorum haline getirip doƒürudan ekleme de yapabilirsiniz
    showMultipleItemsModal('soru');
    
    /* 
    // Tek soru eklemek i√ßin bu kƒ±smƒ± kullanabilirsiniz
    addQuestionToNode(APP_STATE.selectedNode);
    */
}

/**
 * Rubrik ekleme fonksiyonu
 * Bir etkinliƒüe rubrik eklemek i√ßin kullanƒ±lƒ±r
 */
function addRubric() {
    if (!APP_STATE.selectedNode) {
        showModernToast("L√ºtfen √∂nce bir etkinlik se√ßin.", "warning");
        return;
    }
    
    // Se√ßili d√ºƒü√ºm k√∂k deƒüilse alt d√ºƒü√ºm eklenmemeli
    if (APP_STATE.selectedNode.id.includes('.')) {
        showModernToast("Rubrikler sadece ana etkinliklere eklenebilir.", "warning");
        return;
    }
    
    // √áoklu rubrik eklemek i√ßin modal g√∂ster
    showMultipleItemsModal('rubrik');
    
    /* 
    // Tek rubrik eklemek i√ßin bu kƒ±smƒ± kullanabilirsiniz
    addRubricToNode(APP_STATE.selectedNode);
    */
}

/**
 * D√ºƒü√ºm silme
 */
function removeNode() {
    console.log("üî¥ [DEBUG] removeNode() fonksiyonu √ßaƒürƒ±ldƒ±");
    
    if (!APP_STATE.selectedNode) {
        console.log("üî¥ [DEBUG] Se√ßili d√ºƒü√ºm bulunamadƒ±");
        showModernToast("L√ºtfen √∂nce bir etkinlik se√ßin.", "warning");
        return;
    }
    
    console.log("üî¥ [DEBUG] Se√ßili d√ºƒü√ºm:", APP_STATE.selectedNode);
    console.log("üî¥ [DEBUG] Silme onay modalƒ± a√ßƒ±lƒ±yor...");
    
    showDeleteConfirmModal(
        function() {
            console.log("üî¥ [DEBUG] Silme onayƒ± verildi! Silme i≈ülemi ba≈ülƒ±yor...");
            
            try {
                const nodeId = APP_STATE.selectedNode.id;
                const nodeName = APP_STATE.selectedNode.name;
                console.log("üî¥ [DEBUG] Silinecek d√ºƒü√ºm ID:", nodeId);
                console.log("üî¥ [DEBUG] Silinecek d√ºƒü√ºm adƒ±:", nodeName);
                
                // K√∂k d√ºƒü√ºm m√º kontrol et
                const isRoot = !nodeId.includes('.');
                console.log("üî¥ [DEBUG] K√∂k d√ºƒü√ºm m√º?", isRoot);
                
                let deletionSuccessful = false;
                let parentNode = null;
                
                if (isRoot) {
                    console.log("üî¥ [DEBUG] K√∂k d√ºƒü√ºm silme i≈ülemi ba≈ülƒ±yor...");
                    // K√∂k d√ºƒü√ºm√º sil
                    const index = APP_STATE.assessmentTree.findIndex(node => node.id === nodeId);
                    console.log("üî¥ [DEBUG] K√∂k d√ºƒü√ºm indeksi:", index);
                    
                    if (index !== -1) {
                        APP_STATE.assessmentTree.splice(index, 1);
                        deletionSuccessful = true;
                        console.log("üî¥ [DEBUG] K√∂k d√ºƒü√ºm ba≈üarƒ±yla silindi");
                    } else {
                        console.log("üî¥ [DEBUG] HATA: K√∂k d√ºƒü√ºm bulunamadƒ±!");
                    }
                } else {
                    console.log("üî¥ [DEBUG] Alt d√ºƒü√ºm silme i≈ülemi ba≈ülƒ±yor...");
                    // Alt d√ºƒü√ºm√º sil
                    const parentId = nodeId.substring(0, nodeId.lastIndexOf('.'));
                    console.log("üî¥ [DEBUG] Parent ID:", parentId);
                    
                    const findParentAndRemoveChild = (nodes, id) => {
                        for (let i = 0; i < nodes.length; i++) {
                            const node = nodes[i];
                            if (node.id === parentId && node.children) {
                                const childIndex = node.children.findIndex(child => child.id === id);
                                if (childIndex !== -1) {
                                    console.log("üî¥ [DEBUG] Alt d√ºƒü√ºm bulundu, siliniyor. Child index:", childIndex);
                                    node.children.splice(childIndex, 1);
                                    return true;
                                }
                            }
                            
                            if (node.children && node.children.length > 0) {
                                if (findParentAndRemoveChild(node.children, id)) {
                                    return true;
                                }
                            }
                        }
                        return false;
                    };
                    
                    const deleted = findParentAndRemoveChild(APP_STATE.assessmentTree, nodeId);
                    console.log("üî¥ [DEBUG] Alt d√ºƒü√ºm silme sonucu:", deleted);
                    
                    // D√úZELTME: Alt d√ºƒü√ºm silindikten sonra ID yeniden d√ºzenleme yap
                    if (deleted) {
                        deletionSuccessful = true;
                        parentNode = findNodeById(parentId);
                        console.log("üî¥ [DEBUG] Parent d√ºƒü√ºm bulundu:", parentNode);
                        
                        if (parentNode) {
                            console.log("üî¥ [DEBUG] ID yeniden sƒ±ralama ba≈ülƒ±yor...");
                            // ID'leri yeniden sƒ±rala
                            reorderChildNodeIds(parentNode);
                            console.log("üî¥ [DEBUG] ID yeniden sƒ±ralama tamamlandƒ±");
                        }
                        
                        console.log("üî¥ [DEBUG] Grup haritalamalarƒ±nƒ± temizleme ba≈ülƒ±yor...");
                        // Grup haritalamalarƒ±nƒ± temizle
                        cleanupGroupMappingsForDeletedNode(nodeId);
                        console.log("üî¥ [DEBUG] Grup haritalamalarƒ±nƒ± temizleme tamamlandƒ±");
                    } else {
                        console.log("üî¥ [DEBUG] HATA: Alt d√ºƒü√ºm silinemedi!");
                    }
                }
                
                if (deletionSuccessful) {
                    console.log("üî¥ [DEBUG] Silme ba≈üarƒ±lƒ±! Post-processing ba≈ülƒ±yor...");
                    
                    // T√ºm ID'leri yeniden d√ºzenle (k√∂k d√ºƒü√ºm silindiƒüinde)
                    if (isRoot) {
                        console.log("üî¥ [DEBUG] T√ºm ID'leri yeniden d√ºzenleme ba≈ülƒ±yor...");
                        reorganizeAllIds();
                        console.log("üî¥ [DEBUG] T√ºm ID'leri yeniden d√ºzenleme tamamlandƒ±");
                    }
                    
                    APP_STATE.selectedNode = null;
                    console.log("üî¥ [DEBUG] Se√ßili d√ºƒü√ºm temizlendi");
                    
                    console.log("üî¥ [DEBUG] Aƒüacƒ± yeniden render etme ba≈ülƒ±yor...");
                    renderTree();
                    console.log("üî¥ [DEBUG] Aƒüacƒ± yeniden render etme tamamlandƒ±");
                    
                    console.log("üî¥ [DEBUG] Kategori aƒüƒ±rlƒ±klarƒ±nƒ± g√ºncelleme ba≈ülƒ±yor...");
                    // Kategori aƒüƒ±rlƒ±klarƒ±nƒ± g√ºncelle
                    updateCategoryWeights();
                    console.log("üî¥ [DEBUG] Kategori aƒüƒ±rlƒ±klarƒ±nƒ± g√ºncelleme tamamlandƒ±");
                    
                    console.log("üî¥ [DEBUG] Deƒüerlendirme sekmesini g√ºncelleme ba≈ülƒ±yor...");
                    // Deƒüerlendirme sekmesini g√ºncelle
                    updateAssessmentView();
                    console.log("üî¥ [DEBUG] Deƒüerlendirme sekmesini g√ºncelleme tamamlandƒ±");
                    
                    console.log("üî¥ [DEBUG] √ñƒürenci grup bilgilerini g√ºncelleme ba≈ülƒ±yor...");
                    // √ñƒürenci grup bilgilerini g√ºncelle
                    updateStudentGroupInfoDisplay();
                    console.log("üî¥ [DEBUG] √ñƒürenci grup bilgilerini g√ºncelleme tamamlandƒ±");
                    
                    // Alt d√ºƒü√ºm silindiyse ve parent'ƒ± varsa puanƒ±nƒ± ayarlama modalƒ±nƒ± a√ß
                    if (!isRoot && parentNode) {
                        console.log("üî¥ [DEBUG] Alt d√ºƒü√ºm silindi, puanƒ±nƒ± ayarlama modalƒ± kontrol ediliyor...");
                        console.log("üî¥ [DEBUG] Parent d√ºƒü√ºm children sayƒ±sƒ±:", parentNode.children ? parentNode.children.length : 0);
                        
                        // Puanƒ±nƒ± ayarlama modalƒ±nƒ± otomatik a√ß
                        setTimeout(() => {
                            console.log("üî¥ [DEBUG] Puanƒ±nƒ± ayarlama modalƒ± a√ßƒ±lƒ±yor...");
                            // checkAndOfferRedistribution fonksiyonu varsa √ßaƒüƒ±r
                            if (typeof checkAndOfferRedistribution === 'function') {
                                checkAndOfferRedistribution(parentNode);
                            } else {
                                console.log("üî¥ [DEBUG] checkAndOfferRedistribution fonksiyonu bulunamadƒ±");
                            }
                        }, 500);
                    }
                    
                    console.log("üî¥ [DEBUG] Ba≈üarƒ± mesajƒ± g√∂steriliyor...");
                    showModernToast(`"${nodeName}" etkinliƒüi ba≈üarƒ±yla silindi.`);
                    console.log("üî¥ [DEBUG] removeNode i≈ülemi ba≈üarƒ±yla tamamlandƒ±");
                    
                    // Otomatik kayƒ±t trigger
                    if (autoSaveManager) {
                        autoSaveManager.hasUnsavedChanges = true;
                        autoSaveManager.updateFloatingButton('unsaved');
                    }
                } else {
                    console.log("üî¥ [DEBUG] HATA: Silme i≈ülemi ba≈üarƒ±sƒ±z!");
                    showModernToast("Etkinlik silinemedi!", "error");
                }
                
            } catch (error) {
                console.error("üî¥ [DEBUG] D√ºƒü√ºm silinirken hata olu≈ütu:", error);
                console.error("üî¥ [DEBUG] Hata stack trace:", error.stack);
                showModernToast("Etkinlik silinemedi!", "error");
            }
        },
        `"${APP_STATE.selectedNode.name}" etkinliƒüini ve t√ºm alt √∂ƒüelerini silmek istediƒüinizden emin misiniz?`
    );
    
    console.log("üî¥ [DEBUG] showDeleteConfirmModal √ßaƒürƒ±sƒ± tamamlandƒ±");
}

/**
 * T√ºm d√ºƒü√ºmleri geni≈ület
 */
function expandAll() {
    const expandNodes = (nodes) => {
        nodes.forEach(node => {
            node.expanded = true;
            if (node.children && node.children.length > 0) {
                expandNodes(node.children);
            }
        });
    };
    
    expandNodes(APP_STATE.assessmentTree);
    renderTree();
    showModernToast("T√ºm etkinlikler geni≈ületildi.");
}

/**
 * T√ºm d√ºƒü√ºmleri daralt
 */
function collapseAll() {
    const collapseNodes = (nodes) => {
        nodes.forEach(node => {
            node.expanded = false;
            if (node.children && node.children.length > 0) {
                collapseNodes(node.children);
            }
        });
    };
    
    collapseNodes(APP_STATE.assessmentTree);
    renderTree();
    showModernToast("T√ºm etkinlikler daraltƒ±ldƒ±.");
}

/**
 * √úst d√ºƒü√ºm√ºn √ñ√á'lerini alt d√ºƒü√ºmlerden toplama
 * @param {string} parentId - √úst d√ºƒü√ºm ID'si
 */
function updateParentOutcomes(parentId) {
    try {
        const parentNode = findNodeById(parentId);
        if (!parentNode || !parentNode.children || parentNode.children.length === 0) {
            return;
        }
        
        // Alt d√ºƒü√ºmlerden unique √ñ√á'leri topla
        const childOutcomes = new Set();
        collectChildOutcomes(parentNode.children, childOutcomes);
        
        // √úst d√ºƒü√ºm√ºn √ñ√á'lerini g√ºncelle
        if (childOutcomes.size > 0) {
            parentNode.outcomes = Array.from(childOutcomes);
            
            // DOM'da √ºst d√ºƒü√ºm√ºn √ñ√á input'unu g√ºncelle
            const parentOutcomesInput = document.querySelector(`.tree-node[data-id="${parentId}"] .nodeOutcomes`);
            if (parentOutcomesInput) {
                parentOutcomesInput.value = Array.isArray(parentNode.outcomes) ? parentNode.outcomes.join(',') : '';
            }
            
            // Log'a bilgi ekle
            addLogEntry('info', `"${parentNode.name}" etkinliƒüinin √ñ√á'leri alt bile≈üenlerden otomatik g√ºncellendi: ${parentNode.outcomes.join(', ')}`);
        }
    } catch (error) {
        console.error("√úst d√ºƒü√ºm √ñ√á'leri g√ºncellenirken hata olu≈ütu:", error);
        addLogEntry('error', `√úst d√ºƒü√ºm √ñ√á'leri g√ºncellenirken hata: ${error.message}`);
    }
}

/**
 * √ñƒürenme √ßƒ±ktƒ±larƒ±nƒ± g√ºncelleme
 * @param {Object} node - G√ºncellenecek d√ºƒü√ºm
 * @param {HTMLInputElement} outcomesInput - √áƒ±ktƒ±lar input elementi
 */
function updateOutcomes(node, outcomesInput) {
    try {
        const inputValue = outcomesInput.value.trim();
        
        // Alt d√ºƒü√ºm ise (soru veya rubrik), sadece bir √ñ√á atanabilsin
        const isSubItem = node.id.includes('.');
        
        if (isSubItem) {
            const outcomes = inputValue.split(',').map(s => s.trim()).filter(s => s);
            
            if (outcomes.length > 1) {
                showModernToast("Soru veya Rubrik sadece bir √ñƒürenme √áƒ±ktƒ±sƒ±na atanabilir!", "warning");
                // ƒ∞lk √∂ƒürenme √ßƒ±ktƒ±sƒ±nƒ± al
                node.outcomes = outcomes.slice(0, 1);
                outcomesInput.value = Array.isArray(node.outcomes) ? node.outcomes.join(',') : '';
            } else {
                node.outcomes = outcomes;
            }
            
            // ALT D√úƒû√úM √ñ√á'Sƒ∞ DEƒûƒ∞≈ûTƒ∞ƒûƒ∞NDE √úST D√úƒû√úM√ú G√úNCELLE
            const parentId = node.id.substring(0, node.id.lastIndexOf('.'));
            if (parentId) {
                setTimeout(() => {
                    updateParentOutcomes(parentId);
                }, 50);
            }
        } else {
            // Ana etkinlik i√ßin birden √ßok √ñ√á atanabilir
            node.outcomes = inputValue.split(',').map(s => s.trim()).filter(s => s);
        }
        
        // outcomes'ƒ±n her zaman array olduƒüundan emin ol
        if (!Array.isArray(node.outcomes)) {
            node.outcomes = [];
        }
        
        // Alt d√ºƒü√ºmlerin √∂ƒürenme √ßƒ±ktƒ±larƒ±nƒ± ana d√ºƒü√ºme kopyala (manuel g√ºncelleme durumunda)
        if (!isSubItem && node.children && node.children.length > 0) {
            const childOutcomes = new Set();
            collectChildOutcomes(node.children, childOutcomes);
            
            // Eƒüer childOutcomes bo≈ü deƒüilse, ana d√ºƒü√ºm√ºn outcomes'ƒ±nƒ± g√ºncelle
            if (childOutcomes.size > 0) {
                node.outcomes = Array.from(childOutcomes);
                outcomesInput.value = Array.isArray(node.outcomes) ? node.outcomes.join(',') : '';
            }
        }
        
        // √ñ√á deƒüi≈üikliƒüi olduƒüunda deƒüerlendirme sekmesini g√ºncelle
        setTimeout(() => {
            updateAssessmentView();
        }, 100);
    } catch (error) {
        console.error("√ñƒürenme √ßƒ±ktƒ±larƒ± g√ºncellenirken hata olu≈ütu:", error);
        showModernToast("√ñƒürenme √ßƒ±ktƒ±larƒ± g√ºncellenemedi!", "error");
        addLogEntry('error', `√ñ√á g√ºncelleme hatasƒ±: ${error.message}`);
        
        // Hata durumunda g√ºvenli deƒüer ata
        node.outcomes = [];
        outcomesInput.value = '';
    }
}

/**
 * Kategori aƒüƒ±rlƒ±klarƒ±nƒ± g√ºncelleme
 */
/**
 * Kategori aƒüƒ±rlƒ±klarƒ±nƒ± g√ºncelleme
 */
function updateCategoryWeights() {
    try {
        // Yarƒ±yƒ±l i√ßi ve yarƒ±yƒ±l sonu etkinlikleri ayƒ±r
        const termActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('A'));
        const finalActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('F'));
        
        // Her kategori i√ßinde toplam aƒüƒ±rlƒ±klarƒ± hesapla
        const termInternalTotal = termActivities.reduce((sum, node) => sum + parseFloat(node.weight || 0), 0);
        const finalInternalTotal = finalActivities.reduce((sum, node) => sum + parseFloat(node.weight || 0), 0);
        
        // Sabit tanƒ±mlƒ± genel deƒüerlendirme aƒüƒ±rlƒ±klarƒ± - JSON'dan geliyor, deƒüi≈ümez
        const termContribution = APP_STATE.courseData?.dersDegerlendirme?.genelDegerlendirme?.find(
            item => item.degerlendirme.includes("ƒ∞√ßi"))?.katkiYuzdesi || 40;
        const finalContribution = APP_STATE.courseData?.dersDegerlendirme?.genelDegerlendirme?.find(
            item => item.degerlendirme.includes("Sonu"))?.katkiYuzdesi || 60;
        
        // Genel aƒüƒ±rlƒ±klarƒ± kaydet
        APP_STATE.termWeight = termContribution;  
        APP_STATE.finalWeight = finalContribution;
        
        // Bu deƒüerler deƒüi≈ümez - sabit kalmalƒ±
        document.getElementById('termGeneralWeight').textContent = termContribution;
        document.getElementById('finalGeneralWeight').textContent = finalContribution;
        
        // ƒ∞√ß aƒüƒ±rlƒ±k toplamlarƒ± g√ºncellenir
        document.getElementById('termInternalTotal').textContent = termInternalTotal;
        document.getElementById('finalInternalTotal').textContent = finalInternalTotal;
        
        // ƒ∞√ß toplamlar 100% deƒüilse uyarƒ± rengiyle g√∂ster
        if (termInternalTotal !== 100) {
            document.getElementById('termInternalTotal').style.color = 'var(--danger-color)';
        } else {
            document.getElementById('termInternalTotal').style.color = '';
        }
        
        if (finalInternalTotal !== 100) {
            document.getElementById('finalInternalTotal').style.color = 'var(--danger-color)';
        } else {
            document.getElementById('finalInternalTotal').style.color = '';
        }
        
        // Progress barlarƒ± sadece g√∂sterim ama√ßlƒ±
        termProgress.style.width = `${termInternalTotal}%`;
        finalProgress.style.width = `${finalInternalTotal}%`;
        
        // Detaylƒ± bilgilendirme etiketlerini g√ºncelle
        updateCategoryDetails(termActivities, 'termDetails');
        updateCategoryDetails(finalActivities, 'finalDetails');
        
        // Course Data'yƒ± g√ºncelle
        if (APP_STATE.courseData && APP_STATE.courseData.dersDegerlendirme) {
            // Yarƒ±yƒ±l i√ßi etkinliklerini g√ºncelle
            APP_STATE.courseData.dersDegerlendirme.yariyilIciEtkinlikleri = termActivities.map(node => ({
                "etkinlik": node.type,
                "sayi": 1,
                "katkiYuzdesi": node.weight,
                "id": node.id
            }));
            
            // Yarƒ±yƒ±l sonu etkinliklerini g√ºncelle
            APP_STATE.courseData.dersDegerlendirme.yariyilSonuEtkinlikleri = finalActivities.map(node => ({
                "etkinlik": node.type,
                "sayi": 1,
                "katkiYuzdesi": node.weight,
                "id": node.id
            }));
            
            // Toplamlarƒ± g√ºncelle
            APP_STATE.courseData.dersDegerlendirme.yariyilIciToplam = termInternalTotal;
            APP_STATE.courseData.dersDegerlendirme.yariyilSonuToplam = finalInternalTotal;
            // Genel deƒüerlendirme deƒüi≈ümez (40-60)
        }
    } catch (error) {
        console.error("Kategori aƒüƒ±rlƒ±klarƒ± g√ºncellenirken hata olu≈ütu:", error);
    }
}

/**
 * Kategori detaylarƒ±nƒ± g√ºncelle (bilgilendirme etiketleri)
 * @param {Array} activities - Etkinlikler listesi
 * @param {string} containerId - Detay container ID'si
 */
function updateCategoryDetails(activities, containerId) {
    try {
        const container = document.getElementById(containerId);
        if (!container) return;
        
        // Container'ƒ± temizle
        container.innerHTML = '';
        
        if (!activities || activities.length === 0) {
            // Bo≈ü durum etiketi
            const emptyTag = document.createElement('span');
            emptyTag.className = 'detail-tag empty-tag';
            emptyTag.innerHTML = '<span class="tag-icon">üì≠</span> Hen√ºz etkinlik eklenmedi';
            container.appendChild(emptyTag);
            return;
        }
        
        // Kompakt etiket sistemi - sadece etkinlikler
        activities.forEach((activity) => {
            // Bu etkinliƒüin soru ve rubrik sayƒ±larƒ±nƒ± hesapla
            let activityQuestions = 0;
            let activityRubrics = 0;
            
            if (activity.children && activity.children.length > 0) {
                activity.children.forEach(child => {
                    if (child.type === 'Soru' || child.type.includes('Soru') || isQuestionType(child.type) || child.type === 'Test') {
                        activityQuestions++;
                    } else if (child.type === 'Rubrik' || child.type.includes('Rubrik') || isRubricType(child.type)) {
                        activityRubrics++;
                    }
                });
            }
            
            // ƒ∞kon se√ßimi
            const getActivityIcon = (type) => {
                if (type.includes('Sƒ±nav')) return 'üìù';
                if (type.includes('Quiz')) return '‚ùì';
                if (type.includes('Proje')) return 'üöÄ';
                if (type.includes('Rapor')) return 'üìä';
                if (type.includes('Deney')) return 'üß™';
                if (type.includes('Laboratuvar')) return '‚öóÔ∏è';
                if (type.includes('Sunum')) return 'üé§';
                if (type.includes('Seminer')) return 'üéì';
                return 'üìö';
            };
            
            // Etkinlik adƒ±nƒ± kƒ±salt
            const activityName = activity.name || activity.type || `Etkinlik ${activity.id}`;
            const shortName = activityName.length > 15 ? activityName.substring(0, 15) + '...' : activityName;
            
            // Tek kompakt etiket olu≈ütur - t√ºm bilgiler bir arada
            const activityTag = document.createElement('span');
            activityTag.className = 'detail-tag activity-single-tag';
            
            // Grup bilgisini al
            const getGroupInfo = (activityId) => {
                if (APP_STATE.courseData && APP_STATE.courseData.grupHaritalari && APP_STATE.courseData.grupHaritalari[activityId]) {
                    const component = APP_STATE.courseData.grupHaritalari[activityId];
                    if (component.gruplar && Array.isArray(component.gruplar)) {
                        const validGroups = component.gruplar.filter(group => 
                            group && group.length === 1 && /^[A-Z]$/.test(group)
                        );
                        if (validGroups.length > 0) {
                            const groupCount = validGroups.length;
                            return ` [${groupCount} Grup]`;
                        }
                    }
                }
                return ' [1 Grup]'; // Varsayƒ±lan grup
            };
            
            // T√ºm bilgileri tek satƒ±rda topla
            let fullInfo = `${getActivityIcon(activity.type)} ${shortName} %${activity.weight || 0}`;
            
            // Soru ve rubrik bilgilerini ekle
            if (activityQuestions > 0 && activityRubrics > 0) {
                fullInfo += ` (${activityQuestions} Soru, ${activityRubrics} Rubrik)`;
            } else if (activityQuestions > 0) {
                fullInfo += ` (${activityQuestions} Soru)`;
            } else if (activityRubrics > 0) {
                fullInfo += ` (${activityRubrics} Rubrik)`;
            } else {
                fullInfo += ` (Bo≈ü)`;
            }
            
            // Grup bilgisini ekle
            fullInfo += getGroupInfo(activity.id);
            
            activityTag.innerHTML = fullInfo;
            activityTag.title = `${activityName}\nAƒüƒ±rlƒ±k: %${activity.weight || 0}\n${activityQuestions} Soru, ${activityRubrics} Rubrik\n${getGroupInfo(activity.id).replace(/[\[\]]/g, '')}`;
            
            container.appendChild(activityTag);
        });
        
    } catch (error) {
        console.error("Kategori detaylarƒ± g√ºncellenirken hata:", error);
    }
}

// =====================================================
// RENDER VE UI G√úNCELLEME FONKSIYONLARI
// =====================================================

/**
 * D√ºƒü√ºm render etme fonksiyonunu g√ºncelleyelim
 * @param {Object} node - Render edilecek d√ºƒü√ºm
 * @param {HTMLElement} parentElement - √úst element
 * @param {number} level - D√ºƒü√ºm seviyesi
 */
function renderNode(node, parentElement, level) {
    try {
        const nodeElement = document.createElement('div');
        nodeElement.className = 'tree-node';
        nodeElement.dataset.id = node.id;
        nodeElement.dataset.nodetype = node.type; // Tip bilgisini veri √∂zniteliƒüi olarak sakla
        
        // D√ºƒü√ºm tipine g√∂re stil ekle
        if (node.id.startsWith('A')) {
            nodeElement.classList.add('term-type');
        } else if (node.id.startsWith('F')) {
            nodeElement.classList.add('final-type');
        } else if (node.type === 'Soru' || node.type.includes('Soru') || isQuestionType(node.type)) {
            nodeElement.classList.add('question-type');
        } else if (node.type === 'Rubrik' || node.type.includes('Rubrik') || isRubricType(node.type)) {
            nodeElement.classList.add('rubric-type');
        } else if (node.type === 'Test') {
            nodeElement.classList.add('question-type');
        }
        
        if (APP_STATE.selectedNode && APP_STATE.selectedNode.id === node.id) {
            nodeElement.classList.add('selected');
        }
        
        // D√ºƒü√ºm tipine g√∂re se√ßenekler olu≈ütur
        let typeOptions = generateTypeOptions(node);
        
        // Soru veya Rubrik i√ßin aƒüƒ±rlƒ±k alanƒ±nƒ± readonly yapmak
        const isSubItem = node.id.includes('.');
        const isQuestionOrRubric = node.type === 'Soru' || node.type.includes('Soru') || isQuestionType(node.type) || 
                               node.type === 'Rubrik' || node.type.includes('Rubrik') || isRubricType(node.type) ||
                               node.type === 'Test';
        
        const isWeightReadonly = isSubItem && isQuestionOrRubric;
        
        // D√ºƒü√ºm HTML i√ßeriƒüi olu≈ütur
        nodeElement.innerHTML = `
            <div class="toggle">${node.children && node.children.length > 0 ? (node.expanded ? '‚ñº' : '‚ñ∂') : '‚Ä¢'}</div>
            <div class="node-checkbox">
                <input type="checkbox" class="node-select-checkbox" data-node-id="${node.id}">
                <div class="node-id-display">${node.id}</div>
            </div>
            <div><textarea placeholder="Etkinlik adƒ±" class="nodeName auto-resize">${node.name || ''}</textarea></div>
            <div>
                <select class="nodeType" data-current-type="${node.type}">
                    ${typeOptions}
                </select>
            </div>
            <div><input type="number" value="${node.weight || 0}" min="0" max="100" class="nodeWeight" ${isWeightReadonly ? 'readonly' : ''}></div>
            <div><input type="number" value="${node.points || 0}" min="0" class="nodePoints"></div>
            <div><textarea placeholder="√ñ√á.1,√ñ√á.2,..." class="nodeOutcomes auto-resize">${Array.isArray(node.outcomes) ? node.outcomes.join(',') : (node.outcomes || '')}</textarea></div>
            <div>
                ${(isQuestionOrRubric && isSubItem) ? `
                    <textarea placeholder="A:1,B:2,C:3" class="nodeGroupMapping auto-resize" data-node-id="${node.id}"></textarea>
                ` : (!isSubItem && (node.id.startsWith('A') || node.id.startsWith('F'))) ? `
                    <textarea class="componentGroupInfo auto-resize" readonly data-component-id="${node.id}" placeholder="Grup bilgisi..."></textarea>
                ` : ''}
            </div>
            <div>
                <textarea placeholder="A√ßƒ±klama..." class="nodeDescription auto-resize">${node.description || ''}</textarea>
            </div>
            <div class="actions-column">
                <div class="button-group">
                    ${(isQuestionOrRubric && isSubItem) ? `
                        <button class="btn btn-warning btn-small btn-group-mapping ${getGroupMappingStatusClass(node.id)}" data-node-id="${node.id}" title="Grup Haritalama Detaylarƒ± - Modal A√ßar">
                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                            Grup Se√ß
                        </button>
                        <button class="btn btn-success btn-small btn-apply-group-mapping" data-node-id="${node.id}" title="Soldaki Grup Bilgisini Kaydet">
                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                            Grup Kaydet
                        </button>
                    ` : ''}
                    ${(!isSubItem && (node.id.startsWith('A') || node.id.startsWith('F'))) ? `
                        <button class="btn btn-warning btn-small btn-manage-component-groups" data-component-id="${node.id}" title="Bu bile≈üenin gruplarƒ±nƒ± ekle/√ßƒ±kar">
                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="m22 21-3-3m0 0-3-3m3 3 3-3m-3 3-3 3"/>
                            </svg>
                            Grup Ekle/√áƒ±kar
                        </button>
                        <button class="btn btn-info btn-small btn-move-up tooltip" data-node-id="${node.id}" data-tooltip="Bu etkinliƒüi yukarƒ± ta≈üƒ±" title="Bu etkinliƒüi yukarƒ± ta≈üƒ±">
                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="18 15 12 9 6 15"></polyline>
                            </svg>
                            ‚Üë
                        </button>
                        <button class="btn btn-info btn-small btn-move-down tooltip" data-node-id="${node.id}" data-tooltip="Bu etkinliƒüi a≈üaƒüƒ± ta≈üƒ±" title="Bu etkinliƒüi a≈üaƒüƒ± ta≈üƒ±">
                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                            ‚Üì
                        </button>
                    ` : ''}
                    <button class="btn btn-secondary btn-small btn-edit-outcomes" data-node-id="${node.id}" title="√ñƒürenme √áƒ±ktƒ±larƒ±nƒ± Se√ß ve D√ºzenle">
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                        √ñ√á Se√ß
                    </button>
                    <button class="btn btn-danger btn-small btn-delete-node" data-node-id="${node.id}" title="Bu √∂ƒüeyi sil">
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </svg>
                        Sil
                </button>
                </div>
            </div>
        `;
        
        // D√ºƒü√ºme olay dinleyicileri ekle
        nodeElement.addEventListener('click', (e) => {
            if (!e.target.closest('input') && !e.target.closest('select') && !e.target.closest('textarea') && !e.target.closest('button')) {
                selectNode(node);
            }
        });
        
        const toggle = nodeElement.querySelector('.toggle');
        toggle.addEventListener('click', (e) => {
            e.stopPropagation();
            node.expanded = !node.expanded;
            renderTree();
        });
        
        // Silme butonu i√ßin olay dinleyicisi
        const deleteButton = nodeElement.querySelector('.btn-delete-node');
        deleteButton.addEventListener('click', (e) => {
            e.stopPropagation();
            deleteNode(node.id);
        });
        
        // Grup haritalama butonu i√ßin olay dinleyicisi
        const groupMappingButton = nodeElement.querySelector('.btn-group-mapping');
        if (groupMappingButton) {
            groupMappingButton.addEventListener('click', (e) => {
                e.stopPropagation();
                showGroupMappingModal(node.id);
            });
        }
        
        // √ñ√á d√ºzenleme butonu i√ßin olay dinleyicisi
        const editOutcomesButton = nodeElement.querySelector('.btn-edit-outcomes');
        if (editOutcomesButton) {
            editOutcomesButton.addEventListener('click', (e) => {
                e.stopPropagation();
                showOutcomesEditModal(node.id);
            });
        }
        

        
        // Bile≈üen gruplarƒ±nƒ± y√∂netme butonu i√ßin olay dinleyicisi
        const manageComponentGroupsButton = nodeElement.querySelector('.btn-manage-component-groups');
        if (manageComponentGroupsButton) {
            manageComponentGroupsButton.addEventListener('click', (e) => {
                e.stopPropagation();
                const componentId = e.target.closest('button').dataset.componentId;
                showComponentGroupManagementModal(componentId);
            });
        }
        
        // Yukarƒ± ta≈üƒ±ma butonu i√ßin olay dinleyicisi
        const moveUpButton = nodeElement.querySelector('.btn-move-up');
        if (moveUpButton) {
            moveUpButton.addEventListener('click', (e) => {
                e.stopPropagation();
                moveActivityUp(node.id);
            });
        }
        
        // A≈üaƒüƒ± ta≈üƒ±ma butonu i√ßin olay dinleyicisi
        const moveDownButton = nodeElement.querySelector('.btn-move-down');
        if (moveDownButton) {
            moveDownButton.addEventListener('click', (e) => {
                e.stopPropagation();
                moveActivityDown(node.id);
            });
        }
        
        // Input deƒüerlerini g√ºncelleme
        const nameInput = nodeElement.querySelector('.nodeName');
        nameInput.addEventListener('change', () => {
            node.name = nameInput.value;
            // Deƒüerlendirme sekmesini g√ºncelle
            updateAssessmentView();
        });
        
        const typeSelect = nodeElement.querySelector('.nodeType');
        typeSelect.addEventListener('change', () => {
            const oldType = node.type;
            const newType = typeSelect.value;
            
            // Tip deƒüi≈üimini kaydet
            node.type = newType;
            
            // Deƒüerlendirme sekmesini g√ºncelle
            updateAssessmentView();
            
            // Soru ve Rubrik ana tipleri arasƒ±ndaki ge√ßi≈üleri √∂zel ele al
            const isMainTypeChange = (
                (isQuestionMainType(oldType) && (newType === 'Rubrik' || isRubricType(newType))) ||
                ((oldType === 'Rubrik' || isRubricType(oldType)) && isQuestionMainType(newType))
            );
            
            // Eƒüer ana t√ºr deƒüi≈üimi varsa t√ºm aƒüacƒ± yeniden render et
            if (isMainTypeChange) {
                renderTree();
            } else {
                // Alt t√ºrler arasƒ± ge√ßi≈ülerde sadece ilgili sƒ±nƒ±flarƒ± g√ºncelle
                updateNodeClassesAfterTypeChange(nodeElement, oldType, newType);
            }
        });
        
        const weightInput = nodeElement.querySelector('.nodeWeight');
        weightInput.addEventListener('change', () => {
            if (!isWeightReadonly) {
                node.weight = parseInt(weightInput.value) || 0;
                updateCategoryWeights();
                // Deƒüerlendirme sekmesini g√ºncelle
                updateAssessmentView();
            }
        });
        
        const pointsInput = nodeElement.querySelector('.nodePoints');
        pointsInput.addEventListener('change', () => {
            // Ana bile≈üen ise (level 0) ve alt √∂ƒüeleri varsa, manuel deƒüi≈üikliƒüi engelle
            if (level === 0 && node.children && node.children.length > 0) {
                // Eski deƒüeri geri y√ºkle
                pointsInput.value = node.points;
                showModernToast("Ana bile≈üenin puanƒ± alt √∂ƒüelerin toplamƒ±na g√∂re otomatik hesaplanƒ±r!", "warning");
                return;
            }
            
            node.points = parseInt(pointsInput.value) || 0;
            
            // Eƒüer bu bir soru/rubrik alt √∂ƒüesi ise, aƒüƒ±rlƒ±ƒüƒ± otomatik hesapla
            if (isSubItem && isQuestionOrRubric) {
                updateSubItemWeight(node);
            }
            
            // Deƒüerlendirme sekmesini g√ºncelle
            updateAssessmentView();
        });
        
        const outcomesInput = nodeElement.querySelector('.nodeOutcomes');
        outcomesInput.addEventListener('change', () => {
            updateOutcomes(node, outcomesInput);
            // Deƒüerlendirme sekmesini g√ºncelle
            updateAssessmentView();
        });
        
        const descriptionInput = nodeElement.querySelector('.nodeDescription');
        descriptionInput.addEventListener('change', () => {
            node.description = descriptionInput.value;
            // Deƒüerlendirme sekmesini g√ºncelle
            updateAssessmentView();
        });
        
        // Ana ekran hƒ±zlƒ± grup giri≈üi event listener'larƒ±
        const groupMappingInput = nodeElement.querySelector('.nodeGroupMapping');
        if (groupMappingInput) {
            // Input'u mevcut haritalama ile doldur
            const mappingText = getCurrentMappingText(node.id);
            groupMappingInput.value = mappingText;
            
            // Auto-resize for group mapping input
            setupAutoResize(groupMappingInput);
            
            // Enter tu≈üu ile de uygulayabilsin
            groupMappingInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    applyInlineGroupMapping(node.id);
                }
            });
        }
        
        const applyGroupMappingBtn = nodeElement.querySelector('.btn-apply-group-mapping');
        if (applyGroupMappingBtn) {
            applyGroupMappingBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                applyInlineGroupMapping(node.id);
            });
        }
        
        // Setup auto-resize for all auto-resize inputs
        const autoResizeInputs = nodeElement.querySelectorAll('.auto-resize');
        autoResizeInputs.forEach(input => {
            setupAutoResize(input);
        });
        
        // GUID sistemi kaldƒ±rƒ±ldƒ± - temizlendi
        
        // Bile≈üen grup bilgisini g√ºncelle (sadece ana bile≈üenler i√ßin)
        const componentGroupInfo = nodeElement.querySelector('.componentGroupInfo');
        if (componentGroupInfo) {
            updateComponentGroupInfo(node.id);
        }
        
        // D√ºƒü√ºm√º parent'a ekle
        parentElement.appendChild(nodeElement);
        
        // Alt d√ºƒü√ºmleri render et
        if (node.children && node.children.length > 0 && node.expanded) {
            const childrenContainer = document.createElement('div');
            childrenContainer.className = 'node-children';
            parentElement.appendChild(childrenContainer);
            
            node.children.forEach(child => {
                renderNode(child, childrenContainer, level + 1);
            });
        }
    } catch (error) {
        console.error("D√ºƒü√ºm render edilirken hata olu≈ütu:", error);
        showModernToast("Deƒüerlendirme bile≈üenleri g√∂r√ºnt√ºlenirken hata olu≈ütu!", "error");
    }
}

/**
 * Alt √∂ƒüelerin (soru/rubrik) aƒüƒ±rlƒ±ƒüƒ±nƒ± otomatik hesaplama
 * @param {Object} node - Aƒüƒ±rlƒ±ƒüƒ± hesaplanacak d√ºƒü√ºm
 */
function updateSubItemWeight(node) {
    try {
        // √úst d√ºƒü√ºm√º bul
        const parentId = node.id.substring(0, node.id.lastIndexOf('.'));
        const parentNode = findNodeById(parentId);
        
        if (!parentNode || !parentNode.children || parentNode.children.length === 0) {
            return;
        }
        
        // Toplam puan hesapla
        const totalPoints = parentNode.children.reduce((sum, child) => sum + (parseInt(child.points) || 0), 0);
        
        // Her √ßocuk i√ßin aƒüƒ±rlƒ±k hesapla
        if (totalPoints > 0) {
            parentNode.children.forEach(child => {
                const childPoints = parseInt(child.points) || 0;
                child.weight = Math.round((childPoints / totalPoints) * 100);
                
                // DOM'da aƒüƒ±rlƒ±k alanƒ±nƒ± g√ºncelle
                const weightInput = document.querySelector(`.tree-node[data-id="${child.id}"] .nodeWeight`);
                if (weightInput) {
                    weightInput.value = child.weight;
                }
            });
        }
        
        // Ana bile≈üenin toplam puanƒ±nƒ± g√ºncelle
        updateComponentTotalPoints(parentNode);
        
        // Kategori aƒüƒ±rlƒ±klarƒ±nƒ± g√ºncelle
        updateCategoryWeights();
    } catch (error) {
        console.error("Alt √∂ƒüe aƒüƒ±rlƒ±ƒüƒ± hesaplanƒ±rken hata olu≈ütu:", error);
    }
}

// GUID sistemi kaldƒ±rƒ±ldƒ±

/**
 * Panoya kopyalama fonksiyonu
 * @param {string} text - Kopyalanacak metin
 */
function copyToClipboard(text) {
    if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
            console.log(`üìã Panoya kopyalandƒ±: ${text}`);
            if (typeof showModernToast === 'function') {
                showModernToast(`üìã Kopyalandƒ±: ${text}`, 'success');
            }
        }).catch(err => {
            console.error('‚ùå Kopyalama hatasƒ±:', err);
            if (typeof showModernToast === 'function') {
                showModernToast('‚ùå Kopyalanamadƒ±!', 'error');
            }
        });
    } else {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            console.log(`üìã Panoya kopyalandƒ± (fallback): ${text}`);
            if (typeof showModernToast === 'function') {
                showModernToast(`üìã Kopyalandƒ±: ${text}`, 'success');
            }
        } catch (err) {
            console.error('‚ùå Kopyalama hatasƒ± (fallback):', err);
            if (typeof showModernToast === 'function') {
                showModernToast('‚ùå Kopyalanamadƒ±!', 'error');
            }
        }
        document.body.removeChild(textArea);
    }
}

/**
 * Ana bile≈üenin toplam puanƒ±nƒ± hesaplama ve g√∂r√ºnt√ºleme
 * @param {Object} node - Ana bile≈üen d√ºƒü√ºm√º
 */
function updateComponentTotalPoints(node) {
    try {
        if (!node.children || node.children.length === 0) {
            return;
        }
        
        // Toplam puanƒ± hesapla (t√ºm alt √∂ƒüelerin puanlarƒ±nƒ±n toplamƒ±)
        const totalPoints = node.children.reduce((sum, child) => {
            return sum + calculateNodeTotalPoints(child);
        }, 0);
        
        // Ana bile≈üenin kendi puanƒ±nƒ± g√ºncelle
        node.points = totalPoints;
        
        // DOM'da puan input'unu g√ºncelle
        const nodeElement = document.querySelector(`.tree-node[data-id="${node.id}"]`);
        if (nodeElement) {
            const pointsInput = nodeElement.querySelector('.nodePoints');
            if (pointsInput) {
                pointsInput.value = totalPoints;
                
                // Input'u renklendirme
                const isStandard = totalPoints === 100;
                pointsInput.classList.remove('standard-points', 'high-points', 'low-points');
                
                                 if (isStandard) {
                     pointsInput.classList.add('standard-points');
                     pointsInput.title = 'Standart 100 puan (Alt √∂ƒüelerin toplamƒ±)';
                 } else if (totalPoints > 100) {
                     pointsInput.classList.add('high-points');
                     pointsInput.title = `Standart √ºzeri: ${totalPoints} puan (Alt √∂ƒüelerin toplamƒ±)`;
                 } else {
                     pointsInput.classList.add('low-points');
                     pointsInput.title = `Standart altƒ±: ${totalPoints} puan (Alt √∂ƒüelerin toplamƒ±)`;
                 }
                 
                 // Ana bile≈üen input'una readonly √∂zelliƒüi ekle
                 pointsInput.readOnly = true;
                 pointsInput.style.cursor = 'not-allowed';
            }
            
            // GUID sistemi kaldƒ±rƒ±ldƒ±
            
            // Eski toplam puan g√∂sterimini kaldƒ±r (artƒ±k input'ta g√∂steriliyor)
            const totalPointsDisplay = nodeElement.querySelector('.total-points-display');
            if (totalPointsDisplay) {
                totalPointsDisplay.remove();
            }
        }
        
        console.log(`Bile≈üen ${node.id} toplam puanƒ± g√ºncellendi: ${totalPoints}`);
        
    } catch (error) {
        console.error("Bile≈üen toplam puanƒ± hesaplanƒ±rken hata:", error);
    }
}

/**
 * Bir d√ºƒü√ºm√ºn toplam puanƒ±nƒ± hesaplama (kendisi + alt d√ºƒü√ºmler)
 * @param {Object} node - D√ºƒü√ºm
 * @returns {number} - Toplam puan
 */
function calculateNodeTotalPoints(node) {
    let totalPoints = parseInt(node.points) || 0;
    
    if (node.children && node.children.length > 0) {
        totalPoints += node.children.reduce((sum, child) => {
            return sum + calculateNodeTotalPoints(child);
        }, 0);
    }
    
    return totalPoints;
}

/**
 * D√ºƒü√ºme soru ekleme
 * @param {Object} parentNode - √úst d√ºƒü√ºm
 * @param {string} questionType - Soru tipi
 * @param {string} description - A√ßƒ±klama
 */
function addQuestionToNode(parentNode, questionType = 'Soru', description = '') {
    if (!parentNode) return;
    
    try {
        if (!parentNode.children) {
            parentNode.children = [];
        }
        
        const childCount = parentNode.children.length;
        const newId = `${parentNode.id}.${childCount + 1}`;
        
        // √ñƒürenme √ßƒ±ktƒ±larƒ± varsa ilk √∂ƒürenme √ßƒ±ktƒ±sƒ±nƒ± atayalƒ±m
        const outcome = parentNode.outcomes.length > 0 ? [parentNode.outcomes[0]] : [];
        
        // Varsayƒ±lan puanƒ± 3 olarak ayarla (√∂nceki 20 yerine)
        const defaultPoints = 3;
        
        const newNode = {
            id: newId,
            name: `${questionType}`,
            type: questionType,
            weight: 0, // Aƒüƒ±rlƒ±k otomatik hesaplanacak
            points: defaultPoints, // Varsayƒ±lan puan 3
            outcomes: outcome,
            description: description || 'Deƒüerlendirme sorusu',
            expanded: true,
            children: []
        };
        
        parentNode.children.push(newNode);
        parentNode.expanded = true;
        
        // Aƒüƒ±rlƒ±ƒüƒ± hesapla
        updateSubItemWeight(newNode);
        
        selectNode(newNode);
        renderTree();
        
        // Deƒüerlendirme sekmesini g√ºncelle
        updateAssessmentView();
        
        // Yeni eklenen bile≈üen i√ßin otomatik mapping atamasƒ±
        assignDefaultMappingToNewComponent(parentNode.id, newNode);
        
        showModernToast(`"${questionType}" sorusu eklendi.`);
        
        // YENƒ∞ KOD: Aƒüƒ±rlƒ±klarƒ± yeniden deƒüerlendir
        checkAndOfferRedistribution(parentNode);
        
    } catch (error) {
        console.error("Soru eklenirken hata olu≈ütu:", error);
        showModernToast("Soru eklenemedi!", "error");
    }
}

/**
 * D√ºƒü√ºme rubrik ekleme
 * @param {Object} parentNode - √úst d√ºƒü√ºm
 * @param {string} rubricType - Rubrik tipi
 * @param {string} description - A√ßƒ±klama
 */
function addRubricToNode(parentNode, rubricType = 'Rubrik', description = '') {
    if (!parentNode) return;
    
    try {
        if (!parentNode.children) {
            parentNode.children = [];
        }
        
        const childCount = parentNode.children.length;
        const newId = `${parentNode.id}.${childCount + 1}`;
        
        // √ñƒürenme √ßƒ±ktƒ±larƒ± varsa ilk √∂ƒürenme √ßƒ±ktƒ±sƒ±nƒ± atayalƒ±m
        const outcome = parentNode.outcomes.length > 0 ? [parentNode.outcomes[0]] : [];
        
        // Varsayƒ±lan puanƒ± 3 olarak ayarla (√∂nceki 20 yerine)
        const defaultPoints = 3;
        
        const newNode = {
            id: newId,
            name: `${rubricType}`,
            type: 'Rubrik',
            weight: 0, // Aƒüƒ±rlƒ±k otomatik hesaplanacak
            points: defaultPoints, // Varsayƒ±lan puan 3
            outcomes: outcome,
            description: description || 'Deƒüerlendirme kriteri',
            expanded: true,
            children: []
        };
        
        parentNode.children.push(newNode);
        parentNode.expanded = true;
        
        // Aƒüƒ±rlƒ±ƒüƒ± hesapla
        updateSubItemWeight(newNode);
        
        selectNode(newNode);
        renderTree();
        
        // Deƒüerlendirme sekmesini g√ºncelle
        updateAssessmentView();
        
        // Yeni eklenen bile≈üen i√ßin otomatik mapping atamasƒ±
        assignDefaultMappingToNewComponent(parentNode.id, newNode);
        
        showModernToast(`"${rubricType}" rubriƒüi eklendi.`);
        
        // YENƒ∞ KOD: Aƒüƒ±rlƒ±klarƒ± yeniden deƒüerlendir
        checkAndOfferRedistribution(parentNode);
        
    } catch (error) {
        console.error("Rubrik eklenirken hata olu≈ütu:", error);
        showModernToast("Rubrik eklenemedi!", "error");
    }
}

/**
 * √áoklu √∂ƒüe ekleme
 */
// ƒ∞lk addMultipleItems fonksiyonu kaldƒ±rƒ±ldƒ± - geli≈ümi≈ü versiyon korundu

/**
 * Soru tipine ait bir t√ºr olup olmadƒ±ƒüƒ±nƒ± kontrol eder
 * @param {string} type - Kontrol edilecek tip
 * @returns {boolean} - Soru tipine ait ise true
 */
function isQuestionType(type) {
    // Direkt 'Soru' ana tipi ise
    if (type === 'Soru') return true;
    
    // Soru i√ßeriyorsa (√∂rn. "A√ßƒ±k U√ßlu Soru")
    if (type.includes('Soru')) return true;
    
    // Soru t√ºrleri listesinde var mƒ± kontrol et
    const questionTypes = Array.from(document.querySelectorAll('.question-type-item'))
        .map(item => item.getAttribute('data-type'));
    
    return questionTypes.includes(type);
}

/**
 * Rubrik tipine ait bir t√ºr olup olmadƒ±ƒüƒ±nƒ± kontrol eder
 * @param {string} type - Kontrol edilecek tip
 * @returns {boolean} - Rubrik tipine ait ise true
 */
function isRubricType(type) {
    // Direkt 'Rubrik' ana tipi ise
    if (type === 'Rubrik') return true;
    
    // Rubrik t√ºrleri listesinde var mƒ± kontrol et
    const rubricTypes = Array.from(document.querySelectorAll('.rubric-item'))
        .map(item => item.getAttribute('data-type'));
    
    return rubricTypes.includes(type);
}

/**
 * Ana Soru tiplerinden biri olup olmadƒ±ƒüƒ±nƒ± kontrol eder
 * @param {string} type - Kontrol edilecek tip
 * @returns {boolean} - Ana soru tiplerinden biri ise true
 */
function isQuestionMainType(type) {
    return type === 'Soru' || type.includes('Soru') || isQuestionType(type);
}

/**
 * Tipe g√∂re dropdown se√ßeneklerini olu≈üturur
 * @param {Object} node - Dropdown se√ßenekleri olu≈üturulacak d√ºƒü√ºm
 * @returns {string} - Dropdown option HTML i√ßeriƒüi
 */
function generateTypeOptions(node) {
    let typeOptions = '';
    
    // K√∂k d√ºƒü√ºmler i√ßin (Ana etkinlikler)
    if (!node.id.includes('.')) {
        // Yarƒ±yƒ±l i√ßi etkinlikler
        if (node.id.startsWith('A')) {
            typeOptions = ACTIVITY_TYPES.term.map(type => 
                `<option value="${type}" ${node.type === type ? 'selected' : ''}>${type}</option>`
            ).join('');
        } 
        // Yarƒ±yƒ±l sonu etkinlikler
        else if (node.id.startsWith('F')) {
            typeOptions = ACTIVITY_TYPES.final.map(type => 
                `<option value="${type}" ${node.type === type ? 'selected' : ''}>${type}</option>`
            ).join('');
        }
    } 
    // Alt d√ºƒü√ºmler i√ßin (Sorular, rubrikler vb.)
    else {
        // Test tipi i√ßin sadece Test se√ßeneƒüi
        if (node.type === 'Test') {
            typeOptions = `<option value="Test" selected>Test Sorularƒ± (Toplu)</option>`;
        }
        // Soru tipi ve t√ºrevleri i√ßin
        else if (node.type === 'Soru' || node.type.includes('Soru') || isQuestionType(node.type)) {
            // √ñnce ana 'Soru' se√ßeneƒüi
            typeOptions = `<option value="Soru" ${node.type === 'Soru' ? 'selected' : ''}>Soru</option>`;
            
            // Sonra diƒüer soru t√ºrleri
            const questionTypes = Array.from(document.querySelectorAll('.question-type-item'))
                .map(item => item.getAttribute('data-type'))
                .filter(type => type !== 'Test'); // Test t√ºr√ºn√º hari√ß tut
                
            questionTypes.forEach(type => {
                typeOptions += `<option value="${type}" ${node.type === type ? 'selected' : ''}>${type}</option>`;
            });
        } 
        // Rubrik tipi ve t√ºrevleri i√ßin
        else {
            // √ñnce ana 'Rubrik' se√ßeneƒüi
            typeOptions = `<option value="Rubrik" ${node.type === 'Rubrik' ? 'selected' : ''}>Rubrik</option>`;
            
            // Sonra diƒüer rubrik t√ºrleri
            const rubricTypes = Array.from(document.querySelectorAll('.rubric-item'))
                .map(item => item.getAttribute('data-type'));
                
            rubricTypes.forEach(type => {
                typeOptions += `<option value="${type}" ${node.type === type ? 'selected' : ''}>${type}</option>`;
            });
        }
    }
    
    return typeOptions;
}

/**
 * Tip deƒüi≈üikliƒüinden sonra node sƒ±nƒ±flarƒ±nƒ± g√ºnceller
 * @param {HTMLElement} nodeElement - D√ºƒü√ºm elementi
 * @param {string} oldType - Eski tip
 * @param {string} newType - Yeni tip
 */
function updateNodeClassesAfterTypeChange(nodeElement, oldType, newType) {
    // Eski tip sƒ±nƒ±flarƒ±nƒ± kaldƒ±r
    if (isQuestionType(oldType)) {
        nodeElement.classList.remove('question-type');
    } else if (isRubricType(oldType)) {
        nodeElement.classList.remove('rubric-type');
    }
    
    // Yeni tip sƒ±nƒ±flarƒ±nƒ± ekle
    if (isQuestionType(newType)) {
        nodeElement.classList.add('question-type');
    } else if (isRubricType(newType)) {
        nodeElement.classList.add('rubric-type');
    }
    
    // Tip bilgisini veri √∂zniteliƒüinde g√ºncelle
    nodeElement.dataset.nodetype = newType;
}
// Debounced render i√ßin timer
let renderTreeTimer = null;

/**
 * Aƒüacƒ± render etme - Debounced versiyon (Performans optimizasyonu)
 */
function renderTree() {
    // Debounce: 100ms i√ßinde tekrar √ßaƒürƒ±lƒ±rsa √∂nceki render'ƒ± iptal et
    if (renderTreeTimer) {
        clearTimeout(renderTreeTimer);
    }
    
    renderTreeTimer = setTimeout(() => {
        renderTreeImmediate();
        renderTreeTimer = null;
    }, 100);
}

/**
 * Aƒüacƒ± hemen render etme - Ger√ßek render i≈ülemi
 */
function renderTreeImmediate() {
    try {
        treeContainer.innerHTML = '';
        
        if (!APP_STATE.assessmentTree || APP_STATE.assessmentTree.length === 0) {
            const emptyMessage = document.createElement('div');
            emptyMessage.className = 'tree-empty-message';
            emptyMessage.textContent = 'Hen√ºz deƒüerlendirme bile≈üeni eklenmedi. Ders JSON y√ºkleyin veya yeni bile≈üenler ekleyin.';
            treeContainer.appendChild(emptyMessage);
            return;
        }

        // Yarƒ±yƒ±l i√ßi b√∂l√ºm√º olu≈ütur
        const termSection = document.createElement('div');
        termSection.className = 'tree-section term-section';
        
        // Yarƒ±yƒ±l i√ßi ba≈ülƒ±k
        const termHeader = document.createElement('div');
        termHeader.className = 'tree-section-header';
        termHeader.innerHTML = `
            <h3>Yarƒ±yƒ±l ƒ∞√ßi Deƒüerlendirme Bile≈üenleri</h3>
            <div class="tree-section-controls">
                <div class="select-all-checkbox">
                    <input type="checkbox" id="selectAllTerm">
                    <label for="selectAllTerm">Hepsini Se√ß</label>
                </div>
                <div class="bulk-action-buttons">
                    <div class="tooltip">
                        <button class="btn-bulk btn-copy" id="bulkCopyTerm" disabled>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                            Kopyala
                        </button>
                        <span class="tooltiptext">Se√ßili bile≈üenlerin kopyasƒ±nƒ± olu≈üturup yarƒ±yƒ±l i√ßi b√∂l√ºm√ºn√ºn sonuna ekler. Aynƒ± yapƒ±da yeni bile≈üenler olu≈üturur.</span>
                    </div>
                    <div class="tooltip">
                        <button class="btn-bulk btn-delete" id="bulkDeleteTerm" disabled>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                            Sil
                        </button>
                        <span class="tooltiptext">Se√ßili bile≈üenleri kalƒ±cƒ± olarak siler. Bu i≈ülem geri alƒ±namaz! Dikkatli kullanƒ±n.</span>
                    </div>
                </div>
            </div>
        `;
        termSection.appendChild(termHeader);
        
        // Yarƒ±yƒ±l i√ßi d√ºƒü√ºmleri
        const termNodes = APP_STATE.assessmentTree.filter(node => node.id.startsWith('A'));
        
        if (termNodes.length === 0) {
            const emptyTerm = document.createElement('div');
            emptyTerm.className = 'tree-section-empty';
            emptyTerm.textContent = 'Hen√ºz yarƒ±yƒ±l i√ßi deƒüerlendirme bile≈üeni eklenmedi.';
            termSection.appendChild(emptyTerm);
        } else {
            termNodes.forEach(node => {
                renderNode(node, termSection, 0);
                // Ana bile≈üen i√ßin toplam puan hesaplamasƒ±nƒ± tetikle
                if (node.children && node.children.length > 0) {
                    setTimeout(() => updateComponentTotalPoints(node), 100);
                }
            });
        }
        
        // Yarƒ±yƒ±l i√ßi b√∂l√ºm√º i√ßin ekleme butonu
        const termAddButton = document.createElement('div');
        termAddButton.className = 'add-node-button';
        termAddButton.innerHTML = `
            <button class="btn btn-add-node" data-section="term">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Yarƒ±yƒ±l ƒ∞√ßi Etkinlik Ekle
            </button>
        `;
        termSection.appendChild(termAddButton);
        
        // Yarƒ±yƒ±l sonu b√∂l√ºm√º olu≈ütur
        const finalSection = document.createElement('div');
        finalSection.className = 'tree-section final-section';
        
        // Yarƒ±yƒ±l sonu ba≈ülƒ±k
        const finalHeader = document.createElement('div');
        finalHeader.className = 'tree-section-header';
        finalHeader.innerHTML = `
            <h3>Yarƒ±yƒ±l Sonu Deƒüerlendirme Bile≈üenleri</h3>
            <div class="tree-section-controls">
                <div class="select-all-checkbox">
                    <input type="checkbox" id="selectAllFinal">
                    <label for="selectAllFinal">Hepsini Se√ß</label>
                </div>
                <div class="bulk-action-buttons">
                    <div class="tooltip">
                        <button class="btn-bulk btn-copy" id="bulkCopyFinal" disabled>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                            Kopyala
                        </button>
                        <span class="tooltiptext">Se√ßili bile≈üenlerin kopyasƒ±nƒ± olu≈üturup yarƒ±yƒ±l sonu b√∂l√ºm√ºn√ºn sonuna ekler. Aynƒ± yapƒ±da yeni bile≈üenler olu≈üturur.</span>
                    </div>
                    <div class="tooltip">
                        <button class="btn-bulk btn-delete" id="bulkDeleteFinal" disabled>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                            Sil
                        </button>
                        <span class="tooltiptext">Se√ßili bile≈üenleri kalƒ±cƒ± olarak siler. Bu i≈ülem geri alƒ±namaz! Dikkatli kullanƒ±n.</span>
                    </div>
                </div>
            </div>
        `;
        finalSection.appendChild(finalHeader);
        
        // Yarƒ±yƒ±l sonu d√ºƒü√ºmleri
        const finalNodes = APP_STATE.assessmentTree.filter(node => node.id.startsWith('F'));
        
        if (finalNodes.length === 0) {
            const emptyFinal = document.createElement('div');
            emptyFinal.className = 'tree-section-empty';
            emptyFinal.textContent = 'Hen√ºz yarƒ±yƒ±l sonu deƒüerlendirme bile≈üeni eklenmedi.';
            finalSection.appendChild(emptyFinal);
        } else {
            finalNodes.forEach(node => {
                renderNode(node, finalSection, 0);
                // Ana bile≈üen i√ßin toplam puan hesaplamasƒ±nƒ± tetikle
                if (node.children && node.children.length > 0) {
                    setTimeout(() => updateComponentTotalPoints(node), 100);
                }
            });
        }
        
        // Yarƒ±yƒ±l sonu b√∂l√ºm√º i√ßin ekleme butonu
        const finalAddButton = document.createElement('div');
        finalAddButton.className = 'add-node-button';
        finalAddButton.innerHTML = `
            <button class="btn btn-add-node" data-section="final">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Yarƒ±yƒ±l Sonu Etkinlik Ekle
            </button>
        `;
        finalSection.appendChild(finalAddButton);
        
        // ƒ∞lk √∂nce yarƒ±yƒ±l i√ßi, sonra yarƒ±yƒ±l sonu b√∂l√ºmlerini ekle
        treeContainer.appendChild(termSection);
        treeContainer.appendChild(finalSection);
        
        // Ekleme butonlarƒ± i√ßin olay dinleyicileri
        document.querySelectorAll('.btn-add-node').forEach(button => {
            button.addEventListener('click', function() {
                const section = this.getAttribute('data-section');
                if (section === 'term') {
                    addTermActivity();
                } else if (section === 'final') {
                    addFinalActivity();
                }
            });
        });

        // Toplu i≈ülem olay dinleyicileri
        setupBulkActionListeners();
        
        // Aƒüƒ±rlƒ±klarƒ± g√ºncelle
        updateCategoryWeights();
        
        // Grup haritalama UI'larƒ±nƒ± g√ºncelle - v5 format i√ßin zorlamalƒ± g√ºncelleme
        setTimeout(() => {
            console.log("üîÑ Grup UI g√ºncellemesi ba≈ülƒ±yor...");
            console.log("üìä Mevcut grup haritalama verileri:", APP_STATE.courseData?.grupHaritalari);
            updateGroupMappingColors();
            updateAllInlineGroupInputs();
            console.log("‚úÖ Grup UI g√ºncellemesi tamamlandƒ±");
        }, 100);
        
        // Ek g√ºncelleme - bazen ilk seferde yakalanmƒ±yor
        setTimeout(() => {
            console.log("üîÑ ƒ∞kinci grup UI g√ºncellemesi...");
            updateAllInlineGroupInputs();
            
            // Her bile≈üen i√ßin grup bilgilerini kontrol et
            Object.keys(APP_STATE.courseData?.grupHaritalari || {}).forEach(componentId => {
                console.log(`üîç ${componentId} i√ßin grup bilgisi kontrol√º...`);
                updateComponentGroupInfo(componentId);
            });
        }, 500);
        
        // S√ºr√ºkle-bƒ±rak √∂zelliƒüini etkinle≈ütir
        setTimeout(() => {
            enableDragAndDrop();
        }, 200);
        
            console.log('üéØ renderTree tamamlandƒ±');
    } catch (error) {
        console.error("Aƒüa√ß render edilirken hata olu≈ütu:", error);
        showModernToast("Deƒüerlendirme aƒüacƒ± y√ºklenirken hata olu≈ütu!", "error");
    }
}

/**
 * Toplu i≈ülem olay dinleyicilerini kurma
 */
function setupBulkActionListeners() {
    // Yarƒ±yƒ±l i√ßi kontrolleri
    const selectAllTerm = document.getElementById('selectAllTerm');
    const bulkCopyTerm = document.getElementById('bulkCopyTerm');
    const bulkDeleteTerm = document.getElementById('bulkDeleteTerm');
    
    // Yarƒ±yƒ±l sonu kontrolleri
    const selectAllFinal = document.getElementById('selectAllFinal');
    const bulkCopyFinal = document.getElementById('bulkCopyFinal');
    const bulkDeleteFinal = document.getElementById('bulkDeleteFinal');
    
    // Hepsini se√ß/se√ßimi kaldƒ±r - Yarƒ±yƒ±l ƒ∞√ßi
    if (selectAllTerm) {
        selectAllTerm.addEventListener('change', (e) => {
            const termNodes = document.querySelectorAll('.term-section .node-select-checkbox');
            termNodes.forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
            updateBulkActionButtons('term');
        });
    }
    
    // Hepsini se√ß/se√ßimi kaldƒ±r - Yarƒ±yƒ±l Sonu
    if (selectAllFinal) {
        selectAllFinal.addEventListener('change', (e) => {
            const finalNodes = document.querySelectorAll('.final-section .node-select-checkbox');
            finalNodes.forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
            updateBulkActionButtons('final');
        });
    }
    
    // Bireysel checkbox deƒüi≈üiklikleri
    document.querySelectorAll('.node-select-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
            e.stopPropagation();
            const section = e.target.closest('.term-section') ? 'term' : 'final';
            updateBulkActionButtons(section);
            updateSelectAllCheckbox(section);
        });
    });
    
    // Kopyalama butonlarƒ±
    if (bulkCopyTerm) {
        bulkCopyTerm.addEventListener('click', () => {
            const selectedIds = getSelectedNodeIds('term');
            if (selectedIds.length > 0) {
                bulkCopyNodes(selectedIds, 'term');
            }
        });
    }
    
    if (bulkCopyFinal) {
        bulkCopyFinal.addEventListener('click', () => {
            const selectedIds = getSelectedNodeIds('final');
            if (selectedIds.length > 0) {
                bulkCopyNodes(selectedIds, 'final');
            }
        });
    }
    
    // Silme butonlarƒ±
    if (bulkDeleteTerm) {
        bulkDeleteTerm.addEventListener('click', () => {
            const selectedIds = getSelectedNodeIds('term');
            if (selectedIds.length > 0) {
                bulkDeleteNodes(selectedIds, 'term');
            }
        });
    }
    
    if (bulkDeleteFinal) {
        bulkDeleteFinal.addEventListener('click', () => {
            const selectedIds = getSelectedNodeIds('final');
            if (selectedIds.length > 0) {
                bulkDeleteNodes(selectedIds, 'final');
            }
        });
    }
}

/**
 * Se√ßili d√ºƒü√ºm ID'lerini al
 */
function getSelectedNodeIds(section) {
    const sectionClass = section === 'term' ? '.term-section' : '.final-section';
    const selectedCheckboxes = document.querySelectorAll(`${sectionClass} .node-select-checkbox:checked`);
    return Array.from(selectedCheckboxes).map(cb => cb.dataset.nodeId);
}

/**
 * Toplu i≈ülem butonlarƒ±nƒ±n durumunu g√ºncelle
 */
function updateBulkActionButtons(section) {
    const selectedIds = getSelectedNodeIds(section);
    const copyBtn = document.getElementById(`bulkCopy${section.charAt(0).toUpperCase() + section.slice(1)}`);
    const deleteBtn = document.getElementById(`bulkDelete${section.charAt(0).toUpperCase() + section.slice(1)}`);
    
    if (copyBtn) copyBtn.disabled = selectedIds.length === 0;
    if (deleteBtn) deleteBtn.disabled = selectedIds.length === 0;
}

/**
 * Hepsini se√ß checkbox'ƒ±nƒ±n durumunu g√ºncelle
 */
function updateSelectAllCheckbox(section) {
    const sectionClass = section === 'term' ? '.term-section' : '.final-section';
    const allCheckboxes = document.querySelectorAll(`${sectionClass} .node-select-checkbox`);
    const checkedCheckboxes = document.querySelectorAll(`${sectionClass} .node-select-checkbox:checked`);
    const selectAllCheckbox = document.getElementById(`selectAll${section.charAt(0).toUpperCase() + section.slice(1)}`);
    
    if (selectAllCheckbox && allCheckboxes.length > 0) {
        selectAllCheckbox.checked = checkedCheckboxes.length === allCheckboxes.length;
        selectAllCheckbox.indeterminate = checkedCheckboxes.length > 0 && checkedCheckboxes.length < allCheckboxes.length;
    }
}

/**
 * Se√ßili d√ºƒü√ºmleri kopyala
 */
function bulkCopyNodes(nodeIds, section) {
    // Se√ßili bile≈üenleri ana etkinlik ve alt bile≈üen olarak ayƒ±r
    const mainActivities = [];
    const subComponents = [];
    
    nodeIds.forEach(nodeId => {
        const node = findNodeById(nodeId);
        if (node) {
            const isMainActivity = !nodeId.includes('.');
            const componentInfo = {
                id: nodeId,
                name: node.name || node.type || 'ƒ∞simsiz',
                type: node.type || 'Bilinmeyen',
                node: node
            };
            
            if (isMainActivity) {
                mainActivities.push(componentInfo);
            } else {
                subComponents.push(componentInfo);
            }
        }
    });
    
    // Mesajƒ± olu≈ütur
    let message = `${nodeIds.length} adet se√ßili bile≈üenin kopyasƒ±nƒ± olu≈üturmak istediƒüinizden emin misiniz?\n\n`;
    
    if (mainActivities.length > 0) {
        message += `üìã Ana Etkinlikler (${mainActivities.length} adet):\n`;
        mainActivities.slice(0, 5).forEach((comp, index) => {
            message += `${index + 1}. ${comp.id} - ${comp.name}\n`;
        });
        if (mainActivities.length > 5) {
            message += `... ve ${mainActivities.length - 5} tane daha\n`;
        }
        message += `‚Üí Etkinliklerin sonuna eklenecek\n\n`;
    }
    
    if (subComponents.length > 0) {
        message += `üîß Alt Bile≈üenler (${subComponents.length} adet):\n`;
        subComponents.slice(0, 5).forEach((comp, index) => {
            const parentId = comp.id.substring(0, comp.id.lastIndexOf('.'));
            message += `${index + 1}. ${comp.id} - ${comp.name} (${parentId} i√ßine)\n`;
        });
        if (subComponents.length > 5) {
            message += `... ve ${subComponents.length - 5} tane daha\n`;
        }
        message += `‚Üí Kendi ana etkinliklerinin sonuna eklenecek\n\n`;
    }
    
    showModernConfirm(
        'Se√ßili Bile≈üenleri Kopyala',
        message,
        {
            confirmText: 'Evet, Kopyala',
            cancelText: 'ƒ∞ptal',
            headerClass: 'info-action',
            iconClass: 'info'
        }
    ).then(confirmed => {
        if (confirmed) {
            try {
                let copiedCount = 0;
                
                // Ana etkinlikleri kopyala (etkinliklerin sonuna)
                mainActivities.forEach(comp => {
                    const copiedNode = deepCopyNode(comp.node, section);
                    APP_STATE.assessmentTree.push(copiedNode);
                    
                    // Orijinal etkinliƒüin grup haritalamalarƒ±nƒ± kopyala
                    copyGroupMappingsForActivity(comp.node.id, copiedNode.id);
                    
                    copiedCount++;
                });
                
                // Alt bile≈üenleri kopyala (kendi parent'larƒ±nƒ±n sonuna)
                subComponents.forEach(comp => {
                    const parentId = comp.id.substring(0, comp.id.lastIndexOf('.'));
                    const parentNode = findNodeById(parentId);
                    
                    if (parentNode) {
                        const copiedSubComponent = deepCopySubComponent(comp.node, parentNode);
                        if (!parentNode.children) {
                            parentNode.children = [];
                        }
                        parentNode.children.push(copiedSubComponent);
                        
                        // Parent'ƒ±n grup haritalamalarƒ±na yeni alt bile≈üeni ekle
                        addSubComponentToGroupMappings(parentNode.id, copiedSubComponent.id);
                        
                        copiedCount++;
                    }
                });
                
                // T√ºm ID'leri yeniden d√ºzenle
                const oldToNewIdMap = reorganizeAllIds();
                
                // Grup haritalamalarƒ±nƒ± yeni ID'lerle g√ºncelle
                updateGroupMappingsAfterIdChange(oldToNewIdMap);
                
                renderTree();
                updateCategoryWeights();
                updateAssessmentView();
                
                // √ñƒürenci grup bilgilerini g√ºncelle
                updateStudentGroupInfoDisplay();
                
                showModernToast(`${copiedCount} adet bile≈üen ba≈üarƒ±yla kopyalandƒ±!`, "success");
                
                // Se√ßimleri temizle
                clearSelections(section);
                
            } catch (error) {
                console.error("Toplu kopyalama hatasƒ±:", error);
                showModernToast("Kopyalama i≈ülemi sƒ±rasƒ±nda hata olu≈ütu!", "error");
            }
        }
    });
}

/**
 * Se√ßili d√ºƒü√ºmleri sil
 */
function bulkDeleteNodes(nodeIds, section) {
    // Se√ßili bile≈üenlerin bilgilerini topla
    const selectedComponents = nodeIds.map(nodeId => {
        const node = findNodeById(nodeId);
        return node ? {
            id: nodeId,
            name: node.name || node.type || 'ƒ∞simsiz',
            type: node.type || 'Bilinmeyen'
        } : null;
    }).filter(Boolean);
    
    // Mesajƒ± olu≈ütur
    let message = `${selectedComponents.length} adet se√ßili bile≈üeni kalƒ±cƒ± olarak silmek istediƒüinizden emin misiniz?\n\n`;
    
    // Eƒüer 10'dan az bile≈üen varsa hepsini listele
    if (selectedComponents.length <= 10) {
        message += "Silinecek bile≈üenler:\n";
        selectedComponents.forEach((comp, index) => {
            message += `${index + 1}. ${comp.id} - ${comp.name} (${comp.type})\n`;
        });
    } else {
        // 10'dan fazla varsa ilk 8'ini g√∂ster, sonra "..." ekle
        message += "Silinecek bile≈üenler (ilk 8 tanesi):\n";
        selectedComponents.slice(0, 8).forEach((comp, index) => {
            message += `${index + 1}. ${comp.id} - ${comp.name} (${comp.type})\n`;
        });
        message += `... ve ${selectedComponents.length - 8} tane daha\n`;
    }
    
    message += "\n‚ö†Ô∏è Bu i≈ülem geri alƒ±namaz!";
    
    showModernConfirm(
        'Se√ßili Bile≈üenleri Sil',
        message,
        {
            confirmText: 'Evet, Sil',
            cancelText: 'ƒ∞ptal',
            headerClass: 'danger-action',
            iconClass: 'danger'
        }
    ).then(confirmed => {
        if (confirmed) {
            try {
                let deletedCount = 0;
                
                // Silme i≈ülemini ters sƒ±rada yap (alt d√ºƒü√ºmlerden ba≈ülayarak)
                nodeIds.reverse().forEach(nodeId => {
                    if (deleteNodeSilently(nodeId)) {
                        deletedCount++;
                    }
                });
                
                // T√ºm ID'leri yeniden d√ºzenle
                reorganizeAllIds();
                
                renderTree();
                updateCategoryWeights();
                updateAssessmentView();
                
                // √ñƒürenci grup bilgilerini g√ºncelle
                updateStudentGroupInfoDisplay();
                
                showModernToast(`${deletedCount} adet bile≈üen ba≈üarƒ±yla silindi!`, "success");
                
                // Se√ßimleri temizle
                clearSelections(section);
                
            } catch (error) {
                console.error("Toplu silme hatasƒ±:", error);
                showModernToast("Silme i≈ülemi sƒ±rasƒ±nda hata olu≈ütu!", "error");
            }
        }
    });
}

/**
 * D√ºƒü√ºm kopyalama (derin kopya) - Ana etkinlikler i√ßin
 */
function deepCopyNode(node, targetSection) {
    const prefix = targetSection === 'term' ? 'A' : 'F';
    const existingNodes = APP_STATE.assessmentTree.filter(n => n.id.startsWith(prefix));
    const newIndex = existingNodes.length + 1;
    const newId = `${prefix}${newIndex}`;
    
    const copiedNode = {
        id: newId,
        name: `${node.name} (Kopya)`,
        type: node.type,
        weight: node.weight || 0,
        points: node.points || 0,
        outcomes: Array.isArray(node.outcomes) ? [...node.outcomes] : node.outcomes,
        description: node.description || '',
        expanded: node.expanded || false,
        children: []
    };
    
    // Alt d√ºƒü√ºmleri de kopyala
    if (node.children && node.children.length > 0) {
        node.children.forEach((child, index) => {
            const childCopy = {
                id: `${newId}.${index + 1}`,
                name: child.name,
                type: child.type,
                weight: child.weight || 0,
                points: child.points || 0,
                outcomes: Array.isArray(child.outcomes) ? [...child.outcomes] : child.outcomes,
                description: child.description || '',
                expanded: child.expanded || false,
                children: []
            };
            copiedNode.children.push(childCopy);
        });
    }
    
    return copiedNode;
}

/**
 * Alt bile≈üen kopyalama - Parent etkinliƒüin i√ßine
 */
function deepCopySubComponent(subComponent, parentNode) {
    // Parent'ƒ±n mevcut alt bile≈üen sayƒ±sƒ±nƒ± al
    const existingChildrenCount = parentNode.children ? parentNode.children.length : 0;
    const newIndex = existingChildrenCount + 1;
    const newId = `${parentNode.id}.${newIndex}`;
    
    const copiedSubComponent = {
        id: newId,
        name: `${subComponent.name} (Kopya)`,
        type: subComponent.type,
        weight: subComponent.weight || 0,
        points: subComponent.points || 0,
        outcomes: Array.isArray(subComponent.outcomes) ? [...subComponent.outcomes] : subComponent.outcomes,
        description: subComponent.description || '',
        expanded: subComponent.expanded || false,
        children: []
    };
    
    // Eƒüer alt bile≈üenin de √ßocuklarƒ± varsa onlarƒ± da kopyala (deep copy)
    if (subComponent.children && subComponent.children.length > 0) {
        subComponent.children.forEach((child, index) => {
            const childCopy = {
                id: `${newId}.${index + 1}`,
                name: child.name,
                type: child.type,
                weight: child.weight || 0,
                points: child.points || 0,
                outcomes: Array.isArray(child.outcomes) ? [...child.outcomes] : child.outcomes,
                description: child.description || '',
                expanded: child.expanded || false,
                children: []
            };
            copiedSubComponent.children.push(childCopy);
        });
    }
    
    return copiedSubComponent;
}

/**
 * Etkinlik grup haritalamalarƒ±nƒ± kopyala
 * @param {string} sourceActivityId - Kaynak etkinlik ID'si
 * @param {string} targetActivityId - Hedef etkinlik ID'si
 */
function copyGroupMappingsForActivity(sourceActivityId, targetActivityId) {
    if (!APP_STATE.courseData?.grupHaritalari) {
        APP_STATE.courseData.grupHaritalari = {};
    }
    
    const sourceMapping = APP_STATE.courseData.grupHaritalari[sourceActivityId];
    
    if (sourceMapping) {
        // Kaynak haritalamayƒ± derin kopya ile kopyala
        const targetMapping = JSON.parse(JSON.stringify(sourceMapping));
        
        // Hedef etkinlik i√ßin haritalamayƒ± kaydet
        APP_STATE.courseData.grupHaritalari[targetActivityId] = targetMapping;
        
        console.log(`‚úÖ Grup haritalama kopyalandƒ±: ${sourceActivityId} ‚Üí ${targetActivityId}`);
    } else {
        // Kaynak haritalama yoksa varsayƒ±lan olu≈ütur
        APP_STATE.courseData.grupHaritalari[targetActivityId] = {
            gruplar: ["A"],
            haritalar: {
                "A": {}
            }
        };
        
        console.log(`‚úÖ Varsayƒ±lan grup haritalama olu≈üturuldu: ${targetActivityId}`);
    }
}

/**
 * Alt bile≈üeni parent'ƒ±n grup haritalamalarƒ±na ekle
 * @param {string} parentId - Parent etkinlik ID'si
 * @param {string} subComponentId - Alt bile≈üen ID'si
 */
function addSubComponentToGroupMappings(parentId, subComponentId) {
    if (!APP_STATE.courseData?.grupHaritalari?.[parentId]) {
        // Parent i√ßin grup haritalama yoksa olu≈ütur
        APP_STATE.courseData.grupHaritalari[parentId] = {
            gruplar: ["A"],
            haritalar: {
                "A": {}
            }
        };
    }
    
    const parentMapping = APP_STATE.courseData.grupHaritalari[parentId];
    
    // Her grup i√ßin yeni alt bile≈üeni ekle
    parentMapping.gruplar.forEach(groupName => {
        if (!parentMapping.haritalar[groupName]) {
            parentMapping.haritalar[groupName] = {};
        }
        
        // Bu grupta ka√ß alt bile≈üen var, ona g√∂re sƒ±ra numarasƒ± ver
        const existingMappings = parentMapping.haritalar[groupName];
        const nextPosition = Object.keys(existingMappings).length + 1;
        
        // Yeni alt bile≈üeni haritalamaya ekle
        parentMapping.haritalar[groupName][subComponentId] = nextPosition.toString();
        
                 console.log(`‚úÖ Alt bile≈üen grup haritalamaya eklendi: ${subComponentId} ‚Üí ${parentId} (Grup: ${groupName}, Sƒ±ra: ${nextPosition})`);
     });
}

/**
 * ID deƒüi≈üikliƒüi sonrasƒ± grup haritalamalarƒ±nƒ± g√ºncelle
 * @param {Object} oldToNewIdMap - Eski ID'den yeni ID'ye mapping
 */
function updateGroupMappingsAfterIdChange(oldToNewIdMap) {
    if (!APP_STATE.courseData?.grupHaritalari || !oldToNewIdMap) {
        return;
    }
    
    const updatedMappings = {};
    
    // Her etkinlik i√ßin grup haritalamalarƒ±nƒ± g√ºncelle
    Object.keys(APP_STATE.courseData.grupHaritalari).forEach(activityId => {
        const newActivityId = oldToNewIdMap[activityId] || activityId;
        const activityMapping = APP_STATE.courseData.grupHaritalari[activityId];
        
        if (activityMapping && activityMapping.haritalar) {
            const updatedActivityMapping = {
                gruplar: [...activityMapping.gruplar],
                haritalar: {}
            };
            
            // Her grup i√ßin haritalamayƒ± g√ºncelle
            Object.keys(activityMapping.haritalar).forEach(groupName => {
                const groupMapping = activityMapping.haritalar[groupName];
                const updatedGroupMapping = {};
                
                // Her alt bile≈üen i√ßin ID'yi g√ºncelle
                Object.keys(groupMapping).forEach(oldSubId => {
                    const newSubId = oldToNewIdMap[oldSubId] || oldSubId;
                    const position = groupMapping[oldSubId];
                    updatedGroupMapping[newSubId] = position;
                    
                    if (oldSubId !== newSubId) {
                        console.log(`üîÑ Grup haritalama ID g√ºncellendi: ${oldSubId} ‚Üí ${newSubId} (Grup: ${groupName})`);
                    }
                });
                
                updatedActivityMapping.haritalar[groupName] = updatedGroupMapping;
            });
            
            updatedMappings[newActivityId] = updatedActivityMapping;
            
            if (activityId !== newActivityId) {
                console.log(`üîÑ Etkinlik grup haritalama ID g√ºncellendi: ${activityId} ‚Üí ${newActivityId}`);
            }
        }
    });
    
    // G√ºncellenmi≈ü haritalamayƒ± kaydet
    APP_STATE.courseData.grupHaritalari = updatedMappings;
    
    console.log('‚úÖ T√ºm grup haritalamalar ID deƒüi≈üikliƒüi sonrasƒ± g√ºncellendi');
}

/**
 * Se√ßimleri temizle
 */
function clearSelections(section) {
    const sectionClass = section === 'term' ? '.term-section' : '.final-section';
    const checkboxes = document.querySelectorAll(`${sectionClass} .node-select-checkbox`);
    checkboxes.forEach(cb => cb.checked = false);
    
    const selectAllCheckbox = document.getElementById(`selectAll${section.charAt(0).toUpperCase() + section.slice(1)}`);
    if (selectAllCheckbox) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    }
    
    updateBulkActionButtons(section);
}

/**
 * D√ºƒü√ºm silme - sessiz silme (onay modalƒ± olmadan)
 * @param {string} nodeId - Silinecek d√ºƒü√ºm ID'si
 * @returns {boolean} - Silme ba≈üarƒ±lƒ± mƒ±
 */
function deleteNodeSilently(nodeId) {
    if (!nodeId) return false;
    
    try {
        // D√ºƒü√ºm√º bul
        const node = findNodeById(nodeId);
        if (!node) return false;
        
        // Se√ßili d√ºƒü√ºm siliniyorsa se√ßimi kaldƒ±r
        if (APP_STATE.selectedNode && APP_STATE.selectedNode.id === nodeId) {
            APP_STATE.selectedNode = null;
        }
        
        // K√∂k d√ºƒü√ºm m√º kontrol et
        const isRoot = !nodeId.includes('.');
        
        if (isRoot) {
            // K√∂k d√ºƒü√ºm√º sil
            const index = APP_STATE.assessmentTree.findIndex(node => node.id === nodeId);
            if (index !== -1) {
                APP_STATE.assessmentTree.splice(index, 1);
                return true;
            }
        } else {
            // Alt d√ºƒü√ºm√º sil
            const parentId = nodeId.substring(0, nodeId.lastIndexOf('.'));
            const findParentAndRemoveChild = (nodes, id) => {
                for (let i = 0; i < nodes.length; i++) {
                    const node = nodes[i];
                    if (node.id === parentId && node.children) {
                        const childIndex = node.children.findIndex(child => child.id === id);
                        if (childIndex !== -1) {
                            node.children.splice(childIndex, 1);
                            return true;
                        }
                    }
                    
                    if (node.children && node.children.length > 0) {
                        if (findParentAndRemoveChild(node.children, id)) {
                            return true;
                        }
                    }
                }
                return false;
            };
            
            const deleted = findParentAndRemoveChild(APP_STATE.assessmentTree, nodeId);
            
            // Eƒüer alt d√ºƒü√ºm silindiyse, √ºst d√ºƒü√ºm√ºn ID'lerini yeniden sƒ±rala
            if (deleted) {
                const parentNode = findNodeById(parentId);
                if (parentNode) {
                    reorderChildNodeIds(parentNode);
                }
                
                // Deƒüerlendirme sekmesini g√ºncelle - CRITICAL SYNC  
                updateAssessmentView();
                
                // D√úZELTME: Silinen soru i√ßin grup haritalamalarƒ±nƒ± temizle
                // √ñNEMLƒ∞: ID yeniden sƒ±ralama sonrasƒ± grup temizliƒüi yap
                cleanupGroupMappingsForDeletedNode(nodeId);
            }
            
            return deleted;
        }
        
        return false;
        
    } catch (error) {
        console.error(`D√ºƒü√ºm ${nodeId} silinirken hata:`, error);
        return false;
    }
}

/**
 * D√ºƒü√ºm silme - ID'ye g√∂re silme yapan versiyon
 * @param {string} nodeId - Silinecek d√ºƒü√ºm ID'si
 * @param {boolean} skipConfirmation - Onay modalƒ±nƒ± atla (varsayƒ±lan: false)
 */
function deleteNode(nodeId, skipConfirmation = false) {
    console.log("üü¢ [DEBUG] deleteNode() fonksiyonu √ßaƒürƒ±ldƒ±, nodeId:", nodeId, "skipConfirmation:", skipConfirmation);
    
    if (!nodeId) {
        console.log("üü¢ [DEBUG] NodeId bo≈ü, i≈ülem durduruldu");
        return;
    }
    
    // Silme onayƒ± iste
    const node = findNodeById(nodeId);
    if (!node) {
        console.log("üü¢ [DEBUG] D√ºƒü√ºm bulunamadƒ±:", nodeId);
        return;
    }
    
    console.log("üü¢ [DEBUG] Silinecek d√ºƒü√ºm bulundu:", node);
    
    // Eƒüer onay atlama yapƒ±lmadƒ±ysa, √∂ƒürenci notlarƒ± kontrol√º yap
    if (!skipConfirmation) {
        const hasGrades = checkIfNodeHasGrades && checkIfNodeHasGrades(nodeId);
        console.log("üü¢ [DEBUG] √ñƒürenci notlarƒ± var mƒ±?", hasGrades);
        
        if (hasGrades) {
            console.log("üü¢ [DEBUG] Notlƒ± soru/rubrik i√ßin √∂zel modal g√∂steriliyor...");
            // Notlƒ± soru/rubrik i√ßin √∂zel onay
            showModernConfirm(
                "‚ö†Ô∏è Dƒ∞KKAT! Notlƒ± Soru/Rubrik Silme",
                "Bu soru/rubrik i√ßin √∂ƒürenci notlarƒ± girilmi≈ü.\n\nSilme i≈ülemi yapƒ±lƒ±rsa:\n‚Ä¢ Bu soruya ait notlar kalƒ±cƒ± olarak silinecek\n‚Ä¢ Diƒüer sorularƒ±n notlarƒ± korunacak\n‚Ä¢ ID'ler yeniden d√ºzenlenecek\n\nDevam etmek istediƒüinizden emin misiniz?",
                {
                    confirmText: 'Evet, Sil',
                    cancelText: 'ƒ∞ptal',
                    headerClass: 'danger-action',
                    iconClass: 'danger'
                }
            ).then(confirmed => {
                console.log("üü¢ [DEBUG] Notlƒ± silme modalƒ± cevabƒ±:", confirmed);
                if (confirmed) {
                    console.log("üü¢ [DEBUG] Notlƒ± silme modalƒ± onaylandƒ±, skipConfirmation=true ile tekrar √ßaƒürƒ±lƒ±yor...");
                    // Onay alƒ±ndƒ±ƒüƒ± i√ßin skipConfirmation=true ile tekrar √ßaƒüƒ±r
                    deleteNode(nodeId, true);
                } else {
                    console.log("üü¢ [DEBUG] Kullanƒ±cƒ± notlƒ± silme i≈ülemini iptal etti");
                }
            }).catch(error => {
                console.error("üü¢ [DEBUG] Notlƒ± silme modalƒ± hata verdi:", error);
            });
            return;
        }
    }
    
    // Silme i≈ülemi fonksiyonu
    const performDeletion = function() {
        console.log("üü¢ [DEBUG] CALLBACK: Silme onayƒ± verildi, silme i≈ülemi ba≈ülƒ±yor...");
        console.log("üü¢ [DEBUG] CALLBACK: Silinecek nodeId:", nodeId);
        
        try {
            // Se√ßili d√ºƒü√ºm siliniyorsa se√ßimi kaldƒ±r
            if (APP_STATE.selectedNode && APP_STATE.selectedNode.id === nodeId) {
                APP_STATE.selectedNode = null;
                console.log("üü¢ [DEBUG] CALLBACK: Se√ßili d√ºƒü√ºm temizlendi");
            }
            
            // K√∂k d√ºƒü√ºm m√º kontrol et
            const isRoot = !nodeId.includes('.');
            console.log("üü¢ [DEBUG] CALLBACK: K√∂k d√ºƒü√ºm m√º?", isRoot);
            
            let deletionSuccessful = false;
            let parentNode = null;
            
            if (isRoot) {
                console.log("üü¢ [DEBUG] CALLBACK: K√∂k d√ºƒü√ºm silme i≈ülemi ba≈ülƒ±yor...");
                // K√∂k d√ºƒü√ºm√º sil
                const index = APP_STATE.assessmentTree.findIndex(node => node.id === nodeId);
                console.log("üü¢ [DEBUG] CALLBACK: K√∂k d√ºƒü√ºm indeksi:", index);
                
                if (index !== -1) {
                    APP_STATE.assessmentTree.splice(index, 1);
                    deletionSuccessful = true;
                    console.log("üü¢ [DEBUG] CALLBACK: K√∂k d√ºƒü√ºm ba≈üarƒ±yla silindi");
                } else {
                    console.log("üü¢ [DEBUG] CALLBACK: HATA: K√∂k d√ºƒü√ºm bulunamadƒ±!");
                }
            } else {
                console.log("üü¢ [DEBUG] CALLBACK: Alt d√ºƒü√ºm silme i≈ülemi ba≈ülƒ±yor...");
                // Alt d√ºƒü√ºm√º sil
                const parentId = nodeId.substring(0, nodeId.lastIndexOf('.'));
                console.log("üü¢ [DEBUG] CALLBACK: Parent ID:", parentId);
                
                const findParentAndRemoveChild = (nodes, id) => {
                    for (let i = 0; i < nodes.length; i++) {
                        const node = nodes[i];
                        if (node.id === parentId && node.children) {
                            const childIndex = node.children.findIndex(child => child.id === id);
                            if (childIndex !== -1) {
                                console.log("üü¢ [DEBUG] CALLBACK: Alt d√ºƒü√ºm bulundu, siliniyor. Child index:", childIndex);
                                node.children.splice(childIndex, 1);
                                return true;
                            }
                        }
                        
                        if (node.children && node.children.length > 0) {
                            if (findParentAndRemoveChild(node.children, id)) {
                                return true;
                            }
                        }
                    }
                    return false;
                };
                
                const deleted = findParentAndRemoveChild(APP_STATE.assessmentTree, nodeId);
                console.log("üü¢ [DEBUG] CALLBACK: Alt d√ºƒü√ºm silme sonucu:", deleted);
                
                if (deleted) {
                    deletionSuccessful = true;
                    parentNode = findNodeById(parentId);
                    console.log("üü¢ [DEBUG] CALLBACK: Parent d√ºƒü√ºm bulundu:", parentNode);
                } else {
                    console.log("üü¢ [DEBUG] CALLBACK: HATA: Alt d√ºƒü√ºm silinemedi!");
                }
            }
            
            if (deletionSuccessful) {
                console.log("üü¢ [DEBUG] CALLBACK: Silme ba≈üarƒ±lƒ±! Post-processing ba≈ülƒ±yor...");
                
                console.log("üü¢ [DEBUG] CALLBACK: Grup haritalamalarƒ±nƒ± temizleme ba≈ülƒ±yor...");
                // D√úZELTME: √ñnce grup haritalamalarƒ±nƒ± temizle (ID deƒüi≈ümeden √∂nce)
                cleanupGroupMappingsForDeletedNode(nodeId);
                console.log("üü¢ [DEBUG] CALLBACK: Grup haritalamalarƒ±nƒ± temizleme tamamlandƒ±");
                
                // YENƒ∞ KOD: Eƒüer bir alt d√ºƒü√ºm silindiyse, √ºst d√ºƒü√ºm√ºn aƒüƒ±rlƒ±klarƒ±nƒ± kontrol et
                if (!isRoot && parentNode) {
                    console.log("üü¢ [DEBUG] CALLBACK: Alt d√ºƒü√ºm silindi, ID yeniden sƒ±ralama ve puan daƒüƒ±tƒ±mƒ± kontrolleri ba≈ülƒ±yor...");
                    
                    console.log("üü¢ [DEBUG] CALLBACK: ID yeniden sƒ±ralama ba≈ülƒ±yor...");
                    // ID'leri yeniden sƒ±rala
                    reorderChildNodeIds(parentNode);
                    console.log("üü¢ [DEBUG] CALLBACK: ID yeniden sƒ±ralama tamamlandƒ±");
                    
                    console.log("üü¢ [DEBUG] CALLBACK: Puan daƒüƒ±tƒ±m kontrol√º ba≈ülƒ±yor...");
                    checkAndOfferRedistribution(parentNode);
                    console.log("üü¢ [DEBUG] CALLBACK: Puan daƒüƒ±tƒ±m kontrol√º tamamlandƒ±");
                }
                
                console.log("üü¢ [DEBUG] CALLBACK: Aƒüacƒ± yeniden render etme ba≈ülƒ±yor...");
                // Aƒüacƒ± yeniden render et
                renderTree();
                console.log("üü¢ [DEBUG] CALLBACK: Aƒüacƒ± yeniden render etme tamamlandƒ±");
                
                console.log("üü¢ [DEBUG] CALLBACK: Deƒüerlendirme sekmesini g√ºncelleme ba≈ülƒ±yor...");
                // Deƒüerlendirme sekmesini g√ºncelle
                console.log('üîÑ Soru silindi, deƒüerlendirme sekmesi g√ºncelleniyor...');
                updateAssessmentView();
                console.log('‚úÖ Deƒüerlendirme sekmesi g√ºncelleme tamamlandƒ±');
                console.log("üü¢ [DEBUG] CALLBACK: Deƒüerlendirme sekmesini g√ºncelleme tamamlandƒ±");
                
                console.log("üü¢ [DEBUG] CALLBACK: √ñƒürenci grup bilgilerini g√ºncelleme ba≈ülƒ±yor...");
                // √ñƒürenci grup bilgilerini g√ºncelle
                updateStudentGroupInfoDisplay();
                console.log("üü¢ [DEBUG] CALLBACK: √ñƒürenci grup bilgilerini g√ºncelleme tamamlandƒ±");
                
                console.log("üü¢ [DEBUG] CALLBACK: Ba≈üarƒ± mesajƒ± g√∂steriliyor...");
                showModernToast("Etkinlik ba≈üarƒ±yla silindi.");
                console.log("üü¢ [DEBUG] CALLBACK: deleteNode i≈ülemi ba≈üarƒ±yla tamamlandƒ±!");
            } else {
                console.log("üü¢ [DEBUG] CALLBACK: HATA: Silme i≈ülemi ba≈üarƒ±sƒ±z!");
                showModernToast("Etkinlik silinemedi!", "error");
            }
            
        } catch (error) {
            console.error("üü¢ [DEBUG] CALLBACK: D√ºƒü√ºm silinirken hata olu≈ütu:", error);
            console.error("üü¢ [DEBUG] CALLBACK: Hata stack trace:", error.stack);
            showModernToast("Etkinlik silinemedi!", "error");
        }
    };
    
    // Onay modalƒ±nƒ± atla veya g√∂ster
    if (skipConfirmation) {
        console.log("üü¢ [DEBUG] Onay modalƒ± atlanƒ±yor, direkt silme i≈ülemi yapƒ±lƒ±yor...");
        performDeletion();
    } else {
        console.log("üü¢ [DEBUG] showDeleteConfirmModal √ßaƒürƒ±lƒ±yor...");
        
        // Modern silme onay modalƒ±nƒ± g√∂ster
        showDeleteConfirmModal(
            // Onay verildiƒüinde √ßalƒ±≈üacak fonksiyon
            performDeletion,
            // Silme onay mesajƒ±
            `"${node.name}" etkinliƒüini ve t√ºm alt √∂ƒüelerini silmek istediƒüinizden emin misiniz?`
        );
        
        console.log("üü¢ [DEBUG] showDeleteConfirmModal √ßaƒürƒ±sƒ± tamamlandƒ±");
    }
}

/**
 * Alt d√ºƒü√ºmlerin ID'lerini yeniden sƒ±ralar
 * √ñrnek: A1.3 silinirse A1.4 -> A1.3, A1.5 -> A1.4 olur
 * @param {Object} parentNode - Ana d√ºƒü√ºm
 */
function reorderChildNodeIds(parentNode) {
    if (!parentNode || !parentNode.children || parentNode.children.length === 0) {
        return;
    }
    
    console.log(`üîÑ ID yeniden sƒ±ralama ba≈ülƒ±yor: ${parentNode.id}`);
    
    // Eski ID -> Yeni ID mapping'i olu≈ütur
    const idMapping = {};
    
    // Alt d√ºƒü√ºmleri yeniden numaralandƒ±r
    parentNode.children.forEach((child, index) => {
        const oldId = child.id;
        const newId = `${parentNode.id}.${index + 1}`;
        
        if (oldId !== newId) {
            console.log(`üìù ID deƒüi≈üikliƒüi: ${oldId} -> ${newId}`);
            
            // ID mapping'e ekle
            idMapping[oldId] = newId;
            
            // Node'un ID'sini g√ºncelle
            child.id = newId;
            
            // Eƒüer bu node'un da √ßocuklarƒ± varsa, onlarƒ± da g√ºncelle
            if (child.children && child.children.length > 0) {
                updateChildrenIds(child.children, oldId, newId);
            }
        }
    });
    
    // Eƒüer ID deƒüi≈üiklikleri varsa, puan verilerini de g√ºncelle
    if (Object.keys(idMapping).length > 0) {
        updateGradeDataWithNewIds(idMapping);
        
        // D√úZELTME: Grup haritalamalarƒ±ndaki ID'leri de g√ºncelle
        updateGroupMappingsWithNewIds(parentNode.id, idMapping);
        
        console.log(`‚úÖ ${Object.keys(idMapping).length} ID g√ºncellendi ve puan verileri ta≈üƒ±ndƒ±`);
    }
}

/**
 * Alt d√ºƒü√ºmlerin ID'lerini recursive olarak g√ºnceller
 * @param {Array} children - Alt d√ºƒü√ºmler
 * @param {string} oldParentId - Eski parent ID
 * @param {string} newParentId - Yeni parent ID
 */
function updateChildrenIds(children, oldParentId, newParentId) {
    children.forEach(child => {
        const oldId = child.id;
        const newId = oldId.replace(oldParentId, newParentId);
        child.id = newId;
        
        if (child.children && child.children.length > 0) {
            updateChildrenIds(child.children, oldId, newId);
        }
    });
}

/**
 * Puan verilerini yeni ID'ler ile g√ºnceller
 * @param {Object} idMapping - Eski ID -> Yeni ID mapping'i
 */
function updateGradeDataWithNewIds(idMapping) {
    if (!APP_STATE.gradesData) return;
    
    console.log('üìä Puan verileri ID mapping ile g√ºncelleniyor...');
    
    // Her √∂ƒürenci i√ßin puan verilerini g√ºncelle
    Object.keys(APP_STATE.gradesData).forEach(studentId => {
        const studentGrades = APP_STATE.gradesData[studentId];
        
        // ID mapping'deki her deƒüi≈üiklik i√ßin
        Object.keys(idMapping).forEach(oldId => {
            const newId = idMapping[oldId];
            
            // Doƒürudan ID e≈üle≈ümesi
            if (studentGrades[oldId] !== undefined) {
                studentGrades[newId] = studentGrades[oldId];
                delete studentGrades[oldId];
                console.log(`  üìù ${studentId}: ${oldId} -> ${newId} puanƒ± ta≈üƒ±ndƒ±`);
            }
            
            // Parent ID bazlƒ± e≈üle≈üme (A1.1 -> A1[1] formatƒ±)
            const oldParentId = oldId.substring(0, oldId.lastIndexOf('.'));
            const newParentId = newId.substring(0, newId.lastIndexOf('.'));
            
            if (studentGrades[oldParentId] && typeof studentGrades[oldParentId] === 'object') {
                // Tam ID ile e≈üle≈üme
                if (studentGrades[oldParentId][oldId] !== undefined) {
                    if (!studentGrades[newParentId]) studentGrades[newParentId] = {};
                    studentGrades[newParentId][newId] = studentGrades[oldParentId][oldId];
                    delete studentGrades[oldParentId][oldId];
                    console.log(`  üìù ${studentId}: ${oldParentId}[${oldId}] -> ${newParentId}[${newId}] puanƒ± ta≈üƒ±ndƒ±`);
                }
                
                // Kƒ±sa ID ile e≈üle≈üme (A1.1 -> 1)
                const oldShortId = oldId.split('.').pop();
                const newShortId = newId.split('.').pop();
                
                if (studentGrades[oldParentId][oldShortId] !== undefined && oldShortId !== newShortId) {
                    if (!studentGrades[newParentId]) studentGrades[newParentId] = {};
                    studentGrades[newParentId][newShortId] = studentGrades[oldParentId][oldShortId];
                    delete studentGrades[oldParentId][oldShortId];
                    console.log(`  üìù ${studentId}: ${oldParentId}[${oldShortId}] -> ${newParentId}[${newShortId}] puanƒ± ta≈üƒ±ndƒ±`);
                }
            }
        });
    });
}

// GUID sistemi kaldƒ±rƒ±ldƒ± - findNodeByGuid fonksiyonu temizlendi

/**
 * √ñƒürenme √ßƒ±ktƒ±larƒ±nƒ± listele
 */
function renderOutcomes() {
    try {
        console.log('renderOutcomes √ßaƒürƒ±ldƒ±, APP_STATE.learningOutcomes:', APP_STATE.learningOutcomes);
        outcomesList.innerHTML = '';
        
        if (!APP_STATE.learningOutcomes || APP_STATE.learningOutcomes.length === 0) {
            console.log('√ñ√á verisi bo≈ü veya yok');
            const emptyMessage = document.createElement('div');
            emptyMessage.className = 'outcomes-empty-message';
            emptyMessage.textContent = 'Hen√ºz √∂ƒürenme √ßƒ±ktƒ±sƒ± tanƒ±mlanmadƒ±. Ders JSON y√ºkleyin.';
            outcomesList.appendChild(emptyMessage);
            return;
        }
        
        APP_STATE.learningOutcomes.forEach(outcome => {
            const item = document.createElement('div');
            item.className = 'outcome-item';
            item.textContent = `${outcome.id}: ${outcome.aciklama}`;
            item.title = outcome.aciklama;
            item.dataset.id = outcome.id;
            
            // √áƒ±ktƒ±ya tƒ±klayarak deƒüerlendirme aƒüacƒ±nda se√ßili d√ºƒü√ºme ekleme
            item.addEventListener('click', () => {
                if (APP_STATE.selectedNode) {
                    const outcomesInput = document.querySelector(`.tree-node[data-id="${APP_STATE.selectedNode.id}"] .nodeOutcomes`);
                    if (outcomesInput) {
                        const currentValue = outcomesInput.value.trim();
                        
                        // Alt d√ºƒü√ºm ise (soru veya rubrik), sadece bir √ñ√á atanabilsin
                        const isSubItem = APP_STATE.selectedNode.id.includes('.');
                        
                        if (isSubItem) {
                            outcomesInput.value = outcome.id;
                        } else {
                            // Deƒüer bo≈üsa veya virg√ºlle bitiyorsa
                            if (!currentValue) {
                                outcomesInput.value = outcome.id;
                            } else if (currentValue.endsWith(',')) {
                                outcomesInput.value = currentValue + ' ' + outcome.id;
                            } else {
                                outcomesInput.value = currentValue + ', ' + outcome.id;
                            }
                        }
                        
                        // Deƒüeri deƒüi≈ümi≈ü gibi tetikle
                        outcomesInput.dispatchEvent(new Event('change'));
                        
                        showModernToast(`"${outcome.id}" √∂ƒürenme √ßƒ±ktƒ±sƒ± eklendi.`);
                    }
                } else {
                    showModernToast("L√ºtfen √∂nce bir etkinlik se√ßin.", "warning");
                }
            });
            
            outcomesList.appendChild(item);
        });
        
        // ƒ∞√ßerik deƒüi≈ütikten sonra collapsible y√ºksekliklerini g√ºncelle
        setTimeout(() => {
            initializeCollapsibleSections();
        }, 100);
    } catch (error) {
        console.error("√ñƒürenme √ßƒ±ktƒ±larƒ± render edilirken hata olu≈ütu:", error);
        showModernToast("√ñƒürenme √ßƒ±ktƒ±larƒ± y√ºklenirken hata olu≈ütu!", "error");
    }
}

/**
 * Program √ßƒ±ktƒ±larƒ±nƒ± render etme
 */
function renderProgramOutcomes() {
    try {
        programOutcomesList.innerHTML = '';
        
        if (!APP_STATE.programOutcomes || APP_STATE.programOutcomes.length === 0) {
            const emptyMessage = document.createElement('div');
            emptyMessage.className = 'outcomes-empty-message';
            emptyMessage.textContent = 'Hen√ºz program √ßƒ±ktƒ±sƒ± tanƒ±mlanmadƒ±. Ders JSON y√ºkleyin.';
            programOutcomesList.appendChild(emptyMessage);
            return;
        }
        
        APP_STATE.programOutcomes.forEach(programOutcome => {
            const item = document.createElement('div');
            item.className = 'outcome-item program-outcome-item';
            
            // Program √ßƒ±ktƒ±sƒ± i√ßeriƒüini olu≈ütur
            const header = document.createElement('div');
            header.className = 'program-outcome-header';
            header.innerHTML = `
                <span class="program-outcome-id">${programOutcome.id}</span>
                <span class="program-outcome-category">${programOutcome.kategori}</span>
            `;
            
            const description = document.createElement('div');
            description.className = 'program-outcome-description';
            description.textContent = programOutcome.aciklama;
            
            item.appendChild(header);
            item.appendChild(description);
            item.title = `${programOutcome.id} - ${programOutcome.kategori}: ${programOutcome.aciklama}`;
            item.dataset.id = programOutcome.id;
            
            programOutcomesList.appendChild(item);
        });
        
        // ƒ∞√ßerik deƒüi≈ütikten sonra collapsible y√ºksekliklerini g√ºncelle
        setTimeout(() => {
            initializeCollapsibleSections();
        }, 100);
    } catch (error) {
        console.error("Program √ßƒ±ktƒ±larƒ± render edilirken hata olu≈ütu:", error);
        showModernToast("Program √ßƒ±ktƒ±larƒ± y√ºklenirken hata olu≈ütu!", "error");
    }
}

/**
 * Ders detaylarƒ±nƒ± render etme
 */
function renderCourseDetails() {
    try {
        console.log('renderCourseDetails √ßaƒürƒ±ldƒ±');
        console.log('APP_STATE.courseData:', APP_STATE.courseData);
        console.log('courseDetailsContainer:', courseDetailsContainer);
        
        if (!APP_STATE.courseData) {
            console.log('courseData yok - bo≈ü mesaj g√∂steriliyor');
            courseDetailsContainer.innerHTML = '<div class="details-empty-message">Ders detaylarƒ± i√ßin JSON y√ºkleyin.</div>';
            return;
        }

        const { dersBilgisi, dersGenel, dersIcerik, haftalikDersIcerikleri } = APP_STATE.courseData;
        
        console.log('Veri parse ediliyor:');
        console.log('dersBilgisi:', dersBilgisi);
        console.log('dersGenel:', dersGenel);
        console.log('dersIcerik:', dersIcerik);
        console.log('haftalikDersIcerikleri:', haftalikDersIcerikleri);
        
        let html = '';
        
        // Ders Bilgisi (Yeni)
        if (dersBilgisi) {
            html += `
                <div class="details-section">
                    <h4 class="details-section-title">
                        <span class="section-icon">üìö</span>
                        Ders Bilgisi
                    </h4>
                    <div class="details-grid">
                        <div class="detail-item">
                            <span class="detail-label">Ders Kodu:</span>
                            <span class="detail-value">${dersBilgisi.dersKodu || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Ders Adƒ±:</span>
                            <span class="detail-value">${dersBilgisi.dersAdi || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Akademik Yƒ±l:</span>
                            <span class="detail-value">${dersBilgisi.akademikYil || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">D√∂nem:</span>
                            <span class="detail-value">${dersBilgisi.donem || '-'}</span>
                        </div>
                        <div class="detail-item full-width">
                            <span class="detail-label">√ñƒüretim √úyesi:</span>
                            <span class="detail-value">${dersBilgisi.ogretimUyesi || '-'}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Genel Bilgiler
        if (dersGenel) {
            html += `
                <div class="details-section">
                    <h4 class="details-section-title">
                        <span class="section-icon">üìö</span>
                        Genel Bilgiler
                    </h4>
                    <div class="details-grid">
                        <div class="detail-item">
                            <span class="detail-label">Ders Kodu:</span>
                            <span class="detail-value">${dersGenel.dersKodu || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Ders Adƒ±:</span>
                            <span class="detail-value">${dersGenel.dersAdi || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Ders T√ºr√º:</span>
                            <span class="detail-value">${dersGenel.dersTuru || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Seviye:</span>
                            <span class="detail-value">${dersGenel.dersinSeviyesi || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Yarƒ±yƒ±l:</span>
                            <span class="detail-value">${dersGenel.dersinVerildigiYariyil || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Akademik Yƒ±l:</span>
                            <span class="detail-value">${dersGenel.akademikYil || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Kredi:</span>
                            <span class="detail-value">${dersGenel.dersKredisi || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">AKTS:</span>
                            <span class="detail-value">${dersGenel.dersAKTSKredisi || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Kuramsal Saat:</span>
                            <span class="detail-value">${dersGenel.haftalikDersSaatiKuramsal || 0}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Uygulama Saat:</span>
                            <span class="detail-value">${dersGenel.haftalikUygulamaSaati || 0}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Laboratuvar Saat:</span>
                            <span class="detail-value">${dersGenel.haftalikLaboratuarSaati || 0}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Eƒüitim Dili:</span>
                            <span class="detail-value">${dersGenel.egitimDili || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">√úniversite:</span>
                            <span class="detail-value">${dersGenel.universite || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Fak√ºlte:</span>
                            <span class="detail-value">${dersGenel.fakulte || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">B√∂l√ºm:</span>
                            <span class="detail-value">${dersGenel.bolum || '-'}</span>
                        </div>
                        <div class="detail-item full-width">
                            <span class="detail-label">M√ºfredat Yƒ±lƒ±:</span>
                            <span class="detail-value">${dersGenel.mufredatOlusturulmaYili || '-'}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Ders ƒ∞√ßeriƒüi
        if (dersIcerik) {
            html += `
                <div class="details-section">
                    <h4 class="details-section-title">
                        <span class="section-icon">üìñ</span>
                        Ders ƒ∞√ßeriƒüi ve Detaylarƒ±
                    </h4>
                    <div class="content-details">
                        <div class="content-item">
                            <h5>üìã Dersin Amacƒ±</h5>
                            <p>${dersIcerik.dersinAmaci || '-'}</p>
                        </div>
                        <div class="content-item">
                            <h5>üìö Dersin ƒ∞√ßeriƒüi</h5>
                            <p>${dersIcerik.dersinIcerigi || '-'}</p>
                        </div>
                        <div class="content-item">
                            <h5>‚ö†Ô∏è √ñn Ko≈üul Dersler</h5>
                            <p>${dersIcerik.dersinOnKosuluOlanDersler || '-'}</p>
                        </div>
                        <div class="content-item">
                            <h5>üí° √ñnerilen Hususlar</h5>
                            <p>${dersIcerik.dersinIcinOnerilenHususlar || '-'}</p>
                        </div>
                        <div class="content-item">
                            <h5>üìö Kaynaklar ve Materyaller</h5>
                            <pre class="sources-text">${dersIcerik.dersinKitabiMalzemesiOnerilenKaynaklar || '-'}</pre>
                        </div>
                        <div class="instructor-info">
                            <h5>üë®‚Äçüè´ √ñƒüretim √úyesi Bilgileri</h5>
                            <div class="instructor-details">
                                <p><strong>Ad:</strong> ${dersIcerik.dersiVerenOgretimUyesiOgretimGorevlisi || '-'}</p>
                                <p><strong>E-mail:</strong> ${dersIcerik.email || '-'}</p>
                                <p><strong>Avesis:</strong> <a href="${dersIcerik.avesisProfile || '#'}" target="_blank">${dersIcerik.avesisProfile || '-'}</a></p>
                                <p><strong>Hazƒ±rlama Tarihi:</strong> ${dersIcerik.hazirlanmaTarihi || '-'}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Haftalƒ±k Ders ƒ∞√ßerikleri
        if (haftalikDersIcerikleri && haftalikDersIcerikleri.length > 0) {
            html += `
                <div class="details-section">
                    <h4 class="details-section-title">
                        <span class="section-icon">üìÖ</span>
                        Haftalƒ±k Ders ƒ∞√ßerikleri (${haftalikDersIcerikleri.length} Hafta)
                    </h4>
                    <div class="weekly-content">
                        ${haftalikDersIcerikleri.map(hafta => `
                            <div class="week-item ${hafta.hafta === 8 || hafta.hafta === 16 ? 'exam-week' : ''}">
                                <div class="week-header">
                                    <span class="week-number">Hafta ${hafta.hafta}</span>
                                    <span class="week-outcomes">${hafta.iliskiliOgrenme√áiktisi || '-'}</span>
                                </div>
                                <div class="week-content">
                                    <p class="week-description">${hafta.icerik || '-'}</p>
                                    <div class="week-details">
                                        <div class="week-detail">
                                            <strong>üèõÔ∏è Ortam:</strong> ${hafta.ogretimOrtami || '-'}
                                        </div>
                                        <div class="week-detail">
                                            <strong>üìö √ñn Hazƒ±rlƒ±k:</strong> ${hafta.onHazirlik || '-'}
                                        </div>
                                        <div class="week-detail">
                                            <strong>üéØ Y√∂ntem:</strong> ${hafta.ogretimYontemleri || '-'}
                                        </div>
                                        ${hafta.odevVeCalisma && hafta.odevVeCalisma !== '-' ? `
                                            <div class="week-detail">
                                                <strong>üìù √ñdev/√áalƒ±≈üma:</strong> ${hafta.odevVeCalisma}
                                            </div>
                                        ` : ''}
                                        ${hafta.degerlendirmeYontemleri && hafta.degerlendirmeYontemleri !== '-' ? `
                                            <div class="week-detail evaluation">
                                                <strong>üìä Deƒüerlendirme:</strong> ${hafta.degerlendirmeYontemleri}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        console.log('HTML i√ßeriƒüi olu≈üturuldu, uzunluk:', html.length);
        console.log('HTML ilk 300 karakter:', html.substring(0, 300));
        
        courseDetailsContainer.innerHTML = html;
        
        console.log('HTML container\'a eklendi, ≈üu anki i√ßerik:', courseDetailsContainer.innerHTML.substring(0, 100));
        
        // ƒ∞√ßerik deƒüi≈ütikten sonra collapsible y√ºksekliklerini g√ºncelle
        setTimeout(() => {
            initializeCollapsibleSections();
        }, 100);
        
    } catch (error) {
        console.error("Ders detaylarƒ± render edilirken hata olu≈ütu:", error);
        showModernToast("Ders detaylarƒ± y√ºklenirken hata olu≈ütu!", "error");
    }
}

/**
 * √ñ√á-P√á ƒ∞li≈üki Matrisini render etme - Yeni basit versiyon
 */
function renderOutcomeMatrix() {
    try {
        if (!APP_STATE.outcomeMatrix || !APP_STATE.learningOutcomes || !APP_STATE.programOutcomes) {
            matrixContainer.innerHTML = '<div class="matrix-empty-message">√ñ√á-P√á ili≈üki matrisi i√ßin ders JSON y√ºkleyin.</div>';
            return;
        }

        // Legend olu≈ütur
        const legend = document.createElement('div');
        legend.className = 'matrix-legend';
        legend.innerHTML = `
            <h4>ƒ∞li≈üki Seviyesi</h4>
            <div class="legend-items">
                <span class="legend-item"><span class="legend-color level-0"></span>0 - ƒ∞li≈üki Yok</span>
                <span class="legend-item"><span class="legend-color level-1"></span>1 - √áok Zayƒ±f</span>
                <span class="legend-item"><span class="legend-color level-2"></span>2 - Zayƒ±f</span>
                <span class="legend-item"><span class="legend-color level-3"></span>3 - Orta</span>
                <span class="legend-item"><span class="legend-color level-4"></span>4 - G√º√ßl√º</span>
                <span class="legend-item"><span class="legend-color level-5"></span>5 - √áok G√º√ßl√º</span>
            </div>
        `;

        // Matrix tablosu olu≈ütur
        const table = document.createElement('table');
        table.className = 'matrix-table';
        
        // Header row
        let headerHTML = '<thead><tr><th class="matrix-corner">√ñ√á / P√á</th>';
        APP_STATE.programOutcomes.forEach(pc => {
            headerHTML += `<th class="matrix-header" title="${pc.aciklama}">${pc.id}</th>`;
        });
        headerHTML += '</tr></thead>';
        
        // Body rows
        let bodyHTML = '<tbody>';
        APP_STATE.outcomeMatrix.iliskiTablosu.forEach(relation => {
            const learningOutcome = APP_STATE.learningOutcomes.find(lo => lo.id === relation.ogrenme√áiktisiID);
            bodyHTML += `<tr>`;
            bodyHTML += `<th class="matrix-row-header" title="${learningOutcome ? learningOutcome.aciklama : ''}">${relation.ogrenme√áiktisiID}</th>`;
            
            APP_STATE.programOutcomes.forEach(pc => {
                const value = relation.program√áiktilariIliskileri[pc.id] || 0;
                bodyHTML += `<td class="matrix-cell level-${value}" data-level="${value}">${value}</td>`;
            });
            
            bodyHTML += `</tr>`;
        });
        bodyHTML += '</tbody>';
        
        table.innerHTML = headerHTML + bodyHTML;
        
        // Container'ƒ± temizle ve yeni i√ßerikleri ekle
        matrixContainer.innerHTML = '';
        matrixContainer.appendChild(legend);
        matrixContainer.appendChild(table);
        
        // ƒ∞√ßerik deƒüi≈ütikten sonra collapsible y√ºksekliklerini g√ºncelle
        setTimeout(() => {
            initializeCollapsibleSections();
        }, 100);
        
    } catch (error) {
        console.error("√ñ√á-P√á matrisi render edilirken hata olu≈ütu:", error);
        showModernToast("√ñ√á-P√á matrisi y√ºklenirken hata olu≈ütu!", "error");
    }
}

/**
 * Ders bilgilerini g√∂r√ºnt√ºleme
 */
function updateCourseInfo() {
    try {
        if (!APP_STATE.courseData) return;
        
        // Ders kodu ve adƒ±
        const dersKodu = APP_STATE.courseData.dersGenel?.dersKodu || '-';
        const dersAdi = APP_STATE.courseData.dersGenel?.dersAdi || '-';
        courseTitle.textContent = `${dersKodu} - ${dersAdi}`;
        
        // Akademik yƒ±l ve d√∂nem
        const akademikYil = APP_STATE.courseData.dersGenel?.akademikYil || '-';
        const donem = APP_STATE.courseData.dersGenel?.dersinVerildigiYariyil || '-';
        const ogretimUyesi = APP_STATE.courseData.dersIcerik?.dersiVerenOgretimUyesiOgretimGorevlisi || '-';
        
        courseDetails.textContent = `Akademik Yƒ±l: ${akademikYil} | Yarƒ±yƒ±l: ${donem} | √ñƒür. √úyesi: ${ogretimUyesi}`;
        
        // Tarih bilgisi ekle
        courseTerm.textContent = `${akademikYil} (${donem}. Yarƒ±yƒ±l)`;
        
        // Ders bilgileri ekranƒ±nƒ± vurgulamak i√ßin stil ekle
        document.getElementById('courseInfo').style.borderLeft = '5px solid var(--primary-color)';
        document.getElementById('courseInfo').style.backgroundColor = 'var(--secondary-light)';
    } catch (error) {
        console.error("Ders bilgileri g√ºncellenirken hata olu≈ütu:", error);
    }
}

// =====================================================
// NOT Gƒ∞Rƒ∞≈ûƒ∞ VE HESAPLAMA FONKSƒ∞YONLARI
// =====================================================

/**
 * Deƒüerlendirme g√∂r√ºn√ºm√ºn√º g√ºncelleme
 */
function updateAssessmentView() {
    console.log('üéØ updateAssessmentView √ßaƒürƒ±ldƒ± - mevcut aƒüa√ß:', APP_STATE.assessmentTree);
    
    // Filtrelenmi≈ü √∂ƒürenci listesini √∂nce al (scope i√ßin)
    let filteredStudents = [];
    
    try {
        // Konteyner kontrol√º
        if (!assessmentContainer) {
            console.error('‚ùå assessmentContainer bulunamadƒ±');
            return;
        }
        
        // Veri kontrol√º ve assessmentTree olu≈üturma
        if (!APP_STATE.assessmentTree?.length) {
            // Eƒüer assessmentTree bo≈üsa ama dersDegerlendirme verisi varsa, aƒüacƒ± olu≈ütur
            if (APP_STATE.courseData?.dersDegerlendirme) {
                console.log('üîß assessmentTree bo≈ü, dersDegerlendirme verilerinden olu≈üturuluyor...');
                createAssessmentTreeFromCourseData();
            }
        }
        
        if (!APP_STATE.assessmentTree?.length || !APP_STATE.studentData?.length) {
            assessmentContainer.innerHTML = `
                <p class="empty-message">Deƒüerlendirme giri≈üi yapabilmek i√ßin hem ders tanƒ±mlama hem de √∂ƒürenci listesi sekmelerinden gerekli bilgileri y√ºklemeniz gerekmektedir.</p>
            `;
            updateAssessmentFilterInfo();
            return;
        }
        
        // Orijinal √∂ƒürenci verilerini koru
        const originalStudentData = APP_STATE.studentData;
        
        try {
        // Filtrelenmi≈ü √∂ƒürenci listesini al
        filteredStudents = getFilteredAssessmentStudents();
        
        // Ge√ßici olarak APP_STATE.studentData'yƒ± deƒüi≈ütir
        APP_STATE.studentData = filteredStudents;
        
        // Deƒüerlendirme konteynerini temizle
        assessmentContainer.innerHTML = '';
        
            // Etkinlikleri kategorilere ayƒ±r
        let termActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('A'));
            let finalActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('F'));
            
            // Etkinlik filtresi varsa sadece se√ßilen etkinliƒüi g√∂ster
            if (ASSESSMENT_FILTER_SETTINGS.currentActivity) {
                const selectedActivity = ASSESSMENT_FILTER_SETTINGS.currentActivity;
                if (selectedActivity.startsWith('A')) {
                    termActivities = termActivities.filter(activity => activity.id === selectedActivity);
                    finalActivities = []; // Yarƒ±yƒ±l sonu etkinliklerini gizle
                } else if (selectedActivity.startsWith('F')) {
                    finalActivities = finalActivities.filter(activity => activity.id === selectedActivity);
                    termActivities = []; // Yarƒ±yƒ±l i√ßi etkinlikleri gizle
                }
            }
            
            // Yarƒ±yƒ±l i√ßi etkinlikleri render et
            if (termActivities.length > 0) {
                renderActivitySection(
                    'Yarƒ±yƒ±l ƒ∞√ßi Etkinlikler', 
                    APP_STATE.termWeight || 40, 
                    termActivities, 
                    'term'
                );
            }
            
            // Yarƒ±yƒ±l sonu etkinlikleri render et
        if (finalActivities.length > 0) {
                renderActivitySection(
                    'Yarƒ±yƒ±l Sonu Etkinlikler', 
                    APP_STATE.finalWeight || 60, 
                    finalActivities, 
                    'final'
                );
            }
            
            // Notlarƒ± hesaplama butonu ekle
            addCalculateGradesButton();
        
        // Filtre bilgisini g√ºncelle
        updateAssessmentFilterInfo();
        
        // Etkinlik filtresini g√ºncelle
        populateAssessmentActivityFilter();
        
        // √ñ√á tooltip sistemini ba≈ülat
        setTimeout(() => {
                if (typeof initializeOutcomeTooltips === 'function') {
            initializeOutcomeTooltips();
                }
        }, 100);
        
        } finally {
            // Her durumda orijinal √∂ƒürenci listesini geri y√ºkle
            APP_STATE.studentData = originalStudentData;
        }
        
        // Ek g√ºncellemeler - ders tanƒ±mlama deƒüi≈üikliklerini yansƒ±t (grup se√ßicileri hari√ß)
        setTimeout(() => {
            console.log('üîÑ Ders tanƒ±mlama deƒüi≈üiklikleri yansƒ±tƒ±lƒ±yor (grup se√ßicileri korunuyor)...');
            // Grup se√ßicilerini g√ºncelleme - HTML olu≈üturma sƒ±rasƒ±nda zaten doƒüru yapƒ±ldƒ±
            // updateGroupSelectors(); // Bu satƒ±rƒ± kaldƒ±rƒ±yoruz
            
            // Diƒüer bile≈üenleri g√ºncelle
            if (typeof updateOutcomesTextarea === 'function') {
                updateOutcomesTextarea();
            }
            
            if (typeof updateCategoryWeights === 'function') {
                updateCategoryWeights();
            }
            
            if (typeof updateAllMappingDisplays === 'function') {
                updateAllMappingDisplays();
            }
            
            if (typeof updateAllInlineGroupInputs === 'function') {
                updateAllInlineGroupInputs();
            }
            
            console.log('‚úÖ Ders tanƒ±mlama deƒüi≈üiklikleri yansƒ±tƒ±ldƒ± (grup se√ßicileri korundu)');
        }, 100);
        
        // D√úZELTME: Tablo olu≈üturulduktan sonra grup bazlƒ± maksimum puan g√∂sterimini d√ºzelt
        setTimeout(() => {
            console.log('üîÑ Grup bazlƒ± maksimum puan g√ºncelleme ba≈ülatƒ±lƒ±yor...');
            
            // T√ºm component'ler i√ßin g√ºncelleme yap
            const allComponents = document.querySelectorAll('[data-component-id]');
            const componentIds = new Set();
            
            allComponents.forEach(element => {
                const componentId = element.getAttribute('data-component-id');
                if (componentId) componentIds.add(componentId);
            });
            
            componentIds.forEach(componentId => {
                // Sadece filtrelenmi≈ü (g√∂r√ºnt√ºlenen) √∂ƒürenciler i√ßin g√ºncelle
                filteredStudents.forEach(student => {
                    const studentCurrentGroup = getStudentGroupForComponent(student.studentId, componentId);
                    // Her √∂ƒürenci i√ßin grup bazlƒ± soru bilgilerini g√ºncelle
                    updateQuestionInfoForComponent(student.studentId, studentCurrentGroup, componentId);
                });
            });
            
            console.log('‚úÖ Grup bazlƒ± maksimum puan g√ºncelleme tamamlandƒ±');
        }, 150);
        
        console.log('‚úÖ updateAssessmentView tamamlandƒ±');
        
        // Deƒüerlendirme kontrolleri ba≈ülat
        setTimeout(() => {
            initializeAssessmentControls();
            console.log('‚úÖ Deƒüerlendirme kolon kontrolleri ba≈ülatƒ±ldƒ±');
            
            // Otomatik daƒüƒ±tƒ±m butonlarƒ±nƒ± ayarla
            setupAutoDistributeButtons();
            
            // Butonlarƒ± tablolara ekle (eƒüer yoksa)
            addAutoDistributeButtonsToTables();
        }, 200);
        
    } catch (error) {
        console.error("‚ùå Deƒüerlendirme g√∂r√ºn√ºm√º g√ºncellenirken hata olu≈ütu:", error);
        showModernToast("Deƒüerlendirme g√∂r√ºn√ºm√º g√ºncellenemedi!", "error");
    }
}

/**
 * Etkinlik b√∂l√ºm√º render etme
 * @param {string} title - B√∂l√ºm ba≈ülƒ±ƒüƒ±
 * @param {number} weight - Aƒüƒ±rlƒ±k y√ºzdesi
 * @param {Array} activities - Etkinlikler listesi
 * @param {string} type - Etkinlik tipi ('term' veya 'final')
 */
function renderActivitySection(title, weight, activities, type) {
    const header = document.createElement('h3');
    header.textContent = `${title} (${weight}%)`;
    header.className = 'section-title';
    assessmentContainer.appendChild(header);
    
    activities.forEach(activity => {
        try {
            createAssessmentActivitySection(activity, assessmentContainer, type);
        } catch (error) {
            console.error(`‚ùå ${activity.id} etkinliƒüi render edilemedi:`, error);
        }
    });
}

/**
 * Notlarƒ± hesaplama butonu ekle
 */
function addCalculateGradesButton() {
        const calculateButton = document.createElement('button');
        calculateButton.className = 'btn btn-primary';
        calculateButton.style.marginTop = '20px';
        calculateButton.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M5 3a2 2 0 0 0-2 2v14c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2H5zm14 4h-6m-2 4h-2m-4 4h12"></path>
            </svg>
            Notlarƒ± Hesapla
        `;
        calculateButton.addEventListener('click', calculateGrades);
        assessmentContainer.appendChild(calculateButton);
}

/**
 * Deƒüerlendirme giri≈üi i√ßin filtrelenmi≈ü √∂ƒürenci listesini al
 */
function getFilteredStudentsForAssessment() {
    try {
    const filterSelect = document.getElementById('assessmentStudentFilter');
        
        // Filtre yoksa veya deƒüer se√ßilmemi≈üse t√ºm √∂ƒürenciler
    if (!filterSelect || !filterSelect.value) {
            return APP_STATE.studentData || [];
    }
    
    const selectedStudentId = filterSelect.value;
        
        // G√ºvenlik kontrol√º
        if (!APP_STATE.studentData || !Array.isArray(APP_STATE.studentData)) {
            console.warn('‚ö†Ô∏è √ñƒürenci verisi bulunamadƒ± veya ge√ßersiz');
            return [];
        }
        
        // Filtrelenmi≈ü √∂ƒürenciyi bul
        const filteredStudents = APP_STATE.studentData.filter(student => 
            student && student.studentId === selectedStudentId
        );
        
        if (filteredStudents.length === 0) {
            console.warn(`‚ö†Ô∏è ${selectedStudentId} ID'li √∂ƒürenci bulunamadƒ±`);
        }
        
        return filteredStudents;
        
    } catch (error) {
        console.error('‚ùå √ñƒürenci filtresi hatasƒ±:', error);
        return APP_STATE.studentData || [];
    }
}

/**
 * Deƒüerlendirme filtresi bilgisini g√ºncelle
 */
function updateAssessmentFilterInfo() {
    // Yeni filtreleme sistemi varsa onu kullan
    if (typeof updateAssessmentFilterStats === 'function') {
        updateAssessmentFilterStats();
        return;
    }
    
    // Eski sistem i√ßin geri uyumluluk
    try {
    const filterInfo = document.getElementById('assessmentFilterInfo');
    const filterSelect = document.getElementById('assessmentStudentFilter');
    
        if (!filterInfo) {
            console.warn('‚ö†Ô∏è assessmentFilterInfo elementi bulunamadƒ±');
            return;
        }
    
        const totalStudents = APP_STATE.studentData?.length || 0;
    const filteredStudents = getFilteredAssessmentStudents();
    const filteredCount = filteredStudents.length;
    
    if (!filterSelect || !filterSelect.value) {
        // Filtre yok - t√ºm √∂ƒürenciler g√∂steriliyor
        filterInfo.innerHTML = `
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="8.5" cy="7" r="4"></circle>
                <line x1="20" y1="8" x2="20" y2="14"></line>
                <line x1="23" y1="11" x2="17" y2="11"></line>
            </svg>
            Toplam ${totalStudents} √∂ƒürenci g√∂steriliyor
        `;
        filterInfo.className = 'filter-info';
    } else {
        // Filtre aktif - se√ßili √∂ƒürenci g√∂steriliyor
        const selectedStudent = filteredStudents[0];
            
            if (selectedStudent) {
        filterInfo.innerHTML = `
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
                    ${selectedStudent.studentId} - ${selectedStudent.name} ${selectedStudent.surname}
        `;
        filterInfo.className = 'filter-info filtered';
            } else {
                filterInfo.innerHTML = `
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"/>
                    </svg>
                    √ñƒürenci bulunamadƒ± (${filterSelect.value})
                `;
                filterInfo.className = 'filter-info error';
            }
        }
        
        console.log(`üìä Filtre bilgisi g√ºncellendi: ${filteredCount}/${totalStudents} √∂ƒürenci`);
        
    } catch (error) {
        console.error('‚ùå Filtre bilgisi g√ºncelleme hatasƒ±:', error);
    }
}

/**
 * Deƒüerlendirme √∂ƒürenci filtresini ba≈ülat
 */
function initializeAssessmentStudentFilter() {
    const filterSelect = document.getElementById('assessmentStudentFilter');
    if (!filterSelect) return;
    
    // √ñƒürenci listesini doldur
    updateAssessmentStudentFilterOptions();
    
    // Change event listener ekle
    filterSelect.addEventListener('change', function() {
        updateAssessmentView();
    });
}

/**
 * Deƒüerlendirme √∂ƒürenci filtresi se√ßeneklerini g√ºncelle
 */
function updateAssessmentStudentFilterOptions() {
    try {
    const filterSelect = document.getElementById('assessmentStudentFilter');
        if (!filterSelect) {
            console.warn('‚ö†Ô∏è assessmentStudentFilter elementi bulunamadƒ±');
            return;
        }
    
    const currentValue = filterSelect.value;
    
    // Se√ßenekleri temizle
    filterSelect.innerHTML = '<option value="">T√ºm √ñƒürenciler</option>';
        
        // √ñƒürenci verisi kontrol√º
        if (!APP_STATE.studentData || !Array.isArray(APP_STATE.studentData)) {
            console.warn('‚ö†Ô∏è √ñƒürenci verisi bulunamadƒ±, filtre se√ßenekleri bo≈ü bƒ±rakƒ±lƒ±yor');
            updateAssessmentFilterInfo();
            return;
        }
    
    // √ñƒürenci se√ßeneklerini ekle
        let addedCount = 0;
    APP_STATE.studentData.forEach(student => {
            try {
                if (!student || !student.studentId) {
                    console.warn('‚ö†Ô∏è Ge√ßersiz √∂ƒürenci verisi atlandƒ±:', student);
                    return;
                }
                
        const option = document.createElement('option');
        option.value = student.studentId;
                option.textContent = `${student.studentId} - ${student.name || 'Ad Yok'} ${student.surname || 'Soyad Yok'}`;
        
        if (student.studentId === currentValue) {
            option.selected = true;
        }
        
        filterSelect.appendChild(option);
                addedCount++;
                
            } catch (error) {
                console.error('‚ùå √ñƒürenci se√ßeneƒüi eklenirken hata:', error, student);
            }
    });
        
        console.log(`üìù ${addedCount} √∂ƒürenci filtre se√ßeneƒüi eklendi`);
    
    // Filtre bilgisini g√ºncelle
    updateAssessmentFilterInfo();
        
    } catch (error) {
        console.error('‚ùå √ñƒürenci filtre se√ßenekleri g√ºncelleme hatasƒ±:', error);
    }
}

/**
 * Tek √∂ƒürenci i√ßin anlƒ±k not hesaplama (Deƒüerlendirme tablosunda kullanƒ±m i√ßin)
 * @param {string} studentId - √ñƒürenci ID'si
 * @returns {Object} - Hesaplanan notlar
 */
function calculateStudentGrades(studentId) {
    try {
        if (!APP_STATE.assessmentTree || APP_STATE.assessmentTree.length === 0) {
            return {
                termGrade: 0.00,
                finalGrade: 0.00, 
                totalGrade: 0.00,
                letterGrade: "FF"
            };
        }
        
        // Yarƒ±yƒ±l i√ßi etkinlikler
        const termActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('A'));
        let termGrade = 0;
        
        // ƒ∞√ß aƒüƒ±rlƒ±k toplamƒ±
        const termInternalTotal = termActivities.reduce((sum, node) => sum + parseFloat(node.weight || 0), 0);
        
        if (termInternalTotal > 0) {
            termActivities.forEach(activity => {
                // ƒ∞√ß aƒüƒ±rlƒ±k normalle≈ütirmesi
                const activityWeight = activity.weight / termInternalTotal; 
                let activityGrade = 0;
                
                if (activity.children && activity.children.length > 0) {
                    // Alt etkinlikler
                    const childrenTotalWeight = activity.children.reduce((sum, child) => sum + parseFloat(child.weight || 0), 0);
                    
                    if (childrenTotalWeight > 0) {
                        activity.children.forEach(subItem => {
                            // Alt √∂ƒüe aƒüƒ±rlƒ±k normalle≈ütirmesi
                            const subItemWeight = subItem.weight / childrenTotalWeight; 
                            const grade = getStudentGrade(studentId, subItem.id) || 0;
                            const scaledGrade = (grade / (subItem.points || 1)) * 100; // 100 √ºzerinden
                            activityGrade += scaledGrade * subItemWeight;
                        });
                    }
                } else {
                    // Basit etkinlik
                    const grade = getStudentGrade(studentId, activity.id) || 0;
                    activityGrade = (grade / (activity.points || 1)) * 100; // 100 √ºzerinden
                }
                
                termGrade += activityGrade * activityWeight;
            });
        }
        
        // Yarƒ±yƒ±l sonu etkinlikler
        const finalActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('F'));
        let finalGrade = 0;
        
        // ƒ∞√ß aƒüƒ±rlƒ±k toplamƒ±
        const finalInternalTotal = finalActivities.reduce((sum, node) => sum + parseFloat(node.weight || 0), 0);
        
        if (finalInternalTotal > 0) {
            finalActivities.forEach(activity => {
                // ƒ∞√ß aƒüƒ±rlƒ±k normalle≈ütirmesi
                const activityWeight = activity.weight / finalInternalTotal;
                let activityGrade = 0;
                
                if (activity.children && activity.children.length > 0) {
                    // Alt etkinlikler
                    const childrenTotalWeight = activity.children.reduce((sum, child) => sum + parseFloat(child.weight || 0), 0);
                    
                    if (childrenTotalWeight > 0) {
                        activity.children.forEach(subItem => {
                            // Alt √∂ƒüe aƒüƒ±rlƒ±k normalle≈ütirmesi
                            const subItemWeight = subItem.weight / childrenTotalWeight;
                            const grade = getStudentGrade(studentId, subItem.id) || 0;
                            const scaledGrade = (grade / (subItem.points || 1)) * 100; // 100 √ºzerinden
                            activityGrade += scaledGrade * subItemWeight;
                        });
                    }
                } else {
                    // Basit etkinlik
                    const grade = getStudentGrade(studentId, activity.id) || 0;
                    activityGrade = (grade / (activity.points || 1)) * 100; // 100 √ºzerinden
                }
                
                finalGrade += activityGrade * activityWeight;
            });
        }
        
        // Toplam ve harf notu - RTEU Y√∂netmeliƒüi MADDE 26'ya g√∂re
        // Yarƒ±yƒ±l sonu sƒ±navƒ±ndan en az 50 puan alma zorunluluƒüu kontrol√º
        let totalGrade = (termGrade * APP_STATE.termWeight / 100) + (finalGrade * APP_STATE.finalWeight / 100);
        let letterGrade = getLetterGrade(totalGrade);
        
        // Yarƒ±yƒ±l sonu sƒ±navƒ± 50'nin altƒ±ndaysa FF verilir
        if (finalGrade < 50) {
            letterGrade = 'FF';
            // Not: Toplam notu deƒüi≈ütirmiyoruz, sadece harf notunu FF yapƒ±yoruz
        }
        
        return {
            termGrade: parseFloat(termGrade.toFixed(2)),
            finalGrade: parseFloat(finalGrade.toFixed(2)),
            totalGrade: parseFloat(totalGrade.toFixed(2)),
            letterGrade: letterGrade
        };
        
    } catch (error) {
        console.error("√ñƒürenci notlarƒ± hesaplanƒ±rken hata:", error);
        return {
            termGrade: 0.00,
            finalGrade: 0.00,
            totalGrade: 0.00, 
            letterGrade: "FF"
        };
    }
}

/**
 * Harf notuna g√∂re CSS sƒ±nƒ±fƒ± getirme - RTEU Y√∂netmeliƒüi'ne g√∂re
 * @param {string} letterGrade - Harf notu
 * @returns {string} - CSS sƒ±nƒ±fƒ±
 */
function getLetterGradeClass(letterGrade) {
    if (['AA', 'BA'].includes(letterGrade)) {
        return 'grade-excellent';  // M√ºkemmel ve √áok ƒ∞yi
    } else if (['BB', 'CB', 'CC'].includes(letterGrade)) {
        return 'grade-good';       // ƒ∞yi, Orta ve Yeterli (Ba≈üarƒ±lƒ±)
    } else if (['DC'].includes(letterGrade)) {
        return 'grade-conditional'; // ≈ûartlƒ± Ba≈üarƒ±lƒ±
    } else if (['DD', 'FD', 'FF', 'D'].includes(letterGrade)) {
        return 'grade-fail';       // Ba≈üarƒ±sƒ±z
    } else {
        return 'grade-unknown';    // Bilinmeyen
    }
}

/**
 * Deƒüerlendirme tablosundaki not √∂zeti h√ºcrelerini g√ºncelle
 * @param {string} studentId - √ñƒürenci ID'si  
 */
function updateAssessmentGradeSummary(studentId) {
    try {
        // Yeni notlarƒ± hesapla
        const studentGrades = calculateStudentGrades(studentId);
        
        // Bu √∂ƒürencinin t√ºm satƒ±rlarƒ±nƒ± bul
        const studentRows = document.querySelectorAll(`tr[data-student-id="${studentId}"]`);
        
        studentRows.forEach(row => {
            // Not √∂zeti h√ºcrelerini bul ve g√ºncelle
            const termGradeCell = row.querySelector('.grade-summary-cell.term-grade');
            const finalGradeCell = row.querySelector('.grade-summary-cell.final-grade');
            const totalGradeCell = row.querySelector('.grade-summary-cell.total-grade');
            const letterGradeCell = row.querySelector('.grade-summary-cell.letter-grade');
            
            if (termGradeCell) {
                termGradeCell.textContent = studentGrades.termGrade.toFixed(2);
            }
            
            if (finalGradeCell) {
                finalGradeCell.textContent = studentGrades.finalGrade.toFixed(2);
            }
            
            if (totalGradeCell) {
                totalGradeCell.textContent = studentGrades.totalGrade.toFixed(2);
            }
            
            if (letterGradeCell) {
                // Eski CSS sƒ±nƒ±flarƒ±nƒ± kaldƒ±r
                letterGradeCell.classList.remove('grade-excellent', 'grade-good', 'grade-conditional', 'grade-fail', 'grade-unknown');
                // Yeni CSS sƒ±nƒ±fƒ±nƒ± ekle
                letterGradeCell.classList.add(getLetterGradeClass(studentGrades.letterGrade));
                letterGradeCell.textContent = studentGrades.letterGrade;
            }
        });
        
    } catch (error) {
        console.error("Assessment not √∂zeti g√ºncellenirken hata:", error);
    }
}

/**
 * Deƒüerlendirme etkinliƒüi b√∂l√ºm√º olu≈üturma
 * @param {Object} activity - Etkinlik
 * @param {HTMLElement} container - Konteyner elementi
 * @param {string} type - Etkinlik tipi (term/final)
 */
function createAssessmentActivitySection(activity, container, type) {
    console.log(`üìä createAssessmentActivitySection √ßaƒürƒ±ldƒ±: ${activity.id} (${activity.name})`);
    try {
        const sectionDiv = document.createElement('div');
        sectionDiv.className = 'assessment-subsection';
        sectionDiv.dataset.activityId = activity.id;
        
        const header = document.createElement('h4');
        header.innerHTML = `${getComponentDisplayName(activity.id)} <span class="badge badge-primary">${activity.weight}%</span>`;
        sectionDiv.appendChild(header);
        
        // Aktivitenin alt √∂ƒüeleri var mƒ± kontrol et
        if (activity.children && activity.children.length > 0) {
            // Test var mƒ± kontrol et
            const hasTest = activity.children.some(child => child.type === 'Test');
            
            if (hasTest) {
                // Test sorularƒ± i√ßin √∂zel giri≈ü
            activity.children.forEach(subItem => {
                if (subItem.type === 'Test') {
                    createTestInputSection(subItem, sectionDiv);
                }
            });
        } else {
                // Normal sorular i√ßin kaƒüƒ±t sƒ±rasƒ± bazƒ±nda tek giri≈ü
                createComponentPaperOrderInputSection(activity, sectionDiv);
            }
        } else {
            // Alt √∂ƒüe yoksa basit bir puan giri≈üi g√∂ster (Laboratuvar gibi)
            const simpleInputDiv = document.createElement('div');
            simpleInputDiv.className = 'assessment-table-container';
            
            // Basit bile≈üenler i√ßin grup bilgisi kutusu g√∂sterilmez
            const componentId = getParentComponentId(activity.id) || activity.id;
            const component = APP_STATE.courseData?.grupHaritalari?.[componentId];
            const groups = component?.gruplar || ['A'];
            
            // Tablo ba≈ülƒ±klarƒ±nƒ± her zaman grup s√ºtunu ile g√∂ster
            // Yarƒ±yƒ±l i√ßi ve sonu oranlarƒ±nƒ± dinamik olarak al
            const termWeight = getTermWeight();
            const finalWeight = getFinalWeight();
            const tableHeaders = `<th class="col-no">No</th><th class="col-studentId">√ñƒürenci No</th><th class="col-name">Adƒ±</th><th class="col-surname">Soyadƒ±</th><th class="col-email">E-posta</th><th class="col-group">Grup</th><th class="col-answerKey">Cevap Anahtarƒ± Sƒ±rasƒ±</th><th class="col-activityName">Etkinlik Adƒ±<br/><small>(Soru/Rubrik)</small></th><th class="col-description">A√ßƒ±klama</th><th class="col-maxPoints">Etkinlik Max. Puan<br/><small>(Soru/Rubrik)</small></th><th class="col-totalPoints">Toplam Puan<br/><small>(Deƒüerlendirme Oranƒ±: ${getAssessmentWeight(activity.id)}%)</small></th><th class="col-outcomes">√ñ√á</th><th class="col-earnedPoints">Alƒ±nan Puan<br/><small>(Etkinlik Puanƒ±)</small></th><th class="col-termGrade">Yarƒ±yƒ±l ƒ∞√ßi<br/><small>(${termWeight}%)</small></th><th class="col-finalGrade">Yarƒ±yƒ±l Sonu<br/><small>(${finalWeight}%)</small></th><th class="col-average">Ortalama</th><th class="col-letterGrade">Harf Notu</th>`;
            
            const tableHTML = `
                <table class="assessment-table">
                    <thead>
                        <tr>
                            ${tableHeaders}
                        </tr>
                    </thead>
                    <tbody>
                        ${APP_STATE.studentData.map((student, index) => {
                            // Sadece bu bile≈üenin gruplarƒ±nƒ± g√∂ster
                            const studentCurrentGroup = getStudentGroupForComponent(student.studentId, componentId);
                            console.log(`üîç ${componentId} i√ßin √∂ƒürenci ${student.studentId}: gruplar=${groups.join(',')}, mevcut=${studentCurrentGroup}`);
                            const groupOptions = groups.map(groupId => 
                                `<option value="${groupId}" ${studentCurrentGroup === groupId ? 'selected' : ''}>${groupId}</option>`
                            ).join('');
                            console.log(`  üìù HTML groupOptions: "${groupOptions}"`);
                            
                            // Bu basit aktivite i√ßin maksimum puan her zaman activity.points'tir
                            const maxPoints = activity.points;
                            
                            // Grup s√ºtununu her zaman g√∂ster
                            const groupColumn = `<td>
                                        <select class="group-selector compact" data-student-id="${student.studentId}" data-component-id="${componentId}" onchange="updateStudentGroupForComponent(this)">
                                            ${groupOptions}
                                        </select>
                                    </td>`;
                            console.log(`  üèóÔ∏è HTML grup s√ºtunu olu≈üturuldu: ${student.studentId} - ${componentId}`);
                            
                            // √ñƒürenci notlarƒ±nƒ± hesapla
                            const studentGrades = calculateStudentGrades(student.studentId);
                            
                            return `
                            <tr data-student-id="${student.studentId}" data-component-id="${componentId}">
                                <td class="col-no">${index + 1}</td>
                                <td class="col-studentId">${student.studentId}</td>
                                <td class="col-name">${student.name}</td>
                                <td class="col-surname">${student.surname}</td>
                                <td class="col-email email-cell">
                                    <span class="email-text" title="${student.email || 'E-posta bulunamadƒ±'}">${student.email || '-'}</span>
                                    ${student.email ? `<button class="email-button" title="E-posta g√∂nder" onclick="openEmailModal({studentId: '${student.studentId}', name: '${student.name}', surname: '${student.surname}', email: '${student.email}'})">E-posta</button>` : ''}
                                </td>
                                <td class="col-group">${groupColumn.replace('<td>', '').replace('</td>', '')}</td>
                                <td class="col-answerKey">-</td>
                                <td class="col-activityName">${activity.name || activity.id}</td>
                                <td class="col-description">${activity.description || '-'}</td>
                                <td class="col-maxPoints question-points-cell" data-student-id="${student.studentId}" data-activity-id="${activity.id}">
                                    ${maxPoints}
                                </td>
                                <td class="col-totalPoints total-points-cell" data-student-id="${student.studentId}" data-activity-id="${activity.id}">
                                    <div class="total-points-container">
                                        <span class="total-points-value">${getStudentTotalEarnedPointsForComponent(student.studentId, activity.id)}</span>
                                        <button class="auto-distribute-btn" type="button" 
                                                data-student-id="${student.studentId}" 
                                                data-activity-id="${activity.id}"
                                                title="Otomatik puan daƒüƒ±t">
                                            üéØ
                                        </button>
                                    </div>
                                </td>
                                <td class="col-outcomes">-</td>
                                <td class="col-earnedPoints">
                                                        <input type="number" min="0" max="100"
                        data-student-id="${student.studentId}"
                        data-activity-id="${activity.id}" 
                                        value="${getStudentGrade(student.studentId, activity.id) || ''}"
                                        onchange="updateStudentGrade(this)"
                                        placeholder="0-${maxPoints}"
                                        title="Bu aktivitenin maksimum puanƒ±: ${maxPoints}"
                                    >
                                </td>
                                <td class="col-termGrade grade-summary-cell term-grade">${studentGrades.termGrade}</td>
                                <td class="col-finalGrade grade-summary-cell final-grade">${studentGrades.finalGrade}</td>
                                <td class="col-average grade-summary-cell total-grade">${studentGrades.totalGrade}</td>
                                <td class="col-letterGrade grade-summary-cell letter-grade ${getLetterGradeClass(studentGrades.letterGrade)}">${studentGrades.letterGrade}</td>
                            </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            simpleInputDiv.innerHTML = tableHTML;
            sectionDiv.appendChild(simpleInputDiv);
        }
        
        container.appendChild(sectionDiv);
    } catch (error) {
        console.error("Deƒüerlendirme etkinliƒüi b√∂l√ºm√º olu≈üturulurken hata olu≈ütu:", error);
    }
}

/**
 * Test sorularƒ± i√ßin √∂zel giri≈ü b√∂l√ºm√º olu≈üturma
 * @param {Object} testItem - Test √∂ƒüesi
 * @param {HTMLElement} container - Konteyner elementi
 */
function createTestInputSection(testItem, container) {
    try {
        const testDiv = document.createElement('div');
        testDiv.className = 'assessment-subsection';
        
        // Test detaylarƒ±nƒ± g√∂ster
        const testDetailsDiv = document.createElement('div');
        testDetailsDiv.className = 'test-details';
        testDetailsDiv.innerHTML = `
            <h5>${testItem.name}</h5>
            <div class="test-info">
                <p>Toplam ${testItem.testDetails.totalQuestions} soru, her doƒüru: ${testItem.testDetails.correctWeight} puan, her yanlƒ±≈ü: ${testItem.testDetails.wrongPenalty} puan</p>
            </div>
        `;
        testDiv.appendChild(testDetailsDiv);
        
        // Modern grup bilgileri g√∂sterimi
        const parentComponentId = getParentComponentId(testItem.id);
        const modernGroupInfo = createModernGroupInfoDisplay(parentComponentId, testItem.id);
        if (modernGroupInfo) {
            testDiv.appendChild(modernGroupInfo);
        }
        
        // Giri≈ü modlarƒ± olu≈ütur
        const inputModesDiv = document.createElement('div');
        inputModesDiv.className = 'input-modes';
        
        const detailedModeButton = document.createElement('div');
        detailedModeButton.className = 'input-mode active';
        detailedModeButton.textContent = 'Detaylƒ± Giri≈ü';
        detailedModeButton.dataset.mode = 'detailed';
        detailedModeButton.dataset.testId = testItem.id;
        
        const simpleModeButton = document.createElement('div');
        simpleModeButton.className = 'input-mode';
        simpleModeButton.textContent = 'Basit Giri≈ü';
        simpleModeButton.dataset.mode = 'simple';
        simpleModeButton.dataset.testId = testItem.id;
        
        // Mod butonlarƒ± i√ßin olay dinleyicileri
        detailedModeButton.addEventListener('click', function() {
            switchTestInputMode(this.dataset.testId, 'detailed');
        });
        
        simpleModeButton.addEventListener('click', function() {
            switchTestInputMode(this.dataset.testId, 'simple');
        });
        
        inputModesDiv.appendChild(detailedModeButton);
        inputModesDiv.appendChild(simpleModeButton);
        testDiv.appendChild(inputModesDiv);
        
        // Detaylƒ± giri≈ü formu - Doƒüru/Yanlƒ±≈ü sayƒ±sƒ±
        const detailedFormDiv = document.createElement('div');
        detailedFormDiv.className = 'test-input-form detailed-mode';
        detailedFormDiv.dataset.testId = testItem.id;
        
        // Tablo olu≈ütur
        const detailedTable = document.createElement('table');
        detailedTable.className = 'assessment-table';
        
        // Bu test √∂ƒüesinin baƒülƒ± olduƒüu bile≈üenin gruplarƒ±nƒ± al
        const componentId = getParentComponentId(testItem.id);
        const component = APP_STATE.courseData?.grupHaritalari?.[componentId];
        const groups = component?.gruplar || ['A'];
        
        const detailedTableHTML = `
            <thead>
                <tr>
                    <th class="col-no">No</th>
                    <th class="col-studentId">√ñƒürenci No</th>
                    <th class="col-name">Adƒ±</th>
                    <th class="col-surname">Soyadƒ±</th>
                    <th class="col-email">E-posta</th>
                    <th class="col-group">Grup</th>
                    <th class="col-answerKey">Doƒüru Sayƒ±sƒ±</th>
                    <th class="col-activityName">Yanlƒ±≈ü Sayƒ±sƒ±</th>
                    <th class="col-description">Bo≈ü Sayƒ±sƒ±</th>
                    <th class="col-maxPoints">Max. Puan</th>
                    <th class="col-totalPoints">Toplam Puan<br/><small>(Deƒüerlendirme Oranƒ±: ${getAssessmentWeight(testItem.id)}%)</small></th>
                    <th class="col-outcomes">√ñ√á</th>
                    <th class="col-earnedPoints">Alƒ±nan Puan</th>
                    <th class="col-termGrade">Yarƒ±yƒ±l ƒ∞√ßi<br/><small>(${getTermWeight()}%)</small></th>
                    <th class="col-finalGrade">Yarƒ±yƒ±l Sonu<br/><small>(${getFinalWeight()}%)</small></th>
                    <th class="col-average">Ortalama</th>
                    <th class="col-letterGrade">Harf Notu</th>
                </tr>
            </thead>
            <tbody>
                ${APP_STATE.studentData.map((student, index) => {
                    // Test sonu√ßlarƒ±nƒ± al
                    const testScore = getStudentTestScore(student.studentId, testItem.id);
                    const correct = testScore?.correct || 0;
                    const wrong = testScore?.wrong || 0;
                    const empty = testItem.testDetails.totalQuestions - correct - wrong;
                    const totalScore = correct * testItem.testDetails.correctWeight - wrong * Math.abs(testItem.testDetails.wrongPenalty);
                    
                    const studentCurrentGroup = getStudentGroupForComponent(student.studentId, componentId);
                    const groupOptions = groups.map(groupId => 
                        `<option value="${groupId}" ${studentCurrentGroup === groupId ? 'selected' : ''}>${groupId}</option>`
                    ).join('');
                    
                    // √ñƒürenci notlarƒ±nƒ± hesapla
                    const studentGrades = calculateStudentGrades(student.studentId);
                    
                    return `
                        <tr>
                            <td class="col-no">${index + 1}</td>
                            <td class="col-studentId">${student.studentId}</td>
                            <td class="col-name">${student.name}</td>
                            <td class="col-surname">${student.surname}</td>
                            <td class="col-email email-cell">
                                <span class="email-text" title="${student.email || 'E-posta bulunamadƒ±'}">${student.email || '-'}</span>
                                ${student.email ? `<button class="email-button" title="E-posta g√∂nder" onclick="openEmailModal({studentId: '${student.studentId}', name: '${student.name}', surname: '${student.surname}', email: '${student.email}'})">E-posta</button>` : ''}
                            </td>
                            <td class="col-group">
                                <select class="group-selector compact" data-student-id="${student.studentId}" data-component-id="${componentId}" onchange="updateStudentGroupForComponent(this)">
                                    ${groupOptions}
                                </select>
                            </td>
                            <td class="col-answerKey">
                                <input type="number" min="0" max="${testItem.testDetails.totalQuestions}" 
                                    data-student-id="${student.studentId}" 
                                    data-test-id="${testItem.id}" 
                                    data-field="correct"
                                    value="${correct}"
                                    onchange="updateTestScore(this)"
                                >
                            </td>
                            <td class="col-activityName">
                                <input type="number" min="0" max="${testItem.testDetails.totalQuestions}" 
                                    data-student-id="${student.studentId}" 
                                    data-test-id="${testItem.id}" 
                                    data-field="wrong"
                                    value="${wrong}"
                                    onchange="updateTestScore(this)"
                                >
                            </td>
                            <td class="col-description">${empty}</td>
                            <td class="col-maxPoints">${testItem.points}</td>
                            <td class="col-totalPoints total-score">${totalScore.toFixed(2)}</td>
                            <td class="col-outcomes">-</td>
                            <td class="col-earnedPoints">${totalScore.toFixed(2)}</td>
                            <td class="col-termGrade grade-summary-cell term-grade">${studentGrades.termGrade}</td>
                            <td class="col-finalGrade grade-summary-cell final-grade">${studentGrades.finalGrade}</td>
                            <td class="col-average grade-summary-cell total-grade">${studentGrades.totalGrade}</td>
                            <td class="col-letterGrade grade-summary-cell letter-grade ${getLetterGradeClass(studentGrades.letterGrade)}">${studentGrades.letterGrade}</td>
                        </tr>
                    `;
                }).join('')}
            </tbody>
        `;
        
        detailedTable.innerHTML = detailedTableHTML;
        detailedFormDiv.appendChild(detailedTable);
        testDiv.appendChild(detailedFormDiv);
        
        // Basit giri≈ü formu - Sadece toplam puan
        const simpleFormDiv = document.createElement('div');
        simpleFormDiv.className = 'test-input-form simple-mode';
        simpleFormDiv.dataset.testId = testItem.id;
        simpleFormDiv.style.display = 'none'; // Ba≈ülangƒ±√ßta gizli
        
        // Tablo olu≈ütur
        const simpleTable = document.createElement('table');
        simpleTable.className = 'assessment-table';
        
        const simpleTableHTML = `
            <thead>
                <tr>
                    <th class="col-no">No</th>
                    <th class="col-studentId">√ñƒürenci No</th>
                    <th class="col-name">Adƒ±</th>
                    <th class="col-surname">Soyadƒ±</th>
                    <th class="col-email">E-posta</th>
                    <th class="col-group">Grup</th>
                    <th class="col-answerKey">Cevap Anahtarƒ±</th>
                    <th class="col-activityName">Etkinlik Adƒ±</th>
                    <th class="col-description">A√ßƒ±klama</th>
                    <th class="col-maxPoints">Max. Puan</th>
                    <th class="col-totalPoints">Toplam Puan</th>
                    <th class="col-outcomes">√ñ√á</th>
                    <th class="col-earnedPoints">Alƒ±nan Puan (${testItem.points})</th>
                    <th class="col-termGrade">Yarƒ±yƒ±l ƒ∞√ßi</th>
                    <th class="col-finalGrade">Yarƒ±yƒ±l Sonu</th>
                    <th class="col-average">Ortalama</th>
                    <th class="col-letterGrade">Harf Notu</th>
                </tr>
            </thead>
            <tbody>
                ${APP_STATE.studentData.map((student, index) => {
                    // Test sonu√ßlarƒ±nƒ± al
                    const testScore = getStudentTestScore(student.studentId, testItem.id);
                    const correct = testScore?.correct || 0;
                    const wrong = testScore?.wrong || 0;
                    const totalScore = correct * testItem.testDetails.correctWeight - wrong * Math.abs(testItem.testDetails.wrongPenalty);
                    
                    const studentCurrentGroup = getStudentGroupForComponent(student.studentId, componentId);
                    console.log(`üîç Test detaylƒ± giri≈ü - ${componentId} i√ßin √∂ƒürenci ${student.studentId}: gruplar=${groups.join(',')}, mevcut=${studentCurrentGroup}`);
                    const groupOptions = groups.map(groupId => 
                        `<option value="${groupId}" ${studentCurrentGroup === groupId ? 'selected' : ''}>${groupId}</option>`
                    ).join('');
                    
                    // √ñƒürenci notlarƒ±nƒ± hesapla
                    const studentGrades = calculateStudentGrades(student.studentId);
                    
                    return `
                        <tr>
                            <td class="col-no">${index + 1}</td>
                            <td class="col-studentId">${student.studentId}</td>
                            <td class="col-name">${student.name}</td>
                            <td class="col-surname">${student.surname}</td>
                            <td class="col-email email-cell">
                                <span class="email-text" title="${student.email || 'E-posta bulunamadƒ±'}">${student.email || '-'}</span>
                                ${student.email ? `<button class="email-button" title="E-posta g√∂nder" onclick="openEmailModal({studentId: '${student.studentId}', name: '${student.name}', surname: '${student.surname}', email: '${student.email}'})">E-posta</button>` : ''}
                            </td>
                            <td class="col-group">
                                <select class="group-selector compact" data-student-id="${student.studentId}" data-component-id="${componentId}" onchange="updateStudentGroupForComponent(this)">
                                    ${groupOptions}
                                </select>
                            </td>
                            <td class="col-answerKey">-</td>
                            <td class="col-activityName">${testItem.name}</td>
                            <td class="col-description">${testItem.description || '-'}</td>
                            <td class="col-maxPoints">${testItem.points}</td>
                            <td class="col-totalPoints">${totalScore.toFixed(2)}</td>
                            <td class="col-outcomes">-</td>
                            <td class="col-earnedPoints">
                                <input type="number" min="0" max="${testItem.points}" 
                                    data-student-id="${student.studentId}" 
                                    data-activity-id="${testItem.id}" 
                                    value="${totalScore.toFixed(2)}"
                                    onchange="updateStudentGrade(this)"
                                >
                            </td>
                            <td class="col-termGrade grade-summary-cell term-grade">${studentGrades.termGrade}</td>
                            <td class="col-finalGrade grade-summary-cell final-grade">${studentGrades.finalGrade}</td>
                            <td class="col-average grade-summary-cell total-grade">${studentGrades.totalGrade}</td>
                            <td class="col-letterGrade grade-summary-cell letter-grade ${getLetterGradeClass(studentGrades.letterGrade)}">${studentGrades.letterGrade}</td>
                        </tr>
                    `;
                }).join('')}
            </tbody>
        `;
        
        simpleTable.innerHTML = simpleTableHTML;
        simpleFormDiv.appendChild(simpleTable);
        testDiv.appendChild(simpleFormDiv);
        
        container.appendChild(testDiv);
    } catch (error) {
        console.error("Test giri≈ü b√∂l√ºm√º olu≈üturul√ºrken hata olu≈ütu:", error);
    }
}

/**
 * Modern grup bilgileri g√∂sterim elementi olu≈üturma
 * @param {string} componentId - Bile≈üen ID'si
 * @param {string} questionId - Soru ID'si
 * @returns {HTMLElement|null} - Grup bilgileri elementi
 */
function createModernGroupInfoDisplay(componentId, questionId) {
    try {
        if (!APP_STATE.courseData?.grupHaritalari?.[componentId]) {
            return null;
        }

        const componentData = APP_STATE.courseData.grupHaritalari[componentId];
        const groups = componentData.gruplar || [];
        
        // Grup yoksa g√∂sterme, ama tek grup varsa g√∂ster
        if (groups.length === 0) {
            return null;
        }

        const groupInfoDiv = document.createElement('div');
        groupInfoDiv.className = 'compact-group-info';
        
        // Grup bilgilerini kompakt formatta hazƒ±rla
        const groupMappings = [];
        groups.forEach(groupId => {
            let paperOrder = '-';
            let originalOrder = '-';
            let questionPoints = '-';
            
            // Bu grubun bu soru i√ßin haritalama bilgisi var mƒ±?
            const groupMappings_data = componentData.haritalar?.[groupId]?.[questionId];
            
            if (groupMappings_data) {
                // Haritalama varsa, kaƒüƒ±ttaki sƒ±rayƒ± g√∂ster
                paperOrder = groupMappings_data;
                
                // Orijinal sƒ±rayƒ± bul (soru ID'sinden)
                const questionNode = findNodeById(questionId);
                if (questionNode) {
                    questionPoints = questionNode.points || '-';
                    const parent = findNodeById(getParentComponentId(questionId));
                    if (parent && parent.children) {
                        const index = parent.children.findIndex(child => child.id === questionId);
                        originalOrder = index >= 0 ? (index + 1) : '-';
                    }
                }
            } else {
                // Haritalama yoksa, standart sƒ±rayƒ± g√∂ster
                const questionNode = findNodeById(questionId);
                if (questionNode) {
                    questionPoints = questionNode.points || '-';
                    const parent = findNodeById(getParentComponentId(questionId));
                    if (parent && parent.children) {
                        const index = parent.children.findIndex(child => child.id === questionId);
                        originalOrder = index >= 0 ? (index + 1) : '-';
                        paperOrder = originalOrder; // Haritalama yoksa aynƒ±
                    }
                }
            }
            
            groupMappings.push({
                group: groupId,
                paperOrder: paperOrder,
                originalOrder: originalOrder,
                points: questionPoints
            });
        });
        
        // Kompakt tablo formatƒ±nda g√∂ster
        groupInfoDiv.innerHTML = `
            <div class="compact-header">
                <span class="compact-icon">üìä</span>
                <span class="compact-title">Grup Bilgileri</span>
            </div>
            <div class="compact-table">
                <div class="compact-row compact-header-row">
                    <span>Grup</span>
                    <span>Orijinal</span>
                    <span>Kaƒüƒ±t</span>
                    <span>Puan</span>
                </div>
                ${groupMappings.map(mapping => `
                    <div class="compact-row">
                        <span class="group-badge-compact">${mapping.group}</span>
                        <span class="original-info">${mapping.originalOrder}</span>
                        <span class="paper-info">${mapping.paperOrder}</span>
                        <span class="points-info">${mapping.points}</span>
                    </div>
                `).join('')}
            </div>
        `;
        
        return groupInfoDiv;
    } catch (error) {
        console.error("Modern grup bilgileri olu≈üturulurken hata:", error);
        return null;
    }
}

/**
 * Alt √∂ƒüe giri≈ü b√∂l√ºm√º olu≈üturma (Soru/Rubrik)
 * @param {Object} subItem - Alt √∂ƒüe
 * @param {HTMLElement} container - Konteyner elementi
 */
function createSubItemInputSection(subItem, container) {
    try {
        const subDiv = document.createElement('div');
        subDiv.className = 'assessment-subsection';
        
        const parentComponentId = getParentComponentId(subItem.id);
        
        // Ba≈ülƒ±k
        const header = document.createElement('h5');
        header.innerHTML = `${subItem.name}`;
        subDiv.appendChild(header);
        
        // Bile≈üendeki t√ºm sorularƒ± al
        const parentNode = findNodeById(parentComponentId);
        const allQuestions = parentNode?.children || [];
        const maxQuestions = allQuestions.length;
        
        // Grup se√ßeneklerini g√ºvenli ≈üekilde olu≈ütur
        const groups = (APP_STATE.courseData && APP_STATE.courseData.grupHaritalari && APP_STATE.courseData.grupHaritalari[parentComponentId]) 
            ? APP_STATE.courseData.grupHaritalari[parentComponentId].gruplar || ['A']
            : ['A'];
        
        // Grup sistemi her zaman kullanƒ±lƒ±r (tek grup olsa bile)
        const useGroupSystem = true;
        
        // Kaƒüƒ±t sƒ±rasƒ± bazƒ±nda b√∂l√ºmler olu≈ütur
        for (let paperOrder = 1; paperOrder <= maxQuestions; paperOrder++) {
            const paperSection = document.createElement('div');
            paperSection.className = 'paper-order-section';
            
            const paperHeader = document.createElement('h6');
            paperHeader.innerHTML = `Kaƒüƒ±t Sƒ±rasƒ± ${paperOrder}`;
            paperHeader.className = 'paper-order-header';
            paperSection.appendChild(paperHeader);
            
        const table = document.createElement('table');
            table.className = 'assessment-table paper-order-table';
            
            const tableHTML = `
            <thead>
                <tr>
                    <th class="col-no">No</th>
                    <th class="col-studentId">√ñƒürenci No</th>
                    <th class="col-name">Adƒ±</th>
                    <th class="col-surname">Soyadƒ±</th>
                    <th class="col-email">E-posta</th>
                    <th class="col-group">Grup</th>
                    <th class="col-answerKey">Cevap Anahtarƒ± Sƒ±rasƒ±</th>
                    <th class="col-activityName">Etkinlik Adƒ±<br/><small>(Soru/Rubrik)</small></th>
                    <th class="col-description">A√ßƒ±klama</th>
                    <th class="col-maxPoints">Etkinlik Max. Puan<br/><small>(Soru/Rubrik)</small></th>
                        <th class="col-totalPoints">Toplam Puan</th>
                        <th class="col-outcomes">√ñ√á</th>
                        <th class="col-earnedPoints">Alƒ±nan Puan<br/><small>(Etkinlik Puanƒ±)</small></th>
                        <th class="col-termGrade">Yarƒ±yƒ±l ƒ∞√ßi<br/><small>(${getTermWeight()}%)</small></th>
                        <th class="col-finalGrade">Yarƒ±yƒ±l Sonu<br/><small>(${getFinalWeight()}%)</small></th>
                        <th class="col-average">Ortalama</th>
                        <th class="col-letterGrade">Harf Notu</th>
                </tr>
            </thead>
            <tbody>
                    ${APP_STATE.studentData.map((student, index) => {
                        const studentCurrentGroup = getStudentGroupForComponent(student.studentId, parentComponentId);
                        const groupOptions = groups.map(groupId => 
                            `<option value="${groupId}" ${studentCurrentGroup === groupId ? 'selected' : ''}>${groupId}</option>`
                        ).join('');
                        
                        // Bu kaƒüƒ±t sƒ±rasƒ±ndaki sorunun ger√ßek ID'sini bul
                        const actualQuestionId = getQuestionIdByPaperOrder(student.studentId, paperOrder, parentComponentId);
                        const actualQuestion = findNodeById(actualQuestionId);
                        
                        // Cevap anahtarƒ±ndaki sƒ±rayƒ± bul
                        const answerKeyOrder = getAnswerKeyOrder(student.studentId, paperOrder, parentComponentId);
                        
                        // Etkinlik bilgilerini al - Ger√ßek etkinlik adƒ±nƒ± g√∂ster
                        const activityName = actualQuestion?.name || `Etkinlik ${answerKeyOrder || paperOrder}`;
                        const questionDescription = actualQuestion?.description || actualQuestion?.name || '-';
                        const questionPointsForGroup = getQuestionPointsForStudentGroup(student.studentId, actualQuestionId, parentComponentId);
                        const maxPoints = questionPointsForGroup || actualQuestion?.points || 0;
                        const studentOutcomes = getQuestionOutcomesForStudent(student.studentId, actualQuestionId, parentComponentId);
                        
                        return `
                            <tr data-student-id="${student.studentId}" data-paper-order="${paperOrder}" data-component-id="${parentComponentId}">
                        <td class="col-no">${index + 1}</td>
                        <td class="col-studentId">${student.studentId}</td>
                        <td class="col-name">${student.name}</td>
                        <td class="col-surname">${student.surname}</td>
                        <td class="col-email email-cell">
                            <span class="email-text" title="${student.email || 'E-posta bulunamadƒ±'}">${student.email || '-'}</span>
                            ${student.email ? `<button class="email-button" title="E-posta g√∂nder" onclick="openEmailModal({studentId: '${student.studentId}', name: '${student.name}', surname: '${student.surname}', email: '${student.email}'})">E-posta</button>` : ''}
                        </td>
                        <td class="col-group">
                            <select class="group-selector compact" data-student-id="${student.studentId}" data-component-id="${parentComponentId}" onchange="updateStudentGroupForComponent(this)">
                                ${groupOptions}
                            </select>
                        </td>
                        <td class="col-answerKey answer-key-order-cell">
                            <span class="answer-key-badge" data-answer-key="${answerKeyOrder}" data-question-id="${actualQuestionId}">
                                ${answerKeyOrder}
                            </span>
                        </td>
                        <td class="col-activityName question-name-cell">
                            <span class="question-name-badge">${activityName}</span>
                        </td>
                        <td class="col-description question-description-cell">
                            <span class="question-desc-badge" title="${questionDescription}">${questionDescription}</span>
                        </td>
                        <td class="col-maxPoints question-points-cell" data-student-id="${student.studentId}" data-activity-id="${actualQuestionId}">
                            ${maxPoints}
                        </td>
                        <td class="col-totalPoints total-points-cell" data-student-id="${student.studentId}" data-component-id="${parentComponentId}">
                            <div class="total-points-container">
                                <span class="total-points-value">${getStudentTotalEarnedPointsForComponent(student.studentId, parentComponentId)}</span>
                                <button class="auto-distribute-btn" type="button" 
                                        data-student-id="${student.studentId}" 
                                        data-activity-id="${parentComponentId}"
                                        title="Otomatik puan daƒüƒ±t">
                                    üéØ
                                </button>
                            </div>
                        </td>
                        <td class="col-outcomes outcomes-cell">
                            <span class="outcomes-badge">${Array.isArray(studentOutcomes) ? studentOutcomes.join(', ') : (studentOutcomes || '-')}</span>
                        </td>
                        <td class="col-earnedPoints">
                            <input type="number" min="0" max="100" 
                                data-student-id="${student.studentId}" 
                                data-activity-id="${actualQuestionId}"
                                data-paper-order="${paperOrder}"
                                value="${getStudentGrade(student.studentId, actualQuestionId) || ''}"
                                onchange="updateStudentGrade(this)"
                                placeholder="0-${maxPoints}"
                                title="${useGroupSystem ? `Kaƒüƒ±t sƒ±rasƒ±: ${paperOrder}, Cevap anahtarƒ±: ${answerKeyOrder}, Maksimum puan: ${maxPoints}` : `Maksimum puan: ${maxPoints}`}"
                            >
                        </td>
                        <td class="col-termGrade grade-summary-cell term-grade">${calculateStudentGrades(student.studentId).termGrade}</td>
                        <td class="col-finalGrade grade-summary-cell final-grade">${calculateStudentGrades(student.studentId).finalGrade}</td>
                        <td class="col-average grade-summary-cell total-grade">${calculateStudentGrades(student.studentId).totalGrade}</td>
                        <td class="col-letterGrade grade-summary-cell letter-grade ${getLetterGradeClass(calculateStudentGrades(student.studentId).letterGrade)}">${calculateStudentGrades(student.studentId).letterGrade}</td>
                    </tr>
                        `;
                    }).join('')}
            </tbody>
        `;
            
            table.innerHTML = tableHTML;
            paperSection.appendChild(table);
            subDiv.appendChild(paperSection);
        }
        
        container.appendChild(subDiv);
        
        // ƒ∞LK Y√úKLEME SONRASI GRUP BAZLI G√úNCELLEMELERƒ∞ YAP
        // Her √∂ƒürenci i√ßin grup bazlƒ± bilgileri g√ºncelle (combobox deƒüi≈üimi sim√ºlasyonu)
        if (APP_STATE.studentData && APP_STATE.studentData.length > 0) {
            setTimeout(() => {
                console.log('üîÑ ƒ∞lk y√ºkleme sonrasƒ± grup bazlƒ± g√ºncellemeler ba≈ülatƒ±lƒ±yor...');
                APP_STATE.studentData.forEach(student => {
                    const studentGroup = getStudentGroupForComponent(student.studentId, parentComponentId);
                    if (studentGroup) {
                        // Grup deƒüi≈üikliƒüi fonksiyonunu sim√ºle et - sadece soru bilgilerini g√ºncelle
                        updateQuestionInfoForComponent(student.studentId, studentGroup, parentComponentId);
                    }
                });
                console.log('‚úÖ ƒ∞lk y√ºkleme grup bazlƒ± g√ºncellemeleri tamamlandƒ±');
            }, 100); // Kƒ±sa gecikme ile DOM'un hazƒ±r olmasƒ±nƒ± bekle
        }
        
        // GUID sistemi kaldƒ±rƒ±ldƒ±
    } catch (error) {
        console.error("Alt √∂ƒüe giri≈ü b√∂l√ºm√º olu≈üturulurken hata olu≈ütu:", error);
    }
}

/**
 * Test giri≈ü modunu deƒüi≈ütirme
 * @param {string} testId - Test ID'si
 * @param {string} mode - Mod (detailed/simple)
 */
function switchTestInputMode(testId, mode) {
    try {
        // Mod butonlarƒ±nƒ± g√ºncelle
        document.querySelectorAll(`.input-mode[data-test-id="${testId}"]`).forEach(btn => {
            if (btn.dataset.mode === mode) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
        
        // Giri≈ü formlarƒ±nƒ± g√∂ster/gizle
        const detailedForm = document.querySelector(`.test-input-form.detailed-mode[data-test-id="${testId}"]`);
        const simpleForm = document.querySelector(`.test-input-form.simple-mode[data-test-id="${testId}"]`);
        
        if (mode === 'detailed') {
            detailedForm.style.display = 'block';
            simpleForm.style.display = 'none';
        } else {
            detailedForm.style.display = 'none';
            simpleForm.style.display = 'block';
        }
    } catch (error) {
        console.error("Test giri≈ü modu deƒüi≈ütirilirken hata olu≈ütu:", error);
    }
}

/**
 * √ñƒürenci notunu getirme - v5 formatƒ±nƒ± tam destekler
 * @param {string} studentId - √ñƒürenci ID'si
 * @param {string} activityId - Etkinlik ID'si
 * @returns {number|null} - Not deƒüeri
 */
function getStudentGrade(studentId, activityId) {
    if (!APP_STATE.gradesData || !APP_STATE.gradesData[studentId]) return null;
    
    const studentGrades = APP_STATE.gradesData[studentId];
    const activity = findNodeById(activityId);
    
    // Kaƒüƒ±t sƒ±rasƒ± bazlƒ± eri≈üim
    const parts = activityId.split('.');
    if (parts.length > 1) {
        const parentId = parts[0]; // A1.1 -> A1
        
        // Kaƒüƒ±t pozisyonunu bul
        const activity_parent = findNodeById(parentId);
        if (activity_parent && activity_parent.children && studentGrades[parentId]) {
            const questionIndex = activity_parent.children.findIndex(child => child.id === activityId);
            if (questionIndex !== -1) {
                const position = (questionIndex + 1).toString();
                const gradeInfo = studentGrades[parentId][position];
                if (gradeInfo && gradeInfo.puan !== undefined) {
                    return gradeInfo.puan;
                }
            }
        }
    }
    
    // DURUM 1: Doƒürudan eri≈üim (geriye uyumluluk)
    if (studentGrades[activityId] !== undefined) {
        const grade = studentGrades[activityId];
        
        // Sayƒ±sal deƒüer
        if (typeof grade === 'number') {
            return grade;
        }
        
        // Test notu (object formatƒ±nda)
        if (typeof grade === 'object' && grade !== null) {
            // Test tipi
            if (grade.tip === 'test' && activity && activity.type === 'Test') {
                const correct = grade.dogru || 0;
                const wrong = grade.yanlis || 0;
                return correct * (activity.testDetails?.correctWeight || 5) - 
                       wrong * Math.abs(activity.testDetails?.wrongPenalty || 0);
            }
        }
    }
    
    // DURUM 2: ƒ∞√ß i√ße yapƒ± kontrol√º (eski format uyumluluƒüu)
    if (parts.length > 1) {
        const parentId = parts[0]; // A1.1 -> A1
        const shortId = parts[parts.length - 1]; // A1.1 -> 1
        
        if (studentGrades[parentId] && typeof studentGrades[parentId] === 'object') {
            // Tam ID ile eri≈üim
            if (studentGrades[parentId][activityId] !== undefined) {
                // Test notu
                if (typeof studentGrades[parentId][activityId] === 'object' && 
                    studentGrades[parentId][activityId] !== null && 
                    studentGrades[parentId][activityId].tip === 'test') {
                    
                    const testScore = studentGrades[parentId][activityId];
                    const correct = testScore.dogru || 0;
                    const wrong = testScore.yanlis || 0;
                    
                    if (activity && activity.type === 'Test') {
                        return correct * (activity.testDetails?.correctWeight || 5) - 
                               wrong * Math.abs(activity.testDetails?.wrongPenalty || 0);
                    }
                }
                // Normal not
                else if (typeof studentGrades[parentId][activityId] === 'number') {
                    return studentGrades[parentId][activityId];
                }
            }
            
            // Kƒ±sa ID ile eri≈üim (A1.1 -> sadece 1)
            if (studentGrades[parentId][shortId] !== undefined) {
                // Test notu
                if (typeof studentGrades[parentId][shortId] === 'object' && 
                    studentGrades[parentId][shortId] !== null && 
                    studentGrades[parentId][shortId].tip === 'test') {
                    
                    const testScore = studentGrades[parentId][shortId];
                    const correct = testScore.dogru || 0;
                    const wrong = testScore.yanlis || 0;
                    
                    if (activity && activity.type === 'Test') {
                        return correct * (activity.testDetails?.correctWeight || 5) - 
                               wrong * Math.abs(activity.testDetails?.wrongPenalty || 0);
                    }
                }
                // Normal not
                else if (typeof studentGrades[parentId][shortId] === 'number') {
                    return studentGrades[parentId][shortId];
                }
            }
        }
    }
    
    return null;
}

/**
 * Aktivite ID'sinden soru numarasƒ±nƒ± √ßƒ±karma
 * @param {string} activityId - Aktivite ID'si (√∂rn: A1.1, A1.2)
 * @returns {string|null} - Soru numarasƒ± (√∂rn: "1", "2")
 */
function getQuestionNumberFromActivity(activityId) {
    // A1.1 -> "1", A1.2 -> "2", F1.1 -> "1" 
    const parts = activityId.split('.');
    if (parts.length >= 2) {
        return parts[parts.length - 1]; // Son kƒ±smƒ± al
    }
    return null;
}

/**
 * Aktivite ID'sinden ana bile≈üen ID'sini √ßƒ±karma (√∂rn: A1.1 ‚Üí A1)
 * @param {string} activityId - Aktivite ID'si
 * @returns {string|null} - Ana bile≈üen ID'si
 */
// ƒ∞lk getParentComponentId fonksiyonu kaldƒ±rƒ±ldƒ± - geli≈ümi≈ü versiyon korundu

/**
 * Bile≈üen i√ßin grup bilgilerini formatlanmƒ±≈ü string olarak getir
 * @param {string} componentId - Ana bile≈üen ID'si (A1, F1, vb)
 * @param {string} questionId - Soru ID'si
 * @returns {string} - Formatlanmƒ±≈ü grup bilgileri
 */
function getComponentGroupInfo(componentId, questionId) {
    try {
        if (!APP_STATE.courseData?.grupHaritalari?.[componentId]) {
            return `Grup Bilgisi: A (Varsayƒ±lan grup - hi√ß grup tanƒ±mlanmamƒ±≈ü)`;
        }
        
        const componentGroups = APP_STATE.courseData.grupHaritalari[componentId];
        const groups = componentGroups.gruplar || ['A'];
        const mappings = componentGroups.haritalar || {};
        
        let infoText = `Gruplar: ${groups.join(', ')}\n`;
        
        // Her grup i√ßin bu sorunun haritalama bilgisini g√∂ster
        groups.forEach(groupName => {
            if (mappings[groupName]) {
                // D√úZELTME: Veri yapƒ±sƒ± {position: questionId} formatƒ±nda
                const position = Object.keys(mappings[groupName]).find(pos => mappings[groupName][pos] === questionId);
                if (position) {
                    infoText += `Grup ${groupName}: Soru ${position} | `;
                } else {
                    infoText += `Grup ${groupName}: Haritalanmamƒ±≈ü | `;
                }
            } else {
                infoText += `Grup ${groupName}: Haritalanmamƒ±≈ü | `;
            }
        });
        
        // Son | karakterini kaldƒ±r
        if (infoText.endsWith(' | ')) {
            infoText = infoText.slice(0, -3);
        }
        
        return infoText;
    } catch (error) {
        console.error("Grup bilgileri olu≈üturulurken hata:", error);
        return "Grup bilgisi y√ºklenirken hata olu≈ütu";
    }
}

/**
 * √ñƒürencinin grubuna g√∂re belirli bir sorunun puanƒ±nƒ± getir
 * @param {string} studentId - √ñƒürenci ID'si
 * @param {string} activityId - Aktivite ID'si
 * @param {string} componentId - Bile≈üen ID'si
 * @returns {number} - Sorunun puanƒ±
 */
function getQuestionPointsForStudentGroup(studentId, activityId, componentId) {
    try {
        const studentGroup = getStudentGroupForComponent(studentId, componentId);
        
        console.log(`üîç getQuestionPointsForStudentGroup DEBUG:`);
        console.log(`  - studentId: ${studentId}`);
        console.log(`  - activityId: ${activityId}`);
        console.log(`  - componentId: ${componentId}`);
        console.log(`  - studentGroup: ${studentGroup}`);
        
        // Grup haritalama verilerini al
        const componentGroupData = APP_STATE.courseData?.grupHaritalari?.[componentId];
        if (!componentGroupData || !componentGroupData.haritalar || !componentGroupData.haritalar[studentGroup]) {
            // Grup haritalama yoksa, sorunun orijinal puanƒ±nƒ± d√∂nd√ºr
            const activity = findNodeById(activityId);
            console.log(`  - Grup haritalama yok, orijinal puan: ${activity ? activity.points : 0}`);
            return activity ? activity.points : 0;
        }
        
        // Bu √∂ƒürencinin grubundaki bu sorunun kaƒüƒ±t √ºzerindeki sƒ±rasƒ±nƒ± bul
        // Grup haritalama formatƒ± kontrol et: {position: questionId} VEYA {questionId: position}
        const groupMappings = componentGroupData.haritalar[studentGroup];
        let paperQuestionOrder = null;
        
        console.log(`  - groupMappings:`, groupMappings);
        
        // Format 1: {position: questionId} - Doƒüru position deƒüerini bul
        if (Object.values(groupMappings).includes(activityId)) {
            const position = Object.keys(groupMappings).find(pos => groupMappings[pos] === activityId);
            paperQuestionOrder = parseInt(position);
            console.log(`  - Format 1 kullanƒ±ldƒ±, position: ${position}, paperQuestionOrder: ${paperQuestionOrder}`);
        }
        // Format 2: {questionId: position} - Eski format
        else if (groupMappings[activityId]) {
            paperQuestionOrder = parseInt(groupMappings[activityId]);
            console.log(`  - Format 2 kullanƒ±ldƒ±, paperQuestionOrder: ${paperQuestionOrder}`);
        }
        
        if (!paperQuestionOrder) {
            // Haritalama yoksa, sorunun orijinal puanƒ±nƒ± d√∂nd√ºr
            const activity = findNodeById(activityId);
            console.log(`  - PaperQuestionOrder bulunamadƒ±, orijinal puan: ${activity ? activity.points : 0}`);
            return activity ? activity.points : 0;
        }
        
        // Aynƒ± bile≈üendeki t√ºm sorularƒ± al ve sƒ±rala
        const component = findNodeById(componentId);
        if (!component || !component.children) {
            const activity = findNodeById(activityId);
            return activity ? activity.points : 0;
        }
        
        // Sorularƒ± orijinal sƒ±ralarƒ±na g√∂re sƒ±rala
        const questions = component.children
            .filter(child => isQuestionType(child.type) || isRubricType(child.type))
            .sort((a, b) => {
                const aNum = parseInt(a.id.split('.').pop());
                const bNum = parseInt(b.id.split('.').pop());
                return aNum - bNum;
            });
        
        // Kaƒüƒ±t sƒ±rasƒ±ndaki sorunun puanƒ±nƒ± al
        if (paperQuestionOrder >= 1 && paperQuestionOrder <= questions.length) {
            const targetQuestion = questions[paperQuestionOrder - 1]; // Array 0-indexed
            return targetQuestion.points;
        }
        
        // Hata durumunda orijinal sorunun puanƒ±nƒ± d√∂nd√ºr
        const activity = findNodeById(activityId);
        return activity ? activity.points : 0;
        
    } catch (error) {
        console.error("Grup bazlƒ± etkinlik max puanƒ± hesaplanƒ±rken hata:", error);
        const activity = findNodeById(activityId);
        return activity ? activity.points : 0;
    }
}

/**
 * Grup bazlƒ± not hesaplama
 * @param {string} studentId - √ñƒürenci ID'si
 * @param {string} activityId - Aktivite ID'si
 * @param {number} rawScore - Ham puan
 * @returns {number} - Hesaplanan not
 */
function calculateGradeBasedOnGroup(studentId, activityId, rawScore) {
    const studentGroup = getStudentGroup(studentId);
    
    // √ñnce bu aktivitenin hangi deƒüerlendirme bile≈üenine ait olduƒüunu bul
    const parentComponentId = getParentComponentId(activityId);
    if (!parentComponentId) {
        return rawScore;
    }
    
    // Bu deƒüerlendirme bile≈üeninin grup haritasƒ±nƒ± al
    const componentGroupData = APP_STATE.courseData?.grupHaritalari?.[parentComponentId];
    if (!componentGroupData || !componentGroupData.haritalar || !componentGroupData.haritalar[studentGroup]) {
        return rawScore;
    }
    
    // D√úZELTME: Veri yapƒ±sƒ± {position: questionId} formatƒ±nda
    const groupMappings = componentGroupData.haritalar[studentGroup];
    const position = Object.keys(groupMappings).find(pos => groupMappings[pos] === activityId);
    
    // Eƒüer bu aktivite i√ßin grup haritasƒ± yoksa, ham puanƒ± d√∂nd√ºr
    if (!position) {
        return rawScore;
    }
    
    console.log(`Grup bazlƒ± hesaplama: √ñƒürenci ${studentId} (Grup: ${studentGroup}), Aktivite ${activityId} ‚Üí Soru ${position}`);
    
    // Ham puanlardan doƒüru sƒ±radaki puanƒ± al
    const hamPuanlar = APP_STATE.gradesData[studentId]?.hamPuanlar;
    if (hamPuanlar && hamPuanlar[position]) {
        return hamPuanlar[position];
    }
    
    return rawScore;
}

/**
 * Grup deƒüi≈ütiƒüinde √∂ƒürencinin t√ºm notlarƒ±nƒ± yeniden hesapla
 * @param {string} studentId - √ñƒürenci ID'si
 * @param {string} newGroupId - Yeni grup ID'si
 */
function recalculateGradesForGroupChange(studentId, newGroupId) {
    if (!APP_STATE.gradesData[studentId] || !APP_STATE.gradesData[studentId].hamPuanlar) {
        console.log(`√ñƒürenci ${studentId} i√ßin ham puan verisi bulunamadƒ±`);
        return;
    }
    
    const hamPuanlar = APP_STATE.gradesData[studentId].hamPuanlar;
    console.log(`Grup deƒüi≈üimi: √ñƒürenci ${studentId} ‚Üí Grup ${newGroupId}. Ham puanlar:`, hamPuanlar);
    
    // T√ºm aktiviteler i√ßin notlarƒ± yeniden hesapla
    const allActivities = getAllQuestionActivities();
    
    allActivities.forEach(activityId => {
        const questionNumber = getQuestionNumberFromActivity(activityId);
        if (questionNumber && hamPuanlar[questionNumber]) {
            const rawScore = hamPuanlar[questionNumber];
            const calculatedGrade = calculateGradeBasedOnGroup(studentId, activityId, rawScore);
            
            // Hesaplanan notu g√ºncelle
            APP_STATE.gradesData[studentId][activityId] = calculatedGrade;
            
            console.log(`Yeniden hesaplama: ${activityId} ‚Üí Ham: ${rawScore}, Hesaplanan: ${calculatedGrade}`);
            
            // UI'daki input alanlarƒ±nƒ± g√ºncelle
            const inputs = document.querySelectorAll(`input[data-student-id="${studentId}"][data-activity-id="${activityId}"]`);
            inputs.forEach(input => {
                input.value = calculatedGrade;
            });
        }
    });
    
    console.log(`√ñƒürenci ${studentId} i√ßin grup bazlƒ± notlar yeniden hesaplandƒ±`);
}

/**
 * T√ºm soru aktivitelerini getir
 * @returns {Array<string>} - Aktivite ID'leri
 */
function getAllQuestionActivities() {
    const activities = [];
    
    function collectActivities(nodes) {
        nodes.forEach(node => {
            if (node.children && node.children.length > 0) {
                collectActivities(node.children);
            } else if (isQuestionType(node.type)) {
                activities.push(node.id);
            }
        });
    }
    
    collectActivities(APP_STATE.assessmentTree);
    return activities;
}

/**
 * T√ºm √∂ƒürenciler i√ßin grup bazlƒ± hesaplama yap (JSON import sonrasƒ±)
 */
function recalculateAllGradesBasedOnGroups() {
    if (!APP_STATE.studentData || !APP_STATE.gradesData) {
        console.log('√ñƒürenci verileri veya not verileri bulunamadƒ±');
        return;
    }
    
    console.log('T√ºm √∂ƒürenciler i√ßin grup bazlƒ± hesaplama ba≈ülatƒ±lƒ±yor...');
    
    APP_STATE.studentData.forEach(student => {
        const studentId = student.studentId;
        const studentGrades = APP_STATE.gradesData[studentId];
        
        if (!studentGrades) {
            console.log(`√ñƒürenci ${studentId} i√ßin not verisi bulunamadƒ±`);
            return;
        }
        
        // Eƒüer ham puanlar varsa, grup bazlƒ± hesaplama yap
        if (studentGrades.hamPuanlar) {
            console.log(`√ñƒürenci ${studentId} i√ßin ham puanlar bulundu:`, studentGrades.hamPuanlar);
            recalculateGradesForGroupChange(studentId, student.grup);
        } else {
            // Ham puanlar yoksa, mevcut notlardan ham puanlarƒ± √ßƒ±karmaya √ßalƒ±≈ü
            console.log(`√ñƒürenci ${studentId} i√ßin ham puanlar bulunamadƒ±, mevcut notlardan √ßƒ±karƒ±lmaya √ßalƒ±≈üƒ±lƒ±yor`);
            extractRawScoresFromExistingGrades(studentId);
        }
    });
    
    console.log('Grup bazlƒ± hesaplama tamamlandƒ±');
}

/**
 * Mevcut notlardan ham puanlarƒ± √ßƒ±karma (geriye d√∂n√ºk uyumluluk)
 * @param {string} studentId - √ñƒürenci ID'si
 */
function extractRawScoresFromExistingGrades(studentId) {
    const studentGrades = APP_STATE.gradesData[studentId];
    if (!studentGrades) return;
    
    // Ham puanlar objesi olu≈ütur
    if (!studentGrades.hamPuanlar) {
        studentGrades.hamPuanlar = {};
    }
    
    // T√ºm aktiviteler i√ßin ham puanlarƒ± √ßƒ±kar
    const allActivities = getAllQuestionActivities();
    
    allActivities.forEach(activityId => {
        const grade = studentGrades[activityId];
        const questionNumber = getQuestionNumberFromActivity(activityId);
        
        if (grade !== undefined && questionNumber && !studentGrades.hamPuanlar[questionNumber]) {
            // Mevcut notu ham puan olarak kabul et
            if (typeof grade === 'number') {
                studentGrades.hamPuanlar[questionNumber] = grade;
                console.log(`Ham puan √ßƒ±karƒ±ldƒ±: √ñƒürenci ${studentId}, Soru ${questionNumber} = ${grade}`);
            }
        }
    });
    
    // Ham puanlar √ßƒ±karƒ±ldƒ±ktan sonra grup bazlƒ± hesaplama yap
    const student = APP_STATE.studentData.find(s => s.studentId === studentId);
    if (student) {
        recalculateGradesForGroupChange(studentId, student.grup);
    }
}

/**
 * √ñƒürenci test notunu getirme
 * @param {string} studentId - √ñƒürenci ID'si
 * @param {string} testId - Test ID'si
 * @returns {Object|null} - Test notlarƒ±
 */
function getStudentTestScore(studentId, testId) {
    if (!APP_STATE.gradesData[studentId] || !APP_STATE.gradesData[studentId][testId]) return null;
    
    const testGrade = APP_STATE.gradesData[studentId][testId];
    if (testGrade.type === 'test' || testGrade.tip === 'test') {
        return {
            type: 'test',
            correct: testGrade.correct || testGrade.dogru || 0,
            wrong: testGrade.wrong || testGrade.yanlis || 0
        };
    }
    
    // Test deƒüilse null d√∂n
    return null;
}

/**
 * courseData.ogrenciNotlari yapƒ±sƒ±nƒ± g√ºncelle (export i√ßin gerekli)
 */
function updateCourseDataGrades(studentId, activityId, value) {
    try {
        // courseData yapƒ±sƒ±nƒ± kontrol et
        if (!APP_STATE.courseData) {
            APP_STATE.courseData = {};
        }
        if (!APP_STATE.courseData.ogrenciNotlari) {
            APP_STATE.courseData.ogrenciNotlari = {};
        }
        if (!APP_STATE.courseData.ogrenciNotlari[studentId]) {
            APP_STATE.courseData.ogrenciNotlari[studentId] = {
                grupBilgileri: {}
            };
        }
        
        // Aktiviteyi bul
        const activity = findNodeById(activityId);
        if (!activity) {
            console.warn(`updateCourseDataGrades: Aktivite bulunamadƒ±: ${activityId}`);
            return;
        }
        
        // Alt aktivite (A1.1 gibi) ise √ºst aktivite altƒ±nda pozisyon bazlƒ± g√ºncelle
        const parts = activityId.split('.');
        if (parts.length > 1) {
            const parentId = parts[0]; // A1
            const parentActivity = findNodeById(parentId);
            
            if (parentActivity && parentActivity.children) {
                // Alt aktivitenin pozisyonunu bul
                const questionIndex = parentActivity.children.findIndex(child => child.id === activityId);
                if (questionIndex !== -1) {
                    const position = (questionIndex + 1).toString(); // 1, 2, 3, ...
                    
                    // courseData'da √ºst aktivite yapƒ±sƒ±nƒ± olu≈ütur
                    if (!APP_STATE.courseData.ogrenciNotlari[studentId][parentId]) {
                        APP_STATE.courseData.ogrenciNotlari[studentId][parentId] = {};
                    }
                    
                    // Kaƒüƒ±t sƒ±rasƒ±na g√∂re puan kaydet (soruId dinamik hesaplanacak)
                    APP_STATE.courseData.ogrenciNotlari[studentId][parentId][position] = {
                        puan: parseFloat(value) || 0
                    };
                    
                    console.log(`Puan g√ºncellendi: ${studentId} - ${parentId} pozisyon ${position} = ${value} puan`);
                }
            }
        }
        
        // Grup bilgilerini g√ºncelle (gerekirse)
        const componentId = getParentComponentId(activityId);
        if (componentId) {
            if (!APP_STATE.courseData.ogrenciNotlari[studentId].grupBilgileri) {
                APP_STATE.courseData.ogrenciNotlari[studentId].grupBilgileri = {};
            }
            
            // Eƒüer grup bilgisi yoksa varsayƒ±lan 'A' grubunu ata
            if (!APP_STATE.courseData.ogrenciNotlari[studentId].grupBilgileri[componentId]) {
                APP_STATE.courseData.ogrenciNotlari[studentId].grupBilgileri[componentId] = 'A';
            }
        }
        
    } catch (error) {
        console.error("courseData.ogrenciNotlari g√ºncellenirken hata:", error);
    }
}

/**
 * √ñƒürenci notunu g√ºncelleme - Ham puan saklama sistemi
 * @param {HTMLInputElement} input - Not input elementi
 */
function updateStudentGrade(input) {
    try {
        const studentId = input.dataset.studentId;
        const activityId = input.dataset.activityId;
        
        // Aktiviteyi bul ve maksimum puanƒ±nƒ± kontrol et
        const activity = findNodeById(activityId);
        if (!activity) {
            console.error(`Aktivite bulunamadƒ±: ${activityId}`);
            return;
        }
        
        // Maksimum puan kontrol√º - G√∂rsel uyarƒ± sistemi
        const maxPoints = activity.points || 100;
        let value = parseFloat(input.value) || 0;
        
        // Maksimum puanƒ± a≈üan deƒüerler i√ßin g√∂rsel uyarƒ± (deƒüeri deƒüi≈ütirmeden)
        if (value > maxPoints) {
            input.style.borderColor = '#ff6b6b';
            input.style.backgroundColor = '#fff5f5';
            input.title = `‚ö†Ô∏è Girilen puan (${value}) maksimum puandan (${maxPoints}) b√ºy√ºk!`;
            // Deƒüeri deƒüi≈ütirmiyoruz, sadece uyarƒ± veriyoruz
        } else {
            input.style.borderColor = '';
            input.style.backgroundColor = '';
            input.title = `Maksimum puan: ${maxPoints}`;
        }
        
        // √ñƒürenci verisi olu≈ütur
        if (!APP_STATE.gradesData[studentId]) {
            APP_STATE.gradesData[studentId] = {};
        }
        
        // v5 FORMAT: Pozisyon bazlƒ± not saklama
        const parts = activityId.split('.');
        if (parts.length > 1) {
            const parentId = parts[0]; // A1.1 -> A1
            
            // Kaƒüƒ±t pozisyonunu bul ve puanƒ± kaydet
            const activity_parent = findNodeById(parentId);
            if (activity_parent && activity_parent.children) {
                const questionIndex = activity_parent.children.findIndex(child => child.id === activityId);
                if (questionIndex !== -1) {
                    const position = (questionIndex + 1).toString();
                    
                    if (!APP_STATE.gradesData[studentId][parentId]) {
                        APP_STATE.gradesData[studentId][parentId] = {};
                    }
                    
                    // Kaƒüƒ±t sƒ±rasƒ±na g√∂re puanƒ± kaydet
                    APP_STATE.gradesData[studentId][parentId][position] = {
                        puan: value
                    };
                    
                    console.log(`Puan kaydedildi: ${studentId} - ${parentId} pozisyon ${position} = ${value} puan`);
                }
            }
        }
        
        // Geriye uyumluluk i√ßin doƒürudan eri≈üim de saƒüla
        APP_STATE.gradesData[studentId][activityId] = value;
        
        // courseData'yƒ± da g√ºncelle
        updateCourseDataGrades(studentId, activityId, value);
        
        // Test mi kontrol et
        if (activity && activity.type === 'Test') {
            // Test skorlarƒ± i√ßin √∂zel i≈ülem
            const correctWeight = activity.testDetails?.correctWeight || 5;
            const wrongPenalty = Math.abs(activity.testDetails?.wrongPenalty || 0);
            
            // Basit yakla≈üƒ±m: t√ºm puanƒ± doƒüru sorudan gelecek ≈üekilde ayarla
            const correctEstimate = Math.round(value / correctWeight);
            
            APP_STATE.gradesData[studentId][activityId] = {
                tip: 'test',
                dogru: correctEstimate,
                yanlis: 0
            };
            
            // Test i√ßin de courseData g√ºncelle
            updateCourseDataGrades(studentId, activityId, value);
            
            // Detaylƒ± formdaki deƒüerleri g√ºncelle (varsa)
            const correctInput = document.querySelector(`input[data-student-id="${studentId}"][data-test-id="${activityId}"][data-field="correct"]`);
            const wrongInput = document.querySelector(`input[data-student-id="${studentId}"][data-test-id="${activityId}"][data-field="wrong"]`);
            
            if (correctInput) correctInput.value = correctEstimate;
            if (wrongInput) wrongInput.value = 0;
            
            // √ñƒürenci bazlƒ± g√∂r√ºn√ºmdeki inputlarƒ± da g√ºncelle
            const studentViewCorrectInput = document.querySelector(`#studentGradesContainer input[data-student-id="${studentId}"][data-test-id="${activityId}"][data-field="correct"]`);
            const studentViewWrongInput = document.querySelector(`#studentGradesContainer input[data-student-id="${studentId}"][data-test-id="${activityId}"][data-field="wrong"]`);
            const studentViewTotalElement = document.querySelector(`#studentGradesContainer .student-test-item[data-subitem-id="${activityId}"] .total-test-score`);
            
            if (studentViewCorrectInput) studentViewCorrectInput.value = correctEstimate;
            if (studentViewWrongInput) studentViewWrongInput.value = 0;
            if (studentViewTotalElement) studentViewTotalElement.textContent = value.toFixed(2);
            
        } else {
            // Normal not kaydƒ±
            APP_STATE.gradesData[studentId][activityId] = value;
            
            // Toplama hesapla (eƒüer parent varsa)
            const parts = activityId.split('.');
            if (parts.length > 1) {
                const parentId = parts[0]; // A1
                updateParentActivityTotal(studentId, parentId);
            }
            
            // √ñƒürenci bazlƒ± g√∂r√ºn√ºmdeki inputu g√ºncelle
            const studentViewInput = document.querySelector(`#studentGradesContainer input[data-student-id="${studentId}"][data-activity-id="${activityId}"]`);
            if (studentViewInput && studentViewInput !== input) {
                studentViewInput.value = value;
            }
        }
        
        // Notlarƒ± hesapla
        updateStudentCalculatedGrade(studentId);
        
        // Assessment tablosundaki not √∂zeti h√ºcrelerini g√ºncelle
        updateAssessmentGradeSummary(studentId);
        
        // √ñƒürenci √∂zet bilgilerini g√ºncelle
        updateStudentSummary(studentId);
        
        // Toplam puan h√ºcrelerini g√ºncelle
        updateTotalPointsForStudent(studentId, activityId);
        
        // Otomatik kayƒ±t trigger
        if (autoSaveManager) {
            autoSaveManager.hasUnsavedChanges = true;
            autoSaveManager.updateFloatingButton('unsaved');
        }
        
        // OTOMATIK PUAN DAƒûIT BUTONLARINI G√úNCELLE
        setTimeout(() => {
            addAutoDistributeButtonsToTables();
        }, 50);
        
    } catch (error) {
        console.error("√ñƒürenci notu g√ºncellenirken hata olu≈ütu:", error);
        showModernToast("Not g√ºncellenirken hata olu≈ütu!", "error");
    }
}

/**
 * T√ºm √∂ƒürencilerin final notlarƒ±nƒ± hesapla ve kaydet
 */
function calculateFinalGrades() {
    try {
        if (!APP_STATE.studentData || APP_STATE.studentData.length === 0) {
            return;
        }
        
        // Her √∂ƒürenci i√ßin notlarƒ± hesapla
        APP_STATE.studentData.forEach(student => {
            const studentId = student.studentId;
            
            if (!APP_STATE.gradesData[studentId]) {
                APP_STATE.gradesData[studentId] = {};
            }
            
            // Yarƒ±yƒ±l i√ßi etkinlikler
            const termActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('A'));
            let termGrade = 0;
            
            // ƒ∞√ß aƒüƒ±rlƒ±k toplamƒ±
            const termInternalTotal = termActivities.reduce((sum, node) => sum + parseFloat(node.weight || 0), 0);
            
            if (termInternalTotal > 0) {
                termActivities.forEach(activity => {
                    // ƒ∞√ß aƒüƒ±rlƒ±k normalle≈ütirmesi
                    const activityWeight = activity.weight / termInternalTotal; 
                    let activityGrade = 0;
                    
                    if (activity.children && activity.children.length > 0) {
                        // Alt etkinlikler
                        const childrenTotalWeight = activity.children.reduce((sum, child) => sum + parseFloat(child.weight || 0), 0);
                        
                        if (childrenTotalWeight > 0) {
                            activity.children.forEach(subItem => {
                                // Alt √∂ƒüe aƒüƒ±rlƒ±k normalle≈ütirmesi
                                const subItemWeight = subItem.weight / childrenTotalWeight; 
                            const grade = getStudentGrade(studentId, subItem.id) || 0;
                                const scaledGrade = (grade / (subItem.points || 1)) * 100; // 100 √ºzerinden
                                activityGrade += scaledGrade * subItemWeight;
                            });
                        }
                    } else {
                        // Basit etkinlik
                        const grade = getStudentGrade(studentId, activity.id) || 0;
                        activityGrade = (grade / (activity.points || 1)) * 100; // 100 √ºzerinden
                    }
                    
                    termGrade += activityGrade * activityWeight;
                });
            }
            
            // Yarƒ±yƒ±l sonu etkinlikler
            const finalActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('F'));
            let finalGrade = 0;
            
            // ƒ∞√ß aƒüƒ±rlƒ±k toplamƒ±
            const finalInternalTotal = finalActivities.reduce((sum, node) => sum + parseFloat(node.weight || 0), 0);
            
            if (finalInternalTotal > 0) {
                finalActivities.forEach(activity => {
                    // ƒ∞√ß aƒüƒ±rlƒ±k normalle≈ütirmesi
                    const activityWeight = activity.weight / finalInternalTotal;
                    let activityGrade = 0;
                    
                    if (activity.children && activity.children.length > 0) {
                        // Alt etkinlikler
                        const childrenTotalWeight = activity.children.reduce((sum, child) => sum + parseFloat(child.weight || 0), 0);
                        
                        if (childrenTotalWeight > 0) {
                            activity.children.forEach(subItem => {
                                // Alt √∂ƒüe aƒüƒ±rlƒ±k normalle≈ütirmesi
                                const subItemWeight = subItem.weight / childrenTotalWeight;
                            const grade = getStudentGrade(studentId, subItem.id) || 0;
                                const scaledGrade = (grade / (subItem.points || 1)) * 100; // 100 √ºzerinden
                                activityGrade += scaledGrade * subItemWeight;
                            });
                        }
                    } else {
                        // Basit etkinlik
                        const grade = getStudentGrade(studentId, activity.id) || 0;
                        activityGrade = (grade / (activity.points || 1)) * 100; // 100 √ºzerinden
                    }
                    
                    finalGrade += activityGrade * activityWeight;
                });
            }
            
            // Toplam ve harf notu - RTEU Y√∂netmeliƒüi MADDE 26'ya g√∂re
            let totalGrade = (termGrade * APP_STATE.termWeight / 100) + (finalGrade * APP_STATE.finalWeight / 100);
            let letterGrade = getLetterGrade(totalGrade);
            
            // Yarƒ±yƒ±l sonu sƒ±navƒ± 50'nin altƒ±ndaysa FF verilir
            if (finalGrade < 50) {
                letterGrade = 'FF';
            }
            
            // Notlarƒ± kaydet
            APP_STATE.gradesData[studentId].yariyilIciNotu = parseFloat(termGrade.toFixed(2));
            APP_STATE.gradesData[studentId].yariyilSonuNotu = parseFloat(finalGrade.toFixed(2));
            APP_STATE.gradesData[studentId].basariNotu = parseFloat(totalGrade.toFixed(2));
            APP_STATE.gradesData[studentId].harfNotu = letterGrade;
        });
        
    } catch (error) {
        console.error("Final notlarƒ± hesaplanƒ±rken hata olu≈ütu:", error);
    }
}

/**
 * Tek bir √∂ƒürencinin hesaplanmƒ±≈ü notlarƒ±nƒ± g√ºncelleme
 * @param {string} studentId - √ñƒürenci ID'si
 */
function updateStudentCalculatedGrade(studentId) {
    try {
        if (!APP_STATE.gradesData[studentId]) {
            return;
        }
        
        // Yarƒ±yƒ±l i√ßi etkinlikler
        const termActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('A'));
        let termGrade = 0;
        
        // ƒ∞√ß aƒüƒ±rlƒ±k toplamƒ±
        const termInternalTotal = termActivities.reduce((sum, node) => sum + parseFloat(node.weight || 0), 0);
        
        if (termInternalTotal > 0) {
            termActivities.forEach(activity => {
                // ƒ∞√ß aƒüƒ±rlƒ±k normalle≈ütirmesi
                const activityWeight = activity.weight / termInternalTotal; 
                let activityGrade = 0;
                
                if (activity.children && activity.children.length > 0) {
                    // Alt etkinlikler
                    const childrenTotalWeight = activity.children.reduce((sum, child) => sum + parseFloat(child.weight || 0), 0);
                    
                    if (childrenTotalWeight > 0) {
                        activity.children.forEach(subItem => {
                            // Alt √∂ƒüe aƒüƒ±rlƒ±k normalle≈ütirmesi
                            const subItemWeight = subItem.weight / childrenTotalWeight; 
                            const grade = getStudentGrade(studentId, subItem.id) || 0;
                            const scaledGrade = (grade / (subItem.points || 1)) * 100; // 100 √ºzerinden
                            activityGrade += scaledGrade * subItemWeight;
                        });
                    }
                } else {
                    // Basit etkinlik
                    const grade = getStudentGrade(studentId, activity.id) || 0;
                    activityGrade = (grade / (activity.points || 1)) * 100; // 100 √ºzerinden
                }
                
                termGrade += activityGrade * activityWeight;
            });
        }
        
        // Yarƒ±yƒ±l sonu etkinlikler
        const finalActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('F'));
        let finalGrade = 0;
        
        // ƒ∞√ß aƒüƒ±rlƒ±k toplamƒ±
        const finalInternalTotal = finalActivities.reduce((sum, node) => sum + parseFloat(node.weight || 0), 0);
        
        if (finalInternalTotal > 0) {
            finalActivities.forEach(activity => {
                // ƒ∞√ß aƒüƒ±rlƒ±k normalle≈ütirmesi
                const activityWeight = activity.weight / finalInternalTotal;
                let activityGrade = 0;
                
                if (activity.children && activity.children.length > 0) {
                    // Alt etkinlikler
                    const childrenTotalWeight = activity.children.reduce((sum, child) => sum + parseFloat(child.weight || 0), 0);
                    
                    if (childrenTotalWeight > 0) {
                        activity.children.forEach(subItem => {
                            // Alt √∂ƒüe aƒüƒ±rlƒ±k normalle≈ütirmesi
                            const subItemWeight = subItem.weight / childrenTotalWeight;
                            const grade = getStudentGrade(studentId, subItem.id) || 0;
                            const scaledGrade = (grade / (subItem.points || 1)) * 100; // 100 √ºzerinden
                            activityGrade += scaledGrade * subItemWeight;
                        });
                    }
                } else {
                    // Basit etkinlik
                    const grade = getStudentGrade(studentId, activity.id) || 0;
                    activityGrade = (grade / (activity.points || 1)) * 100; // 100 √ºzerinden
                }
                
                finalGrade += activityGrade * activityWeight;
            });
        }
        
        // Toplam ve harf notu - RTEU Y√∂netmeliƒüi MADDE 26'ya g√∂re
        let totalGrade = (termGrade * APP_STATE.termWeight / 100) + (finalGrade * APP_STATE.finalWeight / 100);
        let letterGrade = getLetterGrade(totalGrade);
        
        // Yarƒ±yƒ±l sonu sƒ±navƒ± 50'nin altƒ±ndaysa FF verilir
        if (finalGrade < 50) {
            letterGrade = 'FF';
        }
        
        // Hesaplanmƒ±≈ü not bilgilerini ekle
        APP_STATE.gradesData[studentId].yariyilIciNotu = parseFloat(termGrade.toFixed(2));
        APP_STATE.gradesData[studentId].yariyilSonuNotu = parseFloat(finalGrade.toFixed(2));
        APP_STATE.gradesData[studentId].basariNotu = parseFloat(totalGrade.toFixed(2));
        APP_STATE.gradesData[studentId].harfNotu = letterGrade;
        
    } catch (error) {
        console.error("√ñƒürenci notu hesaplanƒ±rken hata olu≈ütu:", error);
    }
}

/**
 * Test skorunu g√ºncelleme
 * @param {HTMLInputElement} input - Test skoru input elementi
 */
function updateTestScore(input) {
    try {
        const studentId = input.dataset.studentId;
        const testId = input.dataset.testId;
        const field = input.dataset.field;
        const value = parseInt(input.value) || 0;
        
        // Test verisini g√ºncelle
        updateTestScoreData(studentId, testId, field, value);
        
        // ƒ∞lgili g√∂r√ºn√ºm alanlarƒ±nƒ± g√ºncelle
        updateTestScoreViews(studentId, testId, field, value, input);
        
        // Test sorularƒ±na rastgele doƒüru/yanlƒ±≈ü daƒüƒ±lƒ±mƒ± yap
        const testScore = APP_STATE.gradesData[studentId][testId];
        if (testScore && (field === 'correct' || field === 'wrong')) {
            // Doƒüru/yanlƒ±≈ü deƒüeri deƒüi≈ütiƒüinde modern test skoru daƒüƒ±tƒ±m modalƒ±nƒ± g√∂ster
            showTestScoreDistributionModal(studentId, testId);
        }
    } catch (error) {
        console.error("Test skoru g√ºncellenirken hata olu≈ütu:", error);
        showModernToast("Test skoru g√ºncellenirken hata olu≈ütu!", "error");
    }
}

// Test score g√∂r√ºn√ºmlerini g√ºncelleme (yardƒ±mcƒ± fonksiyon)
function updateTestScoreViews(studentId, testId, field, value, sourceInput) {
    const testNode = findNodeById(testId);
    if (!testNode) return;
    
    const testScore = APP_STATE.gradesData[studentId][testId];
    const correct = testScore.dogru || 0;
    const wrong = testScore.yanlis || 0;
    const correctWeight = testNode.testDetails.correctWeight;
    const wrongPenalty = Math.abs(testNode.testDetails.wrongPenalty);
    const totalScore = correct * correctWeight - wrong * wrongPenalty;
    
    // Deƒüerlendirme sekmesindeki toplam puan h√ºcresini g√ºncelle
    const assessmentRow = document.querySelector(`tr:has(input[data-student-id="${studentId}"][data-test-id="${testId}"])`);
    const assessmentTotalScore = assessmentRow?.querySelector('.total-score');
    if (assessmentTotalScore) {
        assessmentTotalScore.textContent = totalScore.toFixed(2);
    }
    
    // Basit giri≈ü formundaki deƒüeri de g√ºncelle
    const simpleInput = document.querySelector(`input[data-student-id="${studentId}"][data-activity-id="${testId}"]`);
    if (simpleInput) {
        simpleInput.value = totalScore.toFixed(2);
    }
    
    // √ñƒürenci g√∂r√ºn√ºm√ºndeki ilgili alanlarƒ± g√ºncelle
    if (field === 'correct' || field === 'wrong') {
        // Kar≈üƒ±lƒ±k gelen inputu bul ve g√ºncelle (kendisi deƒüilse)
        const studentViewInput = document.querySelector(`#studentGradesContainer input[data-student-id="${studentId}"][data-test-id="${testId}"][data-field="${field}"]`);
        if (studentViewInput && studentViewInput !== sourceInput) {
            studentViewInput.value = value;
        }
    }
    
    // √ñƒürenci g√∂r√ºn√ºm√ºndeki toplam skoru g√ºncelle
    updateStudentViewTestTotal(studentId, testId);
    
    // Notlarƒ± yeniden hesapla
    updateStudentCalculatedGrade(studentId);
    
    // √ñƒürenci √∂zet bilgilerini g√ºncelle
    updateStudentSummary(studentId);
    
    // Assessment tablosundaki not √∂zeti h√ºcrelerini g√ºncelle
    updateAssessmentGradeSummary(studentId);
        
        // Assessment tablosundaki not √∂zeti h√ºcrelerini g√ºncelle
        updateAssessmentGradeSummary(studentId);
}

/**
 * Notlarƒ± hesaplama ve g√∂r√ºnt√ºleme
 */
function calculateGrades() {
    try {
        if (!APP_STATE.gradesData || Object.keys(APP_STATE.gradesData).length === 0) {
            showModernToast("Hen√ºz not giri≈üi yapƒ±lmamƒ±≈ü!", "warning");
            return;
        }
        
        // T√ºm notlarƒ± hesapla
        calculateFinalGrades();
        
        // Notlar tablosunu g√∂ster
        const finalGrades = {};
        
        APP_STATE.studentData.forEach(student => {
            const studentId = student.studentId;
            if (!APP_STATE.gradesData[studentId]) {
                finalGrades[studentId] = {
                    studentId,
                    name: student.name,
                    surname: student.surname,
                    termGrade: 0,
                    finalGrade: 0,
                    totalGrade: 0,
                    letterGrade: 'FF'
                };
                return;
            }
            
            finalGrades[studentId] = {
                studentId,
                name: student.name,
                surname: student.surname,
                termGrade: APP_STATE.gradesData[studentId].yariyilIciNotu || 0,
                finalGrade: APP_STATE.gradesData[studentId].yariyilSonuNotu || 0,
                totalGrade: APP_STATE.gradesData[studentId].basariNotu || 0,
                letterGrade: APP_STATE.gradesData[studentId].harfNotu || 'FF'
            };
        });

        // Notlar sekmesine ge√ß
        switchTab('grades');
        
        // Notlar tablosunu g√ºncelle
        updateGradesTable(finalGrades);
        
        // ƒ∞statistikleri g√ºncelle
        updateGradeStatistics(finalGrades);
        
        showModernToast("Notlar ba≈üarƒ±yla hesaplandƒ±.");
    } catch (error) {
        console.error("Notlar hesaplanƒ±rken hata olu≈ütu:", error);
        showModernToast("Notlar hesaplanƒ±rken hata olu≈ütu!", "error");
    }
}

/**
 * Notlar tablosunu g√ºncelleme
 * @param {Object} finalGrades - Hesaplanan son notlar
 */
function updateGradesTable(finalGrades) {
    try {
        const tableBody = document.createElement('tbody');
        
        APP_STATE.studentData.forEach((student, index) => {
            const studentGrade = finalGrades[student.studentId] || {
                termGrade: 0,
                finalGrade: 0,
                totalGrade: 0,
                letterGrade: 'FF'
            };
            
            const row = document.createElement('tr');
            
            // Ge√ßme/kalma durumuna g√∂re satƒ±r stilini belirle
            const letterGrade = studentGrade.letterGrade;
            if (['AA', 'BA', 'BB', 'CB', 'CC'].includes(letterGrade)) {
                row.style.backgroundColor = 'rgba(40, 167, 69, 0.1)'; // Ba≈üarƒ±lƒ±
            } else if (['DC', 'DD'].includes(letterGrade)) {
                row.style.backgroundColor = 'rgba(255, 193, 7, 0.1)'; // Ko≈üullu ba≈üarƒ±lƒ±
            } else {
                row.style.backgroundColor = 'rgba(220, 53, 69, 0.1)'; // Ba≈üarƒ±sƒ±z
            }
            
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${student.studentId}</td>
                <td>${student.name}</td>
                <td>${student.surname}</td>
                <td>${studentGrade.termGrade}</td>
                <td>${studentGrade.finalGrade}</td>
                <td>${studentGrade.totalGrade}</td>
                <td>${studentGrade.letterGrade}</td>
            `;
            tableBody.appendChild(row);
        });
        
        // Tabloyu g√ºncelle - genel aƒüƒ±rlƒ±klarƒ± da g√∂ster
        gradesTable.innerHTML = `
            <thead>
                <tr>
                    <th>No</th>
                    <th>√ñƒürenci No</th>
                    <th>Adƒ±</th>
                    <th>Soyadƒ±</th>
                    <th>Yarƒ±yƒ±l ƒ∞√ßi (${APP_STATE.termWeight}%)</th>
                    <th>Yarƒ±yƒ±l Sonu (${APP_STATE.finalWeight}%)</th>
                    <th>Toplam Puan</th>
                    <th>Harf Notu</th>
                </tr>
            </thead>
        `;
        gradesTable.appendChild(tableBody);
    } catch (error) {
        console.error("Notlar tablosu g√ºncellenirken hata olu≈ütu:", error);
    }
}

/**
 * Not istatistiklerini g√ºncelleme
 * @param {Object} finalGrades - Hesaplanan son notlar
 */
function updateGradeStatistics(finalGrades) {
    try {
        const grades = Object.values(finalGrades);
        
        // Ortalama hesapla
        const totalSum = grades.reduce((sum, grade) => sum + parseFloat(grade.totalGrade), 0);
        const average = totalSum / grades.length;
        
        // Harf notlarƒ± daƒüƒ±lƒ±mƒ±
        const letterGradeCounts = {};
        grades.forEach(grade => {
            const letter = grade.letterGrade;
            letterGradeCounts[letter] = (letterGradeCounts[letter] || 0) + 1;
        });
        
        // Ge√ßme/kalma oranƒ±
        const passingLetters = ['AA', 'BA', 'BB', 'CB', 'CC', 'DC', 'DD'];
        const passingCount = grades.filter(grade => passingLetters.includes(grade.letterGrade)).length;
        const failingCount = grades.length - passingCount;
        const passRate = (passingCount / grades.length) * 100;
        
        // ƒ∞statistikleri g√∂ster
        statsContent.innerHTML = `
            <div class="stats-grid">
                <div class="stats-card">
                    <h5>Genel ƒ∞statistikler</h5>
                    <p>Sƒ±nƒ±f Mevcudu: <strong>${grades.length}</strong> √∂ƒürenci</p>
                    <p>Sƒ±nƒ±f Ortalamasƒ±: <strong>${average.toFixed(2)}</strong></p>
                    <p>Ge√ßen √ñƒürenci Sayƒ±sƒ±: <strong>${passingCount}</strong> (${passRate.toFixed(2)}%)</p>
                    <p>Kalan √ñƒürenci Sayƒ±sƒ±: <strong>${failingCount}</strong> (${(100 - passRate).toFixed(2)}%)</p>
                </div>
                
                <div class="stats-card">
                    <h5>Harf Notu Daƒüƒ±lƒ±mƒ±</h5>
                    <ul class="grade-distribution">
                        ${Object.entries(letterGradeCounts).sort().map(([letter, count]) => {
                            // Harf notuna g√∂re renk belirle
                            let colorClass = '';
                            if (['AA', 'BA', 'BB'].includes(letter)) {
                                colorClass = 'grade-high';
                            } else if (['CB', 'CC'].includes(letter)) {
                                colorClass = 'grade-mid';
                            } else if (['DC', 'DD'].includes(letter)) {
                                colorClass = 'grade-low';
                            } else {
                                colorClass = 'grade-fail';
                            }
                            
                            return `
                                <li class="${colorClass}">
                                    <span class="grade-letter">${letter}</span>
                                    <span class="grade-count">${count} √∂ƒürenci</span>
                                    <span class="grade-percent">(${((count / grades.length) * 100).toFixed(2)}%)</span>
                                    <div class="grade-bar" style="width: ${(count / grades.length) * 100}%"></div>
                                </li>
                            `;
                        }).join('')}
                    </ul>
                </div>
            </div>
        `;
        
        // Grafik olu≈ütur (eƒüer Chart.js k√ºt√ºphanesi y√ºklenmi≈üse)
        if (window.Chart) {
            chartContainer.innerHTML = '<canvas id="gradeChart"></canvas>';
            const ctx = document.getElementById('gradeChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(letterGradeCounts).sort(),
                    datasets: [{
                        data: Object.values(letterGradeCounts).sort((a, b) => b - a),
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.8)', // AA
                            'rgba(40, 167, 69, 0.6)', // BA
                            'rgba(40, 167, 69, 0.4)', // BB
                            'rgba(23, 162, 184, 0.8)', // CB
                            'rgba(23, 162, 184, 0.6)', // CC
                            'rgba(255, 193, 7, 0.8)', // DC
                            'rgba(255, 193, 7, 0.6)', // DD
                            'rgba(220, 53, 69, 0.8)', // FD
                            'rgba(220, 53, 69, 0.6)'  // FF
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    legend: {
                        position: 'right',
                    },
                    title: {
                        display: true,
                        text: 'Harf Notu Daƒüƒ±lƒ±mƒ±'
                    }
                }
            });
        }
    } catch (error) {
        console.error("Not istatistikleri g√ºncellenirken hata olu≈ütu:", error);
    }
}

// =====================================================
// √ñƒûRENCƒ∞ VERƒ∞LERƒ∞ FONKSIYONLARI
// =====================================================

/**
 * √ñƒürenci tablosunu g√ºncelleme
 */
function updateStudentTable() {
    try {
        // Yeni geli≈ümi≈ü tabloyu kullan
        updateStudentTableEnhanced();
        
        // Grup sistemini ba≈ülat
        initializeGroupSystem();
        
        // √ñ√á tooltip sistemini ba≈ülat
        initializeOutcomeTooltips();
        
        // Default grup atamasƒ±nƒ± yap
        assignDefaultGroups();
        
        // √ñƒürenci grup bilgilerini g√ºncelle
        updateStudentGroupInfoDisplay();
        
        // Debug: Grup atamalarƒ±nƒ± konsola yazdƒ±r
        debugGroupAssignments();
        
        // √ñƒürenci filtresi se√ßeneklerini g√ºncelle
        updateAssessmentStudentFilterOptions();
        
        // Deƒüerlendirme g√∂r√ºn√ºm√ºn√º g√ºncelle
        updateAssessmentView();
        
        // Kontrolleri ba≈ülat (sadece ilk kez)
        if (!window.studentControlsInitialized) {
            initializeStudentControls();
            window.studentControlsInitialized = true;
        }
        
    } catch (error) {
        console.error("√ñƒürenci tablosu g√ºncellenirken hata olu≈ütu:", error);
        showModernToast("√ñƒürenci tablosu g√ºncellenemedi!", "error");
    }
}

/**
 * √ñƒürenci grup bilgilerini g√∂sterme
 */
function updateStudentGroupInfoDisplay() {
    try {
        const studentGroupInfoCard = document.getElementById('studentGroupInfoCard');
        const studentGroupInfoContainer = document.getElementById('studentGroupInfoContainer');
        
        if (!studentGroupInfoCard || !studentGroupInfoContainer) {
            return;
        }
        
        // √ñƒürenci verisi yoksa kartƒ± gizle
        if (!APP_STATE.studentData || APP_STATE.studentData.length === 0) {
            studentGroupInfoCard.style.display = 'none';
            return;
        }
        
        // Grup bilgisi yoksa basit mesaj g√∂ster
        if (!APP_STATE.courseData?.grupHaritalari || Object.keys(APP_STATE.courseData.grupHaritalari).length === 0) {
            studentGroupInfoCard.style.display = 'block';
            studentGroupInfoContainer.innerHTML = '<p class="empty-message">Hen√ºz grup atamasƒ± yapƒ±lmamƒ±≈ü. Grup d√ºzenlemeleri "Deƒüerlendirme Giri≈üi" sekmesinden yapabilirsiniz.</p>';
            return;
        }
        
        // Sadece ana etkinliklerin grup bilgilerini topla (alt bile≈üenler hari√ß)
        const mainComponentGroups = {};
        Object.keys(APP_STATE.courseData.grupHaritalari).forEach(componentId => {
            // Sadece ana etkinlikleri al (A1, A2, F1, F2 gibi - nokta i√ßermeyenler)
            if (!componentId.includes('.')) {
            const component = APP_STATE.courseData.grupHaritalari[componentId];
            if (component.gruplar && component.gruplar.length > 0) {
                    mainComponentGroups[componentId] = component.gruplar;
                }
            }
        });
        
        // Grup bilgisi varsa detaylƒ± g√∂sterim
        if (Object.keys(mainComponentGroups).length > 0) {
            let html = '<div class="group-info-grid">';
            
            Object.keys(mainComponentGroups).forEach(componentId => {
                const groups = mainComponentGroups[componentId];
                
                // Ana etkinlik i√ßin grup bilgisi
                html += `
                    <div class="component-group-card">
                        <h4 class="component-title">${getComponentDisplayName(componentId)}</h4>
                        <div class="group-distribution">
                `;
                
                groups.forEach(groupId => {
                    // √ñƒürencileri bu gruba ata ve filtrele
                    const studentsInGroup = APP_STATE.studentData.filter(student => {
                        const studentGroup = getStudentGroupForComponent(student.studentId, componentId);
                        return studentGroup === groupId;
                    });
                    
                    // Eƒüer tek grup varsa ve hi√ß √∂ƒürenci atanmamƒ±≈üsa, t√ºm √∂ƒürencileri bu gruba ata
                    if (groups.length === 1 && studentsInGroup.length === 0 && groupId === 'A') {
                        // T√ºm √∂ƒürencileri A grubuna ata
                        APP_STATE.studentData.forEach(student => {
                            if (!student.grup || !groups.includes(student.grup)) {
                                student.grup = 'A';
                            }
                            // Bile≈üen bazlƒ± grup atamasƒ± da yap
                            if (!APP_STATE.studentComponentGroups) {
                                APP_STATE.studentComponentGroups = {};
                            }
                            if (!APP_STATE.studentComponentGroups[student.studentId]) {
                                APP_STATE.studentComponentGroups[student.studentId] = {};
                            }
                            APP_STATE.studentComponentGroups[student.studentId][componentId] = 'A';
                        });
                        // Yeniden filtrele
                        const allStudents = APP_STATE.studentData.slice();
                        studentsInGroup.length = 0;
                        studentsInGroup.push(...allStudents);
                    }
                    
                    html += `
                        <div class="group-item">
                            <span class="group-badge">${groupId} Grubu</span>
                            <span class="student-count">${studentsInGroup.length} √∂ƒürenci</span>
                            <div class="student-list group-drop-zone" data-group="${groupId}" data-activity="${componentId}">
                                ${studentsInGroup.map(s => `<div class="student-item" draggable="true" data-student-id="${s.studentId}" data-student-name="${s.name} ${s.surname}" data-activity="${componentId}">${s.name} ${s.surname}</div>`).join('')}
                                ${studentsInGroup.length === 0 ? '<div class="empty-group-message">Gruba √∂ƒürenci s√ºr√ºkleyebilirsiniz</div>' : ''}
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                `;
                
                // Ana etkinliƒüin alt bile≈üenlerini g√∂ster
                const mainActivity = APP_STATE.assessmentTree.find(node => node.id === componentId);
                if (mainActivity && mainActivity.children && mainActivity.children.length > 0) {
                    html += `
                        <div class="sub-components-info">
                            <h5 class="sub-components-title">Alt Bile≈üenler:</h5>
                            <div class="sub-components-list">
                    `;
                    
                    mainActivity.children.forEach(subComponent => {
                        html += `
                            <div class="sub-component-item">
                                <span class="sub-component-id">${subComponent.id}</span>
                                <span class="sub-component-name">${subComponent.name}</span>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
                
                html += `
                    </div>
                `;
            });
            
            html += '</div>';
            studentGroupInfoContainer.innerHTML = html;
        } else {
            studentGroupInfoContainer.innerHTML = '<p class="empty-message">T√ºm bile≈üenler tek grup kullanƒ±yor. Grup d√ºzenlemeleri "Deƒüerlendirme Giri≈üi" sekmesinden yapabilirsiniz.</p>';
        }
        
        studentGroupInfoCard.style.display = 'block';
        
        // Drag&drop event listener'larƒ±nƒ± ekle (DOM g√ºncellemesinden sonra)
        setTimeout(() => {
            setupDragAndDrop();
            console.log('üéØ Grup bilgileri i√ßin drag&drop ayarlandƒ±');
        }, 100);
        
    } catch (error) {
        console.error("√ñƒürenci grup bilgileri g√ºncellenirken hata:", error);
    }
}

/**
 * Bile≈üen ID'sinden etkinlik adƒ±nƒ± getir
 * @param {string} componentId - Bile≈üen ID'si (A1, A2, F1, vb.)
 * @returns {string} - Etkinlik adƒ±
 */
function getComponentDisplayName(componentId) {
    try {
        // assessmentTree'den ilgili bile≈üeni bul
        const component = APP_STATE.assessmentTree?.find(node => node.id === componentId);
        
        if (component && component.name) {
            return `${componentId} - ${component.name}`;
        }
        
        // Eƒüer bulunamazsa sadece ID'yi d√∂nd√ºr
        return `${componentId} Bile≈üeni`;
    } catch (error) {
        console.error('Bile≈üen adƒ± alƒ±nƒ±rken hata:', error);
        return `${componentId} Bile≈üeni`;
    }
}

/**
 * Debug: Grup atamalarƒ±nƒ± konsola yazdƒ±r
 */
function debugGroupAssignments() {
    try {
        console.log('\n=== üîç DEBUG: GRUP ATAMALARI ===');
        
        if (!APP_STATE.studentData || APP_STATE.studentData.length === 0) {
            console.log('‚ö†Ô∏è √ñƒürenci verisi yok');
            return;
        }
        
        console.log(`üë• Toplam √∂ƒürenci sayƒ±sƒ±: ${APP_STATE.studentData.length}`);
        
        // Genel grup atamalarƒ±
        console.log('\nüìã Genel grup atamalarƒ±:');
        APP_STATE.studentData.forEach((student, index) => {
            console.log(`  ${index + 1}. ${student.name} ${student.surname} (${student.studentId}) ‚Üí Grup: ${student.grup || 'YOK'}`);
        });
        
        // Bile≈üen bazlƒ± grup atamalarƒ±
        if (APP_STATE.courseData?.grupHaritalari) {
            console.log('\nüéØ Bile≈üen bazlƒ± grup atamalarƒ±:');
            Object.keys(APP_STATE.courseData.grupHaritalari).forEach(componentId => {
                const component = APP_STATE.courseData.grupHaritalari[componentId];
                console.log(`\n  üìä ${getComponentDisplayName(componentId)} (Gruplar: ${component.gruplar?.join(', ') || 'YOK'}):`);
                
                APP_STATE.studentData.forEach((student, index) => {
                    const studentGroup = getStudentGroupForComponent(student.studentId, componentId);
                    console.log(`    ${index + 1}. ${student.name} ${student.surname} ‚Üí ${studentGroup}`);
                });
            });
        }
        
        console.log('\n=== üîç DEBUG TAMAMLANDI ===\n');
        
    } catch (error) {
        console.error('Debug grup atamalarƒ± sƒ±rasƒ±nda hata:', error);
    }
}

/**
 * Bir √∂ƒürencinin belirli bir bile≈üendeki grubunu al
 * @param {string} studentId - √ñƒürenci ID
 * @param {string} componentId - Bile≈üen ID
 * @returns {string} - Grup ID
 */
function getStudentGroupForComponent(studentId, componentId) {
    // Bu bile≈üenin mevcut gruplarƒ±nƒ± kontrol et
    const component = APP_STATE.courseData?.grupHaritalari?.[componentId];
    const availableGroups = component?.gruplar || ['A'];
    
    // 1. Sadece courseData.ogrenciNotlari formatƒ± kontrol et (tek format)
    if (APP_STATE.courseData?.ogrenciNotlari?.[studentId]?.grupBilgileri?.[componentId]) {
        const courseDataGroup = APP_STATE.courseData.ogrenciNotlari[studentId].grupBilgileri[componentId];
        if (availableGroups.includes(courseDataGroup)) {
            return courseDataGroup;
        }
    }
    
    // 2. gradesData formatƒ±ndan kontrol et (yedek)
    if (APP_STATE.gradesData?.[studentId]?.grupBilgileri?.[componentId]) {
        const gradesDataGroup = APP_STATE.gradesData[studentId].grupBilgileri[componentId];
        if (availableGroups.includes(gradesDataGroup)) {
            return gradesDataGroup;
        }
    }
    
    // 3. Varsayƒ±lan grup d√∂nd√ºr
    return availableGroups[0] || 'A';
}

/**
 * √ñƒürenci listesini temizleme
 */
function clearStudents() {
    // √ñnce silinecek √∂ƒürenci var mƒ± kontrol et
    const hasStudents = (APP_STATE.studentData && APP_STATE.studentData.length > 0) || 
                       (APP_STATE.students && APP_STATE.students.length > 0);
    
    if (!hasStudents) {
        showModernToast("‚ÑπÔ∏è Silinecek √∂ƒürenci bulunmuyor.", "info");
        return;
    }
    
    showModernConfirm(
        'üéì √ñƒürenci Listesini Temizle',
        '√ñƒürenci listesini temizlemek istediƒüinizden emin misiniz?\n\n‚Ä¢ √ñƒürenci listesi silinecek\n‚Ä¢ Notlar korunacak\n‚Ä¢ Deƒüerlendirme yapƒ±sƒ± korunacak\n\nBu i≈ülem geri alƒ±namaz!',
        function() {
            try {
                APP_STATE.studentData = [];
                APP_STATE.gradesData = {};
                updateStudentTable();
                
                // Deƒüerlendirme g√∂r√ºn√ºm√ºn√º g√ºncelle
                updateAssessmentView();
                
                // Otomatik kayƒ±t trigger
                if (autoSaveManager) {
                    autoSaveManager.hasUnsavedChanges = true;
                    autoSaveManager.updateFloatingButton('unsaved');
                }
                
                showModernToast("üéì √ñƒürenci listesi temizlendi!", "success");
            } catch (error) {
                console.error("√ñƒürenci listesi temizlenirken hata olu≈ütu:", error);
                showModernToast("‚ùå √ñƒürenci listesi temizlenemedi!", "error");
            }
        }
    );
}

/**
 * √ñƒürenci verilerini i√ße aktarma - T√ºm formatlarƒ± destekler
 * @param {Object} jsonData - JSON veri
 */
function importStudentData(jsonData) {
    try {
        let studentData = [];
        let gradesData = {};
        
        // √ñƒürenci listesini farklƒ± formatlarda kontrol et
        if (jsonData.ogrenciler && Array.isArray(jsonData.ogrenciler)) {
            // Format 1: Ders deƒüerlendirme sistemi formatƒ±
            studentData = jsonData.ogrenciler.map(student => ({
                studentId: student.ogrenciNo,
                name: student.ad,
                surname: student.soyad,
                status: student.durum || 'Aktif',
                grup: student.grup || 'A',
                email: student.email || '',
                telefon: student.telefon || '',
                tcKimlik: student.tcKimlik || ''
            }));
            
            // ogrenciNotlari formatƒ±
            if (jsonData.ogrenciNotlari) {
                gradesData = jsonData.ogrenciNotlari;
            }
        } 
        else if (jsonData.students && Array.isArray(jsonData.students)) {
            // Format 2: Normal/ƒ∞ngilizce format
            studentData = jsonData.students.map(student => ({
                studentId: student.student_id || student.studentId || student.ogrenciNo,
                name: student.name || student.ad,
                surname: student.surname || student.soyad,
                status: student.status || student.durum || 'Aktif',
                grup: student.grup || student.group || 'A',
                email: student.email || '',
                telefon: student.telefon || '',
                tcKimlik: student.tcKimlik || ''
            }));
            
            // grades veya rawGrades formatƒ±
            if (jsonData.grades) {
                gradesData = jsonData.grades;
            } else if (jsonData.rawGrades) {
                gradesData = jsonData.rawGrades;
            }
        } 
        else if (jsonData.courseData && jsonData.courseData.ogrenciler) {
            // Format 3: Excel-to-MUDEK formatƒ±
            studentData = jsonData.courseData.ogrenciler.map(student => ({
                studentId: student.ogrenciNo,
                name: student.ad,
                surname: student.soyad,
                status: student.durum || 'Aktif',
                grup: student.grup || 'A',
                email: student.email || '',
                telefon: student.telefon || '',
                tcKimlik: student.tcKimlik || ''
            }));
        } 
        else {
            throw new Error('Ge√ßerli √∂ƒürenci verisi bulunamadƒ±.');
        }
        
        if (!studentData.length) {
            throw new Error('√ñƒürenci listesi bo≈ü.');
        }
        
        // √ñƒürenci verilerini kaydet
        APP_STATE.studentData = studentData;
        
        // Grup haritasƒ± bilgilerini y√ºkle
        if (jsonData.grupHaritalari) {
            if (!APP_STATE.courseData) {
                APP_STATE.courseData = {};
            }
            APP_STATE.courseData.grupHaritalari = jsonData.grupHaritalari;
            console.log('Grup haritalarƒ± y√ºklendi:', jsonData.grupHaritalari);
        }
        
        // Grup sistemini ba≈ülat
        initializeGroupSystem();
        
        // T√ºm ilgili UI'larƒ± g√ºncelle
        updateStudentTable();
        updateGroupSelectors();
        // updateStudentSelector fonksiyonu kaldƒ±rƒ±ldƒ± (√ñƒürenci Bazlƒ± Not Giri≈üi sekmesi ile birlikte)
        updateAllInlineGroupInputs();
        updateAllMappingDisplays();
        
        // Not verilerini de y√ºkle
        if (Object.keys(gradesData).length > 0) {
            APP_STATE.gradesData = gradesData;
            console.log('Not verileri y√ºklendi:', Object.keys(gradesData).length, '√∂ƒürenci');
            
            // HAM PUAN KONTROL√ú VE GRUP BAZLI HESAPLAMA
            recalculateAllGradesBasedOnGroups();
        }
        
        // Deƒüerlendirme g√∂r√ºn√ºm√ºn√º g√ºncelle
        updateAssessmentView();
        
        // Deƒüerlendirme sekmesine ge√ß
        switchTab('assessment');
        
        // Otomatik kayƒ±t trigger
        if (autoSaveManager) {
            autoSaveManager.hasUnsavedChanges = true;
            autoSaveManager.updateFloatingButton('unsaved');
        }
        
        showModernToast(`${APP_STATE.studentData.length} √∂ƒürenci ba≈üarƒ±yla y√ºklendi.`);
    } catch (error) {
        console.error("√ñƒürenci verileri i√ße aktarƒ±lƒ±rken hata olu≈ütu:", error);
        showModernToast("√ñƒürenci verileri i√ße aktarƒ±lamadƒ±! L√ºtfen dosya formatƒ±nƒ± kontrol edin.", "error");
        throw error;
    }
}

// =====================================================
// JSON VE DOSYA ƒ∞≈ûLEMLERƒ∞
// =====================================================

/**
 * Not verilerini i√ße aktarma
 */
function importGrades() {
    try {
        // Not giri≈ülerinin kontrol√º
        if (!APP_STATE.assessmentTree.length || !APP_STATE.studentData.length) {
            showModernToast("Deƒüerlendirme kriterleri ve √∂ƒürenci listesi y√ºklenmeden not giri≈üi yapƒ±lamaz!", "warning");
            return;
        }
        
        // Not i√ße aktarma modalƒ±nƒ± g√∂ster
        openModal(importModal);
        
        // Modalda a√ßƒ±klama ekle
        jsonContent.value = "";
        jsonContent.placeholder = "Not verilerini JSON formatƒ±nda yapƒ±≈ütƒ±rƒ±n veya dosyadan y√ºkleyin.\n\n" +
            "√ñrnek format:\n{\n  \"12345\": {\n    \"A1\": 85,\n    \"F1\": 75\n  }\n}";
            
        // Modalƒ±n ba≈ülƒ±ƒüƒ±nƒ± deƒüi≈ütir
        document.querySelector('#importModal .modal-header h2').textContent = "Notlarƒ± ƒ∞√ße Aktar";
        
        // Apply butonuna farklƒ± bir i≈ülev ata
        btnApplyJson.onclick = function() {
            applyGradesJson();
        };
        
    } catch (error) {
        console.error("Not i√ße aktarma modalƒ± g√∂sterilirken hata olu≈ütu:", error);
        showModernToast("Not i√ße aktarma i≈ülemi ba≈ülatƒ±lamadƒ±!", "error");
    }
}

/**
 * Not JSON verilerini uygulama
 */
function applyGradesJson() {
    try {
        const jsonString = jsonContent.value.trim();
        
        if (!jsonString) {
            showModernToast("L√ºtfen ge√ßerli bir JSON i√ßeriƒüi girin.", "warning");
            return;
        }
        
        const jsonData = JSON.parse(jsonString);
        
        // Temel doƒürulama
        if (!jsonData || typeof jsonData !== 'object') {
            throw new Error('Ge√ßersiz JSON formatƒ±.');
        }
        
        // Not verilerini y√ºkle
        if (jsonData.grades) {
            APP_STATE.gradesData = jsonData.grades;
        } else if (jsonData.ogrenciNotlari) {
            APP_STATE.gradesData = jsonData.ogrenciNotlari;
        } else if (jsonData.rawGrades) {
            APP_STATE.gradesData = jsonData.rawGrades;
        } else {
            // Doƒürudan not verisi olarak kabul et
            APP_STATE.gradesData = jsonData;
        }
        
        // JSON y√ºklendikten sonra alanlarƒ± uyumlu hale getir
        normalizeGradeFields();
        
        // Deƒüerlendirme g√∂r√ºn√ºm√ºn√º g√ºncelle
        updateAssessmentView();
        
        closeModal(importModal);
        showModernToast("Not verileri ba≈üarƒ±yla y√ºklendi.");
        
        // Deƒüerlendirme sekmesine ge√ß
        switchTab('assessment');
        
    } catch (error) {
        console.error("Not JSON verisi uygulanƒ±rken hata olu≈ütu:", error);
        showModernToast("Not verileri y√ºklenemedi: " + error.message, "error");
    }
}
/**
 * Not verilerini kaydetme
 */
function saveGrades() {
    try {
        // Not giri≈ülerinin kontrol√º
        if (!APP_STATE.assessmentTree.length || !APP_STATE.studentData.length) {
            showModernToast("Deƒüerlendirme kriterleri ve √∂ƒürenci listesi y√ºklenmeden not kaydƒ± yapƒ±lamaz!", "warning");
            return;
        }
        
        // Notlarƒ± kaydet - dosya sisteminde kalƒ±cƒ± olarak saklanmasƒ±na gerek yok,
        // √ß√ºnk√º zaten APP_STATE.gradesData i√ßinde tutuluyorlar
        
        showModernToast("Notlar ba≈üarƒ±yla kaydedildi.");
        
        // ƒ∞steƒüe baƒülƒ± olarak notlarƒ± JSON olarak dƒ±≈üa aktarma modalƒ±nƒ± g√∂ster
        showExportGradesModal('json');
    } catch (error) {
        console.error("Notlar kaydedilirken hata olu≈ütu:", error);
        showModernToast("Notlar kaydedilemedi!", "error");
    }
}

/**
 * Not dƒ±≈üa aktarma modalƒ±nƒ± g√∂sterme
 * @param {string} type - Dƒ±≈üa aktarma tipi (json/csv)
 */
function showExportGradesModal(type) {
    try {
        // Tip kontrol√º
        if (type !== 'json' && type !== 'csv') {
            throw new Error('Ge√ßersiz dƒ±≈üa aktarma tipi!');
        }
        
        // ƒ∞√ßerik olu≈ütur
        let content = '';
        
        if (type === 'json') {
            // JSON verisi olu≈ütur
            const gradesData = createGradesExportData();
            content = JSON.stringify(gradesData, null, 2);
        } else {
            // CSV verisi olu≈ütur
            content = createGradesCSV();
        }
        
        // Modal i√ßeriƒüini ayarla
        exportGradesContent.value = content;
        
        // Modalƒ± g√∂ster
        openModal(exportGradesModal);
        
        showModernToast(`Notlar ${type.toUpperCase()} formatƒ±nda hazƒ±rlandƒ±.`);
    } catch (error) {
        console.error("Not dƒ±≈üa aktarma modalƒ± g√∂sterilirken hata olu≈ütu:", error);
        showModernToast("Not verileri dƒ±≈üa aktarƒ±lamadƒ±!", "error");
    }
}

// ƒ∞lk applyJsonData fonksiyonu silindi - ikinci fonksiyon daha kapsamlƒ±

/**
 * √ñƒürenci JSON verilerini uygulama
 */
function applyStudentJsonData() {
    try {
        const jsonData = JSON.parse(studentJsonContent.value);
        
        // √ñƒürenci verilerini i√ße aktar
        importStudentData(jsonData);
        
        closeModal(importStudentsModal);
        showModernToast("√ñƒürenci listesi ba≈üarƒ±yla y√ºklendi.");
    } catch (error) {
        console.error("√ñƒürenci JSON verisi uygulanƒ±rken hata olu≈ütu:", error);
        showModernToast("√ñƒürenci listesi y√ºklenemedi! L√ºtfen dosya formatƒ±nƒ± kontrol edin.", "error");
    }
}

/**
 * Ders verilerinden deƒüerlendirme aƒüacƒ± olu≈üturma
 */
function createAssessmentTreeFromCourseData() {
    try {
        // Temiz bir aƒüa√ß yapƒ±sƒ± olu≈ütur
        APP_STATE.assessmentTree = [];
        
        if (!APP_STATE.courseData) return;
        
        // Derste tanƒ±mlƒ± deƒüerlendirme etkinliklerini kontrol et
        const assessmentActivities = APP_STATE.courseData.dersDegerlendirme?.yariyilIciEtkinlikleri || [];
        const finalActivities = APP_STATE.courseData.dersDegerlendirme?.yariyilSonuEtkinlikleri || [];
        
        // Yarƒ±yƒ±l i√ßi etkinlikler
        if (assessmentActivities.length > 0) {
            assessmentActivities.forEach((activity, index) => {
                // v5 formatƒ±nda ID zaten var, yoksa olu≈ütur
                const activityId = activity.id || `A${index + 1}`;
                
                // √ñ√á'leri kullan - eƒüer JSON'da √ñ√á varsa onlarƒ± akƒ±llƒ±ca daƒüƒ±t
                const randomOutcomes = getSmartOutcomes(2);
                
                const node = {
                    id: activityId,
                    name: activity.etkinlik,
                    type: activity.etkinlik,
                    weight: activity.katkiYuzdesi,
                    points: 100,
                    outcomes: randomOutcomes,
                    description: 'Yarƒ±yƒ±l i√ßi deƒüerlendirme',
                    expanded: true,
                    children: []
                };
                
                // v5 formatƒ±nda detaylar varsa onlarƒ± kullan
                if (activity.detaylar && Array.isArray(activity.detaylar)) {
                    node.children = activity.detaylar.map(detail => ({
                        id: detail.id,
                        name: detail.isim,
                        type: detail.tip,
                        weight: detail.agirlik,
                        points: detail.puan,
                        outcomes: detail.ogrenme√áiktilari || [],
                        description: detail.aciklama || 'Deƒüerlendirme bile≈üeni',
                        expanded: false,
                        children: []
                    }));
                }
                // Eski format veya assessment details varsa
                else if (APP_STATE.courseData.assessmentDetails && APP_STATE.courseData.assessmentDetails[activityId]) {
                    const details = APP_STATE.courseData.assessmentDetails[activityId];
                    if (details.children && Array.isArray(details.children)) {
                        node.children = details.children;
                    }
                } else {
                    // Varsayƒ±lan olarak bazƒ± soru ve rubrikler ekle
                    if (activity.etkinlik === 'Ara Sƒ±nav' || activity.etkinlik === 'Quiz') {
                        // √ñrnek sorular ekle
                        for (let i = 1; i <= 5; i++) {
                            const questionOutcome = getSmartOutcomes(1);
                            
                            node.children.push({
                                id: `${activityId}.${i}`,
                                name: `Soru ${i}`,
                                type: 'Soru',
                                weight: 20,
                                points: 20,
                                outcomes: questionOutcome,
                                description: 'Deƒüerlendirme sorusu',
                                expanded: false,
                                children: []
                            });
                        }
                    } else if (activity.etkinlik === 'Proje Hazƒ±rlama' || activity.etkinlik === 'Rapor' || activity.etkinlik === 'Ev √ñdevi') {
                        // √ñrnek rubrikler ekle
                        const rubricTypes = [
                            { name: 'ƒ∞√ßerik', desc: 'ƒ∞√ßerik kalitesi ve kapsamƒ±' },
                            { name: 'Organizasyon', desc: '√áalƒ±≈ümanƒ±n d√ºzeni ve yapƒ±sƒ±' },
                            { name: 'Sunum', desc: 'Sunum kalitesi ve profesyonellik' },
                            { name: 'Kaynaklar', desc: 'Kaynaklarƒ±n kullanƒ±mƒ± ve atƒ±f yapƒ±lmasƒ±' },
                            { name: '√ñzg√ºnl√ºk', desc: '√áalƒ±≈ümanƒ±n √∂zg√ºnl√ºk d√ºzeyi' }
                        ];
                        
                        rubricTypes.forEach((rubric, idx) => {
                            const rubricOutcome = getSmartOutcomes(1);
                            
                            node.children.push({
                                id: `${activityId}.${idx + 1}`,
                                name: rubric.name,
                                type: 'Rubrik',
                                weight: 20,
                                points: 20,
                                outcomes: rubricOutcome,
                                description: rubric.desc,
                                expanded: false,
                                children: []
                            });
                        });
                    }
                }
                
                APP_STATE.assessmentTree.push(node);
            });
        } else {
            // Varsayƒ±lan bir yarƒ±yƒ±l i√ßi etkinlik ekle
            APP_STATE.assessmentTree.push({
                id: 'A1',
                name: 'Ara Sƒ±nav',
                type: 'Ara Sƒ±nav',
                weight: 40,
                points: 100,
                outcomes: getSmartOutcomes(3),
                description: 'Yarƒ±yƒ±l i√ßi deƒüerlendirme',
                expanded: true,
                children: []
            });
        }
        
        // Yarƒ±yƒ±l sonu etkinlikler
        if (finalActivities.length > 0) {
            finalActivities.forEach((activity, index) => {
                // v5 formatƒ±nda ID zaten var, yoksa olu≈ütur
                const activityId = activity.id || `F${index + 1}`;
                
                // √ñ√á'leri akƒ±llƒ±ca daƒüƒ±t
                const randomOutcomes = getSmartOutcomes(3);
                
                const node = {
                    id: activityId,
                    name: activity.etkinlik,
                    type: activity.etkinlik,
                    weight: activity.katkiYuzdesi,
                    points: 100,
                    outcomes: randomOutcomes,
                    description: 'Yarƒ±yƒ±l sonu deƒüerlendirme',
                    expanded: true,
                    children: []
                };
                
                // v5 formatƒ±nda detaylar varsa onlarƒ± kullan
                if (activity.detaylar && Array.isArray(activity.detaylar)) {
                    node.children = activity.detaylar.map(detail => ({
                        id: detail.id,
                        name: detail.isim,
                        type: detail.tip,
                        weight: detail.agirlik,
                        points: detail.puan,
                        outcomes: detail.ogrenme√áiktilari || [],
                        description: detail.aciklama || 'Deƒüerlendirme bile≈üeni',
                        expanded: false,
                        children: []
                    }));
                }
                // Eski format veya assessment details varsa
                else if (APP_STATE.courseData.assessmentDetails && APP_STATE.courseData.assessmentDetails[activityId]) {
                    const details = APP_STATE.courseData.assessmentDetails[activityId];
                    if (details.children && Array.isArray(details.children)) {
                        node.children = details.children;
                    }
                } else {
                    // Final sƒ±navƒ± i√ßin √∂rnek sorular ekle
                    if (activity.etkinlik === 'Final Sƒ±navƒ±') {
                        for (let i = 1; i <= 5; i++) {
                            const questionOutcome = getSmartOutcomes(1);
                            
                            node.children.push({
                                id: `${activityId}.${i}`,
                                name: `Soru ${i}`,
                                type: 'Soru',
                                weight: 20,
                                points: 20,
                                outcomes: questionOutcome,
                                description: 'Deƒüerlendirme sorusu',
                                expanded: false,
                                children: []
                            });
                        }
                    }
                }
                
                APP_STATE.assessmentTree.push(node);
            });
        } else {
            // Varsayƒ±lan bir yarƒ±yƒ±l sonu etkinlik ekle
            APP_STATE.assessmentTree.push({
                id: 'F1',
                name: 'Final Sƒ±navƒ±',
                type: 'Final Sƒ±navƒ±',
                weight: 60,
                points: 100,
                outcomes: getSmartOutcomes(4),
                description: 'Yarƒ±yƒ±l sonu deƒüerlendirme',
                expanded: true,
                children: []
            });
        }
        
        // Ana bile≈üenler olu≈üturuldu
        console.log('üéØ Ana deƒüerlendirme bile≈üenleri olu≈üturuldu');
        // Bu noktada sadece aƒüa√ß yapƒ±sƒ± hazƒ±r, DOM hen√ºz render edilmemi≈ü
        
    } catch (error) {
        console.error("Deƒüerlendirme aƒüacƒ± olu≈üturulurken hata olu≈ütu:", error);
        showModernToast("Deƒüerlendirme aƒüacƒ± olu≈üturulamadƒ±!", "error");
    }
}

/**
 * Dƒ±≈üa aktarƒ±lacak JSON verisi olu≈ütur
 * @returns {Object} - Dƒ±≈üa aktarƒ±lacak veri
 */
function createExportData() {
    try {
        // Grup haritalamalarƒ±nƒ± temizleme - sadece pozisyon->soru mapping'lerini koru
        function cleanGroupMappings(haritalar) {
            const result = {};
            const sortedGroups = Object.keys(haritalar).sort();
            
            sortedGroups.forEach(group => {
                result[group] = {};
                // Sadece sayƒ±sal anahtar (pozisyon) olan mapping'leri koru - ters mapping'leri filtrele
                Object.keys(haritalar[group]).forEach(key => {
                    if (/^\d+$/.test(key)) { // Sadece sayƒ±sal anahtarlar (1,2,3,4,5...)
                        result[group][key] = haritalar[group][key];
                    }
                });
            });
            return result;
        }
        
        // Tarih ve zaman bilgisi
        const now = new Date();
        const formattedDateTime = now.toISOString().slice(0, 19).replace('T', ' ');
        
        // Dƒ±≈üa aktarƒ±lacak veri yapƒ±sƒ± - tamamen T√ºrk√ße anahtar isimlerini kullanƒ±yor
        const exportData = {
            disaAktarmaTarihi: now.toISOString(),
            dersBilgisi: {
                dersKodu: APP_STATE.courseData?.dersGenel?.dersKodu || '',
                dersAdi: APP_STATE.courseData?.dersGenel?.dersAdi || '',
                akademikYil: APP_STATE.courseData?.dersGenel?.akademikYil || '',
                donem: APP_STATE.courseData?.dersGenel?.ogretimYiliDonemi || 'Bahar D√∂nemi',
                ogretimUyesi: APP_STATE.courseData?.dersIcerik?.dersiVerenOgretimUyesiOgretimGorevlisi || ''
            },
            ogrenciler: APP_STATE.studentData.map(student => ({
                ogrenciNo: student.studentId,
                ad: student.name,
                soyad: student.surname,
                durum: student.status || 'Aktif',
                email: student.email || '', // Email korunuyor
                tcKimlik: student.tcKimlik || '', // TC Kimlik korunuyor
                telefon: student.telefon || '' // Telefon korunuyor
            })),
            dersDegerlendirme: {
                yariyilIciEtkinlikleri: APP_STATE.assessmentTree.filter(node => node.id.startsWith('A')).map(node => {
                    // Grup haritalama bilgilerini al
                    const groupMapping = APP_STATE.courseData?.grupHaritalari?.[node.id];
                    
                    return {
                        id: node.id,
                    etkinlik: node.type,
                    sayi: 1,
                    katkiYuzdesi: node.weight,
                    detaylar: node.children && node.children.map(child => ({
                        id: child.id,
                        isim: child.name,
                        tip: child.type,
                        agirlik: child.weight,
                        puan: child.points,
                        ogrenme√áiktilari: child.outcomes || [],
                        aciklama: child.description || (child.type === 'Soru' ? 'Deƒüerlendirme sorusu' : 'Deƒüerlendirme bile≈üeni')
                        })) || [],
                        grupBilgileri: {
                            gruplar: groupMapping?.gruplar || groupMapping?.groups || ["A"],
                            haritalar: groupMapping?.haritalar ? 
                                // Mevcut haritalar varsa, sadece pozisyon->soru mapping'lerini koru
                                cleanGroupMappings(groupMapping.haritalar) :
                                // Yoksa varsayƒ±lan olu≈ütur (pozisyon: soruId formatƒ±nda)
                                {
                                    "A": node.children ? node.children.reduce((acc, child, index) => {
                                        acc[(index + 1).toString()] = child.id;
                                        return acc;
                                    }, {}) : {}
                                }
                        }
                    };
                }),
                yariyilSonuEtkinlikleri: APP_STATE.assessmentTree.filter(node => node.id.startsWith('F')).map(node => {
                    // Grup haritalama bilgilerini al
                    const groupMapping = APP_STATE.courseData?.grupHaritalari?.[node.id];
                    
                    return {
                        id: node.id,
                    etkinlik: node.type,
                    sayi: 1,
                    katkiYuzdesi: node.weight,
                    detaylar: node.children && node.children.map(child => ({
                        id: child.id,
                        isim: child.name,
                        tip: child.type,
                        agirlik: child.weight,
                        puan: child.points,
                        ogrenme√áiktilari: child.outcomes || [],
                        aciklama: child.description || (child.type === 'Soru' ? 'Deƒüerlendirme sorusu' : 'Deƒüerlendirme bile≈üeni')
                        })) || [],
                        grupBilgileri: {
                            gruplar: groupMapping?.gruplar || ["A"],
                            haritalar: groupMapping?.haritalar ? 
                                // Mevcut haritalar varsa, sadece pozisyon->soru mapping'lerini koru
                                cleanGroupMappings(groupMapping.haritalar) :
                                // Yoksa varsayƒ±lan olu≈ütur (pozisyon: soruId formatƒ±nda)
                                {
                                    "A": node.children ? node.children.reduce((acc, child, index) => {
                                        acc[(index + 1).toString()] = child.id;
                                        return acc;
                                    }, {}) : {}
                                }
                        }
                    };
                })
            },
            // √ñƒürenci notlarƒ±nƒ± kaƒüƒ±t sƒ±rasƒ±na g√∂re d√ºzenle
            ogrenciNotlari: (() => {
                const notlari = {};
                
                APP_STATE.studentData.forEach(student => {
                    const studentId = student.studentId;
                    const studentGrades = {};
                    
                    // Her etkinlik i√ßin notlarƒ± d√ºzenle
                    APP_STATE.assessmentTree.forEach(activity => {
                        if (activity.children && activity.children.length > 0) {
                            const activityGrades = {};
                            
                                        // Kaƒüƒ±t sƒ±rasƒ±na g√∂re puanlarƒ± al
            activity.children.forEach((child, index) => {
                const questionOrder = (index + 1).toString();
                
                // Kaƒüƒ±t sƒ±rasƒ±ndaki puanƒ± al
                const grade = (APP_STATE.gradesData[studentId]?.[activity.id]?.[questionOrder]?.puan) || 0;
                
                // Soru ID'sini haritadan hesapla
                const studentGroup = getStudentGroupForComponent(studentId, activity.id) || 'A';
                const groupMapping = APP_STATE.courseData?.grupHaritalari?.[activity.id]?.haritalar?.[studentGroup];
                const exportQuestionId = groupMapping?.[questionOrder] || child.id;
                
                activityGrades[questionOrder] = {
                    puan: parseFloat(grade.toFixed(2)),
                    soruId: exportQuestionId
                };
            });
                            
                            studentGrades[activity.id] = activityGrades;
                        }
                    });
                    
                    // Her √∂ƒürenci i√ßin grup bilgilerini ekle (v5 format uyumlu)
                    studentGrades.grupBilgileri = {};
                    APP_STATE.assessmentTree.forEach(activity => {
                        studentGrades.grupBilgileri[activity.id] = getStudentGroupForComponent(studentId, activity.id) || 'A';
                    });
                    
                    notlari[studentId] = studentGrades;
                });
                
                return notlari;
            })(),
            
            // Genel ders bilgileri
            dersGenel: APP_STATE.courseData?.dersGenel || {},
            dersIcerik: APP_STATE.courseData?.dersIcerik || {},
            
            // √ñƒürenme √ßƒ±ktƒ±larƒ± varsa ekle
            dersOgrenme√áiktilari: APP_STATE.learningOutcomes.map(outcome => ({
                id: outcome.id,
                aciklama: outcome.aciklama
            })),
            
            // Etkinlik t√ºrleri listesi (import'tan koru)
            etkinlikTurleri: APP_STATE.courseData?.etkinlikTurleri || [
                "Alan √áalƒ±≈ümasƒ±", "Alan Gezisi", "Ara Sƒ±nav", "Ara Sƒ±nav ƒ∞√ßin Bireysel √áalƒ±≈üma",
                "Beyin Fƒ±rtƒ±nasƒ±", "Bireysel √áalƒ±≈üma", "B√ºt√ºnleme Sƒ±navƒ±", "Deney",
                "Deney Sonrasƒ± Quiz", "Derse Katƒ±lƒ±m", "Ev √ñdevi", "Final Sƒ±navƒ±",
                "Final Sƒ±navƒ± ƒ∞√ßin Bireysel √áalƒ±≈üma", "G√∂sterme", "G√∂zlem", "Laboratuvar",
                "Laboratuvar Ara Sƒ±navƒ±", "Laboratuvar Sƒ±navƒ±", "Makale Kritik Etme",
                "Makale Yazma", "Multirom CD √áalƒ±≈ümasƒ±", "√ñdev Problemleri ƒ∞√ßin √áalƒ±≈üma",
                "Okuma", "√ñrnek Vaka ƒ∞ncelemesi", "Performans", "Problem √á√∂z√ºm√º",
                "Proje Hazƒ±rlama", "Proje Sunma", "Proje Tasarƒ±mƒ±/Y√∂netimi", "Quiz",
                "Quiz ƒ∞√ßin Bireysel √áalƒ±≈üma", "Rapor", "Rapor Hazƒ±rlama", "Rapor Sunma",
                "Rehberli Problem √á√∂z√ºm√º", "Rol Oynama / Dramatizasyon", "Seminer",
                "Soru-Yanƒ±t", "S√∂zl√º Sƒ±nav", "Takƒ±m/Grup √áalƒ±≈ümasƒ±", "Tartƒ±≈üma",
                "Toplantƒ± Ba≈ükanlƒ±ƒüƒ± Yapma", "Uygulama/Pratik"
            ],
            
            // Yarƒ±yƒ±l i√ßi olasƒ± etkinlikler (import'tan koru)
            yariyilIciOlasiEtkinlikler: APP_STATE.courseData?.yariyilIciOlasiEtkinlikler || [
                "Ara Sƒ±nav", "Laboratuvar Sƒ±navƒ±", "Deney", "Deney Sonrasƒ± Quiz",
                "Performans", "Quiz", "Rapor", "Rapor Sunma", "Makale Kritik Etme",
                "Makale Yazma", "Proje Hazƒ±rlama", "Proje Sunma", "Rehberli Problem √á√∂z√ºm√º",
                "Seminer", "S√∂zl√º Sƒ±nav", "√ñdev Problemleri ƒ∞√ßin √áalƒ±≈üma", "Proje Tasarƒ±mƒ±/Y√∂netimi"
            ],
            
            // Yarƒ±yƒ±l sonu olasƒ± etkinlikler (import'tan koru)
            yariyilSonuOlasiEtkinlikler: APP_STATE.courseData?.yariyilSonuOlasiEtkinlikler || [
                "Final Sƒ±navƒ±", "Laboratuvar Ara Sƒ±navƒ±", "Makale Yazma", "Proje Hazƒ±rlama",
                "Proje Sunma", "Proje Tasarƒ±mƒ±/Y√∂netimi", "Quiz", "Rapor", "Rapor Hazƒ±rlama",
                "Rapor Sunma", "Seminer", "S√∂zl√º Sƒ±nav", "G√∂zlem"
            ],
            
            // Denetim bilgileri
            denetimBilgileri: {
                olusturmaTarihi: APP_STATE.courseData?.denetimBilgileri?.olusturmaTarihi || formattedDateTime,
                olusturan: APP_STATE.courseData?.denetimBilgileri?.olusturan || 'Ders Deƒüerlendirme Sistemi',
                sonGuncellenmeTarihi: formattedDateTime,
                guncelleyen: 'Ders Deƒüerlendirme Sistemi',
                durum: 'Taslak'
            }
        };
        
        // Ders Genel ve ƒ∞√ßerik bilgilerini APP_STATE'den al
        if (APP_STATE.courseData) {
            if (APP_STATE.courseData.dersGenel) {
                exportData.dersGenel = JSON.parse(JSON.stringify(APP_STATE.courseData.dersGenel));
            }
            
            if (APP_STATE.courseData.dersIcerik) {
                exportData.dersIcerik = JSON.parse(JSON.stringify(APP_STATE.courseData.dersIcerik));
            }
            
            // Diƒüer √∂nemli bilgileri koru
            if (APP_STATE.courseData.haftalikDersIcerikleri) {
                exportData.haftalikDersIcerikleri = JSON.parse(JSON.stringify(APP_STATE.courseData.haftalikDersIcerikleri));
            }
            
            if (APP_STATE.courseData.dersIsYuku) {
                exportData.dersIsYuku = JSON.parse(JSON.stringify(APP_STATE.courseData.dersIsYuku));
            }
            
            if (APP_STATE.courseData.programCiktilari) {
                exportData.programCiktilari = JSON.parse(JSON.stringify(APP_STATE.courseData.programCiktilari));
            }
            
            if (APP_STATE.courseData.programVeOgrenmeIliskisi) {
                exportData.programVeOgrenmeIliskisi = JSON.parse(JSON.stringify(APP_STATE.courseData.programVeOgrenmeIliskisi));
            }
            
            if (APP_STATE.courseData.toplumsalKatkiVeSurdurulebilirlik) {
                exportData.toplumsalKatkiVeSurdurulebilirlik = JSON.parse(JSON.stringify(APP_STATE.courseData.toplumsalKatkiVeSurdurulebilirlik));
            }
            
            if (APP_STATE.courseData.dersSekmeler) {
                exportData.dersSekmeler = JSON.parse(JSON.stringify(APP_STATE.courseData.dersSekmeler));
            }
            
            if (APP_STATE.courseData.numaralandirmaDegerleri) {
                exportData.numaralandirmaDegerleri = JSON.parse(JSON.stringify(APP_STATE.courseData.numaralandirmaDegerleri));
            }
        }
        
        return exportData;
    } catch (error) {
        console.error("Dƒ±≈üa aktarƒ±lacak veri olu≈üturulurken hata olu≈ütu:", error);
        showModernToast("Dƒ±≈üa aktarƒ±lacak veri olu≈üturulamadƒ±!", "error");
        return {};
    }
}

/**
 * Notlarƒ± JSON olarak dƒ±≈üa aktarma - Yeni temiz yapƒ±
 * @returns {Object} - Dƒ±≈üa aktarƒ±lacak not verisi
 */
function createGradesExportData() {
    try {
        // Sadece √∂ƒürenci notlarƒ± - temiz yapƒ±
        const exportData = {
            ogrenciNotlari: {}
        };
        
        // Her √∂ƒürenci i√ßin notlarƒ± olu≈ütur
        APP_STATE.studentData.forEach(student => {
            const studentId = student.studentId;
            const studentGrades = {};
            
            // Her etkinlik i√ßin notlarƒ± al
            APP_STATE.assessmentTree.forEach(activity => {
                if (activity.children && activity.children.length > 0) {
                    const activityGrades = {};
                    
                    // Grup bilgisini al
                    const studentGroup = getStudentGroup(studentId, activity.id) || 'A';
                    const groupMapping = APP_STATE.courseData?.grupHaritalari?.[activity.id]?.haritalar?.[studentGroup];
                    
                    // Her soru i√ßin puan ve soru ID'si
                    activity.children.forEach((child, index) => {
                        const questionOrder = (index + 1).toString();
                        
                        // Hangi soru ID'sine denk geldiƒüini bul
                        let questionId = child.id;
                        if (groupMapping && groupMapping[questionOrder]) {
                            questionId = groupMapping[questionOrder];
                        }
                        
                        // Kaƒüƒ±t sƒ±rasƒ±na g√∂re puanƒ± al
                        const grade = getStudentGrade(studentId, questionId) || 0;
                        
                        activityGrades[questionOrder] = {
                                                            puan: parseFloat(grade.toFixed(2)),
                            soruId: questionId
                        };
                    });
                    
                    studentGrades[activity.id] = activityGrades;
                }
            });
            
            // Grup bilgilerini ekle
            studentGrades.grupBilgileri = {};
            APP_STATE.assessmentTree.forEach(activity => {
                studentGrades.grupBilgileri[activity.id] = getStudentGroup(studentId, activity.id) || 'A';
            });
            
            exportData.ogrenciNotlari[studentId] = studentGrades;
        });
        
        return exportData;
    } catch (error) {
        console.error("Not verileri dƒ±≈üa aktarƒ±lƒ±rken hata olu≈ütu:", error);
        showModernToast("Not verileri dƒ±≈üa aktarƒ±lamadƒ±!", "error");
        return {};
    }
}

/**
 * Notlarƒ± CSV olarak dƒ±≈üa aktarma
 * @returns {string} - CSV formatƒ±ndaki not verisi
 */
function createGradesCSV() {
    try {
        // Final notlarƒ±nƒ± hesapla
        const finalGrades = {};
        
        APP_STATE.studentData.forEach(student => {
            const studentId = student.studentId;
            
            // Yarƒ±yƒ±l i√ßi etkinlikler
            const termActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('A'));
            let termGrade = 0;
            
            termActivities.forEach(activity => {
                const activityWeight = activity.weight / APP_STATE.termWeight; // Normalize
                let activityGrade = 0;
                
                if (activity.children && activity.children.length > 0) {
                    // Alt etkinlikler - grup haritalama dikkate alƒ±narak
                    const studentGroup = getStudentGroupForComponent(studentId, activity.id) || 'A';
                    const groupMapping = APP_STATE.courseData?.grupHaritalari?.[activity.id]?.haritalar?.[studentGroup];
                    
                    activity.children.forEach((subItem, index) => {
                        const subItemWeight = subItem.weight / 100; // subItem i√ßinde normalize
                        
                        // Grup haritalama varsa doƒüru soru ID'sini kullan
                        let questionId = subItem.id;
                        if (groupMapping) {
                            const questionOrder = (index + 1).toString();
                            if (groupMapping[questionOrder]) {
                                questionId = groupMapping[questionOrder];
                            }
                        }
                        
                        const grade = getStudentGrade(studentId, questionId) || 0;
                        const scaledGrade = (grade / subItem.points) * 100; // 100 √ºzerinden
                        activityGrade += scaledGrade * subItemWeight;
                    });
                } else {
                    // Basit etkinlik
                    const grade = getStudentGrade(studentId, activity.id) || 0;
                    activityGrade = (grade / activity.points) * 100; // 100 √ºzerinden
                }
                
                termGrade += activityGrade * activityWeight;
            });
            
            // Yarƒ±yƒ±l sonu etkinlikler
            const finalActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('F'));
            let finalGrade = 0;
            
            finalActivities.forEach(activity => {
                const activityWeight = activity.weight / APP_STATE.finalWeight; // Normalize
                let activityGrade = 0;
                
                if (activity.children && activity.children.length > 0) {
                    // Alt etkinlikler - grup haritalama dikkate alƒ±narak
                    const studentGroup = getStudentGroupForComponent(studentId, activity.id) || 'A';
                    const groupMapping = APP_STATE.courseData?.grupHaritalari?.[activity.id]?.haritalar?.[studentGroup];
                    
                    activity.children.forEach((subItem, index) => {
                        const subItemWeight = subItem.weight / 100; // subItem i√ßinde normalize
                        
                        // Grup haritalama varsa doƒüru soru ID'sini kullan
                        let questionId = subItem.id;
                        if (groupMapping) {
                            const questionOrder = (index + 1).toString();
                            if (groupMapping[questionOrder]) {
                                questionId = groupMapping[questionOrder];
                            }
                        }
                        
                        const grade = getStudentGrade(studentId, questionId) || 0;
                        const scaledGrade = (grade / subItem.points) * 100; // 100 √ºzerinden
                        activityGrade += scaledGrade * subItemWeight;
                    });
                } else {
                    // Basit etkinlik
                    const grade = getStudentGrade(studentId, activity.id) || 0;
                    activityGrade = (grade / activity.points) * 100; // 100 √ºzerinden
                }
                
                finalGrade += activityGrade * activityWeight;
            });
            
            // Toplam ve harf notu - RTEU Y√∂netmeliƒüi MADDE 26'ya g√∂re
            let totalGrade = (termGrade * APP_STATE.termWeight / 100) + (finalGrade * APP_STATE.finalWeight / 100);
            let letterGrade = getLetterGrade(totalGrade);
            
            // Yarƒ±yƒ±l sonu sƒ±navƒ± 50'nin altƒ±ndaysa FF verilir
            if (finalGrade < 50) {
                letterGrade = 'FF';
            }
            
            finalGrades[studentId] = {
                termGrade: termGrade.toFixed(2),
                finalGrade: finalGrade.toFixed(2),
                totalGrade: totalGrade.toFixed(2),
                letterGrade: letterGrade
            };
        });
        
        // CSV ba≈ülƒ±k satƒ±rƒ±
        let csv = "√ñƒürenci No,Adƒ±,Soyadƒ±,Durum,Yarƒ±yƒ±l ƒ∞√ßi,Yarƒ±yƒ±l Sonu,Toplam,Harf Notu\n";
        
        // Her √∂ƒürenci i√ßin satƒ±r ekle
        APP_STATE.studentData.forEach(student => {
            const studentGrade = finalGrades[student.studentId] || {
                termGrade: "0.00",
                finalGrade: "0.00",
                totalGrade: "0.00",
                letterGrade: "FF"
            };
            
            csv += `${student.studentId},${student.name},${student.surname},${student.status || 'Aktif'},${studentGrade.termGrade},${studentGrade.finalGrade},${studentGrade.totalGrade},${studentGrade.letterGrade}\n`;
        });
        
        return csv;
    } catch (error) {
        console.error("CSV olu≈üturulurken hata olu≈ütu:", error);
        showModernToast("CSV olu≈üturulamadƒ±!", "error");
        return '';
    }
}

/**
 * JSON verisini panoya kopyala
 */
function copyJsonToClipboard() {
    try {
        exportJsonContent.select();
        document.execCommand('copy');
        showModernToast("JSON verisi panoya kopyalandƒ±.");
    } catch (error) {
        console.error("JSON verisi kopyalanƒ±rken hata olu≈ütu:", error);
        showModernToast("JSON verisi kopyalanamadƒ±!", "error");
    }
}

/**
 * Notlarƒ± panoya kopyala
 */
function copyGradesToClipboard() {
    try {
        exportGradesContent.select();
        document.execCommand('copy');
        showModernToast("Not verileri panoya kopyalandƒ±.");
    } catch (error) {
        console.error("Not verileri kopyalanƒ±rken hata olu≈ütu:", error);
        showModernToast("Not verileri kopyalanamadƒ±!", "error");
    }
}

/**
 * JSON verisini dosyaya kaydet
 */
function saveJsonToFile() {
    try {
        const jsonData = exportJsonContent.value;
        const blob = new Blob([jsonData], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        
        // Eƒüer orijinal dosya adƒ± varsa kullan, yoksa yeni bir ad olu≈ütur
        if (APP_STATE.jsonFileName) {  // jsonFileName -> APP_STATE.jsonFileName
            a.download = APP_STATE.jsonFileName;
        } else {
            const dersKodu = APP_STATE.courseData?.dersGenel?.dersKodu || 'ders';
            a.download = `${dersKodu}_degerlendirme.json`;
        }
        
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showModernToast("JSON dosyasƒ± ba≈üarƒ±yla kaydedildi.");
    } catch (error) {
        console.error("JSON dosyasƒ± kaydedilirken hata olu≈ütu:", error);
        showModernToast("JSON dosyasƒ± kaydedilemedi!", "error");
    }
}


/**
 * Dosya y√ºkleme i≈ülemi
 * @param {Event} event - Dosya se√ßme olayƒ±
 */
function loadJsonFromFile(event) {
    try {
        const file = event.target.files[0];
        if (!file) {
            showModernToast("Dosya se√ßilmedi.", "warning");
            return;
        }
        
        APP_STATE.jsonFileName = file.name;
        selectedFileName.textContent = file.name;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                jsonContent.value = e.target.result;
                showModernToast("Dosya ba≈üarƒ±yla y√ºklendi. Uygulamak i√ßin 'Uygula' butonuna tƒ±klayƒ±n.");
            } catch (error) {
                console.error("Dosya okuma hatasƒ±:", error);
                showModernToast("Dosya okunamadƒ±: " + error.message, "error");
            }
        };
        
        reader.onerror = function() {
            showModernToast("Dosya okuma hatasƒ± olu≈ütu.", "error");
        };
        
        reader.readAsText(file);
    } catch (error) {
        console.error("Dosya y√ºkleme hatasƒ±:", error);
        showModernToast("Dosya y√ºklenemedi: " + error.message, "error");
    }
}

/**
 * JSON verisini uygulama - T√ºm formatlarƒ± destekler
 */
function applyJsonData() {
    try {
        const jsonString = jsonContent.value.trim();
        
        if (!jsonString) {
            showModernToast("L√ºtfen ge√ßerli bir JSON i√ßeriƒüi girin.", "warning");
            return;
        }
        
        const jsonData = JSON.parse(jsonString);
        
        // Temel doƒürulama
        if (!jsonData || typeof jsonData !== 'object') {
            throw new Error('Ge√ßersiz JSON formatƒ±.');
        }
        
        // Ders verilerini kaydet
        APP_STATE.courseData = jsonData;
        
        // √ñƒürenme √ßƒ±ktƒ±larƒ±nƒ± ayarla
        if (jsonData.dersOgrenme√áiktilari && Array.isArray(jsonData.dersOgrenme√áiktilari)) {
            APP_STATE.learningOutcomes = jsonData.dersOgrenme√áiktilari;
            console.log('√ñ√á verileri y√ºklendi:', APP_STATE.learningOutcomes);
            renderOutcomes();
            showModernToast(`${APP_STATE.learningOutcomes.length} adet √∂ƒürenme √ßƒ±ktƒ±sƒ± y√ºklendi.`, "success");
        } else {
            console.log('√ñ√á verileri bulunamadƒ±:', jsonData.dersOgrenme√áiktilari);
            showModernToast("JSON'da √∂ƒürenme √ßƒ±ktƒ±sƒ± bulunamadƒ±!", "warning");
        }
        
        // Program √ßƒ±ktƒ±larƒ±nƒ± ayarla
        if (jsonData.programCiktilari && Array.isArray(jsonData.programCiktilari)) {
            APP_STATE.programOutcomes = jsonData.programCiktilari;
            renderProgramOutcomes();
            showModernToast(`${APP_STATE.programOutcomes.length} adet program √ßƒ±ktƒ±sƒ± y√ºklendi.`, "success");
        } else {
            showModernToast("JSON'da program √ßƒ±ktƒ±sƒ± bulunamadƒ±!", "warning");
        }
        
        // √ñ√á-P√á ƒ∞li≈üki Matrisini ayarla
        if (jsonData.programVeOgrenmeIliskisi && jsonData.programVeOgrenmeIliskisi.iliskiTablosu) {
            APP_STATE.outcomeMatrix = jsonData.programVeOgrenmeIliskisi;
            renderOutcomeMatrix();
        }
        
        // Ders bilgilerini g√ºncelle
        updateCourseInfo();
        
        // Ders detaylarƒ±nƒ± render et
        renderCourseDetails();
        
        // Deƒüerlendirme aƒüacƒ± i√ßin veri yapƒ±sƒ± olu≈ütur
        if (jsonData.degerlendirmeAgaci) {
            // Doƒürudan aƒüacƒ± al (eƒüer daha √∂nce kaydedilmi≈üse)
            APP_STATE.assessmentTree = jsonData.degerlendirmeAgaci;
            showModernToast("Deƒüerlendirme aƒüacƒ± JSON'dan y√ºklendi.", "success");
        } else if (jsonData.assessmentTree) {
            APP_STATE.assessmentTree = jsonData.assessmentTree;
            showModernToast("Deƒüerlendirme aƒüacƒ± JSON'dan y√ºklendi.", "success");
        } else {
            // Ders verilerinden aƒüa√ß olu≈ütur
            createAssessmentTreeFromCourseData();
            showModernToast("Deƒüerlendirme aƒüacƒ± ders verilerinden olu≈üturuldu ve √ñ√á'ler otomatik atandƒ±.", "info");
        }
        
        // Eƒüer deƒüerlendirme aƒüacƒ± hala bo≈üsa, default sorular ekle
        if (!APP_STATE.assessmentTree || APP_STATE.assessmentTree.length === 0) {
            createDefaultAssessmentTree();
            showModernToast("Varsayƒ±lan deƒüerlendirme aƒüacƒ± olu≈üturuldu ve √ñ√á'ler otomatik atandƒ±.", "info");
        }
        
        // Temel dosya format i√ßin default grup sistemi ve soru atamasƒ±
        if (!isTamDosyaFormat(jsonData)) {
            console.log("üîß Temel dosya format tespit edildi, default grup sistemi olu≈üturuluyor...");
            createDefaultGroupSystemForTemelDosya();
            showModernToast("Temel dosya format i√ßin A grubu ve soru atamalarƒ± olu≈üturuldu!", "success");
        }

        
        // Grup haritalama bilgilerini √ñNCE y√ºkle
        console.log("üîß Grup haritalama bilgileri y√ºkleme √ßaƒürƒ±sƒ± yapƒ±lƒ±yor...");
        console.log("üìÑ JSON data kontrol√º:", {
            hasJsonData: !!jsonData,
            hasDersDegerlendirme: !!jsonData.dersDegerlendirme,
            jsonKeys: Object.keys(jsonData)
        });
        
        // Fonksiyonun var olup olmadƒ±ƒüƒ±nƒ± kontrol et
        if (typeof loadGroupMappingsFromAssessmentData === 'function') {
            console.log("‚úÖ loadGroupMappingsFromAssessmentData fonksiyonu bulundu, √ßaƒürƒ±lƒ±yor...");
            try {
                loadGroupMappingsFromAssessmentData(jsonData);
                console.log("‚úÖ loadGroupMappingsFromAssessmentData √ßaƒürƒ±sƒ± ba≈üarƒ±yla tamamlandƒ±");
            } catch (error) {
                console.error("‚ùå loadGroupMappingsFromAssessmentData √ßaƒürƒ±sƒ±nda hata:", error);
            }
        } else {
            console.error("‚ùå loadGroupMappingsFromAssessmentData fonksiyonu bulunamadƒ±!");
            console.log("üîç Mevcut fonksiyonlar:", Object.keys(window).filter(key => key.includes('loadGroup')));
        }
        
        console.log("üîß Grup haritalama bilgileri y√ºkleme √ßaƒürƒ±sƒ± tamamlandƒ±");
        
        // Aƒüacƒ± render et
        renderTree();
        
        // v5 format i√ßin ek grup bilgisi g√ºncelleme
        setTimeout(() => {
            console.log("üîÑ JSON import sonrasƒ± grup UI zorlamalƒ± g√ºncellemesi...");
            updateAllInlineGroupInputs();
            
            // Bile≈üen grup bilgilerini de g√ºncelle
            document.querySelectorAll('.componentGroupInfo').forEach(input => {
                const componentId = input.dataset.componentId;
                if (componentId) {
                    updateComponentGroupInfo(componentId);
                }
            });
        }, 200);
        
        // √ñƒürencileri i√ße aktar
        let hasStudentData = false;
        
        // Format 1: ogrenciler dizisi
        if (jsonData.ogrenciler && Array.isArray(jsonData.ogrenciler)) {
            APP_STATE.studentData = jsonData.ogrenciler.map((student, index) => ({
                studentId: student.ogrenciNo,
                name: student.ad,
                surname: student.soyad,
                status: student.durum || 'Aktif',
                grup: student.grup || 'A', // Default grup atamasƒ±
                email: student.email || '', // Email bilgisini koru
                tcKimlik: student.tcKimlik || '', // TC Kimlik bilgisini koru
                telefon: student.telefon || '' // Telefon bilgisini koru
            }));
            hasStudentData = true;
            showModernToast(`${APP_STATE.studentData.length} √∂ƒürenci verisi y√ºklendi.`, "success");
        } 
        // Format 2: students dizisi
        else if (jsonData.students && Array.isArray(jsonData.students)) {
            APP_STATE.studentData = jsonData.students.map((student, index) => ({
                studentId: student.studentId || student.student_id || student.ogrenciNo,
                name: student.name || student.ad,
                surname: student.surname || student.soyad, 
                status: student.status || student.durum || 'Aktif',
                grup: student.grup || student.group || 'A', // Default grup atamasƒ±
                email: student.email || '', // Email bilgisini koru
                tcKimlik: student.tcKimlik || '', // TC Kimlik bilgisini koru
                telefon: student.telefon || '' // Telefon bilgisini koru
            }));
            hasStudentData = true;
            showModernToast(`${APP_STATE.studentData.length} √∂ƒürenci verisi y√ºklendi.`, "success");
        }
        // Format 3: courseData.ogrenciler
        else if (jsonData.courseData && jsonData.courseData.ogrenciler && Array.isArray(jsonData.courseData.ogrenciler)) {
            APP_STATE.studentData = jsonData.courseData.ogrenciler.map((student, index) => ({
                studentId: student.ogrenciNo,
                name: student.ad,
                surname: student.soyad,
                status: student.durum || 'Aktif',
                grup: student.grup || 'A', // Default grup atamasƒ±
                email: student.email || '', // Email bilgisini koru
                tcKimlik: student.tcKimlik || '', // TC Kimlik bilgisini koru
                telefon: student.telefon || '' // Telefon bilgisini koru
            }));
            hasStudentData = true;
            showModernToast(`${APP_STATE.studentData.length} √∂ƒürenci verisi y√ºklendi.`, "success");
        } else {
            showModernToast("JSON'da √∂ƒürenci verisi bulunamadƒ±!", "warning");
        }
        
        // √ñƒürenci notlarƒ± y√ºkleme
        if (hasStudentData) {
            // √ñnce not verilerini sƒ±fƒ±rla
            APP_STATE.gradesData = {};
            
            // Format 1: ogrenciNotlari (en yaygƒ±n format) - v5 formatƒ±nƒ± destekle
            if (jsonData.ogrenciNotlari && typeof jsonData.ogrenciNotlari === 'object') {
                // v5 formatƒ±nƒ± tam olarak destekle
                loadStudentGradesNewFormat(jsonData);
                const gradeCount = Object.keys(APP_STATE.gradesData).length;
                showModernToast(`${gradeCount} √∂ƒürencinin not verisi y√ºklendi (Tam Dosya format).`, "success");
            }
            // Format 2: grades
            else if (jsonData.grades && typeof jsonData.grades === 'object') {
                // Tam olarak kopyala - derin kopya
                APP_STATE.gradesData = JSON.parse(JSON.stringify(jsonData.grades));
                const gradeCount = Object.keys(APP_STATE.gradesData).length;
                showModernToast(`${gradeCount} √∂ƒürencinin not verisi y√ºklendi.`, "success");
            }
            // Format 3: rawGrades
            else if (jsonData.rawGrades && typeof jsonData.rawGrades === 'object') {
                // Tam olarak kopyala - derin kopya
                APP_STATE.gradesData = JSON.parse(JSON.stringify(jsonData.rawGrades));
                const gradeCount = Object.keys(APP_STATE.gradesData).length;
                showModernToast(`${gradeCount} √∂ƒürencinin not verisi y√ºklendi.`, "success");
            } else {
                showModernToast("JSON'da not verisi bulunamadƒ±!", "warning");
            }
            
            // Grup sistem bilgilerini y√ºkle ve doƒürula
            if (jsonData.grupHaritalari && typeof jsonData.grupHaritalari === 'object') {
                // Grup haritalarƒ±nƒ± courseData'ya kaydet (derin kopya ile)
                if (!APP_STATE.courseData) {
                    APP_STATE.courseData = {};
                }
                APP_STATE.courseData.grupHaritalari = JSON.parse(JSON.stringify(jsonData.grupHaritalari));
                
                // Grup veri yapƒ±sƒ±nƒ± doƒürula ve eksik kƒ±sƒ±mlarƒ± tamamla
                validateAndCompleteGroupData();
                
                // Grup sistemini ba≈ülat
                initializeGroupSystem();
                
                console.log('Grup haritalarƒ± y√ºklendi ve doƒürulandƒ±:', APP_STATE.courseData.grupHaritalari);
                showModernToast("Grup haritalarƒ± y√ºklendi ve doƒürulandƒ±.", "success");
            } else {
                // Varsayƒ±lan grup sistemi ba≈ülat
                initializeGroupSystem();
                
                // Eƒüer √∂ƒürencilerde grup bilgisi eksikse, hepsini A grubuna ata ve sƒ±rala
                assignDefaultGroups();
                
                console.log('Varsayƒ±lan grup sistemi olu≈üturuldu');
                showModernToast("Varsayƒ±lan grup sistemi olu≈üturuldu.", "info");
            }
            
            // √ñƒürenci tablosunu g√ºncelle
            updateStudentTable();
            
            // Grup se√ßicilerini g√ºncelle
            updateGroupSelectors();
            
            // Dual range slider uyarƒ±sƒ±nƒ± g√ºncelle
            const minSlider = document.getElementById('groupMinSlider');
            const maxSlider = document.getElementById('groupMaxSlider');
            if (minSlider && maxSlider) {
                updateDualRangeWarning(parseInt(minSlider.value), parseInt(maxSlider.value));
            }
        }
        
        // Deƒüerlendirme g√∂r√ºn√ºm√ºn√º g√ºncelle
        updateAssessmentView();
        
        // √ñƒürenci sayƒ±larƒ±nƒ± g√ºncelle (JSON y√ºklendikten sonra)
        if (hasStudentData) {
            const passRateSlider = document.getElementById('passRateSlider');
            if (passRateSlider) {
                const passRate = parseInt(passRateSlider.value);
                updateStudentCounts(passRate);
            }
            updatePassFailCounts();
        }
        
        closeModal(importModal);
        showModernToast("JSON verisi ba≈üarƒ±yla y√ºklendi.");
        
        // Otomatik kayƒ±t trigger
        if (autoSaveManager) {
            autoSaveManager.hasUnsavedChanges = true;
            autoSaveManager.updateFloatingButton('unsaved');
        }
        
        // √ñƒürenci verileri y√ºklendiyse deƒüerlendirme sekmesine ge√ß
        if (hasStudentData) {
            setTimeout(() => {
                switchTab('assessment');
            }, 500);
        }
        
    } catch (error) {
        console.error("JSON verisi uygulanƒ±rken hata olu≈ütu:", error);
        showModernToast("JSON verisi uygulanamadƒ±: " + error.message, "error");
    }
}

/**
 * √ñƒürenci dosyasƒ±nƒ± y√ºkleme
 * @param {Event} event - Dosya se√ßme olayƒ±
 */
function loadStudentJsonFromFile(event) {
    try {
        const file = event.target.files[0];
        if (!file) {
            showModernToast("Dosya se√ßilmedi.", "warning");
            return;
        }
        
        selectedStudentFileName.textContent = file.name;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                studentJsonContent.value = e.target.result;
                showModernToast("√ñƒürenci dosyasƒ± ba≈üarƒ±yla y√ºklendi. Uygulamak i√ßin 'Uygula' butonuna tƒ±klayƒ±n.");
            } catch (error) {
                console.error("Dosya okuma hatasƒ±:", error);
                showModernToast("Dosya okunamadƒ±: " + error.message, "error");
            }
        };
        
        reader.onerror = function() {
            showModernToast("Dosya okuma hatasƒ± olu≈ütu.", "error");
        };
        
        reader.readAsText(file);
    } catch (error) {
        console.error("√ñƒürenci dosyasƒ± y√ºkleme hatasƒ±:", error);
        showModernToast("√ñƒürenci dosyasƒ± y√ºklenemedi: " + error.message, "error");
    }
}

/**
 * √ñƒürenci dosyasƒ±nƒ± doƒürudan y√ºkleme
 * @param {Event} event - Dosya se√ßme olayƒ±
 */
function loadStudentsFromFile(event) {
    try {
        const file = event.target.files[0];
        if (!file) {
            showModernToast("Dosya se√ßilmedi.", "warning");
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const jsonData = JSON.parse(e.target.result);
                importStudentData(jsonData);
                showModernToast("√ñƒürenci listesi ba≈üarƒ±yla y√ºklendi.");
            } catch (error) {
                console.error("√ñƒürenci verisi i≈üleme hatasƒ±:", error);
                showModernToast("√ñƒürenci dosyasƒ± i≈ülenemedi: " + error.message, "error");
            }
        };
        
        reader.onerror = function() {
            showModernToast("Dosya okuma hatasƒ± olu≈ütu.", "error");
        };
        
        reader.readAsText(file);
    } catch (error) {
        console.error("√ñƒürenci dosyasƒ± y√ºkleme hatasƒ±:", error);
        showModernToast("√ñƒürenci dosyasƒ± y√ºklenemedi: " + error.message, "error");
    }
}

/**
 * Not verilerini dosyaya kaydet
 */
function saveGradesToFile() {
    try {
        const data = exportGradesContent.value;
        
        // ƒ∞√ßerik kontrol√º
        if (!data || data.trim() === '') {
            showModernToast("Kaydedilecek veri bulunamadƒ±!", "warning");
            return;
        }
        
        const isCSV = data.startsWith("√ñƒürenci No,Adƒ±");
        const mimeType = isCSV ? 'text/csv' : 'application/json';
        const extension = isCSV ? 'csv' : 'json';
        
        const blob = new Blob([data], { type: mimeType });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        
        const dersKodu = APP_STATE.courseData?.dersGenel?.dersKodu || 'ders';
        const dateStr = new Date().toISOString().slice(0, 10);
        a.download = `${dersKodu}_notlar_${dateStr}.${extension}`;
        
        document.body.appendChild(a);
        a.click();
        
        // Temizlemeyi geciktir - indirme i≈üleminin ba≈ülamasƒ± i√ßin zaman ver
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 200);
        
        showModernToast(`Not dosyasƒ± (.${extension}) ba≈üarƒ±yla kaydedildi.`);
    } catch (error) {
        console.error("Not dosyasƒ± kaydedilirken hata olu≈ütu:", error);
        showModernToast("Not dosyasƒ± kaydedilemedi: " + error.message, "error");
    }
}

/**
 * Test detaylarƒ± modalƒ±nƒ± g√∂sterme
 */
function showTestDetailsModal() {
    if (!APP_STATE.testDetailsNode) return;
    
    const node = APP_STATE.testDetailsNode;
    
    totalQuestionsInput.value = node.testDetails?.totalQuestions || 20;
    correctWeightInput.value = node.testDetails?.correctWeight || 5;
    wrongPenaltyInput.value = node.testDetails?.wrongPenalty || 0;
    
    openModal(testDetailsModal);
}

/**
 * Test detaylarƒ±nƒ± kaydetme
 */
function saveTestDetails() {
    if (!APP_STATE.testDetailsNode) return;
    
    try {
        const totalQuestions = parseInt(totalQuestionsInput.value) || 20;
        const correctWeight = parseFloat(correctWeightInput.value) || 5;
        const wrongPenalty = parseFloat(wrongPenaltyInput.value) || 0;
        
        APP_STATE.testDetailsNode.testDetails = {
            totalQuestions,
            correctWeight,
            wrongPenalty
        };
        
        // Toplam puanƒ± hesapla
        APP_STATE.testDetailsNode.points = totalQuestions * correctWeight;
        
        // Aƒüacƒ± yeniden render et
        renderTree();
        
        // Deƒüerlendirme sekmesini g√ºncelle
        updateAssessmentView();
        
        // Modalƒ± kapat
        closeModal(testDetailsModal);
        
        showModernToast("Test detaylarƒ± kaydedildi.");
    } catch (error) {
        console.error("Test detaylarƒ± kaydedilirken hata olu≈ütu:", error);
        showModernToast("Test detaylarƒ± kaydedilemedi!", "error");
    }
}

/**
 * Modali a√ßma fonksiyonu
 * @param {HTMLElement} modal - A√ßƒ±lacak modal elementi
 */
function openModal(modal) {
    if (modal) {
        modal.style.display = 'flex';
    }
}

/**
 * Modali kapatma fonksiyonu
 * @param {HTMLElement} modal - Kapatƒ±lacak modal elementi
 */
function closeModal(modal) {
    if (modal) {
        modal.style.display = 'none';
    }
}


/**
 * Se√ßili sekmeyi deƒüi≈ütirme
 * @param {string} tabId - Sekme ID'si
 */
function switchTab(tabId) {
    const tabs = document.querySelectorAll('.nav-tab');
    const contents = document.querySelectorAll('.nav-content');
    
    // √ñnce t√ºm tablarƒ± pasif yap
    tabs.forEach(tab => tab.classList.remove('active'));
    contents.forEach(content => {
        content.classList.remove('active');
        content.style.display = 'none';
    });
    
    // Se√ßili tabƒ± aktif yap
    const selectedTab = document.querySelector(`.nav-tab[data-tab="${tabId}"]`);
    const selectedContent = document.getElementById(`${tabId}-content`);
    
    if (selectedTab && selectedContent) {
        selectedTab.classList.add('active');
        selectedContent.classList.add('active');
        selectedContent.style.display = 'block';
        APP_STATE.currentActiveTabId = tabId;
        
        // √ñƒürenci listesi sekmesi a√ßƒ±ldƒ±ƒüƒ±nda grup bilgilerini g√ºncelle
        if (tabId === 'students') {
            setTimeout(() => {
                updateStudentGroupInfo();
                setupTableViewControls(); // Tablo g√∂r√ºn√ºm kontrollerini yeniden ayarla
            }, 100);
        }
        
        // Deƒüerlendirme giri≈üi sekmesi a√ßƒ±ldƒ±ƒüƒ±nda g√ºncelle
        if (tabId === 'assessment') {
            setTimeout(() => {
                updateAssessmentView();
            }, 100);
        }
        
        // Log sekmesi a√ßƒ±ldƒ±ƒüƒ±nda log sistemini ba≈ülat
        if (tabId === 'logs') {
            setTimeout(() => {
                initializeLogSystem();
            }, 100);
        }
        
        // √ñƒürenci bazlƒ± not giri≈üi sekmesi kaldƒ±rƒ±ldƒ±
    }
}
/**
 * Tarihi okunabilir formata √ßevirme
 * @param {string} isoDate - ISO formatlƒ± tarih
 * @returns {string} - Formatlanmƒ±≈ü tarih
 */
function formatDate(isoDate) {
    if (!isoDate) return '';
    
    const date = new Date(isoDate);
    return date.toLocaleDateString('tr-TR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

/**
 * Dosya adƒ±ndan uzantƒ±yƒ± √ßƒ±karma
 * @param {string} filename - Dosya adƒ±
 * @returns {string} - Uzantƒ±sƒ±z dosya adƒ±
 */
function removeExtension(filename) {
    if (!filename) return '';
    return filename.replace(/\.[^/.]+$/, "");
}

// =====================================================
// EVENT LISTENERS VE GLOBAL FONKSƒ∞YONLAR
// =====================================================

// Global scope'a fonksiyonlarƒ± ekle
window.updateStudentGrade = updateStudentGrade;
window.updateTestScore = updateTestScore;
window.updateStudentGradeFromStudentView = updateStudentGradeFromStudentView;
window.updateTestScoreFromStudentView = updateTestScoreFromStudentView;

// =====================================================
// OTOMATIK G√úNCELLEME Sƒ∞STEMƒ∞
// =====================================================

/**
 * Deƒüerlendirme ile ilgili bile≈üenleri g√ºnceller
 * updateAssessmentView i√ßinden √ßaƒürƒ±lƒ±r
 */
function updateAssessmentRelatedComponents() {
    try {
        console.log('üîÑ Deƒüerlendirme bile≈üenleri g√ºncelleniyor...');
        
        // G√ºncelleme i≈ülemlerini sƒ±rayla yap (grup se√ßicileri hari√ß - HTML olu≈üturma sƒ±rasƒ±nda yapƒ±lƒ±yor)
        const updateOperations = [
            // { name: 'Grup se√ßicileri', func: () => updateGroupSelectors() }, // Kaldƒ±rƒ±ldƒ±
            { name: '√ñ√á g√∂r√ºn√ºmleri', func: () => updateOutcomesTextarea?.() },
            { name: 'Kategori aƒüƒ±rlƒ±klarƒ±', func: () => updateCategoryWeights?.() },
            { name: 'Grup haritalama bilgileri', func: () => updateAllMappingDisplays?.() },
            { name: 'Maksimum puan bilgileri', func: () => addMaxPointsToInputs?.() },
            { name: 'Grup bilgileri', func: () => updateAllInlineGroupInputs?.() },
            { name: '√ñƒürenci filtre se√ßenekleri', func: () => updateAssessmentStudentFilterOptions?.() }
        ];
        
        let successCount = 0;
        let errorCount = 0;
        
        updateOperations.forEach(operation => {
            try {
                if (operation.func) {
                    operation.func();
                    successCount++;
                    console.log(`‚úÖ ${operation.name} g√ºncellendi`);
                } else {
                    console.warn(`‚ö†Ô∏è ${operation.name} fonksiyonu bulunamadƒ±`);
                }
            } catch (error) {
                errorCount++;
                console.error(`‚ùå ${operation.name} g√ºncellenirken hata:`, error);
            }
        });
        
        console.log(`üîÑ Deƒüerlendirme bile≈üenleri g√ºncellendi: ${successCount} ba≈üarƒ±lƒ±, ${errorCount} hatalƒ±`);
        
    } catch (error) {
        console.error('‚ùå updateAssessmentRelatedComponents genel hatasƒ±:', error);
    }
}

// =====================================================
// MEVCUT FONKSƒ∞YONLARA OTOMATƒ∞K G√úNCELLEME EKLEMESƒ∞
// =====================================================

// T√ºm olay dinleyicileri ayarla
// T√ºm olay dinleyicileri ayarla
document.addEventListener('DOMContentLoaded', function() {
    try {
        // √ñƒürenci bazlƒ± not giri≈üi sekmesi kaldƒ±rƒ±ldƒ± - butonlar temizlendi
        
        // Not i≈ülemleri butonlarƒ±
        if (btnImportGrades) btnImportGrades.addEventListener('click', importGrades);
        if (btnSaveGrades) {
            btnSaveGrades.addEventListener('click', saveGrades);
            btnSaveGrades.addEventListener('click', saveGradesToFile);
        }
        
        // JSON i≈ülemleri butonlarƒ±
        if (btnImport) btnImport.addEventListener('click', () => openModal(importModal));
        if (closeImportModal) closeImportModal.addEventListener('click', () => closeModal(importModal));
        if (btnExport) {
            btnExport.addEventListener('click', () => {
                try {
                    // JSON verisi olu≈ütur
                    const exportData = createExportData();
                    if (exportJsonContent) {
                        exportJsonContent.value = JSON.stringify(exportData, null, 2);
                    }
                    openModal(exportModal);
                } catch (error) {
                    console.error("JSON dƒ±≈üa aktarma hatasƒ±:", error);
                    showModernToast("JSON dƒ±≈üa aktarma i≈ülemi ba≈üarƒ±sƒ±z oldu!", "error");
                }
            });
        }
        
        // Modal kapatma butonlarƒ±
        if (closeExportModal) closeExportModal.addEventListener('click', () => closeModal(exportModal));
        if (closeImportStudentsModal) closeImportStudentsModal.addEventListener('click', () => closeModal(importStudentsModal));
        if (closeExportGradesModal) closeExportGradesModal.addEventListener('click', () => closeModal(exportGradesModal));
        if (closeTestDetailsModal) closeTestDetailsModal.addEventListener('click', () => closeModal(testDetailsModal));
        if (closeMultipleItemsModal) closeMultipleItemsModal.addEventListener('click', () => closeModal(multipleItemsModal));
        
        // Dosya i≈ülemleri butonlarƒ±
        if (btnSelectFile) btnSelectFile.addEventListener('click', () => fileInput && fileInput.click());
        if (btnApplyJson) btnApplyJson.addEventListener('click', applyJsonData);
        if (fileInput) fileInput.addEventListener('change', loadJsonFromFile);
        if (btnCopyJson) btnCopyJson.addEventListener('click', copyJsonToClipboard);
        if (btnSaveJson) btnSaveJson.addEventListener('click', saveJsonToFile);
        
        // √ñƒürenci i≈ülemleri butonlarƒ±
        if (btnImportStudents) btnImportStudents.addEventListener('click', () => openModal(importStudentsModal));
        if (btnSelectStudentFile) btnSelectStudentFile.addEventListener('click', () => studentJsonInput && studentJsonInput.click());
        if (btnApplyStudentJson) btnApplyStudentJson.addEventListener('click', applyStudentJsonData);
        if (studentJsonInput) studentJsonInput.addEventListener('change', loadStudentJsonFromFile);
        if (studentFileInput) studentFileInput.addEventListener('change', loadStudentsFromFile);
        // btnClearStudents event listener'ƒ± a≈üaƒüƒ±da test butonlarƒ± kƒ±smƒ±nda tanƒ±mlandƒ±
        
        // √ñƒürenci listesi sekmesindeki temizleme butonu (farklƒ± ID ve fonksiyon)
        const btnClearStudentList = document.getElementById('btnClearStudentList');
        if (btnClearStudentList) btnClearStudentList.addEventListener('click', clearStudents);
        
        // Not dƒ±≈üa aktarma butonlarƒ±
        if (btnExportGradesJSON) btnExportGradesJSON.addEventListener('click', () => showExportGradesModal('json'));
        if (btnExportGradesExcel) btnExportGradesExcel.addEventListener('click', () => showExportGradesModal('csv'));
        if (btnCopyGrades) btnCopyGrades.addEventListener('click', copyGradesToClipboard);
        if (btnSaveGradesToFile) btnSaveGradesToFile.addEventListener('click', saveGradesToFile);
        if (btnCalculateGrades) btnCalculateGrades.addEventListener('click', calculateGrades);
        if (btnExportFinalGrades) btnExportFinalGrades.addEventListener('click', () => showExportGradesModal('csv'));
        
        // Test detaylarƒ± butonlarƒ±
        if (btnSaveTestDetails) btnSaveTestDetails.addEventListener('click', saveTestDetails);
        
        // ƒ∞lk y√ºklemede status badge'leri g√ºncelle
        updatePassFailCounts();
        
        // Sekme i≈ülemleri i√ßin event listeners
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                if (tabId) switchTab(tabId);
            });
        });
        
        // Daha detaylƒ± tab i≈ülemleri
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                try {
                    // Aktif sekme sƒ±nƒ±fƒ±nƒ± kaldƒ±r
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    
                    // Aktif i√ßerik sƒ±nƒ±fƒ±nƒ± kaldƒ±r
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Se√ßilen sekmeyi aktif yap
                    tab.classList.add('active');
                    
                    // ƒ∞lgili i√ßeriƒüi g√∂ster
                    const tabId = tab.getAttribute('data-tab');
                    if (tabId) {
                        const contentElement = document.getElementById(`${tabId}Tab`);
                        if (contentElement) contentElement.classList.add('active');
                    }
                } catch (error) {
                    console.error("Tab i≈ülemi hatasƒ±:", error);
                }
            });
        });
        
        // Etkinlik ekleme butonlarƒ±
        if (btnAddTerm) btnAddTerm.addEventListener('click', addTermActivity);
        if (btnAddFinal) btnAddFinal.addEventListener('click', addFinalActivity);
        
        // Soru ve Rubrik ekleme butonlarƒ± - se√ßili unsur olmasa da √ßalƒ±≈ümalƒ±
        if (btnAddQuestion) btnAddQuestion.addEventListener('click', function() {
            // √áoklu soru eklemek i√ßin modal g√∂ster - se√ßili unsur kontrol√º modal i√ßinde yapƒ±lacak
            showMultipleItemsModal('soru');
        });
        
        if (btnAddRubric) btnAddRubric.addEventListener('click', function() {
            // √áoklu rubrik eklemek i√ßin modal g√∂ster - se√ßili unsur kontrol√º modal i√ßinde yapƒ±lacak
            showMultipleItemsModal('rubrik');
        });
        
        // Diƒüer aƒüa√ß i≈ülem butonlarƒ±
        if (btnRemove) btnRemove.addEventListener('click', removeNode);
        if (btnExpandAll) btnExpandAll.addEventListener('click', expandAll);
        if (btnCollapseAll) btnCollapseAll.addEventListener('click', collapseAll);
        
        // Rubrik ve soru t√ºrleri i√ßin click event
        document.querySelectorAll('.rubric-item').forEach(item => {
            item.addEventListener('click', function() {
                try {
                    if (!APP_STATE.selectedNode) {
                        showModernToast("L√ºtfen √∂nce bir etkinlik se√ßin.", "warning");
                        return;
                    }
                    
                    // Se√ßili d√ºƒü√ºm k√∂k deƒüilse alt d√ºƒü√ºm eklenmemeli
                    if (APP_STATE.selectedNode.id.includes('.')) {
                        showModernToast("Rubrikler sadece ana etkinliklere eklenebilir.", "warning");
                        return;
                    }
                    
                    const rubricType = this.getAttribute('data-type');
                    const description = this.getAttribute('data-description');
                    addRubricToNode(APP_STATE.selectedNode, rubricType, description);
                } catch (error) {
                    console.error("Rubrik ekleme hatasƒ±:", error);
                    showModernToast("Rubrik eklenirken bir hata olu≈ütu!", "error");
                }
            });
        });
        
        document.querySelectorAll('.question-type-item').forEach(item => {
            item.addEventListener('click', function() {
                try {
                    if (!APP_STATE.selectedNode) {
                        showModernToast("L√ºtfen √∂nce bir etkinlik se√ßin.", "warning");
                        return;
                    }
                    
                    // Se√ßili d√ºƒü√ºm k√∂k deƒüilse alt d√ºƒü√ºm eklenmemeli
                    if (APP_STATE.selectedNode.id.includes('.')) {
                        showModernToast("Sorular sadece ana etkinliklere eklenebilir.", "warning");
                        return;
                    }
                    
                    const questionType = this.getAttribute('data-type');
                    
                    // Test t√ºr√º i√ßin √∂zel i≈ülem
                    if (questionType === 'Test') {
                        addTestToNode(APP_STATE.selectedNode);
                        return;
                    }
                    
                    const description = this.getAttribute('data-description');
                    addQuestionToNode(APP_STATE.selectedNode, questionType, description);
                } catch (error) {
                    console.error("Soru ekleme hatasƒ±:", error);
                    showModernToast("Soru eklenirken bir hata olu≈ütu!", "error");
                }
            });
        });
        
        // √ñƒürenme √ßƒ±ktƒ±larƒ± i√ßin tƒ±klama i≈ülemleri
        document.querySelectorAll('.outcome-item').forEach(item => {
            item.addEventListener('click', function() {
                try {
                    if (APP_STATE.selectedNode) {
                        const outcomeId = this.getAttribute('data-id');
                        if (!outcomeId) return;
                        
                        const outcomesInput = document.querySelector(`.tree-node[data-id="${APP_STATE.selectedNode.id}"] .nodeOutcomes`);
                        if (outcomesInput) {
                            const currentValue = outcomesInput.value.trim();
                            
                            // Alt d√ºƒü√ºm ise (soru veya rubrik), sadece bir √ñ√á atanabilsin
                            const isSubItem = APP_STATE.selectedNode.id.includes('.');
                            
                            if (isSubItem) {
                                outcomesInput.value = outcomeId;
                            } else {
                                // Deƒüer bo≈üsa veya virg√ºlle bitiyorsa
                                if (!currentValue) {
                                    outcomesInput.value = outcomeId;
                                } else if (currentValue.endsWith(',')) {
                                    outcomesInput.value = currentValue + ' ' + outcomeId;
                                } else {
                                    outcomesInput.value = currentValue + ', ' + outcomeId;
                                }
                            }
                            
                            // Deƒüeri deƒüi≈ümi≈ü gibi tetikle
                            outcomesInput.dispatchEvent(new Event('change'));
                            
                            showModernToast(`"${outcomeId}" √∂ƒürenme √ßƒ±ktƒ±sƒ± eklendi.`);
                        }
                    } else {
                        showModernToast("L√ºtfen √∂nce bir etkinlik se√ßin.", "warning");
                    }
                } catch (error) {
                    console.error("√ñƒürenme √ßƒ±ktƒ±sƒ± ekleme hatasƒ±:", error);
                    showModernToast("√ñƒürenme √ßƒ±ktƒ±sƒ± eklenirken bir hata olu≈ütu!", "error");
                }
            });
        });
        
        // T√ºm close-modal sƒ±nƒ±fƒ±na sahip butonlara tƒ±klama olayƒ± ekle
        document.querySelectorAll('.close-modal').forEach(button => {
            button.addEventListener('click', function() {
                try {
                    // En yakƒ±n modal elementini bul
                    const modal = this.closest('.modal');
                    if (modal) {
                        closeModal(modal);
                    }
                } catch (error) {
                    console.error("Modal kapatma hatasƒ±:", error);
                }
            });
        });
        
        // ƒ∞tem tipi deƒüi≈üikliƒüini dinle (√ßoklu √∂ƒüe ekleme modalƒ±nda)
        if (itemType) {
            itemType.addEventListener('change', function() {
                try {
                    const type = this.value;
                    if (questionTypeContainer && rubricTypeContainer) {
                        if (type === 'soru') {
                            questionTypeContainer.style.display = 'block';
                            rubricTypeContainer.style.display = 'none';
                        } else {
                            questionTypeContainer.style.display = 'none';
                            rubricTypeContainer.style.display = 'block';
                        }
                    }
                } catch (error) {
                    console.error("Tip deƒüi≈üikliƒüi hatasƒ±:", error);
                }
            });
        }
        
        // √áoklu √∂ƒüe ekleme butonunu dinle
        if (btnAddMultipleItems) {
            btnAddMultipleItems.addEventListener('click', addMultipleItems);
        }
        
        // ƒ∞lk a√ßƒ±lƒ±≈üta aktif sekmeyi ayarla
        switchTab(APP_STATE.currentActiveTabId || 'definition');

		// Puan daƒüƒ±tma butonu
		const btnDistributePoints = document.getElementById('btnDistributePoints');
		if (btnDistributePoints) {
			btnDistributePoints.addEventListener('click', function() {
				if (!APP_STATE.selectedNode) {
					showModernToast("L√ºtfen √∂nce bir etkinlik se√ßin.", "warning");
					return;
				}
				
				// Eƒüer alt d√ºƒü√ºm se√ßiliyse √ºst d√ºƒü√ºm√º bul
				let parentNode = APP_STATE.selectedNode;
				if (parentNode.id.includes('.')) {
					const parentId = parentNode.id.substring(0, parentNode.id.lastIndexOf('.'));
					parentNode = findNodeById(parentId);
				}
				
				// Puanlarƒ± daƒüƒ±t
				if (parentNode && parentNode.children && parentNode.children.length > 0) {
					// Alt √∂ƒüelerin toplam aƒüƒ±rlƒ±ƒüƒ±nƒ± hesapla
					const totalWeight = parentNode.children.reduce((sum, child) => sum + (parseInt(child.weight) || 0), 0);
					
					// Daƒüƒ±tƒ±m modalƒ±nƒ± g√∂ster
					showDistributePointsModal(parentNode, totalWeight);
				} else {
					showModernToast("Se√ßilen etkinliƒüin alt √∂ƒüeleri bulunmuyor.", "warning");
				}
			});
		}
		
		
		// Test daƒüƒ±lƒ±m butonu
		const btnDistributeTestScores = document.getElementById('btnDistributeTestScores');
		if (btnDistributeTestScores) {
			btnDistributeTestScores.addEventListener('click', function() {
				if (!APP_STATE.testDetailsNode) {
					showModernToast("Test detaylarƒ± bulunamadƒ±.", "error");
					return;
				}
				
				// Test detaylarƒ±nƒ± al
				const testId = APP_STATE.testDetailsNode.id;
				const totalQuestions = parseInt(totalQuestionsInput.value) || 20;
				
				// √ñƒürenci verileri var mƒ± kontrol et
				if (!APP_STATE.studentData || APP_STATE.studentData.length === 0) {
					showModernToast("√ñƒürenci verisi bulunamadƒ±.", "warning");
					return;
				}
				
				// ƒ∞≈ülemi onaylamak i√ßin modern onay modalƒ± g√∂ster
				showDeleteConfirmModal(
					// Onay verildiƒüinde √ßalƒ±≈üacak fonksiyon
					function() {
						// Her √∂ƒürenci i√ßin rastgele doƒüru/yanlƒ±≈ü sayƒ±sƒ± belirle ve daƒüƒ±lƒ±m yap
						APP_STATE.studentData.forEach(student => {
							const studentId = student.studentId;
							
							// Rastgele doƒüru sayƒ±sƒ± √ºret
							const correct = Math.floor(Math.random() * (totalQuestions + 1));
							
							// Rastgele yanlƒ±≈ü sayƒ±sƒ± √ºret (toplam soruyu ge√ßmeyecek ≈üekilde)
							const maxWrong = totalQuestions - correct;
							const wrong = Math.floor(Math.random() * (maxWrong + 1));
							
							// Not verilerini kaydeden yardƒ±mcƒ± fonksiyon kullan
							// (saveTestDistribution fonksiyonunu kullan, modal g√∂stermeyen)
							saveTestDistribution(studentId, testId, correct, wrong);
						});
						
						// Deƒüerlendirme g√∂r√ºn√ºm√ºn√º g√ºncelle
						updateAssessmentView();
						
						showModernToast("T√ºm √∂ƒürenciler i√ßin rastgele test puanlarƒ± olu≈üturuldu ve daƒüƒ±tƒ±ldƒ±.", "success");
					},
					// Onay mesajƒ±
					"T√ºm √∂ƒürenciler i√ßin rastgele test puanlarƒ± olu≈üturmak istediƒüinizden emin misiniz?"
				);
			});
		}
				
        
        // Varsayƒ±lan grup atamasƒ± yap
        assignDefaultGroups();
        
        console.log("T√ºm olay dinleyicileri ba≈üarƒ±yla y√ºklendi.");
    } catch (error) {
        console.error("Olay dinleyicileri y√ºklenirken hata olu≈ütu:", error);
        showModernToast("Uygulama ba≈ülatƒ±lƒ±rken bir hata olu≈ütu. L√ºtfen sayfayƒ± yenileyin veya daha sonra tekrar deneyin.", "error", 8000);
    }
});

/**
 * Alan adlarƒ±nƒ± normalle≈ütirme (ƒ∞ngilizce/T√ºrk√ße uyumu)
 */
function normalizeGradeFields() {
    try {
        if (!APP_STATE.gradesData) return;
        
        // T√ºm √∂ƒürenciler i√ßin
        Object.keys(APP_STATE.gradesData).forEach(studentId => {
            const studentGrades = APP_STATE.gradesData[studentId];
            
            // Hesaplanmƒ±≈ü notlar i√ßin standart alanlarƒ± ekle/normalle≈ütir
            if (studentGrades.yariyilIciNotu !== undefined || studentGrades.termGrade !== undefined) {
                const termGrade = studentGrades.yariyilIciNotu || studentGrades.termGrade || 0;
                studentGrades.yariyilIciNotu = parseFloat(termGrade);
                studentGrades.termGrade = parseFloat(termGrade);
            }
            
            if (studentGrades.yariyilSonuNotu !== undefined || studentGrades.finalGrade !== undefined) {
                const finalGrade = studentGrades.yariyilSonuNotu || studentGrades.finalGrade || 0;
                studentGrades.yariyilSonuNotu = parseFloat(finalGrade);
                studentGrades.finalGrade = parseFloat(finalGrade);
            }
            
            if (studentGrades.basariNotu !== undefined || studentGrades.totalGrade !== undefined) {
                const totalGrade = studentGrades.basariNotu || studentGrades.totalGrade || 0;
                studentGrades.basariNotu = parseFloat(totalGrade);
                studentGrades.totalGrade = parseFloat(totalGrade);
            }
            
            if (studentGrades.harfNotu !== undefined || studentGrades.letterGrade !== undefined) {
                const letterGrade = studentGrades.harfNotu || studentGrades.letterGrade || 'FF';
                studentGrades.harfNotu = letterGrade;
                studentGrades.letterGrade = letterGrade;
            }
            
            // T√ºm aktiviteler i√ßin
            Object.keys(studentGrades).forEach(activityId => {
                const grade = studentGrades[activityId];
                
                // Nesne ise ve test skorlarƒ±nƒ± i√ßeriyorsa
                if (typeof grade === 'object' && grade !== null) {
                    // Type/tip alanlarƒ±nƒ± kontrol et
                    if (grade.type === 'test' || grade.tip === 'test') {
                        // Her iki dilde de alanlarƒ± ayarla
                        grade.type = 'test';
                        grade.tip = 'test';
                        
                        // Doƒüru sayƒ±sƒ± i√ßin
                        if (grade.correct !== undefined || grade.dogru !== undefined) {
                            const correctValue = grade.correct !== undefined ? grade.correct : grade.dogru;
                            grade.correct = correctValue;
                            grade.dogru = correctValue;
                        }
                        
                        // Yanlƒ±≈ü sayƒ±sƒ± i√ßin
                        if (grade.wrong !== undefined || grade.yanlis !== undefined) {
                            const wrongValue = grade.wrong !== undefined ? grade.wrong : grade.yanlis;
                            grade.wrong = wrongValue;
                            grade.yanlis = wrongValue;
                        }
                    }
                    
                    // Alt nesneleri kontrol et (i√ß i√ße yapƒ± i√ßin)
                    Object.keys(grade).forEach(subKey => {
                        const subGrade = grade[subKey];
                        if (typeof subGrade === 'object' && subGrade !== null) {
                            if (subGrade.type === 'test' || subGrade.tip === 'test') {
                                // Her iki dilde de alanlarƒ± ayarla
                                subGrade.type = 'test';
                                subGrade.tip = 'test';
                                
                                // Doƒüru sayƒ±sƒ± i√ßin
                                if (subGrade.correct !== undefined || subGrade.dogru !== undefined) {
                                    const correctValue = subGrade.correct !== undefined ? subGrade.correct : subGrade.dogru;
                                    subGrade.correct = correctValue;
                                    subGrade.dogru = correctValue;
                                }
                                
                                // Yanlƒ±≈ü sayƒ±sƒ± i√ßin
                                if (subGrade.wrong !== undefined || subGrade.yanlis !== undefined) {
                                    const wrongValue = subGrade.wrong !== undefined ? subGrade.wrong : subGrade.yanlis;
                                    subGrade.wrong = wrongValue;
                                    subGrade.yanlis = wrongValue;
                                }
                            }
                        }
                    });
                }
            });
        });
    } catch (error) {
        console.error("Not alanlarƒ± normalle≈ütirilirken hata olu≈ütu:", error);
    }
}

/**
 * Hesaplanmƒ±≈ü notlarƒ± g√ºncelleme
 */
function updateCalculatedGrades() {
    try {
        if (!APP_STATE.studentData || APP_STATE.studentData.length === 0) {
            return;
        }
        
        APP_STATE.studentData.forEach(student => {
            const studentId = student.studentId;
            
            // Yarƒ±yƒ±l i√ßi etkinlikler
            const termActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('A'));
            let termGrade = 0;
            
            // ƒ∞√ß aƒüƒ±rlƒ±k toplamƒ±
            const termInternalTotal = termActivities.reduce((sum, node) => sum + parseFloat(node.weight || 0), 0);
            
            if (termInternalTotal > 0) {
                termActivities.forEach(activity => {
                    // ƒ∞√ß aƒüƒ±rlƒ±k normalle≈ütirmesi
                    const activityWeight = activity.weight / termInternalTotal; 
                    let activityGrade = 0;
                    
                    if (activity.children && activity.children.length > 0) {
                        // Alt etkinlikler
                        const childrenTotalWeight = activity.children.reduce((sum, child) => sum + parseFloat(child.weight || 0), 0);
                        
                        if (childrenTotalWeight > 0) {
                            activity.children.forEach(subItem => {
                                // Alt √∂ƒüe aƒüƒ±rlƒ±k normalle≈ütirmesi
                                const subItemWeight = subItem.weight / childrenTotalWeight; 
                            const grade = getStudentGrade(studentId, subItem.id) || 0;
                                const scaledGrade = (grade / (subItem.points || 1)) * 100; // 100 √ºzerinden
                                activityGrade += scaledGrade * subItemWeight;
                            });
                        }
                    } else {
                        // Basit etkinlik
                        const grade = getStudentGrade(studentId, activity.id) || 0;
                        activityGrade = (grade / (activity.points || 1)) * 100; // 100 √ºzerinden
                    }
                    
                    termGrade += activityGrade * activityWeight;
                });
            }
            
            // Yarƒ±yƒ±l sonu etkinlikler
            const finalActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('F'));
            let finalGrade = 0;
            
            // ƒ∞√ß aƒüƒ±rlƒ±k toplamƒ±
            const finalInternalTotal = finalActivities.reduce((sum, node) => sum + parseFloat(node.weight || 0), 0);
            
            if (finalInternalTotal > 0) {
                finalActivities.forEach(activity => {
                    // ƒ∞√ß aƒüƒ±rlƒ±k normalle≈ütirmesi
                    const activityWeight = activity.weight / finalInternalTotal;
                    let activityGrade = 0;
                    
                    if (activity.children && activity.children.length > 0) {
                        // Alt etkinlikler
                        const childrenTotalWeight = activity.children.reduce((sum, child) => sum + parseFloat(child.weight || 0), 0);
                        
                        if (childrenTotalWeight > 0) {
                            activity.children.forEach(subItem => {
                                // Alt √∂ƒüe aƒüƒ±rlƒ±k normalle≈ütirmesi
                                const subItemWeight = subItem.weight / childrenTotalWeight;
                            const grade = getStudentGrade(studentId, subItem.id) || 0;
                                const scaledGrade = (grade / (subItem.points || 1)) * 100; // 100 √ºzerinden
                                activityGrade += scaledGrade * subItemWeight;
                            });
                        }
                    } else {
                        // Basit etkinlik
                        const grade = getStudentGrade(studentId, activity.id) || 0;
                        activityGrade = (grade / (activity.points || 1)) * 100; // 100 √ºzerinden
                    }
                    
                    finalGrade += activityGrade * activityWeight;
                });
            }
            
            // Toplam ve harf notu - RTEU Y√∂netmeliƒüi MADDE 26'ya g√∂re
            let totalGrade = (termGrade * APP_STATE.termWeight / 100) + (finalGrade * APP_STATE.finalWeight / 100);
            let letterGrade = getLetterGrade(totalGrade);
            
            // Yarƒ±yƒ±l sonu sƒ±navƒ± 50'nin altƒ±ndaysa FF verilir
            if (finalGrade < 50) {
                letterGrade = 'FF';
            }
            
            // √ñƒürenci notlarƒ± nesnesini olu≈ütur
            if (!APP_STATE.gradesData[studentId]) {
                APP_STATE.gradesData[studentId] = {};
            }
            
            // Yarƒ±yƒ±l i√ßi, sonu ve toplam not bilgilerini ekle
            APP_STATE.gradesData[studentId].yariyilIciNotu = parseFloat(termGrade.toFixed(2));
            APP_STATE.gradesData[studentId].yariyilSonuNotu = parseFloat(finalGrade.toFixed(2));
            APP_STATE.gradesData[studentId].basariNotu = parseFloat(totalGrade.toFixed(2));
            APP_STATE.gradesData[studentId].harfNotu = letterGrade;
        });
    } catch (error) {
        console.error("Notlar hesaplanƒ±rken hata olu≈ütu:", error);
    }
}

// √ñƒürenci bazlƒ± not giri≈üi sekmesi kaldƒ±rƒ±ldƒ± - updateStudentSelector fonksiyonu temizlendi

// √ñƒürenci bazlƒ± not giri≈üi sekmesi kaldƒ±rƒ±ldƒ± - showStudentGrades fonksiyonu temizlendi

/**
 * √ñƒürenci g√∂r√ºn√ºm√ºnde etkinlik b√∂l√ºm√º olu≈üturma
 * @param {Object} student - √ñƒürenci
 * @param {Object} activity - Etkinlik
 * @returns {string} - HTML i√ßeriƒüi
 */
function createStudentActivitySection(student, activity) {
    try {
        let html = `
            <div class="student-activity" data-activity-id="${activity.id}">
                <h5>${activity.name} <span class="badge badge-primary">${activity.weight}%</span></h5>
        `;
        
        // Aktivitenin alt √∂ƒüeleri var mƒ± kontrol et
        if (activity.children && activity.children.length > 0) {
            // Alt √∂ƒüeler var, her biri i√ßin giri≈ü alanƒ± olu≈ütur
            html += '<div class="student-subitems">';
            
            activity.children.forEach(subItem => {
                if (subItem.type === 'Test') {
                    html += createStudentTestInputSection(student, subItem);
                } else {
                    html += createStudentSubItemInputSection(student, subItem);
                }
            });
            
            html += '</div>';
        } else {
            // Alt √∂ƒüe yoksa basit bir puan giri≈üi g√∂ster
            const grade = getStudentGrade(student.studentId, activity.id) || '';
            
            html += `
                <div class="student-grade-input">
                    <label>Puan:</label>
                    <input type="number" min="0" max="${activity.points}" 
                        data-student-id="${student.studentId}" 
                        data-activity-id="${activity.id}" 
                        value="${grade}"
                        onchange="updateStudentGradeFromStudentView(this)">
                    <span>/ ${activity.points}</span>
                </div>
            `;
        }
        
        html += '</div>';
        return html;
    } catch (error) {
        console.error("√ñƒürenci etkinlik b√∂l√ºm√º olu≈üturulurken hata olu≈ütu:", error);
        return '<div class="error-message">Etkinlik bilgileri y√ºklenemedi.</div>';
    }
}

/**
 * √ñƒürenci g√∂r√ºn√ºm√ºnde alt √∂ƒüe giri≈ü b√∂l√ºm√º olu≈üturma (Soru/Rubrik)
 * @param {Object} student - √ñƒürenci
 * @param {Object} subItem - Alt √∂ƒüe
 * @returns {string} - HTML i√ßeriƒüi
 */
function createStudentSubItemInputSection(student, subItem) {
    try {
        // √úst bile≈üen ID'sini bul
        const parentComponentId = getParentComponentId(subItem.id) || subItem.id;
        const component = APP_STATE.courseData?.grupHaritalari?.[parentComponentId];
        const useGroupSystem = component && component.gruplar && component.gruplar.length > 1;
        
        if (!useGroupSystem || !subItem.children || subItem.children.length === 0) {
            // Grup sistemi yok veya alt sorular yok - basit giri≈ü
        const grade = getStudentGrade(student.studentId, subItem.id) || '';
        
        return `
            <div class="student-subitem" data-subitem-id="${subItem.id}">
                <div class="subitem-header">
                    <span>${subItem.name}</span>
                    <span class="badge badge-primary">${subItem.points} puan</span>
                    <span class="badge badge-success">${subItem.outcomes.join(', ')}</span>
                </div>
                <div class="student-grade-input">
                    <input type="number" min="0" max="${subItem.points}" 
                        data-student-id="${student.studentId}" 
                        data-activity-id="${subItem.id}" 
                        value="${grade}"
                        onchange="updateStudentGradeFromStudentView(this)">
                    <span>/ ${subItem.points}</span>
                </div>
            </div>
        `;
        }
        
        // Grup sistemi var ve alt sorular var - detaylƒ± tablo (√ñƒürenci bazlƒ± g√∂r√ºn√ºm)
        const componentDisplayName = getComponentDisplayName(parentComponentId);
        const studentCurrentGroup = getStudentGroupForComponent(student.studentId, parentComponentId);
        
        let html = `
            <div class="student-subitem" data-subitem-id="${subItem.id}" data-component-id="${parentComponentId}">
                <div class="subitem-header">
                    <span>${componentDisplayName}</span>
                    <span class="badge badge-primary">${subItem.points} puan</span>
                    <span class="badge badge-success">${subItem.outcomes.join(', ')}</span>
                    <span class="badge badge-info">Grup: ${studentCurrentGroup}</span>
                </div>
                <div class="subitem-questions-table">
                    <table class="assessment-table">
                        <thead>
                            <tr>
                                <th>Kaƒüƒ±t Sƒ±rasƒ±</th>
                                <th>Soru Sƒ±rasƒ±</th>
                                <th>Etkinlik Adƒ±<br/><small>(Soru/Rubrik)</small></th>
                                <th>A√ßƒ±klama</th>
                                <th>Etkinlik Max. Puan<br/><small>(Soru/Rubrik)</small></th>
                                <th>Toplam Puan</th>
                                <th>√ñ√á</th>
                                                <th>Alƒ±nan Puan<br/><small>(Etkinlik Puanƒ±)</small></th>
            </tr>
        </thead>
        <tbody>
        `;
        
        // Her soru i√ßin satƒ±r olu≈ütur (√ñƒürenci bazlƒ± g√∂r√ºn√ºm - grup se√ßici yok)
        subItem.children.forEach((question, paperOrder) => {
            const actualQuestionId = getQuestionIdByPaperOrder(student.studentId, paperOrder + 1, parentComponentId);
            const actualQuestion = findNodeById(actualQuestionId);
            const answerKeyOrder = getAnswerKeyOrder(student.studentId, paperOrder + 1, parentComponentId);
            
            // Soru bilgilerini al
            const questionName = `Soru ${answerKeyOrder || paperOrder + 1}`;
            const questionDescription = actualQuestion?.description || actualQuestion?.name || '-';
            const questionPointsForGroup = getQuestionPointsForStudentGroup(student.studentId, actualQuestionId, parentComponentId);
            const maxPoints = questionPointsForGroup || actualQuestion?.points || 0;
            const studentOutcomes = getQuestionOutcomesForStudent(student.studentId, actualQuestionId, parentComponentId);
            
            // Mevcut puanƒ± al
            const currentGrade = getStudentGrade(student.studentId, actualQuestionId) || '';
            
            html += `
                <tr data-question-id="${actualQuestionId}" data-paper-order="${paperOrder + 1}" data-student-id="${student.studentId}" data-component-id="${parentComponentId}">
                    <td class="paper-order-cell">
                        <span class="paper-order-badge">${paperOrder + 1}</span>
                    </td>
                    <td class="answer-key-order-cell">
                        <span class="answer-key-badge">${answerKeyOrder}</span>
                    </td>
                    <td class="question-name-cell">
                        <span class="question-name-badge">${questionName}</span>
                    </td>
                    <td class="question-description-cell">
                        <span class="question-desc-badge" title="${questionDescription}">${questionDescription}</span>
                    </td>
                    <td class="points-cell">
                        <span class="points-badge">${maxPoints}</span>
                    </td>
                    <td class="total-points-cell">
                        <span class="total-points-badge">${getStudentTotalEarnedPointsForComponent(student.studentId, parentComponentId)}</span>
                    </td>
                    <td class="outcomes-cell">
                        <span class="outcomes-badge">${Array.isArray(studentOutcomes) ? studentOutcomes.join(', ') : (studentOutcomes || '-')}</span>
                    </td>
                    <td class="grade-input-cell">
                        <input type="number" 
                               min="0" 
                               max="100" 
                               step="0.1"
                               class="grade-input" 
                               data-student-id="${student.studentId}" 
                               data-activity-id="${actualQuestionId}" 
                               value="${currentGrade}"
                               onchange="updateStudentGradeFromStudentView(this)">
                    </td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        </div>
        `;
        
        return html;
    } catch (error) {
        console.error("Alt √∂ƒüe giri≈ü b√∂l√ºm√º olu≈üturulurken hata olu≈ütu:", error);
        return '<div class="error-message">Alt √∂ƒüe bilgileri y√ºklenemedi.</div>';
    }
}

/**
 * √ñƒürenci g√∂r√ºn√ºm√ºnde test giri≈ü b√∂l√ºm√º olu≈üturma
 * @param {Object} student - √ñƒürenci
 * @param {Object} testItem - Test √∂ƒüesi
 * @returns {string} - HTML i√ßeriƒüi
 */
function createStudentTestInputSection(student, testItem) {
    try {
        // √úst bile≈üen ID'sini bul
        const parentComponentId = getParentComponentId(testItem.id) || testItem.id;
        const component = APP_STATE.courseData?.grupHaritalari?.[parentComponentId];
        const useGroupSystem = component && component.gruplar && component.gruplar.length > 1;
        
        if (!useGroupSystem || !testItem.children || testItem.children.length === 0) {
            // Grup sistemi yok veya soru detaylarƒ± yok - basit test giri≈üi
        const testScore = getStudentTestScore(student.studentId, testItem.id);
        const correct = testScore?.correct || 0;
        const wrong = testScore?.wrong || 0;
        const totalScore = correct * testItem.testDetails.correctWeight - wrong * Math.abs(testItem.testDetails.wrongPenalty);
        
        return `
            <div class="student-subitem student-test-item" data-subitem-id="${testItem.id}">
                <div class="subitem-header">
                    <span>${testItem.name}</span>
                    <span class="badge badge-primary">${testItem.points} puan</span>
                    <span class="badge badge-success">${testItem.outcomes.join(', ')}</span>
                </div>
                <div class="test-info">
                    <p>Toplam ${testItem.testDetails.totalQuestions} soru, her doƒüru: ${testItem.testDetails.correctWeight} puan, her yanlƒ±≈ü: ${testItem.testDetails.wrongPenalty} puan</p>
                </div>
                <div class="test-inputs">
                    <div class="student-grade-input">
                        <label>Doƒüru:</label>
                        <input type="number" min="0" max="${testItem.testDetails.totalQuestions}" 
                            data-student-id="${student.studentId}" 
                            data-test-id="${testItem.id}" 
                            data-field="correct"
                            value="${correct}"
                            onchange="updateTestScoreFromStudentView(this)">
                    </div>
                    <div class="student-grade-input">
                        <label>Yanlƒ±≈ü:</label>
                        <input type="number" min="0" max="${testItem.testDetails.totalQuestions}" 
                            data-student-id="${student.studentId}" 
                            data-test-id="${testItem.id}" 
                            data-field="wrong"
                            value="${wrong}"
                            onchange="updateTestScoreFromStudentView(this)">
                    </div>
                    <div class="student-grade-input">
                        <label>Toplam:</label>
                        <span class="total-test-score">${totalScore.toFixed(2)}</span>
                    </div>
                </div>
            </div>
        `;
        }
        
        // Grup sistemi var ve soru detaylarƒ± var - detaylƒ± tablo (√ñƒürenci bazlƒ± g√∂r√ºn√ºm)
        const componentDisplayName = getComponentDisplayName(parentComponentId);
        const studentCurrentGroup = getStudentGroupForComponent(student.studentId, parentComponentId);
        
        let html = `
            <div class="student-subitem student-test-item" data-subitem-id="${testItem.id}" data-component-id="${parentComponentId}">
                <div class="subitem-header">
                    <span>${componentDisplayName}</span>
                    <span class="badge badge-primary">${testItem.points} puan</span>
                    <span class="badge badge-success">${testItem.outcomes.join(', ')}</span>
                    <span class="badge badge-info">Grup: ${studentCurrentGroup}</span>
                </div>
                <div class="test-questions-table">
                    <table class="assessment-table">
                        <thead>
                            <tr>
                                <th>Kaƒüƒ±t Sƒ±rasƒ±</th>
                                <th>Soru Sƒ±rasƒ±</th>
                                <th>Etkinlik Adƒ±<br/><small>(Soru/Rubrik)</small></th>
                                <th>A√ßƒ±klama</th>
                                <th>Etkinlik Max. Puan<br/><small>(Soru/Rubrik)</small></th>
                                <th>Toplam Puan</th>
                                <th>√ñ√á</th>
                                                <th>Alƒ±nan Puan<br/><small>(Etkinlik Puanƒ±)</small></th>
            </tr>
        </thead>
        <tbody>
        `;
        
        // Her soru i√ßin satƒ±r olu≈ütur (√ñƒürenci bazlƒ± g√∂r√ºn√ºm - grup se√ßici yok)
        testItem.children.forEach((question, paperOrder) => {
            const actualQuestionId = getQuestionIdByPaperOrder(student.studentId, paperOrder + 1, parentComponentId);
            const actualQuestion = findNodeById(actualQuestionId);
            const answerKeyOrder = getAnswerKeyOrder(student.studentId, paperOrder + 1, parentComponentId);
            
            // Soru bilgilerini al
            const questionName = `Soru ${answerKeyOrder || paperOrder + 1}`;
            const questionDescription = actualQuestion?.description || actualQuestion?.name || '-';
            const questionPointsForGroup = getQuestionPointsForStudentGroup(student.studentId, actualQuestionId, parentComponentId);
            const maxPoints = questionPointsForGroup || actualQuestion?.points || 0;
            const studentOutcomes = getQuestionOutcomesForStudent(student.studentId, actualQuestionId, parentComponentId);
            
            // Mevcut puanƒ± al
            const currentGrade = getStudentGrade(student.studentId, actualQuestionId) || '';
            
            html += `
                <tr data-question-id="${actualQuestionId}" data-paper-order="${paperOrder + 1}" data-student-id="${student.studentId}" data-component-id="${parentComponentId}">
                    <td class="paper-order-cell">
                        <span class="paper-order-badge">${paperOrder + 1}</span>
                    </td>
                    <td class="answer-key-order-cell">
                        <span class="answer-key-badge">${answerKeyOrder}</span>
                    </td>
                    <td class="question-name-cell">
                        <span class="question-name-badge">${questionName}</span>
                    </td>
                    <td class="question-description-cell">
                        <span class="question-desc-badge" title="${questionDescription}">${questionDescription}</span>
                    </td>
                    <td class="points-cell">
                        <span class="points-badge">${maxPoints}</span>
                    </td>
                    <td class="total-points-cell">
                        <span class="total-points-badge">${getStudentTotalEarnedPointsForComponent(student.studentId, parentComponentId)}</span>
                    </td>
                    <td class="outcomes-cell">
                        <span class="outcomes-badge">${Array.isArray(studentOutcomes) ? studentOutcomes.join(', ') : (studentOutcomes || '-')}</span>
                    </td>
                    <td class="grade-input-cell">
                        <input type="number" 
                               min="0" 
                               max="100" 
                               step="0.1"
                               class="grade-input" 
                               data-student-id="${student.studentId}" 
                               data-activity-id="${actualQuestionId}" 
                               value="${currentGrade}"
                               onchange="updateStudentGradeFromStudentView(this)">
                    </td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        </div>
        `;
        
        return html;
    } catch (error) {
        console.error("Test giri≈ü b√∂l√ºm√º olu≈üturulurken hata olu≈ütu:", error);
        return '<div class="error-message">Test bilgileri y√ºklenemedi.</div>';
    }
}

/**
 * √ñƒürenci g√∂r√ºn√ºm√ºnden not g√ºncelleme
 * @param {HTMLInputElement} input - Not input elementi
 */
function updateStudentGradeFromStudentView(input) {
    try {
        const studentId = input.dataset.studentId;
        const activityId = input.dataset.activityId;
        
        // Aktiviteyi bul ve maksimum puanƒ±nƒ± kontrol et
        const activity = findNodeById(activityId);
        if (!activity) {
            console.error(`Aktivite bulunamadƒ±: ${activityId}`);
            return;
        }
        
        // Maksimum puan kontrol√º - G√∂rsel uyarƒ± sistemi
        const maxPoints = activity.points || 100;
        let value = parseFloat(input.value) || 0;
        
        // Maksimum puanƒ± a≈üan deƒüerler i√ßin g√∂rsel uyarƒ± (deƒüeri deƒüi≈ütirmeden)
        if (value > maxPoints) {
            input.style.borderColor = '#ff6b6b';
            input.style.backgroundColor = '#fff5f5';
            input.title = `‚ö†Ô∏è Girilen puan (${value}) maksimum puandan (${maxPoints}) b√ºy√ºk!`;
            // Deƒüeri deƒüi≈ütirmiyoruz, sadece uyarƒ± veriyoruz
        } else {
            input.style.borderColor = '';
            input.style.backgroundColor = '';
            input.title = `Maksimum puan: ${maxPoints}`;
        }
        
        // √ñƒürenci verisi olu≈ütur
        if (!APP_STATE.gradesData[studentId]) {
            APP_STATE.gradesData[studentId] = {};
        }
        
        // Test mi kontrol et
        if (activity && activity.type === 'Test') {
            // Test skorlarƒ± i√ßin √∂zel i≈ülem
            const correctWeight = activity.testDetails?.correctWeight || 5;
            const wrongPenalty = Math.abs(activity.testDetails?.wrongPenalty || 0);
            
            // Basit yakla≈üƒ±m: t√ºm puanƒ± doƒüru sorudan gelecek ≈üekilde ayarla
            const correctEstimate = Math.round(value / correctWeight);
            
            APP_STATE.gradesData[studentId][activityId] = {
                tip: 'test',
                dogru: correctEstimate,
                yanlis: 0
            };
            
            // Deƒüerlendirme sekmesindeki form elementlerini bul ve g√ºncelle
            // Test i√ßin de courseData g√ºncelle
            updateCourseDataGrades(studentId, activityId, value);
            
            const assessmentCorrectInput = document.querySelector(`#assessment-content input[data-student-id="${studentId}"][data-test-id="${activityId}"][data-field="correct"]`);
            const assessmentWrongInput = document.querySelector(`#assessment-content input[data-student-id="${studentId}"][data-test-id="${activityId}"][data-field="wrong"]`);
            
            if (assessmentCorrectInput) assessmentCorrectInput.value = correctEstimate;
            if (assessmentWrongInput) assessmentWrongInput.value = 0;
            
            // Total score'u g√ºncelle
            const assessmentTotalScore = document.querySelector(`#assessment-content tr:has(input[data-student-id="${studentId}"][data-test-id="${activityId}"]) .total-score`);
            if (assessmentTotalScore) {
                assessmentTotalScore.textContent = value.toFixed(2);
            }
            
        } else {
            // Normal not i√ßin
            APP_STATE.gradesData[studentId][activityId] = value;
            
            // ‚úÖ Normal not i√ßin de courseData g√ºncelle
            updateCourseDataGrades(studentId, activityId, value);
            
            // Alt d√ºƒü√ºm yapƒ±sƒ±nƒ± olu≈ütur (A1.1 -> A1 altƒ±nda storlama)
            const parts = activityId.split('.');
            if (parts.length > 1) {
                const parentId = parts[0]; // A1
                const shortId = parts[parts.length - 1]; // 1
                
                // Eƒüer √ºst aktivite yoksa olu≈ütur
                if (!APP_STATE.gradesData[studentId][parentId]) {
                    APP_STATE.gradesData[studentId][parentId] = {
                        toplam: 0
                    };
                }
                
                // Not deƒüerini ekle - hem tam ID, hem kƒ±sa ID olarak
                APP_STATE.gradesData[studentId][parentId][activityId] = value;
                APP_STATE.gradesData[studentId][parentId][shortId] = value;
                
                // Toplama hesapla
                updateParentActivityTotal(studentId, parentId);
            }
            
            // Deƒüerlendirme sekmesindeki aynƒ± inputu g√ºncelle
            const assessmentInput = document.querySelector(`#assessment-content input[data-student-id="${studentId}"][data-activity-id="${activityId}"]`);
            if (assessmentInput && assessmentInput !== input) {
                assessmentInput.value = value;
            }
        }
        
        // Notlarƒ± yeniden hesapla
        updateStudentCalculatedGrade(studentId);
        
        // Assessment tablosundaki not √∂zeti h√ºcrelerini g√ºncelle
        updateAssessmentGradeSummary(studentId);
        
        // √ñzetleme b√∂l√ºm√ºn√º g√ºncelle
        updateStudentSummary(studentId);
        
        // OTOMATIK PUAN DAƒûIT BUTONLARINI G√úNCELLE
        setTimeout(() => {
            addAutoDistributeButtonsToTables();
        }, 50);
        
    } catch (error) {
        console.error("√ñƒürenci notu g√ºncellenirken hata olu≈ütu:", error);
        showModernToast("Not g√ºncellenirken hata olu≈ütu!", "error");
    }
}

/**
 * √ñƒürenci g√∂r√ºn√ºm√ºnde test skorunu g√ºncelleme
 * @param {HTMLInputElement} input - Test skoru input elementi
 */
function updateTestScoreFromStudentView(input) {
    try {
        const studentId = input.dataset.studentId;
        const testId = input.dataset.testId;
        const field = input.dataset.field;
        const value = parseInt(input.value) || 0;
        
        // √ñnce verileri g√ºncelle
        updateTestScoreData(studentId, testId, field, value);
        
        // Deƒüerlendirme sekmesindeki kar≈üƒ±lƒ±k gelen test score alanlarƒ±nƒ± g√ºncelle
        const assessmentInput = document.querySelector(`#assessment-content input[data-student-id="${studentId}"][data-test-id="${testId}"][data-field="${field}"]`);
        if (assessmentInput && assessmentInput !== input) {
            assessmentInput.value = value;
            // Event'i manuel tetikle
            assessmentInput.dispatchEvent(new Event('change'));
        }
        
        // Yalnƒ±zca √∂ƒürenci g√∂r√ºn√ºm√ºndeki toplam skoru g√ºncelle
        updateStudentViewTestTotal(studentId, testId);
        
        // Notlarƒ± yeniden hesapla
        updateStudentCalculatedGrade(studentId);
        
        // Assessment tablosundaki not √∂zeti h√ºcrelerini g√ºncelle
        updateAssessmentGradeSummary(studentId);
        
        // √ñzetleme b√∂l√ºm√ºn√º g√ºncelle
        updateStudentSummary(studentId);
        
        // OTOMATIK PUAN DAƒûIT BUTONLARINI G√úNCELLE
        setTimeout(() => {
            addAutoDistributeButtonsToTables();
        }, 50);
        
    } catch (error) {
        console.error("Test skoru g√ºncellenirken hata olu≈ütu:", error);
        showModernToast("Test skoru g√ºncellenirken hata olu≈ütu!", "error");
    }
}

// Test skoru verilerini g√ºncelleme (yardƒ±mcƒ± fonksiyon)
function updateTestScoreData(studentId, testId, field, value) {
    // Test d√ºƒü√ºm√ºn√º bul
    const testNode = findNodeById(testId);
    if (!testNode) return;
    
    // √ñƒürenci notlarƒ± hen√ºz yoksa olu≈ütur
    if (!APP_STATE.gradesData[studentId]) {
        APP_STATE.gradesData[studentId] = {};
    }
    
    // Test notlarƒ± hen√ºz yoksa olu≈ütur
    if (!APP_STATE.gradesData[studentId][testId]) {
        APP_STATE.gradesData[studentId][testId] = {
            tip: 'test',
            dogru: 0,
            yanlis: 0
        };
    }
    
    // ƒ∞lgili alanƒ± g√ºncelle
    if (field === 'correct') {
        APP_STATE.gradesData[studentId][testId].dogru = value;
    } else if (field === 'wrong') {
        APP_STATE.gradesData[studentId][testId].yanlis = value;
    } else {
        APP_STATE.gradesData[studentId][testId][field] = value;
    }
    
    // Doƒüru ve yanlƒ±≈ü sayƒ±larƒ±nƒ± kontrol et
    const testScore = APP_STATE.gradesData[studentId][testId];
    const correct = testScore.dogru || 0;
    const wrong = testScore.yanlis || 0;
    const totalQuestions = testNode.testDetails.totalQuestions;
    
    // Doƒüru ve yanlƒ±≈ü toplamƒ± toplam soru sayƒ±sƒ±nƒ± ge√ßemez
    if (correct + wrong > totalQuestions) {
        showModernToast(`Dikkat: Doƒüru ve yanlƒ±≈ü sorularƒ±n toplamƒ± toplam soru sayƒ±sƒ±nƒ± (${totalQuestions}) ge√ßemez.`, "warning");
        // Deƒüeri d√ºzelt
        if (field === 'correct') {
            APP_STATE.gradesData[studentId][testId].dogru = totalQuestions - wrong;
        } else {
            APP_STATE.gradesData[studentId][testId].yanlis = totalQuestions - correct;
        }
    }
    
    // Alt test yapƒ±sƒ± olu≈ütur (gerekiyorsa)
    const parts = testId.split('.');
    if (parts.length > 1) {
        const parentId = parts[0]; // A1
        const shortId = parts[parts.length - 1]; // 1
        
        // Eƒüer √ºst aktivite yoksa olu≈ütur
        if (!APP_STATE.gradesData[studentId][parentId]) {
            APP_STATE.gradesData[studentId][parentId] = {
                toplam: 0
            };
        }
        
        // Kƒ±sa kod da ekle
        APP_STATE.gradesData[studentId][parentId][shortId] = {
            tip: 'test',
            dogru: testScore.dogru,
            yanlis: testScore.yanlis
        };
        
        // Alt yapƒ±ya da ekle
        if (!APP_STATE.gradesData[studentId][parentId][testId]) {
            APP_STATE.gradesData[studentId][parentId][testId] = {
                tip: 'test',
                dogru: testScore.dogru,
                yanlis: testScore.yanlis
            };
        } else {
            APP_STATE.gradesData[studentId][parentId][testId].dogru = testScore.dogru;
            APP_STATE.gradesData[studentId][parentId][testId].yanlis = testScore.yanlis;
        }
        
        // Toplama hesapla
        updateParentActivityTotal(studentId, parentId);
    }
}

// √úst aktivitenin toplamƒ±nƒ± g√ºncelleme (yardƒ±mcƒ± fonksiyon)
function updateParentActivityTotal(studentId, parentId) {
    const parentActivity = findNodeById(parentId);
    if (parentActivity && parentActivity.children && parentActivity.children.length > 0) {
        let total = 0;
        let maxPoints = 0;
        
        parentActivity.children.forEach(child => {
            let grade = 0;
            if (child.type === 'Test') {
                // Test notlarƒ± i√ßin √∂zel hesaplama
                const testScore = APP_STATE.gradesData[studentId][child.id];
                if (testScore && testScore.tip === 'test') {
                    const correct = testScore.dogru || 0;
                    const wrong = testScore.yanlis || 0;
                    grade = correct * (child.testDetails?.correctWeight || 5) - 
                            wrong * Math.abs(child.testDetails?.wrongPenalty || 0);
                }
            } else {
                grade = getStudentGrade(studentId, child.id) || 0;
            }
            total += grade;
            maxPoints += parseFloat(child.points) || 0;
        });
        
        // Toplam puanƒ± hesapla (100 √ºzerinden)
        const normalized = maxPoints > 0 ? (total / maxPoints) * 100 : 0;
        APP_STATE.gradesData[studentId][parentId].toplam = normalized;
    }
}

// √ñƒürenci g√∂r√ºn√ºm√ºnde test toplamƒ±nƒ± g√ºncelleme (yardƒ±mcƒ± fonksiyon)
function updateStudentViewTestTotal(studentId, testId) {
    const testNode = findNodeById(testId);
    if (!testNode) return;
    
    const testScore = APP_STATE.gradesData[studentId][testId];
    if (!testScore) return;
    
    const correct = testScore.dogru || 0;
    const wrong = testScore.yanlis || 0;
    const correctWeight = testNode.testDetails?.correctWeight || 5;
    const wrongPenalty = Math.abs(testNode.testDetails?.wrongPenalty || 0);
    const totalScore = correct * correctWeight - wrong * wrongPenalty;
    
    // √ñƒürenci g√∂r√ºn√ºm√ºndeki toplam skoru g√ºncelle
    const studentViewTotalElement = document.querySelector(`#studentGradesContainer .student-test-item[data-subitem-id="${testId}"] .total-test-score`);
    if (studentViewTotalElement) {
                    studentViewTotalElement.textContent = totalScore.toFixed(2);
    }
}

// √ñƒürenci √∂zet bilgilerini g√ºncelleme (yardƒ±mcƒ± fonksiyon)
function updateStudentSummary(studentId) {
    const studentGrades = calculateStudentGrades(studentId);
    if (!studentGrades) return;
    
    // √ñzet alanƒ±nƒ± g√ºncelle
    const summaryItems = document.querySelectorAll('#studentGradesContainer .student-summary .summary-item strong');
    if (summaryItems.length === 4) {
        summaryItems[0].textContent = studentGrades.termGrade;
        summaryItems[1].textContent = studentGrades.finalGrade;
        summaryItems[2].textContent = studentGrades.totalGrade;
        summaryItems[3].textContent = studentGrades.letterGrade;
        summaryItems[3].className = getLetterGradeClass(studentGrades.letterGrade);
    }
}

/**
 * √áoklu √∂ƒüe ekleme modalƒ±nƒ± g√∂sterme
 * @param {string} type - Eklenecek √∂ƒüe tipi ('soru' veya 'rubrik')
 */
function showMultipleItemsModal(type = 'soru') {
    // Modal ba≈ülƒ±ƒüƒ±nƒ± ayarla
    multipleItemsTitle.textContent = type === 'soru' ? '√áoklu Soru Ekle' : '√áoklu Rubrik Ekle';
    
    // Hedef etkinlik combobox'ƒ±nƒ± doldur
    const targetActivitySelect = document.getElementById('targetActivitySelect');
    targetActivitySelect.innerHTML = '';
    
    // Mevcut ana etkinlikleri bul ve ekle - √ßoklu veri kaynaƒüƒ± kontrol√º
    const activities = [];
    
    // √ñnce APP_STATE.data.children kontrol et
    if (APP_STATE.data && APP_STATE.data.children) {
        APP_STATE.data.children.forEach(node => {
            // Ana etkinlikler (alt d√ºƒü√ºm olmayan)
            if (!node.id.includes('.')) {
                activities.push({
                    id: node.id,
                    name: node.name || node.type || `Etkinlik ${node.id}`,
                    type: node.type || 'Bilinmeyen',
                    category: node.id.startsWith('A') ? 'Yarƒ±yƒ±l ƒ∞√ßi' : 'Yarƒ±yƒ±l Sonu'
                });
            }
        });
    }
    
    // Eƒüer bulunamadƒ±ysa APP_STATE.assessmentTree kontrol et
    if (activities.length === 0 && APP_STATE.assessmentTree && APP_STATE.assessmentTree.length > 0) {
        APP_STATE.assessmentTree.forEach(node => {
            // Ana etkinlikler (alt d√ºƒü√ºm olmayan)
            if (!node.id.includes('.')) {
                activities.push({
                    id: node.id,
                    name: node.name || node.type || `Etkinlik ${node.id}`,
                    type: node.type || 'Bilinmeyen',
                    category: node.id.startsWith('A') ? 'Yarƒ±yƒ±l ƒ∞√ßi' : 'Yarƒ±yƒ±l Sonu'
                });
            }
        });
    }
    
    // Son olarak DOM'dan kontrol et
    if (activities.length === 0) {
        document.querySelectorAll('.tree-node').forEach(nodeEl => {
            const nodeId = nodeEl.dataset.id;
            if (nodeId && !nodeId.includes('.')) {
                const nameEl = nodeEl.querySelector('.nodeName');
                const typeEl = nodeEl.querySelector('.nodeType');
                activities.push({
                    id: nodeId,
                    name: nameEl ? nameEl.value : `Etkinlik ${nodeId}`,
                    type: typeEl ? typeEl.value : 'Bilinmeyen',
                    category: nodeId.startsWith('A') ? 'Yarƒ±yƒ±l ƒ∞√ßi' : 'Yarƒ±yƒ±l Sonu'
                });
            }
        });
    }
    
    console.log("üîç showMultipleItemsModal - Bulunan etkinlikler:", activities);
    console.log("üîç APP_STATE.data:", APP_STATE.data);
    console.log("üîç APP_STATE.assessmentTree:", APP_STATE.assessmentTree);
    
    if (activities.length === 0) {
        const option = document.createElement('option');
        option.disabled = true;
        option.textContent = 'Hen√ºz etkinlik tanƒ±mlanmamƒ±≈ü - L√ºtfen √∂nce etkinlik olu≈üturun';
        targetActivitySelect.appendChild(option);
        
        // Etkinlik yoksa bile modalƒ± a√ß ama uyarƒ± ver
        showModernToast("Hen√ºz etkinlik tanƒ±mlanmamƒ±≈ü. √ñnce 'Yarƒ±yƒ±l ƒ∞√ßi Ekle' veya 'Yarƒ±yƒ±l Sonu Ekle' butonlarƒ±nƒ± kullanarak etkinlik olu≈üturun.", "warning");
        // return; // Bu satƒ±rƒ± kaldƒ±rƒ±yoruz ki modal a√ßƒ±lsƒ±n
    }
    
    // Etkinlikleri kategoriye g√∂re grupla ve ekle
    const termActivities = activities.filter(a => a.category === 'Yarƒ±yƒ±l ƒ∞√ßi');
    const finalActivities = activities.filter(a => a.category === 'Yarƒ±yƒ±l Sonu');
    
    if (termActivities.length > 0) {
        const termGroup = document.createElement('optgroup');
        termGroup.label = 'üìö Yarƒ±yƒ±l ƒ∞√ßi Deƒüerlendirme';
        termActivities.forEach(activity => {
            const option = document.createElement('option');
            option.value = activity.id;
            option.textContent = `${activity.id} - ${activity.name} (${activity.type})`;
            termGroup.appendChild(option);
        });
        targetActivitySelect.appendChild(termGroup);
    }
    
    if (finalActivities.length > 0) {
        const finalGroup = document.createElement('optgroup');
        finalGroup.label = 'üéì Yarƒ±yƒ±l Sonu Deƒüerlendirme';
        finalActivities.forEach(activity => {
            const option = document.createElement('option');
            option.value = activity.id;
            option.textContent = `${activity.id} - ${activity.name} (${activity.type})`;
            finalGroup.appendChild(option);
        });
        targetActivitySelect.appendChild(finalGroup);
    }
    
    // Eƒüer se√ßili bir etkinlik varsa onu varsayƒ±lan olarak se√ß
    if (APP_STATE.selectedNode && !APP_STATE.selectedNode.id.includes('.')) {
        targetActivitySelect.value = APP_STATE.selectedNode.id;
    }
    
    // Tip deƒüi≈üimine g√∂re uygun container'ƒ± g√∂ster
    if (type === 'soru') {
        questionTypeContainer.style.display = 'block';
        rubricTypeContainer.style.display = 'none';
        
        // Soru tiplerini dinamik olarak doldur
        questionType.innerHTML = '';
        
        // √ñnce varsayƒ±lan 'Soru' se√ßeneƒüi
        const defaultOption = document.createElement('option');
        defaultOption.value = 'Soru';
        defaultOption.textContent = 'Soru (Genel)';
        questionType.appendChild(defaultOption);
        
        // Diƒüer soru t√ºrlerini ekle
        document.querySelectorAll('.question-type-item').forEach(item => {
            const value = item.getAttribute('data-type');
            if (value !== 'Test') { // Test t√ºr√ºn√º hari√ß tut
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                questionType.appendChild(option);
            }
        });
    } else {
        questionTypeContainer.style.display = 'none';
        rubricTypeContainer.style.display = 'block';
        
        // Rubrik tiplerini dinamik olarak doldur
        rubricType.innerHTML = '';
        
        // √ñnce varsayƒ±lan 'Rubrik' se√ßeneƒüi
        const defaultOption = document.createElement('option');
        defaultOption.value = 'Rubrik';
        defaultOption.textContent = 'Rubrik (Genel)';
        rubricType.appendChild(defaultOption);
        
        // Diƒüer rubrik t√ºrlerini ekle
        document.querySelectorAll('.rubric-item').forEach(item => {
            const value = item.getAttribute('data-type');
            const option = document.createElement('option');
            option.value = value;
            option.textContent = value;
            rubricType.appendChild(option);
        });
    }
    
    // √ñƒürenme √áƒ±ktƒ±larƒ±nƒ± doldur
    const outcomeSelection = document.getElementById('outcomeSelection');
    outcomeSelection.innerHTML = '';
    
    // √ñƒürenme √ßƒ±ktƒ±larƒ±nƒ± ekle
    if (APP_STATE.learningOutcomes && APP_STATE.learningOutcomes.length > 0) {
        APP_STATE.learningOutcomes.forEach(outcome => {
            const option = document.createElement('option');
            option.value = outcome.id;
            option.textContent = `${outcome.id}: ${outcome.aciklama}`;
            outcomeSelection.appendChild(option);
        });
    } else {
        // √ñƒürenme √ßƒ±ktƒ±sƒ± yoksa bilgi mesajƒ± ekle
        const option = document.createElement('option');
        option.disabled = true;
        option.textContent = 'Hen√ºz √∂ƒürenme √ßƒ±ktƒ±sƒ± tanƒ±mlanmamƒ±≈ü';
        outcomeSelection.appendChild(option);
    }
    
    // Global deƒüi≈ükenleri ayarla
    APP_STATE.multipleItemsNode = APP_STATE.selectedNode;
    APP_STATE.multipleItemsType = type;
    
    // Modalƒ± g√∂ster
    openModal(multipleItemsModal);
}

/**
 * √áoklu √∂ƒüe ekleme i≈ülemini ger√ßekle≈ütirme
 */
function addMultipleItems() {
    try {
        const count = parseInt(itemCount.value) || 5;
        const type = APP_STATE.multipleItemsType;
        
        // Hedef etkinliƒüi combobox'tan al
        const targetActivitySelect = document.getElementById('targetActivitySelect');
        const selectedActivityId = targetActivitySelect.value;
        
        if (!selectedActivityId || selectedActivityId === '') {
            showModernToast("L√ºtfen hedef etkinlik listesinden bir etkinlik se√ßin. Eƒüer liste bo≈üsa √∂nce 'Yarƒ±yƒ±l ƒ∞√ßi Ekle' veya 'Yarƒ±yƒ±l Sonu Ekle' butonlarƒ±nƒ± kullanarak etkinlik olu≈üturun.", "warning");
            return;
        }
        
        // Se√ßilen etkinliƒüi bul
        const selectedNode = findNodeById(selectedActivityId);
        
        if (!selectedNode) {
            showModernToast("Se√ßilen etkinlik bulunamadƒ±.", "error");
            return;
        }
        
        // Se√ßilen etkinliƒüin bilgilerini al
        const activityInfo = `${selectedNode.id} - ${selectedNode.name || selectedNode.type} (${selectedNode.type})`;
        const category = selectedNode.id.startsWith('A') ? 'Yarƒ±yƒ±l ƒ∞√ßi' : 'Yarƒ±yƒ±l Sonu';
        
        // Se√ßilen √ñ√á'leri al
        const outcomeSelection = document.getElementById('outcomeSelection');
        const selectedOutcomes = Array.from(outcomeSelection.selectedOptions).map(option => option.value);
        
        // Mevcut alt √∂ƒüeleri kontrol et
        const existingChildrenCount = selectedNode.children ? selectedNode.children.length : 0;
        
        // Aƒüƒ±rlƒ±k hesaplama
        let newItemWeight = 0;
        
        if (existingChildrenCount === 0) {
            // Hi√ß alt √∂ƒüe yoksa, 100'√º e≈üit b√∂l
            newItemWeight = Math.floor(100 / count);
        } else {
            // Mevcut alt √∂ƒüelerin toplam aƒüƒ±rlƒ±ƒüƒ±nƒ± hesapla
            const totalExistingWeight = selectedNode.children.reduce((sum, child) => sum + (parseFloat(child.weight) || 0), 0);
            
            // Kalan aƒüƒ±rlƒ±ƒüƒ± bul (100'den fazla ise 0 olarak al)
            const remainingWeight = Math.max(0, 100 - totalExistingWeight);
            
            // Kalan aƒüƒ±rlƒ±ƒüƒ± e≈üit b√∂l
            newItemWeight = Math.floor(remainingWeight / count);
            
            // Eƒüer kalan aƒüƒ±rlƒ±k 0 ise, mevcut √∂ƒüelerin aƒüƒ±rlƒ±klarƒ±nƒ± yeniden daƒüƒ±t
            if (remainingWeight <= 0) {
                // T√ºm alt √∂ƒüelerin aƒüƒ±rlƒ±klarƒ±nƒ± yeniden hesapla
                const totalItems = existingChildrenCount + count;
                const newWeightPerItem = Math.floor(100 / totalItems);
                
                // Mevcut alt √∂ƒüelerin aƒüƒ±rlƒ±klarƒ±nƒ± g√ºncelle
                selectedNode.children.forEach(child => {
                    child.weight = newWeightPerItem;
                });
                
                newItemWeight = newWeightPerItem;
            }
        }
        
        // Se√ßilen tip ve sayƒ±da √∂ƒüe ekle
        if (type === 'soru') {
            const selectedQuestionType = questionType.value;
            const description = Array.from(document.querySelectorAll('.question-type-item'))
                .find(item => item.getAttribute('data-type') === selectedQuestionType)?.getAttribute('data-description') || '';
            
            // √áoklu soru ekle
            for (let i = 0; i < count; i++) {
                // √ñ√á atamasƒ± - dengeli daƒüƒ±tƒ±m i√ßin sƒ±rayla atama
                let outcome = [];
                if (selectedOutcomes.length > 0) {
                    // i. √∂ƒüeye i % selectedOutcomes.length indeksindeki √ñ√á'yi ata
                    outcome = [selectedOutcomes[i % selectedOutcomes.length]];
                }
                
                const newNode = {
                    id: `${selectedNode.id}.${(existingChildrenCount + i + 1)}`,
                    name: `${selectedQuestionType} ${existingChildrenCount + i + 1}`,
                    type: selectedQuestionType,
                    weight: newItemWeight,
                    points: 20, // Varsayƒ±lan puan
                    outcomes: outcome,
                    description: description || 'Deƒüerlendirme sorusu',
                    expanded: false,
                    children: []
                };
                
                if (!selectedNode.children) {
                    selectedNode.children = [];
                }
                
                selectedNode.children.push(newNode);
            }
            
            showModernToast(`${count} adet "${selectedQuestionType}" sorusu "${activityInfo}" etkinliƒüine eklendi.`, "success");
        } else {
            const selectedRubricType = rubricType.value;
            const description = Array.from(document.querySelectorAll('.rubric-item'))
                .find(item => item.getAttribute('data-type') === selectedRubricType)?.getAttribute('data-description') || '';
            
            // √áoklu rubrik ekle
            for (let i = 0; i < count; i++) {
                // √ñ√á atamasƒ± - dengeli daƒüƒ±tƒ±m i√ßin sƒ±rayla atama
                let outcome = [];
                if (selectedOutcomes.length > 0) {
                    // i. √∂ƒüeye i % selectedOutcomes.length indeksindeki √ñ√á'yi ata
                    outcome = [selectedOutcomes[i % selectedOutcomes.length]];
                }
                
                const newNode = {
                    id: `${selectedNode.id}.${(existingChildrenCount + i + 1)}`,
                    name: `${selectedRubricType} ${existingChildrenCount + i + 1}`,
                    type: selectedRubricType,
                    weight: newItemWeight,
                    points: 20, // Varsayƒ±lan puan
                    outcomes: outcome,
                    description: description || 'Deƒüerlendirme kriteri',
                    expanded: false,
                    children: []
                };
                
                if (!selectedNode.children) {
                    selectedNode.children = [];
                }
                
                selectedNode.children.push(newNode);
            }
            
            showModernToast(`${count} adet "${selectedRubricType}" rubriƒüi "${activityInfo}" etkinliƒüine eklendi.`, "success");
        }
        
        // Modal'ƒ± kapat
        closeModal(multipleItemsModal);
        
        // Ana d√ºƒü√ºm√º geni≈ület
        selectedNode.expanded = true;
        
        // Aƒüacƒ± yeniden render et
        renderTree();
        
        // Deƒüerlendirme sekmesini g√ºncelle
        updateAssessmentView();
    } catch (error) {
        console.error("√áoklu √∂ƒüe eklenirken hata olu≈ütu:", error);
        showModernToast("√ñƒüeler eklenemedi!", "error");
    }
}

/**
 * Test sorularƒ±na rastgele doƒüru/yanlƒ±≈ü daƒüƒ±lƒ±mƒ± yapma
 * @param {string} studentId - √ñƒürenci ID'si
 * @param {string} testId - Test ID'si
 * @param {number} correct - Doƒüru sayƒ±sƒ±
 * @param {number} wrong - Yanlƒ±≈ü sayƒ±sƒ±
 */
function distributeTestScores(studentId, testId, correct, wrong) {
    // Modern test daƒüƒ±tƒ±m modalƒ±nƒ± g√∂ster
    showTestScoreDistributionModal(studentId, testId);
}

/**
 * Diziyi karƒ±≈ütƒ±rma (Fisher-Yates shuffle algoritmasƒ±)
 * @param {Array} array - Karƒ±≈ütƒ±rƒ±lacak dizi
 */
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

/**
 * Puanlarƒ± e≈üit olarak daƒüƒ±t
 * @param {Object} parentNode - Ana etkinlik d√ºƒü√ºm√º
 * @param {number} totalPoints - Toplam puan
 */
function distributePointsEqually(parentNode, totalPoints) {
    if (!parentNode || !parentNode.children || parentNode.children.length === 0) {
        return;
    }
    
    const childCount = parentNode.children.length;
    
    // E≈üit daƒüƒ±tƒ±m i√ßin temel puanƒ± hesapla
    const basePoint = Math.floor(totalPoints / childCount);
    const remainder = totalPoints - (basePoint * childCount);
    
    // Her alt √∂ƒüeye e≈üit puan ver
    parentNode.children.forEach((child, index) => {
        // Son alt √∂ƒüeye kalan puanlarƒ± ekle
        if (index === childCount - 1) {
            child.points = basePoint + remainder;
        } else {
            child.points = basePoint;
        }
    });
    
    // Alt √∂ƒüelerin aƒüƒ±rlƒ±klarƒ±nƒ± g√ºncelle
    updateSubItemWeights(parentNode);
}

/**
 * Sorularƒ±n puanlarƒ±nƒ± rastgele ama dengeli daƒüƒ±tma
 * @param {Object} parentNode - Ana etkinlik d√ºƒü√ºm√º
 * @param {number} totalPoints - Toplam puan
 */
function distributePointsRandomly(parentNode, totalPoints) {
    if (!parentNode || !parentNode.children || parentNode.children.length === 0) {
        return;
    }
    
    const childCount = parentNode.children.length;
    
    // Dengeli bir daƒüƒ±lƒ±m i√ßin √∂nce e≈üit puan ver
    const basePoint = Math.floor(totalPoints / childCount);
    const remainder = totalPoints - (basePoint * childCount);
    
    // √ñ√á'leri grupla
    const outcomeGroups = {};
    parentNode.children.forEach(child => {
        if (child.outcomes && child.outcomes.length > 0) {
            const key = child.outcomes.join(',');
            if (!outcomeGroups[key]) {
                outcomeGroups[key] = [];
            }
            outcomeGroups[key].push(child);
        } else {
            // √ñ√á'si olmayan sorular i√ßin √∂zel grup
            if (!outcomeGroups['no_outcome']) {
                outcomeGroups['no_outcome'] = [];
            }
            outcomeGroups['no_outcome'].push(child);
        }
    });
    
    // D√ºzg√ºn bir daƒüƒ±lƒ±m yapabilmek i√ßin puan dizisi olu≈ütur
    let points = parentNode.children.map(() => basePoint);
    
    // Kalan puanlarƒ± rastgele daƒüƒ±t (her √ñ√á grubuna e≈üit daƒüƒ±lƒ±m yaparak)
    const outcomeKeys = Object.keys(outcomeGroups);
    
    // Her gruba e≈üit sayƒ±da ek puan daƒüƒ±t
    const extraPointsPerGroup = Math.floor(remainder / outcomeKeys.length);
    let remainingExtra = remainder - (extraPointsPerGroup * outcomeKeys.length);
    
    outcomeKeys.forEach(key => {
        const group = outcomeGroups[key];
        const extraPointsForThisGroup = group.length > 0 ? Math.floor(extraPointsPerGroup / group.length) : 0;
        let groupRemainder = extraPointsPerGroup - (extraPointsForThisGroup * group.length);
        
        // Her soruya ek puanƒ± ata
        group.forEach(child => {
            const index = parentNode.children.indexOf(child);
            if (index !== -1) {
                points[index] += extraPointsForThisGroup;
            }
        });
        
        // Gruptaki kalan puanlarƒ± rastgele daƒüƒ±t
        while (groupRemainder > 0 && group.length > 0) {
            const randomIndex = Math.floor(Math.random() * group.length);
            const childIndex = parentNode.children.indexOf(group[randomIndex]);
            if (childIndex !== -1) {
                points[childIndex]++;
                groupRemainder--;
            }
        }
    });
    
    // Son kalan puanlarƒ± rastgele daƒüƒ±t
    while (remainingExtra > 0 && parentNode.children.length > 0) {
        const randomIndex = Math.floor(Math.random() * parentNode.children.length);
        points[randomIndex]++;
        remainingExtra--;
    }
    
    // Puanlarƒ± √ßocuk d√ºƒü√ºmlere ata
    parentNode.children.forEach((child, index) => {
        child.points = points[index];
    });
    
    // Alt √∂ƒüelerin aƒüƒ±rlƒ±klarƒ±nƒ± da g√ºncelle
    updateSubItemWeights(parentNode);
}

/**
 * Alt √∂ƒüelerin aƒüƒ±rlƒ±klarƒ±nƒ± toplam puana g√∂re g√ºnceller
 * @param {Object} parentNode - Ana etkinlik d√ºƒü√ºm√º
 */
function updateSubItemWeights(parentNode) {
    if (!parentNode || !parentNode.children || parentNode.children.length === 0) {
        return;
    }
    
    // Toplam puanƒ± hesapla
    const totalPoints = parentNode.children.reduce((sum, child) => sum + (parseInt(child.points) || 0), 0);
    
    // Her √ßocuk i√ßin aƒüƒ±rlƒ±k hesapla
    if (totalPoints > 0) {
        parentNode.children.forEach(child => {
            const childPoints = parseInt(child.points) || 0;
            child.weight = Math.round((childPoints / totalPoints) * 100);
        });
    }
}

/**
 * Soru veya rubrik eklendiƒüinde/√ßƒ±karƒ±ldƒ±ƒüƒ±nda puanlarƒ± yeniden daƒüƒ±tmak isteyip istemediƒüini sor
 * @param {Object} parentNode - Ana etkinlik d√ºƒü√ºm√º
 */
function checkAndOfferRedistribution(parentNode) {
    if (!parentNode || !parentNode.children || parentNode.children.length <= 1) {
        return;
    }
    
    // Toplam aƒüƒ±rlƒ±ƒüƒ± kontrol et
    const totalWeight = parentNode.children.reduce((sum, child) => sum + (parseInt(child.weight) || 0), 0);
    
    if (totalWeight !== 100) {
        // Modern daƒüƒ±tƒ±m modalƒ±nƒ± g√∂ster
        showDistributePointsModal(parentNode, totalWeight);
    }
}

// =====================================================
// MODERN MODAL & TOAST Sƒ∞STEMƒ∞
// =====================================================

/**
 * Modern onay modalƒ± g√∂sterir
 * @param {string} title - Modal ba≈ülƒ±ƒüƒ±
 * @param {string} message - Onay mesajƒ±
 * @param {Function} onConfirm - Onaylandƒ±ƒüƒ±nda √ßalƒ±≈üacak fonksiyon
 * @param {Function} onCancel - ƒ∞ptal edildiƒüinde √ßalƒ±≈üacak fonksiyon (opsiyonel)
 * @param {Object} options - Buton metinleri ve stiller (opsiyonel)
 */
function showModernConfirm(title, message, options = {}) {
    console.log("üîç showModernConfirm √ßaƒürƒ±ldƒ±:", title);
    console.log("üîç Options:", options);
    
    return new Promise((resolve) => {
    const modal = document.getElementById('modernConfirmModal');
    const titleElement = document.getElementById('confirmModalTitle');
    const messageElement = document.getElementById('confirmModalMessage');
    const yesButton = document.getElementById('confirmModalYes');
    const noButton = document.getElementById('confirmModalNo');
        const headerElement = modal ? modal.querySelector('.modern-modal-header') : null;
        const iconElement = modal ? modal.querySelector('.modal-icon') : null;
        
        console.log("üîç Modal elementleri kontrol ediliyor:");
        console.log("- modal:", modal ? "‚úÖ Bulundu" : "‚ùå Bulunamadƒ±");
        console.log("- titleElement:", titleElement ? "‚úÖ Bulundu" : "‚ùå Bulunamadƒ±");
        console.log("- messageElement:", messageElement ? "‚úÖ Bulundu" : "‚ùå Bulunamadƒ±");
        console.log("- yesButton:", yesButton ? "‚úÖ Bulundu" : "‚ùå Bulunamadƒ±");
        console.log("- noButton:", noButton ? "‚úÖ Bulundu" : "‚ùå Bulunamadƒ±");
        console.log("- headerElement:", headerElement ? "‚úÖ Bulundu" : "‚ùå Bulunamadƒ±");
        console.log("- iconElement:", iconElement ? "‚úÖ Bulundu" : "‚ùå Bulunamadƒ±");
    
    if (!modal || !titleElement || !messageElement || !yesButton || !noButton) {
            console.error('‚ùå Modern confirm modal elementleri bulunamadƒ±!');
        // Fallback olarak toast mesajƒ± g√∂ster
        showModernToast("Modal y√ºklenemedi. L√ºtfen sayfayƒ± yenileyin.", "error");
            resolve(false);
        return;
    }
    
    // Varsayƒ±lan buton metinleri ve stiller
    const defaultOptions = {
        confirmText: 'Evet, Sil',
        cancelText: 'ƒ∞ptal',
        confirmClass: 'btn-danger',
        cancelClass: 'btn-secondary',
        headerClass: 'danger-action',
        iconClass: 'danger'
    };
    
    // Options'ƒ± birle≈ütir
    const finalOptions = { ...defaultOptions, ...options };
    
    // Modal i√ßeriƒüini ayarla
    titleElement.textContent = title;
    messageElement.textContent = message;
    
    // Buton metinlerini g√ºncelle
    yesButton.textContent = finalOptions.confirmText;
    noButton.textContent = finalOptions.cancelText;
    
    // Buton sƒ±nƒ±flarƒ±nƒ± g√ºncelle
    yesButton.className = `modern-confirm-btn ${finalOptions.confirmClass}`;
    noButton.className = `modern-confirm-btn ${finalOptions.cancelClass}`;
    
    // Header renk sƒ±nƒ±fƒ±nƒ± g√ºncelle
    if (headerElement) {
        // Mevcut action sƒ±nƒ±flarƒ±nƒ± temizle
        headerElement.classList.remove('create-action', 'success-action', 'info-action', 'warning-action', 'danger-action');
        // Yeni sƒ±nƒ±fƒ± ekle
        headerElement.classList.add(finalOptions.headerClass);
    }
    
    // ƒ∞kon sƒ±nƒ±fƒ±nƒ± ve i√ßeriƒüini g√ºncelle
    if (iconElement) {
        // Mevcut icon sƒ±nƒ±flarƒ±nƒ± temizle
        iconElement.classList.remove('warning', 'danger', 'success', 'info');
        // Yeni sƒ±nƒ±fƒ± ekle
        iconElement.classList.add(finalOptions.iconClass);
        
        // ƒ∞kon SVG i√ßeriƒüini g√ºncelle
        const iconSvg = iconElement.querySelector('svg');
        if (iconSvg) {
            // SVG boyutunu 64x64 yap
            iconSvg.setAttribute('width', '64');
            iconSvg.setAttribute('height', '64');
            
            switch(finalOptions.iconClass) {
                case 'success':
                    iconSvg.innerHTML = `
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    `;
                    break;
                case 'info':
                    iconSvg.innerHTML = `
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="16" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                    `;
                    break;
                case 'warning':
                    iconSvg.innerHTML = `
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                        <line x1="12" y1="9" x2="12" y2="13"></line>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    `;
                    break;
                case 'danger':
                default:
                    iconSvg.innerHTML = `
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                    `;
                    break;
            }
        }
    }
    
    // Promise'i yalnƒ±zca bir kez resolve etmek i√ßin flag
    let resolved = false;
    
    function handleYesClick() {
        if (resolved) return;
        resolved = true;
        console.log("‚úÖ Modal EVET butonuna tƒ±klandƒ±");
            modal.classList.remove('active');
            setTimeout(() => modal.style.display = 'none', 300);
            resolve(true);
    }
    
    function handleNoClick() {
        if (resolved) return;
        resolved = true;
        console.log("‚ùå Modal ƒ∞PTAL butonuna tƒ±klandƒ±");
            modal.classList.remove('active');
            setTimeout(() => modal.style.display = 'none', 300);
            resolve(false);
    }

    // Event listener'larƒ± temizle ve yenilerini ekle
    yesButton.onclick = null;
    noButton.onclick = null;
    yesButton.onclick = handleYesClick;
    noButton.onclick = handleNoClick;
    
    console.log("üîß Buton event handler'larƒ± eklendi");
    
    // Close button'larƒ± da handle et
    const closeButtons = modal.querySelectorAll('.modern-close');
    closeButtons.forEach(button => {
        button.onclick = null;
        button.onclick = handleNoClick;
    });
    
    // Modal dƒ±≈üƒ±na tƒ±klamayƒ± handle et
    modal.onclick = null;
    modal.onclick = (e) => {
        if (e.target === modal) {
            handleNoClick();
        }
    };
    
    // Modalƒ± g√∂ster
        console.log("üé≠ Modal g√∂steriliyor...");
    modal.style.display = 'flex';
        // CSS animasyonlarƒ± i√ßin active sƒ±nƒ±fƒ±nƒ± ekle
        setTimeout(() => {
            modal.classList.add('active');
            console.log("‚úÖ Modal active sƒ±nƒ±fƒ± eklendi");
        }, 10);
    });
}

/**
 * Modern toast bildirimi g√∂sterme
 * @param {string} message - Bildirim mesajƒ±
 * @param {string} type - Bildirim tipi (success, error, warning, info)
 * @param {number} duration - G√∂r√ºnme s√ºresi (ms)
 */
function showModernToast(message, type = 'success', duration = 4000) {
    const toast = document.getElementById('modernToast');
    const messageElement = document.getElementById('modernToastMessage');
    const iconElement = toast.querySelector('.modern-toast-icon');
    const progressBar = toast.querySelector('.modern-toast-progress-bar');
    
    // Mesajƒ± ayarla
    messageElement.textContent = message;
    
    // ƒ∞kon ve renk sƒ±nƒ±flarƒ±nƒ± temizle
    iconElement.classList.remove('success', 'error', 'warning', 'info');
    
    // ƒ∞kon ve renk ayarla
    switch(type) {
        case 'error':
            iconElement.classList.add('error');
            iconElement.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>';
            progressBar.style.backgroundColor = 'var(--danger-color)';
            break;
        case 'warning':
            iconElement.classList.add('warning');
            iconElement.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>';
            progressBar.style.backgroundColor = 'var(--warning-color)';
            break;
        case 'info':
            iconElement.classList.add('info');
            iconElement.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>';
            progressBar.style.backgroundColor = 'var(--info-color)';
            break;
        default: // success
            iconElement.classList.add('success');
            iconElement.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>';
            progressBar.style.backgroundColor = 'var(--success-color)';
    }
    
    // Animasyon s√ºresini ayarla
    progressBar.style.animation = `progressShrink ${duration/1000}s linear forwards`;
    
    // Toastƒ± g√∂ster
    toast.style.display = 'block';
    
    // Belirtilen s√ºre sonra kapat
    const toastTimeout = setTimeout(() => {
        toast.style.display = 'none';
    }, duration);
    
    // Kapatma butonuna tƒ±klandƒ±ƒüƒ±nda
    toast.querySelector('.modern-toast-close').onclick = function() {
        clearTimeout(toastTimeout);
        toast.style.display = 'none';
    };
}

/**
 * Modern modal a√ßma
 * @param {string} modalId - Modal element ID'si
 */
function openModernModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('active'), 10);
        
        // Close butonlarƒ± i√ßin event listener ekle
        modal.querySelectorAll('.modern-close').forEach(closeBtn => {
            closeBtn.onclick = () => closeModernModal(modalId);
        });
        
        // Modal dƒ±≈üƒ±na tƒ±klama ile kapatma
        modal.onclick = function(e) {
            if (e.target === modal) {
                closeModernModal(modalId);
            }
        };
        
        // Escape tu≈üu ile kapatma
        const escapeHandler = (e) => {
            if (e.key === 'Escape') {
                closeModernModal(modalId);
                document.removeEventListener('keydown', escapeHandler);
            }
        };
        document.addEventListener('keydown', escapeHandler);
    }
}

/**
 * Modern modal kapatma
 * @param {string} modalId - Modal element ID'si
 */
function closeModernModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('active');
        setTimeout(() => {
        modal.style.display = 'none';
            // Event listener'larƒ± temizle
            modal.onclick = null;
        }, 300);
    }
}

/**
 * Silme onay modalƒ±nƒ± g√∂sterme
 * @param {Function} confirmCallback - Onay verildiƒüinde √ßalƒ±≈üacak fonksiyon
 * @param {string} message - G√∂sterilecek mesaj
 */
function showDeleteConfirmModal(confirmCallback, message = 'Bu √∂ƒüeyi silmek istediƒüinizden emin misiniz?') {
    console.log("üî¥ [DEBUG] showDeleteConfirmModal √ßaƒürƒ±ldƒ±");
    console.log("üî¥ [DEBUG] Callback fonksiyonu tipi:", typeof confirmCallback);
    console.log("üî¥ [DEBUG] Mesaj:", message);
    
    // Modern confirm sistemini kullan
    showModernConfirm(
        'Etkinlik Silme Onayƒ±',
        message,
        {
            confirmText: 'Evet, Sil',  
            cancelText: 'ƒ∞ptal',
            headerClass: 'danger-action',
            iconClass: 'danger'
        }
    ).then(confirmed => {
        console.log("üî¥ [DEBUG] Modal cevabƒ± alƒ±ndƒ±, confirmed:", confirmed);
        console.log("üî¥ [DEBUG] Callback fonksiyonu mevcut mu?", typeof confirmCallback === 'function');
        
        if (confirmed && typeof confirmCallback === 'function') {
            console.log("üî¥ [DEBUG] Callback fonksiyonu √ßaƒürƒ±lƒ±yor...");
            confirmCallback();
        } else if (confirmed) {
            console.log("üî¥ [DEBUG] HATA: Onay verildi ama callback fonksiyonu bulunamadƒ±!");
        } else {
            console.log("üî¥ [DEBUG] Kullanƒ±cƒ± silme i≈ülemini iptal etti");
        }
    }).catch(error => {
        console.error("üî¥ [DEBUG] Modal hata verdi:", error);
    });
}

/**
 * Puan daƒüƒ±tƒ±m modalƒ±nƒ± g√∂sterme
 * @param {Object} parentNode - Ana d√ºƒü√ºm
 * @param {number} totalWeight - Mevcut toplam aƒüƒ±rlƒ±k
 */
function showDistributePointsModal(parentNode, totalWeight) {
    const modal = document.getElementById('distributePointsModal');
    const totalWeightElement = document.getElementById('currentTotalWeight');
    const confirmButton = document.getElementById('confirmDistributeBtn');
    const totalPointsInput = document.getElementById('totalPointsInput');
    const equalOption = document.getElementById('equalOption');
    const randomOption = document.getElementById('randomOption');
    
    let selectedDistribution = null;
    
    // Toplam aƒüƒ±rlƒ±ƒüƒ± g√∂ster
    totalWeightElement.textContent = totalWeight;
    
    // Se√ßim yapƒ±lana kadar onay butonunu devre dƒ±≈üƒ± bƒ±rak
    confirmButton.disabled = true;
    
    // Daƒüƒ±tƒ±m se√ßeneklerine tƒ±klandƒ±ƒüƒ±nda
    equalOption.onclick = function() {
        equalOption.classList.add('selected');
        randomOption.classList.remove('selected');
        selectedDistribution = 'equal';
        confirmButton.disabled = false;
    };
    
    randomOption.onclick = function() {
        randomOption.classList.add('selected');
        equalOption.classList.remove('selected');
        selectedDistribution = 'random';
        confirmButton.disabled = false;
    };
    
    // Onay butonuna tƒ±klandƒ±ƒüƒ±nda
    confirmButton.onclick = function() {
        const totalPoints = parseInt(totalPointsInput.value) || 100;
        
        if (selectedDistribution === 'equal') {
            distributePointsEqually(parentNode, totalPoints);
            showModernToast(`Puanlar ${parentNode.name} etkinliƒüine e≈üit olarak daƒüƒ±tƒ±ldƒ±.`, 'success');
        } else if (selectedDistribution === 'random') {
            distributePointsRandomly(parentNode, totalPoints);
            showModernToast(`Puanlar ${parentNode.name} etkinliƒüine rastgele daƒüƒ±tƒ±ldƒ±.`, 'success');
        }
        
        // Modalƒ± kapat
        closeModernModal('distributePointsModal');
        
        // Aƒüacƒ± yeniden render et
        renderTree();
        
        // Deƒüerlendirme sekmesini g√ºncelle
        updateAssessmentView();
    };
    
    // Modalƒ± g√∂ster
    openModernModal('distributePointsModal');
    
    // Se√ßimleri sƒ±fƒ±rla
    equalOption.classList.remove('selected');
    randomOption.classList.remove('selected');
}

/**
 * Test skoru daƒüƒ±tƒ±m modalƒ±nƒ± g√∂sterme
 * @param {string} studentId - √ñƒürenci ID'si
 * @param {string} testId - Test ID'si
 */
function showTestScoreDistributionModal(studentId, testId) {
    const modal = document.getElementById('testScoreDistributionModal');
    const testNode = findNodeById(testId);
    const student = APP_STATE.studentData.find(s => s.studentId === studentId);
    
    if (!testNode || !student) {
        showModernToast("Test veya √∂ƒürenci bilgisi bulunamadƒ±!", "error");
        return;
    }
    
    // Test bilgilerini ayarla
    document.getElementById('testStudentName').textContent = `${student.name} ${student.surname} (${studentId})`;
    document.getElementById('testName').textContent = testNode.name;
    document.getElementById('testTotalQuestions').textContent = testNode.testDetails.totalQuestions;
    
    const totalQuestions = testNode.testDetails.totalQuestions;
    const correctWeight = testNode.testDetails.correctWeight;
    const wrongPenalty = Math.abs(testNode.testDetails.wrongPenalty);
    
    // Slider'larƒ± ayarla
    const correctSlider = document.getElementById('testCorrectSlider');
    const wrongSlider = document.getElementById('testWrongSlider');
    correctSlider.max = totalQuestions;
    wrongSlider.max = totalQuestions;
    
    // Mevcut deƒüerleri al
    let correct = 0;
    let wrong = 0;
    
    // √ñƒürencinin mevcut test verilerini kontrol et
    if (APP_STATE.gradesData[studentId] && APP_STATE.gradesData[studentId][testId]) {
        const testData = APP_STATE.gradesData[studentId][testId];
        if (testData.tip === 'test' || testData.type === 'test') {
            correct = testData.dogru || testData.correct || 0;
            wrong = testData.yanlis || testData.wrong || 0;
        }
    }
    
    // Slider ve deƒüerleri g√ºncelle
    correctSlider.value = correct;
    wrongSlider.value = wrong;
    updateTestDistributionPreview(correct, wrong, totalQuestions, correctWeight, wrongPenalty);
    
    // Slider olaylarƒ±
    correctSlider.oninput = function() {
        const correctValue = parseInt(this.value);
        const wrongValue = parseInt(wrongSlider.value);
        
        // Toplam soru sayƒ±sƒ±nƒ± kontrol et
        if (correctValue + wrongValue > totalQuestions) {
            wrongSlider.value = totalQuestions - correctValue;
            wrong = totalQuestions - correctValue;
        }
        
        correct = correctValue;
        updateTestDistributionPreview(correct, wrong, totalQuestions, correctWeight, wrongPenalty);
    };
    
    wrongSlider.oninput = function() {
        const wrongValue = parseInt(this.value);
        const correctValue = parseInt(correctSlider.value);
        
        // Toplam soru sayƒ±sƒ±nƒ± kontrol et
        if (correctValue + wrongValue > totalQuestions) {
            correctSlider.value = totalQuestions - wrongValue;
            correct = totalQuestions - wrongValue;
        }
        
        wrong = wrongValue;
        updateTestDistributionPreview(correct, wrong, totalQuestions, correctWeight, wrongPenalty);
    };
    
    // Rastgele daƒüƒ±t butonu
    document.getElementById('randomizeTestDistribution').onclick = function() {
        // Rastgele doƒüru sayƒ±sƒ± √ºret
        const randomCorrect = Math.floor(Math.random() * (totalQuestions + 1));
        
        // Rastgele yanlƒ±≈ü sayƒ±sƒ± √ºret (toplam soruyu ge√ßmeyecek ≈üekilde)
        const maxWrong = totalQuestions - randomCorrect;
        const randomWrong = Math.floor(Math.random() * (maxWrong + 1));
        
        // Deƒüerleri g√ºncelle
        correctSlider.value = randomCorrect;
        wrongSlider.value = randomWrong;
        correct = randomCorrect;
        wrong = randomWrong;
        
        updateTestDistributionPreview(correct, wrong, totalQuestions, correctWeight, wrongPenalty);
    };
    
    // Uygula butonu
    document.getElementById('applyTestDistribution').onclick = function() {
        // Test skorunu kaydet
        saveTestDistribution(studentId, testId, correct, wrong);
        
        // Modalƒ± kapat
        closeModernModal('testScoreDistributionModal');
        
        showModernToast(`${student.name} ${student.surname} i√ßin test puanƒ± g√ºncellendi.`, "success");
    };
    
    // Modalƒ± g√∂ster
    openModernModal('testScoreDistributionModal');
}

/**
 * Test daƒüƒ±lƒ±m √∂nizlemesini g√ºncelleme
 */
function updateTestDistributionPreview(correct, wrong, totalQuestions, correctWeight, wrongPenalty) {
    document.getElementById('testCorrectValue').textContent = correct;
    document.getElementById('testWrongValue').textContent = wrong;
    
    const empty = totalQuestions - correct - wrong;
    document.getElementById('testEmptyValue').textContent = empty;
    
    // Toplam puanƒ± hesapla
    const totalScore = (correct * correctWeight) - (wrong * wrongPenalty);
    document.getElementById('testTotalScore').textContent = totalScore.toFixed(2);
    
    // Daƒüƒ±lƒ±m √∂nizlemesini g√ºncelle
    const previewElement = document.getElementById('distributionPreview');
    previewElement.innerHTML = '';
    
    // Doƒüru oranƒ±
    if (correct > 0) {
        const correctBlock = document.createElement('div');
        correctBlock.className = 'question-block question-correct';
        correctBlock.style.width = `${(correct / totalQuestions) * 100}%`;
        previewElement.appendChild(correctBlock);
    }
    
    // Yanlƒ±≈ü oranƒ±
    if (wrong > 0) {
        const wrongBlock = document.createElement('div');
        wrongBlock.className = 'question-block question-wrong';
        wrongBlock.style.width = `${(wrong / totalQuestions) * 100}%`;
        previewElement.appendChild(wrongBlock);
    }
    
    // Bo≈ü oranƒ±
    if (empty > 0) {
        const emptyBlock = document.createElement('div');
        emptyBlock.className = 'question-block question-empty';
        emptyBlock.style.width = `${(empty / totalQuestions) * 100}%`;
        previewElement.appendChild(emptyBlock);
    }
}

/**
 * Test daƒüƒ±lƒ±mƒ±nƒ± kaydetme
 */
function saveTestDistribution(studentId, testId, correct, wrong) {
    // √ñƒürenci verisi olu≈ütur
    if (!APP_STATE.gradesData[studentId]) {
        APP_STATE.gradesData[studentId] = {};
    }
    
    // Test verisini kaydet
    APP_STATE.gradesData[studentId][testId] = {
        tip: 'test',
        type: 'test',
        dogru: correct,
        correct: correct,
        yanlis: wrong,
        wrong: wrong
    };
    
    // Alt d√ºƒü√ºm yapƒ±sƒ±nƒ± olu≈ütur (gerekiyorsa)
    const parts = testId.split('.');
    if (parts.length > 1) {
        const parentId = parts[0]; // √ñrneƒüin: A1
        const shortId = parts[parts.length - 1]; // √ñrneƒüin: 1
        
        // Eƒüer √ºst aktivite yoksa olu≈ütur
        if (!APP_STATE.gradesData[studentId][parentId]) {
            APP_STATE.gradesData[studentId][parentId] = {
                toplam: 0
            };
        }
        
        // Kƒ±sa kod da ekle
        APP_STATE.gradesData[studentId][parentId][shortId] = {
            tip: 'test',
            type: 'test',
            dogru: correct,
            correct: correct,
            yanlis: wrong,
            wrong: wrong
        };
        
        // Alt yapƒ±ya da ekle
        APP_STATE.gradesData[studentId][parentId][testId] = {
            tip: 'test',
            type: 'test',
            dogru: correct,
            correct: correct,
            yanlis: wrong,
            wrong: wrong
        };
        
        // Toplama hesapla
        updateParentActivityTotal(studentId, parentId);
    }
    
    // Deƒüerlendirme sekmesini g√ºncelle
    updateAssessmentView();
    
    // Notlarƒ± yeniden hesapla
    updateStudentCalculatedGrade(studentId);
    
    // √ñƒürenci g√∂r√ºn√ºm√ºn√º g√ºncelle
    updateStudentViewTestTotal(studentId, testId);
}

// Modal kapatma d√ºƒümelerini ayarla
document.addEventListener('DOMContentLoaded', function() {
    // T√ºm modern kapatma butonlarƒ±na tƒ±klama olayƒ± ekle
    document.querySelectorAll('.modern-close').forEach(button => {
        button.addEventListener('click', function() {
            // En yakƒ±n modal elementini bul
            const modal = this.closest('.modern-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        });
    });
    
    // Modal dƒ±≈üƒ±na tƒ±klanƒ±nca kapatma
    document.querySelectorAll('.modern-modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });
    });
});

// =====================================================
// GRUP Y√ñNETƒ∞Mƒ∞ FONKSƒ∞YONLARI
// =====================================================

/**
 * Grup sistemini ba≈ülatma
 */
function initializeGroupSystem() {
    // Eƒüer grup haritalama yoksa varsayƒ±lan olu≈ütur
    if (!APP_STATE.courseData) {
        APP_STATE.courseData = {};
    }
    
    if (!APP_STATE.courseData.grupHaritalari) {
        APP_STATE.courseData.grupHaritalari = {};
    }
    
    // Her zaman en az bir grup olmasƒ±nƒ± garanti et
    ensureDefaultGroupExists();
    
    // √ñƒürencilere grup atanmamƒ±≈üsa A grubu ata
    if (APP_STATE.studentData && APP_STATE.studentData.length > 0) {
        APP_STATE.studentData.forEach(student => {
            if (!student.grup) {
                student.grup = "A";
            }
        });
    }
    
    // Sorular i√ßin otomatik 1:1 haritalama olu≈ütur (her parent activity kendi i√ßinde)
    createDefaultMapping();
    
    // Grup haritalama verilerini debug et
    console.log('üìä Grup haritalama durumu:', APP_STATE.courseData?.grupHaritalari);
    
    // T√ºm ilgili UI'larƒ± g√ºncelle
    updateGroupSelectors();
    updateAllInlineGroupInputs();
}

/**
 * Her deƒüerlendirme bile≈üeni i√ßin varsayƒ±lan A grubunun var olmasƒ±nƒ± garanti eder
 * A GRUBU HER ZAMAN MEVCUT OLMALI - Bu sistem kuralƒ±dƒ±r
 */
function ensureDefaultGroupExists() {
    console.log(`üîß ensureDefaultGroupExists √ßalƒ±≈üƒ±yor...`);
    
    // Ana deƒüerlendirme bile≈üenlerini bul
    const mainComponents = APP_STATE.assessmentTree.filter(node => 
        node.id.startsWith('A') || node.id.startsWith('F')
    );
    
    console.log(`üìã ${mainComponents.length} ana bile≈üen bulundu:`, mainComponents.map(c => c.id));
    
    mainComponents.forEach(component => {
        console.log(`\nüîç ${component.id} bile≈üeni kontrol ediliyor...`);
        
        if (!APP_STATE.courseData.grupHaritalari[component.id]) {
            // Hi√ß grup yapƒ±sƒ± yoksa olu≈ütur
            APP_STATE.courseData.grupHaritalari[component.id] = {
                gruplar: ["A"],
                haritalar: {
                    "A": {}
                }
            };
            console.log(`‚úÖ ${component.id}: Yeni grup yapƒ±sƒ± olu≈üturuldu (A grubu)`);
        } else {
            // Mevcut bile≈üeni kontrol et ve d√ºzelt
            const existingComponent = APP_STATE.courseData.grupHaritalari[component.id];
            let needsUpdate = false;
            
            // Grup listesi kontrol√º
            if (!existingComponent.gruplar || existingComponent.gruplar.length === 0) {
                existingComponent.gruplar = ["A"];
                needsUpdate = true;
                console.log(`üîß ${component.id}: Grup listesi d√ºzeltildi (A grubu eklendi)`);
            } else if (!existingComponent.gruplar.includes("A")) {
                // A grubu listede yoksa ba≈üa ekle
                existingComponent.gruplar.unshift("A");
                needsUpdate = true;
                console.log(`üîß ${component.id}: A grubu listeye eklendi`);
            }
            
            // Mapping yapƒ±sƒ± kontrol√º
            if (!existingComponent.haritalar) {
                existingComponent.haritalar = {};
                needsUpdate = true;
                console.log(`üîß ${component.id}: Mapping yapƒ±sƒ± olu≈üturuldu`);
            }
            
            if (!existingComponent.haritalar["A"]) {
                existingComponent.haritalar["A"] = {};
                needsUpdate = true;
                console.log(`üîß ${component.id}: A grubu mapping'i olu≈üturuldu`);
            }
            
            if (needsUpdate) {
                console.log(`‚úÖ ${component.id}: Grup yapƒ±sƒ± g√ºncellendi`);
            } else {
                console.log(`‚úÖ ${component.id}: Grup yapƒ±sƒ± zaten uygun`);
            }
        }
        
        // Son kontrol
        const finalCheck = APP_STATE.courseData.grupHaritalari[component.id];
        console.log(`üìä ${component.id} final durum:`, {
            gruplar: finalCheck.gruplar,
            mappingKeys: Object.keys(finalCheck.haritalar || {}),
            hasAGroup: finalCheck.gruplar?.includes("A"),
            hasAMapping: !!finalCheck.haritalar?.["A"]
        });
    });
    
    console.log(`‚úÖ ensureDefaultGroupExists tamamlandƒ± - T√ºm bile≈üenlerde A grubu garantili`);
}

/**
 * Yarƒ±yƒ±l i√ßi aƒüƒ±rlƒ±ƒüƒ±nƒ± getir
 */
function getTermWeight() {
    return APP_STATE.termWeight || 40;
}

/**
 * Yarƒ±yƒ±l sonu aƒüƒ±rlƒ±ƒüƒ±nƒ± getir
 */
function getFinalWeight() {
    return APP_STATE.finalWeight || 60;
}

/**
 * Belirli bir deƒüerlendirmenin aƒüƒ±rlƒ±ƒüƒ±nƒ± getir
 * @param {string} activityId - Aktivite ID'si
 * @returns {number} - Aƒüƒ±rlƒ±k y√ºzdesi
 */
function getAssessmentWeight(activityId) {
    try {
        const activity = findNodeById(activityId);
        if (!activity) return 0;
        
        // Ana bile≈üen mi yoksa alt bile≈üen mi kontrol et
        if (activity.id.startsWith('A')) {
            // Yarƒ±yƒ±l i√ßi deƒüerlendirme
            return activity.weight || 0;
        } else if (activity.id.startsWith('F')) {
            // Yarƒ±yƒ±l sonu deƒüerlendirme
            return activity.weight || 0;
        }
        
        // Alt bile≈üen ise, √ºst bile≈üenin aƒüƒ±rlƒ±ƒüƒ±nƒ± al
        const parentId = getParentComponentId(activityId);
        if (parentId) {
            const parentActivity = findNodeById(parentId);
            return parentActivity?.weight || 0;
        }
        
        return 0;
    } catch (error) {
        console.error("Deƒüerlendirme aƒüƒ±rlƒ±ƒüƒ± alƒ±nƒ±rken hata:", error);
        return 0;
    }
}

/**
 * Varsayƒ±lan 1:1 haritalama olu≈üturma - Her deƒüerlendirme bile≈üeni i√ßin ayrƒ± grup sistemi
 */
function createDefaultMapping() {
    // Grup haritalama yapƒ±sƒ±nƒ± ba≈ülat
    if (!APP_STATE.courseData.grupHaritalari) {
        APP_STATE.courseData.grupHaritalari = {};
    }
    
    // Her ana deƒüerlendirme bile≈üeni i√ßin ayrƒ± grup sistemi olu≈ütur
    APP_STATE.assessmentTree.forEach(parentNode => {
        // T√ºm ana bile≈üenler i√ßin grup yapƒ±sƒ± olu≈ütur (soru/rubrik olsun olmasƒ±n)
        if (!APP_STATE.courseData.grupHaritalari[parentNode.id]) {
            APP_STATE.courseData.grupHaritalari[parentNode.id] = {
                gruplar: ["A"], // Varsayƒ±lan olarak sadece A grubu
                haritalar: {
                    "A": {}
                }
            };
        }
        
        // Eƒüer alt sorularƒ± varsa haritalama olu≈ütur
        if (parentNode.children && parentNode.children.length > 0) {
            let questionIndex = 1;
            parentNode.children.forEach(childNode => {
                if (isQuestionType(childNode.type) || isRubricType(childNode.type)) {
                    // A grubu i√ßin varsayƒ±lan 1:1 haritalama
                    APP_STATE.courseData.grupHaritalari[parentNode.id].haritalar.A[childNode.id] = questionIndex.toString();
                    questionIndex++;
                }
            });
        }
        // Eƒüer alt sorularƒ± yoksa (Laboratuvar gibi), haritalama gerekmez
        // Sadece grup yapƒ±sƒ± yeterli
    });
    
    // T√ºm √∂ƒürencileri A grubuna ata (grup bilgisi yoksa)
    if (APP_STATE.studentData && APP_STATE.studentData.length > 0) {
        APP_STATE.studentData.forEach(student => {
            if (!student.grup) {
                student.grup = 'A';
            }
        });
    }
}

/**
 * Mevcut haritalamayƒ± temizleyip yeniden olu≈üturma
 */
function recreateDefaultMapping() {
    // T√ºm deƒüerlendirme bile≈üenleri i√ßin haritalamayƒ± temizle
    APP_STATE.courseData.grupHaritalari = {};
    
    // Yeniden olu≈ütur
    createDefaultMapping();
    
    // UI'larƒ± g√ºncelle
    updateAllInlineGroupInputs();
    updateGroupMappingColors();
    updateAllMappingDisplays();
    
    showModernToast("Grup haritalamalar d√ºzeltildi - her deƒüerlendirme bile≈üeni kendi grup sistemine sahip", "success");
}

/**
 * T√ºm sorularƒ± toplama
 */
function getAllQuestions() {
    const questions = [];
    
    function collectQuestions(nodes) {
        nodes.forEach(node => {
            if (isQuestionType(node.type) || isRubricType(node.type)) {
                questions.push({
                    id: node.id,
                    name: node.name,
                    type: node.type
                });
            }
            if (node.children && node.children.length > 0) {
                collectQuestions(node.children);
            }
        });
    }
    
    collectQuestions(APP_STATE.assessmentTree);
    return questions;
}

/**
 * Belirli bir deƒüerlendirme bile≈üenine yeni grup ekleme
 */
async function addNewGroupToComponent(componentId) {
    const groupNames = ['B', 'C', 'D', 'E', 'F', 'G', 'H'];
    const component = APP_STATE.courseData.grupHaritalari[componentId];
    
    if (!component) {
        showModernToast("Deƒüerlendirme bile≈üeni bulunamadƒ±", "error");
        return;
    }
    
    const existingGroups = component.gruplar || [];
    const newGroupName = groupNames.find(name => !existingGroups.includes(name));
    
    if (!newGroupName) {
        showModernToast("Bu bile≈üen i√ßin maksimum grup sayƒ±sƒ±na ula≈üƒ±ldƒ±", "warning");
        return;
    }
    
    // Modern confirm dialog ile onay al
    const confirmed = await showModernConfirm(
        'Grup Ekleme Onayƒ±',
        `${getComponentDisplayName(componentId)} bile≈üenine grup ${newGroupName} eklemek istediƒüinizden emin misiniz?`,
        {
            confirmText: 'Evet, Ekle',
            cancelText: 'ƒ∞ptal',
            headerClass: 'success-action',
            iconClass: 'success'
        }
    );
    
    if (!confirmed) {
        return;
    }
    
        // Yeni grubu listeye ekle
        component.gruplar.push(newGroupName);
        
        // A grubunun kopyasƒ± olarak mapping olu≈ütur (derin kopya)
        const groupAMapping = component.haritalar.A || {};
        component.haritalar[newGroupName] = JSON.parse(JSON.stringify(groupAMapping));
        
        // Eƒüer A grubunda mapping yoksa, varsayƒ±lan 1:1 mapping olu≈ütur
        if (Object.keys(groupAMapping).length === 0) {
            const componentNode = findNodeById(componentId);
            if (componentNode && componentNode.children) {
                let questionIndex = 1;
                componentNode.children.forEach(childNode => {
                    if (isQuestionType(childNode.type) || isRubricType(childNode.type)) {
                        // D√úZELTME: Veri yapƒ±sƒ± {position: questionId} formatƒ±nda
                        component.haritalar.A[questionIndex.toString()] = childNode.id;
                        component.haritalar[newGroupName][questionIndex.toString()] = childNode.id;
                        questionIndex++;
                    }
                });
            }
        }
        
        // UI'larƒ± g√ºncelle
        updateGroupSelectors();
        updateStudentTable();
        updateAssessmentView();
        updateAllInlineGroupInputs();
        updateAllMappingDisplays();
        updateGroupMappingColors();
        
        // Grup sayƒ±sƒ±nƒ± g√ºncelle
        updateComponentGroupCounts();
        
        // Modal'ƒ± g√ºncelle (eƒüer a√ßƒ±ksa)
        updateComponentGroupList(componentId);
        
        // Ders tanƒ±mlama sayfasƒ±ndaki grup bilgilerini g√ºncelle
        updateComponentGroupInfo(componentId);
        
        showModernToast(`${getComponentDisplayName(componentId)} bile≈üenine grup ${newGroupName} eklendi`, "success");
}

/**
 * T√ºm deƒüerlendirme bile≈üenlerine yeni grup ekleme (eski davranƒ±≈ü i√ßin)
 */
function addNewGroup() {
    const groupNames = ['B', 'C', 'D', 'E', 'F', 'G', 'H'];
    let addedToAny = false;
    
    // Her deƒüerlendirme bile≈üenine grup ekle
    Object.keys(APP_STATE.courseData.grupHaritalari || {}).forEach(componentId => {
        const component = APP_STATE.courseData.grupHaritalari[componentId];
        const existingGroups = component.gruplar || [];
        const newGroupName = groupNames.find(name => !existingGroups.includes(name));
        
        if (newGroupName) {
            component.gruplar.push(newGroupName);
            const groupAMapping = component.haritalar.A || {};
            component.haritalar[newGroupName] = {...groupAMapping};
            addedToAny = true;
        }
    });
    
    if (addedToAny) {
        // UI'larƒ± g√ºncelle
        updateGroupSelectors();
        updateStudentTable();
        updateAssessmentView();
        updateAllInlineGroupInputs();
        updateAllMappingDisplays();
        updateGroupMappingColors();
        
        showModernToast("T√ºm deƒüerlendirme bile≈üenlerine yeni grup eklendi", "success");
    } else {
        showModernToast("Maksimum grup sayƒ±sƒ±na ula≈üƒ±ldƒ±", "warning");
    }
}

/**
 * Belirli bir deƒüerlendirme bile≈üeninden grup silme
 */
async function deleteGroupFromComponent(componentId, groupName) {
    const component = APP_STATE.courseData.grupHaritalari[componentId];
    
    if (!component || groupName === 'A') {
        showModernToast("A grubu silinemez", "warning");
        return;
    }
    
    if (!component.gruplar.includes(groupName)) {
        showModernToast("Grup bulunamadƒ±", "warning");
        return;
    }
    
    // Modern confirm dialog ile onay al
    const confirmed = await showModernConfirm(
        'Grup Silme Onayƒ±',
        `${getComponentDisplayName(componentId)} bile≈üeninden grup ${groupName}'ƒ± silmek istediƒüinizden emin misiniz?`,
        {
            confirmText: 'Evet, Sil',
            cancelText: 'ƒ∞ptal',
            headerClass: 'danger-action',
            iconClass: 'danger'
        }
    );
    
    if (!confirmed) {
        return;
    }
    
    // Bu grupta √∂ƒürenci var mƒ± kontrol et
    console.log('üîç √ñƒürenci kontrol√º yapƒ±lƒ±yor...');
    console.log('üìä APP_STATE.studentData:', APP_STATE.studentData);
    console.log('üéØ Aranan grup:', groupName);
    
    const studentsInGroup = APP_STATE.studentData.filter(student => student.grup === groupName);
    console.log('üë• Bu grupta bulunan √∂ƒürenciler:', studentsInGroup);
    
    if (studentsInGroup.length > 0) {
        console.log(`‚úÖ ${studentsInGroup.length} √∂ƒürenci bulundu, yeniden atama modalƒ± a√ßƒ±lƒ±yor...`);
        // √ñƒürenci yeniden atama modalƒ±nƒ± a√ß
        showStudentReassignmentModal(groupName, studentsInGroup, componentId, function() {
            // Yeniden atama sonrasƒ± grup silme i≈ülemini tamamla
            performGroupDeletion(componentId, groupName);
        });
    } else {
        console.log('‚ÑπÔ∏è Bu grupta √∂ƒürenci yok, direkt siliniyor...');
        // √ñƒürenci yoksa direkt sil
        performGroupDeletion(componentId, groupName);
    }
}

/**
 * Grup silme i≈ülemini ger√ßekle≈ütir
 */
function performGroupDeletion(componentId, groupName) {
    const component = APP_STATE.courseData.grupHaritalari[componentId];
    
    if (!component) {
        showModernToast("Bile≈üen bulunamadƒ±", "error");
        return;
    }
    
            // Grubu listeden √ßƒ±kar
            component.gruplar = component.gruplar.filter(g => g !== groupName);
            
            // Mapping'i sil
            delete component.haritalar[groupName];
            
            // UI'larƒ± g√ºncelle
            updateGroupSelectors();
            updateStudentTable();
            updateAssessmentView();
            updateAllInlineGroupInputs();
            updateAllMappingDisplays();
            updateGroupMappingColors();
            
            // Grup sayƒ±sƒ±nƒ± g√ºncelle
            updateComponentGroupCounts();
            
            // Modal'ƒ± g√ºncelle (eƒüer a√ßƒ±ksa)
            updateComponentGroupList(componentId);
            
            // T√ºm UI'larƒ± g√ºncelle
            updateAllInlineGroupInputs();
            updateGroupSelectors();
            updateAssessmentView();
            
            showModernToast(`${getComponentDisplayName(componentId)} bile≈üeninden grup ${groupName} silindi`, "success");
}

/**
 * √ñƒürenci yeniden atama modalƒ±nƒ± g√∂ster
 */
function showStudentReassignmentModal(groupName, studentsInGroup, componentId, onComplete) {
    console.log('üöÄ showStudentReassignmentModal √ßaƒürƒ±ldƒ±');
    console.log('üìã Parametreler:', { groupName, studentsInGroup, componentId });
    
    const modal = document.getElementById('studentReassignmentModal');
    console.log('üîç Modal element:', modal);
    
    if (!modal) {
        console.error('‚ùå Student reassignment modal bulunamadƒ±');
        return;
    }
    
    // Modal i√ßeriƒüini doldur
    const reassignmentMessage = document.getElementById('reassignmentMessage');
    const studentsToReassign = document.getElementById('studentsToReassign');
    const targetGroupSelect = document.getElementById('targetGroupSelect');
    
    if (reassignmentMessage) {
        reassignmentMessage.textContent = `Grup ${groupName} silinecek. Bu grupta ${studentsInGroup.length} √∂ƒürenci bulunuyor. Bu √∂ƒürencileri hangi gruplara atamak istiyorsunuz?`;
    }
    
    if (studentsToReassign) {
        studentsToReassign.innerHTML = studentsInGroup.map(student => 
            `<div class="student-item">
                <span class="student-info">${student.ogrenciNo} - ${student.ad} ${student.soyad}</span>
                <span class="current-group">Mevcut Grup: ${student.grup}</span>
            </div>`
        ).join('');
    }
    
    // Mevcut gruplarƒ± listele (silinecek grup hari√ß)
    if (targetGroupSelect) {
        const allGroups = new Set(['A']);
        
        // T√ºm bile≈üenlerden grup listesi olu≈ütur
        Object.values(APP_STATE.courseData.grupHaritalari || {}).forEach(component => {
            if (component.gruplar) {
                component.gruplar.forEach(group => {
                    if (group !== groupName && group.length === 1 && /^[A-Z]$/.test(group)) {
                        allGroups.add(group);
                    }
                });
            }
        });
        
        const availableGroups = Array.from(allGroups).sort();
        targetGroupSelect.innerHTML = availableGroups.map(group => 
            `<option value="${group}">Grup ${group}</option>`
        ).join('');
    }
    
    // Radio button event'lerini ayarla
    const distributeRadio = document.getElementById('distributeEvenly');
    const specificRadio = document.getElementById('assignToSpecific');
    const specificGroupSelection = document.getElementById('specificGroupSelection');
    
    if (distributeRadio && specificRadio && specificGroupSelection) {
        distributeRadio.addEventListener('change', function() {
            if (this.checked) {
                specificGroupSelection.style.display = 'none';
            }
        });
        
        specificRadio.addEventListener('change', function() {
            if (this.checked) {
                specificGroupSelection.style.display = 'block';
            }
        });
        
        // Varsayƒ±lan olarak dengeli daƒüƒ±tƒ±m se√ßili
        distributeRadio.checked = true;
        specificGroupSelection.style.display = 'none';
    }
    
    // Onay butonu event'ini ayarla
    const confirmBtn = document.getElementById('confirmReassignment');
    if (confirmBtn) {
        // Eski event listener'larƒ± temizle
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        
        newConfirmBtn.addEventListener('click', function() {
            performStudentReassignment(groupName, studentsInGroup, onComplete);
        });
    }
    
    // Modal'ƒ± a√ß
    console.log('üîì openModernModal √ßaƒürƒ±lƒ±yor: studentReassignmentModal');
    openModernModal('studentReassignmentModal');
    console.log('‚úÖ openModernModal √ßaƒürƒ±sƒ± tamamlandƒ±');
}

/**
 * √ñƒürenci yeniden atama i≈ülemini ger√ßekle≈ütir
 */
function performStudentReassignment(groupName, studentsInGroup, onComplete) {
    const distributeRadio = document.getElementById('distributeEvenly');
    const specificRadio = document.getElementById('assignToSpecific');
    const targetGroupSelect = document.getElementById('targetGroupSelect');
    
    if (!distributeRadio || !specificRadio) {
        showModernToast("Yeniden atama se√ßeneƒüi belirlenemedi", "error");
        return;
    }
    
    try {
        if (distributeRadio.checked) {
            // Dengeli daƒüƒ±tƒ±m
            const allGroups = new Set(['A']);
            
            // Mevcut gruplarƒ± topla
            Object.values(APP_STATE.courseData.grupHaritalari || {}).forEach(component => {
                if (component.gruplar) {
                    component.gruplar.forEach(group => {
                        if (group !== groupName && group.length === 1 && /^[A-Z]$/.test(group)) {
                            allGroups.add(group);
                        }
                    });
                }
            });
            
            const availableGroups = Array.from(allGroups).sort();
            
            // √ñƒürencileri gruplar arasƒ±nda e≈üit daƒüƒ±t
            studentsInGroup.forEach((student, index) => {
                const targetGroup = availableGroups[index % availableGroups.length];
                student.grup = targetGroup;
            });
            
            showModernToast(`${studentsInGroup.length} √∂ƒürenci ${availableGroups.length} grup arasƒ±nda e≈üit daƒüƒ±tƒ±ldƒ±`, "success");
            
        } else if (specificRadio.checked) {
            // Belirli gruba atama
            const targetGroup = targetGroupSelect?.value;
            if (!targetGroup) {
                showModernToast("Hedef grup se√ßilmedi", "error");
                return;
            }
            
            studentsInGroup.forEach(student => {
                student.grup = targetGroup;
            });
            
            showModernToast(`${studentsInGroup.length} √∂ƒürenci Grup ${targetGroup}'a ta≈üƒ±ndƒ±`, "success");
        }
        
        // UI'larƒ± g√ºncelle
        updateStudentTable();
        updateGroupSelectors();
        updateAssessmentView();
        
        // Modal'ƒ± kapat
        closeModernModal('studentReassignmentModal');
        
        // Callback'i √ßaƒüƒ±r
        if (onComplete) {
            onComplete();
        }
        
    } catch (error) {
        console.error('√ñƒürenci yeniden atama hatasƒ±:', error);
        showModernToast("√ñƒürenci yeniden atama sƒ±rasƒ±nda hata olu≈ütu", "error");
    }
}

/**
 * Bile≈üen grup y√∂netimi modalƒ± g√∂sterme
 */
function showComponentGroupManagementModal(componentId) {
    const component = APP_STATE.courseData.grupHaritalari[componentId];
    if (!component) {
        showModernToast("Deƒüerlendirme bile≈üeni bulunamadƒ±", "error");
        return;
    }
    
    const groups = component.gruplar || ['A'];
    const totalQuestions = countQuestionsInComponent(componentId);
    
    // Modal body i√ßeriƒüi olu≈ütur
    const modalBodyContent = `
        <div class="component-summary">
            <div class="summary-item">
                <span class="summary-label">Toplam Soru:</span>
                <span class="summary-value">${totalQuestions}</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Mevcut Grup Sayƒ±sƒ±:</span>
                <span class="summary-value">${groups.length}</span>
            </div>
        </div>
        
        <div class="groups-container">
            <h4>Gruplar ve Durumlarƒ±:</h4>
            <div class="groups-grid">
                ${groups.map(group => {
                    // D√úZELTME: Sadece bu bile≈üendeki sorularƒ±n e≈üle≈ütirme durumunu kontrol et
                    const componentQuestionCount = getComponentSpecificQuestionMappingCount(componentId, group);
                    const isComplete = componentQuestionCount === totalQuestions;
                    return `
                        <div class="group-card ${isComplete ? 'complete' : 'incomplete'}">
                            <div class="group-header">
                                <span class="group-name">Grup ${group}</span>
                                ${group !== 'A' ? `
                                    <button class="btn-delete-group" data-component-id="${componentId}" data-group="${group}" title="Grubu Sil">
                                        √ó
                                    </button>
                                ` : '<span class="default-badge">Varsayƒ±lan</span>'}
                            </div>
                            <div class="group-stats">
                                <span class="mapped-count">${componentQuestionCount}/${totalQuestions} soru e≈üle≈ütirildi</span>
                                <span class="status-badge ${isComplete ? 'complete' : 'incomplete'}">
                                    ${isComplete ? 'Tamamlandƒ±' : 'Eksik'}
                                </span>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
        
        <div class="group-actions">
            <button class="btn btn-success" id="addNewGroupBtn" data-component-id="${componentId}">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <line x1="19" y1="8" x2="19" y2="14"/>
                    <line x1="22" y1="11" x2="16" y2="11"/>
                </svg>
                Yeni Grup Ekle
            </button>
        </div>
    `;
    
    // Modal body'yi g√ºncelle
    const modalBody = document.getElementById('componentGroupModalBody');
    if (modalBody) {
        modalBody.innerHTML = modalBodyContent;
        
        // Modal ba≈ülƒ±ƒüƒ±nƒ± g√ºncelle
        const modalHeader = document.querySelector('#componentGroupManagementModal .modern-modal-header h2');
        if (modalHeader) {
            modalHeader.textContent = `${componentId} Bile≈üeni - Grup Ekle/√áƒ±kar`;
        }
        
        // Event listener'larƒ± ekle
        setupComponentGroupModalEvents(componentId);
        
        // Modal'ƒ± g√∂ster
        openModernModal('componentGroupManagementModal');
    }
}

/**
 * Belirli bir bile≈üen ve grup i√ßin e≈üle≈ütirilmi≈ü soru sayƒ±sƒ±nƒ± hesaplama
 */
function getComponentSpecificQuestionMappingCount(componentId, groupId) {
    const component = APP_STATE.courseData.grupHaritalari[componentId];
    if (!component || !component.haritalar || !component.haritalar[groupId]) {
        return 0;
    }
    
    // Bu bile≈üendeki t√ºm sorularƒ± bul
    const componentNode = findNodeById(componentId);
    if (!componentNode || !componentNode.children) {
        return 0;
    }
    
    const componentQuestionIds = [];
    componentNode.children.forEach(child => {
        if (isQuestionType(child.type) || isRubricType(child.type)) {
            componentQuestionIds.push(child.id);
        }
    });
    
    // Bu bile≈üendeki sorulardan ka√ß tanesi bu grupta e≈üle≈ütirilmi≈ü
    let mappedCount = 0;
    const groupMappings = component.haritalar[groupId];
    
    componentQuestionIds.forEach(questionId => {
        // D√úZELTME: Veri yapƒ±sƒ± {position: questionId} formatƒ±nda, {questionId: position} deƒüil
        // Bu y√ºzden Object.values() ile questionId'leri kontrol etmeliyiz
        const isQuestionMapped = Object.values(groupMappings).includes(questionId);
        
        if (isQuestionMapped) {
            mappedCount++;
        }
    });
    
    return mappedCount;
}

/**
 * Bile≈üen grup modalƒ± event listener'larƒ±nƒ± kurma
 */
function setupComponentGroupModalEvents(componentId) {
    // Grup silme butonlarƒ±
    document.querySelectorAll('#componentGroupManagementModal .btn-delete-group').forEach(btn => {
        btn.addEventListener('click', function() {
            const groupName = this.dataset.group;
            const compId = this.dataset.componentId;
            deleteGroupFromComponent(compId, groupName);
        });
    });
    
    // Yeni grup ekleme butonu
    const addNewGroupBtn = document.getElementById('addNewGroupBtn');
    if (addNewGroupBtn) {
        addNewGroupBtn.addEventListener('click', function() {
            const compId = this.dataset.componentId;
            addNewGroupToComponent(compId);
        });
    }
}

/**
 * Bile≈üen grup listesini g√ºncelleme
 */
function updateComponentGroupList(componentId) {
    // Modal a√ßƒ±k mƒ± kontrol et
    const modal = document.getElementById('componentGroupManagementModal');
    if (modal && (modal.classList.contains('active') || modal.style.display === 'block')) {
        // Modal i√ßeriƒüini yeniden olu≈ütur
        showComponentGroupManagementModal(componentId);
    }
}

/**
 * Grup haritalama √∂nizlemesi olu≈üturma
 */
function generateGroupMappingsPreview(componentId) {
    const component = APP_STATE.courseData.grupHaritalari[componentId];
    if (!component || !component.haritalar) {
        return '<p>Hen√ºz haritalama yapƒ±lmamƒ±≈ü</p>';
    }
    
    const groups = component.gruplar || ['A'];
    let preview = '<div class="mappings-grid">';
    
    groups.forEach(group => {
        const mappings = component.haritalar[group] || {};
        const mappingCount = Object.keys(mappings).length;
        
        preview += `
            <div class="mapping-preview-item">
                <div class="group-header">Grup ${group}</div>
                <div class="mapping-count">${mappingCount} haritalama</div>
                <div class="mapping-details">
                    ${Object.entries(mappings).map(([position, questionId]) => 
                        `<span class="mapping-detail">Soru ${position} ‚Üí ${questionId}</span>`
                    ).join('')}
                </div>
            </div>
        `;
    });
    
    preview += '</div>';
    return preview;
}

/**
 * T√ºm deƒüerlendirme bile≈üenlerinden grup silme (eski davranƒ±≈ü i√ßin)
 */
function deleteGroup() {
    // T√ºm bile≈üenlerde ortak olan gruplarƒ± bul
    const allGroups = new Set();
    Object.values(APP_STATE.courseData.grupHaritalari || {}).forEach(component => {
        (component.gruplar || []).forEach(group => allGroups.add(group));
    });
    
    const nonAGroups = Array.from(allGroups).filter(g => g !== 'A');
    
    if (nonAGroups.length === 0) {
        showModernToast("A grubu dƒ±≈üƒ±nda silinecek grup yok", "warning");
        return;
    }
    
    // Son grubu sil (alfabetik sƒ±rayla son)
    const lastGroup = nonAGroups.sort().pop();
    
    showDeleteConfirmModal(
        function() {
            // T√ºm bile≈üenlerden bu grubu sil
            Object.keys(APP_STATE.courseData.grupHaritalari || {}).forEach(componentId => {
                const component = APP_STATE.courseData.grupHaritalari[componentId];
                if (component.gruplar && component.gruplar.includes(lastGroup)) {
                    component.gruplar = component.gruplar.filter(g => g !== lastGroup);
                    delete component.haritalar[lastGroup];
                }
            });
            
            // Bu gruptaki √∂ƒürencileri A grubuna ta≈üƒ±
            APP_STATE.studentData.forEach(student => {
                if (student.grup === lastGroup) {
                    student.grup = 'A';
                }
            });
            
            // T√ºm ilgili UI'larƒ± g√ºncelle
            updateGroupSelectors();
            updateStudentTable();
            updateAssessmentView();
            updateAllInlineGroupInputs();
            updateAllMappingDisplays();
            updateGroupMappingColors();
            
            // √ñƒürenci bazlƒ± not giri≈üi ekranƒ±nƒ± da g√ºncelle
            if (APP_STATE.selectedStudentId) {
                showStudentGrades(APP_STATE.selectedStudentId);
            }
            
            showModernToast(`Grup ${lastGroup} t√ºm bile≈üenlerden silindi, √∂ƒürenciler A grubuna ta≈üƒ±ndƒ±`, "success");
        },
        `Grup ${lastGroup}'ƒ± t√ºm deƒüerlendirme bile≈üenlerinden silmek istediƒüinizden emin misiniz? Bu gruptaki t√ºm √∂ƒürenciler A grubuna ta≈üƒ±nacak.`
    );
}

/**
 * Aktif gruplarƒ± g√∂r√ºnt√ºleme
 */
// updateActiveGroupsDisplay fonksiyonu kaldƒ±rƒ±ldƒ± - artƒ±k her bile≈üenin kendi grup bilgisi var

/**
 * Grup se√ßicileri g√ºncelleme - Bile≈üen bazlƒ±
 */
function updateGroupSelectors() {
    console.log('üîÑ updateGroupSelectors √ßaƒürƒ±ldƒ±');
    
    try {
        // √ñƒürenci tablosundaki grup se√ßicilerini g√ºncelle (genel gruplar)
        updateStudentTableGroupSelectors();
        
        // Deƒüerlendirme giri≈üindeki grup se√ßicilerini g√ºncelle (bile≈üen bazlƒ±)
        updateAssessmentGroupSelectors();
        
        // √ñƒürenci bazlƒ± not giri≈üindeki grup se√ßicilerini g√ºncelle
        updateStudentGradesGroupSelectors();
        
    } catch (error) {
        console.error('Grup se√ßicileri g√ºncellenirken hata:', error);
    }
}

/**
 * √ñƒürenci tablosundaki grup se√ßicilerini g√ºncelle (genel sistem gruplarƒ±)
 */
function updateStudentTableGroupSelectors() {
    // √ñƒürenci tablosunda genel sistem gruplarƒ± kullanƒ±lƒ±r
    const allGroups = new Set(['A']); // A grubu her zaman var
    
    // Mevcut √∂ƒürencilerin gruplarƒ±ndan grup listesi olu≈ütur
    if (APP_STATE.studentData && APP_STATE.studentData.length > 0) {
        APP_STATE.studentData.forEach(student => {
            if (student.grup) {
                allGroups.add(student.grup);
            }
        });
    }
    
    // Eƒüer grup sistemi varsa, t√ºm mevcut gruplarƒ± ekle
    if (APP_STATE.courseData?.grupHaritalari) {
        Object.values(APP_STATE.courseData.grupHaritalari).forEach(component => {
            if (component.gruplar) {
                component.gruplar.forEach(group => {
                    // Sadece tek harf olan gruplarƒ± ekle (A, B, C, D... - bile≈üen kodlarƒ± deƒüil)
                    if (group.length === 1 && /^[A-Z]$/.test(group)) {
                        allGroups.add(group);
                    }
                });
            }
        });
    }
    
    const groups = Array.from(allGroups).sort();
    
    // Sadece √∂ƒürenci tablosundaki grup se√ßicilerini g√ºncelle
    document.querySelectorAll('#student-content .group-selector').forEach(select => {
        const currentValue = select.value;
        const studentId = select.dataset.studentId;
        select.innerHTML = '';
        
        groups.forEach(groupId => {
            const option = document.createElement('option');
            option.value = groupId;
            option.textContent = groupId;
            if (groupId === currentValue) {
                option.selected = true;
            }
            select.appendChild(option);
        });
        
        // Eƒüer √∂ƒürencinin grubu se√ßenekler arasƒ±nda yoksa, varsayƒ±lan grubu se√ß
        if (!groups.includes(currentValue) && groups.length > 0) {
            select.value = groups[0];
            if (studentId) {
                const student = APP_STATE.studentData.find(s => s.studentId === studentId);
                if (student) {
                    student.grup = groups[0];
                }
            }
        }
    });
}

/**
 * Deƒüerlendirme giri≈üindeki grup se√ßicilerini g√ºncelle (bile≈üen bazlƒ±)
 */
function updateAssessmentGroupSelectors() {
    console.log('üéØ updateAssessmentGroupSelectors √ßaƒürƒ±ldƒ±');
    
    // Deƒüerlendirme giri≈üindeki her bile≈üen i√ßin ayrƒ± ayrƒ± grup se√ßicilerini g√ºncelle
    const groupSelectors = document.querySelectorAll('#assessment-content .group-selector');
    console.log(`  üìã Toplam ${groupSelectors.length} grup se√ßici bulundu`);
    
    groupSelectors.forEach((select, index) => {
        const studentId = select.dataset.studentId;
        let componentId = select.dataset.componentId;
        
        console.log(`  üîç Se√ßici ${index + 1}: studentId=${studentId}, componentId=${componentId}`);
        
        if (!componentId) {
            // Component ID yoksa, en yakƒ±n assessment-subsection'dan bul
            const subsection = select.closest('.assessment-subsection');
            if (subsection && subsection.dataset.activityId) {
                componentId = subsection.dataset.activityId;
                console.log(`    üìç Subsection'dan componentId bulundu: ${componentId}`);
            }
            
            // Hala yoksa TR elementinden bul
            if (!componentId) {
                const row = select.closest('tr');
                if (row && row.dataset.componentId) {
                    componentId = row.dataset.componentId;
                    console.log(`    üìç TR'den componentId bulundu: ${componentId}`);
                }
            }
        }
        
        if (componentId && studentId) {
            // Bu bile≈üenin gruplarƒ±nƒ± al
            const component = APP_STATE.courseData?.grupHaritalari?.[componentId];
            const componentGroups = component?.gruplar || ['A'];
            
            console.log(`    üìä ${componentId} bile≈üeni gruplarƒ±:`, componentGroups);
            
            // √ñƒürencinin bu bile≈üendeki mevcut grubunu al
            const currentGroup = getStudentGroupForComponent(studentId, componentId);
            console.log(`    üë§ √ñƒürenci ${studentId} mevcut grup: ${currentGroup}`);
            
            // Se√ßiciyi g√ºncelle - DOM manipulation ile
            const currentValue = select.value; // Mevcut deƒüeri koru
            
            // √ñnce mevcut option'larƒ± temizle
            while (select.firstChild) {
                select.removeChild(select.firstChild);
            }
            
            // Yeni option'larƒ± ekle
            componentGroups.forEach(groupId => {
                const option = document.createElement('option');
                option.value = groupId;
                option.textContent = groupId;
                if (groupId === currentGroup) {
                    option.selected = true;
                }
                select.appendChild(option);
                console.log(`      ‚ûï Option eklendi: ${groupId} ${groupId === currentGroup ? '(se√ßili)' : ''}`);
            });
            
            // Son kontrol
            console.log(`      üîç Select element option sayƒ±sƒ±: ${select.children.length}`);
            
            console.log(`    ‚úÖ ${componentId} bile≈üeni i√ßin √∂ƒürenci ${studentId}: ${componentGroups.join(', ')} gruplarƒ±, se√ßili: ${currentGroup}`);
        } else {
            console.warn(`    ‚ö†Ô∏è ComponentId veya StudentId eksik: componentId=${componentId}, studentId=${studentId}`);
            
            // En azƒ±ndan A grubunu ekle
            if (select.children.length === 0) {
                const option = document.createElement('option');
                option.value = 'A';
                option.textContent = 'A';
                option.selected = true;
                select.appendChild(option);
                console.log(`    üîß Varsayƒ±lan A grubu eklendi`);
            }
        }
    });
    
    console.log('‚úÖ updateAssessmentGroupSelectors tamamlandƒ±');
}

/**
 * √ñƒürenci bazlƒ± not giri≈üindeki grup se√ßicilerini g√ºncelle
 */
function updateStudentGradesGroupSelectors() {
    // √ñƒürenci bazlƒ± not giri≈üinde genel sistem gruplarƒ± kullanƒ±lƒ±r
    const allGroups = new Set(['A']); // A grubu her zaman var
    
    // Mevcut √∂ƒürencilerin gruplarƒ±ndan grup listesi olu≈ütur
    if (APP_STATE.studentData && APP_STATE.studentData.length > 0) {
        APP_STATE.studentData.forEach(student => {
            if (student.grup) {
                allGroups.add(student.grup);
            }
        });
    }
    
    const groups = Array.from(allGroups).sort();
    
    // Sadece √∂ƒürenci bazlƒ± not giri≈üindeki grup se√ßicilerini g√ºncelle
    document.querySelectorAll('#assessment-content .group-selector').forEach(select => {
        const currentValue = select.value;
        const studentId = select.dataset.studentId;
        select.innerHTML = '';
        
        groups.forEach(groupId => {
            const option = document.createElement('option');
            option.value = groupId;
            option.textContent = groupId;
            if (groupId === currentValue) {
                option.selected = true;
            }
            select.appendChild(option);
        });
        
        // Eƒüer √∂ƒürencinin grubu se√ßenekler arasƒ±nda yoksa, varsayƒ±lan grubu se√ß
        if (!groups.includes(currentValue) && groups.length > 0) {
            select.value = groups[0];
            if (studentId) {
                const student = APP_STATE.studentData.find(s => s.studentId === studentId);
                if (student) {
                    student.grup = groups[0];
                }
            }
        }
    });
}

/**
 * √ñƒürenci grup g√ºncelleme (T√ºm sekmelerde senkronize)
 */
function updateStudentGroup(selectElement) {
    const studentId = selectElement.dataset.studentId;
    const groupId = selectElement.value;
    
    console.log(`üîÑ updateStudentGroup √ßaƒürƒ±ldƒ±:`);
    console.log(`  - studentId: ${studentId}`);
    console.log(`  - groupId: ${groupId}`);
    console.log(`  - selectElement:`, selectElement);
    
    // Hangi etkinlik i√ßinde bu grup deƒüi≈üikliƒüi yapƒ±ldƒ±ƒüƒ±nƒ± bul
    const componentId = findComponentIdFromGroupSelector(selectElement);
    console.log(`  - componentId: ${componentId}`);
    
    if (!componentId) {
        console.error("‚ùå Component ID bulunamadƒ±!");
        return;
    }
    
    // √ñƒürenci verilerini g√ºncelle (sadece bu etkinlik i√ßin)
    setStudentGroupForComponent(studentId, groupId, componentId);
    
    // Sadece bu etkinlikteki aynƒ± √∂ƒürencinin diƒüer satƒ±rlarƒ±nƒ± g√ºncelle
    updateComponentGroupSelectors(studentId, groupId, componentId);
    
    // Sadece bu etkinlikteki soru bilgilerini g√ºncelle
    updateQuestionInfoForComponent(studentId, groupId, componentId);
    
    // Toast mesajƒ±
    const student = APP_STATE.studentData.find(s => s.studentId === studentId);
    const studentName = student ? `${student.name} ${student.surname}` : studentId;
    showModernToast(`${studentName} √∂ƒürencisi ${getComponentDisplayName(componentId)} etkinliƒüinde ${groupId} grubuna atandƒ±`, "success");
}

/**
 * Grup bazlƒ± notlarƒ± y√ºkleme
 * @param {string} studentId - √ñƒürenci ID'si
 * @param {string} newGroupId - Yeni grup ID'si
 */
function loadGroupBasedGrades(studentId, newGroupId) {
    console.log(`üîÑ loadGroupBasedGrades √ßaƒürƒ±ldƒ± - √ñƒürenci: ${studentId}, Yeni Grup: ${newGroupId}`);
    
    try {
        // √ñƒürencinin not verilerini kontrol et
        if (!APP_STATE.gradesData || !APP_STATE.gradesData[studentId]) {
            console.log(`‚ö†Ô∏è ${studentId} √∂ƒürencisi i√ßin not verisi bulunamadƒ±`);
            return;
        }
        
        const studentGrades = APP_STATE.gradesData[studentId];
        
        // Grup bazlƒ± notlar kontrol√º
        if (!studentGrades.grupBazliNotlar) {
            console.log(`üìù ${studentId} √∂ƒürencisi i√ßin grup bazlƒ± not yapƒ±sƒ± olu≈üturuluyor`);
            studentGrades.grupBazliNotlar = {};
            return;
        }
        
        const groupGrades = studentGrades.grupBazliNotlar[newGroupId];
        if (!groupGrades) {
            console.log(`üìù ${studentId} √∂ƒürencisi i√ßin ${newGroupId} grubunda hen√ºz not girilmemi≈ü`);
            return;
        }
        
        console.log(`üìã ${studentId} √∂ƒürencisi i√ßin ${newGroupId} grubundaki notlar y√ºkleniyor:`, groupGrades);
        
        // Grup bazlƒ± notlarƒ± input alanlarƒ±na y√ºkle
        Object.keys(groupGrades).forEach(activityId => {
            const grade = groupGrades[activityId];
            
            // Input alanƒ±nƒ± bul ve deƒüeri y√ºkle
            const assessmentInput = document.querySelector(`input[data-student-id="${studentId}"][data-activity-id="${activityId}"]`);
            if (assessmentInput) {
                assessmentInput.value = grade;
                assessmentInput.style.borderColor = "";
                
                // Maksimum puan kontrol√º
                const maxPoints = parseFloat(assessmentInput.max) || 100;
                if (grade > maxPoints) {
                    assessmentInput.style.borderColor = "#ff6b6b";
                    assessmentInput.title = `Bu √∂ƒürencinin grubundaki bu sorunun maksimum puanƒ±: ${maxPoints} (Mevcut deƒüer ${grade} maksimumdan b√ºy√ºk!)`;
                }
                
                console.log(`  ‚úÖ ${activityId}: ${grade} puan y√ºklendi`);
            } else {
                console.log(`  ‚ö†Ô∏è ${activityId} i√ßin input alanƒ± bulunamadƒ±`);
            }
            
            // Ana not verisini g√ºncelle
            APP_STATE.gradesData[studentId][activityId] = grade;
        });
        
        // Hesaplanmƒ±≈ü notlarƒ± g√ºncelle
        updateStudentCalculatedGrade(studentId);
        updateAssessmentGradeSummary(studentId);
        updateStudentSummary(studentId);
        
        console.log(`‚úÖ ${studentId} √∂ƒürencisi i√ßin ${newGroupId} grubundaki notlar ba≈üarƒ±yla y√ºklendi`);
        
    } catch (error) {
        console.error("Grup bazlƒ± notlar y√ºklenirken hata olu≈ütu:", error);
    }
}

/**
 * Grup se√ßicisinden hangi etkinlik i√ßinde olduƒüunu bul
 */
function findComponentIdFromGroupSelector(selectElement) {
    // √úst elementlerde component ID'si arayalƒ±m
    let currentElement = selectElement;
    
    while (currentElement && currentElement !== document.body) {
        // TR elementinde data-component-id var mƒ±?
        if (currentElement.dataset && currentElement.dataset.componentId) {
            return currentElement.dataset.componentId;
        }
        
        // Assessment subsection i√ßinde mi?
        if (currentElement.classList && currentElement.classList.contains('assessment-subsection')) {
            // Ba≈ülƒ±k elementini bul ve component ID'sini √ßƒ±kar
            const header = currentElement.querySelector('h5');
            if (header && header.textContent) {
                // "Ara Sƒ±nav" gibi ba≈ülƒ±ktan component ID'sini bulmaya √ßalƒ±≈ü
                const allActivities = [...(APP_STATE.courseData?.ara || []), ...(APP_STATE.courseData?.final || [])];
                const activity = allActivities.find(act => act.name === header.textContent.trim());
                if (activity) {
                    return activity.id;
                }
            }
        }
        
        currentElement = currentElement.parentElement;
    }
    
    console.warn("Component ID bulunamadƒ±, selectElement'in parent elementleri kontrol ediliyor...");
    return null;
}

/**
 * Bile≈üen i√ßin grup se√ßenekleri olu≈üturma
 * @param {string} studentId - √ñƒürenci ID'si
 * @param {string} componentId - Bile≈üen ID'si
 * @returns {string} - HTML option elemanlarƒ±
 */
function createGroupOptions(studentId, componentId) {
    // Bu bile≈üenin gruplarƒ±nƒ± al
    const component = APP_STATE.courseData?.grupHaritalari?.[componentId];
    const groups = component?.gruplar || ['A'];
    
    // √ñƒürencinin bu bile≈üendeki mevcut grubunu al
    const studentCurrentGroup = getStudentGroupForComponent(studentId, componentId);
    
    // Grup se√ßeneklerini olu≈ütur
    return groups.map(groupId => 
        `<option value="${groupId}" ${studentCurrentGroup === groupId ? 'selected' : ''}>${groupId}</option>`
    ).join('');
}

/**
 * √ñƒürenci bazlƒ± not giri≈üindeki ana grup se√ßici i√ßin - t√ºm bile≈üenler i√ßin grup g√ºnceller
 */
function updateStudentGroupForAllComponents(selectElement) {
    const studentId = selectElement.dataset.studentId;
    const groupId = selectElement.value;
    
    console.log(`üîÑ updateStudentGroupForAllComponents √ßaƒürƒ±ldƒ±:`);
    console.log(`  - studentId: ${studentId}`);
    console.log(`  - groupId: ${groupId}`);
    
    // √ñƒürencinin genel grubunu g√ºncelle
    const student = APP_STATE.studentData.find(s => s.studentId === studentId);
    if (student) {
        student.grup = groupId;
    }
    
    // T√ºm bile≈üenler i√ßin grup g√ºncelle
    if (APP_STATE.courseData?.grupHaritalari) {
        Object.keys(APP_STATE.courseData.grupHaritalari).forEach(componentId => {
            setStudentGroupForComponent(studentId, groupId, componentId);
        });
    }
    
    // √ñƒürenci g√∂r√ºn√ºm√ºn√º yeniden olu≈ütur
    showStudentGrades(studentId);
    
    // Toast mesajƒ±
    const studentName = student ? `${student.name} ${student.surname}` : studentId;
    showModernToast(`${studentName} √∂ƒürencisi t√ºm bile≈üenlerde ${groupId} grubuna atandƒ±`, "success");
}

/**
 * DOM event i√ßin wrapper fonksiyon
 */
function updateStudentGroupForComponent(selectElement) {
    const studentId = selectElement.dataset.studentId;
    const groupId = selectElement.value;
    const componentId = selectElement.dataset.componentId;
    
    console.log(`üîÑ updateStudentGroupForComponent (DOM wrapper) √ßaƒürƒ±ldƒ±:`);
    console.log(`  - studentId: ${studentId}`);
    console.log(`  - groupId: ${groupId}`);
    console.log(`  - componentId: ${componentId}`);
    
    if (!componentId) {
        console.error("‚ùå Component ID bulunamadƒ±!");
        return;
    }
    
    // √ñƒürenci verilerini g√ºncelle (sadece bu etkinlik i√ßin)
    setStudentGroupForComponent(studentId, groupId, componentId);
    
    // SENKRONIZASYON: T√ºm sistemi g√ºncelle
    synchronizeStudentGroupChanges(studentId, groupId, componentId);
    
    // Toast mesajƒ±
    const student = APP_STATE.studentData.find(s => s.studentId === studentId);
    const studentName = student ? `${student.name} ${student.surname}` : studentId;
    showModernToast(`${studentName} √∂ƒürencisi ${getComponentDisplayName(componentId)} etkinliƒüinde ${groupId} grubuna atandƒ± - T√ºm sistem senkronize edildi`, "success");
}

/**
 * √ñƒürenci grup deƒüi≈üikliƒüini t√ºm sisteme senkronize et
 */
function synchronizeStudentGroupChanges(studentId, groupId, componentId) {
    console.log(`üîÑ synchronizeStudentGroupChanges ba≈ülatƒ±ldƒ±:`);
    console.log(`  - studentId: ${studentId}`);
    console.log(`  - groupId: ${groupId}`);
    console.log(`  - componentId: ${componentId}`);
    
    // 1. Bu etkinlikteki aynƒ± √∂ƒürencinin diƒüer satƒ±rlarƒ±nƒ± g√ºncelle
    updateComponentGroupSelectors(studentId, groupId, componentId);
    
    // 2. Bu etkinlikteki soru bilgilerini g√ºncelle
    updateQuestionInfoForComponent(studentId, groupId, componentId);
    
    // 3. Deƒüerlendirme tablosundaki genel soru puanlarƒ±nƒ± g√ºncelle
    updateQuestionPointsInAssessmentTable(studentId);
    
    // 4. √ñƒürenci Listesi sekmesindeki grup bilgilerini g√ºncelle
    updateStudentListGroupInfo();
    
    // 5. T√ºm sekmelerdeki grup se√ßicilerini g√ºncelle
    updateAllTabGroupSelectors(studentId, groupId, componentId);
    
    // 6. Grup bazlƒ± not y√ºkleme
    loadGroupBasedGrades(studentId, groupId);
    
    // 7. Notlar sekmesini g√ºncelle (eƒüer a√ßƒ±ksa)
    if (document.querySelector('#grades-content.active')) {
        updateGradesView();
    }
    
    // 8. Deƒüerlendirme g√∂r√ºn√ºm√ºn√º yenile (grup deƒüi≈üikliƒüi sonrasƒ±)
    setTimeout(() => {
        refreshAssessmentViewForStudent(studentId, componentId);
    }, 100);
    
    console.log(`‚úÖ Sistem senkronizasyonu tamamlandƒ±`);
}

/**
 * √ñƒürenci Listesi sekmesindeki grup bilgilerini g√ºncelle
 */
function updateStudentListGroupInfo() {
    console.log(`üìã √ñƒürenci Listesi grup bilgileri g√ºncelleniyor...`);
    
    // √ñƒürenci grup bilgileri kartƒ±nƒ± g√ºncelle
    const groupInfoCard = document.getElementById('studentGroupInfoCard');
    const groupInfoContainer = document.getElementById('studentGroupInfoContainer');
    
    if (!groupInfoCard || !groupInfoContainer) {
        console.log(`‚ö†Ô∏è √ñƒürenci grup bilgi bile≈üenleri bulunamadƒ±`);
        return;
    }
    
    // Grup bilgilerini yeniden olu≈ütur
    const hasGroupData = APP_STATE.studentComponentGroups && Object.keys(APP_STATE.studentComponentGroups).length > 0;
    
    if (!hasGroupData) {
        groupInfoCard.style.display = 'none';
        return;
    }
    
    groupInfoCard.style.display = 'block';
    
    // Grup bilgilerini d√ºzenle
    let groupInfoHTML = '';
    const students = APP_STATE.studentData || [];
    const components = getAllComponents();
    
    if (students.length === 0 || components.length === 0) {
        groupInfoHTML = '<p class="empty-message">√ñƒürenci veya etkinlik verisi bulunmuyor.</p>';
    } else {
        // Etkinlik bazƒ±nda grup bilgilerini g√∂ster
        components.forEach(component => {
            const componentGroups = {};
            
            students.forEach(student => {
                const studentGroup = getStudentGroupForComponent(student.studentId, component.id);
                if (studentGroup && studentGroup !== 'A') { // Varsayƒ±lan A grubunu g√∂sterme
                    if (!componentGroups[studentGroup]) {
                        componentGroups[studentGroup] = [];
                    }
                    componentGroups[studentGroup].push(student);
                }
            });
            
            if (Object.keys(componentGroups).length > 0) {
                groupInfoHTML += `
                    <div class="component-group-info">
                        <h4 class="component-title">${getComponentDisplayName(component.id)}</h4>
                        <div class="groups-container">
                `;
                
                Object.keys(componentGroups).sort().forEach(groupId => {
                    const groupStudents = componentGroups[groupId];
                    groupInfoHTML += `
                        <div class="group-info">
                            <div class="group-header">
                                <span class="group-badge">${groupId} Grubu</span>
                                <span class="student-count">${groupStudents.length} √∂ƒürenci</span>
                            </div>
                            <div class="group-students">
                                ${groupStudents.map(student => 
                                    `<span class="student-tag">${student.studentId} - ${student.name} ${student.surname}</span>`
                                ).join('')}
                            </div>
                        </div>
                    `;
                });
                
                groupInfoHTML += `
                        </div>
                    </div>
                `;
            }
        });
        
        if (!groupInfoHTML) {
            groupInfoHTML = '<p class="empty-message">Hen√ºz grup atamasƒ± yapƒ±lmamƒ±≈ü.</p>';
        }
    }
    
    groupInfoContainer.innerHTML = groupInfoHTML;
    console.log(`‚úÖ √ñƒürenci Listesi grup bilgileri g√ºncellendi`);
}

/**
 * T√ºm sekmelerdeki grup se√ßicilerini g√ºncelle
 */
function updateAllTabGroupSelectors(studentId, groupId, componentId) {
    console.log(`üîÑ T√ºm sekmelerdeki grup se√ßicileri g√ºncelleniyor...`);
    
    // Deƒüerlendirme Giri≈üi sekmesindeki grup se√ßicilerini g√ºncelle
    const assessmentSelectors = document.querySelectorAll(`#assessment-content select[data-student-id="${studentId}"][data-component-id="${componentId}"]`);
    assessmentSelectors.forEach(selector => {
        if (selector.value !== groupId) {
            selector.value = groupId;
            console.log(`‚úÖ Assessment sekmesi grup se√ßicisi g√ºncellendi: ${groupId}`);
        }
    });
    
    // Diƒüer sekmelerdeki benzer se√ßicileri de g√ºncelle (gelecekte eklenebilir)
    console.log(`‚úÖ T√ºm sekmelerdeki grup se√ßicileri g√ºncellendi`);
}

/**
 * Belirli √∂ƒürenci i√ßin deƒüerlendirme g√∂r√ºn√ºm√ºn√º yenile
 */
function refreshAssessmentViewForStudent(studentId, componentId) {
    console.log(`üîÑ √ñƒürenci ${studentId} i√ßin deƒüerlendirme g√∂r√ºn√ºm√º yenileniyor...`);
    
    // Sadece bu √∂ƒürencinin satƒ±rlarƒ±nƒ± yenile
    const studentRows = document.querySelectorAll(`#assessment-content tr[data-student-id="${studentId}"][data-component-id="${componentId}"]`);
    
    studentRows.forEach(row => {
        // Grup se√ßicisini kontrol et
        const groupSelector = row.querySelector('select[data-student-id]');
        if (groupSelector) {
            const currentGroup = getStudentGroupForComponent(studentId, componentId);
            if (groupSelector.value !== currentGroup) {
                groupSelector.value = currentGroup;
            }
        }
        
        // Soru bilgilerini g√ºncelle
        const paperOrder = row.dataset.paperOrder;
        if (paperOrder) {
            const questionId = getQuestionIdByPaperOrder(studentId, parseInt(paperOrder), componentId);
            const question = findNodeById(questionId);
            
            // Puan bilgisini g√ºncelle
            const pointsCell = row.querySelector('.question-points-cell');
            if (pointsCell && question) {
                pointsCell.textContent = question.points;
                pointsCell.dataset.activityId = questionId;
            }
            
            // Input alanƒ±nƒ± g√ºncelle
            const input = row.querySelector('input[data-student-id]');
            if (input && question) {
                
                input.placeholder = `0-${question.points}`;
                input.dataset.activityId = questionId;
                
                // Max puan bilgisini g√ºncelle
                let maxInfoSpan = input.parentElement.querySelector('.max-points-info');
                if (maxInfoSpan) {
                    maxInfoSpan.textContent = `(max: ${question.points})`;
                }
            }
        }
    });
    
    console.log(`‚úÖ √ñƒürenci ${studentId} deƒüerlendirme g√∂r√ºn√ºm√º yenilendi`);
}

/**
 * T√ºm bile≈üenleri (etkinlikleri) al
 */
function getAllComponents() {
    const components = [];
    
    if (!APP_STATE.courseData || !APP_STATE.courseData.children) {
        return components;
    }
    
    function collectComponents(nodes) {
        nodes.forEach(node => {
            if (node.type === 'activity') {
                components.push(node);
            }
            if (node.children && node.children.length > 0) {
                collectComponents(node.children);
            }
        });
    }
    
    collectComponents(APP_STATE.courseData.children);
    return components;
}

/**
 * Notlar sekmesini g√ºncelle
 */
function updateGradesView() {
    console.log(`üìä Notlar sekmesi g√ºncelleniyor...`);
    
    // Notlarƒ± yeniden hesapla
    if (typeof calculateGrades === 'function') {
        calculateGrades();
    }
    
    console.log(`‚úÖ Notlar sekmesi g√ºncellendi`);
}

/**
 * Belirli bir etkinlik i√ßin √∂ƒürenci grubunu g√ºncelle (veri i≈üleme)
 */
function setStudentGroupForComponent(studentId, groupId, componentId) {
    // Etkinlik bazlƒ± grup verilerini sakla
    if (!APP_STATE.studentComponentGroups) {
        APP_STATE.studentComponentGroups = {};
    }
    
    if (!APP_STATE.studentComponentGroups[studentId]) {
        APP_STATE.studentComponentGroups[studentId] = {};
    }
    
    APP_STATE.studentComponentGroups[studentId][componentId] = groupId;
    
    // v5 formatƒ±ndaki grup bilgilerini de g√ºncelle (en y√ºksek √∂ncelikli)
    if (!APP_STATE.gradesData) {
        APP_STATE.gradesData = {};
    }
    
    if (!APP_STATE.gradesData[studentId]) {
        APP_STATE.gradesData[studentId] = {};
    }
    
    if (!APP_STATE.gradesData[studentId].grupBilgileri) {
        APP_STATE.gradesData[studentId].grupBilgileri = {};
    }
    
    APP_STATE.gradesData[studentId].grupBilgileri[componentId] = groupId;
    
    // EKLEME: courseData i√ßindeki ogrenciNotlari yapƒ±sƒ±nƒ± da g√ºncelle (v5 format i√ßin kritik!)
    if (APP_STATE.courseData && APP_STATE.courseData.ogrenciNotlari && APP_STATE.courseData.ogrenciNotlari[studentId]) {
        if (!APP_STATE.courseData.ogrenciNotlari[studentId].grupBilgileri) {
            APP_STATE.courseData.ogrenciNotlari[studentId].grupBilgileri = {};
        }
        APP_STATE.courseData.ogrenciNotlari[studentId].grupBilgileri[componentId] = groupId;
        console.log(`üìù courseData v5 formatƒ±nda grup bilgisi g√ºncellendi: ${studentId} -> ${componentId} -> ${groupId}`);
    }
    
    console.log(`üìù √ñƒürenci ${studentId} i√ßin ${componentId} etkinliƒüinde grup ${groupId} olarak g√ºncellendi`);
    console.log(`  - G√ºncel componentGroups:`, APP_STATE.studentComponentGroups[studentId]);
    console.log(`  - G√ºncel v5 grupBilgileri:`, APP_STATE.gradesData[studentId].grupBilgileri);
}

/**
 * Belirli bir etkinlikteki grup se√ßicilerini g√ºncelle
 */
function updateComponentGroupSelectors(studentId, groupId, componentId) {
    // Sadece deƒüerlendirme giri≈üindeki grup se√ßicilerini bul (√∂ƒürenci bazlƒ± not giri≈üi kaldƒ±rƒ±ldƒ±)
    const assessmentRows = document.querySelectorAll(`#assessment-content tr[data-student-id="${studentId}"][data-component-id="${componentId}"]`);
    const componentRows = [...assessmentRows];
    
    console.log(`üîÑ ${componentId} etkinliƒüinde ${studentId} √∂ƒürencisi i√ßin ${componentRows.length} satƒ±r bulundu (Assessment: ${assessmentRows.length})`);
    
    componentRows.forEach((row, index) => {
        const groupSelector = row.querySelector(`select[data-student-id="${studentId}"]`);
        if (groupSelector && groupSelector.value !== groupId) {
            console.log(`  - Satƒ±r ${index + 1} grup se√ßicisi g√ºncellendi: ${groupSelector.value} ‚Üí ${groupId}`);
            groupSelector.value = groupId;
        }
    });
}

/**
 * Belirli bir etkinlik i√ßin soru bilgilerini g√ºncelle
 */
function updateQuestionInfoForComponent(studentId, groupId, componentId) {
    console.log(`üîÑ updateQuestionInfoForComponent √ßaƒürƒ±ldƒ±:`);
    console.log(`  - studentId: ${studentId}`);
    console.log(`  - groupId: ${groupId}`);
    console.log(`  - componentId: ${componentId}`);
    
    // Sadece deƒüerlendirme giri≈üindeki satƒ±rlarƒ± bul (√∂ƒürenci bazlƒ± not giri≈üi kaldƒ±rƒ±ldƒ±)
    const assessmentRows = document.querySelectorAll(`#assessment-content tr[data-student-id="${studentId}"][data-component-id="${componentId}"]`);
    const componentRows = [...assessmentRows];
    console.log(`üìã ${componentId} etkinliƒüinde ${studentId} i√ßin ${componentRows.length} satƒ±r bulundu (Assessment: ${assessmentRows.length})`);
    
    if (componentRows.length === 0) {
        console.debug(`üîç ${studentId} √∂ƒürencisi i√ßin ${componentId} etkinliƒüinde hi√ß satƒ±r bulunamadƒ± (filtre nedeniyle normal)`);
        return;
    }
    
    componentRows.forEach((row, index) => {
        const paperOrder = row.dataset.paperOrder;
        
        console.log(`üìù Satƒ±r ${index + 1} (paperOrder: ${paperOrder}):`);
        
        if (paperOrder) {
            // Kaƒüƒ±t sƒ±rasƒ±ndan ger√ßek soru ID'sini al (yeni grupla)
            const questionId = getQuestionIdByPaperOrder(studentId, parseInt(paperOrder), componentId);
            const answerKeyOrder = getAnswerKeyOrder(studentId, parseInt(paperOrder), componentId);
            const outcomes = getQuestionOutcomesForStudent(studentId, questionId, componentId);
            
            console.log(`üîç Hesaplanan deƒüerler:`);
            console.log(`  - questionId: ${questionId}`);
            console.log(`  - answerKeyOrder: ${answerKeyOrder}`);
            console.log(`  - outcomes:`, outcomes);
            
            // Etkinlik max puanƒ±nƒ± g√ºncelle
            const pointsCell = row.querySelector('.question-points-cell');
            if (pointsCell && questionId) {
                // Points cell'in data-activity-id deƒüerini g√ºncelle
                if (pointsCell.dataset.activityId !== questionId) {
                    console.log(`üîÑ Points cell data-activity-id g√ºncellendi: ${pointsCell.dataset.activityId} ‚Üí ${questionId}`);
                    pointsCell.dataset.activityId = questionId;
                }
                
                // Sorunun ID'si bulunduysa, doƒürudan o sorunun puanƒ±nƒ± al
                const question = findNodeById(questionId);
                const newPoints = question ? question.points : 0;
                console.log(`  - Soru bulundu: ${!!question}, Yeni puan: ${newPoints}`);
                pointsCell.textContent = newPoints;
                
                // Input alanƒ±nƒ±n max deƒüerini g√ºncelle
                const input = row.querySelector(`input[data-student-id="${studentId}"]`);
                if (input) {
                    // Input'un data-activity-id deƒüerini g√ºncelle (grup deƒüi≈ütiƒüinde soru ID'si deƒüi≈üebilir)
                    if (questionId && input.dataset.activityId !== questionId) {
                        console.log(`üîÑ Input data-activity-id g√ºncellendi: ${input.dataset.activityId} ‚Üí ${questionId}`);
                        input.dataset.activityId = questionId;
                    }
                    
                    
                    input.placeholder = `0-${newPoints}`;
                    
                    // Maksimum puan bilgisini title'da g√∂ster
                    const maxPointsInfo = `üìä Maksimum Puan: ${newPoints}`;
                    input.title = `${maxPointsInfo} - Bu √∂ƒürencinin grubundaki bu sorunun maksimum puanƒ±`;
                    
                    // Input yanƒ±na maksimum puan bilgisi ekle
                    let maxInfoSpan = input.parentElement.querySelector('.max-points-info');
                    if (!maxInfoSpan) {
                        maxInfoSpan = document.createElement('span');
                        maxInfoSpan.className = 'max-points-info';
                        maxInfoSpan.style.cssText = 'font-size: 10px; color: #666; margin-left: 5px; font-weight: bold;';
                        input.parentElement.appendChild(maxInfoSpan);
                    }
                    maxInfoSpan.textContent = `(max: ${newPoints})`;
                    
                    // Eƒüer mevcut deƒüer yeni maksimumdan b√ºy√ºkse, sadece g√∂rsel uyarƒ± ver (deƒüeri deƒüi≈ütirme)
                    const currentValue = parseFloat(input.value);
                    if (currentValue > newPoints) {
                        input.style.borderColor = '#ff6b6b';
                        input.style.backgroundColor = '#fff5f5';
                        input.title += ` (Mevcut deƒüer ${currentValue} maksimumdan b√ºy√ºk!)`;
                        console.log(`‚ö†Ô∏è Uyarƒ±: ${studentId} √∂ƒürencisinin kaƒüƒ±t sƒ±rasƒ± ${paperOrder} sorusu puanƒ± (${currentValue}) maksimumdan (${newPoints}) b√ºy√ºk!`);
                    } else {
                        input.style.borderColor = '';
                        input.style.backgroundColor = '';
                    }
                    
                    // ‚úÖ FIX: GRUP BAZLI NOT Y√úKLEME KALDIRILDI
                    // updateQuestionInfoForComponent sadece UI g√ºncellemesi yapar, puanlarƒ± deƒüi≈ütirmez
                    // Puanlar import sƒ±rasƒ±nda kaƒüƒ±t sƒ±rasƒ±na g√∂re doƒüru ≈üekilde y√ºklenir
                }
            }
            
            // Cevap anahtarƒ± sƒ±rasƒ±nƒ± g√ºncelle
            const answerKeyBadge = row.querySelector('.answer-key-badge');
            if (answerKeyBadge) {
                const oldValue = answerKeyBadge.textContent;
                answerKeyBadge.textContent = answerKeyOrder || '?';
                console.log(`  - Cevap anahtarƒ± sƒ±rasƒ± g√ºncellendi: ${oldValue} ‚Üí ${answerKeyOrder || '?'}`);
            }
            
            // Etkinlik adƒ±nƒ± g√ºncelle - Ger√ßek etkinlik adƒ±nƒ± g√∂ster
            const questionNameBadge = row.querySelector('.question-name-badge');
            if (questionNameBadge) {
                const question = findNodeById(questionId);
                const realQuestionName = question?.name || `Soru ${answerKeyOrder || paperOrder}`;
                const oldName = questionNameBadge.textContent;
                questionNameBadge.textContent = realQuestionName;
                questionNameBadge.title = `${realQuestionName} (Cevap anahtarƒ± sƒ±rasƒ±: ${answerKeyOrder})`;
                console.log(`  - Etkinlik adƒ± g√ºncellendi: "${oldName}" ‚Üí "${realQuestionName}"`);
            }
            
            // Soru a√ßƒ±klamasƒ±nƒ± g√ºncelle
            const questionDescBadge = row.querySelector('.question-desc-badge');
            if (questionDescBadge && questionId) {
                const question = findNodeById(questionId);
                const description = question ? (question.description || question.name || '-') : 'Soru bulunamadƒ±';
                const oldValue = questionDescBadge.textContent;
                questionDescBadge.textContent = description;
                questionDescBadge.title = description;
                console.log(`  - Soru a√ßƒ±klamasƒ± g√ºncellendi: "${oldValue}" ‚Üí "${description}"`);
            }
            
            // √ñ√á deƒüerini g√ºncelle
            const outcomesBadge = row.querySelector('.outcomes-badge');
            if (outcomesBadge) {
                const oldValue = outcomesBadge.textContent;
                if (outcomes && outcomes.length > 0) {
                    outcomesBadge.textContent = outcomes.join(', ');
                    outcomesBadge.title = `√ñƒürenme √áƒ±ktƒ±larƒ±: ${outcomes.join(', ')}`;
                    console.log(`  - √ñ√á g√ºncellendi: "${oldValue}" ‚Üí "${outcomes.join(', ')}"`);
                } else {
                    outcomesBadge.textContent = '';
                    outcomesBadge.title = '√ñƒürenme √ßƒ±ktƒ±sƒ± tanƒ±mlanmamƒ±≈ü';
                    console.log(`  - √ñ√á temizlendi: "${oldValue}" ‚Üí ""`);
                }
            }
            
            // Her satƒ±r i√ßin toplam puanƒ± g√ºncelle
            const totalPointsCell = row.querySelector('.total-points-cell');
            if (totalPointsCell) {
                const totalPoints = getStudentTotalEarnedPointsForComponent(studentId, componentId);
                totalPointsCell.textContent = totalPoints;
                
                // Badge i√ßinde ise badge'i g√ºncelle
                const totalPointsBadge = totalPointsCell.querySelector('.total-points-badge');
                if (totalPointsBadge) {
                    totalPointsBadge.textContent = totalPoints;
                }
                console.log(`  - Toplam puan g√ºncellendi: ${totalPoints}`);
            }
            
            console.log(`‚úÖ Satƒ±r ${index + 1} i≈ülendi`);
        } else {
            // Basit etkinlik (paperOrder yok)
            console.log(`üìù Basit etkinlik satƒ±rƒ± ${index + 1}:`);
            
            // Etkinlik max puanƒ±nƒ± g√ºncelle
            const pointsCell = row.querySelector('.question-points-cell');
            if (pointsCell) {
                const activityId = pointsCell.dataset.activityId;
                if (activityId) {
                    const activity = findNodeById(activityId);
                    const newPoints = activity?.points || 0;
                    console.log(`  - Yeni puan: ${newPoints}`);
                    pointsCell.textContent = newPoints;
                    
                    // Input alanƒ±nƒ±n max deƒüerini g√ºncelle
                    const input = row.querySelector(`input[data-student-id="${studentId}"]`);
                    if (input) {
                        
                        input.placeholder = `0-${newPoints}`;
                        input.title = `Bu aktivitenin maksimum puanƒ±: ${newPoints}`;
                        
                        // Input yanƒ±na maksimum puan bilgisi ekle (basit etkinlik i√ßin)
                        let maxInfoSpan = input.parentElement.querySelector('.max-points-info');
                        if (!maxInfoSpan) {
                            maxInfoSpan = document.createElement('span');
                            maxInfoSpan.className = 'max-points-info';
                            maxInfoSpan.style.cssText = 'font-size: 10px; color: #666; margin-left: 5px; font-weight: bold;';
                            input.parentElement.appendChild(maxInfoSpan);
                        }
                        maxInfoSpan.textContent = `(max: ${newPoints})`;
                    }
                }
            }
            
            // Her satƒ±r i√ßin toplam puanƒ± g√ºncelle
            const totalPointsCell = row.querySelector('.total-points-cell');
            if (totalPointsCell) {
                const totalPoints = getStudentTotalEarnedPointsForComponent(studentId, componentId);
                totalPointsCell.textContent = totalPoints;
                
                // Badge i√ßinde ise badge'i g√ºncelle
                const totalPointsBadge = totalPointsCell.querySelector('.total-points-badge');
                if (totalPointsBadge) {
                    totalPointsBadge.textContent = totalPoints;
                }
                console.log(`  - Toplam puan g√ºncellendi: ${totalPoints}`);
            }
            
            console.log(`‚úÖ Basit etkinlik satƒ±rƒ± ${index + 1} i≈ülendi`);
        }
    });
    
    console.log(`üèÅ updateQuestionInfoForComponent tamamlandƒ±`);
}

/**
 * Deƒüerlendirme giri≈üi sekmesindeki soru bilgilerini g√ºncelleme (puan, a√ßƒ±klama, cevap anahtarƒ± sƒ±rasƒ±, √ñ√á)
 */
function updateQuestionPointsInAssessmentTable(studentId) {
    console.log(`üîÑ updateQuestionPointsInAssessmentTable √ßaƒürƒ±ldƒ± - √ñƒürenci: ${studentId}`);
    
    // Bu √∂ƒürencinin t√ºm kaƒüƒ±t sƒ±rasƒ± satƒ±rlarƒ±nƒ± bul
    const paperOrderRows = document.querySelectorAll(`tr[data-student-id="${studentId}"]`);
    console.log(`üìã Bulunan satƒ±r sayƒ±sƒ±: ${paperOrderRows.length}`);
    
    if (paperOrderRows.length === 0) {
        console.warn(`‚ö†Ô∏è ${studentId} √∂ƒürencisi i√ßin hi√ß satƒ±r bulunamadƒ±!`);
        console.log(`üîç T√ºm tr elementleri:`, document.querySelectorAll('tr[data-student-id]'));
        return;
    }
    
    paperOrderRows.forEach((row, index) => {
        const paperOrder = row.dataset.paperOrder;
        const componentId = row.dataset.componentId;
        
        console.log(`üìù Satƒ±r ${index + 1}:`);
        console.log(`  - paperOrder: ${paperOrder}`);
        console.log(`  - componentId: ${componentId}`);
        console.log(`  - row.dataset:`, row.dataset);
        
        if (paperOrder && componentId) {
            // √ñƒürencinin grubunu al
            const studentGroup = getStudentGroupForComponent(studentId, componentId);
            console.log(`üë• √ñƒürenci grubu: ${studentGroup}`);
            
            // Kaƒüƒ±t sƒ±rasƒ±ndan ger√ßek soru ID'sini al
            const questionId = getQuestionIdByPaperOrder(studentId, parseInt(paperOrder), componentId);
            const answerKeyOrder = getAnswerKeyOrder(studentId, parseInt(paperOrder), componentId);
            const outcomes = getQuestionOutcomesForStudent(studentId, questionId, componentId);
            
            console.log(`üîç Hesaplanan deƒüerler:`);
            console.log(`  - questionId: ${questionId}`);
            console.log(`  - answerKeyOrder: ${answerKeyOrder}`);
            console.log(`  - outcomes:`, outcomes);
            
            // Etkinlik max puanƒ±nƒ± g√ºncelle
            const pointsCell = row.querySelector('.question-points-cell');
            console.log(`üí∞ Points cell bulundu: ${!!pointsCell}`);
            
            if (pointsCell && questionId) {
                // Points cell'in data-activity-id deƒüerini g√ºncelle
                if (pointsCell.dataset.activityId !== questionId) {
                    console.log(`üîÑ Points cell data-activity-id g√ºncellendi: ${pointsCell.dataset.activityId} ‚Üí ${questionId}`);
                    pointsCell.dataset.activityId = questionId;
                }
                
                // Sorunun ID'si bulunduysa, doƒürudan o sorunun puanƒ±nƒ± al
                const question = findNodeById(questionId);
                const newPoints = question ? question.points : 0;
                console.log(`  - Soru bulundu: ${!!question}, Yeni puan: ${newPoints}`);
                pointsCell.textContent = newPoints;
                
                // Input alanƒ±nƒ±n max deƒüerini g√ºncelle
                const input = row.querySelector(`input[data-student-id="${studentId}"]`);
                console.log(`  - Input bulundu: ${!!input}`);
                
                if (input) {
                    // Input'un data-activity-id deƒüerini g√ºncelle (grup deƒüi≈ütiƒüinde soru ID'si deƒüi≈üebilir)
                    if (questionId && input.dataset.activityId !== questionId) {
                        console.log(`üîÑ Input data-activity-id g√ºncellendi: ${input.dataset.activityId} ‚Üí ${questionId}`);
                        input.dataset.activityId = questionId;
                    }
                    
                    
                    input.placeholder = `0-${newPoints}`;
                    input.title = `Bu √∂ƒürencinin grubundaki bu sorunun maksimum puanƒ±: ${newPoints}`;
                    
                    // Input yanƒ±na maksimum puan bilgisi ekle
                    let maxInfoSpan = input.parentElement.querySelector('.max-points-info');
                    if (!maxInfoSpan) {
                        maxInfoSpan = document.createElement('span');
                        maxInfoSpan.className = 'max-points-info';
                        maxInfoSpan.style.cssText = 'font-size: 10px; color: #666; margin-left: 5px; font-weight: bold;';
                        input.parentElement.appendChild(maxInfoSpan);
                    }
                    maxInfoSpan.textContent = `(max: ${newPoints})`;
                    
                    // Eƒüer mevcut deƒüer yeni maksimumdan b√ºy√ºkse, uyarƒ± ver
                    const currentValue = parseFloat(input.value);
                    if (currentValue > newPoints) {
                        input.style.borderColor = '#ff6b6b';
                        input.title += ` (Mevcut deƒüer ${currentValue} maksimumdan b√ºy√ºk!)`;
                        showModernToast(`${studentId} √∂ƒürencisinin kaƒüƒ±t sƒ±rasƒ± ${paperOrder} sorusundaki puanƒ± (${currentValue}) yeni maksimumdan (${newPoints}) b√ºy√ºk!`, "warning");
                    } else {
                        input.style.borderColor = '';
                    }
                }
            }
            
            // Cevap anahtarƒ± sƒ±rasƒ±nƒ± g√ºncelle
            const answerKeyCell = row.querySelector('.answer-key-order-cell');
            const answerKeyBadge = answerKeyCell?.querySelector('.answer-key-badge');
            console.log(`üîë Answer key cell bulundu: ${!!answerKeyCell}, badge bulundu: ${!!answerKeyBadge}`);
            
            if (answerKeyBadge) {
                const oldValue = answerKeyBadge.textContent;
                answerKeyBadge.textContent = answerKeyOrder || '?';
                console.log(`  - Cevap anahtarƒ± sƒ±rasƒ± g√ºncellendi: ${oldValue} ‚Üí ${answerKeyOrder || '?'}`);
            }
            
            // Soru a√ßƒ±klamasƒ±nƒ± g√ºncelle
            const descriptionCell = row.querySelector('.question-description-cell');
            const questionDescBadge = descriptionCell?.querySelector('.question-desc-badge');
            console.log(`üìù Description cell bulundu: ${!!descriptionCell}, badge bulundu: ${!!questionDescBadge}`);
            
            if (questionDescBadge && questionId) {
                const question = findNodeById(questionId);
                const description = question ? question.description : 'Soru bulunamadƒ±';
                const oldValue = questionDescBadge.textContent;
                questionDescBadge.textContent = description;
                questionDescBadge.title = description; // Full text tooltip
                console.log(`  - Soru a√ßƒ±klamasƒ± g√ºncellendi: "${oldValue}" ‚Üí "${description}"`);
            }
            
            // √ñ√á deƒüerini g√ºncelle
            const outcomesCell = row.querySelector('.outcomes-cell');
            const outcomesBadge = outcomesCell?.querySelector('.outcomes-badge');
            console.log(`üéØ Outcomes cell bulundu: ${!!outcomesCell}, badge bulundu: ${!!outcomesBadge}`);
            
            if (outcomesBadge) {
                const oldValue = outcomesBadge.textContent;
                if (outcomes && outcomes.length > 0) {
                    outcomesBadge.textContent = outcomes.join(', ');
                    outcomesBadge.title = `√ñƒürenme √áƒ±ktƒ±larƒ±: ${outcomes.join(', ')}`;
                    console.log(`  - √ñ√á g√ºncellendi: "${oldValue}" ‚Üí "${outcomes.join(', ')}"`);
                } else {
                    outcomesBadge.textContent = '';
                    outcomesBadge.title = '√ñƒürenme √ßƒ±ktƒ±sƒ± tanƒ±mlanmamƒ±≈ü';
                    console.log(`  - √ñ√á temizlendi: "${oldValue}" ‚Üí ""`);
                }
            }
            
            console.log(`‚úÖ Satƒ±r ${index + 1} i≈ülendi`);
        } else {
            console.warn(`‚ö†Ô∏è Satƒ±r ${index + 1} atlandƒ± - paperOrder veya componentId eksik`);
        }
    });
    
    console.log(`üèÅ updateQuestionPointsInAssessmentTable tamamlandƒ±`);
}

/**
 * Soru bilgilerini g√ºncelleme
 */
function updateQuestionInfoDisplay(studentId, groupId) {
    const infoElement = document.getElementById(`questionInfo-${studentId}`);
    if (!infoElement || !groupId) {
        if (infoElement) infoElement.textContent = '';
        return;
    }
    
    // Grup haritalamalarƒ±nƒ± kontrol et
    const mappings = APP_STATE.courseData?.grupHaritalari?.[groupId];
    if (mappings) {
        const info = [];
        // D√úZELTME: Veri yapƒ±sƒ± {position: questionId} formatƒ±nda
        Object.keys(mappings).forEach(position => {
            const questionId = mappings[position];
            info.push(`S${position}‚Üí${questionId}`);
        });
        infoElement.textContent = `(${groupId} grubunda: ${info.join(', ')})`;
    }
}

/**
 * T√ºm haritalama g√∂r√ºnt√ºleri g√ºncelleme
 */
function updateAllMappingDisplays() {
    // √ñƒürenci tablosundaki t√ºm grup bilgilerini g√ºncelle
    APP_STATE.studentData.forEach(student => {
        if (student.grup) {
            updateQuestionInfoDisplay(student.studentId, student.grup);
        }
    });
    
    // Tree'deki haritalama kontrollerini g√ºncelle
    updateTreeMappingControls();
}

/**
 * Tree'deki haritalama kontrollerini g√ºncelleme
 */
function updateTreeMappingControls() {
    // Bu fonksiyon tree render edildiƒüinde √ßaƒürƒ±lacak
    // renderNode fonksiyonunda haritalama kontrolleri eklenecek
}

/**
 * √ñƒürenci grubunu alma (etkinlik bazlƒ±)
 */
function getStudentGroup(studentId, componentId = null) {
    // Eƒüer componentId verilmi≈üse, etkinlik bazlƒ± grup al
    if (componentId && APP_STATE.studentComponentGroups && 
        APP_STATE.studentComponentGroups[studentId] && 
        APP_STATE.studentComponentGroups[studentId][componentId]) {
        return APP_STATE.studentComponentGroups[studentId][componentId];
    }
    
    // Yoksa genel grup bilgisini al
    const student = APP_STATE.studentData.find(s => s.studentId === studentId);
    return student?.grup || 'A'; // Varsayƒ±lan grup A
}

/**
 * Bile≈üen grup sayƒ±sƒ±nƒ± alma
 */
function getComponentGroupCount(componentId) {
    const component = APP_STATE.courseData?.grupHaritalari?.[componentId];
    if (!component || !component.gruplar) {
        return 1; // En azƒ±ndan A grubu var
    }
    return component.gruplar.length;
}

/**
 * Bile≈üenin toplam puanƒ±nƒ± hesaplama (maksimum puan)
 */
function getComponentTotalPoints(componentId) {
    if (!componentId) return 0;
    
    try {
        const component = findNodeById(componentId);
        if (!component) return 0;
        
        // Eƒüer direkt points varsa kullan
        if (component.points) {
            return component.points;
        }
        
        // Alt √∂ƒüelerin toplam puanƒ±nƒ± hesapla
        let totalPoints = 0;
        if (component.children && Array.isArray(component.children)) {
            component.children.forEach(child => {
                if (child.points) {
                    totalPoints += child.points;
                } else if (child.children) {
                    totalPoints += getComponentTotalPoints(child.id);
                }
            });
        }
        
        return totalPoints;
    } catch (error) {
        console.error(`getComponentTotalPoints hatasƒ± (${componentId}):`, error);
        return 0;
    }
}

/**
 * √ñƒürencinin belirli bir etkinlikten aldƒ±ƒüƒ± toplam puanƒ± hesaplama (grup bazlƒ±)
 */
function getStudentTotalEarnedPointsForComponent(studentId, componentId) {
    if (!studentId || !componentId) return 0;
    
    try {
        const component = findNodeById(componentId);
        if (!component) return 0;
        
        let totalEarnedPoints = 0;
        
        // Eƒüer basit etkinlik ise (alt √∂ƒüe yok)
        if (!component.children || component.children.length === 0) {
            const grade = getStudentGrade(studentId, componentId) || 0;
            return grade;
        }
        
        // Alt √∂ƒüelerin aldƒ±ƒüƒ± puanlarƒ± topla
        component.children.forEach(child => {
            if (child.children && child.children.length > 0) {
                // Alt √∂ƒüenin de √ßocuklarƒ± varsa recursive √ßaƒüƒ±r
                totalEarnedPoints += getStudentTotalEarnedPointsForComponent(studentId, child.id);
            } else {
                // Basit alt √∂ƒüe - √∂ƒürencinin aldƒ±ƒüƒ± puanƒ± al
                const grade = getStudentGrade(studentId, child.id) || 0;
                totalEarnedPoints += grade;
            }
        });
        
        return parseFloat(totalEarnedPoints.toFixed(2));
    } catch (error) {
        console.error(`getStudentTotalEarnedPointsForComponent hatasƒ± (${studentId}, ${componentId}):`, error);
        return 0;
    }
}

/**
 * √ñƒürencinin grubuna g√∂re bile≈üen maksimum puanƒ±nƒ± hesaplama
 */
function getStudentTotalMaxPointsForComponent(studentId, componentId) {
    if (!studentId || !componentId) return 0;
    
    try {
        const component = findNodeById(componentId);
        if (!component) return 0;
        
        let totalMaxPoints = 0;
        
        // Eƒüer basit etkinlik ise (alt √∂ƒüe yok)
        if (!component.children || component.children.length === 0) {
            return component.points || 0;
        }
        
        // Alt √∂ƒüelerin maksimum puanlarƒ±nƒ± topla (grup bazlƒ±)
        component.children.forEach(child => {
            if (child.children && child.children.length > 0) {
                // Alt √∂ƒüenin de √ßocuklarƒ± varsa recursive √ßaƒüƒ±r
                totalMaxPoints += getStudentTotalMaxPointsForComponent(studentId, child.id);
            } else {
                // Basit alt √∂ƒüe - √∂ƒürencinin grubuna g√∂re maksimum puanƒ± al
                const maxPoints = getQuestionPointsForStudentGroup(studentId, child.id, componentId);
                totalMaxPoints += maxPoints;
            }
        });
        
        return parseFloat(totalMaxPoints.toFixed(2));
    } catch (error) {
        console.error(`getStudentTotalMaxPointsForComponent hatasƒ± (${studentId}, ${componentId}):`, error);
        return 0;
    }
}

/**
 * Aktivitenin baƒülƒ± olduƒüu √ºst bile≈üeni bulma
 */
function getParentComponentId(activityId) {
    // A1.1 -> A1, F2.3 -> F2 gibi
    const parts = activityId.split('.');
    if (parts.length > 1) {
        return parts[0];
    }
    return activityId;
}

/**
 * √ñƒürencinin toplam puanlarƒ±nƒ± g√ºncelleme
 */
function updateTotalPointsForStudent(studentId, activityId) {
    try {
        // Aktivitenin baƒülƒ± olduƒüu bile≈üeni bul
        const componentId = getParentComponentId(activityId) || activityId;
        
        // Bu √∂ƒürencinin bu bile≈üenle ilgili t√ºm satƒ±rlarƒ±nƒ± bul
        const relatedRows = document.querySelectorAll(`tr[data-student-id="${studentId}"][data-component-id="${componentId}"], tr[data-student-id="${studentId}"] .total-points-cell[data-student-id="${studentId}"][data-activity-id="${activityId}"]`);
        
        relatedRows.forEach(row => {
            const totalPointsCell = row.querySelector('.total-points-cell');
            if (totalPointsCell) {
                const totalPoints = getStudentTotalEarnedPointsForComponent(studentId, componentId);
                totalPointsCell.textContent = totalPoints;
                
                // Badge i√ßinde ise badge'i g√ºncelle
                const totalPointsBadge = totalPointsCell.querySelector('.total-points-badge');
                if (totalPointsBadge) {
                    totalPointsBadge.textContent = totalPoints;
                }
            }
        });
        
        // √ñƒürenci bazlƒ± not giri≈üi sekmesindeki badge'leri de g√ºncelle
        const studentGradesBadges = document.querySelectorAll(`#studentGradesContainer .total-points-badge`);
        studentGradesBadges.forEach(badge => {
            const componentElement = badge.closest('[data-component-id]');
            if (componentElement && componentElement.dataset.componentId === componentId) {
                const totalPoints = getStudentTotalEarnedPointsForComponent(studentId, componentId);
                badge.textContent = totalPoints;
            }
        });
        
        console.log(`üîÑ Toplam puanlar g√ºncellendi - √ñƒürenci: ${studentId}, Bile≈üen: ${componentId}`);
        
    } catch (error) {
        console.error(`updateTotalPointsForStudent hatasƒ±:`, error);
    }
}

/**
 * Bile≈üendeki soru sayƒ±sƒ±nƒ± hesaplama
 */
function countQuestionsInComponent(componentId) {
    const node = findNodeById(componentId);
    if (!node || !node.children) {
        return 0;
    }
    
    let questionCount = 0;
    node.children.forEach(child => {
        if (isQuestionType(child.type) || isRubricType(child.type)) {
            questionCount++;
        }
    });
    
    return questionCount;
}

/**
 * T√ºm bile≈üenlerin grup sayƒ±sƒ±nƒ± g√ºncelleme
 */
function updateComponentGroupCounts() {
    document.querySelectorAll('.component-group-info').forEach(element => {
        const componentId = element.dataset.componentId;
        if (componentId) {
            const groupCount = getComponentGroupCount(componentId);
            const countElement = element.querySelector('.group-count');
            if (countElement) {
                countElement.textContent = `${groupCount} grup`;
            }
        }
    });
}

/**
 * Grup haritalama modal'ƒ±nƒ± g√∂sterme
 */
function showGroupMappingModal(activityId) {
    const activity = findNodeById(activityId);
    if (!activity) return;
    
    APP_STATE.currentMappingNode = activity;
    mappingActivityName.textContent = activity.name;
    
    // Soru sayƒ±sƒ± bilgisini g√∂ster
    let parentNode;
    if (activity && activity.id.includes('.')) {
        const parentId = activity.id.substring(0, activity.id.lastIndexOf('.'));
        parentNode = findNodeById(parentId);
    }
    
    const relatedQuestions = parentNode && parentNode.children ? parentNode.children.length : 1;
    const infoElement = document.querySelector('#groupMappingModal .info-message p');
    if (infoElement) {
        infoElement.textContent = `Bu sorunun hangi gruplarda hangi sƒ±rada yer alacaƒüƒ±nƒ± belirleyin (Toplam ${relatedQuestions} soru):`;
    }
    
    // Mevcut haritalamlarƒ± g√∂ster
    renderMappingRows(activityId);
    
    // Hƒ±zlƒ± giri≈ü alanƒ±nƒ± da g√ºncelle
    updateBulkInputFromModalRows();
    
    // Hata mesajlarƒ±nƒ± temizle
    const errorContainer = document.getElementById('bulkErrorMessages');
    if (errorContainer) {
        errorContainer.innerHTML = '';
    }
    
    // Modal'ƒ± g√∂ster
    openModernModal('groupMappingModal');
}

/**
 * Haritalama satƒ±rlarƒ±nƒ± render etme
 */
function renderMappingRows(activityId) {
    const mappingContainer = document.getElementById('mappingContainer');
    if (!mappingContainer) return;
    
    mappingContainer.innerHTML = '';
    
    // Bu sorunun hangi bile≈üene ait olduƒüunu bul
    const parentComponentId = getParentComponentId(activityId);
    if (!parentComponentId) {
        mappingContainer.innerHTML = '<p class="error-message">Soru i√ßin bile≈üen bulunamadƒ±</p>';
        return;
    }
    
    const component = APP_STATE.courseData?.grupHaritalari?.[parentComponentId];
    if (!component) {
        mappingContainer.innerHTML = '<p class="error-message">Bile≈üen grup verisi bulunamadƒ±</p>';
        return;
    }
    
    const groups = component.gruplar || ['A'];
    const activity = findNodeById(activityId);
    
    // Sadece bu aktivitenin √ºst d√ºƒü√ºm√ºndeki sorularƒ± al
    let parentNode;
    if (activity && activity.id.includes('.')) {
        const parentId = activity.id.substring(0, activity.id.lastIndexOf('.'));
        parentNode = findNodeById(parentId);
    }
    
    const relatedQuestions = parentNode && parentNode.children ? parentNode.children.length : 1;
    const maxPosition = relatedQuestions;
    
    groups.forEach(groupName => {
        // D√úZELTME: Veri yapƒ±sƒ± {position: questionId} formatƒ±nda
        const groupMappings = component.haritalar?.[groupName];
        const currentPosition = groupMappings ? Object.keys(groupMappings).find(pos => groupMappings[pos] === activityId) : null;
        
        const row = document.createElement('div');
        row.className = 'mapping-row-modal';
        row.innerHTML = `
            <select class="group-select" data-group="${groupName}">
                ${groups.map(g => `<option value="${g}" ${g === groupName ? 'selected' : ''}>Grup ${g}</option>`).join('')}
            </select>
            <select class="position-select" data-group="${groupName}">
                <option value="">Sƒ±ra Se√ß</option>
                ${Array.from({length: maxPosition}, (_, i) => {
                    const pos = i + 1;
                    const selected = currentPosition && currentPosition === pos.toString() ? 'selected' : '';
                    return `<option value="${pos}" ${selected}>${pos}. Soru</option>`;
                }).join('')}
            </select>
            <button class="remove-mapping-btn" onclick="removeMappingRow(this, '${groupName}', '${activityId}')">√ó</button>
        `;
        
        // Event listener'lar ekle - sadece g√∂rsel g√ºncelleme i√ßin
        const groupSelect = row.querySelector('.group-select');
        const positionSelect = row.querySelector('.position-select');
        
        // Sadece hƒ±zlƒ± giri≈ü alanƒ±nƒ± g√ºncelle, veriyi kaydetme
        groupSelect.addEventListener('change', () => {
            updateBulkInputFromModalRows();
        });
        
        positionSelect.addEventListener('change', () => {
            updateBulkInputFromModalRows();
        });
        
        mappingContainer.appendChild(row);
    });
}

/**
 * Haritalama satƒ±rƒ± kaldƒ±rma (sadece modal'dan, veri kaydedilmez)
 */
function removeMappingRow(button, groupName, activityId) {
    // Sadece satƒ±rƒ± kaldƒ±r, veriyi kaydetme
    button.closest('.mapping-row-modal').remove();
    
    // Hƒ±zlƒ± giri≈ü alanƒ±nƒ± g√ºncelle
    updateBulkInputFromModalRows();
    
    showModernToast(`${groupName} grubundan haritalama kaldƒ±rƒ±ldƒ± (ge√ßici)`, "info");
}

/**
 * Haritalama kaydetme
 */
function saveGroupMapping() {
    if (!APP_STATE.currentMappingNode) return;
    
    const activityId = APP_STATE.currentMappingNode.id;
    const mappingContainer = document.getElementById('mappingContainer');
    
    // Validation: Duplicate ve hata kontrol√º
    const newMappings = new Map(); // groupId -> position
    const usedPositions = new Map(); // groupId -> Set<position>
    let hasErrors = false;
    const errors = [];
    
    // T√ºm grup se√ßicilerini kontrol et ve yeni haritalamayƒ± topla
    mappingContainer.querySelectorAll('.mapping-row-modal').forEach(row => {
        const groupSelect = row.querySelector('.group-select');
        const positionSelect = row.querySelector('.position-select');
        
        const groupId = groupSelect.value;
        const position = parseInt(positionSelect.value);
        
        if (groupId && position) {
            // Aynƒ± grup i√ßin duplicate position kontrol√º
            if (!usedPositions.has(groupId)) {
                usedPositions.set(groupId, new Set());
            }
            
            if (usedPositions.get(groupId).has(position)) {
                hasErrors = true;
                errors.push(`Grup ${groupId}'da ${position}. sƒ±ra birden fazla kez atanmƒ±≈ü`);
            } else {
                usedPositions.get(groupId).add(position);
                newMappings.set(groupId, position);
            }
        }
    });
    
    // Hata varsa kullanƒ±cƒ±yƒ± bilgilendir
    if (hasErrors) {
        showModernToast(`Haritalama hatalarƒ±:<br>${errors.join('<br>')}`, "error", 6000);
        return;
    }
    
    // Bu sorunun hangi bile≈üene ait olduƒüunu bul
    const parentComponentId = getParentComponentId(activityId);
    if (!parentComponentId) {
        showModernToast('Soru i√ßin bile≈üen bulunamadƒ±', 'error');
        return;
    }
    
    const component = APP_STATE.courseData?.grupHaritalari?.[parentComponentId];
    if (!component || !component.haritalar) {
        showModernToast('Bile≈üen grup verisi bulunamadƒ±', 'error');
        return;
    }
    
    // √ñnce bu sorunun mevcut haritalamalarƒ±nƒ± kontrol et ve sil
    const oldMappings = [];
    Object.keys(component.haritalar).forEach(existingGroupName => {
        if (component.haritalar[existingGroupName]) {
            const existingPosition = Object.keys(component.haritalar[existingGroupName]).find(pos => 
                component.haritalar[existingGroupName][pos] === activityId
            );
            if (existingPosition) {
                oldMappings.push(`Grup ${existingGroupName} (${existingPosition}. sƒ±ra)`);
                // Eski pozisyonu sil
                delete component.haritalar[existingGroupName][existingPosition];
            }
        }
    });
    
    // Yeni haritalamayƒ± uygula
    // D√úZELTME: Veri yapƒ±sƒ± {position: questionId} formatƒ±nda
    newMappings.forEach((position, groupName) => {
        if (!component.haritalar[groupName]) {
            component.haritalar[groupName] = {};
        }
        
        component.haritalar[groupName][position.toString()] = activityId;
    });
    
    // Kullanƒ±cƒ±ya bilgi ver
    const activity = findNodeById(activityId);
    const activityName = activity ? activity.name : activityId;
    
    let message = `üìù "${activityName}" sorusu haritalama kaydedildi:`;
    if (oldMappings.length > 0) {
        message += `\nüóëÔ∏è Eski haritalamalar silindi: ${oldMappings.join(', ')}`;
    }
    if (newMappings.size > 0) {
        const newMappingList = Array.from(newMappings.entries()).map(([group, pos]) => `Grup ${group} (${pos}. sƒ±ra)`);
        message += `\n‚úÖ Yeni haritalamalar: ${newMappingList.join(', ')}`;
    }
    
    showModernToast(message, "success", 4000);
    
    // Modal'ƒ± kapat
    closeModernModal('groupMappingModal');
    
    // G√∂r√ºnt√ºleri g√ºncelle
    updateAllMappingDisplays();
    updateTreeMappingControls();
    
    // Aƒüa√ßtaki buton renklerini g√ºncelle
    updateGroupMappingColors();
    
    // Ana ekran grup giri≈ülerini g√ºncelle
    updateAllInlineGroupInputs();
    
    APP_STATE.currentMappingNode = null;
}

/**
 * Yeni haritalama satƒ±rƒ± ekleme
 */
async function addMappingRow() {
    if (!APP_STATE.currentMappingNode) return;
    
    const activityId = APP_STATE.currentMappingNode.id;
    
    // Bu sorunun hangi bile≈üene ait olduƒüunu bul
    const parentComponentId = getParentComponentId(activityId);
    if (!parentComponentId) {
        showModernToast("Soru i√ßin bile≈üen bulunamadƒ±", "error");
        return;
    }
    
    const component = APP_STATE.courseData?.grupHaritalari?.[parentComponentId];
    if (!component) {
        showModernToast("Bile≈üen grup verisi bulunamadƒ±", "error");
        return;
    }
    
    const groups = component.gruplar || ['A'];
    const groupNames = ['B', 'C', 'D', 'E', 'F', 'G', 'H'];
    const newGroupName = groupNames.find(name => !groups.includes(name));
    
    if (!newGroupName) {
        showModernToast("Bu etkinlik i√ßin maksimum grup sayƒ±sƒ±na ula≈üƒ±ldƒ± (H grubuna kadar)", "warning");
        return;
    }
    
    // Modern confirm dialog ile onay al
    const confirmed = await showModernConfirm(
        'Etkinliƒüe Grup Ekleme Onayƒ±',
        `${getComponentDisplayName(parentComponentId)} etkinliƒüine grup ${newGroupName} eklenecek.\n\nBu grup eklendikten sonra:\n‚Ä¢ Haritalama modalƒ±nda g√∂r√ºnecek\n‚Ä¢ √ñƒürenci gruplarƒ±nda se√ßilebilir olacak\n‚Ä¢ A grubunun kopyasƒ± olarak olu≈üturulacak`,
        {
            confirmText: 'Evet, Ekle',
            cancelText: 'ƒ∞ptal',
            headerClass: 'success-action',
            iconClass: 'success'
        }
    );
    
    if (!confirmed) {
        return;
    }
    
    // Yeni grubu listeye ekle
    component.gruplar.push(newGroupName);
    
    // A grubunun kopyasƒ± olarak mapping olu≈ütur (derin kopya)
    const groupAMapping = component.haritalar.A || {};
    component.haritalar[newGroupName] = JSON.parse(JSON.stringify(groupAMapping));
    
    // Eƒüer A grubunda mapping yoksa, varsayƒ±lan 1:1 mapping olu≈ütur
    if (Object.keys(groupAMapping).length === 0) {
        const componentNode = findNodeById(parentComponentId);
        if (componentNode && componentNode.children) {
            let questionIndex = 1;
            componentNode.children.forEach(childNode => {
                if (isQuestionType(childNode.type) || isRubricType(childNode.type)) {
                    // D√úZELTME: Veri yapƒ±sƒ± {position: questionId} formatƒ±nda
                    component.haritalar.A[questionIndex.toString()] = childNode.id;
                    component.haritalar[newGroupName][questionIndex.toString()] = childNode.id;
                    questionIndex++;
                }
            });
        }
    }
    
    // UI'larƒ± g√ºncelle
    updateGroupSelectors();
    updateStudentTable();
    updateAssessmentView();
    updateAllInlineGroupInputs();
    updateAllMappingDisplays();
    updateGroupMappingColors();
    
    // Grup sayƒ±sƒ±nƒ± g√ºncelle
    updateComponentGroupCounts();
    
    // Modal i√ßeriƒüini yeniden render et
    renderMappingRows(activityId);
    
    showModernToast(`${getComponentDisplayName(parentComponentId)} etkinliƒüine grup ${newGroupName} ba≈üarƒ±yla eklendi`, "success");
}

// =====================================================
// EVENT Lƒ∞STENER'LAR
// =====================================================

// Grup butonlarƒ± HTML'den kaldƒ±rƒ±ldƒ± - artƒ±k bile≈üen bazlƒ± grup y√∂netimi kullanƒ±lƒ±yor

// Haritalama kaydetme butonu
if (saveMappingBtn) {
    saveMappingBtn.addEventListener('click', saveGroupMapping);
}

// Haritalama satƒ±rƒ± ekleme butonu
if (addMappingRowBtn) {
    addMappingRowBtn.addEventListener('click', addMappingRow);
}

// Toplu grup haritalama butonu
const applyBulkMappingBtn = document.getElementById('applyBulkMapping');
if (applyBulkMappingBtn) {
    applyBulkMappingBtn.addEventListener('click', applyBulkMapping);
}

/**
 * √ñƒürenci tablosundaki grup g√∂r√ºnt√ºs√ºn√º g√ºncelleme
 */
function updateStudentTableGroupDisplay(studentId, groupId) {
    // Bu fonksiyon artƒ±k kullanƒ±lmƒ±yor - √∂ƒürenci listesinde grup g√∂sterimi yok
    // Grup bilgileri ayrƒ± bir kartta g√∂steriliyor
}

/**
 * Deƒüerlendirme giri≈üi sekmesindeki grup g√∂r√ºnt√ºs√ºn√º g√ºncelleme
 */
function updateAssessmentGroupDisplay(studentId, groupId) {
    const assessmentContainer = document.getElementById('assessmentContainer');
    if (assessmentContainer) {
        // T√ºm assessment containerƒ±ndaki grup se√ßicileri g√ºncelle
        assessmentContainer.querySelectorAll(`select[data-student-id="${studentId}"]`).forEach(select => {
            if (select.value !== groupId) {
                select.value = groupId;
            }
        });
        
        // Eƒüer assessment sekmesi aktif ise ve se√ßenekler arasƒ±nda grup yoksa view'ƒ± yenile
        const activeTab = document.querySelector('.nav-content.active');
        if (activeTab && activeTab.id === 'assessment-content') {
            const groupOption = assessmentContainer.querySelector(`select[data-student-id="${studentId}"] option[value="${groupId}"]`);
            if (!groupOption) {
                // Grup se√ßeneƒüi yoksa assessment view'ƒ±nƒ± yenile
                updateAssessmentView();
            }
        }
    }
}

/**
 * √ñƒürenci bazlƒ± not giri≈üi sekmesindeki grup g√∂r√ºnt√ºs√ºn√º g√ºncelleme
 */
function updateStudentGradesGroupDisplay(studentId, groupId) {
    const studentGradesContainer = document.getElementById('studentGradesContainer');
    if (studentGradesContainer) {
        const groupSelector = studentGradesContainer.querySelector(`select[data-student-id="${studentId}"]`);
        if (groupSelector && groupSelector.value !== groupId) {
            groupSelector.value = groupId;
        }
    }
}



/**
 * Grup haritalama durumunu kontrol etme
 * @param {string} nodeId - Kontrol edilecek d√ºƒü√ºm ID'si
 * @returns {Object} - Haritalama durumu bilgisi
 */
function checkGroupMappingStatus(nodeId) {
    // Bu sorunun hangi bile≈üene ait olduƒüunu bul
    const parentComponentId = getParentComponentId(nodeId);
    if (!parentComponentId) {
        return { isComplete: true, missingGroups: [], duplicatePositions: {}, hasMapping: false };
    }
    
    // Bu bile≈üenin gruplarƒ±nƒ± al
    const component = APP_STATE.courseData?.grupHaritalari?.[parentComponentId];
    const activeGroups = component?.gruplar || ['A'];
    const mappingStatus = {
        isComplete: true,
        missingGroups: [],
        duplicatePositions: {},
        hasMapping: false
    };
    
    if (activeGroups.length <= 1) {
        // Tek grup varsa haritalama gerekmez
        mappingStatus.isComplete = true;
        return mappingStatus;
    }
    
    // Her grup i√ßin kontrol et
    activeGroups.forEach(groupId => {
        const groupMappings = component?.haritalar?.[groupId];
        // D√úZELTME: Veri yapƒ±sƒ± {position: questionId} formatƒ±nda
        const hasMapping = groupMappings && Object.values(groupMappings).includes(nodeId);
        if (!hasMapping) {
            mappingStatus.missingGroups.push(groupId);
            mappingStatus.isComplete = false;
        } else {
            mappingStatus.hasMapping = true;
        }
    });
    
    // Aynƒ± pozisyonda birden fazla soru var mƒ± kontrol et
    const positionGroups = {};
    activeGroups.forEach(groupId => {
        const groupMappings = component?.haritalar?.[groupId];
        if (groupMappings) {
            // D√úZELTME: Veri yapƒ±sƒ± {position: questionId} formatƒ±nda
            const position = Object.keys(groupMappings).find(pos => groupMappings[pos] === nodeId);
            if (position) {
            if (!positionGroups[position]) {
                positionGroups[position] = [];
            }
            positionGroups[position].push(groupId);
            }
        }
    });
    
    // Duplicate pozisyonlarƒ± tespit et
    Object.keys(positionGroups).forEach(position => {
        if (positionGroups[position].length > 1) {
            mappingStatus.duplicatePositions[position] = positionGroups[position];
            mappingStatus.isComplete = false;
        }
    });
    
    return mappingStatus;
}

/**
 * Grup haritalama durumuna g√∂re CSS sƒ±nƒ±fƒ± d√∂nd√ºrme
 * @param {string} nodeId - D√ºƒü√ºm ID'si
 * @returns {string} - CSS sƒ±nƒ±f adƒ±
 */
function getGroupMappingStatusClass(nodeId) {
    const status = checkGroupMappingStatus(nodeId);
    
    // Bu sorunun hangi bile≈üene ait olduƒüunu bul
    const parentComponentId = getParentComponentId(nodeId);
    if (!parentComponentId) {
        return 'group-single';
    }
    
    const component = APP_STATE.courseData?.grupHaritalari?.[parentComponentId];
    const activeGroups = component?.gruplar || ['A'];
    
    if (activeGroups.length <= 1) {
        return 'group-single'; // Tek grup
    }
    
    if (!status.hasMapping) {
        return 'group-unmapped'; // Hi√ß haritalama yok
    }
    
    if (!status.isComplete) {
        if (status.missingGroups.length > 0) {
            return 'group-incomplete'; // Eksik gruplar var
        }
        if (Object.keys(status.duplicatePositions).length > 0) {
            return 'group-duplicate'; // Duplicate pozisyonlar var
        }
    }
    
    return 'group-complete'; // Tam haritalanmƒ±≈ü
}

/**
 * Toplu grup haritalama i√ßin format ayrƒ±≈ütƒ±rma
 * @param {string} input - Giri≈ü metni (√∂rn: "A:1,B:2,C:3")
 * @param {string} nodeId - D√ºƒü√ºm ID'si
 * @returns {Object} - Ayrƒ±≈ütƒ±rƒ±lmƒ±≈ü haritalama
 */
function parseBulkGroupMapping(input, nodeId) {
    const mappings = {};
    const errors = [];
    
    if (!input.trim()) {
        return { mappings, errors };
    }
    
    // Bu sorunun hangi bile≈üene ait olduƒüunu bul
    const parentComponentId = getParentComponentId(nodeId);
    if (!parentComponentId) {
        errors.push('Soru i√ßin bile≈üen bulunamadƒ±');
        return { mappings, errors };
    }
    
    const component = APP_STATE.courseData?.grupHaritalari?.[parentComponentId];
    if (!component) {
        errors.push('Bile≈üen grup verisi bulunamadƒ±');
        return { mappings, errors };
    }
    
    const availableGroups = component.gruplar || ['A'];
    const parts = input.split(',').map(p => p.trim());
    
    parts.forEach(part => {
        const colonIndex = part.indexOf(':');
        if (colonIndex === -1) {
            errors.push(`Ge√ßersiz format: "${part}". "Grup:Pozisyon" formatƒ±nda olmalƒ±.`);
            return;
        }
        
        const groupId = part.substring(0, colonIndex).trim().toUpperCase();
        const position = part.substring(colonIndex + 1).trim();
        
        if (!availableGroups.includes(groupId)) {
            errors.push(`Ge√ßersiz grup: "${groupId}". Bu bile≈üende mevcut gruplar: ${availableGroups.join(', ')}`);
            return;
        }
        
        if (!/^\d+$/.test(position) || parseInt(position) < 1) {
            errors.push(`Ge√ßersiz pozisyon: "${position}". Pozitif sayƒ± olmalƒ±.`);
            return;
        }
        
        mappings[groupId] = position;
    });
    
    return { mappings, errors };
}

/**
 * Toplu grup haritalama uygulama
 */
function applyBulkMapping() {
    try {
        const bulkInput = document.getElementById('bulkMappingInput');
        const errorContainer = document.getElementById('bulkErrorMessages');
        
        if (!bulkInput || !APP_STATE.currentMappingNode) {
            return;
        }
        
        const input = bulkInput.value.trim();
        const nodeId = APP_STATE.currentMappingNode.id;
        
        // Hata mesajlarƒ±nƒ± temizle
        errorContainer.innerHTML = '';
        
        // Giri≈ü ayrƒ±≈ütƒ±rma
        const { mappings, errors } = parseBulkGroupMapping(input, nodeId);
        
        // Hata varsa g√∂ster
        if (errors.length > 0) {
            errors.forEach(error => {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'bulk-error-message';
                errorDiv.textContent = error;
                errorContainer.appendChild(errorDiv);
            });
            return;
        }
        
        // Ba≈üarƒ±lƒ± giri≈ü
        if (Object.keys(mappings).length > 0) {
            // Modal satƒ±rlarƒ±nƒ± g√ºncelle (bu haritalamayƒ± da CourseData'ya kaydeder)
            updateModalRowsFromBulkInput(mappings);
            
            // Ba≈üarƒ± animasyonu
            bulkInput.classList.add('success');
            setTimeout(() => {
                bulkInput.classList.remove('success');
            }, 600);
            
            showModernToast('Toplu haritalama ba≈üarƒ±yla uygulandƒ±', 'success');
        }
        
    } catch (error) {
        console.error('Toplu haritalama hatasƒ±:', error);
        showModernToast('Toplu haritalama uygulanamadƒ±!', 'error');
    }
}

/**
 * Grup haritalama modal'ƒ±nƒ± kapattƒ±ƒüƒ±nda aƒüa√ßtaki buton renklerini g√ºncelle
 */
function updateGroupMappingColors() {
    document.querySelectorAll('.btn-group-mapping').forEach(button => {
        const nodeId = button.dataset.nodeId;
        if (nodeId) {
            // Eski sƒ±nƒ±flarƒ± kaldƒ±r
            button.classList.remove('group-single', 'group-unmapped', 'group-incomplete', 'group-duplicate', 'group-complete');
            // Yeni sƒ±nƒ±fƒ± ekle
            button.classList.add(getGroupMappingStatusClass(nodeId));
        }
    });
}

/**
 * Modal satƒ±rlarƒ±ndan hƒ±zlƒ± giri≈ü alanƒ±nƒ± g√ºncelleme
 */
function updateBulkInputFromModalRows() {
    if (!APP_STATE.currentMappingNode) return;
    
    const nodeId = APP_STATE.currentMappingNode.id;
    const bulkInput = document.getElementById('bulkMappingInput');
    
    if (!bulkInput) return;
    
    // Bu sorunun hangi bile≈üene ait olduƒüunu bul
    const parentComponentId = getParentComponentId(nodeId);
    if (!parentComponentId) return;
    
    const component = APP_STATE.courseData?.grupHaritalari?.[parentComponentId];
    if (!component || !component.haritalar) return;
    
    const mappingPairs = [];
    const groups = component.gruplar || ['A'];
    
    // Her grup i√ßin haritalama bilgisini topla
    // D√úZELTME: Veri yapƒ±sƒ± {position: questionId} formatƒ±nda
    groups.forEach(groupName => {
        const groupMappings = component.haritalar[groupName];
        if (groupMappings) {
            const position = Object.keys(groupMappings).find(pos => groupMappings[pos] === nodeId);
            if (position) {
                mappingPairs.push(`${groupName}:${position}`);
            }
        }
    });
    
    // Alfabetik sƒ±rala
    mappingPairs.sort();
    
    // Hƒ±zlƒ± giri≈ü alanƒ±nƒ± g√ºncelle
    bulkInput.value = mappingPairs.join(',');
}

/**
 * Hƒ±zlƒ± giri≈üten modal satƒ±rlarƒ±nƒ± g√ºncelleme
 */
function updateModalRowsFromBulkInput(mappings) {
    if (!APP_STATE.currentMappingNode) return;
    
    const nodeId = APP_STATE.currentMappingNode.id;
    
    // Bu sorunun hangi bile≈üene ait olduƒüunu bul
    const parentComponentId = getParentComponentId(nodeId);
    if (!parentComponentId) return;
    
    const component = APP_STATE.courseData?.grupHaritalari?.[parentComponentId];
    if (!component || !component.haritalar) return;
    
    // Haritalamayƒ± CourseData'ya uygula
    // D√úZELTME: Veri yapƒ±sƒ± {position: questionId} formatƒ±nda
    Object.keys(mappings).forEach(groupName => {
        if (!component.haritalar[groupName]) {
            component.haritalar[groupName] = {};
        }
        const position = mappings[groupName];
        component.haritalar[groupName][position] = nodeId;
    });
    
    // Modal satƒ±rlarƒ±nƒ± yenile
    renderMappingRows(nodeId);
}

/**
 * Mevcut haritalama metnini getirme
 * @param {string} nodeId - D√ºƒü√ºm ID'si
 * @returns {string} - Haritalama metni (√∂rn: "A:1,B:2,C:3")
 */
function getCurrentMappingText(nodeId) {
    try {
        // √ñnce bu sorunun hangi bile≈üene ait olduƒüunu bul
        const parentComponentId = getParentComponentId(nodeId);
        if (!parentComponentId) {
            return '';
        }
        
        const component = APP_STATE.courseData?.grupHaritalari?.[parentComponentId];
        if (!component || !component.haritalar) {
            return '';
        }
        
        const mappingPairs = [];
        const groups = component.gruplar || ['A'];
        
        groups.forEach(groupName => {
            const groupMapping = component.haritalar[groupName];
            if (groupMapping) {
                // D√úZELTME: Veri yapƒ±sƒ± {position: questionId} formatƒ±nda
                // Bu sorunun hangi pozisyonda olduƒüunu bul
                const position = Object.keys(groupMapping).find(pos => groupMapping[pos] === nodeId);
                if (position) {
                    mappingPairs.push(`${groupName}:${position}`);
                }
            }
        });
        
        // Duplicate'leri temizle
        const uniquePairs = [...new Set(mappingPairs)];
        uniquePairs.sort();
        const result = uniquePairs.join(',');
        
        console.log(`üìã getCurrentMappingText(${nodeId}): "${result}"`, {
            parentComponentId,
            component: component ? {
                gruplar: component.gruplar,
                mappingKeys: Object.keys(component.haritalar || {}),
                fullMappings: component.haritalar
            } : null,
            mappingPairs: uniquePairs,
            foundMappings: mappingPairs
        });
        
        return result;
    } catch (error) {
        console.error('getCurrentMappingText hatasƒ±:', error);
        return '';
    }
}

/**
 * Ana ekran hƒ±zlƒ± grup haritalama uygulama
 * @param {string} nodeId - D√ºƒü√ºm ID'si
 */
function applyInlineGroupMapping(nodeId) {
    try {
        const inputElement = document.querySelector(`.nodeGroupMapping[data-node-id="${nodeId}"]`);
        const buttonElement = document.querySelector(`.btn-apply-group-mapping[data-node-id="${nodeId}"]`);
        
        if (!inputElement) return;
        
        const input = inputElement.value.trim();
        
        // Buton loading durumu
        if (buttonElement) {
            buttonElement.classList.add('loading');
        }
        
        // Input'u normal duruma getir
        inputElement.classList.remove('success', 'error');
        
        // Giri≈ü ayrƒ±≈ütƒ±rma
        const { mappings, errors } = parseBulkGroupMapping(input, nodeId);
        
        // Hata varsa g√∂ster
        if (errors.length > 0) {
            inputElement.classList.add('error');
            showModernToast(errors.join('<br>'), 'error', 4000);
            
            if (buttonElement) {
                buttonElement.classList.remove('loading');
            }
            return;
        }
        
        // Ba≈üarƒ±lƒ± giri≈ü
        if (Object.keys(mappings).length > 0) {
            // Bu sorunun hangi bile≈üene ait olduƒüunu bul
            const parentComponentId = getParentComponentId(nodeId);
            if (!parentComponentId) {
                showModernToast('Soru i√ßin bile≈üen bulunamadƒ±', 'error');
                return;
            }
            
            const component = APP_STATE.courseData?.grupHaritalari?.[parentComponentId];
            if (!component || !component.haritalar) {
                showModernToast('Bile≈üen grup verisi bulunamadƒ±', 'error');
                return;
            }
            
            // √ñnce mevcut haritalamlarƒ± kontrol et ve eski pozisyonlarƒ± temizle
            const oldMappings = [];
            Object.keys(component.haritalar).forEach(existingGroupName => {
                if (component.haritalar[existingGroupName]) {
                    const existingPosition = Object.keys(component.haritalar[existingGroupName]).find(pos => 
                        component.haritalar[existingGroupName][pos] === nodeId
                    );
                    if (existingPosition) {
                        // Eƒüer yeni haritalamada bu grup yoksa, eski pozisyonu kaydet
                        if (!mappings[existingGroupName]) {
                            oldMappings.push(`Grup ${existingGroupName} (${existingPosition}. sƒ±ra)`);
                        }
                        // Eski pozisyonu sil
                        delete component.haritalar[existingGroupName][existingPosition];
                    }
                }
            });
            
            // Haritalamayƒ± uygula
            // D√úZELTME: Veri yapƒ±sƒ± {position: questionId} formatƒ±nda
            Object.keys(mappings).forEach(groupName => {
                if (!component.haritalar[groupName]) {
                    component.haritalar[groupName] = {};
                }
                const position = mappings[groupName];
                component.haritalar[groupName][position] = nodeId;
            });
            
            // Ba≈üarƒ± animasyonu
            inputElement.classList.add('success');
            setTimeout(() => {
                inputElement.classList.remove('success');
            }, 600);
            
            // Grup butonunun rengini g√ºncelle
            updateGroupMappingColors();
            
            // Deƒüerlendirme sekmesini g√ºncelle
            setTimeout(() => {
                updateAssessmentView();
            }, 100);
            
            // Kullanƒ±cƒ±ya bilgi ver
            const activity = findNodeById(nodeId);
            const activityName = activity ? activity.name : nodeId;
            const newMappingText = Object.keys(mappings).map(g => `Grup ${g} (${mappings[g]}. sƒ±ra)`).join(', ');
            
            if (oldMappings.length > 0) {
                showModernToast(
                    `üìù "${activityName}" sorusu:<br>` +
                    `üóëÔ∏è ≈ûu gruplardan silindi: ${oldMappings.join(', ')}<br>` +
                    `‚úÖ Yeni atama: ${newMappingText}`, 
                    'info', 
                    4000
                );
            } else {
                showModernToast(
                    `üìù "${activityName}" sorusu:<br>` +
                    `‚úÖ Grup haritalama uygulandƒ±: ${newMappingText}`, 
                    'success', 
                    3000
                );
            }
        } else {
            // Bo≈ü giri≈ü - mevcut haritalamayƒ± temizle
            const parentComponentId = getParentComponentId(nodeId);
            if (parentComponentId) {
                const component = APP_STATE.courseData?.grupHaritalari?.[parentComponentId];
                if (component && component.haritalar) {
                    // D√úZELTME: Veri yapƒ±sƒ± {position: questionId} formatƒ±nda
                    Object.keys(component.haritalar).forEach(groupName => {
                        if (component.haritalar[groupName]) {
                            // Bu sorunun pozisyonunu bul ve sil
                            const position = Object.keys(component.haritalar[groupName]).find(pos => 
                                component.haritalar[groupName][pos] === nodeId
                            );
                            if (position) {
                                delete component.haritalar[groupName][position];
                            }
                        }
                    });
                }
            }
            
            updateGroupMappingColors();
            showModernToast('Grup haritalama temizlendi', 'info', 2000);
        }
        
        // Loading durumunu kaldƒ±r
        if (buttonElement) {
            setTimeout(() => {
                buttonElement.classList.remove('loading');
            }, 300);
        }
        
    } catch (error) {
        console.error('Ana ekran grup haritalama hatasƒ±:', error);
        showModernToast('Grup haritalama uygulanamadƒ±!', 'error');
        
        const buttonElement = document.querySelector(`.btn-apply-group-mapping[data-node-id="${nodeId}"]`);
        if (buttonElement) {
            buttonElement.classList.remove('loading');
        }
    }
}

/**
 * Silinen soru/rubrik i√ßin grup haritalamalarƒ±nƒ± temizle ve pozisyonlarƒ± yeniden d√ºzenle
 * @param {string} nodeId - Silinen d√ºƒü√ºm ID'si
 */
function cleanupGroupMappingsForDeletedNode(nodeId) {
    try {
        if (!APP_STATE.courseData?.grupHaritalari) return;
        
        console.log(`üßπ Silinen d√ºƒü√ºm i√ßin grup haritalama temizliƒüi ve yeniden d√ºzenleme: ${nodeId}`);
        
        // Bu sorunun hangi bile≈üene ait olduƒüunu bul
        const parentComponentId = getParentComponentId(nodeId);
        if (!parentComponentId) {
            console.log(`‚ö†Ô∏è Parent component bulunamadƒ±: ${nodeId}`);
            return;
        }
        
        const component = APP_STATE.courseData.grupHaritalari[parentComponentId];
        if (!component || !component.haritalar) {
            console.log(`‚ö†Ô∏è Component mapping bulunamadƒ±: ${parentComponentId}`);
            return;
        }
        
        let cleanupCount = 0;
        
        // Her grup i√ßin haritalamayƒ± temizle ve yeniden d√ºzenle
        Object.keys(component.haritalar).forEach(groupName => {
            if (component.haritalar[groupName]) {
                const groupMapping = component.haritalar[groupName];
                
                console.log(`üîç Grup ${groupName} - silme √∂ncesi mapping:`, {...groupMapping});
                
                // 1. Silinen sorunun pozisyonunu bul
                let deletedPosition = null;
                Object.keys(groupMapping).forEach(position => {
                    if (groupMapping[position] === nodeId) {
                        deletedPosition = parseInt(position);
                        delete groupMapping[position];
                        cleanupCount++;
                        console.log(`üóëÔ∏è Silindi: Grup ${groupName}, Pozisyon ${position}, Soru ${nodeId}`);
                    }
                });
                
                // 2. Eƒüer silinen pozisyon varsa, sonraki pozisyonlarƒ± kaydƒ±r
                if (deletedPosition !== null) {
                    console.log(`üìê Pozisyon kaymasƒ± ba≈ülatƒ±lƒ±yor: ${deletedPosition} pozisyonundan itibaren`);
                    
                    // Mevcut pozisyonlarƒ± sƒ±rala
                    const sortedPositions = Object.keys(groupMapping)
                        .map(pos => parseInt(pos))
                        .filter(pos => !isNaN(pos))
                        .sort((a, b) => a - b);
                    
                    console.log(`üìã Sƒ±ralƒ± pozisyonlar:`, sortedPositions);
                    
                    // Yeni mapping olu≈ütur - pozisyonlarƒ± sƒ±kƒ±≈ütƒ±r
                    const newMapping = {};
                    let newPosition = 1;
                    
                    sortedPositions.forEach(oldPosition => {
                        const questionId = groupMapping[oldPosition.toString()];
                        if (questionId) {
                            newMapping[newPosition.toString()] = questionId;
                            console.log(`üîÑ Pozisyon deƒüi≈üimi: ${questionId} => ${oldPosition} ‚Üí ${newPosition}`);
                            newPosition++;
                        }
                    });
                    
                    // Eski mapping'i temizle ve yenisini ata
                    component.haritalar[groupName] = newMapping;
                    
                    console.log(`‚úÖ Grup ${groupName} - yeniden d√ºzenleme sonrasƒ±:`, {...newMapping});
                }
            }
        });
        
        if (cleanupCount > 0) {
            console.log(`‚úÖ ${cleanupCount} grup haritalama temizlendi ve pozisyonlar yeniden d√ºzenlendi`);
            
            // UI g√ºncellemeleri
            updateGroupMappingColors();
            updateAllInlineGroupInputs();
            updateAllMappingDisplays();
            
            showModernToast(`Soru silindi ve grup pozisyonlarƒ± g√ºncellendi`, "success", 3000);
        } else {
            console.log(`‚ÑπÔ∏è ${nodeId} i√ßin temizlenecek grup haritalama bulunamadƒ±`);
        }
        
    } catch (error) {
        console.error("Grup haritalama temizliƒüi sƒ±rasƒ±nda hata:", error);
        showModernToast("Grup haritalama temizliƒüi ba≈üarƒ±sƒ±z!", "warning");
    }
}

/**
 * Soru/rubrik eklendikten sonra grup haritalamalarƒ±nƒ± g√ºncelle
 * @param {string} parentComponentId - Ana bile≈üen ID'si
 */
function updateGroupMappingsAfterNodeAdd(parentComponentId) {
    try {
        if (!APP_STATE.courseData?.grupHaritalari) return;
        
        console.log(`üîÑ Soru ekleme sonrasƒ± grup haritalama g√ºncelleniyor: ${parentComponentId}`);
        
        const component = APP_STATE.courseData.grupHaritalari[parentComponentId];
        if (!component) {
            console.log(`‚ÑπÔ∏è ${parentComponentId} i√ßin grup yapƒ±sƒ± bulunamadƒ±, varsayƒ±lan olu≈üturuluyor...`);
            createDefaultMappingForComponent(parentComponentId);
            return;
        }
        
        // Mevcut sorular ile haritalamayƒ± senkronize et
        const parentNode = findNodeById(parentComponentId);
        if (parentNode && parentNode.children) {
            const questions = parentNode.children.filter(child => 
                isQuestionType(child.type) || isRubricType(child.type)
            );
            
            // Her grup i√ßin eksik haritalamlarƒ± kontrol et ve otomatik ekle
            const groups = component.gruplar || ['A'];
            groups.forEach(groupName => {
                if (!component.haritalar[groupName]) {
                    component.haritalar[groupName] = {};
                }
                
                // Yeni eklenen sorular i√ßin otomatik haritalama olu≈ütur
                questions.forEach((question, index) => {
                    const hasMapping = Object.values(component.haritalar[groupName]).includes(question.id);
                    if (!hasMapping) {
                        // Mevcut pozisyonlarƒ± kontrol et ve sƒ±ralƒ± olarak en sona ekle
                        const existingPositions = Object.keys(component.haritalar[groupName])
                            .map(pos => parseInt(pos))
                            .filter(pos => !isNaN(pos))
                            .sort((a, b) => a - b);
                        
                        // Sƒ±ralƒ± pozisyon ata (bo≈üluk varsa doldur, yoksa en sona ekle)
                        let nextPosition = 1;
                        for (let i = 0; i < existingPositions.length; i++) {
                            if (existingPositions[i] !== nextPosition) {
                                break; // Bo≈üluk bulundu
                            }
                            nextPosition++;
                        }
                        
                        component.haritalar[groupName][nextPosition.toString()] = question.id;
                        console.log(`‚ûï Otomatik haritalama: Grup ${groupName}, Pozisyon ${nextPosition}, Soru ${question.id}`);
                    }
                });
            });
        }
        
        // UI g√ºncellemeleri
        updateGroupMappingColors();
        updateAllInlineGroupInputs();
        updateAllMappingDisplays();
        
        console.log(`‚úÖ Grup haritalama g√ºncelleme tamamlandƒ±: ${parentComponentId}`);
        
    } catch (error) {
        console.error("Grup haritalama g√ºncelleme hatasƒ±:", error);
    }
}

/**
 * Grup haritalamalarƒ±nda pozisyon deƒüi≈ütirme (sƒ±ralama deƒüi≈üikliƒüi)
 * @param {string} componentId - Bile≈üen ID'si
 * @param {string} groupName - Grup adƒ±
 * @param {string} questionId - Soru ID'si
 * @param {number} newPosition - Yeni pozisyon
 */
function changeQuestionPosition(componentId, groupName, questionId, newPosition) {
    try {
        if (!APP_STATE.courseData?.grupHaritalari?.[componentId]?.haritalar?.[groupName]) {
            console.error(`Grup ${groupName} haritalama bulunamadƒ±: ${componentId}`);
            return false;
        }
        
        const groupMapping = APP_STATE.courseData.grupHaritalari[componentId].haritalar[groupName];
        
        console.log(`üîÑ Pozisyon deƒüi≈üikliƒüi: ${questionId} ‚Üí Pozisyon ${newPosition}`);
        console.log(`üìã Deƒüi≈üiklik √∂ncesi mapping:`, {...groupMapping});
        
        // 1. Mevcut pozisyonu bul ve kaldƒ±r
        let oldPosition = null;
        Object.keys(groupMapping).forEach(pos => {
            if (groupMapping[pos] === questionId) {
                oldPosition = parseInt(pos);
                delete groupMapping[pos];
            }
        });
        
        if (oldPosition === null) {
            console.error(`Soru ${questionId} grup ${groupName} haritalamada bulunamadƒ±`);
            return false;
        }
        
        // 2. Yeni pozisyonda ba≈üka soru varsa yer deƒüi≈ütir
        const existingQuestionAtNewPos = groupMapping[newPosition.toString()];
        if (existingQuestionAtNewPos) {
            // Yer deƒüi≈ütirme
            groupMapping[oldPosition.toString()] = existingQuestionAtNewPos;
            console.log(`üîÑ Yer deƒüi≈üimi: ${existingQuestionAtNewPos} => ${newPosition} ‚Üí ${oldPosition}`);
        }
        
        // 3. Soruyu yeni pozisyona yerle≈ütir
        groupMapping[newPosition.toString()] = questionId;
        
        console.log(`‚úÖ Pozisyon deƒüi≈üikliƒüi tamamlandƒ±:`, {...groupMapping});
        
        // UI g√ºncellemeleri
        updateGroupMappingColors();
        updateAllInlineGroupInputs();
        updateAllMappingDisplays();
        updateAssessmentView();
        
        showModernToast(`Soru pozisyonu deƒüi≈ütirildi: ${oldPosition} ‚Üí ${newPosition}`, "success");
        return true;
        
    } catch (error) {
        console.error("Pozisyon deƒüi≈üikliƒüi hatasƒ±:", error);
        showModernToast("Pozisyon deƒüi≈ütirilemedi!", "error");
        return false;
    }
}

/**
 * T√ºm ana ekran grup giri≈ülerini g√ºncelleme
 */
function updateAllInlineGroupInputs() {
    document.querySelectorAll('.nodeGroupMapping').forEach(input => {
        const nodeId = input.dataset.nodeId;
        if (nodeId) {
            const mappingText = getCurrentMappingText(nodeId);
            input.value = mappingText;
        }
    });
    
    // Bile≈üen grup bilgilerini de g√ºncelle
    document.querySelectorAll('.componentGroupInfo').forEach(input => {
        const componentId = input.dataset.componentId;
        if (componentId) {
            updateComponentGroupInfo(componentId);
        }
    });
}

/**
 * Bile≈üen grup bilgisini g√ºncelleme - v5 format uyumlu
 * @param {string} componentId - Bile≈üen ID'si
 */
function updateComponentGroupInfo(componentId) {
    // Alt √∂ƒüeler (soru/rubrik) i√ßin textarea yoksa sessizce ge√ß
    if (componentId.includes('.')) {
        return; // Alt √∂ƒüeler i√ßin grup bilgisi textarea'sƒ± yok, normal durum
    }
    
    const componentGroupTextarea = document.querySelector(`.componentGroupInfo[data-component-id="${componentId}"]`);
    if (!componentGroupTextarea) {
        console.log(`‚ö†Ô∏è updateComponentGroupInfo: ${componentId} i√ßin textarea bulunamadƒ±`);
        return;
    }
    
    const component = APP_STATE.courseData?.grupHaritalari?.[componentId];
    if (!component) {
        console.log(`‚ö†Ô∏è updateComponentGroupInfo: ${componentId} i√ßin grup bilgisi bulunamadƒ±`);
        componentGroupTextarea.value = 'A (Tek grup - Grup bilgisi y√ºklenemedi)';
        return;
    }
    
    const groups = component.gruplar || ['A'];
    console.log(`üìä updateComponentGroupInfo(${componentId}): Gruplar:`, groups);
    console.log(`üìä updateComponentGroupInfo(${componentId}): Mappings:`, component.haritalar);
    
    // v5 formatƒ±nda detaylƒ± grup bilgisi g√∂ster
    let groupInfo = `Gruplar: ${groups.join(', ')}`;
    
    // Mapping bilgisi varsa √∂rnekle - v5 format uyumlu
    if (component.haritalar && Object.keys(component.haritalar).length > 0) {
        const sampleMappings = [];
        groups.slice(0, 2).forEach(groupName => { // ƒ∞lk 2 grubu g√∂ster
            const groupMapping = component.haritalar[groupName];
            if (groupMapping && Object.keys(groupMapping).length > 0) {
                // v5 formatƒ±nda pozisyon anahtarlarƒ± string olabilir
                const positions = Object.keys(groupMapping).sort((a, b) => {
                    const numA = parseInt(a) || 0;
                    const numB = parseInt(b) || 0;
                    return numA - numB;
                });
                
                if (positions.length > 0) {
                    const samplePositions = positions.slice(0, 3); // ƒ∞lk 3 pozisyonu g√∂ster
                    const positionInfo = samplePositions.map(pos => {
                        const soruId = groupMapping[pos];
                        // v5 formatƒ±nda soruId uzun olabilir, kƒ±salt
                        const shortSoruId = soruId.length > 10 ? soruId.substring(0, 10) + '...' : soruId;
                        return `${shortSoruId}:${pos}`;
                    }).join(',');
                    sampleMappings.push(`${groupName}(${positionInfo})`);
                }
            }
        });
        
        if (sampleMappings.length > 0) {
            groupInfo += `\nSoru Sƒ±ralamasƒ±: ${sampleMappings.join('; ')}`;
        } else {
            groupInfo += `\n(Hen√ºz soru sƒ±ralamasƒ± atanmamƒ±≈ü)`;
        }
    } else {
        groupInfo += `\n(Hen√ºz grup mapping'i yapƒ±lmamƒ±≈ü)`;
    }
    
    componentGroupTextarea.value = groupInfo;
    
    console.log(`‚úÖ updateComponentGroupInfo(${componentId}): "${groupInfo}"`);
    
    // Auto-resize tetikle
    const event = new Event('input');
    componentGroupTextarea.dispatchEvent(event);
}

/**
 * Auto-resize textarea based on content - vertical expansion
 * @param {HTMLTextAreaElement} textarea - Textarea element to setup auto-resize
 */
function setupAutoResize(textarea) {
    if (!textarea) return;
    
    function adjustHeight() {
        // Reset height to auto to get the natural content height
        textarea.style.height = 'auto';
        
        // Calculate the scroll height
        const scrollHeight = textarea.scrollHeight;
        
        // Set minimum and maximum heights
        const minHeight = 32;
        const maxHeight = 150; // Maximum height before scroll
        
        // Set the new height
        const newHeight = Math.min(Math.max(scrollHeight, minHeight), maxHeight);
        textarea.style.height = newHeight + 'px';
        
        // Enable scroll if content exceeds max height
        if (scrollHeight > maxHeight) {
            textarea.style.overflowY = 'auto';
        } else {
            textarea.style.overflowY = 'hidden';
        }
    }
    
    // Add event listeners for height adjustment
    textarea.addEventListener('input', adjustHeight);
    textarea.addEventListener('change', adjustHeight);
    textarea.addEventListener('keyup', adjustHeight);
    textarea.addEventListener('focus', adjustHeight);
    textarea.addEventListener('paste', () => setTimeout(adjustHeight, 0));
    
    // Initial adjustment
    setTimeout(adjustHeight, 0);
}

/**
 * Default deƒüerlendirme aƒüacƒ± olu≈üturur
 */
function createDefaultAssessmentTree() {
    try {
        APP_STATE.assessmentTree = [
            {
                id: 'A1',
                name: 'Ara Sƒ±nav',
                type: 'Ara Sƒ±nav',
                weight: 40,
                points: 100,
                outcomes: getSmartOutcomes(3),
                description: 'Yarƒ±yƒ±l i√ßi deƒüerlendirme',
                expanded: true,
                children: [
                    {
                        id: 'A1.1',
                        name: 'Soru 1',
                        type: 'Soru',
                        weight: 20,
                        points: 20,
                        outcomes: getSmartOutcomes(1),
                        description: 'Deƒüerlendirme sorusu',
                        expanded: false,
                        children: []
                    },
                    {
                        id: 'A1.2',
                        name: 'Soru 2',
                        type: 'Soru',
                        weight: 20,
                        points: 20,
                        outcomes: getSmartOutcomes(1),
                        description: 'Deƒüerlendirme sorusu',
                        expanded: false,
                        children: []
                    },
                    {
                        id: 'A1.3',
                        name: 'Soru 3',
                        type: 'Soru',
                        weight: 20,
                        points: 20,
                        outcomes: getSmartOutcomes(1),
                        description: 'Deƒüerlendirme sorusu',
                        expanded: false,
                        children: []
                    },
                    {
                        id: 'A1.4',
                        name: 'Soru 4',
                        type: 'Soru',
                        weight: 20,
                        points: 20,
                        outcomes: getSmartOutcomes(1),
                        description: 'Deƒüerlendirme sorusu',
                        expanded: false,
                        children: []
                    },
                    {
                        id: 'A1.5',
                        name: 'Soru 5',
                        type: 'Soru',
                        weight: 20,
                        points: 20,
                        outcomes: getSmartOutcomes(1),
                        description: 'Deƒüerlendirme sorusu',
                        expanded: false,
                        children: []
                    }
                ]
            },
            {
                id: 'F1',
                name: 'Final Sƒ±navƒ±',
                type: 'Final Sƒ±navƒ±',
                weight: 60,
                points: 100,
                outcomes: getSmartOutcomes(4),
                description: 'Yarƒ±yƒ±l sonu deƒüerlendirme',
                expanded: true,
                children: [
                    {
                        id: 'F1.1',
                        name: 'Soru 1',
                        type: 'Soru',
                        weight: 20,
                        points: 20,
                        outcomes: [], // √ñ√á'leri bo≈ü bƒ±rak, kullanƒ±cƒ± manuel olarak atayacak
                        description: 'Deƒüerlendirme sorusu',
                        expanded: false,
                        children: []
                    },
                    {
                        id: 'F1.2',
                        name: 'Soru 2',
                        type: 'Soru',
                        weight: 20,
                        points: 20,
                        outcomes: [], // √ñ√á'leri bo≈ü bƒ±rak, kullanƒ±cƒ± manuel olarak atayacak
                        description: 'Deƒüerlendirme sorusu',
                        expanded: false,
                        children: []
                    },
                    {
                        id: 'F1.3',
                        name: 'Soru 3',
                        type: 'Soru',
                        weight: 20,
                        points: 20,
                        outcomes: [], // √ñ√á'leri bo≈ü bƒ±rak, kullanƒ±cƒ± manuel olarak atayacak
                        description: 'Deƒüerlendirme sorusu',
                        expanded: false,
                        children: []
                    },
                    {
                        id: 'F1.4',
                        name: 'Soru 4',
                        type: 'Soru',
                        weight: 20,
                        points: 20,
                        outcomes: [], // √ñ√á'leri bo≈ü bƒ±rak, kullanƒ±cƒ± manuel olarak atayacak
                        description: 'Deƒüerlendirme sorusu',
                        expanded: false,
                        children: []
                    },
                    {
                        id: 'F1.5',
                        name: 'Soru 5',
                        type: 'Soru',
                        weight: 20,
                        points: 20,
                        outcomes: [], // √ñ√á'leri bo≈ü bƒ±rak, kullanƒ±cƒ± manuel olarak atayacak
                        description: 'Deƒüerlendirme sorusu',
                        expanded: false,
                        children: []
                    }
                ]
            }
        ];
        
        console.log('Default deƒüerlendirme aƒüacƒ± olu≈üturuldu');
    } catch (error) {
        console.error("Default deƒüerlendirme aƒüacƒ± olu≈üturulurken hata:", error);
    }
}

/**
 * Grup veri yapƒ±sƒ±nƒ± doƒürulama ve tamamlama
 */
function validateAndCompleteGroupData() {
    try {
        if (!APP_STATE.courseData?.grupHaritalari) {
            console.log('Grup haritalarƒ± bulunamadƒ±, yeniden olu≈üturuluyor...');
            createDefaultMapping();
            return;
        }
        
        const grupHaritalari = APP_STATE.courseData.grupHaritalari;
        let hasChanges = false;
        
        // Her deƒüerlendirme bile≈üeni i√ßin doƒürula
        APP_STATE.assessmentTree.forEach(mainComponent => {
            if (mainComponent.id.startsWith('A') || mainComponent.id.startsWith('F')) {
                const componentId = mainComponent.id;
                
                // Bile≈üen i√ßin grup verisi yoksa olu≈ütur
                if (!grupHaritalari[componentId]) {
                    grupHaritalari[componentId] = {
                        gruplar: ['A'],
                        haritalar: { A: {} }
                    };
                    hasChanges = true;
                    console.log(`${componentId} i√ßin varsayƒ±lan grup verisi olu≈üturuldu`);
                }
                
                const component = grupHaritalari[componentId];
                
                // Groups dizisi yoksa veya bo≈üsa
                if (!component.gruplar || !Array.isArray(component.gruplar) || component.gruplar.length === 0) {
                    component.gruplar = ['A'];
                    hasChanges = true;
                }
                
                // A grubu yoksa ekle
                if (!component.gruplar.includes('A')) {
                    component.gruplar.unshift('A');
                    hasChanges = true;
                }
                
                // Mappings objesi yoksa olu≈ütur
                if (!component.haritalar || typeof component.haritalar !== 'object') {
                    component.haritalar = {};
                    hasChanges = true;
                }
                
                // Her grup i√ßin mapping yoksa olu≈ütur
                component.gruplar.forEach(groupName => {
                    if (!component.haritalar[groupName]) {
                        // A grubunun kopyasƒ±nƒ± olu≈ütur (eƒüer varsa)
                        if (groupName !== 'A' && component.haritalar.A && Object.keys(component.haritalar.A).length > 0) {
                            component.haritalar[groupName] = JSON.parse(JSON.stringify(component.haritalar.A));
                        } else {
                            component.haritalar[groupName] = {};
                        }
                        hasChanges = true;
                        console.log(`${componentId}: ${groupName} grubu i√ßin mapping olu≈üturuldu`);
                    } else if (groupName !== 'A' && Object.keys(component.haritalar[groupName]).length === 0 && 
                              component.haritalar.A && Object.keys(component.haritalar.A).length > 0) {
                        // Eƒüer grup mapping'i bo≈üsa ve A grubunda veri varsa, A'dan kopyala
                        component.haritalar[groupName] = JSON.parse(JSON.stringify(component.haritalar.A));
                        hasChanges = true;
                        console.log(`${componentId}: ${groupName} grubu i√ßin bo≈ü mapping A grubundan kopyalandƒ±`);
                    }
                });
            }
        });
        
        if (hasChanges) {
            console.log('Grup veri yapƒ±sƒ± g√ºncellendi:', grupHaritalari);
        }
        
    } catch (error) {
        console.error('Grup veri doƒürulamasƒ± sƒ±rasƒ±nda hata:', error);
        createDefaultMapping();
    }
}

/**
 * √ñƒürencilere default grup atamasƒ± yapar - HER √ñƒûRENCƒ∞ MUTLAKA Bƒ∞R GRUBA ATANMALI
 */
function assignDefaultGroups() {
    try {
        console.log(`üéØ assignDefaultGroups ba≈ülatƒ±ldƒ±...`);
        
        if (!APP_STATE.studentData || !Array.isArray(APP_STATE.studentData)) {
            console.log(`‚ö†Ô∏è √ñƒürenci verisi yok, i≈ülem atlanƒ±yor`);
            return;
        }
        
        console.log(`üë• ${APP_STATE.studentData.length} √∂ƒürenci kontrol ediliyor...`);
        
        let hasChanges = false;
        let assignedToA = 0;
        let alreadyAssigned = 0;
        
        // Mevcut gruplarƒ± kontrol et - A grubu her zaman ge√ßerli
        const availableGroups = Object.keys(APP_STATE.courseData?.grupHaritalari || {});
        let validGroups = ['A']; // Her zaman A grubu ge√ßerli
        
        if (availableGroups.length > 0) {
            // T√ºm bile≈üenlerin gruplarƒ±nƒ± topla
            const allGroupsSet = new Set(['A']); // A grubu garantili
            
            availableGroups.forEach(componentId => {
                const component = APP_STATE.courseData.grupHaritalari[componentId];
                if (component && component.gruplar && Array.isArray(component.gruplar)) {
                    component.gruplar.forEach(group => {
                        if (group && typeof group === 'string' && group.length === 1) {
                            allGroupsSet.add(group);
                        }
                    });
                }
            });
            
            validGroups = Array.from(allGroupsSet).sort();
        }
        
        console.log(`üìã Ge√ßerli gruplar:`, validGroups);
        
        // T√úM √ñƒûRENCƒ∞LERƒ∞ KONTROL ET VE ATANMAMI≈û OLANLARI A GRUBUNA ATA
        APP_STATE.studentData.forEach((student, index) => {
            const studentInfo = `${student.name} ${student.surname} (${student.studentId})`;
            
            if (!student.grup || student.grup === '' || !validGroups.includes(student.grup)) {
                const oldGroup = student.grup || 'YOK';
                student.grup = 'A'; // Varsayƒ±lan grup A
                hasChanges = true;
                assignedToA++;
                
                console.log(`üîß ${index + 1}. ${studentInfo}: ${oldGroup} ‚Üí A`);
                
                // Bile≈üen bazlƒ± grup atamalarƒ±nƒ± da g√ºncelle
                if (!APP_STATE.studentComponentGroups) {
                    APP_STATE.studentComponentGroups = {};
                }
                if (!APP_STATE.studentComponentGroups[student.studentId]) {
                    APP_STATE.studentComponentGroups[student.studentId] = {};
                }
                
                // Her bile≈üen i√ßin A grubu ata
                availableGroups.forEach(componentId => {
                    APP_STATE.studentComponentGroups[student.studentId][componentId] = 'A';
                });
            } else {
                alreadyAssigned++;
                console.log(`‚úÖ ${index + 1}. ${studentInfo}: Zaten ${student.grup} grubunda`);
            }
        });
        
        // DOƒûRULAMA: Hi√ßbir √∂ƒürenci atanmamƒ±≈ü kalmamalƒ±
        const unassignedStudents = APP_STATE.studentData.filter(s => !s.grup || s.grup === '');
        if (unassignedStudents.length > 0) {
            console.error(`‚ùå HATA: ${unassignedStudents.length} √∂ƒürenci hala atanmamƒ±≈ü!`);
            unassignedStudents.forEach(s => {
                console.error(`  - ${s.name} ${s.surname} (${s.studentId})`);
                s.grup = 'A'; // G√ºvenlik i√ßin A grubuna ata
            });
            hasChanges = true;
        }
        
        // RAPOR
        console.log(`\nüìä GRUP ATAMA RAPORU:`);
        console.log(`   ‚úÖ Zaten atanmƒ±≈ü: ${alreadyAssigned} √∂ƒürenci`);
        console.log(`   üîß A grubuna atanan: ${assignedToA} √∂ƒürenci`);
        console.log(`   üìã Toplam: ${APP_STATE.studentData.length} √∂ƒürenci`);
        
        if (hasChanges) {
            // UI'larƒ± g√ºncelle
            updateStudentTable();
            updateGroupSelectors();
            updateAssessmentView();
            updateAllInlineGroupInputs();
            updateAllMappingDisplays();
            
            console.log(`‚úÖ Grup atamalarƒ± tamamlandƒ±, UI g√ºncellemeleri yapƒ±ldƒ±`);
            showModernToast(`${assignedToA} √∂ƒürenci A grubuna atandƒ±. T√ºm √∂ƒürenciler artƒ±k gruplarda.`, "success");
        } else {
            console.log(`‚úÖ T√ºm √∂ƒürenciler zaten uygun gruplarda, deƒüi≈üiklik gerekmedi`);
        }
        
    } catch (error) {
        console.error("‚ùå Default grup atamasƒ± yapƒ±lƒ±rken hata:", error);
        showModernToast("Grup atamasƒ± sƒ±rasƒ±nda hata olu≈ütu!", "error");
    }
}

/**
 * √ñ√á d√ºzenleme modalƒ±nƒ± g√∂sterme
 */
function showOutcomesEditModal(nodeId) {
    const node = findNodeById(nodeId);
    if (!node) {
        showModernToast("D√ºƒü√ºm bulunamadƒ±!", "error");
        return;
    }
    
    // Modal elementlerini al
    const modal = document.getElementById('outcomesEditModal');
    const activityName = document.getElementById('outcomesActivityName');
    const outcomesTextarea = document.getElementById('outcomesTextarea');
    const outcomesList = document.getElementById('availableOutcomesList');
    
    if (!modal || !activityName || !outcomesTextarea || !outcomesList) {
        showModernToast("Modal elemanlarƒ± bulunamadƒ±!", "error");
        return;
    }
    
    // Modal ba≈ülƒ±ƒüƒ±nƒ± g√ºncelle
    activityName.textContent = `${node.id} - ${node.name}`;
    
    // Mevcut √∂ƒürenme √ßƒ±ktƒ±larƒ±nƒ± textarea'ya y√ºkle
    outcomesTextarea.value = (node.outcomes || []).join(', ');
    
    // Mevcut √∂ƒürenme √ßƒ±ktƒ±larƒ± listesini olu≈ütur
    renderAvailableOutcomes(outcomesList, node.outcomes || []);
    
    // Modal a√ßma butonu event listener'larƒ±nƒ± kur
    setupOutcomesModalEvents(nodeId);
    
    // Modal'ƒ± a√ß
    openModernModal('outcomesEditModal');
}

/**
 * Mevcut √∂ƒürenme √ßƒ±ktƒ±larƒ± listesini render etme
 */
function renderAvailableOutcomes(container, selectedOutcomes = []) {
    container.innerHTML = '';
    
    // T√ºm mevcut √∂ƒürenme √ßƒ±ktƒ±larƒ±nƒ± bul (kod ve a√ßƒ±klama ile)
    const allOutcomes = new Map(); // kod -> {kod, a√ßƒ±klama}
    
    // √ñncelikle APP_STATE.learningOutcomes'dan al (ana veri kaynaƒüƒ±)
    if (APP_STATE.learningOutcomes && APP_STATE.learningOutcomes.length > 0) {
        APP_STATE.learningOutcomes.forEach(outcome => {
            const outcomeCode = outcome.id || outcome.kod || outcome.kodu || outcome;
            const description = outcome.aciklama || outcome.a√ßƒ±klama || outcome.description || outcome.desc || '';
            
            allOutcomes.set(outcomeCode, { 
                kod: outcomeCode, 
                aciklama: description 
            });
        });
    } else {
        // Fallback: APP_STATE.courseData'dan √∂ƒürenme √ßƒ±ktƒ±larƒ±nƒ± topla
        if (APP_STATE.courseData && APP_STATE.courseData.ogrenmeciktorilari) {
            APP_STATE.courseData.ogrenmeciktorilari.forEach(outcome => {
                const outcomeCode = outcome.kod || outcome.kodu || outcome.id || outcome;
                const description = outcome.aciklama || outcome.a√ßƒ±klama || outcome.description || outcome.desc || '';
                
                if (typeof outcome === 'string') {
                    // Eƒüer sadece string ise, kod olarak al
                    allOutcomes.set(outcome, { kod: outcome, aciklama: '' });
                } else {
                    // Object ise kod ve a√ßƒ±klamayƒ± al
                    allOutcomes.set(outcomeCode, { kod: outcomeCode, aciklama: description });
                }
            });
        }
    }
    
    // Assessment tree'den √∂ƒürenme √ßƒ±ktƒ±larƒ±nƒ± topla (sadece eksik olanlar i√ßin)
    function collectOutcomesFromTree(nodes) {
        nodes.forEach(node => {
            if (node.outcomes && Array.isArray(node.outcomes)) {
                node.outcomes.forEach(outcome => {
                    if (!allOutcomes.has(outcome)) {
                        // Tree'den gelen outcome'lar genelde sadece kod
                        allOutcomes.set(outcome, { kod: outcome, aciklama: '' });
                    }
                });
            }
            if (node.children) {
                collectOutcomesFromTree(node.children);
            }
        });
    }
    
    collectOutcomesFromTree(APP_STATE.assessmentTree);
    
    if (allOutcomes.size === 0) {
        container.innerHTML = '<div class="empty-outcomes-message">Hen√ºz √∂ƒürenme √ßƒ±ktƒ±sƒ± tanƒ±mlanmamƒ±≈ü</div>';
        return;
    }
    
    // √ñƒürenme √ßƒ±ktƒ±larƒ±nƒ± kod'a g√∂re sƒ±rala
    const sortedOutcomes = Array.from(allOutcomes.entries()).sort((a, b) => a[0].localeCompare(b[0]));
    
    // Badge'leri olu≈ütur
    sortedOutcomes.forEach(([code, outcomeData]) => {
        const badge = document.createElement('div');
        badge.className = 'outcome-item outcome-badge';
        badge.dataset.outcome = code;
        
        // Badge i√ßeriƒüini olu≈ütur
        const codeSpan = document.createElement('div');
        codeSpan.className = 'outcome-code';
        codeSpan.textContent = outcomeData.kod;
        
        const descSpan = document.createElement('div');
        descSpan.className = 'outcome-description';
        descSpan.textContent = outcomeData.aciklama || 'A√ßƒ±klama yok';
        
        badge.appendChild(codeSpan);
        badge.appendChild(descSpan);
        
        // Eƒüer se√ßili ise i≈üaretle
        if (selectedOutcomes.includes(code)) {
            badge.classList.add('selected');
        }
        
        // Click event listener
        badge.addEventListener('click', () => {
            badge.classList.toggle('selected');
            updateOutcomesTextarea();
        });
        
        container.appendChild(badge);
    });
}

/**
 * Se√ßili √∂ƒürenme √ßƒ±ktƒ±larƒ±nƒ± textarea'ya yansƒ±tma
 */
function updateOutcomesTextarea() {
    const selectedBadges = document.querySelectorAll('.outcome-item.selected');
    const selectedOutcomes = Array.from(selectedBadges).map(badge => badge.dataset.outcome);
    const outcomesTextarea = document.getElementById('outcomesTextarea');
    
    if (outcomesTextarea) {
        outcomesTextarea.value = selectedOutcomes.join(', ');
    }
}

/**
 * √ñ√á modal event listener'larƒ±nƒ± kurma
 */
function setupOutcomesModalEvents(nodeId) {
    const selectAllBtn = document.getElementById('selectAllOutcomes');
    const clearAllBtn = document.getElementById('clearAllOutcomes');
    const randomSelectBtn = document.getElementById('randomSelectOutcomes');
    const saveBtn = document.getElementById('saveOutcomesBtn');
    const outcomesTextarea = document.getElementById('outcomesTextarea');
    
    // √ñnceki event listener'larƒ± temizle
    const newSelectAllBtn = selectAllBtn.cloneNode(true);
    const newClearAllBtn = clearAllBtn.cloneNode(true);
    const newRandomSelectBtn = randomSelectBtn.cloneNode(true);
    const newSaveBtn = saveBtn.cloneNode(true);
    
    selectAllBtn.parentNode.replaceChild(newSelectAllBtn, selectAllBtn);
    clearAllBtn.parentNode.replaceChild(newClearAllBtn, clearAllBtn);
    randomSelectBtn.parentNode.replaceChild(newRandomSelectBtn, randomSelectBtn);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
    
    // T√ºm√ºn√º se√ß
    newSelectAllBtn.addEventListener('click', () => {
        document.querySelectorAll('.outcome-item.outcome-badge').forEach(badge => {
            badge.classList.add('selected');
        });
        updateOutcomesTextarea();
    });
    
    // Temizle
    newClearAllBtn.addEventListener('click', () => {
        document.querySelectorAll('.outcome-item.outcome-badge').forEach(badge => {
            badge.classList.remove('selected');
        });
        updateOutcomesTextarea();
    });
    
    // Rastgele se√ß (2-3 tane)
    newRandomSelectBtn.addEventListener('click', () => {
        // √ñnce t√ºm√ºn√º temizle
        document.querySelectorAll('.outcome-item.outcome-badge').forEach(badge => {
            badge.classList.remove('selected');
        });
        
        const allBadges = Array.from(document.querySelectorAll('.outcome-item.outcome-badge'));
        const randomCount = Math.floor(Math.random() * 2) + 2; // 2-3 tane
        const selectedIndices = [];
        
        while (selectedIndices.length < Math.min(randomCount, allBadges.length)) {
            const randomIndex = Math.floor(Math.random() * allBadges.length);
            if (!selectedIndices.includes(randomIndex)) {
                selectedIndices.push(randomIndex);
                allBadges[randomIndex].classList.add('selected');
            }
        }
        
        updateOutcomesTextarea();
    });
    
    // Textarea deƒüi≈üikliklerini badge'lere yansƒ±t
    outcomesTextarea.addEventListener('input', () => {
        const textValue = outcomesTextarea.value;
        const outcomes = textValue.split(',').map(o => o.trim()).filter(o => o.length > 0);
        
        // T√ºm badge'leri temizle
        document.querySelectorAll('.outcome-badge').forEach(badge => {
            badge.classList.remove('selected');
        });
        
        // Matching badge'leri se√ß
        outcomes.forEach(outcome => {
            const badge = document.querySelector(`.outcome-badge[data-outcome="${outcome}"]`);
            if (badge) {
                badge.classList.add('selected');
            }
        });
    });
    
    // Kaydet
    newSaveBtn.addEventListener('click', () => {
        const textValue = outcomesTextarea.value;
        const outcomes = textValue.split(',').map(o => o.trim()).filter(o => o.length > 0);
        
        const node = findNodeById(nodeId);
        if (node) {
            node.outcomes = outcomes;
            
            // Ana ekrandaki textarea'yƒ± g√ºncelle
            const nodeTextarea = document.querySelector(`.tree-node[data-id="${nodeId}"] .nodeOutcomes`);
            if (nodeTextarea) {
                nodeTextarea.value = outcomes.join(',');
            }
            
            // ALT D√úƒû√úM ƒ∞SE, √úST D√úƒû√úM√úN √ñ√á'LERƒ∞Nƒ∞ G√úNCELLE
            const isSubItem = nodeId.includes('.');
            if (isSubItem) {
                const parentId = nodeId.substring(0, nodeId.lastIndexOf('.'));
                if (parentId) {
                    setTimeout(() => {
                        updateParentOutcomes(parentId);
                        // Ekranƒ± yeniden render et
                        renderTree();
                        updateAssessmentView();
                    }, 100);
                }
            }
            
            // Deƒüerlendirme g√∂r√ºn√ºm√ºn√º g√ºncelle
            updateAssessmentView();
            
            showModernToast("√ñƒürenme √ßƒ±ktƒ±larƒ± ba≈üarƒ±yla g√ºncellendi!", "success");
            closeModernModal('outcomesEditModal');
        }
    });
}

// =====================================================
// COLLAPSE/EXPAND FONKSƒ∞YONLARI
// =====================================================

/**
 * B√∂l√ºm√º collapse/expand yapma
 * @param {string} sectionId - B√∂l√ºm ID'si
 */
function toggleCollapse(sectionId) {
    const collapseElement = document.getElementById(sectionId + 'Collapse');
    const header = collapseElement.parentElement.querySelector('.collapsible-header');
    
    if (collapseElement.classList.contains('collapsed')) {
        // Expand - dinamik y√ºkseklik hesapla
        collapseElement.style.maxHeight = 'none'; // √ñnce sƒ±nƒ±rsƒ±z yaparak √∂l√ß
        const fullHeight = collapseElement.scrollHeight;
        collapseElement.style.maxHeight = '0px'; // Sonra sƒ±fƒ±ra d√∂nd√ºr
        
        // Animasyon i√ßin kƒ±sa bir gecikme sonra ger√ßek y√ºksekliƒüi ver
        setTimeout(() => {
            collapseElement.style.maxHeight = fullHeight + 'px';
            collapseElement.classList.remove('collapsed');
            header.classList.remove('collapsed');
        }, 10);
    } else {
        // Collapse
        collapseElement.style.maxHeight = '0px';
        collapseElement.classList.add('collapsed');
        header.classList.add('collapsed');
    }
}

/**
 * T√ºm b√∂l√ºmleri expand yapma
 */
function expandAllSections() {
    const collapsibleSections = document.querySelectorAll('.collapsible-content');
    const headers = document.querySelectorAll('.collapsible-header');
    
    collapsibleSections.forEach(section => {
        // Dinamik y√ºkseklik hesapla
        section.style.maxHeight = 'none';
        const fullHeight = section.scrollHeight;
        section.style.maxHeight = fullHeight + 'px';
        section.classList.remove('collapsed');
    });
    
    headers.forEach(header => {
        header.classList.remove('collapsed');
    });
}

/**
 * T√ºm b√∂l√ºmleri collapse yapma
 */
function collapseAllSections() {
    const collapsibleSections = document.querySelectorAll('.collapsible-content');
    const headers = document.querySelectorAll('.collapsible-header');
    
    collapsibleSections.forEach(section => {
        section.style.maxHeight = '0px';
        section.classList.add('collapsed');
    });
    
    headers.forEach(header => {
        header.classList.add('collapsed');
    });
}

// Mevcut fonksiyonlarƒ± global hale getir
window.updateStudentGroup = updateStudentGroup;
window.showGroupMappingModal = showGroupMappingModal;
window.removeMappingRow = removeMappingRow;
window.applyBulkMapping = applyBulkMapping;
window.applyInlineGroupMapping = applyInlineGroupMapping;
window.showOutcomesEditModal = showOutcomesEditModal;
/**
 * Sayfa y√ºklendiƒüinde doƒüru y√ºkseklikleri ayarlama
 */
function initializeCollapsibleSections() {
    const collapsibleSections = document.querySelectorAll('.collapsible-content:not(.collapsed)');
    
    collapsibleSections.forEach(section => {
        // A√ßƒ±k olan b√∂l√ºmlerin doƒüru y√ºksekliƒüini ayarla
        const fullHeight = section.scrollHeight;
        section.style.maxHeight = fullHeight + 'px';
    });
}

// Sayfa y√ºklendiƒüinde ve i√ßerik deƒüi≈ütiƒüinde √ßalƒ±≈ütƒ±r
document.addEventListener('DOMContentLoaded', initializeCollapsibleSections);

// ResizeObserver ile i√ßerik deƒüi≈üikliklerini izle
if (window.ResizeObserver) {
    const resizeObserver = new ResizeObserver(() => {
        // A√ßƒ±k olan b√∂l√ºmlerin y√ºksekliƒüini yeniden hesapla
        const openSections = document.querySelectorAll('.collapsible-content:not(.collapsed)');
        openSections.forEach(section => {
            const fullHeight = section.scrollHeight;
            section.style.maxHeight = fullHeight + 'px';
        });
    });

    // T√ºm collapsible section'larƒ± izle
    setTimeout(() => {
        document.querySelectorAll('.collapsible-content').forEach(section => {
            resizeObserver.observe(section);
        });
    }, 100);
}

window.toggleCollapse = toggleCollapse;
window.expandAllSections = expandAllSections;
window.collapseAllSections = collapseAllSections;
window.initializeCollapsibleSections = initializeCollapsibleSections;

// ============================================================================
// Sƒ∞STEM TEST ƒ∞≈ûLEMLERƒ∞
// ============================================================================

/**
 * Rastgele deƒüerlendirme bile≈üeni ekleme
 */
function generateRandomAssessment() {
    try {
        console.log('üé≤ Rastgele deƒüerlendirme olu≈üturuluyor...');
        
        // Yarƒ±yƒ±l i√ßi mi yarƒ±yƒ±l sonu mu belirle (ger√ßek√ßi daƒüƒ±lƒ±m)
        const isTermActivity = Math.random() > 0.25; // %75 yarƒ±yƒ±l i√ßi, %25 yarƒ±yƒ±l sonu
        
        // Ger√ßek√ßi deƒüerlendirme t√ºrleri
        const realisticTypes = {
            term: [
                { name: 'Ara Sƒ±nav', weight: [25, 35], points: 100, hasSubItems: true, subTypes: ['Soru', 'Test'] },
                { name: 'Quiz', weight: [5, 15], points: 100, hasSubItems: false },
                { name: 'Ev √ñdevi', weight: [10, 20], points: 100, hasSubItems: true, subTypes: ['Soru', 'Rubrik'] },
                { name: 'Laboratuvar', weight: [15, 25], points: 100, hasSubItems: true, subTypes: ['Rubrik', 'Soru'] },
                { name: 'Proje', weight: [20, 30], points: 100, hasSubItems: true, subTypes: ['Rubrik'] },
                { name: 'Sunum', weight: [10, 20], points: 100, hasSubItems: true, subTypes: ['Rubrik'] },
                { name: 'Rapor', weight: [15, 25], points: 100, hasSubItems: true, subTypes: ['Rubrik'] }
            ],
            final: [
                { name: 'Final Sƒ±navƒ±', weight: [80, 100], points: 100, hasSubItems: true, subTypes: ['Soru', 'Test'] },
                { name: 'B√ºt√ºnleme Sƒ±navƒ±', weight: [80, 100], points: 100, hasSubItems: true, subTypes: ['Soru', 'Test'] },
                { name: 'Final Projesi', weight: [70, 90], points: 100, hasSubItems: true, subTypes: ['Rubrik'] }
            ]
        };
        
        const availableTypes = isTermActivity ? realisticTypes.term : realisticTypes.final;
        const randomTypeInfo = availableTypes[Math.floor(Math.random() * availableTypes.length)];
        
        // Mevcut aktiviteleri say ve doƒüru ID formatƒ±nƒ± olu≈ütur
        const existingActivities = APP_STATE.assessmentTree.filter(node => 
            isTermActivity ? node.id.startsWith('A') : node.id.startsWith('F')
        );
        const nextNumber = existingActivities.length + 1;
        const newId = isTermActivity ? `A${nextNumber}` : `F${nextNumber}`;
        
        // Mevcut √∂ƒürenme √ßƒ±ktƒ±larƒ±nƒ± kullan (varsa)
        let selectedOutcomes = [];
        if (APP_STATE.learningOutcomes && APP_STATE.learningOutcomes.length > 0) {
            const numOutcomes = Math.floor(Math.random() * 3) + 1; // 1-3 arasƒ±
            const shuffledOutcomes = [...APP_STATE.learningOutcomes].sort(() => Math.random() - 0.5);
            selectedOutcomes = shuffledOutcomes.slice(0, numOutcomes).map(outcome => outcome.id);
        } else {
            // Varsayƒ±lan √∂ƒürenme √ßƒ±ktƒ±larƒ± (ger√ßek√ßi)
            const defaultOutcomes = ['√ñ√á.1', '√ñ√á.2', '√ñ√á.3', '√ñ√á.4', '√ñ√á.5', '√ñ√á.6'];
            const numOutcomes = Math.floor(Math.random() * 3) + 2; // 2-4 arasƒ±
            const shuffledOutcomes = [...defaultOutcomes].sort(() => Math.random() - 0.5);
            selectedOutcomes = shuffledOutcomes.slice(0, numOutcomes);
        }
        
        // Ger√ßek√ßi aƒüƒ±rlƒ±k ve puan hesaplama
        const weightRange = randomTypeInfo.weight;
        const weight = Math.floor(Math.random() * (weightRange[1] - weightRange[0] + 1)) + weightRange[0];
        
        let points;
        if (Array.isArray(randomTypeInfo.points)) {
            points = Math.floor(Math.random() * (randomTypeInfo.points[1] - randomTypeInfo.points[0] + 1)) + randomTypeInfo.points[0];
        } else {
            points = randomTypeInfo.points;
        }
        
        console.log(`  üìã ${randomTypeInfo.name} olu≈üturuluyor - Aƒüƒ±rlƒ±k: ${weight}%, Puan: ${points}`);
        
        // Yeni aktivite olu≈ütur - mevcut sistem formatƒ±nda
        const newActivity = {
            id: newId,
            name: randomTypeInfo.name,
            type: randomTypeInfo.name,
            weight: weight,
            points: points,
            outcomes: selectedOutcomes,
            description: isTermActivity ? 
                `Yarƒ±yƒ±l i√ßi ${randomTypeInfo.name.toLowerCase()} deƒüerlendirmesi` : 
                `Yarƒ±yƒ±l sonu ${randomTypeInfo.name.toLowerCase()} deƒüerlendirmesi`,
            expanded: true,
            children: []
        };
        
        // Alt bile≈üenler ekle (ger√ßek√ßi yakla≈üƒ±m)
        if (randomTypeInfo.hasSubItems) {
            let numSubItems;
            let subTypes = randomTypeInfo.subTypes;
            
            // Deƒüerlendirme t√ºr√ºne g√∂re alt bile≈üen sayƒ±sƒ±
            if (randomTypeInfo.name.includes('Sƒ±nav')) {
                numSubItems = Math.floor(Math.random() * 4) + 3; // 3-6 soru/test
            } else if (randomTypeInfo.name === 'Quiz') {
                numSubItems = Math.floor(Math.random() * 3) + 2; // 2-4 soru
            } else if (randomTypeInfo.name.includes('Proje')) {
                numSubItems = Math.floor(Math.random() * 3) + 2; // 2-4 rubrik
            } else {
                numSubItems = Math.floor(Math.random() * 3) + 2; // 2-4 bile≈üen
            }
            
            console.log(`    üîπ ${numSubItems} alt bile≈üen ekleniyor...`);
            
            for (let i = 0; i < numSubItems; i++) {
                // Alt bile≈üen t√ºr√ºn√º ger√ßek√ßi ≈üekilde se√ß
                const subType = subTypes[Math.floor(Math.random() * subTypes.length)];
                
                // Ger√ßek√ßi alt bile≈üen isimleri
                let subName;
                if (subType === 'Soru') {
                    const questionTypes = ['√áoktan Se√ßmeli', 'A√ßƒ±k U√ßlu', 'Kƒ±sa Cevaplƒ±', 'Problem', 'Analiz'];
                    subName = `${questionTypes[Math.floor(Math.random() * questionTypes.length)]} Soru ${i + 1}`;
                } else if (subType === 'Test') {
                    subName = `Test B√∂l√ºm√º ${i + 1}`;
                } else if (subType === 'Rubrik') {
                    const rubricTypes = ['Deƒüerlendirme', 'Analiz', 'Sunum', 'Rapor', 'Kod Kalitesi'];
                    subName = `${rubricTypes[Math.floor(Math.random() * rubricTypes.length)]} Rubriƒüi`;
                } else {
                    subName = `${subType} ${i + 1}`;
                }
                
                const subItem = {
                    id: `${newId}.${i + 1}`,
                    name: subName,
                    type: subType,
                    weight: Math.floor(100 / numSubItems), // E≈üit aƒüƒ±rlƒ±k daƒüƒ±lƒ±mƒ±
                    points: Math.floor(points / numSubItems),
                    outcomes: selectedOutcomes.length > 0 ? 
                        [selectedOutcomes[Math.floor(Math.random() * selectedOutcomes.length)]] : [],
                    description: `${subName} i√ßin deƒüerlendirme kriteri`,
                    expanded: false,
                    children: []
                };
                
                // Test i√ßin ger√ßek√ßi detaylar ekle
                if (subType === 'Test') {
                    const questionCount = Math.floor(Math.random() * 20) + 10; // 10-30 soru
                    subItem.testDetails = {
                        totalQuestions: questionCount,
                        correctWeight: Math.floor(Math.random() * 3) + 3, // 3-5 puan
                        wrongPenalty: -(Math.floor(Math.random() * 2) + 1) // -1 veya -2 puan
                    };
                    console.log(`      üß™ Test: ${questionCount} soru, +${subItem.testDetails.correctWeight}/${subItem.testDetails.wrongPenalty} puan`);
                }
                
                newActivity.children.push(subItem);
                console.log(`      ‚úÖ ${subName} (${subItem.points} puan)`);
            }
            
            // Alt bile≈üenlerin aƒüƒ±rlƒ±klarƒ±nƒ± normalize et
            const totalWeight = newActivity.children.reduce((sum, child) => sum + child.weight, 0);
            if (totalWeight !== 100) {
                newActivity.children.forEach(child => {
                    child.weight = Math.round((child.weight / totalWeight) * 100);
                });
            }
        }
        
        // Assessment tree'ye doƒüru sƒ±rada ekle
        if (isTermActivity) {
            // Yarƒ±yƒ±l i√ßi etkinlikleri ba≈üa ekle
            const termActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('A'));
            const finalActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('F'));
            termActivities.push(newActivity);
            APP_STATE.assessmentTree = [...termActivities, ...finalActivities];
        } else {
            // Yarƒ±yƒ±l sonu etkinlikleri sona ekle
            APP_STATE.assessmentTree.push(newActivity);
        }
        
        // Se√ßili d√ºƒü√ºm√º yeni aktivite yap
        selectNode(newActivity);
        
        // Yeni eklenen sorularƒ± t√ºm gruplara farklƒ± sƒ±ralarda ata
        if (APP_STATE.courseData && APP_STATE.courseData.grupHaritalari) {
            const activeGroups = Object.keys(APP_STATE.courseData.grupHaritalari);
            if (activeGroups.length > 0 && newActivity.children && newActivity.children.length > 0) {
                // Yeni aktivitedeki sorularƒ± topla
                const newQuestions = newActivity.children.filter(child => child.type === 'Soru');
                
                if (newQuestions.length > 0) {
                    // Her grup i√ßin t√ºm sorularƒ± farklƒ± sƒ±ralarda ata
                    activeGroups.forEach((groupName, groupIndex) => {
                        console.log(`\nYeni sorular Grup ${groupName} i√ßin sƒ±ralanƒ±yor:`);
                        
                        // Yeni sorularƒ± kopyala ve karƒ±≈ütƒ±r
                        const shuffledQuestions = [...newQuestions];
                        
                        // Her grup i√ßin farklƒ± karƒ±≈ütƒ±rma
                        for (let i = 0; i < groupIndex + 1; i++) {
                            for (let j = shuffledQuestions.length - 1; j > 0; j--) {
                                const k = Math.floor(Math.random() * (j + 1));
                                [shuffledQuestions[j], shuffledQuestions[k]] = [shuffledQuestions[k], shuffledQuestions[j]];
                            }
                        }
                        
                        // Grup haritasƒ±nƒ± g√ºncelle
                        if (!APP_STATE.courseData.grupHaritalari[groupName][newId]) {
                            APP_STATE.courseData.grupHaritalari[groupName][newId] = [];
                        }
                        
                        // T√ºm yeni sorularƒ± bu gruba ata (karƒ±≈ütƒ±rƒ±lmƒ±≈ü sƒ±rada)
                        shuffledQuestions.forEach((question, index) => {
                            APP_STATE.courseData.grupHaritalari[groupName][newId].push(question.id);
                            console.log(`  ${index + 1}. ${question.name} (${question.id})`);
                        });
                    });
                }
            }
        }
        
        // UI'larƒ± g√ºncelle
        renderTree();
        updateAssessmentView();
        updateCategoryWeights();
        updateTreeMappingControls();
        updateAllInlineGroupInputs();
        updateAllMappingDisplays();
        
        // √ñƒürenci grup bilgilerini g√ºncelle
        updateStudentGroupInfoDisplay();
        
        console.log('‚úÖ Rastgele deƒüerlendirme ba≈üarƒ±yla eklendi:', newActivity);
        showModernToast(`üìù ${randomTypeInfo.name} deƒüerlendirmesi eklendi! (${newId})`, "success");
        
    } catch (error) {
        console.error("‚ùå Rastgele deƒüerlendirme olu≈üturulurken hata:", error);
        showModernToast("Rastgele deƒüerlendirme olu≈üturulamadƒ±!", "error");
    }
}

/**
 * üßπ Deƒüerlendirmeleri Temizle
 */
function clearAssessments() {
    console.log("üîç clearAssessments fonksiyonu √ßaƒürƒ±ldƒ±");
    try {
        // √ñnce silinecek veri var mƒ± kontrol et
        if (!APP_STATE.assessmentTree || APP_STATE.assessmentTree.length === 0) {
            console.log("‚ÑπÔ∏è Silinecek deƒüerlendirme bile≈üeni bulunmuyor");
            showModernToast("‚ÑπÔ∏è Silinecek deƒüerlendirme bile≈üeni bulunmuyor.", "info");
            return;
        }
        
        console.log("üìã showModernConfirm √ßaƒürƒ±lƒ±yor...");
        showModernConfirm(
            "Deƒüerlendirme Bile≈üenlerini Sil",
            "T√ºm deƒüerlendirme bile≈üenleri silinecek. Bu i≈ülem geri alƒ±namaz. Emin misiniz?",
            {
                confirmText: 'Evet, Sil',
                cancelText: 'ƒ∞ptal',
                confirmClass: 'btn-modern-danger',
                cancelClass: 'btn-modern-secondary'
            }
        ).then((confirmed) => {
            if (confirmed) {
                console.log("‚úÖ Onay verildi, performClearAssessments √ßaƒürƒ±lƒ±yor");
                performClearAssessments();
            } else {
                console.log('üë§ Kullanƒ±cƒ± deƒüerlendirme bile≈üenlerini silmeyi iptal etti');
                showModernToast('‚ùå Deƒüerlendirme bile≈üenlerini silme iptal edildi', 'info', 2000);
            }
        });
    } catch (error) {
        console.error("‚ùå Deƒüerlendirmeler temizlenirken hata:", error);
        showModernToast("Deƒüerlendirmeler temizlenemedi!", "error");
    }
}

function performClearAssessments() {
    try {
        console.log("üîß performClearAssessments ba≈ülatƒ±ldƒ±");
        
        // 1. Deƒüerlendirme aƒüacƒ±nƒ± temizle
        APP_STATE.assessmentTree = [];
        APP_STATE.selectedNode = null;
        
        // 2. ƒ∞LGƒ∞Lƒ∞ PUANLARI DA TEMƒ∞ZLE (Baƒüƒ±mlƒ±lƒ±k √ß√∂z√ºm√º)
        console.log("üîó Deƒüerlendirmelerle ilgili puanlar da temizleniyor...");
        APP_STATE.gradesData = {};
        APP_STATE.testScores = {};
        
        // 3. Grup haritalamalarƒ±nƒ± temizle (deƒüerlendirme yok ise grup da anlamsƒ±z)
        if (APP_STATE.courseData) {
            APP_STATE.courseData.grupHaritalari = {};
        }
        
        // 4. UI'larƒ± g√ºncelle
        renderTree();
        updateAssessmentView();
        updateCategoryWeights();
        
        // 5. G√ºvenli UI g√ºncellemeleri
        if (typeof updateTreeMappingControls === 'function') {
        updateTreeMappingControls();
        }
        if (typeof updateAllInlineGroupInputs === 'function') {
        updateAllInlineGroupInputs();
        }
        
        // 6. Not tablolarƒ±nƒ± temizle
        const gradesTableContainer = document.getElementById('gradesTableContainer');
        if (gradesTableContainer) {
            gradesTableContainer.innerHTML = '<p class="empty-message">Hen√ºz not hesaplanmadƒ±.</p>';
        }
        
        // 7. √ñƒürenci grup bilgilerini g√ºncelle
        updateStudentGroupInfoDisplay();
        
        showModernToast("üóëÔ∏è T√ºm deƒüerlendirme bile≈üenleri ve ilgili puanlar temizlendi!", "success");
        
    } catch (error) {
        console.error("‚ùå Deƒüerlendirmeler temizlenirken hata:", error);
        showModernToast("Deƒüerlendirmeler temizlenemedi!", "error");
    }
}

/**
 * üßπ Gruplarƒ± Temizle
 */
function clearGroups() {
    try {
        // √ñnce silinecek veri var mƒ± kontrol et
        if (!APP_STATE.courseData || !APP_STATE.courseData.grupHaritalari || Object.keys(APP_STATE.courseData.grupHaritalari).length === 0) {
            showModernToast("‚ÑπÔ∏è Silinecek grup verisi bulunmuyor.", "info");
            return;
        }
        
        showModernConfirm(
            "A Grubu Hari√ß T√ºm Gruplarƒ± Sil",
            "A grubu hari√ß t√ºm grup haritalama verileri silinecek. A grubundaki sorular 1'den ba≈ülayarak sƒ±ralƒ± hale getirilecek. Bu i≈ülem geri alƒ±namaz. Emin misiniz?",
            {
                confirmText: 'Evet, Sil',
                cancelText: 'ƒ∞ptal',
                confirmClass: 'btn-modern-danger',
                cancelClass: 'btn-modern-secondary'
            }
        ).then((confirmed) => {
            if (confirmed) {
                performClearGroups();
            } else {
                console.log('üë§ Kullanƒ±cƒ± grup verilerini silmeyi iptal etti');
                showModernToast('‚ùå Grup verilerini silme iptal edildi', 'info', 2000);
            }
        });
    } catch (error) {
        console.error("Gruplar temizlenirken hata:", error);
        showModernToast("Gruplar temizlenemedi!", "error");
    }
}

function performClearGroups() {
    try {
        console.log("üîß performClearGroups ba≈ülatƒ±ldƒ± - A grubu korunacak");
        
        // 1. A grubu hari√ß t√ºm grup haritalamalarƒ±nƒ± temizle ve A grubunu yeniden d√ºzenle
        if (APP_STATE.courseData && APP_STATE.courseData.grupHaritalari) {
            const assessmentComponents = Object.keys(APP_STATE.courseData.grupHaritalari);
            
            // Her deƒüerlendirme bile≈üeni i√ßin A grubunu koru, diƒüerlerini sil
            assessmentComponents.forEach(componentId => {
                // A grubunu koru, diƒüer gruplarƒ± sil
                APP_STATE.courseData.grupHaritalari[componentId] = {
                    gruplar: ['A'],
                    haritalar: {
                        'A': {}
                    }
                };
                
                // A grubu i√ßin sorularƒ± 1'den ba≈ülayarak sƒ±ralƒ± ata
                const component = APP_STATE.assessmentTree.find(item => item.id === componentId);
                if (component && component.children) {
                    const aGroupMapping = {};
                    let questionIndex = 1;
                    
                    // √áocuk √∂ƒüeleri (sorular/rubrikler) i√ßin sƒ±ralƒ± numara ata
                    // D√úZELTME: Veri yapƒ±sƒ± {position: questionId} formatƒ±nda olmalƒ±
                    component.children.forEach(child => {
                        aGroupMapping[questionIndex.toString()] = child.id;
                        questionIndex++;
                    });
                    
                    APP_STATE.courseData.grupHaritalari[componentId].haritalar['A'] = aGroupMapping;
                    
                    console.log(`üìù ${componentId} bile≈üeni A grubu: ${Object.keys(aGroupMapping).length} soru sƒ±ralƒ± hale getirildi`);
                }
            });
        }
        
        // 2. T√ºm √∂ƒürencileri A grubuna ata
        if (APP_STATE.studentData) {
            APP_STATE.studentData.forEach(student => {
                student.grup = 'A';
            });
        }
        
        // 3. GRUP DEƒûƒ∞≈ûƒ∞KLƒ∞ƒûƒ∞ PUANLARI ETKƒ∞LEYEBƒ∞Lƒ∞R - Uyarƒ± ver
        const hasGrades = (APP_STATE.gradesData && Object.keys(APP_STATE.gradesData).length > 0) ||
                         (APP_STATE.testScores && Object.keys(APP_STATE.testScores).length > 0);
        
        if (hasGrades) {
            console.log("‚ö†Ô∏è Grup deƒüi≈üikliƒüi mevcut puanlarƒ± etkileyebilir");
            showModernToast("‚ö†Ô∏è Grup haritalama temizlendi. Mevcut puanlar grup deƒüi≈üikliƒüinden etkilenebilir!", "warning", 6000);
        }
        
        // 4. UI'larƒ± g√ºvenli ≈üekilde g√ºncelle
        console.log("üîÑ UI g√ºncellemeleri ba≈ülatƒ±lƒ±yor...");
        
        // Ana tree'yi yeniden render et (grup textarea'larƒ± i√ßin kritik)
        renderTree();
        
        // Grup se√ßicilerini g√ºncelle
        if (typeof updateGroupSelectors === 'function') {
        updateGroupSelectors();
        }
        
        // √ñƒürenci tablosunu g√ºncelle
        updateStudentTable();
        
        // Tree mapping kontrollerini g√ºncelle
        if (typeof updateTreeMappingControls === 'function') {
        updateTreeMappingControls();
        }
        
        // Inline grup input'larƒ±nƒ± g√ºncelle
        if (typeof updateAllInlineGroupInputs === 'function') {
        updateAllInlineGroupInputs();
        }
        
        // Mapping g√∂r√ºn√ºmlerini g√ºncelle
        if (typeof updateAllMappingDisplays === 'function') {
        updateAllMappingDisplays();
        }
        
        // Deƒüerlendirme g√∂r√ºn√ºm√ºn√º g√ºncelle
        updateAssessmentView();
        
        console.log("‚úÖ UI g√ºncellemeleri tamamlandƒ±");
        
        showModernToast("‚úÖ A grubu korundu, diƒüer gruplar temizlendi! A grubundaki sorular 1'den ba≈ülayarak sƒ±ralƒ± hale getirildi.", "success");
        
    } catch (error) {
        console.error("‚ùå Gruplar temizlenirken hata:", error);
        showModernToast("Gruplar temizlenemedi!", "error");
    }
}

/**
 * üßπ Puanlarƒ± Temizle
 */
function clearScores() {
    try {
        // √ñnce silinecek veri var mƒ± kontrol et
        const hasGrades = APP_STATE.gradesData && Object.keys(APP_STATE.gradesData).length > 0;
        const hasTestScores = APP_STATE.testScores && Object.keys(APP_STATE.testScores).length > 0;
        
        if (!hasGrades && !hasTestScores) {
            showModernToast("‚ÑπÔ∏è Silinecek puan verisi bulunmuyor.", "info");
            return;
        }
        
        showModernConfirm(
            "√ñƒürenci Puanlarƒ±nƒ± Sil",
            "T√ºm √∂ƒürenci puanlarƒ± silinecek. Bu i≈ülem geri alƒ±namaz. Emin misiniz?",
            {
                confirmText: 'Evet, Sil',
                cancelText: 'ƒ∞ptal',
                confirmClass: 'btn-modern-danger',
                cancelClass: 'btn-modern-secondary'
            }
        ).then((confirmed) => {
            if (confirmed) {
                performClearScores();
            } else {
                console.log('üë§ Kullanƒ±cƒ± √∂ƒürenci puanlarƒ±nƒ± silmeyi iptal etti');
                showModernToast('‚ùå √ñƒürenci puanlarƒ±nƒ± silme iptal edildi', 'info', 2000);
            }
        });
    } catch (error) {
        console.error("Puanlar temizlenirken hata:", error);
        showModernToast("Puanlar temizlenemedi!", "error");
    }
}

function performClearScores() {
    try {
        console.log("üîß performClearScores ba≈ülatƒ±ldƒ± - Puanlar sƒ±fƒ±rlanacak");
        
        // 1. Puanlarƒ± sƒ±fƒ±rla (silmek yerine 0 yap)
        if (APP_STATE.studentData && APP_STATE.studentData.length > 0) {
            APP_STATE.studentData.forEach(student => {
                const studentId = student.ogrenciNo || student.id;
                
                // Her √∂ƒürenci i√ßin mevcut puanlarƒ± sƒ±fƒ±rla
                if (APP_STATE.gradesData[studentId]) {
                    Object.keys(APP_STATE.gradesData[studentId]).forEach(assessmentId => {
                        if (typeof APP_STATE.gradesData[studentId][assessmentId] === 'object') {
                            // Alt sorular i√ßin her birini sƒ±fƒ±rla
                            Object.keys(APP_STATE.gradesData[studentId][assessmentId]).forEach(subId => {
                                APP_STATE.gradesData[studentId][assessmentId][subId] = 0;
                            });
                        } else {
                            // Direkt puan ise sƒ±fƒ±rla
                            APP_STATE.gradesData[studentId][assessmentId] = 0;
                        }
                    });
                }
                
                // Test skorlarƒ±nƒ± da sƒ±fƒ±rla
                if (APP_STATE.testScores && APP_STATE.testScores[studentId]) {
                    Object.keys(APP_STATE.testScores[studentId]).forEach(testId => {
                        if (typeof APP_STATE.testScores[studentId][testId] === 'object') {
                            // Test detaylarƒ± i√ßin
                            if (APP_STATE.testScores[studentId][testId].correct !== undefined) {
                                APP_STATE.testScores[studentId][testId].correct = 0;
                                APP_STATE.testScores[studentId][testId].wrong = 0;
                                APP_STATE.testScores[studentId][testId].empty = APP_STATE.testScores[studentId][testId].total || 0;
                                APP_STATE.testScores[studentId][testId].score = 0;
                            }
                        } else {
                            APP_STATE.testScores[studentId][testId] = 0;
                        }
                    });
                }
            });
            
            console.log("‚úÖ Mevcut puanlar sƒ±fƒ±rlandƒ±");
        } else {
            // √ñƒürenci yoksa bo≈ü objeler olu≈ütur
        APP_STATE.gradesData = {};
        APP_STATE.testScores = {};
            console.log("‚ÑπÔ∏è √ñƒürenci bulunamadƒ±, puanlar temizlendi");
        }
        
        // 2. UI'larƒ± G√úVENLƒ∞ ≈ûEKƒ∞LDE g√ºncelle
        console.log("üîÑ UI g√ºncellemeleri ba≈ülatƒ±lƒ±yor...");
        
        // Deƒüerlendirme giri≈üi sekmesini yeniden render et
        updateAssessmentView();
        
        // Deƒüerlendirme tablosunu manuel olarak yeniden olu≈ütur
        setTimeout(() => {
            console.log("üîÑ Deƒüerlendirme tablosu yeniden olu≈üturuluyor...");
            
            // Deƒüerlendirme container'ƒ±nƒ± tamamen temizle ve yeniden olu≈ütur
            const assessmentContainer = document.getElementById('assessmentContainer');
            if (assessmentContainer) {
                console.log("üóëÔ∏è Deƒüerlendirme container'ƒ± temizleniyor...");
                assessmentContainer.innerHTML = '<p class="empty-message">Deƒüerlendirme tablosu yeniden olu≈üturuluyor...</p>';
            }
            
            // Deƒüerlendirme giri≈üi sekmesini zorla g√ºncelle
            updateAssessmentView();
            
            // √ñƒürenci filtresini de g√ºncelle
            const assessmentStudentFilter = document.getElementById('assessmentStudentFilter');
            if (assessmentStudentFilter) {
                const currentValue = assessmentStudentFilter.value;
                // Filtreyi tetikle
                assessmentStudentFilter.dispatchEvent(new Event('change'));
            }
        }, 100);
        
        // 3. Not tablosunu g√ºvenli g√ºncelleme
        try {
            // Sƒ±fƒ±rlanmƒ±≈ü puanlarla tabloyu g√ºncelle
            updateGradesTable();
        } catch (tableError) {
            console.warn("‚ö†Ô∏è Not tablosu g√ºncellenirken hata (g√∂rmezden gelindi):", tableError);
        }
        
        // 4. SADECE √ñƒûRENCI PUANLARINI ITERATIF OLARAK SIFIRLA
        setTimeout(() => {
            console.log("üîÑ √ñƒürenci puanlarƒ± iteratif olarak sƒ±fƒ±rlanƒ±yor...");
            
            // Her √∂ƒürenci i√ßin t√ºm puanlarƒ± sƒ±fƒ±rla (veri modelinde)
            if (APP_STATE.studentData && APP_STATE.studentData.length > 0) {
                APP_STATE.studentData.forEach((student, studentIndex) => {
                    const studentId = student.ogrenciNo || student.id;
                    console.log(`üìù ${studentIndex + 1}. √∂ƒürenci (${studentId}) puanlarƒ± sƒ±fƒ±rlanƒ±yor...`);
                    
                    // √ñƒürencinin t√ºm deƒüerlendirme puanlarƒ±nƒ± sƒ±fƒ±rla
                    if (APP_STATE.gradesData[studentId]) {
                        Object.keys(APP_STATE.gradesData[studentId]).forEach(assessmentId => {
                            const oldValue = APP_STATE.gradesData[studentId][assessmentId];
                            APP_STATE.gradesData[studentId][assessmentId] = 0;
                            console.log(`  ‚úÖ ${assessmentId}: ${oldValue} ‚Üí 0`);
                        });
                    }
                    
                    // √ñƒürencinin test skorlarƒ±nƒ± da sƒ±fƒ±rla
                    if (APP_STATE.testScores[studentId]) {
                        Object.keys(APP_STATE.testScores[studentId]).forEach(testId => {
                            const oldValue = APP_STATE.testScores[studentId][testId];
                            APP_STATE.testScores[studentId][testId] = 0;
                            console.log(`  ‚úÖ Test ${testId}: ${oldValue} ‚Üí 0`);
                        });
                    }
                });
                
                console.log(`‚úÖ ${APP_STATE.studentData.length} √∂ƒürencinin puanlarƒ± ba≈üarƒ±yla sƒ±fƒ±rlandƒ±`);
            } else {
                console.log("‚ÑπÔ∏è √ñƒürenci bulunamadƒ±, sadece veri yapƒ±larƒ± temizlendi");
            }
            
        }, 300);
        
        // 5. G√ú√áL√ú GUI G√úNCELLEMESƒ∞ - √áoklu zamanlƒ± g√ºncelleme
        setTimeout(() => {
            console.log("üîÑ Final g√ºncelleme - deƒüerlendirme tablosu g√º√ßl√º g√ºncelleme ba≈ülatƒ±lƒ±yor...");
            
            // √áoklu g√ºncelleme dalgasƒ±
            updateAssessmentView();
            
            // Container'ƒ± temizle ve yeniden olu≈ütur
            const assessmentContainer = document.getElementById('assessmentContainer');
            if (assessmentContainer) {
                console.log("üóëÔ∏è Assessment container temizleniyor ve yeniden olu≈üturuluyor...");
                assessmentContainer.innerHTML = '<p class="empty-message">Deƒüerlendirme tablosu g√ºncelleniyor...</p>';
                
                // Hemen ardƒ±ndan yeniden olu≈ütur
                setTimeout(() => {
                    updateAssessmentView();
                }, 50);
            }
            
            // T√ºm input'lara 0 deƒüerini zorla uygula
            setTimeout(() => {
                const allInputs = document.querySelectorAll('#assessmentContainer input[type="number"]');
                allInputs.forEach((input, index) => {
                    // Sadece √∂ƒürenci puan input'larƒ±nƒ± g√ºncelle (readonly veya disabled olmayanlarƒ±)
                    if (!input.readOnly && !input.disabled) {
                        const inputId = input.id || '';
                        const inputName = input.name || '';
                        
                        // Maksimum puan input'larƒ±nƒ± atla
                        if (!inputId.includes('max') && !inputId.includes('total') && 
                            !inputId.includes('limit') && !inputId.includes('point') &&
                            !inputName.includes('max') && !inputName.includes('total') && 
                            !inputName.includes('limit') && !inputName.includes('point')) {
                            
                            input.value = '0';
                            input.dispatchEvent(new Event('input', { bubbles: true }));
                            console.log(`üîÑ Input ${index + 1} g√ºncellendi: ${inputId || inputName} ‚Üí 0`);
                        }
                    }
                });
            }, 100);
            
        }, 500);
        
        // 6. NOTLARI VE HESAPLAMALARI YENƒ∞DEN HESAPLA (SEKME DEƒûƒ∞≈ûTƒ∞RMEDEN)
        setTimeout(() => {
            console.log("üßÆ Puanlar sƒ±fƒ±rlandƒ±ktan sonra t√ºm hesaplamalar yeniden yapƒ±lƒ±yor (sekme korunacak)...");
            
            // Mevcut aktif sekmeyi kaydet
            const currentActiveTab = document.querySelector('.nav-tab.active');
            const currentActiveContent = document.querySelector('.nav-content.active');
            console.log("üíæ Mevcut aktif sekme kaydedildi:", currentActiveTab?.getAttribute('data-tab'));
            
            // Not hesaplama fonksiyonunu sekme korumalƒ± √ßaƒüƒ±r
            if (typeof calculateGrades === 'function') {
                console.log("üßÆ calculateGrades √ßaƒürƒ±lƒ±yor (sekme korumalƒ±)...");
                
                // Sekme ge√ßi≈üini engelleyen kapsamlƒ± wrapper fonksiyon
                const originalShowTab = window.showTab;
                const originalSwitchTab = window.switchTab;
                const originalActivateTab = window.activateTab;
                const originalShowGradesTab = window.showGradesTab;
                const originalSwitchToGrades = window.switchToGrades;
                const originalActivateGradesTab = window.activateGradesTab;
                
                // T√ºm sekme fonksiyonlarƒ±nƒ± ge√ßici olarak devre dƒ±≈üƒ± bƒ±rak
                window.showTab = function() { console.log("üö´ showTab engellendi"); };
                window.switchTab = function() { console.log("üö´ switchTab engellendi"); };
                window.activateTab = function() { console.log("üö´ activateTab engellendi"); };
                window.showGradesTab = function() { console.log("üö´ showGradesTab engellendi"); };
                window.switchToGrades = function() { console.log("üö´ switchToGrades engellendi"); };
                window.activateGradesTab = function() { console.log("üö´ activateGradesTab engellendi"); };
                
                // Click event'lerini de ge√ßici olarak engelle
                const tabElements = document.querySelectorAll('.nav-tab');
                const originalClickHandlers = [];
                tabElements.forEach((tab, index) => {
                    originalClickHandlers[index] = tab.onclick;
                    tab.onclick = function(e) { 
                        e.preventDefault(); 
                        e.stopPropagation(); 
                        console.log("üö´ Tab click engellendi:", tab.getAttribute('data-tab')); 
                        return false;
                    };
                });
                
                try {
                    // Hesaplama yap
                    calculateGrades();
                    console.log("‚úÖ Notlar ba≈üarƒ±yla yeniden hesaplandƒ± (sekme korumalƒ±)");
    } catch (error) {
                    console.error("‚ùå calculateGrades hatasƒ±:", error);
                } finally {
                    // T√ºm sekme fonksiyonlarƒ±nƒ± geri y√ºkle
                    if (originalShowTab) window.showTab = originalShowTab;
                    if (originalSwitchTab) window.switchTab = originalSwitchTab;
                    if (originalActivateTab) window.activateTab = originalActivateTab;
                    if (originalShowGradesTab) window.showGradesTab = originalShowGradesTab;
                    if (originalSwitchToGrades) window.switchToGrades = originalSwitchToGrades;
                    if (originalActivateGradesTab) window.activateGradesTab = originalActivateGradesTab;
                    
                    // Click handler'larƒ± geri y√ºkle
                    tabElements.forEach((tab, index) => {
                        tab.onclick = originalClickHandlers[index];
                    });
                    
                    console.log("üîÑ T√ºm sekme fonksiyonlarƒ± ve event handler'lar geri y√ºklendi");
                }
                
                // Hesaplama sonrasƒ± sekmeyi zorla geri d√∂nd√ºr
                if (currentActiveTab && currentActiveContent) {
                    // T√ºm sekmeleri pasif yap
                    document.querySelectorAll('.nav-tab').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    document.querySelectorAll('.nav-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // Orijinal sekmeyi geri getir
                    currentActiveTab.classList.add('active');
                    currentActiveContent.classList.add('active');
                    console.log("üîÑ Orijinal sekme zorla geri getirildi");
                }
            } else {
                console.log("‚ö†Ô∏è calculateGrades fonksiyonu bulunamadƒ±");
            }
            
            // Deƒüerlendirme tablosundaki hesaplamalarƒ± da yenile
            if (typeof updateAssessmentCalculations === 'function') {
                updateAssessmentCalculations();
                console.log("‚úÖ Deƒüerlendirme hesaplamalarƒ± g√ºncellendi");
            }
            
            // T√ºm input hesaplamalarƒ±nƒ± zorla yenile
            const assessmentContainer = document.getElementById('assessmentContainer');
            if (assessmentContainer) {
                const allInputs = assessmentContainer.querySelectorAll('input[type="number"]');
                allInputs.forEach(input => {
                    // Input event'lerini tetikle
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                    input.dispatchEvent(new Event('change', { bubbles: true }));
                });
                console.log(`‚úÖ ${allInputs.length} input hesaplamasƒ± tetiklendi`);
            }
            
            // Notlar sekmesini g√ºncelle (ama sekme deƒüi≈ütirme)
            updateGradesTable();
            
            // Tekrar sekmeyi kontrol et ve d√ºzelt
            setTimeout(() => {
                if (currentActiveTab && currentActiveContent) {
                    // T√ºm sekmeleri pasif yap
                    document.querySelectorAll('.nav-tab').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    document.querySelectorAll('.nav-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // Orijinal sekmeyi geri getir
                    currentActiveTab.classList.add('active');
                    currentActiveContent.classList.add('active');
                    console.log("üîÑ Sekme tekrar d√ºzeltildi");
                }
            }, 50);
            
            // ƒ∞statistikleri g√ºncelle
            if (typeof updateModernStats === 'function') {
                updateModernStats();
            }
            if (typeof updatePassFailCounts === 'function') {
                updatePassFailCounts();
            }
            
            // Deƒüerlendirme giri≈üini bir kez daha g√ºncelle
            setTimeout(() => {
                updateAssessmentView();
                console.log("üîÑ Deƒüerlendirme giri≈üi son kez g√ºncellendi");
                
                // T√ºm satƒ±rlardaki hesaplama fonksiyonlarƒ±nƒ± zorla tetikle
                setTimeout(() => {
                    const assessmentRows = document.querySelectorAll('#assessmentContainer tr');
                    assessmentRows.forEach((row, index) => {
                        // Her satƒ±rdaki input'larƒ± bul ve hesaplama event'lerini tetikle
                        const inputs = row.querySelectorAll('input[type="number"]');
                        inputs.forEach(input => {
                            if (!input.readOnly && !input.disabled) {
                                // Hesaplama fonksiyonlarƒ±nƒ± tetikle
                                input.dispatchEvent(new Event('blur', { bubbles: true }));
                                input.dispatchEvent(new Event('focusout', { bubbles: true }));
                            }
                        });
                    });
                    console.log(`üîÑ ${assessmentRows.length} satƒ±r hesaplamasƒ± tetiklendi`);
                }, 50);
                
            }, 100);
            
        }, 600);

        // 7. ZORLA DERS TANIMLAMA SEKMESƒ∞NDE KAL
        setTimeout(() => {
            console.log("üìç ZORLA Ders Tanƒ±mlama sekmesinde tutuluyor...");
            
            // Ders Tanƒ±mlama sekmesini zorla aktif yap
            const definitionTab = document.querySelector('[data-tab="definition"]');
            const definitionContent = document.getElementById('definition-content');
            
            if (definitionTab && definitionContent) {
                // T√ºm sekmeleri pasif yap
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelectorAll('.nav-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // Ders Tanƒ±mlama sekmesini zorla aktif yap
                definitionTab.classList.add('active');
                definitionContent.classList.add('active');
                
                console.log("‚úÖ ZORLA Ders Tanƒ±mlama sekmesi aktif edildi");
                
                // Bir kez daha kontrol et ve zorla d√ºzelt
                setTimeout(() => {
                    if (!definitionTab.classList.contains('active')) {
                        // T√ºm sekmeleri pasif yap
                        document.querySelectorAll('.nav-tab').forEach(tab => {
                            tab.classList.remove('active');
                        });
                        document.querySelectorAll('.nav-content').forEach(content => {
                            content.classList.remove('active');
                        });
                        
                        // Ders Tanƒ±mlama sekmesini tekrar zorla aktif yap
                        definitionTab.classList.add('active');
                        definitionContent.classList.add('active');
                        console.log("üîÑ Ders Tanƒ±mlama sekmesi TEKRAR zorla aktif edildi");
                    }
                }, 100);
                
                // 900ms sonra son kontrol ve Notlar sekmesi kapama
                setTimeout(() => {
                    const gradesTab = document.querySelector('.nav-tab[data-tab="grades"]');
                    const gradesContent = document.querySelector('#grades-content');
                    
                    // Eƒüer hala Notlar sekmesi aktifse zorla d√ºzelt
                    if (gradesTab?.classList.contains('active') || gradesContent?.classList.contains('active')) {
                        console.log("‚ö†Ô∏è 900ms sonra Notlar sekmesi hala aktif! Zorla d√ºzeltiliyor...");
                        
                        // Notlar sekmesini kapat
                        gradesTab?.classList.remove('active');
                        gradesContent?.classList.remove('active');
                        
                        // Ders Tanƒ±mlama sekmesini a√ß
                        definitionTab?.classList.add('active');
                        definitionContent?.classList.add('active');
                        
                        console.log("üîß Sekme zorla d√ºzeltildi (900ms)");
                    } else {
                        console.log("‚úÖ Sekme durumu doƒüru (900ms)");
                    }
                }, 900);
                
            } else {
                console.log("‚ö†Ô∏è Ders Tanƒ±mlama sekmesi bulunamadƒ±");
            }
            
        }, 800);

        showModernToast("üîÑ T√ºm √∂ƒürenci puanlarƒ± sƒ±fƒ±rlandƒ± ve notlar yeniden hesaplandƒ±! Maksimum puanlar korundu, sadece alƒ±nan puanlar 0 yapƒ±ldƒ±.", "success");
        
    } catch (error) {
        console.error("‚ùå Puanlar sƒ±fƒ±rlanƒ±rken hata:", error);
        showModernToast("Puanlar sƒ±fƒ±rlanamadƒ±!", "error");
    }
}

/**
 * üßπ √ñƒürencileri Temizle
 */
function clearStudentsOnly() {
    try {
        showModernConfirm(
            "√ñƒürenci Listesini Sil",
            "T√ºm √∂ƒürenci listesi silinecek. Bu i≈ülem geri alƒ±namaz. Emin misiniz?",
            function() {
                // Onay verildiƒüinde √ßalƒ±≈üacak kod
                performClearStudentsOnly();
            }
        );
    } catch (error) {
        console.error("√ñƒürenciler temizlenirken hata:", error);
        showModernToast("√ñƒürenciler temizlenemedi!", "error");
    }
}

function performClearStudentsOnly() {
    try {
        
        APP_STATE.studentData = [];
        APP_STATE.selectedStudentId = null;
        
        // √ñƒürenci verilerine baƒülƒ± puanlarƒ± da temizle
        APP_STATE.gradesData = {};
        APP_STATE.testScores = {};
        
        // UI'larƒ± g√ºncelle
        updateStudentTable();
        // updateStudentSelector fonksiyonu kaldƒ±rƒ±ldƒ± (√ñƒürenci Bazlƒ± Not Giri≈üi sekmesi ile birlikte)
        updateAssessmentView();
        
        // √ñƒürenci bazlƒ± not giri≈üi sekmesini temizle
        const studentGradesContainer = document.getElementById('studentGradesContainer');
        if (studentGradesContainer) {
            studentGradesContainer.innerHTML = '<p class="empty-message">Veri bulunamadƒ±.</p>';
        }
        
        showModernToast("üóëÔ∏è T√ºm √∂ƒürenci listesi temizlendi!", "success");
        
    } catch (error) {
        console.error("√ñƒürenciler temizlenirken hata:", error);
        showModernToast("√ñƒürenciler temizlenemedi!", "error");
    }
}

/**
 * üîÑ Sistemi Resetle
 */
function resetSystem() {
    try {
        showModernConfirm(
            "‚ö†Ô∏è Sƒ∞STEMƒ∞ TAMAMEN RESETLE",
            "T√úM VERƒ∞LER Sƒ∞Lƒ∞NECEK! Bu i≈ülem geri alƒ±namaz. Sistem tamamen sƒ±fƒ±rlanacak. Devam etmek istediƒüinizden emin misiniz?",
            function() {
                // Onay verildiƒüinde √ßalƒ±≈üacak kod
                performResetSystem();
            }
        );
    } catch (error) {
        console.error("Sistem resetlenirken hata:", error);
        showModernToast("Sistem resetlenemedi!", "error");
    }
}

function performResetSystem() {
    try {
        
        // T√ºm verileri sƒ±fƒ±rla
        APP_STATE.studentData = [];
        APP_STATE.assessmentTree = [];
        APP_STATE.gradesData = {};
        APP_STATE.testScores = {};
        APP_STATE.courseData = {
            grupHaritalari: {}
        };
        APP_STATE.selectedNode = null;
        APP_STATE.selectedStudentId = null;
        APP_STATE.learningOutcomes = [];
        APP_STATE.programOutcomes = [];
        
        // UI'larƒ± tamamen yenile
        updateStudentTable();
        // updateStudentSelector fonksiyonu kaldƒ±rƒ±ldƒ± (√ñƒürenci Bazlƒ± Not Giri≈üi sekmesi ile birlikte)
        renderTree();
        updateGroupSelectors();
        updateAssessmentView();
        updateCategoryWeights();
        updateTreeMappingControls();
        updateAllInlineGroupInputs();
        updateAllMappingDisplays();
        
        // T√ºm containers'ƒ± temizle
        const containers = [
            'studentGradesContainer',
            'assessmentContainer',
            'gradesTableContainer',
            'courseDetailsContainer',
            'outcomesContainer',
            'programOutcomesContainer',
            'outcomeMatrixContainer'
        ];
        
        containers.forEach(containerId => {
            const container = document.getElementById(containerId);
            if (container) {
                if (containerId === 'courseDetailsContainer') {
                    container.innerHTML = '<div class="details-empty-message">Ders detaylarƒ± i√ßin JSON y√ºkleyin.</div>';
                } else if (containerId === 'outcomesContainer') {
                    container.innerHTML = '<div class="outcomes-empty-message">Hen√ºz √∂ƒürenme √ßƒ±ktƒ±sƒ± eklenmedi.</div>';
                } else if (containerId === 'programOutcomesContainer') {
                    container.innerHTML = '<div class="outcomes-empty-message">Hen√ºz program √ßƒ±ktƒ±sƒ± eklenmedi.</div>';
                } else if (containerId === 'outcomeMatrixContainer') {
                    container.innerHTML = '<div class="matrix-empty-message">Hen√ºz ili≈üki matrisi olu≈üturulmadƒ±.</div>';
                } else {
                    container.innerHTML = '<p class="empty-message">Veri bulunamadƒ±.</p>';
                }
            }
        });
        
        // Tree container'ƒ± √∂zel mesajla
        const treeContainer = document.getElementById('treeContainer');
        if (treeContainer) {
            treeContainer.innerHTML = '<div class="tree-empty-message">Hen√ºz deƒüerlendirme bile≈üeni eklenmedi. Ders JSON y√ºkleyin veya yeni bile≈üenler ekleyin.</div>';
        }
        
        showModernToast("üîÑ Sistem tamamen sƒ±fƒ±rlandƒ±! Temiz bir ba≈ülangƒ±√ß yapabilirsiniz.", "success", 5000);
        
    } catch (error) {
        console.error("Sistem resetlenirken hata:", error);
        showModernToast("Sistem resetlenemedi!", "error");
    }
}

/**
 * Rastgele gruplar olu≈üturma ve soru-grup e≈üle≈ütirmesi
 */
/**
 * Rastgele grup olu≈üturma (Onay ile)
 */
function generateRandomGroups() {
    console.log('üöÄ generateRandomGroups() fonksiyonu ba≈ülatƒ±ldƒ±');
    console.log('üìä DEBUG: APP_STATE kontrol√º yapƒ±lƒ±yor...');
    
    // Mevcut grup verilerini kontrol et
    const hasExistingGroups = APP_STATE.courseData && APP_STATE.courseData.grupHaritalari && 
        Object.keys(APP_STATE.courseData.grupHaritalari).length > 0;
    const hasExistingAssessments = APP_STATE.assessmentTree && APP_STATE.assessmentTree.length > 0;
    const studentCount = APP_STATE.studentData ? APP_STATE.studentData.length : 0;
    
    console.log('üìä DEBUG: Durum Kontrol√º:');
    console.log('  - APP_STATE.courseData:', !!APP_STATE.courseData);
    console.log('  - APP_STATE.courseData.grupHaritalari:', !!APP_STATE.courseData?.grupHaritalari);
    console.log('  - hasExistingGroups:', hasExistingGroups);
    console.log('  - APP_STATE.assessmentTree length:', APP_STATE.assessmentTree?.length || 0);
    console.log('  - hasExistingAssessments:', hasExistingAssessments);
    console.log('  - APP_STATE.studentData length:', APP_STATE.studentData?.length || 0);
    console.log('  - studentCount:', studentCount);
    
    const minSlider = document.getElementById('groupMinSlider');
    const maxSlider = document.getElementById('groupMaxSlider');
    const minGroups = minSlider ? parseInt(minSlider.value) : 1;
    const maxGroups = maxSlider ? parseInt(maxSlider.value) : 2;
    
    console.log('üéöÔ∏è DEBUG: Slider Deƒüerleri:');
    console.log('  - minSlider element:', !!minSlider);
    console.log('  - maxSlider element:', !!maxSlider);
    console.log('  - minGroups:', minGroups);
    console.log('  - maxGroups:', maxGroups);
    
    let warningMessage = '';
    
    if (!hasExistingAssessments) {
        console.log('‚ùå DEBUG: Deƒüerlendirme bile≈üeni bulunamadƒ±!');
        console.log('   - APP_STATE.assessmentTree:', APP_STATE.assessmentTree);
        warningMessage = 'Hen√ºz deƒüerlendirme bile≈üeni bulunmuyor. √ñnce yarƒ±yƒ±l i√ßi veya yarƒ±yƒ±l sonu etkinlikleri olu≈üturun.';
        showModernToast(warningMessage, 'warning');
        return;
    }
    
    if (studentCount === 0) {
        warningMessage = `${minGroups}-${maxGroups} arasƒ±nda rastgele grup olu≈üturulacak (√∂ƒürenci verisi yok, sadece yapƒ± olu≈üturulacak).\n\nDevam etmek istediƒüinizden emin misiniz?`;
    } else if (hasExistingGroups) {
        const existingGroupCount = Object.keys(APP_STATE.courseData.grupHaritalari).length;
        warningMessage = `Mevcut ${existingGroupCount} deƒüerlendirme bile≈üeninin grup haritalarƒ± deƒüi≈üecek. ${studentCount} √∂ƒürenci i√ßin ${minGroups}-${maxGroups} arasƒ±nda yeni grup d√ºzeni olu≈üturulacak.\n\nMevcut grup haritalama verileri kaybolacak. Devam etmek istediƒüinizden emin misiniz?`;
    } else {
        warningMessage = `${studentCount} √∂ƒürenci i√ßin ${minGroups}-${maxGroups} arasƒ±nda rastgele grup olu≈üturulacak.\n\nBu i≈ülem geri alƒ±namaz. Devam etmek istediƒüinizden emin misiniz?`;
    }
    
    showModernConfirm(
        'üé≤ Rastgele √ñƒürenci Gruplarƒ± Olu≈ütur',
        warningMessage,
        {
            confirmText: 'Evet, Olu≈ütur',
            cancelText: 'ƒ∞ptal',
            confirmClass: 'btn-modern-primary',
            cancelClass: 'btn-modern-secondary',
            headerClass: 'warning-action',
            iconClass: 'warning'
        }
    ).then((result) => {
        console.log('üîç Modal sonucu:', result);
        if (result) {
            console.log('‚úÖ Kullanƒ±cƒ± onayladƒ±, executeGenerateRandomGroups √ßaƒürƒ±lƒ±yor...');
            executeGenerateRandomGroups();
        } else {
            console.log('‚ùå Kullanƒ±cƒ± iptal etti');
            showModernToast('‚ùå Rastgele √∂ƒürenci gruplarƒ± olu≈üturma iptal edildi', 'info', 2000);
        }
    });
}

/**
 * Rastgele grup olu≈üturma (Ger√ßek i≈ülem)
 */
function executeGenerateRandomGroups() {
    console.log('üéØ executeGenerateRandomGroups() fonksiyonu ba≈ülatƒ±ldƒ±');
    console.log('üìä DEBUG: Ana i≈ülem ba≈ülƒ±yor, t√ºm kontroller yapƒ±lacak...');
    
    try {
        // Dual range slider'dan min ve max grup sayƒ±larƒ±nƒ± al
        const minSlider = document.getElementById('groupMinSlider');
        const maxSlider = document.getElementById('groupMaxSlider');
        let minGroups = minSlider ? parseInt(minSlider.value) : 1;
        let maxGroups = maxSlider ? parseInt(maxSlider.value) : 2;
        
        console.log('üéöÔ∏è DEBUG: executeGenerateRandomGroups - Slider Deƒüerleri:');
        console.log('  - minSlider element:', !!minSlider, minSlider?.value);
        console.log('  - maxSlider element:', !!maxSlider, maxSlider?.value);
        console.log('  - minGroups (parsed):', minGroups);
        console.log('  - maxGroups (parsed):', maxGroups);
        
        // √ñƒürenci sayƒ±sƒ±nƒ± kontrol et
        const studentCount = APP_STATE.studentData ? APP_STATE.studentData.length : 0;
        
        console.log('üë• DEBUG: √ñƒürenci Verileri:');
        console.log('  - APP_STATE.studentData:', !!APP_STATE.studentData);
        console.log('  - studentCount:', studentCount);
        if (APP_STATE.studentData && APP_STATE.studentData.length > 0) {
            console.log('  - ƒ∞lk √∂ƒürenci √∂rneƒüi:', APP_STATE.studentData[0]);
        }
        
        // UYARI: √ñƒürenci sayƒ±sƒ±ndan fazla grup olu≈üturma kontrol√º
        if (minGroups > studentCount && studentCount > 0) {
            showModernToast(`‚ö†Ô∏è Uyarƒ±: Minimum grup sayƒ±sƒ± (${minGroups}) √∂ƒürenci sayƒ±sƒ±ndan (${studentCount}) fazla! Maksimum ${studentCount} grup olu≈üturulabilir.`, "warning");
            return;
        }
        
        if (maxGroups > studentCount && studentCount > 0) {
            showModernToast(`‚ö†Ô∏è Uyarƒ±: Maksimum grup sayƒ±sƒ± (${maxGroups}) √∂ƒürenci sayƒ±sƒ±ndan (${studentCount}) fazla! En fazla ${studentCount} grup olu≈üturulabilir.`, "warning");
            // Maksimum grup sayƒ±sƒ±nƒ± √∂ƒürenci sayƒ±sƒ± ile sƒ±nƒ±rla
            maxGroups = Math.min(maxGroups, studentCount);
            maxSlider.value = maxGroups;
            document.getElementById('groupMaxValue').textContent = maxGroups;
        }
        
        // Aralƒ±ktan rastgele bir grup sayƒ±sƒ± se√ß (√∂ƒürenci sayƒ±sƒ± ile sƒ±nƒ±rlƒ±)
        const effectiveMaxGroups = Math.min(maxGroups, studentCount || 20); // √ñƒürenci yoksa 20 ile sƒ±nƒ±rla
        const requestedGroupCount = Math.floor(Math.random() * (effectiveMaxGroups - minGroups + 1)) + minGroups;
        
        const groupNames = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T'];
        
        // Mevcut grup haritalarƒ±nƒ± temizle ama her zaman A grubu olacak
        if (!APP_STATE.courseData) {
            APP_STATE.courseData = {};
        }
        APP_STATE.courseData.grupHaritalari = {};
        
        console.log('üîç DEBUG: Ana deƒüerlendirme bile≈üenlerini bulma i≈ülemi ba≈ülatƒ±ldƒ±');
        console.log('  - APP_STATE.assessmentTree:', APP_STATE.assessmentTree);
        console.log('  - assessmentTree length:', APP_STATE.assessmentTree?.length || 0);
        
        // Ana deƒüerlendirme bile≈üenlerini bul (A1, A2, F1 vb.)
        const mainComponents = APP_STATE.assessmentTree.filter(node => 
            node.id.startsWith('A') || node.id.startsWith('F')
        );
        
        console.log('üîç DEBUG: Ana bile≈üen filtreleme sonucu:');
        console.log('  - mainComponents length:', mainComponents.length);
        console.log('  - mainComponents:', mainComponents);
        if (mainComponents.length > 0) {
            mainComponents.forEach((comp, index) => {
                console.log(`    ${index + 1}. ${comp.id} - ${comp.name} (${comp.type})`);
                console.log(`       children length: ${comp.children?.length || 0}`);
            });
        }
        
        if (mainComponents.length === 0) {
            console.log('‚ùå DEBUG: Ana bile≈üen bulunamadƒ±!');
            showModernToast("√ñnce deƒüerlendirme bile≈üenleri olu≈üturun!", "warning");
            return;
        }
        
        console.log(`üìä DEBUG: Ana bile≈üenler:`, mainComponents.map(c => c.id));
        console.log(`üë• DEBUG: √ñƒürenci sayƒ±sƒ±: ${studentCount}`);
        const rangeText = minGroups === maxGroups ? `${minGroups}` : `${minGroups}-${effectiveMaxGroups}`;
        console.log(`üéØ DEBUG: Grup aralƒ±ƒüƒ±: ${rangeText}, Se√ßilen grup sayƒ±sƒ±: ${requestedGroupCount}`);
        
        // T√ºm gruplarƒ± toplamak i√ßin - her zaman A grubu dahil
        const allGroupsSet = new Set(['A']); // A grubu her zaman var
        const componentGroupData = {};
        if (studentCount === 0) {
            // √ñƒürenci yoksa sadece A grubu ile devam et
            console.log("‚ö†Ô∏è √ñƒürenci verisi yok, sadece A grubu olu≈üturuluyor");
            mainComponents.forEach(component => {
                APP_STATE.courseData.grupHaritalari[component.id] = {
                    gruplar: ['A'],
                    haritalar: { 'A': {} }
                };
            });
            
            // Varsayƒ±lan haritalamayƒ± olu≈ütur
            ensureDefaultGroupExists();
            createDefaultMapping();
            
            // UI g√ºncellemeleri
            updateGroupSelectors();
            updateTreeMappingControls();
            updateAllInlineGroupInputs();
            updateAllMappingDisplays();
            renderTree();
            updateAssessmentView();
            
            showModernToast("Sadece A grubu olu≈üturuldu (√∂ƒürenci verisi yok)", "info");
            return;
        }
        
        // Grup sayƒ±sƒ±nƒ± √∂ƒürenci sayƒ±sƒ± ve istenen sayƒ± ile sƒ±nƒ±rla
        const maxPossibleGroups = Math.min(requestedGroupCount, studentCount, groupNames.length);
        const finalGroupCount = Math.max(1, maxPossibleGroups); // En az 1 grup (A grubu)
        
        console.log(`üë• √ñƒürenci sayƒ±sƒ±: ${studentCount}`);
        console.log(`üéØ ƒ∞stenen grup sayƒ±sƒ±: ${requestedGroupCount}`);
        console.log(`üìä Maksimum m√ºmk√ºn grup sayƒ±sƒ±: ${maxPossibleGroups}`);
        console.log(`‚úÖ Final grup sayƒ±sƒ±: ${finalGroupCount}`);
        
        // Her ana bile≈üen i√ßin uygun grup sayƒ±sƒ± olu≈ütur - √ñƒûRENCƒ∞ SAYISINI A≈ûMAYACAK
        mainComponents.forEach(component => {
            let numGroups, componentGroups;
            
            // Belirlenen grup sayƒ±sƒ±nƒ± kullan
            numGroups = finalGroupCount;
            componentGroups = groupNames.slice(0, numGroups);
            
            console.log(`üìä ${component.id} i√ßin grup bilgileri:`);
            console.log(`   - √ñƒürenci sayƒ±sƒ±: ${studentCount}`);
            console.log(`   - ƒ∞stenen grup sayƒ±sƒ±: ${requestedGroupCount}`);
            console.log(`   - Kullanƒ±lan grup sayƒ±sƒ±: ${numGroups}`);
            
            console.log(`\n=== ${component.id} bile≈üeni i√ßin ${numGroups} grup olu≈üturuluyor: ${componentGroups.join(', ')} ===`);
            
            // Bu bile≈üenin gruplarƒ±nƒ± global grup setine ekle
            componentGroups.forEach(group => allGroupsSet.add(group));
            
            // Bile≈üen grup verisini sakla
            componentGroupData[component.id] = {
                gruplar: [...componentGroups],
                numGroups: numGroups
            };
            
            // Bu bile≈üenin grup yapƒ±sƒ±nƒ± olu≈ütur
            APP_STATE.courseData.grupHaritalari[component.id] = {
                gruplar: [...componentGroups], // Bu bile≈üen i√ßin grup listesi
                haritalar: {}
            };
            
            // Her grup i√ßin mapping objesi olu≈ütur
            componentGroups.forEach(groupName => {
                APP_STATE.courseData.grupHaritalari[component.id].haritalar[groupName] = {};
            });
            
            // Bu bile≈üenin alt sorularƒ±nƒ± topla
            const componentQuestions = [];
            
            function collectComponentQuestions(nodes) {
                nodes.forEach(node => {
                    if (isQuestionType(node.type) || isRubricType(node.type)) {
                        componentQuestions.push({
                            id: node.id,
                            name: node.name || node.type,
                            questionNumber: getQuestionNumberFromActivity(node.id)
                        });
                    }
                    if (node.children && node.children.length > 0) {
                        collectComponentQuestions(node.children);
                    }
                });
            }
            
            if (component.children && component.children.length > 0) {
                collectComponentQuestions(component.children);
            }
            
            console.log(`  ${component.id} sorularƒ±:`, componentQuestions.map(q => q.id));
            
            // HER GRUP ƒ∞√áƒ∞N GARANTƒ∞Lƒ∞ SORU DAƒûILIMI - T√úM SORULAR HER GRUPTA OLMALI
            if (componentQuestions.length > 0) {
                console.log(`üìù ${componentQuestions.length} soru ${componentGroups.length} gruba daƒüƒ±tƒ±lƒ±yor...`);
                
                componentGroups.forEach((groupName, groupIndex) => {
                    console.log(`\nüéØ Grup ${groupName} (${groupIndex + 1}/${componentGroups.length}) i√ßin sƒ±ralama:`);
                    
                    // T√úM SORULARI KOPYALA - Hi√ßbir soru eksik kalmamalƒ±
                    const shuffledQuestions = [...componentQuestions];
                    
                    // HER GRUP ƒ∞√áƒ∞N FARKLI KARI≈ûTIRILMI≈û SIRALAMA
                    // Grup indeksine g√∂re farklƒ± seed ile karƒ±≈ütƒ±rma
                    for (let shuffleRound = 0; shuffleRound <= groupIndex; shuffleRound++) {
                        for (let i = shuffledQuestions.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [shuffledQuestions[i], shuffledQuestions[j]] = [shuffledQuestions[j], shuffledQuestions[i]];
                        }
                    }
                    
                    // DOƒûRULAMA: T√ºm sorular mevcut mu?
                    const originalQuestionIds = componentQuestions.map(q => q.id).sort();
                    const shuffledQuestionIds = shuffledQuestions.map(q => q.id).sort();
                    
                    if (originalQuestionIds.length !== shuffledQuestionIds.length) {
                        console.error(`‚ùå HATA: Grup ${groupName} i√ßin soru sayƒ±sƒ± uyu≈ümuyor!`);
                        console.error(`   Orijinal: ${originalQuestionIds.length}, Karƒ±≈ütƒ±rƒ±lmƒ±≈ü: ${shuffledQuestionIds.length}`);
                    }
                    
                    // Eksik sorularƒ± kontrol et
                    const missingQuestions = originalQuestionIds.filter(id => !shuffledQuestionIds.includes(id));
                    const extraQuestions = shuffledQuestionIds.filter(id => !originalQuestionIds.includes(id));
                    
                    if (missingQuestions.length > 0) {
                        console.error(`‚ùå EKSIK SORULAR (Grup ${groupName}):`, missingQuestions);
                    }
                    if (extraQuestions.length > 0) {
                        console.error(`‚ùå FAZLA SORULAR (Grup ${groupName}):`, extraQuestions);
                    }
                    
                    // SORU HARITASINI OLU≈ûTUR - Her soruya kaƒüƒ±t sƒ±rasƒ± ata
                    // D√úZELTME: Veri yapƒ±sƒ± {position: questionId} formatƒ±nda
                    shuffledQuestions.forEach((question, index) => {
                        const paperOrderNumber = (index + 1).toString();
                        APP_STATE.courseData.grupHaritalari[component.id].haritalar[groupName][paperOrderNumber] = question.id;
                        
                        console.log(`      üìÑ Kaƒüƒ±t sƒ±rasƒ± ${paperOrderNumber}: ${question.id} (${question.name})`);
                    });
                    
                    console.log(`‚úÖ Grup ${groupName}: ${shuffledQuestions.length} soru ba≈üarƒ±yla haritalandƒ±`);
                });
                
                // √áAPRAZ DOƒûRULAMA: T√ºm gruplarda aynƒ± sorular var mƒ±?
                console.log(`\nüîç √áAPRAZ DOƒûRULAMA - T√ºm gruplarda aynƒ± sorular var mƒ±?`);
                // D√úZELTME: Veri yapƒ±sƒ± {position: questionId} formatƒ±nda, values'larƒ± kar≈üƒ±la≈ütƒ±rmalƒ±yƒ±z
                const baseGroupQuestions = Object.values(APP_STATE.courseData.grupHaritalari[component.id].haritalar[componentGroups[0]] || {}).sort();
                
                let allGroupsValid = true;
                componentGroups.forEach(groupName => {
                    const groupQuestions = Object.values(APP_STATE.courseData.grupHaritalari[component.id].haritalar[groupName] || {}).sort();
                    
                    if (JSON.stringify(baseGroupQuestions) !== JSON.stringify(groupQuestions)) {
                        console.error(`‚ùå HATA: Grup ${groupName} farklƒ± sorulara sahip!`);
                        console.error(`   Beklenen: ${baseGroupQuestions}`);
                        console.error(`   Mevcut: ${groupQuestions}`);
                        allGroupsValid = false;
                    } else {
                        console.log(`‚úÖ Grup ${groupName}: T√ºm sorular mevcut (${groupQuestions.length} soru)`);
                    }
                });
                
                if (allGroupsValid) {
                    console.log(`üéâ ${component.id} bile≈üeni: T√ºm gruplarda aynƒ± sorular mevcut!`);
                } else {
                    console.error(`‚ùå ${component.id} bile≈üeni: Grup soru daƒüƒ±lƒ±mƒ±nda hata var!`);
                }
            } else {
                console.log(`‚ÑπÔ∏è ${component.id} bile≈üeninde soru yok (Laboratuvar tipi)`);
            }
        });
        
        // T√ºm gruplarƒ± birle≈ütir (A, B, C, D, E... ≈üeklinde)
        const allGroups = Array.from(allGroupsSet).sort();
        console.log(`\n=== Toplam ${allGroups.length} farklƒ± grup olu≈üturuldu: ${allGroups.join(', ')} ===`);
        
        // AKILLI √ñƒûRENCI GRUP ATAMALARI - HER √ñƒûRENCƒ∞ MUTLAKA Bƒ∞R GRUBA ATANACAK
        if (APP_STATE.studentData && APP_STATE.studentData.length > 0) {
            console.log(`\n=== ${APP_STATE.studentData.length} √∂ƒürenci akƒ±llƒ± ≈üekilde gruplara atanƒ±yor ===`);
            
            // T√ºm √∂ƒürencileri kopyala ve karƒ±≈ütƒ±r
            const students = [...APP_STATE.studentData];
            
            // Fisher-Yates karƒ±≈ütƒ±rma algoritmasƒ± ile √∂ƒürencileri tamamen rastgele sƒ±rala
            for (let i = students.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [students[i], students[j]] = [students[j], students[i]];
            }
            
            // Grup atama saya√ßlarƒ±
            const groupAssignments = {};
            allGroups.forEach(group => {
                groupAssignments[group] = [];
            });
            
            // ROUND-ROBIN ATAMA: Her √∂ƒürenci sƒ±rayla gruplara atanƒ±r
            console.log(`üîÑ Round-robin atama ba≈ülatƒ±lƒ±yor...`);
            students.forEach((student, index) => {
                const groupIndex = index % allGroups.length;
                const assignedGroup = allGroups[groupIndex];
                
                // √ñƒürencinin ana grup bilgisini g√ºncelle
                student.grup = assignedGroup;
                groupAssignments[assignedGroup].push(student);
                
                console.log(`  ${index + 1}. ${student.name} ${student.surname} (${student.studentId}) ‚Üí Grup ${assignedGroup}`);
                
                // Bile≈üen bazlƒ± grup atamalarƒ±nƒ± ba≈ülat
                if (!APP_STATE.studentComponentGroups) {
                    APP_STATE.studentComponentGroups = {};
                }
                if (!APP_STATE.studentComponentGroups[student.studentId]) {
                    APP_STATE.studentComponentGroups[student.studentId] = {};
                }
                
                // Her bile≈üen i√ßin aynƒ± grubu ata (ba≈ülangƒ±√ß deƒüeri olarak)
                mainComponents.forEach(component => {
                    APP_STATE.studentComponentGroups[student.studentId][component.id] = assignedGroup;
                });
            });
            
            // GRUP DAƒûILIMI KONTROL√ú VE RAPORU
            console.log(`\n=== üìä DETAYLI GRUP DAƒûILIMI RAPORU ===`);
            let totalAssigned = 0;
            let emptyGroups = [];
            
            allGroups.forEach(group => {
                const studentsInGroup = groupAssignments[group];
                const studentCount = studentsInGroup.length;
                totalAssigned += studentCount;
                
                if (studentCount === 0) {
                    emptyGroups.push(group);
                    console.log(`‚ùå Grup ${group}: BO≈û GRUP!`);
                } else {
                    console.log(`‚úÖ Grup ${group}: ${studentCount} √∂ƒürenci`);
                    studentsInGroup.forEach((s, idx) => {
                        console.log(`     ${idx + 1}. ${s.name} ${s.surname} (${s.studentId})`);
                    });
                }
            });
            
            // DOƒûRULAMA KONTROLLERI
            console.log(`\n=== üîç DOƒûRULAMA KONTROLLERI ===`);
            console.log(`üìã Toplam √∂ƒürenci sayƒ±sƒ±: ${students.length}`);
            console.log(`üìã Atanan √∂ƒürenci sayƒ±sƒ±: ${totalAssigned}`);
            console.log(`üìã Grup sayƒ±sƒ±: ${allGroups.length}`);
            console.log(`üìã Bo≈ü grup sayƒ±sƒ±: ${emptyGroups.length}`);
            
            // Hata kontrol√º
            if (totalAssigned !== students.length) {
                console.error(`‚ùå HATA: Atanan √∂ƒürenci sayƒ±sƒ± toplam √∂ƒürenci sayƒ±sƒ±na e≈üit deƒüil!`);
                showModernToast("Grup atama hatasƒ±: Bazƒ± √∂ƒürenciler atanmadƒ±!", "error");
                return;
            }
            
            if (emptyGroups.length > 0) {
                console.warn(`‚ö†Ô∏è UYARI: ${emptyGroups.length} bo≈ü grup var: ${emptyGroups.join(', ')}`);
            }
            
            // Atanmayan √∂ƒürenci kontrol√º
            const unassignedStudents = students.filter(s => !s.grup || s.grup === '');
            if (unassignedStudents.length > 0) {
                console.error(`‚ùå HATA: ${unassignedStudents.length} √∂ƒürenci atanmadƒ±!`);
                unassignedStudents.forEach(s => {
                    console.error(`  - ${s.name} ${s.surname} (${s.studentId})`);
                    s.grup = 'A'; // G√ºvenlik i√ßin A grubuna ata
                });
            }
            
            console.log(`‚úÖ T√ºm √∂ƒürenciler ba≈üarƒ±yla gruplara atandƒ±!`);
            
            // UI g√ºncellemeleri
            updateStudentTable();
            updateStudentGroupInfoDisplay();
        }
        
        // Grup sistemini yeniden ba≈ülat
        initializeGroupSystem();
        
        // UI g√ºncellemeleri - sƒ±ra √∂nemli!
        updateGroupSelectors();
        updateTreeMappingControls();
        updateAllInlineGroupInputs(); // Grup haritalama textarea'larƒ±nƒ± g√ºncelle
        updateAllMappingDisplays();
        
        // Tree'yi yeniden render et (grup bilgileri ile)
        renderTree();
        
        // Grup e≈üle≈ütirme renklerini g√ºncelle
        updateGroupMappingColors();
        
        // Deƒüerlendirme bile≈üenlerini en son g√ºncelle (grup alanlarƒ± i√ßin)
        updateAssessmentView();
        
        // Deƒüerlendirme bile≈üenlerindeki grup dropdown'larƒ±nƒ± manuel g√ºncelle
        setTimeout(() => {
            updateAssessmentGroupSelectors();
            // updateStudentSelector fonksiyonu kaldƒ±rƒ±ldƒ± (√ñƒürenci Bazlƒ± Not Giri≈üi sekmesi ile birlikte)
            console.log('Grup dropdown\'larƒ± g√ºncellendi');
        }, 200); // updateAssessmentView'ƒ±n tamamlanmasƒ±nƒ± bekle
        
        // Bile≈üen ba≈üƒ±na grup sayƒ±sƒ±nƒ± ve toplam soru sayƒ±sƒ±nƒ± hesapla
        const componentSummary = mainComponents.map(comp => {
            const componentGroups = componentGroupData[comp.id];
            const questions = [];
            function countQuestions(nodes) {
                nodes.forEach(node => {
                    if (isQuestionType(node.type) || isRubricType(node.type)) {
                        questions.push(node.id);
                    }
                    if (node.children && node.children.length > 0) {
                        countQuestions(node.children);
                    }
                });
            }
            if (comp.children) countQuestions(comp.children);
            return {
                componentId: comp.id,
                groupCount: componentGroups.numGroups,
                questionCount: questions.length
            };
        });
        
        const totalQuestions = componentSummary.reduce((sum, comp) => sum + comp.questionCount, 0);
        const totalUniqueGroups = allGroups.length;
        
        // Detaylƒ± bilgi i√ßin
        const componentDetails = componentSummary.map(comp => 
            `${comp.componentId}: ${comp.groupCount} grup (${comp.questionCount} soru)`
        ).join(', ');
        
        console.log(`\n=== RASTGELE GRUP OLU≈ûTURMA TAMAMLANDI ===`);
        console.log(`Toplam ${totalUniqueGroups} farklƒ± grup: ${allGroups.join(', ')}`);
        console.log(`Bile≈üen detaylarƒ±: ${componentDetails}`);
        console.log(`Toplam ${APP_STATE.studentData?.length || 0} √∂ƒürenci rastgele gruplara atandƒ±`);
        console.log(`üéØ GRUP ATAMALARI TAMAMLANDI`);
        console.log(`APP_STATE.studentComponentGroups:`, APP_STATE.studentComponentGroups);
        
        // Grup daƒüƒ±lƒ±m √∂zetini hazƒ±rla
        const groupDistribution = allGroups.map(group => {
            const studentsInGroup = APP_STATE.studentData.filter(s => s.grup === group);
            return `${group}(${studentsInGroup.length})`;
        }).join(', ');
        
        showModernToast(
            `üé≤ Rastgele grup daƒüƒ±lƒ±mƒ± tamamlandƒ±! (${finalGroupCount} grup)\n` +
            `üìä ${totalUniqueGroups} grup: ${groupDistribution}\n` +
            `üìù ${mainComponents.length} bile≈üende toplam ${totalQuestions} soru e≈üle≈ütirildi\n` +
            `üë• ${APP_STATE.studentData?.length || 0} √∂ƒürenci dengeli daƒüƒ±tƒ±ldƒ±`, 
            "success", 6000
        );
        
        // √ñƒürenci grup bilgilerini g√ºncelle
        updateStudentGroupInfoDisplay();
        
        // Grup istatistiklerini g√ºncelle
        updateGroupStatistics();
        
        // ƒ∞statistikleri g√ºncelle
        updatePassFailCounts();
        
        // Grup slider'larƒ±nƒ±n sƒ±nƒ±rlarƒ±nƒ± g√ºncelle
        updateGroupSliderLimits();
        
    } catch (error) {
        console.error("‚ùå FATAL ERROR: Rastgele gruplar olu≈üturulurken hata:", error);
        console.error("‚ùå ERROR STACK:", error.stack);
        console.error("‚ùå ERROR MESSAGE:", error.message);
        console.error("‚ùå ERROR NAME:", error.name);
        console.error("‚ùå CURRENT APP_STATE:", {
            courseData: APP_STATE.courseData,
            assessmentTree: APP_STATE.assessmentTree,
            studentData: APP_STATE.studentData,
            studentComponentGroups: APP_STATE.studentComponentGroups
        });
        showModernToast("Rastgele gruplar olu≈üturulamadƒ±! Detay i√ßin console'u kontrol edin.", "error");
    }
}

/**
 * Rastgele puanlama yapma (Onay ile)
 */
function generateRandomScores() {
    // Mevcut verileri kontrol et
    const hasStudents = APP_STATE.studentData && APP_STATE.studentData.length > 0;
    const hasAssessments = APP_STATE.assessmentTree && APP_STATE.assessmentTree.length > 0;
    const hasExistingScores = (APP_STATE.gradesData && Object.keys(APP_STATE.gradesData).length > 0) ||
                              (APP_STATE.testScores && Object.keys(APP_STATE.testScores).length > 0);
    
    let warningMessage = '';
    
    if (!hasStudents) {
        warningMessage = '√ñnce √∂ƒürenci listesi y√ºkleyin!';
        showModernToast(warningMessage, 'warning');
        return;
    }
    
    if (!hasAssessments) {
        warningMessage = '√ñnce deƒüerlendirme bile≈üenleri olu≈üturun!';
        showModernToast(warningMessage, 'warning');
        return;
    }
    
    const passRateSlider = document.getElementById('passRateSlider');
    const passRate = passRateSlider ? parseInt(passRateSlider.value) : 70;
    const studentCount = APP_STATE.studentData.length;
    const assessmentCount = APP_STATE.assessmentTree.length;
    
    if (hasExistingScores) {
        const existingScoreCount = Object.keys(APP_STATE.gradesData || {}).length + Object.keys(APP_STATE.testScores || {}).length;
        warningMessage = `Mevcut not verileri silinecek ve yeniden olu≈üturulacak!\n\n${studentCount} √∂ƒürenci i√ßin ${assessmentCount} deƒüerlendirme bile≈üeninde %${passRate} ge√ßme oranƒ±na g√∂re akƒ±llƒ± puanlama yapƒ±lacak.\n\nMevcut ${existingScoreCount} not verisi kaybolacak. Bu i≈ülem geri alƒ±namaz. Devam etmek istediƒüinizden emin misiniz?`;
    } else {
        warningMessage = `${studentCount} √∂ƒürenci i√ßin ${assessmentCount} deƒüerlendirme bile≈üeninde %${passRate} ge√ßme oranƒ±na g√∂re akƒ±llƒ± puanlama yapƒ±lacak.\n\nBu i≈ülem geri alƒ±namaz. Devam etmek istediƒüinizden emin misiniz?`;
    }
    
    showModernConfirm(
        'üß† Akƒ±llƒ± Puanlama Sistemi Uygula',
        warningMessage,
        {
            confirmText: 'Evet, Olu≈ütur',
            cancelText: 'ƒ∞ptal',
            confirmClass: 'btn-modern-primary',
            cancelClass: 'btn-modern-secondary'
        }
    ).then((confirmed) => {
        if (confirmed) {
            executeGenerateRandomScores();
        } else {
            console.log('üë§ Kullanƒ±cƒ± rastgele puanlama yapmayƒ± iptal etti');
            showModernToast('‚ùå Rastgele puanlama iptal edildi', 'info', 2000);
        }
    });
}

/**
 * Rastgele puanlama yapma (Ger√ßek i≈ülem)
 */
function executeGenerateRandomScores() {
    try {
        if (!APP_STATE.studentData || APP_STATE.studentData.length === 0) {
            showModernToast("√ñnce √∂ƒürenci listesi y√ºkleyin!", "warning");
            return;
        }
        
        if (!APP_STATE.assessmentTree || APP_STATE.assessmentTree.length === 0) {
            showModernToast("√ñnce deƒüerlendirme bile≈üenleri olu≈üturun!", "warning");
            return;
        }
        
        // APP_STATE.gradesData'yƒ± ba≈ülat
        if (!APP_STATE.gradesData) {
            APP_STATE.gradesData = {};
        }
        
        // Ge√ßen √∂ƒürenci oranƒ±nƒ± al
        const passRateSlider = document.getElementById('passRateSlider');
        const passRate = passRateSlider ? parseInt(passRateSlider.value) : 70; // Varsayƒ±lan %70
        
        console.log("üéØ Akƒ±llƒ± rastgele puan olu≈üturma ba≈ülatƒ±ldƒ±:");
        console.log("üìä Ge√ßen √∂ƒürenci oranƒ±:", passRate + '%');
        console.log("üë• √ñƒürenci sayƒ±sƒ±:", APP_STATE.studentData.length);
        console.log("üìã Deƒüerlendirme aƒüacƒ±:", APP_STATE.assessmentTree.length);
        
        let scoreCount = 0;
        const totalStudents = APP_STATE.studentData.length;
        
        // Akƒ±llƒ± not daƒüƒ±lƒ±mƒ± - ge√ßen √∂ƒürenci oranƒ±na g√∂re
        const passingStudents = Math.round(totalStudents * passRate / 100);
        const failingStudents = totalStudents - passingStudents;
        
        console.log(`‚úÖ Ge√ßecek √∂ƒürenci: ${passingStudents} (${passRate}%)`);
        console.log(`‚ùå Kalacak √∂ƒürenci: ${failingStudents} (${100-passRate}%)`);
        
        // Ge√ßen √∂ƒürenciler i√ßin not aralƒ±klarƒ± (60-100) - daha ger√ßek√ßi daƒüƒ±lƒ±m
        const passingGrades = [
            { min: 90, max: 100, grade: 'AA', ratio: 0.10 },  // %10 AA
            { min: 85, max: 89, grade: 'BA', ratio: 0.15 },   // %15 BA
            { min: 80, max: 84, grade: 'BB', ratio: 0.25 },   // %25 BB
            { min: 75, max: 79, grade: 'CB', ratio: 0.25 },   // %25 CB
            { min: 70, max: 74, grade: 'CC', ratio: 0.20 },   // %20 CC
            { min: 60, max: 69, grade: 'DC', ratio: 0.05 }    // %5 DC
        ];
        
        // Kalan √∂ƒürenciler i√ßin not aralƒ±klarƒ± (0-59)
        const failingGrades = [
            { min: 50, max: 59, grade: 'DD', ratio: 0.70 },   // %70 DD (50-59)
            { min: 40, max: 49, grade: 'FD', ratio: 0.25 },   // %25 FD (40-49)
            { min: 0, max: 39, grade: 'FF', ratio: 0.05 }     // %5 FF (0-39)
        ];
        
        // √ñƒürencileri karƒ±≈ütƒ±r
        const shuffledStudents = [...APP_STATE.studentData].sort(() => Math.random() - 0.5);
        
        // Her √∂ƒürenci i√ßin hedef not aralƒ±ƒüƒ±nƒ± belirle
        const studentGradeTargets = {};
        let studentIndex = 0;
        
        // Ge√ßen √∂ƒürencileri daƒüƒ±t
        for (const gradeInfo of passingGrades) {
            const studentsForThisGrade = Math.round(passingStudents * gradeInfo.ratio);
            for (let i = 0; i < studentsForThisGrade && studentIndex < totalStudents; i++) {
                if (studentIndex < shuffledStudents.length) {
                    studentGradeTargets[shuffledStudents[studentIndex].studentId] = gradeInfo;
                    studentIndex++;
                }
            }
        }
        
        // Kalan ge√ßen √∂ƒürencileri CC'ye ata
        while (studentIndex < passingStudents && studentIndex < totalStudents) {
            studentGradeTargets[shuffledStudents[studentIndex].studentId] = passingGrades[4]; // CC
            studentIndex++;
        }
        
        // Kalan √∂ƒürencileri (kalanlar) daƒüƒ±t
        for (const gradeInfo of failingGrades) {
            const studentsForThisGrade = Math.round(failingStudents * gradeInfo.ratio);
            for (let i = 0; i < studentsForThisGrade && studentIndex < totalStudents; i++) {
                if (studentIndex < shuffledStudents.length) {
                    studentGradeTargets[shuffledStudents[studentIndex].studentId] = gradeInfo;
                    studentIndex++;
                }
            }
        }
        
        // Kalan √∂ƒürencileri DD'ye ata
        while (studentIndex < totalStudents) {
            studentGradeTargets[shuffledStudents[studentIndex].studentId] = failingGrades[0]; // DD
            studentIndex++;
        }
        
        // Her √∂ƒürenci i√ßin hedef nota uygun puanlar olu≈ütur
        console.log("üéØ Hedef not daƒüƒ±lƒ±mƒ± √∂rnekleri:", Object.entries(studentGradeTargets).slice(0, 5).map(([id, grade]) => `${id}: ${grade.grade} (${grade.min}-${grade.max})`));
        
        APP_STATE.studentData.forEach(student => {
            const targetGrade = studentGradeTargets[student.studentId];
            
            APP_STATE.assessmentTree.forEach(activity => {
                if (activity.children && activity.children.length > 0) {
                    // Alt bile≈üenler varsa onlara puan ver
                    activity.children.forEach(subItem => {
                        if (subItem.type === 'Test' && subItem.testDetails) {
                            // Test i√ßin doƒüru/yanlƒ±≈ü sayƒ±sƒ± - hedef nota g√∂re ayarla
                            const totalQuestions = subItem.testDetails.totalQuestions;
                            const targetPercentage = (targetGrade.min + Math.random() * (targetGrade.max - targetGrade.min)) / 100;
                            const correct = Math.floor(totalQuestions * targetPercentage);
                            const remaining = totalQuestions - correct;
                            const wrong = Math.floor(Math.random() * remaining);
                            
                            if (!APP_STATE.testScores) APP_STATE.testScores = {};
                            if (!APP_STATE.testScores[student.studentId]) APP_STATE.testScores[student.studentId] = {};
                            
                            APP_STATE.testScores[student.studentId][subItem.id] = {
                                correct: correct,
                                wrong: wrong,
                                empty: totalQuestions - correct - wrong
                            };
                        } else {
                            // Normal puan - hedef nota g√∂re ayarla
                            const maxPoints = subItem.points || 100;
                            const targetScore = targetGrade.min + Math.random() * (targetGrade.max - targetGrade.min);
                            const score = Math.round((targetScore / 100) * maxPoints);
                            
                            if (!APP_STATE.gradesData[student.studentId]) {
                                APP_STATE.gradesData[student.studentId] = {};
                            }
                            APP_STATE.gradesData[student.studentId][subItem.id] = Math.max(0, Math.min(maxPoints, score));
                        }
                        scoreCount++;
                    });
                } else {
                    // Ana aktiviteye direkt puan ver - hedef nota g√∂re ayarla
                    const maxPoints = activity.points || 100;
                    const targetScore = targetGrade.min + Math.random() * (targetGrade.max - targetGrade.min);
                    const score = Math.round((targetScore / 100) * maxPoints);
                    
                    if (!APP_STATE.gradesData[student.studentId]) {
                        APP_STATE.gradesData[student.studentId] = {};
                    }
                    APP_STATE.gradesData[student.studentId][activity.id] = Math.max(0, Math.min(maxPoints, score));
                    scoreCount++;
                }
            });
        });
        
        // Notlarƒ± hesapla
        calculateFinalGrades();
        
        // T√ºm g√∂r√ºn√ºmleri g√ºncelle
        updateAssessmentView();
        // updateStudentSelector fonksiyonu kaldƒ±rƒ±ldƒ± (√ñƒürenci Bazlƒ± Not Giri≈üi sekmesi ile birlikte)
        
        // Eƒüer √∂ƒürenci bazlƒ± not giri≈üi a√ßƒ±ksa, se√ßili √∂ƒürenciyi yenile
        if (APP_STATE.selectedStudentId) {
            const container = document.getElementById('studentGradesContainer');
            if (container && container.innerHTML !== '<p class="empty-message">Veri bulunamadƒ±.</p>') {
                showStudentGrades(APP_STATE.selectedStudentId);
            }
        }
        
        // Harf notu daƒüƒ±lƒ±mƒ±nƒ± hesapla ve g√∂ster
        console.log("Final notlarƒ± hesaplanƒ±yor...");
        calculateFinalGrades(); // Notlarƒ± hesapla
        console.log("Final notlarƒ± hesaplandƒ±.");
        
        const gradeDistribution = {};
        
        // APP_STATE.gradesData'dan harf notlarƒ±nƒ± al
        APP_STATE.studentData.forEach(student => {
            const studentGrades = APP_STATE.gradesData[student.studentId];
            if (studentGrades && studentGrades.harfNotu) {
                const letterGrade = studentGrades.harfNotu;
                gradeDistribution[letterGrade] = (gradeDistribution[letterGrade] || 0) + 1;
            }
        });
        
        const distributionText = Object.entries(gradeDistribution)
            .sort(([a], [b]) => {
                const gradeOrder = ['AA', 'BA', 'BB', 'CB', 'CC', 'DC', 'DD', 'FD', 'FF'];
                return gradeOrder.indexOf(a) - gradeOrder.indexOf(b);
            })
            .map(([grade, count]) => `${grade}: ${count}`)
            .join(', ');
        
        // Ge√ßme/kalma analizi
        const actualPassing = Object.values(gradeDistribution).slice(0, 6).reduce((sum, count) => sum + count, 0); // AA-DC arasƒ±
        const actualFailing = Object.values(gradeDistribution).slice(6).reduce((sum, count) => sum + count, 0); // DD-FF arasƒ±
        const actualPassRate = Math.round((actualPassing / totalStudents) * 100);
        
        console.log(`üìä Ger√ßekle≈üen daƒüƒ±lƒ±m: Ge√ßen ${actualPassing} (${actualPassRate}%), Kalan ${actualFailing} (${100-actualPassRate}%)`);
        
        showModernToast(`üéØ ${scoreCount} akƒ±llƒ± puan olu≈üturuldu! Hedef: %${passRate} ge√ßen ‚Üí Ger√ßek: %${actualPassRate} ge√ßen\nüìä ${distributionText}`, "success", 5000);
        
        // Pass rate g√∂stergelerini g√ºncelle
        updatePassRateIndicators();
        
        // ƒ∞statistikleri g√ºncelle
        updatePassFailCounts();
        
    } catch (error) {
        console.error("Rastgele puanlama yapƒ±lƒ±rken hata:", error);
        showModernToast("Rastgele puanlama yapƒ±lamadƒ±!", "error");
    }
}

/**
 * Test √∂ƒürencileri olu≈üturma (Onay ile)
 */
function generateTestStudents() {
    // Mevcut √∂ƒürenci verilerini kontrol et
    const hasExistingStudents = APP_STATE.studentData && APP_STATE.studentData.length > 0;
    const currentStudentCount = hasExistingStudents ? APP_STATE.studentData.length : 0;
    
    const warningMessage = hasExistingStudents 
        ? `Sistemde zaten ${currentStudentCount} √∂ƒürenci mevcut. Bu i≈ülem mevcut √∂ƒürencilerin √ºzerine yazacak ve t√ºm not verilerini sƒ±fƒ±rlayacak.\n\nBu i≈ülem geri alƒ±namaz. Devam etmek istediƒüinizden emin misiniz?`
        : `10-24 arasƒ± rastgele test √∂ƒürencisi olu≈üturulacak. Bu i≈ülem geri alƒ±namaz.\n\nDevam etmek istediƒüinizden emin misiniz?`;
    
    showModernConfirm('üë• Rastgele Test √ñƒürencileri Olu≈ütur', warningMessage, {
            confirmText: 'Evet, Olu≈ütur',
            cancelText: 'ƒ∞ptal',
        confirmClass: 'btn-modern-primary',
        cancelClass: 'btn-modern-secondary'
    }).then((confirmed) => {
        if (confirmed) {
        executeGenerateTestStudents();
        } else {
            console.log('üë§ Kullanƒ±cƒ± test √∂ƒürencileri olu≈üturmayƒ± iptal etti');
            showModernToast('‚ùå Test √∂ƒürencileri olu≈üturma iptal edildi', 'info', 2000);
        }
    });
}

/**
 * Test √∂ƒürencileri olu≈üturma (Ger√ßek i≈ülem - Tam Dosya Format uyumlu)
 */
function executeGenerateTestStudents() {
    try {
        const firstNames = ['Ahmet', 'Mehmet', 'Ay≈üe', 'Fatma', 'Ali', 'Veli', 'Zeynep', 'Elif', 'Mustafa', 'Hatice', 'ƒ∞brahim', 'Emine', 'H√ºseyin', 'Meryem', '√ñmer', 'Selin', 'Burak', 'Deniz', 'Can', 'Seda'];
        const lastNames = ['Yƒ±lmaz', 'Kaya', 'Demir', '√áelik', '≈ûahin', 'Yƒ±ldƒ±z', 'Yƒ±ldƒ±rƒ±m', '√ñzt√ºrk', 'Aydin', '√ñzdemir', 'Arslan', 'Doƒüan', 'Kƒ±lƒ±√ß', 'Aslan', '√áetin', 'Ko√ß', 'Kurt', '√ñzkan', 'Erdoƒüan', 'G√ºne≈ü'];
        
        const numStudents = Math.floor(Math.random() * 15) + 10; // 10-24 √∂ƒürenci
        const testStudents = [];
        
        console.log(`üë• ${numStudents} test √∂ƒürencisi olu≈üturuluyor...`);
        
        for (let i = 0; i < numStudents; i++) {
            const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
            const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
            const studentId = `2114010${String(i + 50).padStart(2, '0')}`;
            
            // updateStudentTable() ile uyumlu format
            testStudents.push({
                studentId: studentId,
                name: firstName,
                surname: lastName,
                status: Math.random() > 0.9 ? 'ƒ∞li≈üiƒüi Kesilmi≈ü' : 'Aktif', // %10 ili≈üiƒüi kesilmi≈ü
                email: `${firstName.toLowerCase()}_${lastName.toLowerCase()}@erdogan.edu.tr`,
                tcKimlik: `${Math.floor(Math.random() * 90000000000) + 10000000000}`,
                telefon: `05${Math.floor(Math.random() * 900000000) + 100000000}`,
                // Tam dosya formatƒ± i√ßin alias'lar
                ogrenciNo: studentId,
                ad: firstName,
                soyad: lastName,
                durum: Math.random() > 0.9 ? 'ƒ∞li≈üiƒüi Kesilmi≈ü' : 'Aktif'
            });
        }
        
        // Tam dosya formatƒ±na uygun olarak courseData.ogrenciler'e kaydet
        if (!APP_STATE.courseData) {
            APP_STATE.courseData = {};
        }
        
        // Hem eski sistem hem tam dosya uyumluluƒüu i√ßin
        APP_STATE.studentData = testStudents;
        APP_STATE.courseData.ogrenciler = testStudents;
        
        // √ñƒürenci tablosunu g√ºncelle
        updateStudentTable();
        // updateStudentSelector fonksiyonu kaldƒ±rƒ±ldƒ± (√ñƒürenci Bazlƒ± Not Giri≈üi sekmesi ile birlikte)
        
        // Deƒüerlendirme g√∂r√ºn√ºm√ºn√º g√ºncelle
        updateAssessmentView();
        
        // Akƒ±llƒ± puanlama √∂ƒürenci sayƒ±larƒ±nƒ± g√ºncelle
        const passRateSlider = document.getElementById('passRateSlider');
        if (passRateSlider) {
            const passRate = parseInt(passRateSlider.value);
            updateStudentCounts(passRate);
        }
        
        // ƒ∞statistikleri g√ºncelle
        updatePassFailCounts();
        
        // Dual range slider uyarƒ±sƒ±nƒ± g√ºncelle
        const minSlider = document.getElementById('groupMinSlider');
        const maxSlider = document.getElementById('groupMaxSlider');
        if (minSlider && maxSlider) {
            updateDualRangeWarning(parseInt(minSlider.value), parseInt(maxSlider.value));
        }
        
        // Grup istatistiklerini g√ºncelle
        updateGroupStatistics();
        
        // Grup slider'larƒ±nƒ±n sƒ±nƒ±rlarƒ±nƒ± g√ºncelle
        updateGroupSliderLimits();
        
        showModernToast(`‚úÖ Tam dosya formatƒ±nda ${numStudents} test √∂ƒürencisi olu≈üturuldu!`, "success");
        
    } catch (error) {
        console.error("Test √∂ƒürencileri olu≈üturulurken hata:", error);
        showModernToast("Test √∂ƒürencileri olu≈üturulamadƒ±!", "error");
    }
}

/**
 * Tam test verisi olu≈üturma (hepsini birden)
 */
function generateFullTestData() {
    try {
        showModernToast("üöÄ Kapsamlƒ± test verisi olu≈üturuluyor...", "info", 3000);
        
        console.log("üéØ TAM TEST VERƒ∞Sƒ∞ OLU≈ûTURMA BA≈ûLADI");
        
        // 1. Test √∂ƒürencileri olu≈ütur
        console.log("üë• 1/5 - Test √∂ƒürencileri olu≈üturuluyor...");
        generateTestStudents();
        
        // 2. √áe≈üitli deƒüerlendirme bile≈üenleri ekle (ger√ßek√ßi sayƒ±da)
        setTimeout(() => {
            console.log("üìù 2/5 - Deƒüerlendirme bile≈üenleri olu≈üturuluyor...");
            const assessmentCount = Math.floor(Math.random() * 3) + 4; // 4-6 deƒüerlendirme
            
            for (let i = 0; i < assessmentCount; i++) {
                generateRandomAssessment();
            }
            
            // 3. Rastgele gruplar olu≈ütur (deƒüerlendirmeler olu≈üturulduktan sonra)
            setTimeout(() => {
                console.log("üé≤ 3/5 - Grup sistemleri olu≈üturuluyor...");
                generateRandomGroups();
                
                // 4. Rastgele puanlar ver
                setTimeout(() => {
                    console.log("üìä 4/5 - Rastgele puanlar olu≈üturuluyor...");
                    generateRandomScores();
                    
                    // 5. T√ºm g√∂r√ºn√ºmleri g√ºncelle ve finalize et
                    setTimeout(() => {
                        console.log("üîÑ 5/5 - UI g√ºncellemeleri yapƒ±lƒ±yor...");
                        
                        // Kapsamlƒ± UI g√ºncellemeleri
                        updateAssessmentView();
                        updateCategoryWeights();
                        renderTree();
                        // updateStudentSelector fonksiyonu kaldƒ±rƒ±ldƒ± (√ñƒürenci Bazlƒ± Not Giri≈üi sekmesi ile birlikte)
                        updateGroupSelectors();
                        updateTreeMappingControls();
                        updateAllInlineGroupInputs();
                        updateAllMappingDisplays();
                        
                        // Eƒüer farklƒ± sekmeler a√ßƒ±ksa onlarƒ± da g√ºncelle
                        const activeTab = document.querySelector('.nav-tab.active');
                        if (activeTab) {
                            const tabId = activeTab.getAttribute('data-tab');
                            if (tabId === 'assessment') {
                                updateAssessmentView();
                                                         // √ñƒürenci bazlƒ± not giri≈üi sekmesi kaldƒ±rƒ±ldƒ±
                            }
                        }
                        
                        // √ñzet bilgileri
                        const studentCount = APP_STATE.studentData?.length || 0;
                        const assessmentCount = APP_STATE.assessmentTree?.length || 0;
                        const groupCount = Object.keys(APP_STATE.courseData?.grupHaritalari || {}).length;
                        
                        console.log("‚úÖ TAM TEST VERƒ∞Sƒ∞ OLU≈ûTURMA TAMAMLANDI");
                        console.log(`üìä √ñzet: ${studentCount} √∂ƒürenci, ${assessmentCount} deƒüerlendirme, ${groupCount} grup sistemi`);
                        
                        showModernToast(
                            `üéâ Tam test verisi ba≈üarƒ±yla olu≈üturuldu!\n` +
                            `üë• ${studentCount} √∂ƒürenci\n` +
                            `üìù ${assessmentCount} deƒüerlendirme bile≈üeni\n` +
                            `üé≤ ${groupCount} grup sistemi\n` +
                            `üìä Rastgele puanlar atandƒ±`, 
                            "success", 6000
                        );
                        
                    }, 800);
                }, 1200);
            }, 800);
        }, 600);
        
    } catch (error) {
        console.error("‚ùå Tam test verisi olu≈üturulurken hata:", error);
        showModernToast("Tam test verisi olu≈üturulamadƒ±!", "error");
    }
}

/**
 * T√ºm test verilerini temizleme
 */
function clearAllTestData() {
    try {
        console.log("üîß clearAllTestData ba≈ülatƒ±ldƒ±");
        
        // √ñnce silinecek veri var mƒ± kontrol et
        const hasData = (APP_STATE.studentData && APP_STATE.studentData.length > 0) ||
                       (APP_STATE.assessmentTree && APP_STATE.assessmentTree.length > 0) ||
                       (APP_STATE.gradesData && Object.keys(APP_STATE.gradesData).length > 0) ||
                       (APP_STATE.testScores && Object.keys(APP_STATE.testScores).length > 0);
        
        if (!hasData) {
            showModernToast("‚ÑπÔ∏è Silinecek test verisi bulunmuyor.", "info");
            return;
        }
        
        // Modern onay modalƒ± kullan
        showModernConfirm('üß™ T√ºm Test Verilerini Sil', 'T√ºm test verileri silinecek (√∂ƒürenciler, deƒüerlendirmeler, notlar, gruplar). Bu i≈ülem geri alƒ±namaz! Emin misiniz?', {
            confirmText: 'Evet, Sil',
            cancelText: 'ƒ∞ptal',
            confirmClass: 'btn-modern-danger',
            cancelClass: 'btn-modern-secondary'
        }).then((confirmed) => {
            if (confirmed) {
                console.log("‚úÖ clearAllTestData onaylandƒ±, temizleme ba≈ülƒ±yor...");
        
                // 1. T√ºm verileri koordineli ≈üekilde temizle
        APP_STATE.studentData = [];
        APP_STATE.assessmentTree = [];
        APP_STATE.gradesData = {};
        APP_STATE.testScores = {};
        APP_STATE.courseData = {
            grupHaritalari: { A: {} }
        };
        APP_STATE.selectedStudentId = null;
                APP_STATE.selectedNode = null;
        
                // 2. UI'larƒ± g√ºvenli ≈üekilde g√ºncelle
        updateStudentTable();
        renderTree();
                if (typeof updateGroupSelectors === 'function') {
        updateGroupSelectors();
                }
        updateAssessmentView();
        updateCategoryWeights();
                if (typeof updateTreeMappingControls === 'function') {
        updateTreeMappingControls();
                }
        
                // 3. Containers'ƒ± temizle
        const containers = [
            'studentGradesContainer',
            'assessmentContainer',
            'gradesTableContainer'
        ];
        
        containers.forEach(containerId => {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = '<p class="empty-message">Veri bulunamadƒ±.</p>';
            }
        });
        
                // 4. Not tablosunu g√ºvenli ≈üekilde temizle
                try {
                    updateGradesTable([]);
                } catch (tableError) {
                    console.warn("‚ö†Ô∏è Not tablosu g√ºncellenirken hata (g√∂rmezden gelindi):", tableError);
                    const gradesTable = document.getElementById('gradesTable');
                    if (gradesTable) {
                        const tbody = gradesTable.querySelector('tbody');
                        if (tbody) {
                            tbody.innerHTML = '<tr><td colspan="8" class="empty-message">Not giri≈üi yapƒ±lmadƒ±</td></tr>';
                        }
                    }
        }
        
                // 5. Grup slider'larƒ±nƒ±n sƒ±nƒ±rlarƒ±nƒ± sƒ±fƒ±rla
                if (typeof updateGroupSliderLimits === 'function') {
        updateGroupSliderLimits();
                }
        
                // 6. Akƒ±llƒ± puanlama sayƒ±larƒ±nƒ± sƒ±fƒ±rla (√∂ƒürenci kalmadƒ±ƒüƒ± i√ßin)
        const passRateSlider = document.getElementById('passRateSlider');
        if (passRateSlider) {
            const passRate = parseInt(passRateSlider.value);
                    if (typeof updateStudentCounts === 'function') {
            updateStudentCounts(passRate);
                    }
        }
        
                // 7. Dual range slider uyarƒ±sƒ±nƒ± g√ºncelle (√∂ƒürenci kalmadƒ±ƒüƒ± i√ßin)
        const minSlider = document.getElementById('groupMinSlider');
        const maxSlider = document.getElementById('groupMaxSlider');
                if (minSlider && maxSlider && typeof updateDualRangeWarning === 'function') {
            updateDualRangeWarning(parseInt(minSlider.value), parseInt(maxSlider.value));
        }
        
                showModernToast("üß™ T√ºm test verileri koordineli ≈üekilde temizlendi!", "success");
            } else {
                console.log('üë§ Kullanƒ±cƒ± test verilerini temizlemeyi iptal etti');
                showModernToast('‚ùå Test verilerini temizleme iptal edildi', 'info', 2000);
            }
        });
        
    } catch (error) {
        console.error("‚ùå Test verileri temizlenirken hata:", error);
        showModernToast("Test verileri temizlenemedi!", "error");
    }
}

/**
 * Test ders datasƒ± olu≈üturma (data-input √∂rneklerine benzer)
 */
/**
 * Test ders verisi olu≈üturma (Onay ile)
 */
function generateTestCourseData() {
    // Mevcut verileri kontrol et
    const hasExistingData = APP_STATE.courseData && (
        (APP_STATE.courseData.ogrenciler && APP_STATE.courseData.ogrenciler.length > 0) ||
        (APP_STATE.assessmentTree && APP_STATE.assessmentTree.length > 0)
    );
    
    const warningMessage = hasExistingData 
        ? `Bu i≈ülem mevcut t√ºm ders verilerini (√∂ƒürenciler, deƒüerlendirmeler, notlar) tamamen deƒüi≈ütirecek ve kapsamlƒ± MUDEK uyumlu test verisi olu≈üturacak.\n\nBu i≈ülem geri alƒ±namaz. Devam etmek istediƒüinizden emin misiniz?`
        : `Kapsamlƒ± MUDEK uyumlu test ders verisi olu≈üturulacak (√∂ƒürenciler, deƒüerlendirmeler, haftalƒ±k i√ßerikler, √∂ƒürenme √ßƒ±ktƒ±larƒ±).\n\nBu i≈ülem geri alƒ±namaz. Devam etmek istediƒüinizden emin misiniz?`;
    
        showModernConfirm('üìö Test Ders Verisi Olu≈ütur', warningMessage, {
                confirmText: 'Evet, Olu≈ütur',
                cancelText: 'ƒ∞ptal',
            confirmClass: 'btn-modern-primary',
            cancelClass: 'btn-modern-secondary'
        }).then((confirmed) => {
            if (confirmed) {
            executeGenerateTestCourseData();
            } else {
                console.log('üë§ Kullanƒ±cƒ± test ders verisi olu≈üturmayƒ± iptal etti');
                showModernToast('‚ùå Test ders verisi olu≈üturma iptal edildi', 'info', 2000);
            }
        });
}

/**
 * Test ders verisi olu≈üturma (Ger√ßek i≈ülem)
 */
function executeGenerateTestCourseData() {
    try {
        showModernToast("üéì Tam dosya formatƒ±nda tam MUDEK uyumlu test ders verisi olu≈üturuluyor...", "info", 4000);
        
        // Test √∂ƒürencileri olu≈ütur (ki≈üisel veriler deƒüi≈ütirilecek)
        const testStudents = [];
        const turkishNames = [
            'Ahmet', 'Mehmet', 'Ali', 'Mustafa', 'Hasan', 'H√ºseyin', 'ƒ∞brahim', 'Osman', 'Yusuf', 'Murat',
            'Fatma', 'Ay≈üe', 'Emine', 'Hatice', 'Zeynep', 'Elif', 'Merve', 'B√º≈üra', 'Seda', '√ñzge',
            'Emre', 'Burak', 'Cem', 'Deniz', 'Ege', 'Furkan', 'G√∂khan', 'Halil', 'ƒ∞smail', 'Kemal',
            'Selin', 'Tuƒüba', '√úlk√º', 'Vildan', 'Wanda', 'Ximena', 'Yasemin', 'Zara', 'Aslƒ±', 'Berna'
        ];
        const turkishSurnames = [
            'Yƒ±lmaz', 'Kaya', 'Demir', '≈ûahin', '√áelik', 'Yƒ±ldƒ±z', 'Yƒ±ldƒ±rƒ±m', '√ñzt√ºrk', 'Aydin', '√ñzdemir',
            'Arslan', 'Doƒüan', 'Kƒ±lƒ±√ß', 'Aslan', '√áetin', 'Kara', 'Ko√ß', 'Kurt', '√ñzkan', '≈ûim≈üek',
            'Polat', 'G√ºler', 'T√ºrk', 'Acar', 'Bulut', 'Erdoƒüan', 'Keskin', 'Ta≈ü', 'Akƒ±n', 'Bayram'
        ];
        
        // 15-25 arasƒ± √∂ƒürenci olu≈ütur
        const numStudents = Math.floor(Math.random() * 11) + 15;
        
        for (let i = 0; i < numStudents; i++) {
            const firstName = turkishNames[Math.floor(Math.random() * turkishNames.length)];
            const lastName = turkishSurnames[Math.floor(Math.random() * turkishSurnames.length)];
            const studentNo = `2114010${String(i + 50).padStart(2, '0')}`;
            const tcKimlik = String(Math.floor(Math.random() * 90000000000) + 10000000000);
            const phone = `05${Math.floor(Math.random() * 900000000) + 100000000}`;
            
            testStudents.push({
                ogrenciNo: studentNo,
                ad: firstName,
                soyad: lastName,
                durum: Math.random() > 0.85 ? 'ƒ∞li≈üiƒüi Kesilmi≈ü' : 'Aktif',
                email: `${firstName.toLowerCase()}_${lastName.toLowerCase()}21@erdogan.edu.tr`,
                tcKimlik: tcKimlik,
                telefon: phone
            });
        }
        
        // Ger√ßek MUDEK dosyasƒ±ndan test ders datasƒ± olu≈ütur (sadece ki≈üisel veriler deƒüi≈ütirilir)
        const testCourseData = {
            "disaAktarmaTarihi": new Date().toISOString(),
            "dersBilgisi": {
                "dersKodu": "CE100",
                "dersAdi": "Algorithms And Programming II",
                "akademikYil": "2024-2025",
                "donem": "Bahar D√∂nemi",
                "ogretimUyesi": "DOKTOR √ñƒûRETƒ∞M √úYESƒ∞ TEST HOCASI"
            },
            "ogrenciler": testStudents,
            "dersDegerlendirme": {
                "yariyilIciEtkinlikleri": [
                    {
                        "etkinlik": "Ara Sƒ±nav",
                        "sayi": 1,
                        "katkiYuzdesi": 50
                    },
                    {
                        "etkinlik": "Ev √ñdevi",
                        "sayi": 4,
                        "katkiYuzdesi": 33
                    },
                    {
                        "etkinlik": "Laboratuvar",
                        "sayi": 15,
                        "katkiYuzdesi": 17
                    }
                ],
                "yariyilIciToplam": 100,
                "yariyilSonuEtkinlikleri": [
                    {
                        "etkinlik": "Final Sƒ±navƒ±",
                        "sayi": 1,
                        "katkiYuzdesi": 100
                    }
                ],
                "yariyilSonuToplam": 100,
                "genelDegerlendirme": [
                    {
                        "degerlendirme": "Yarƒ±yƒ±l (Yƒ±l) Sonu Etkinlikleri",
                        "katkiYuzdesi": 60
                    },
                    {
                        "degerlendirme": "Yarƒ±yƒ±l (Yƒ±l) ƒ∞√ßi Etkinlikleri",
                        "katkiYuzdesi": 40
                    }
                ],
                "genelDegerlendirmeToplam": 100
            },
            "ogrenciNotlari": {},
            "dersGenel": {
                "dersTuru": "Zorunlu",
                "dersinSeviyesi": "Lisans",
                "haftalikDersSaatiKuramsal": 3,
                "haftalikUygulamaSaati": 0,
                "haftalikLaboratuarSaati": 2,
                "dersinVerildigiYariyil": 2,
                "ogretimSistemi": "Birinci √ñƒüretim",
                "egitimDili": "ƒ∞ngilizce",
                "universite": "Recep Tayyip Erdoƒüan √úniversitesi",
                "ulke": "T√ºrkiye",
                "il": "Rize",
                "ilce": "Merkez",
                "mahalle": "Fener Mah",
                "fakulte": "M√ºhendislik Ve Mimarlƒ±k Fak√ºltesi",
                "bolum": "Bilgisayar M√ºhendisliƒüi",
                "dersKodu": "CE100",
                "dersAdi": "Algorithms and Programming II",
                "ogretimYiliDonemi": "Bahar",
                "dersAKTSKredisi": 5,
                "dilSecimi": "ƒ∞ngilizce",
                "mufredatOlusturulmaYili": "2020",
                "akademikYil": "2024-2025 Bahar",
                "dersKredisi": 4
            },
            "dersIcerik": {
                "dersinAmaci": "Bu ders Algoritmalar ve Programlama I dersinin devamƒ± niteliƒüindedir. Bu derste Algoritmalar ve Programlama I dersinde √∂ƒürenilen programlama becerileri, ortak problemler ve √ß√∂z√ºm algoritmalarƒ± ile b√ºt√ºnle≈üir. Bu ders, algoritmalarƒ±n yaygƒ±n sorunlar i√ßin nasƒ±l √ßalƒ±≈ütƒ±ƒüƒ±nƒ± analiz etmek ve anlamakla ilgilidir. Sƒ±nƒ±f, uzmanlƒ±k payla≈üƒ±mƒ±na dayalƒ± olacak ve √∂ƒürencilerin algoritma ve programlama konularƒ± i√ßin √∂ƒürenme y√∂ntemleri ve uygulamalarƒ± bulmalarƒ±na rehberlik edilecektir. Derslerde programlama uygulamalarƒ± ve projeleri yapƒ±lacaktƒ±r. Teoriden √ßok uygulama yapƒ±larak √∂ƒürenme s√ºreci g√º√ßlendirilecektir.",
                "dersinOnKosuluOlanDersler": "CE103 (Algorithms and Programming-I)",
                "dersinIcerigi": "Algoritma Temelleri, S√∂zde Kodlama, Zaman Karma≈üƒ±klƒ±ƒüƒ± ve Asimptotik G√∂sterim i√ßin Algoritma Analizi, Sƒ±ralama Sorunlarƒ± (Ekleme ve Birle≈ütirme Sƒ±ralamalarƒ±), √ñzyinelemeli Algoritmalar, B√∂l ve Fethet Analizi (Birle≈ütirme Sƒ±ralama, ƒ∞kili Arama), Matris √áarpma Problemi, Hƒ±zlƒ± Sƒ±ralama Analizi, Yƒ±ƒüƒ±nlar, Yƒ±ƒüƒ±n Sƒ±ralama ve √ñncelik Kuyruklarƒ±, Baƒülantƒ±lƒ± Listeler, Radix Sƒ±ralamasƒ± ve Sayma Sƒ±ralamasƒ±, Dƒ±≈üb√ºkey G√∂vde (Convex Hull), Dinamik Programlama, A√ßg√∂zl√º Algoritmalar, Grafikler ve Grafikler Arama Algoritmalarƒ± (Geni≈ülik-ƒ∞lk Arama, Derinlik-ƒ∞lk Arama ve Topolojik Sƒ±ralama), Grafik Yapƒ±sƒ± Algoritmalarƒ± (G√º√ßl√º Baƒülantƒ±lƒ± Bile≈üenler, Minimum Yayƒ±lma Aƒüacƒ±), Ayrƒ±k K√ºme ƒ∞≈ülemleri, Tek Kaynaklƒ± En Kƒ±sa Yol Algoritmasƒ±, Q-Learning En Kƒ±sa Yol Uygulamasƒ±, Aƒü Akƒ±≈üƒ± ve Uygulamalarƒ±, Veri √ñzetleme ve ≈ûifreleme.",
                "dersinIcinOnerilenHususlar": "√ñƒürencilerin Algoritmalar ve Programlama I dersindeki temel programlama bilgisine sahip olmasƒ±, derslere d√ºzenli katƒ±lƒ±mƒ± ve laboratuvar √ßalƒ±≈ümalarƒ±nƒ±/√∂devleri zamanƒ±nda yapmasƒ± beklenmektedir. Teorik konularƒ±n pratik uygulamalarla peki≈ütirilmesi √∂nemlidir.",
                "ogretimTuru": "Birinci √ñƒüretim",
                "stajDurumu": "Mevcut Deƒüil",
                "dersinKitabiMalzemesiOnerilenKaynaklar": "1. Paul Deitel ve Harvey Deitel. 2012. C How to Program (7. baskƒ±). Prentice Hall Press, USA.\n2. Intro to Java Programming, Comprehensive Version (10th Edition) 10th Edition by Y. Daniel Liang\n3. Introduction to Algorithms, Third Edition By Thomas H. Cormen, Charles E. Leiserson, Ronald L. Rivest, and Clifford Stein\n4. Problem Solving and Program Design in C, J.R. Hanly, and E.B. Koffman, 6th Edition.\n5. Robert Sedgewick and Kevin Wayne. 2011. Algorithms (4th. ed.). Addison-Wesley Professional.\n6. Harvey M. Deitel and Paul J. Deitel. 2001. Java How to Program (4th. ed.). Prentice-Hall PTR, USA.\n7. Paul Deitel ve Harvey Deitel. 2016. Visual C# How to Program (6th. ed.). Pearson.",
                "dersiVerenOgretimUyesiOgretimGorevlisi": "Dr. √ñƒür. √úyesi TEST HOCASI",
                "hazirlanmaTarihi": new Date().toLocaleDateString('tr-TR'),
                "email": "test.hoca@erdogan.edu.tr",
                "avesisProfile": "https://avesis.erdogan.edu.tr/test.hoca",
                "avesisId": "test.hoca"
            },
            "dersOgrenme√áiktilari": [
                {
                    "id": "√ñ√á.1",
                    "aciklama": "Verilen bir hesaplama problemi i√ßin uygun algoritmayƒ± se√ßer, √ß√∂z√ºm√ºn√º tasarlar ve se√ßilen bir programlama dilinde (C/C++, Java, C#) uygular."
                },
                {
                    "id": "√ñ√á.2",
                    "aciklama": "Algoritmalarƒ±n zaman ve bellek karma≈üƒ±klƒ±ƒüƒ±nƒ± asimptotik g√∂sterim (B√ºy√ºk O, Omega, Teta) kullanarak analiz eder."
                },
                {
                    "id": "√ñ√á.3",
                    "aciklama": "√ñzyinelemeli (recursive) algoritmalarƒ± tasarlar ve yineleme baƒüƒ±ntƒ±larƒ±nƒ± (√∂rn. Master Teoremi) kullanarak karma≈üƒ±klƒ±klarƒ±nƒ± analiz eder."
                },
                {
                    "id": "√ñ√á.4",
                    "aciklama": "B√∂l ve fethet, dinamik programlama ve a√ßg√∂zl√º (greedy) algoritma tasarƒ±m paradigmalarƒ±nƒ± anlar ve ilgili problemlere uygular (√∂rn. sƒ±ralama, matris √ßarpƒ±mƒ±, en uzun ortak alt dizi, aktivite se√ßimi)."
                },
                {
                    "id": "√ñ√á.5",
                    "aciklama": "Graf veri yapƒ±sƒ±nƒ± ve temel graf algoritmalarƒ±nƒ± (BFS, DFS, topolojik sƒ±ralama, minimum yayƒ±lan aƒüa√ß, en kƒ±sa yol) anlar ve uygular."
                },
                {
                    "id": "√ñ√á.6",
                    "aciklama": "Hashing, simetrik/asimetrik ≈üifreleme ve dijital imza gibi temel kriptografik kavramlarƒ± ve algoritmalarƒ± anlar; g√ºvenlik ve b√ºt√ºnl√ºk saƒülamadaki rollerini a√ßƒ±klar."
                },
                {
                    "id": "√ñ√á.7",
                    "aciklama": "Farklƒ± veri yapƒ±larƒ± (√∂rn. yƒ±ƒüƒ±n, baƒülƒ± liste, graf) ve algoritmalarƒ±n (√∂rn. sƒ±ralama, arama, graf algoritmalarƒ±) performans √∂zelliklerini kar≈üƒ±la≈ütƒ±rƒ±r ve problem gereksinimlerine g√∂re en uygun olanƒ± se√ßer."
                }
            ],
            "haftalikDersIcerikleri": [
                {
                    "hafta": 1,
                    "icerik": "Ders Planƒ± ve ƒ∞leti≈üim Not Sistemi, √ñdevler ve Sƒ±navlar. Algoritma Temelleri, S√∂zde Kod, RAM Modeli, Algoritma Maliyet Hesaplamasƒ±. Asimptotik Notasyon. Sƒ±ralama Problemi.",
                    "iliskiliOgrenme√áiktisi": "√ñ√á.2, √ñ√á.7",
                    "ogretimOrtami": "Sƒ±nƒ±f Ortamƒ±, Bilgisayar Laboratuvarƒ±",
                    "onHazirlik": "Temel algoritma ve programlama bilgisi (CE103)",
                    "ogretimYontemleri": "Anlatƒ±m, Problem √á√∂zme, Uygulama",
                    "aracVeGerecler": "Bilgisayar, Projeksiyon, IDE",
                    "kaynakVeMateryal": "Ders Notlarƒ±, Kaynak Kitaplar",
                    "degerlendirmeYontemleri": "-",
                    "odevVeCalisma": "Programlama √áalƒ±≈ütayƒ±"
                },
                {
                    "hafta": 2,
                    "icerik": "Yinelemeleri √á√∂zme (Yineleme Aƒüacƒ±, Ana Y√∂ntem ve Geri Yerine Koyma). B√∂l ve Fethet Analizi.",
                    "iliskiliOgrenme√áiktisi": "√ñ√á.3, √ñ√á.4, √ñ√á.7",
                    "ogretimOrtami": "Sƒ±nƒ±f Ortamƒ±, Bilgisayar Laboratuvarƒ±",
                    "onHazirlik": "Asimptotik notasyon",
                    "ogretimYontemleri": "Anlatƒ±m, Problem √á√∂zme, Uygulama",
                    "aracVeGerecler": "Bilgisayar, Projeksiyon, IDE",
                    "kaynakVeMateryal": "Ders Notlarƒ±, Kaynak Kitaplar",
                    "degerlendirmeYontemleri": "-",
                    "odevVeCalisma": "Programlama √áalƒ±≈ütayƒ±"
                },
                {
                    "hafta": 3,
                    "icerik": "Matris √áarpma, Quicksort, Heapsort, Radix Sort, Counting Sort.",
                    "iliskiliOgrenme√áiktisi": "√ñ√á.1, √ñ√á.2, √ñ√á.4, √ñ√á.7",
                    "ogretimOrtami": "Sƒ±nƒ±f Ortamƒ±, Bilgisayar Laboratuvarƒ±",
                    "onHazirlik": "B√∂l ve Fethet",
                    "ogretimYontemleri": "Anlatƒ±m, Problem √á√∂zme, Uygulama",
                    "aracVeGerecler": "Bilgisayar, Projeksiyon, IDE",
                    "kaynakVeMateryal": "Ders Notlarƒ±, Kaynak Kitaplar",
                    "degerlendirmeYontemleri": "-",
                    "odevVeCalisma": "Programlama √áalƒ±≈ütayƒ± (Ara Sƒ±nav √ñdevi-1 G√∂nderilecek)"
                },
                {
                    "hafta": 4,
                    "icerik": "Arasƒ±nav √ñdevi-1 Kontroller ve √ñzetle Tekrar",
                    "iliskiliOgrenme√áiktisi": "√ñ√á.1, √ñ√á.2, √ñ√á.3, √ñ√á.4, √ñ√á.7",
                    "ogretimOrtami": "Bilgisayar Laboratuvarƒ±",
                    "onHazirlik": "√ñdev-1",
                    "ogretimYontemleri": "Soru-Cevap, Deƒüerlendirme",
                    "aracVeGerecler": "Bilgisayar, IDE",
                    "kaynakVeMateryal": "√ñdevler",
                    "degerlendirmeYontemleri": "-",
                    "odevVeCalisma": "-"
                },
                {
                    "hafta": 5,
                    "icerik": "Konveks G√∂vde (Convex Hull). Dinamik Programlama (Fibonacci, Matris Zinciri √áarpƒ±mƒ±).",
                    "iliskiliOgrenme√áiktisi": "√ñ√á.4, √ñ√á.7",
                    "ogretimOrtami": "Sƒ±nƒ±f Ortamƒ±, Bilgisayar Laboratuvarƒ±",
                    "onHazirlik": "Temel algoritmalar",
                    "ogretimYontemleri": "Anlatƒ±m, Problem √á√∂zme, Uygulama",
                    "aracVeGerecler": "Bilgisayar, Projeksiyon, IDE",
                    "kaynakVeMateryal": "Ders Notlarƒ±, Kaynak Kitaplar",
                    "degerlendirmeYontemleri": "-",
                    "odevVeCalisma": "Programlama √áalƒ±≈ütayƒ±"
                },
                {
                    "hafta": 6,
                    "icerik": "Dinamik Programlama (LCS). A√ßg√∂zl√º Algoritmalar (Aktivite Se√ßimi, Sƒ±rt √áantasƒ±).",
                    "iliskiliOgrenme√áiktisi": "√ñ√á.4, √ñ√á.7",
                    "ogretimOrtami": "Sƒ±nƒ±f Ortamƒ±, Bilgisayar Laboratuvarƒ±",
                    "onHazirlik": "Dinamik Programlama temelleri",
                    "ogretimYontemleri": "Anlatƒ±m, Problem √á√∂zme, Uygulama",
                    "aracVeGerecler": "Bilgisayar, Projeksiyon, IDE",
                    "kaynakVeMateryal": "Ders Notlarƒ±, Kaynak Kitaplar",
                    "degerlendirmeYontemleri": "-",
                    "odevVeCalisma": "Programlama √áalƒ±≈ütayƒ± (Ara Sƒ±nav √ñdevi-2 G√∂nderilecek)"
                },
                {
                    "hafta": 7,
                    "icerik": "Arasƒ±nav √ñdevi-2 Kontroller ve √ñzetle Tekrar",
                    "iliskiliOgrenme√áiktisi": "√ñ√á.1, √ñ√á.2, √ñ√á.3, √ñ√á.4, √ñ√á.7",
                    "ogretimOrtami": "Bilgisayar Laboratuvarƒ±",
                    "onHazirlik": "√ñdev-2",
                    "ogretimYontemleri": "Soru-Cevap, Deƒüerlendirme",
                    "aracVeGerecler": "Bilgisayar, IDE",
                    "kaynakVeMateryal": "√ñdevler",
                    "degerlendirmeYontemleri": "-",
                    "odevVeCalisma": "-"
                },
                {
                    "hafta": 8,
                    "icerik": "Vize",
                    "iliskiliOgrenme√áiktisi": "√ñ√á.1, √ñ√á.2, √ñ√á.3, √ñ√á.4, √ñ√á.7",
                    "ogretimOrtami": "Sƒ±nƒ±f Ortamƒ±",
                    "onHazirlik": "1-7 hafta konularƒ±",
                    "ogretimYontemleri": "√ñl√ßme Deƒüerlendirme",
                    "aracVeGerecler": "-",
                    "kaynakVeMateryal": "-",
                    "degerlendirmeYontemleri": "Yazƒ±lƒ± Sƒ±nav/Proje",
                    "odevVeCalisma": "-"
                },
                {
                    "hafta": 9,
                    "icerik": "Yƒ±ƒüƒ±n Veri Yapƒ±sƒ±, Yƒ±ƒüƒ±n Sƒ±ralama, Huffman Kodlama.",
                    "iliskiliOgrenme√áiktisi": "√ñ√á.4, √ñ√á.7",
                    "ogretimOrtami": "Sƒ±nƒ±f Ortamƒ±, Bilgisayar Laboratuvarƒ±",
                    "onHazirlik": "Temel veri yapƒ±larƒ±",
                    "ogretimYontemleri": "Anlatƒ±m, Problem √á√∂zme, Uygulama",
                    "aracVeGerecler": "Bilgisayar, Projeksiyon, IDE",
                    "kaynakVeMateryal": "Ders Notlarƒ±, Kaynak Kitaplar",
                    "degerlendirmeYontemleri": "-",
                    "odevVeCalisma": "Programlama √áalƒ±≈ütayƒ±"
                },
                {
                    "hafta": 10,
                    "icerik": "Grafiklere Giri≈ü, G√∂sterim, BFS, DFS, Topolojik Sƒ±ra, SCC, MST, Prim, Kruskal, Tek Kaynak En Kƒ±sa Yol.",
                    "iliskiliOgrenme√áiktisi": "√ñ√á.5, √ñ√á.7",
                    "ogretimOrtami": "Sƒ±nƒ±f Ortamƒ±, Bilgisayar Laboratuvarƒ±",
                    "onHazirlik": "Temel veri yapƒ±larƒ±",
                    "ogretimYontemleri": "Anlatƒ±m, Problem √á√∂zme, Uygulama",
                    "aracVeGerecler": "Bilgisayar, Projeksiyon, IDE",
                    "kaynakVeMateryal": "Ders Notlarƒ±, Kaynak Kitaplar",
                    "degerlendirmeYontemleri": "-",
                    "odevVeCalisma": "Programlama √áalƒ±≈ütayƒ±"
                },
                {
                    "hafta": 11,
                    "icerik": "Q-Learning En Kƒ±sa Yol, Max-Flow Min-Cut. Kriptografi: Hashing ve B√ºt√ºnl√ºk Kontrol√º.",
                    "iliskiliOgrenme√áiktisi": "√ñ√á.5, √ñ√á.6, √ñ√á.7",
                    "ogretimOrtami": "Sƒ±nƒ±f Ortamƒ±, Bilgisayar Laboratuvarƒ±",
                    "onHazirlik": "Graf algoritmalarƒ±",
                    "ogretimYontemleri": "Anlatƒ±m, Problem √á√∂zme, Uygulama",
                    "aracVeGerecler": "Bilgisayar, Projeksiyon, IDE",
                    "kaynakVeMateryal": "Ders Notlarƒ±, Kaynak Kitaplar",
                    "degerlendirmeYontemleri": "-",
                    "odevVeCalisma": "Programlama √áalƒ±≈ütayƒ± (Son √ñdev-1 G√∂nderilecek)"
                },
                {
                    "hafta": 12,
                    "icerik": "Son √ñdev-1 Kontrolleri ve √ñzetle ƒ∞nceleme",
                    "iliskiliOgrenme√áiktisi": "√ñ√á.1, √ñ√á.2, √ñ√á.3, √ñ√á.4, √ñ√á.5, √ñ√á.6, √ñ√á.7",
                    "ogretimOrtami": "Bilgisayar Laboratuvarƒ±",
                    "onHazirlik": "√ñdev-1",
                    "ogretimYontemleri": "Soru-Cevap, Deƒüerlendirme",
                    "aracVeGerecler": "Bilgisayar, IDE",
                    "kaynakVeMateryal": "√ñdevler",
                    "degerlendirmeYontemleri": "-",
                    "odevVeCalisma": "-"
                },
                {
                    "hafta": 13,
                    "icerik": "Kriptografi: Simetrik ≈ûifreleme, Asimetrik ≈ûifreleme, Dijital ƒ∞mza.",
                    "iliskiliOgrenme√áiktisi": "√ñ√á.6",
                    "ogretimOrtami": "Sƒ±nƒ±f Ortamƒ±, Bilgisayar Laboratuvarƒ±",
                    "onHazirlik": "Temel kriptografi kavramlarƒ±",
                    "ogretimYontemleri": "Anlatƒ±m, Problem √á√∂zme, Uygulama",
                    "aracVeGerecler": "Bilgisayar, Projeksiyon, IDE, Crypto++",
                    "kaynakVeMateryal": "Ders Notlarƒ±, Kriptografi Kaynaklarƒ±",
                    "degerlendirmeYontemleri": "-",
                    "odevVeCalisma": "Programlama √áalƒ±≈ütayƒ±"
                },
                {
                    "hafta": 14,
                    "icerik": "Kriptografi: OTP Hesaplama, Dosya ≈ûifreleme/≈ûifre √á√∂zme.",
                    "iliskiliOgrenme√áiktisi": "√ñ√á.1, √ñ√á.6",
                    "ogretimOrtami": "Sƒ±nƒ±f Ortamƒ±, Bilgisayar Laboratuvarƒ±",
                    "onHazirlik": "≈ûifreleme algoritmalarƒ±",
                    "ogretimYontemleri": "Anlatƒ±m, Problem √á√∂zme, Uygulama",
                    "aracVeGerecler": "Bilgisayar, Projeksiyon, IDE, Crypto++",
                    "kaynakVeMateryal": "Ders Notlarƒ±, Kriptografi Kaynaklarƒ±",
                    "degerlendirmeYontemleri": "-",
                    "odevVeCalisma": "Programlama √áalƒ±≈ütayƒ± (Son √ñdev-2 G√∂nderilecek)"
                },
                {
                    "hafta": 15,
                    "icerik": "Son √ñdev-2 Kontrolleri ve √ñzetle ƒ∞nceleme",
                    "iliskiliOgrenme√áiktisi": "√ñ√á.1, √ñ√á.2, √ñ√á.3, √ñ√á.4, √ñ√á.5, √ñ√á.6, √ñ√á.7",
                    "ogretimOrtami": "Bilgisayar Laboratuvarƒ±",
                    "onHazirlik": "√ñdev-2",
                    "ogretimYontemleri": "Soru-Cevap, Deƒüerlendirme",
                    "aracVeGerecler": "Bilgisayar, IDE",
                    "kaynakVeMateryal": "√ñdevler",
                    "degerlendirmeYontemleri": "-",
                    "odevVeCalisma": "-"
                },
                {
                    "hafta": 16,
                    "icerik": "Final",
                    "iliskiliOgrenme√áiktisi": "√ñ√á.1, √ñ√á.2, √ñ√á.3, √ñ√á.4, √ñ√á.5, √ñ√á.6, √ñ√á.7",
                    "ogretimOrtami": "Sƒ±nƒ±f Ortamƒ±",
                    "onHazirlik": "T√ºm konular",
                    "ogretimYontemleri": "√ñl√ßme Deƒüerlendirme",
                    "aracVeGerecler": "-",
                    "kaynakVeMateryal": "-",
                    "degerlendirmeYontemleri": "Yazƒ±lƒ± Sƒ±nav/Proje",
                    "odevVeCalisma": "-"
                }
            ],
            "dersIsYuku": {
                "etkinlikler": [
                    {
                        "etkinlik": "Derse Katƒ±lƒ±m",
                        "sayi": 14,
                        "sure": 3,
                        "toplamIsYuku": 42
                    },
                    {
                        "etkinlik": "Laboratuvar",
                        "sayi": 14,
                        "sure": 2,
                        "toplamIsYuku": 28
                    },
                    {
                        "etkinlik": "Bireysel √áalƒ±≈üma",
                        "sayi": 14,
                        "sure": 1.8571428571428572,
                        "toplamIsYuku": 26
                    },
                    {
                        "etkinlik": "Ara Sƒ±nav",
                        "sayi": 1,
                        "sure": 1,
                        "toplamIsYuku": 1
                    },
                    {
                        "etkinlik": "Ara Sƒ±nav ƒ∞√ßin Bireysel √áalƒ±≈üma",
                        "sayi": 1,
                        "sure": 6,
                        "toplamIsYuku": 6
                    },
                    {
                        "etkinlik": "Ev √ñdevi",
                        "sayi": 4,
                        "sure": 1,
                        "toplamIsYuku": 4
                    },
                    {
                        "etkinlik": "Bireysel √áalƒ±≈üma",
                        "sayi": 4,
                        "sure": 2,
                        "toplamIsYuku": 8
                    },
                    {
                        "etkinlik": "Final Sƒ±navƒ±",
                        "sayi": 1,
                        "sure": 2,
                        "toplamIsYuku": 2
                    },
                    {
                        "etkinlik": "Final Sƒ±navƒ± ƒ∞√ßin Bireysel √áalƒ±≈üma",
                        "sayi": 1,
                        "sure": 8,
                        "toplamIsYuku": 8
                    }
                ],
                "toplamIsYuku": 125,
                "dersAKTSKredisi": 5,
                "hesaplama": "Dersin AKTS Kredisi = Toplam ƒ∞≈ü Y√ºk√º (Saat) / 25 = 5",
                "aktsHesaplama": "Toplam ƒ∞≈ü Y√ºk√º / 25"
            },
            "programCiktilari": [
                {
                    "id": "P√á.1",
                    "kategori": "Bƒ∞LGƒ∞ - Kuramsal Olgusal",
                    "aciklama": "TEMEL Bƒ∞LGƒ∞: Matematik, Fen Bilimleri ve Bilgisayar M√ºhendisliƒüi konularƒ±nda yeterli bilgi sahibidir; bu alanlardaki kuramsal ve uygulamalƒ± bilgileri, karma≈üƒ±k m√ºhendislik problemlerinde kullanƒ±r."
                },
                {
                    "id": "P√á.2",
                    "kategori": "BECERƒ∞LER - Bili≈üsel Uygulamalƒ±",
                    "aciklama": "PROBLEM √á√ñZME: Karma≈üƒ±k Bilgisayar M√ºhendisliƒüi problemlerini saptar, tanƒ±mlar, form√ºle eder ve √ß√∂zer; bu amaca uygun analiz ve modelleme y√∂ntemlerini se√ßer ve uygular."
                },
                {
                    "id": "P√á.3",
                    "kategori": "BECERƒ∞LER - Bili≈üsel Uygulamalƒ±",
                    "aciklama": "TASARIM: Karma≈üƒ±k bir sistemi, s√ºreci, cihazƒ± veya √ºr√ºn√º ger√ßek√ßi kƒ±sƒ±tlar ve ko≈üullar altƒ±nda, belirli gereksinimleri kar≈üƒ±layacak ≈üekilde tasarlar; bu ama√ßla modern tasarƒ±m y√∂ntemlerini uygular."
                },
                {
                    "id": "P√á.4",
                    "kategori": "BECERƒ∞LER - Bili≈üsel Uygulamalƒ±",
                    "aciklama": "TEKNOLOJƒ∞: Bilgisayar M√ºhendisliƒüi uygulamalarƒ±nda kar≈üƒ±la≈üƒ±lan karma≈üƒ±k problemlerin analizi ve √ß√∂z√ºm√º i√ßin gerekli olan modern teknik ve ara√ßlarƒ± geli≈ütirir, se√ßer ve kullanƒ±r; bili≈üim teknolojilerini etkin bir ≈üekilde kullanƒ±r."
                },
                {
                    "id": "P√á.5",
                    "kategori": "BECERƒ∞LER - Bili≈üsel Uygulamalƒ±",
                    "aciklama": "ARA≈ûTIRMA: Karma≈üƒ±k Bilgisayar M√ºhendisliƒüi problemlerinin veya ara≈ütƒ±rma konularƒ±nƒ±n incelenmesi i√ßin deney tasarlar, deney yapar, veri toplar, sonu√ßlarƒ± analiz eder ve yorumlar."
                },
                {
                    "id": "P√á.6",
                    "kategori": "YETKƒ∞NLƒ∞KLER - Baƒüƒ±msƒ±z √áalƒ±≈üabilme ve Sorumluluk Alabilme Yetkinliƒüi",
                    "aciklama": "ƒ∞≈ûBƒ∞RLƒ∞ƒûƒ∞: Bilgisayar M√ºhendisliƒüi disiplini i√ßinde ve √ßok disiplinli takƒ±mlarda etkin bi√ßimde √ßalƒ±≈üƒ±r; bireysel √ßalƒ±≈üma sergiler."
                },
                {
                    "id": "P√á.7",
                    "kategori": "YETKƒ∞NLƒ∞KLER - √ñƒürenme Yetkinliƒüi",
                    "aciklama": "GELƒ∞≈ûƒ∞M: Ya≈üam boyu √∂ƒürenmenin gerekliliƒüinin bilincindedir; bilgiye eri≈üir, bilim ve teknolojideki geli≈ümeleri izler ve kendini s√ºrekli yeniler."
                },
                {
                    "id": "P√á.8",
                    "kategori": "YETKƒ∞NLƒ∞KLER - ƒ∞leti≈üim ve Sosyal Yetkinlik",
                    "aciklama": "ƒ∞LETƒ∞≈ûƒ∞M: T√ºrk√ße s√∂zl√º ve yazƒ±lƒ± etkin ileti≈üim kurar; etkin rapor yazar ve yazƒ±lƒ± raporlarƒ± anlar, tasarƒ±m ve √ºretim raporlarƒ± hazƒ±rlar, etkin sunum yapar, a√ßƒ±k ve anla≈üƒ±lƒ±r talimat verir ve alƒ±r."
                },
                {
                    "id": "P√á.9",
                    "kategori": "YETKƒ∞NLƒ∞KLER - ƒ∞leti≈üim ve Sosyal Yetkinlik",
                    "aciklama": "TOPLUMSAL Bƒ∞Lƒ∞N√á: Bilgisayar M√ºhendisliƒüi uygulamalarƒ±nƒ±n evrensel ve toplumsal boyutlarda saƒülƒ±k, √ßevre ve g√ºvenlik √ºzerindeki etkileri ve √ßaƒüƒ±n m√ºhendislik alanƒ±na yansƒ±yan sorunlarƒ± hakkƒ±nda bilgi sahibidir."
                },
                {
                    "id": "P√á.10",
                    "kategori": "YETKƒ∞NLƒ∞KLER - ƒ∞leti≈üim ve Sosyal Yetkinlik",
                    "aciklama": "ULUSLARARASILIK: Bir yabancƒ± dili kullanarak Bilgisayar M√ºhendisliƒüi ile ili≈ükili konularda, bilgi toplar ve meslekta≈ülarƒ± ile ileti≈üim kurar."
                },
                {
                    "id": "P√á.11",
                    "kategori": "YETKƒ∞NLƒ∞KLER - Alana √ñzg√º Yetkinlik",
                    "aciklama": "ETƒ∞K: Etik ilkelerine uygun davranma, mesleki ve etik sorumluluk bilincine sahiptir; m√ºhendislik uygulamalarƒ±nda kullanƒ±lan standartlar hakkƒ±nda bilgi sahibidir."
                },
                {
                    "id": "P√á.12",
                    "kategori": "YETKƒ∞NLƒ∞KLER - Alana √ñzg√º Yetkinlik",
                    "aciklama": "Y√ñNETƒ∞M: Proje y√∂netimi, risk y√∂netimi ve deƒüi≈üiklik y√∂netimi gibi, i≈ü hayatƒ±ndaki uygulamalar hakkƒ±nda bilgi sahibidir; giri≈üimcilik, yenilik√ßilik hakkƒ±nda bilin√ßlidir."
                }
            ],
            "programVeOgrenmeIliskisi": {
                "iliskiOlcekleri": "0-5 arasƒ± deƒüerler (0: ƒ∞li≈üki yok, 5: √áok g√º√ßl√º ili≈üki)",
                "iliskiTablosu": [
                    {
                        "ogrenme√áiktisiID": "√ñ√á.1",
                        "program√áiktilariIliskileri": {
                            "P√á.1": 0,
                            "P√á.2": 5,
                            "P√á.3": 0,
                            "P√á.4": 0,
                            "P√á.5": 3,
                            "P√á.6": 0,
                            "P√á.7": 0,
                            "P√á.8": 0,
                            "P√á.9": 3,
                            "P√á.10": 0,
                            "P√á.11": 0,
                            "P√á.12": 0
                        }
                    },
                    {
                        "ogrenme√áiktisiID": "√ñ√á.2",
                        "program√áiktilariIliskileri": {
                            "P√á.1": 0,
                            "P√á.2": 3,
                            "P√á.3": 0,
                            "P√á.4": 0,
                            "P√á.5": 0,
                            "P√á.6": 3,
                            "P√á.7": 0,
                            "P√á.8": 0,
                            "P√á.9": 0,
                            "P√á.10": 3,
                            "P√á.11": 0,
                            "P√á.12": 0
                        }
                    },
                    {
                        "ogrenme√áiktisiID": "√ñ√á.3",
                        "program√áiktilariIliskileri": {
                            "P√á.1": 0,
                            "P√á.2": 3,
                            "P√á.3": 3,
                            "P√á.4": 0,
                            "P√á.5": 0,
                            "P√á.6": 0,
                            "P√á.7": 3,
                            "P√á.8": 0,
                            "P√á.9": 0,
                            "P√á.10": 0,
                            "P√á.11": 0,
                            "P√á.12": 0
                        }
                    },
                    {
                        "ogrenme√áiktisiID": "√ñ√á.4",
                        "program√áiktilariIliskileri": {
                            "P√á.1": 0,
                            "P√á.2": 3,
                            "P√á.3": 0,
                            "P√á.4": 3,
                            "P√á.5": 0,
                            "P√á.6": 0,
                            "P√á.7": 0,
                            "P√á.8": 0,
                            "P√á.9": 0,
                            "P√á.10": 0,
                            "P√á.11": 0,
                            "P√á.12": 0
                        }
                    },
                    {
                        "ogrenme√áiktisiID": "√ñ√á.5",
                        "program√áiktilariIliskileri": {
                            "P√á.1": 0,
                            "P√á.2": 3,
                            "P√á.3": 0,
                            "P√á.4": 0,
                            "P√á.5": 3,
                            "P√á.6": 0,
                            "P√á.7": 0,
                            "P√á.8": 0,
                            "P√á.9": 3,
                            "P√á.10": 0,
                            "P√á.11": 0,
                            "P√á.12": 0
                        }
                    },
                    {
                        "ogrenme√áiktisiID": "√ñ√á.6",
                        "program√áiktilariIliskileri": {
                            "P√á.1": 0,
                            "P√á.2": 3,
                            "P√á.3": 0,
                            "P√á.4": 0,
                            "P√á.5": 0,
                            "P√á.6": 3,
                            "P√á.7": 0,
                            "P√á.8": 0,
                            "P√á.9": 0,
                            "P√á.10": 3,
                            "P√á.11": 0,
                            "P√á.12": 0
                        }
                    },
                    {
                        "ogrenme√áiktisiID": "√ñ√á.7",
                        "program√áiktilariIliskileri": {
                            "P√á.1": 0,
                            "P√á.2": 3,
                            "P√á.3": 3,
                            "P√á.4": 0,
                            "P√á.5": 0,
                            "P√á.6": 0,
                            "P√á.7": 3,
                            "P√á.8": 0,
                            "P√á.9": 0,
                            "P√á.10": 0,
                            "P√á.11": 0,
                            "P√á.12": 0
                        }
                    }
                ]
            },
            "toplumsalKatkiVeSurdurulebilirlik": {
                "surdurulebilirKalkinmaAmaclari": [
                    { "amac": "Yoksulluƒüa Son", "secili": false },
                    { "amac": "A√ßlƒ±ƒüa Son", "secili": false },
                    { "amac": "Saƒülƒ±k ve Kaliteli Ya≈üam", "secili": false },
                    { "amac": "Nitelikli Eƒüitim", "secili": true },
                    { "amac": "Toplumsal Cinsiyet E≈üitliƒüi", "secili": false },
                    { "amac": "Temiz Su ve Sanitasyon", "secili": false },
                    { "amac": "Eri≈üilebilir ve Temiz Enerji", "secili": false },
                    { "amac": "ƒ∞nsana Yakƒ±≈üƒ±r ƒ∞≈ü ve Ekonomik B√ºy√ºme", "secili": true },
                    { "amac": "Sanayi, Yenilik√ßilik ve Altyapƒ±", "secili": true },
                    { "amac": "E≈üitsizliklerin Azaltƒ±lmasƒ±", "secili": false },
                    { "amac": "S√ºrd√ºr√ºlebilir ≈ûehirler ve Topluluklar", "secili": false },
                    { "amac": "Sorumlu √úretim ve T√ºketim", "secili": true },
                    { "amac": "ƒ∞klim Eylemi", "secili": false },
                    { "amac": "Sudaki Ya≈üam", "secili": false },
                    { "amac": "Karasal Ya≈üam", "secili": false },
                    { "amac": "Barƒ±≈ü, Adalet ve G√º√ßl√º Kurumlar", "secili": true },
                    { "amac": "Ama√ßlar ƒ∞√ßin Ortaklƒ±klar", "secili": false }
                ],
                "toplumsalKatkiAlanlari": [
                    { "alan": "Eƒüitim ve √ñƒüretim", "secili": true },
                    { "alan": "Saƒülƒ±k", "secili": false },
                    { "alan": "Sosyal Hizmetler ve Toplumsal E≈üitlik", "secili": false },
                    { "alan": "√áevre ve S√ºrd√ºr√ºlebilirlik", "secili": true },
                    { "alan": "Teknolojik ve Bilimsel Yenilikler", "secili": true },
                    { "alan": "Ekonomik Kalkƒ±nma ve Giri≈üimcilik", "secili": true },
                    { "alan": "K√ºlt√ºrel ve Sanatsal Etkinlikler", "secili": false },
                    { "alan": "Uluslararasƒ± ƒ∞≈ü birliƒüi ve Diplomasi", "secili": false },
                    { "alan": "Toplum yararƒ±na yapƒ±lacak diƒüer √ßalƒ±≈ümalar", "secili": true }
                ]
            },
            "dersSekmeler": {
                "dersGenel": true,
                "dersOgrenme√áiktilari": true,
                "haftalikDersIcerikleri": true,
                "dersIsYuku": true,
                "dersDegerlendirme": true,
                "programVeOgrenme√áiktilariIliskisi": true,
                "toplumsalKatkiVeSurdurulebilirlik": true
            },
            "etkinlikTurleri": [
                "Alan √áalƒ±≈ümasƒ±", "Alan Gezisi", "Ara Sƒ±nav", "Ara Sƒ±nav ƒ∞√ßin Bireysel √áalƒ±≈üma",
                "Beyin Fƒ±rtƒ±nasƒ±", "Bireysel √áalƒ±≈üma", "B√ºt√ºnleme Sƒ±navƒ±", "Deney", "Deney Sonrasƒ± Quiz",
                "Derse Katƒ±lƒ±m", "Ev √ñdevi", "Final Sƒ±navƒ±", "Final Sƒ±navƒ± ƒ∞√ßin Bireysel √áalƒ±≈üma",
                "G√∂sterme", "G√∂zlem", "Laboratuvar", "Laboratuvar Ara Sƒ±navƒ±", "Laboratuvar Sƒ±navƒ±",
                "Makale Kritik Etme", "Makale Yazma", "Multirom CD √áalƒ±≈ümasƒ±", "√ñdev Problemleri ƒ∞√ßin √áalƒ±≈üma",
                "Okuma", "√ñrnek Vaka ƒ∞ncelemesi", "Performans", "Problem √á√∂z√ºm√º", "Proje Hazƒ±rlama",
                "Proje Sunma", "Proje Tasarƒ±mƒ±/Y√∂netimi", "Quiz", "Quiz ƒ∞√ßin Bireysel √áalƒ±≈üma",
                "Rapor", "Rapor Hazƒ±rlama", "Rapor Sunma", "Rehberli Problem √á√∂z√ºm√º",
                "Rol Oynama / Dramatizasyon", "Seminer", "Soru-Yanƒ±t", "S√∂zl√º Sƒ±nav",
                "Takƒ±m/Grup √áalƒ±≈ümasƒ±", "Tartƒ±≈üma", "Toplantƒ± Ba≈ükanlƒ±ƒüƒ± Yapma", "Uygulama/Pratik"
            ],
            "yariyilIciOlasiEtkinlikler": [
                "Ara Sƒ±nav", "Laboratuvar Sƒ±navƒ±", "Deney", "Deney Sonrasƒ± Quiz", "Performans",
                "Quiz", "Rapor", "Rapor Sunma", "Makale Kritik Etme", "Makale Yazma",
                "Proje Hazƒ±rlama", "Proje Sunma", "Rehberli Problem √á√∂z√ºm√º", "Seminer",
                "S√∂zl√º Sƒ±nav", "√ñdev Problemleri ƒ∞√ßin √áalƒ±≈üma", "Proje Tasarƒ±mƒ±/Y√∂netimi"
            ],
            "yariyilSonuOlasiEtkinlikler": [
                "Final Sƒ±navƒ±", "Laboratuvar Ara Sƒ±navƒ±", "Makale Yazma", "Proje Hazƒ±rlama",
                "Proje Sunma", "Proje Tasarƒ±mƒ±/Y√∂netimi", "Quiz", "Rapor", "Rapor Hazƒ±rlama",
                "Rapor Sunma", "Seminer", "S√∂zl√º Sƒ±nav", "G√∂zlem"
            ],
            "denetimBilgileri": {
                "olusturmaTarihi": new Date().toISOString().split('T')[0] + ' ' + new Date().toTimeString().split(' ')[0],
                "olusturan": "test_data_generator",
                "sonGuncellenmeTarihi": new Date().toISOString().split('T')[0] + ' ' + new Date().toTimeString().split(' ')[0],
                "guncelleyen": "test_data_generator",
                "durum": "Test"
            },
            "numaralandirmaDegerleri": {
                "dersTurleri": ["Zorunlu", "Se√ßmeli"],
                "dersSeviyesi": ["Lisans", "Y√ºksek Lisans", "Doktora"],
                "ogretimSistemi": ["Birinci √ñƒüretim", "ƒ∞kinci √ñƒüretim", "Uzaktan √ñƒüretim"],
                "egitimDili": ["T√ºrk√ße", "ƒ∞ngilizce"],
                "stajDurumu": ["Mevcut Deƒüil", "Mevcut", "Zorunlu", "Se√ßmeli"],
                "dokumanDurumu": ["Taslak", "Onaylandƒ±", "Yayƒ±nlandƒ±", "Revize Edildi"]
            }
        };
        
        // √ñƒürenci notlarƒ± objesi olu≈ütur
        testStudents.forEach(student => {
            testCourseData.ogrenciNotlari[student.ogrenciNo] = {};
        });
        
        // JSON'u sisteme y√ºkle (applyJsonData fonksiyonunu kullan)
        const jsonString = JSON.stringify(testCourseData, null, 2);
        
        // JSON i√ßeriƒüini textarea'ya yerle≈ütir
        const jsonContent = document.getElementById('jsonContent');
        if (jsonContent) {
            jsonContent.value = jsonString;
        }
        
        // JSON'u otomatik olarak uygula
        APP_STATE.courseData = testCourseData;
        APP_STATE.jsonFileName = `test-ce100-algorithms-programming-ii-${Date.now()}.json`;
        
        // √ñƒürenme √ßƒ±ktƒ±larƒ± ve program √ßƒ±ktƒ±larƒ±nƒ± APP_STATE'e ata
        APP_STATE.learningOutcomes = testCourseData.dersOgrenme√áiktilari || [];
        APP_STATE.programOutcomes = testCourseData.programCiktilari || [];
        APP_STATE.outcomeMatrix = testCourseData.programVeOgrenmeIliskisi || null;
        
        // Verileri i≈üle
        importStudentData(testCourseData);
        createAssessmentTreeFromCourseData();
        
        // UI'larƒ± g√ºncelle
        renderTree();
        renderOutcomes();
        renderProgramOutcomes();
        renderCourseDetails();
        renderOutcomeMatrix();
        updateCourseInfo();
        updateAssessmentView();
        updateCategoryWeights();
        updateStudentTable();
        // updateStudentSelector fonksiyonu kaldƒ±rƒ±ldƒ± (√ñƒürenci Bazlƒ± Not Giri≈üi sekmesi ile birlikte)
        updateGroupSelectors();
        updateTreeMappingControls();
        
        showModernToast(`Ger√ßek MUDEK uyumlu test ders datasƒ± olu≈üturuldu: CE100 - Algorithms And Programming II (${numStudents} √∂ƒürenci)`, "success");
        
    } catch (error) {
        console.error("Test ders datasƒ± olu≈üturulurken hata:", error);
        showModernToast("Test ders datasƒ± olu≈üturulamadƒ±!", "error");
    }
}

/**
 * Bile≈üen i√ßin kaƒüƒ±t sƒ±rasƒ± bazƒ±nda giri≈ü b√∂l√ºm√º olu≈üturma
 * @param {Object} activity - Ana aktivite
 * @param {HTMLElement} container - Konteyner elementi
 */
function createComponentPaperOrderInputSection(activity, container) {
    try {
        const componentId = activity.id;
        const allQuestions = activity.children || [];
        const maxQuestions = allQuestions.length;
        
        // Grup se√ßeneklerini g√ºvenli ≈üekilde olu≈ütur
        const groups = (APP_STATE.courseData && APP_STATE.courseData.grupHaritalari && APP_STATE.courseData.grupHaritalari[componentId]) 
            ? APP_STATE.courseData.grupHaritalari[componentId].gruplar || ['A']
            : ['A'];
        
        // Grup sistemi her zaman kullanƒ±lƒ±r (tek grup olsa bile)
        const useGroupSystem = true;
        
        // Kaƒüƒ±t sƒ±rasƒ± bazƒ±nda b√∂l√ºmler olu≈ütur
        for (let paperOrder = 1; paperOrder <= maxQuestions; paperOrder++) {
            const paperSection = document.createElement('div');
            paperSection.className = 'paper-order-section';
            
            const paperHeader = document.createElement('h6');
            paperHeader.innerHTML = `Kaƒüƒ±t Sƒ±rasƒ± ${paperOrder}`;
            paperHeader.className = 'paper-order-header';
            paperSection.appendChild(paperHeader);
            
            const table = document.createElement('table');
            table.className = 'assessment-table paper-order-table';
            
            const tableHTML = `
                <thead>
                    <tr>
                        <th class="col-no">No</th>
                        <th class="col-studentId">√ñƒürenci No</th>
                        <th class="col-name">Adƒ±</th>
                        <th class="col-surname">Soyadƒ±</th>
                        <th class="col-email">E-posta</th>
                        <th class="col-group">Grup</th>
                        <th class="col-answerKey">Cevap Anahtarƒ± Sƒ±rasƒ±</th>
                        <th class="col-activityName">Etkinlik Adƒ±<br/><small>(Soru/Rubrik)</small></th>
                        <th class="col-description">A√ßƒ±klama</th>
                        <th class="col-maxPoints">Etkinlik Max. Puan<br/><small>(Soru/Rubrik)</small></th>
                        <th class="col-totalPoints">Toplam Puan</th>
                        <th class="col-outcomes">√ñ√á</th>
                        <th class="col-earnedPoints">Alƒ±nan Puan<br/><small>(Etkinlik Puanƒ±)</small></th>
                        <th class="col-termGrade">Yarƒ±yƒ±l ƒ∞√ßi<br/><small>(${getTermWeight()}%)</small></th>
                        <th class="col-finalGrade">Yarƒ±yƒ±l Sonu<br/><small>(${getFinalWeight()}%)</small></th>
                        <th class="col-average">Ortalama</th>
                        <th class="col-letterGrade">Harf Notu</th>
                    </tr>
                </thead>
                <tbody>
                    ${APP_STATE.studentData.map((student, index) => {
                        const studentCurrentGroup = getStudentGroupForComponent(student.studentId, componentId);
                        console.log(`üîç Kaƒüƒ±t sƒ±rasƒ± ${paperOrder} - ${componentId} i√ßin √∂ƒürenci ${student.studentId}: gruplar=${groups.join(',')}, mevcut=${studentCurrentGroup}`);
                        const groupOptions = groups.map(groupId => 
                            `<option value="${groupId}" ${studentCurrentGroup === groupId ? 'selected' : ''}>${groupId}</option>`
                        ).join('');
                        
                        // Bu kaƒüƒ±t sƒ±rasƒ±ndaki sorunun ger√ßek ID'sini bul
                        const actualQuestionId = getQuestionIdByPaperOrder(student.studentId, paperOrder, componentId);
                        const actualQuestion = findNodeById(actualQuestionId);
                        
                        // Cevap anahtarƒ±ndaki sƒ±rayƒ± bul
                        const answerKeyOrder = getAnswerKeyOrder(student.studentId, paperOrder, componentId);
                        
                        // Etkinlik bilgilerini al
                        const activityName = actualQuestion?.name || `Etkinlik ${answerKeyOrder || paperOrder}`;
                        const questionDescription = actualQuestion?.description || actualQuestion?.name || '-';
                        // D√úZELTME: actualQuestionId zaten grup bazlƒ± doƒüru soru, direkt puanƒ±nƒ± kullan
                        const maxPoints = actualQuestion?.points || 0;
                        const studentOutcomes = getQuestionOutcomesForStudent(student.studentId, actualQuestionId, componentId);
                        
                        // DEBUG: Tablo olu≈üturma sorunlarƒ± i√ßin
                        if (paperOrder === 1 && index < 3) {
                            console.log(`üîç D√úZELTME SONRASI - √ñƒürenci: ${student.studentId}, Grup: ${studentCurrentGroup}, PaperOrder: ${paperOrder}`);
                            console.log(`  - actualQuestionId: ${actualQuestionId}`);
                            console.log(`  - actualQuestion?.points: ${actualQuestion?.points}`);
                            console.log(`  - maxPoints: ${maxPoints}`);
                        }
                        
                        return `
                            <tr data-student-id="${student.studentId}" data-paper-order="${paperOrder}" data-component-id="${componentId}">
                                <td class="col-no">${index + 1}</td>
                                <td class="col-studentId">${student.studentId}</td>
                                <td class="col-name">${student.name}</td>
                                <td class="col-surname">${student.surname}</td>
                                <td class="col-email email-cell">
                                    <span class="email-text" title="${student.email || 'E-posta bulunamadƒ±'}">${student.email || '-'}</span>
                                    ${student.email ? `<button class="email-button" title="E-posta g√∂nder" onclick="openEmailModal({studentId: '${student.studentId}', name: '${student.name}', surname: '${student.surname}', email: '${student.email}'})">E-posta</button>` : ''}
                                </td>
                                <td class="col-group">
                                    <select class="group-selector compact" data-student-id="${student.studentId}" data-component-id="${componentId}" onchange="updateStudentGroupForComponent(this)">
                                        ${groupOptions}
                                    </select>
                                </td>
                                <td class="col-answerKey answer-key-order-cell">
                                    <span class="answer-key-badge" data-answer-key="${answerKeyOrder}" data-question-id="${actualQuestionId}">
                                        ${answerKeyOrder}
                                    </span>
                                </td>
                                <td class="col-activityName question-name-cell">
                                    <span class="question-name-badge">${activityName}</span>
                                </td>
                                <td class="col-description question-description-cell">
                                    <span class="question-desc-badge" title="${questionDescription}">${questionDescription}</span>
                                </td>
                                <td class="col-maxPoints question-points-cell" data-student-id="${student.studentId}" data-activity-id="${actualQuestionId}">
                                    ${maxPoints}
                                </td>
                                <td class="col-totalPoints total-points-cell" data-student-id="${student.studentId}" data-component-id="${componentId}">
                                    <div class="total-points-container">
                                        <span class="total-points-value">${getStudentTotalEarnedPointsForComponent(student.studentId, componentId)}</span>
                                        <button class="auto-distribute-btn" type="button" 
                                                data-student-id="${student.studentId}" 
                                                data-activity-id="${componentId}"
                                                title="Otomatik puan daƒüƒ±t">
                                            üéØ
                                        </button>
                                    </div>
                                </td>
                                <td class="col-outcomes outcomes-cell">
                                    <span class="outcomes-badge">${Array.isArray(studentOutcomes) ? studentOutcomes.join(', ') : (studentOutcomes || '-')}</span>
                                </td>
                                <td class="col-earnedPoints">
                                    <input type="number" min="0" max="100" 
                                        data-student-id="${student.studentId}" 
                                        data-activity-id="${actualQuestionId}"
                                        data-paper-order="${paperOrder}"
                                        value="${getStudentGrade(student.studentId, actualQuestionId) || ''}"
                                        onchange="updateStudentGrade(this)"
                                        placeholder="0-${maxPoints}"
                                        title="${useGroupSystem ? `Kaƒüƒ±t sƒ±rasƒ±: ${paperOrder}, Cevap anahtarƒ±: ${answerKeyOrder}, Maksimum puan: ${maxPoints}` : `Maksimum puan: ${maxPoints}`}"
                                    >
                                </td>
                                <td class="col-termGrade grade-summary-cell term-grade">${calculateStudentGrades(student.studentId).termGrade}</td>
                                <td class="col-finalGrade grade-summary-cell final-grade">${calculateStudentGrades(student.studentId).finalGrade}</td>
                                <td class="col-average grade-summary-cell total-grade">${calculateStudentGrades(student.studentId).totalGrade}</td>
                                <td class="col-letterGrade grade-summary-cell letter-grade ${getLetterGradeClass(calculateStudentGrades(student.studentId).letterGrade)}">${calculateStudentGrades(student.studentId).letterGrade}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            `;
            
            table.innerHTML = tableHTML;
            paperSection.appendChild(table);
            container.appendChild(paperSection);
        }
        
        // D√úZELTME: Tablo olu≈üturulduktan sonra t√ºm satƒ±rlarƒ± g√ºncelle
        // Bu, grup bazlƒ± maksimum puan g√∂sterimini d√ºzeltir
        setTimeout(() => {
            console.log('üîÑ Tablo olu≈üturma sonrasƒ± grup bazlƒ± g√ºncelleme ba≈ülatƒ±lƒ±yor...');
            APP_STATE.studentData.forEach(student => {
                const studentCurrentGroup = getStudentGroupForComponent(student.studentId, componentId);
                updateQuestionInfoForComponent(student.studentId, studentCurrentGroup, componentId);
            });
            console.log('‚úÖ Grup bazlƒ± g√ºncelleme tamamlandƒ±');
        }, 100);
        
    } catch (error) {
        console.error("Bile≈üen kaƒüƒ±t sƒ±rasƒ± giri≈ü b√∂l√ºm√º olu≈üturulurken hata olu≈ütu:", error);
    }
}

/**
 * √ñƒürencinin grubuna g√∂re belirli bir sorunun √∂ƒürenme √ßƒ±ktƒ±larƒ±nƒ± getir
 * @param {string} studentId - √ñƒürenci ID'si
 * @param {string} questionId - Soru ID'si
 * @param {string} componentId - Bile≈üen ID'si
 * @returns {Array} - √ñƒürenme √ßƒ±ktƒ±larƒ±
 */
function getQuestionOutcomesForStudent(studentId, questionId, componentId) {
    // Debug: getQuestionOutcomesForStudent √ßaƒürƒ±ldƒ±
    
    try {
        if (!questionId) {
            return [];
        }
        
        const question = findNodeById(questionId);
        
        if (!question) {
            return [];
        }
        
        if (!question.outcomes || question.outcomes.length === 0) {
            return [];
        }
        
        return question.outcomes || [];
    } catch (error) {
        console.error("Soru √∂ƒürenme √ßƒ±ktƒ±larƒ± alƒ±nƒ±rken hata:", error);
        return [];
    }
}

/**
 * Kaƒüƒ±t sƒ±rasƒ±na g√∂re ger√ßek soru ID'sini bulma
 * @param {string} studentId - √ñƒürenci ID'si
 * @param {number} paperOrder - Kaƒüƒ±ttaki sƒ±ra (1, 2, 3...)
 * @param {string} componentId - Bile≈üen ID'si
 * @returns {string} - Ger√ßek soru ID'si
 */
function getQuestionIdByPaperOrder(studentId, paperOrder, componentId) {
    try {
        const studentGroup = getStudentGroupForComponent(studentId, componentId);
        const parentNode = findNodeById(componentId);
        
        if (!parentNode || !parentNode.children) {
            return null;
        }
        
        // Grup haritasƒ± var mƒ± kontrol et
        const groupMappings = APP_STATE.courseData?.grupHaritalari?.[componentId]?.haritalar?.[studentGroup];
        
        if (groupMappings) {
            // Grup haritasƒ±na g√∂re kaƒüƒ±t sƒ±rasƒ±ndan ger√ßek soru ID'sini bul
            // Format 1: {position: questionId} - Yeni format
            if (groupMappings[paperOrder.toString()]) {
                return groupMappings[paperOrder.toString()];
            }
            // Format 2: {questionId: position} - Eski format desteƒüi
            for (const [questionId, position] of Object.entries(groupMappings)) {
                if (parseInt(position) === paperOrder) {
                    return questionId;
                }
            }
        }
        
        // Grup haritasƒ± yoksa, varsayƒ±lan sƒ±ralama
        if (parentNode.children[paperOrder - 1]) {
            return parentNode.children[paperOrder - 1].id;
        }
        
        return null;
    } catch (error) {
        console.error("Kaƒüƒ±t sƒ±rasƒ±ndan soru ID'si bulunamadƒ±:", error);
        return null;
    }
}

/**
 * Kaƒüƒ±t sƒ±rasƒ±ndan cevap anahtarƒ±ndaki sƒ±rayƒ± bulma
 * @param {string} studentId - √ñƒürenci ID'si
 * @param {number} paperOrder - Kaƒüƒ±ttaki sƒ±ra (1, 2, 3...)
 * @param {string} componentId - Bile≈üen ID'si
 * @returns {string} - Cevap anahtarƒ±ndaki sƒ±ra
 */
function getAnswerKeyOrder(studentId, paperOrder, componentId) {
    try {
        const actualQuestionId = getQuestionIdByPaperOrder(studentId, paperOrder, componentId);
        
        if (!actualQuestionId) {
            return `A1.${paperOrder}`;
        }
        
        // Soru ID'sini doƒürudan cevap anahtarƒ± sƒ±rasƒ± olarak d√∂nd√ºr
        // √ñrneƒüin A1.1 -> "A1.1", A1.2 -> "A1.2"
        return actualQuestionId;
    } catch (error) {
        console.error("Cevap anahtarƒ± sƒ±rasƒ± bulunamadƒ±:", error);
        return `A1.${paperOrder}`;
    }
}

// Test fonksiyonlarƒ±nƒ± global hale getir
window.generateRandomAssessment = generateRandomAssessment;
window.generateRandomGroups = generateRandomGroups;
window.generateRandomScores = generateRandomScores;
window.generateTestStudents = generateTestStudents;
window.generateFullTestData = generateFullTestData;
window.clearAllTestData = clearAllTestData;
window.generateTestCourseData = generateTestCourseData;

// Test butonlarƒ±na event listener ekle
document.addEventListener('DOMContentLoaded', function() {
    // Test i≈ülemleri butonlarƒ±
    const testButtons = [
        { id: 'btnGenerateRandomTermAssessment', func: generateMultipleRandomTermAssessments },
        { id: 'btnGenerateRandomFinalAssessment', func: generateMultipleRandomFinalAssessments },
        { id: 'btnGenerateRandomGroups', func: generateRandomGroups },
        { id: 'btnGenerateIntelligentScores', func: generateIntelligentScores },
        { id: 'btnGenerateTestStudents', func: generateTestStudents },

        { id: 'btnGenerateTestCourseData', func: generateTestCourseData },
        { id: 'btnClearAllTestData', func: clearAllTestData },
        // Yeni temizleme butonlarƒ±
        { id: 'btnClearAssessments', func: clearAssessments },
        { id: 'btnClearGroups', func: clearGroups },
        { id: 'btnClearScores', func: clearScores },
        { id: 'btnClearStudents', func: clearAllStudents },
        { id: 'btnResetSystem', func: resetCompleteSystem }
    ];
    
    testButtons.forEach(button => {
        const element = document.getElementById(button.id);
        if (element) {
            element.addEventListener('click', function() {
                console.log(`Test i≈ülemi ba≈ülatƒ±ldƒ±: ${button.id}`);
                
                // Loading durumu ekle
                element.classList.add('loading');
                element.disabled = true;
                
                try {
                    // Fonksiyonu √ßaƒüƒ±r
                    const result = button.func();
                    
                    // Promise ise bekle
                    if (result && typeof result.then === 'function') {
                        result.finally(() => {
                            element.classList.remove('loading');
                            element.disabled = false;
                        });
                    } else {
                        // Kƒ±sa bir gecikme sonra loading'i kaldƒ±r
                        setTimeout(() => {
                            element.classList.remove('loading');
                            element.disabled = false;
                        }, 500);
                    }
                } catch (error) {
                    console.error(`Test i≈ülemi hatasƒ± (${button.id}):`, error);
                    element.classList.remove('loading');
                    element.disabled = false;
                    showModernToast(`Test i≈ülemi ba≈üarƒ±sƒ±z: ${error.message}`, "error");
                }
            });
        } else {
            console.warn(`Test butonu bulunamadƒ±: ${button.id}`);
        }
    });
    
    console.log('Test i≈ülemleri butonlarƒ± ba≈üarƒ±yla y√ºklendi!');
    
    // Rastgele deƒüerlendirme slider kontrollerini ba≈ülat (akƒ±llƒ± puanlama dahil)
    initializeAssessmentSliders();
    
    // Akƒ±llƒ± puanlama kontrollerini ba≈ülat
    initializeSmartScoringControls();
    
    // Grup istatistiklerini ba≈ülat
    updateGroupStatistics();
    
    // √ñƒürenci filtresini ba≈ülat
    initializeAssessmentStudentFilter();
    
    // √ñƒürenci sayƒ±larƒ±nƒ± ba≈ülangƒ±√ßta g√ºncelle
    updatePassFailCounts();
});

// =====================================================
// AKILLI PUANLAMA KONTROLLERƒ∞
// =====================================================

/**
 * Akƒ±llƒ± puanlama kontrol elemanlarƒ±nƒ± ba≈ülatƒ±r
 */
function initializeSmartScoringControls() {
    console.log('üîç Akƒ±llƒ± puanlama kontrolleri ba≈ülatƒ±lƒ±yor...');
    
    const passRateSlider = document.getElementById('passRateSlider');
    const passRateValue = document.getElementById('passRateValue');
    const failRateDisplay = document.getElementById('failRateDisplay');
    const passRateDisplay = document.getElementById('passRateDisplay');
    
    // Debug loglarƒ±
    console.log('passRateSlider:', passRateSlider ? '‚úÖ Bulundu' : '‚ùå Bulunamadƒ±');
    console.log('passRateValue:', passRateValue ? '‚úÖ Bulundu' : '‚ùå Bulunamadƒ±');
    console.log('failRateDisplay:', failRateDisplay ? '‚úÖ Bulundu' : '‚ùå Bulunamadƒ±');
    console.log('passRateDisplay:', passRateDisplay ? '‚úÖ Bulundu' : '‚ùå Bulunamadƒ±');
    
    if (passRateSlider && passRateValue && failRateDisplay && passRateDisplay) {
        // Slider deƒüi≈üim event'i
        passRateSlider.addEventListener('input', function() {
            const passRate = parseInt(this.value);
            const failRate = 100 - passRate;
            
            // Deƒüerleri g√ºncelle
            passRateValue.textContent = passRate + '%';
            passRateDisplay.textContent = passRate + '%';
            failRateDisplay.textContent = failRate + '%';
            
            // √ñƒürenci sayƒ±sƒ±nƒ± g√ºncelle
            updateStudentCounts(passRate);
            
            // Slider renk ge√ßi≈üini g√ºncelle
            updateSliderGradient(this, passRate);
        });
        
        // Ba≈ülangƒ±√ß deƒüerini ayarla
        const initialValue = parseInt(passRateSlider.value);
        updateSliderGradient(passRateSlider, initialValue);
        updateStudentCounts(initialValue);
        
        console.log('üéØ Akƒ±llƒ± puanlama kontrolleri ba≈üarƒ±yla ba≈ülatƒ±ldƒ±');
    } else {
        console.warn('‚ö†Ô∏è Akƒ±llƒ± puanlama kontrollerinin bazƒ± elemanlarƒ± bulunamadƒ±');
    }
}

/**
 * √ñƒürenci sayƒ± bilgilerini g√ºnceller
 * @param {number} passRate - Ge√ßen √∂ƒürenci oranƒ±
 */
function updateStudentCounts(passRate) {
    // Genel updatePassFailCounts fonksiyonunu kullan
    updatePassFailCounts();
    
    // Fail rate display'i de g√ºncelle
    const failRateDisplay = document.getElementById('failRateDisplay');
    if (failRateDisplay) {
        failRateDisplay.textContent = (100 - passRate) + '%';
    }
}

/**
 * Slider'ƒ±n renk ge√ßi≈üini g√ºnceller
 * @param {HTMLElement} slider - Slider elementi
 * @param {number} passRate - Ge√ßen √∂ƒürenci oranƒ±
 */
function updateSliderGradient(slider, passRate) {
    // 0-100 aralƒ±ƒüƒ±nda y√ºzde hesaplama
    const percentage = passRate;
    
    // Dinamik renk hesaplama - 0'dan ba≈ülayacak ≈üekilde g√ºncellendi
    let gradientColor;
    if (passRate <= 10) {
        gradientColor = '#8b0000'; // Koyu kƒ±rmƒ±zƒ± - hepsi kalƒ±yor
    } else if (passRate < 30) {
        gradientColor = '#e74c3c'; // Kƒ±rmƒ±zƒ± - √ßok d√º≈ü√ºk
    } else if (passRate < 50) {
        gradientColor = '#f39c12'; // Turuncu - d√º≈ü√ºk
    } else if (passRate < 70) {
        gradientColor = '#f1c40f'; // Sarƒ± - orta
    } else if (passRate < 85) {
        gradientColor = '#27ae60'; // Ye≈üil - iyi
    } else {
        gradientColor = '#2980b9'; // Mavi - m√ºkemmel
    }
    
    // CSS √∂zelliƒüini g√ºncelle - 0'dan ba≈ülayan gradient
    slider.style.background = `linear-gradient(90deg, #8b0000 0%, #e74c3c 15%, #f39c12 35%, #f1c40f 55%, #27ae60 75%, #2980b9 100%)`;
}

// =====================================================
// √ñ√á TOOLTIP Sƒ∞STEMƒ∞
// =====================================================

/**
 * √ñ√á Badge'lerine tooltip sistemi ekler ve tƒ±klama fonksiyonunu ayarlar
 */
function initializeOutcomeTooltips() {
    // Mevcut tooltip'leri temizle
    document.querySelectorAll('.outcome-tooltip').forEach(tooltip => tooltip.remove());
    
    // T√ºm outcomes badge'lerini bul
    document.querySelectorAll('.outcomes-badge').forEach(badge => {
        const outcomeCodes = badge.textContent.trim().split(',').map(code => code.trim()).filter(code => code && code !== '-');
        
        // √áok fazla √ñ√á varsa (3'ten fazla) tƒ±klanabilir yap
        if (outcomeCodes.length > 3) {
            badge.classList.add('clickable', 'many-outcomes');
            badge.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                showOutcomeDetailModal(outcomeCodes);
            });
            // √áok √ñ√á olan badge'lerde tooltip yerine sadece basit bilgi
            badge.title = `${outcomeCodes.length} √∂ƒürenme √ßƒ±ktƒ±sƒ± - Detaylar i√ßin tƒ±klayƒ±n`;
        } else {
            // Az √ñ√á olan badge'lerde normal tooltip
        badge.addEventListener('mouseenter', showOutcomeTooltip);
        badge.addEventListener('mouseleave', hideOutcomeTooltip);
        }
    });
}

/**
 * √ñ√á tooltip'ini g√∂sterir
 * @param {Event} event - Mouse event
 */
function showOutcomeTooltip(event) {
    const badge = event.target;
    const outcomeCodes = badge.textContent.trim().split(',').map(code => code.trim()).filter(code => code && code !== '-');
    
    if (outcomeCodes.length === 0) return;
    
    // Tooltip olu≈ütur
    const tooltip = document.createElement('div');
    tooltip.className = 'outcome-tooltip';
    
    let tooltipContent = '';
    
    outcomeCodes.forEach((code, index) => {
        const outcome = getOutcomeInfo(code);
        const relations = getProgramOutcomeRelations(code);
        
        if (index > 0) tooltipContent += '<hr style="margin: 8px 0; border: none; border-top: 1px solid #455a64;">';
        
        tooltipContent += `
            <div class="outcome-tooltip-content">
                <div class="outcome-tooltip-title">${code}</div>
                <div class="outcome-tooltip-description">${outcome.description || 'A√ßƒ±klama bulunamadƒ±'}</div>
                ${relations.length > 0 ? `
                    <div class="outcome-tooltip-relations">
                        <strong style="color: #81c784;">Program √áƒ±ktƒ±sƒ± ƒ∞li≈ükileri:</strong><br>
                        ${relations.map(rel => `
                            <div class="outcome-relation">
                                <div style="display: flex; align-items: center; margin-bottom: 4px;">
                                    <span style="color: #4fc3f7; font-weight: bold;">${code}</span>
                                    <span class="outcome-relation-arrow">‚Üí</span>
                                    <span class="relation-level-${rel.level}">${rel.level}</span>
                                    <span class="outcome-relation-arrow">‚Üí</span>
                                    <span class="program-outcome-badge">${rel.programOutcome}</span>
                                    <span class="outcome-relation-level">${getRelationLevelText(rel.level)}</span>
                                </div>
                                ${rel.description ? `
                                    <div style="color: #b0bec5; font-size: 11px; margin-left: 8px; line-height: 1.3; padding: 2px 0;">
                                        <strong>${rel.programOutcome}:</strong> ${rel.description}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            </div>
        `;
    });
    
    tooltip.innerHTML = tooltipContent;
    document.body.appendChild(tooltip);
    
    // Tooltip pozisyonunu ayarla
    positionTooltip(tooltip, badge);
    
    // Tooltip'i g√∂ster
    setTimeout(() => {
        tooltip.classList.add('show');
    }, 10);
}

/**
 * √ñ√á tooltip'ini gizler
 */
function hideOutcomeTooltip() {
    document.querySelectorAll('.outcome-tooltip').forEach(tooltip => {
        tooltip.classList.remove('show');
        setTimeout(() => {
            tooltip.remove();
        }, 200);
    });
}

/**
 * Tooltip pozisyonunu ayarlar (fixed positioning ile)
 * @param {HTMLElement} tooltip - Tooltip elementi
 * @param {HTMLElement} badge - Badge elementi
 */
function positionTooltip(tooltip, badge) {
    const badgeRect = badge.getBoundingClientRect();
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;
    const scrollTop = window.scrollY || document.documentElement.scrollTop;
    
    // ƒ∞lk olarak tooltip'i g√∂sterip boyutunu √∂l√ßelim
    tooltip.style.visibility = 'hidden';
    tooltip.style.display = 'block';
    const tooltipRect = tooltip.getBoundingClientRect();
    tooltip.style.visibility = 'visible';
    
    // Tooltip pozisyonunu hesapla (badge'in ortasƒ±ndan)
    let left = badgeRect.left + (badgeRect.width / 2) - (tooltipRect.width / 2);
    let top = badgeRect.bottom + 8;
    
    // Saƒü taraftan ta≈üma kontrol√º
    if (left + tooltipRect.width > viewportWidth - 15) {
        left = viewportWidth - tooltipRect.width - 15;
    }
    
    // Sol taraftan ta≈üma kontrol√º
    if (left < 15) {
        left = 15;
    }
    
    // Alt taraftan ta≈üma kontrol√º - tooltip'i yukarƒ± ta≈üƒ±
    if (top + tooltipRect.height > viewportHeight - 15) {
        top = badgeRect.top - tooltipRect.height - 8;
    }
    
    // √úst taraftan ta≈üma kontrol√º
    if (top < 15) {
        top = badgeRect.bottom + 8;
    }
    
    tooltip.style.left = left + 'px';
    tooltip.style.top = top + 'px';
}

/**
 * √ñ√á bilgilerini getirir
 * @param {string} outcomeCode - √ñ√á kodu
 * @returns {Object} - √ñ√á bilgileri
 */
function getOutcomeInfo(outcomeCode) {
    if (APP_STATE.learningOutcomes) {
        const outcome = APP_STATE.learningOutcomes.find(o => o.id === outcomeCode || o.kod === outcomeCode);
        if (outcome) {
            return {
                code: outcome.id || outcome.kod,
                description: outcome.aciklama || outcome.a√ßƒ±klama || outcome.description
            };
        }
    }
    
    return {
        code: outcomeCode,
        description: 'A√ßƒ±klama bulunamadƒ±'
    };
}

/**
 * Program √ßƒ±ktƒ±sƒ± ili≈ükilerini getirir
 * @param {string} outcomeCode - √ñ√á kodu
 * @returns {Array} - Program √ßƒ±ktƒ±sƒ± ili≈ükileri
 */
function getProgramOutcomeRelations(outcomeCode) {
    const relations = [];
    
    if (APP_STATE.outcomeMatrix && APP_STATE.outcomeMatrix.iliskiTablosu && APP_STATE.programOutcomes) {
        const relation = APP_STATE.outcomeMatrix.iliskiTablosu.find(r => r.ogrenme√áiktisiID === outcomeCode);
        
        if (relation && relation.program√áiktilariIliskileri) {
            APP_STATE.programOutcomes.forEach(po => {
                const level = relation.program√áiktilariIliskileri[po.id];
                if (level && level > 0) {
                    relations.push({
                        programOutcome: po.id,
                        level: level,
                        description: po.aciklama || po.a√ßƒ±klama || po.description
                    });
                }
            });
        }
    }
    
    return relations.sort((a, b) => b.level - a.level); // Seviyeye g√∂re azalan sƒ±ralama
}

/**
 * √ñ√á detay modalƒ±nƒ± g√∂sterir
 * @param {Array} outcomeCodes - √ñ√á kodlarƒ±
 */
function showOutcomeDetailModal(outcomeCodes) {
    const modal = document.getElementById('outcomeDetailModal');
    const container = document.getElementById('outcomeDetailContainer');
    
    if (!modal || !container) return;
    
    // Modal i√ßeriƒüini olu≈ütur
    let modalContent = '';
    
    outcomeCodes.forEach((code, index) => {
        const outcome = getOutcomeInfo(code);
        const relations = getProgramOutcomeRelations(code);
        
        modalContent += `
            <div class="outcome-detail-item">
                <div class="outcome-detail-header">
                    <span class="outcome-detail-code">${code}</span>
                    <h4 class="outcome-detail-title">√ñƒürenme √áƒ±ktƒ±sƒ± ${index + 1}</h4>
                </div>
                <div class="outcome-detail-description">
                    ${outcome.description || 'A√ßƒ±klama bulunamadƒ±'}
                </div>
                ${relations.length > 0 ? `
                    <div class="outcome-detail-relations">
                        <h5>üéØ Program √áƒ±ktƒ±sƒ± ƒ∞li≈ükileri</h5>
                        <div class="outcome-relation-list">
                            ${relations.map(rel => `
                                <div class="outcome-relation-item">
                                    <span class="program-outcome-code">${rel.programOutcome}</span>
                                    <span class="relation-arrow">‚Üí</span>
                                    <span class="relation-level-badge level-${rel.level}">${rel.level}</span>
                                    <span>${getRelationLevelText(rel.level)}</span>
                                </div>
                                ${rel.description ? `
                                    <div class="relation-description">
                                        <strong>${rel.programOutcome}:</strong> ${rel.description}
                                    </div>
                                ` : ''}
                            `).join('')}
                        </div>
                    </div>
                ` : '<div class="outcome-detail-relations"><p style="color: #666; font-style: italic;">Program √ßƒ±ktƒ±sƒ± ili≈ükisi bulunamadƒ±</p></div>'}
            </div>
        `;
    });
    
    container.innerHTML = modalContent;
    
    // Modal'ƒ± a√ß
    openModernModal('outcomeDetailModal');
}

/**
 * ƒ∞li≈üki seviyesi metnini d√∂nd√ºr√ºr
 * @param {number} level - ƒ∞li≈üki seviyesi
 * @returns {string} - ƒ∞li≈üki seviyesi metni
 */
function getRelationLevelText(level) {
    const levelTexts = {
        0: 'ƒ∞li≈üki Yok',
        1: '√áok Zayƒ±f',
        2: 'Zayƒ±f', 
        3: 'Orta',
        4: 'G√º√ßl√º',
        5: '√áok G√º√ßl√º'
    };
    return levelTexts[level] || 'Bilinmiyor';
}

/**
 * √ñƒürenci i√ßin detaylƒ± e-posta i√ßeriƒüi olu≈üturur
 * @param {string} studentId - √ñƒürenci ID'si
 * @returns {Object} - E-posta konusu ve i√ßeriƒüi
 */
function generateDetailedEmailContent(studentId) {
    try {
        // √ñƒürenci bilgilerini bul - id ve studentId her ikisini de kontrol et
        const student = APP_STATE.studentData.find(s => s.id === studentId || s.studentId === studentId);
        if (!student) {
            console.warn('√ñƒürenci bulunamadƒ±:', studentId);
            return { 
                subject: 'Ders Not Durumu', 
                body: '√ñƒürenci bilgileri y√ºklenirken bir hata olu≈ütu. L√ºtfen tekrar deneyiniz.' 
            };
        }

        // Not hesaplama
        const grades = calculateStudentGrades(studentId);
        
        // Kurs bilgileri
        const courseInfo = APP_STATE.courseData || {};
        const courseName = courseInfo.dersBilgisi?.dersAdi || courseInfo.dersGenel?.dersAdi || 'Ders Adƒ± Bulunamadƒ±';
        const courseTerm = courseInfo.dersBilgisi?.donem || courseInfo.dersGenel?.akademikYil || 'D√∂nem Bilgisi Yok';
        const instructor = courseInfo.dersBilgisi?.ogretimUyesi || courseInfo.dersIcerik?.dersiVerenOgretimUyesiOgretimGorevlisi || '√ñƒüretim √úyesi';
        
        // E-posta konusu
        const subject = `${courseName} - Ders Not Durumu - ${student.name} ${student.surname}`;
        
        // Ge√ßme notu (genellikle 60 veya DD)
        const passingGrade = 60;
        const isPassing = grades.totalGrade >= passingGrade;
        
        // Detaylƒ± notlar listesi
        let detailedScores = '';
        
        // Assessment tree'den etkinlik detaylarƒ±nƒ± al
        if (APP_STATE.assessmentTree && APP_STATE.assessmentTree.length > 0) {
            const termActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('A'));
            const finalActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('F'));
            
            // Yarƒ±yƒ±l i√ßi etkinlikler
            if (termActivities.length > 0) {
                detailedScores += `
                <div class="activity-category">
                    <h4>üìã Yarƒ±yƒ±l ƒ∞√ßi Etkinlikler</h4>`;
                
                termActivities.forEach(activity => {
                    const activityScore = getStudentActivityScore(studentId, activity.id);
                    const maxScore = getActivityMaxScore(activity.id);
                    const displayName = getComponentDisplayName(activity.id);
                    const percentage = maxScore > 0 ? ((activityScore / maxScore) * 100).toFixed(2) : '0.0';
                    
                    detailedScores += `
                    <div class="activity-item">
                        <div class="activity-name">${displayName}</div>
                        <div class="activity-score">
                            <span class="score-value">${activityScore.toFixed(2)}/${maxScore}</span>
                            <span class="score-percentage">%${percentage}</span>
                        </div>
                    </div>`;
                });
                
                detailedScores += `</div>`;
            }
            
            // Yarƒ±yƒ±l sonu etkinlikler
            if (finalActivities.length > 0) {
                detailedScores += `
                <div class="activity-category">
                    <h4>üìù Yarƒ±yƒ±l Sonu Etkinlikler</h4>`;
                
                finalActivities.forEach(activity => {
                    const activityScore = getStudentActivityScore(studentId, activity.id);
                    const maxScore = getActivityMaxScore(activity.id);
                    const displayName = getComponentDisplayName(activity.id);
                    const percentage = maxScore > 0 ? ((activityScore / maxScore) * 100).toFixed(2) : '0.0';
                    
                    detailedScores += `
                    <div class="activity-item">
                        <div class="activity-name">${displayName}</div>
                        <div class="activity-score">
                            <span class="score-value">${activityScore.toFixed(2)}/${maxScore}</span>
                            <span class="score-percentage">%${percentage}</span>
                        </div>
                    </div>`;
                });
                
                detailedScores += `</div>`;
            }
        }
        
        // Text tabanlƒ± e-posta i√ßeriƒüi - sembollerle g√∂rselle≈ütirilmi≈ü
        let termActivitiesText = '';
        let finalActivitiesText = '';
        
        // Assessment tree'den etkinlik detaylarƒ±nƒ± al
        if (APP_STATE.assessmentTree && APP_STATE.assessmentTree.length > 0) {
            const termActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('A'));
            const finalActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('F'));
            
            // Yarƒ±yƒ±l i√ßi etkinlikler
            if (termActivities.length > 0) {
                termActivitiesText = termActivities.map(activity => {
                    const activityScore = getStudentActivityScore(studentId, activity.id);
                    const maxScore = getActivityMaxScore(activity.id);
                    const displayName = getComponentDisplayName(activity.id);
                    const percentage = maxScore > 0 ? ((activityScore / maxScore) * 100).toFixed(2) : '0.0';
                    
                    return `- ${displayName}: ${activityScore.toFixed(2)}/${maxScore} (%${percentage})`;
                }).join('\n');
            }
            
            // Yarƒ±yƒ±l sonu etkinlikler
            if (finalActivities.length > 0) {
                finalActivitiesText = finalActivities.map(activity => {
                    const activityScore = getStudentActivityScore(studentId, activity.id);
                    const maxScore = getActivityMaxScore(activity.id);
                    const displayName = getComponentDisplayName(activity.id);
                    const percentage = maxScore > 0 ? ((activityScore / maxScore) * 100).toFixed(2) : '0.0';
                    
                    return `- ${displayName}: ${activityScore.toFixed(2)}/${maxScore} (%${percentage})`;
                }).join('\n');
            }
        }
        
        const body = `==================================================
              DERS NOT DURUMU
              ${courseName}
                ${courseTerm}
==================================================

Sayin ${student.name} ${student.surname} (${student.studentId}),

${courseName} dersi kapsaminda aldiginiz notlar ve basari durumunuz 
asagida detayli olarak belirtilmistir.

GENEL NOT OZETI:
- Yariyil Ici Notu    : ${grades.termGrade.toFixed(2)}/100
- Yariyil Sonu Notu   : ${grades.finalGrade.toFixed(2)}/100
- Toplam Basari Notu  : ${grades.totalGrade.toFixed(2)}/100
- Harf Notu          : ${grades.letterGrade}
${isPassing ? '* BASARILI - Dersi gectiniz!' : '* BASARISIZ - Ders tekrari gerekiyor'}

${termActivitiesText ? `YARIYIL ICI ETKINLIKLER:
${termActivitiesText}

` : ''}${finalActivitiesText ? `YARIYIL SONU ETKINLIKLER:
${finalActivitiesText}

` : ''}DEGERLENDIRME KRITERLERI:
- Yariyil Ici Agirligi: %${APP_STATE.courseData?.dersGenel?.yariYiliciAgirligi || 40}
- Yariyil Sonu Agirligi: %${APP_STATE.courseData?.dersGenel?.yariYilSonuAgirligi || 60}
- Basari Siniri: 60/100 (DD)

==================================================
Bu e-posta otomatik olarak ${new Date().toLocaleDateString('tr-TR')} tarihinde olusturulmustur.

Iyi calismalar,
${instructor}
==================================================`;


        return { subject, body };
        
    } catch (error) {
        console.error('E-posta i√ßeriƒüi olu≈üturulurken hata:', error);
        return { 
            subject: 'Not Bilgisi - Hata', 
            body: 'Not bilgileri olu≈üturulurken bir hata meydana geldi. L√ºtfen √∂ƒüretim √ºyenizle ileti≈üime ge√ßiniz.' 
        };
    }
}

/**
 * √ñƒürencinin bir etkinlikteki puanƒ±nƒ± getirir
 * @param {string} studentId - √ñƒürenci ID'si  
 * @param {string} activityId - Etkinlik ID'si
 * @returns {number} - √ñƒürencinin puanƒ±
 */
function getStudentActivityScore(studentId, activityId) {
    let totalScore = 0;
    
    function searchNode(node) {
        if (node.id === activityId && node.students && node.students[studentId]) {
            totalScore += parseFloat(node.students[studentId].grade || 0);
        }
        
        if (node.children) {
            node.children.forEach(child => searchNode(child));
        }
    }
    
    // T√ºm assessment tree'de ara
    if (APP_STATE.assessmentTree) {
        APP_STATE.assessmentTree.forEach(activity => {
            searchNode(activity);
        });
    }
    
    return totalScore;
}

/**
 * Etkinliƒüin maksimum puanƒ±nƒ± getirir
 * @param {string} activityId - Etkinlik ID'si
 * @returns {number} - Maksimum puan
 */
function getActivityMaxScore(activityId) {
    let maxScore = 0;
    
    function searchNode(node) {
        if (node.id === activityId) {
            maxScore += parseFloat(node.points || 0);
        }
        
        if (node.children) {
            node.children.forEach(child => searchNode(child));
        }
    }
    
    // T√ºm assessment tree'de ara
    if (APP_STATE.assessmentTree) {
        APP_STATE.assessmentTree.forEach(activity => {
            searchNode(activity);
        });
    }
    
    return maxScore;
}

/* =====================================================
   E-POSTA MODAL Sƒ∞STEMƒ∞
   ===================================================== */

// Global deƒüi≈ükenler
let selectedEmailType = null;
let currentStudentForEmail = null;

/**
 * E-posta modalƒ±nƒ± a√ßar
 * @param {Object} student - √ñƒürenci objesi
 */
function openEmailModal(student) {
    currentStudentForEmail = student;
    
    // Yeni modal olu≈ütur
    createNewEmailModal();
    
    const modal = document.getElementById('newEmailModal');
    modal.style.display = 'flex';
    setTimeout(() => {
        modal.classList.add('active');
    }, 10);
}

/**
 * Yeni e-posta modalƒ±nƒ± olu≈üturur
 */
function createNewEmailModal() {
    // Eski modal varsa kaldƒ±r
    const existingModal = document.getElementById('newEmailModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    const modal = document.createElement('div');
    modal.id = 'newEmailModal';
    modal.className = 'modal-overlay';
    
    modal.innerHTML = `
        <div class="new-modal-content">
            <div class="modal-header">
                <h2>üìß E-posta G√∂nder</h2>
                <span class="modal-close" onclick="closeNewEmailModal()">&times;</span>
            </div>
            
            <div class="modal-body">
                <!-- √ñƒürenci Bilgileri -->
                <div class="student-info-section">
                    <div class="student-info-card">
                        <div class="student-avatar">
                            ${currentStudentForEmail.name.charAt(0)}${currentStudentForEmail.surname.charAt(0)}
                        </div>
                        <div class="student-details">
                            <div class="student-name-display">${currentStudentForEmail.name} ${currentStudentForEmail.surname}</div>
                            <div class="student-meta">${currentStudentForEmail.studentId} ‚Ä¢ ${currentStudentForEmail.email}</div>
                        </div>
                    </div>
                </div>
                
                <!-- E-posta T√ºr√º Se√ßimi -->
                <div class="email-type-selection">
                    <h3>E-posta t√ºr√ºn√º se√ßin:</h3>
                    
                    <div class="email-type-grid">
                        <div class="email-type-card" data-type="survey">
                            <div class="card-icon">üìã</div>
                            <h4>Anket E-postasƒ±</h4>
                            <p>Ders bazƒ±nda √∂ƒürenme √ßƒ±ktƒ±larƒ± anketi</p>
                        </div>
                        
                        <div class="email-type-card" data-type="detailed">
                            <div class="card-icon">üìä</div>
                            <h4>Detaylƒ± Puan Raporu</h4>
                            <p>T√ºm sƒ±nav ve √∂dev sonu√ßlarƒ±</p>
                        </div>
                        
                        <div class="email-type-card" data-type="analysis">
                            <div class="card-icon">üìà</div>
                            <h4>√ñ√á-P√á Analiz Raporu</h4>
                            <p>√ñƒürenme √ßƒ±ktƒ±larƒ± ve program √ßƒ±ktƒ±larƒ± analizi</p>
                        </div>
                        
                        <div class="email-type-card" data-type="info">
                            <div class="card-icon">üí¨</div>
                            <h4>Bilgi Talebi</h4>
                            <p>G√∂r√º≈üme daveti ve bilgi toplama</p>
                        </div>
                    </div>
                </div>
                
                <!-- Format Se√ßimi -->
                <div class="format-selection" id="formatSelection" style="display: none;">
                    <h3>G√∂nderim formatƒ±nƒ± se√ßin:</h3>
                    
                    <div class="format-options">
                        <div class="format-option text-option">
                            <div class="format-header">
                                <div class="format-icon">üìù</div>
                                <div class="format-title">
                                    <h4>Sade Text Format</h4>
                                    <p>D√ºz metin formatƒ±nda, Gmail'de direkt a√ßƒ±lƒ±r</p>
                                </div>
                            </div>
                            <div class="format-features">
                                <span class="feature">‚úÖ Hƒ±zlƒ± ve basit</span>
                                <span class="feature">‚úÖ T√ºm e-posta istemcilerinde √ßalƒ±≈üƒ±r</span>
                                <span class="feature">‚úÖ Direkt Gmail'de a√ßƒ±lƒ±r</span>
                            </div>
                            <button class="format-btn text-btn" onclick="sendTextEmail()">üìß Direkt G√∂nder</button>
                        </div>
                        
                        <div class="format-option html-option recommended">
                            <div class="recommended-badge">√ñnerilen</div>
                            <div class="format-header">
                                <div class="format-icon">üé®</div>
                                <div class="format-title">
                                    <h4>HTML Format</h4>
                                    <p>Renkli, tablolu, profesy√∂nel g√∂r√ºn√ºm</p>
                                </div>
                            </div>
                            <div class="format-features">
                                <span class="feature">‚úÖ Profesy√∂nel tasarƒ±m</span>
                                <span class="feature">‚úÖ Renkli tablolar ve checkbox'lar</span>
                                <span class="feature">‚úÖ Gmail'de m√ºkemmel g√∂r√ºn√ºm</span>
                            </div>
                            <button class="format-btn html-btn" onclick="sendHtmlEmail()">üé® HTML G√∂nder</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // CSS stilleri ekle
    if (!document.querySelector('#newEmailModalStyles')) {
        const styles = document.createElement('style');
        styles.id = 'newEmailModalStyles';
        styles.textContent = `
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                opacity: 0;
                transition: opacity 0.3s ease;
            }
            
            .modal-overlay.active {
                opacity: 1;
            }
            
            .new-modal-content {
                background: white;
                border-radius: 15px;
                max-width: 700px;
                width: 90%;
                max-height: 90vh;
                overflow-y: auto;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                transform: scale(0.9);
                transition: transform 0.3s ease;
            }
            
            .modal-overlay.active .new-modal-content {
                transform: scale(1);
            }
            
            .modal-header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-radius: 15px 15px 0 0;
            }
            
            .modal-header h2 {
                margin: 0;
                font-size: 24px;
            }
            
            .modal-close {
                background: none;
                border: none;
                color: white;
                font-size: 28px;
                cursor: pointer;
                line-height: 1;
                padding: 0;
                width: 30px;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                transition: background 0.3s;
            }
            
            .modal-close:hover {
                background: rgba(255, 255, 255, 0.2);
            }
            
            .modal-body {
                padding: 30px;
            }
            
            .student-info-card {
                display: flex;
                align-items: center;
                gap: 15px;
                padding: 20px;
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                border-radius: 12px;
                margin-bottom: 30px;
                border: 1px solid #dee2e6;
            }
            
            .student-avatar {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                width: 60px;
                height: 60px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                font-size: 24px;
                text-transform: uppercase;
            }
            
            .student-name-display {
                font-weight: bold;
                font-size: 20px;
                margin-bottom: 5px;
                color: #333;
            }
            
            .student-meta {
                color: #666;
                font-size: 14px;
            }
            
            .email-type-selection h3 {
                margin-bottom: 20px;
                color: #333;
                font-size: 18px;
            }
            
            .email-type-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 15px;
                margin-bottom: 30px;
            }
            
            .email-type-card {
                padding: 20px;
                border: 2px solid #e9ecef;
                border-radius: 12px;
                cursor: pointer;
                transition: all 0.3s ease;
                background: #fff;
            }
            
            .email-type-card:hover {
                border-color: #667eea;
                transform: translateY(-2px);
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.15);
            }
            
            .email-type-card.selected {
                border-color: #667eea;
                background: linear-gradient(135deg, #f8f9ff 0%, #e8f1ff 100%);
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
            }
            
            .email-type-card .card-icon {
                font-size: 32px;
                margin-bottom: 10px;
            }
            
            .email-type-card h4 {
                margin: 0 0 8px 0;
                color: #333;
                font-size: 16px;
            }
            
            .email-type-card p {
                margin: 0;
                color: #666;
                font-size: 14px;
            }
            
            .format-selection {
                margin-top: 30px;
                padding-top: 30px;
                border-top: 2px solid #e9ecef;
            }
            
            .format-selection h3 {
                margin-bottom: 20px;
                color: #333;
                font-size: 18px;
            }
            
            .format-options {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
            }
            
            .format-option {
                border: 2px solid #e9ecef;
                border-radius: 12px;
                padding: 25px;
                background: #fff;
                transition: all 0.3s ease;
                position: relative;
            }
            
            .format-option.recommended {
                border-color: #28a745;
                background: linear-gradient(135deg, #f8fff9 0%, #e8f8e9 100%);
            }
            
            .recommended-badge {
                position: absolute;
                top: -10px;
                right: 15px;
                background: #28a745;
                color: white;
                padding: 5px 15px;
                border-radius: 15px;
                font-size: 12px;
                font-weight: bold;
            }
            
            .format-header {
                display: flex;
                align-items: flex-start;
                gap: 15px;
                margin-bottom: 15px;
            }
            
            .format-icon {
                font-size: 32px;
                flex-shrink: 0;
            }
            
            .format-title h4 {
                margin: 0 0 5px 0;
                font-size: 18px;
                color: #333;
            }
            
            .format-title p {
                margin: 0;
                color: #666;
                font-size: 14px;
            }
            
            .format-features {
                margin: 15px 0 20px 0;
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            
            .feature {
                font-size: 14px;
                color: #555;
            }
            
            .format-btn {
                width: 100%;
                padding: 12px 20px;
                border: none;
                border-radius: 8px;
                font-size: 16px;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.3s ease;
            }
            
            .text-btn {
                background: #007bff;
                color: white;
            }
            
            .text-btn:hover {
                background: #0056b3;
                transform: translateY(-1px);
            }
            
            .html-btn {
                background: #28a745;
                color: white;
            }
            
            .html-btn:hover {
                background: #1e7e34;
                transform: translateY(-1px);
            }
            
            @media (max-width: 768px) {
                .format-options {
                    grid-template-columns: 1fr;
                }
                
                .email-type-grid {
                    grid-template-columns: 1fr;
                }
                
                .new-modal-content {
                    width: 95%;
                    margin: 20px;
                }
                
                .modal-body {
                    padding: 20px;
                }
            }
        `;
        document.head.appendChild(styles);
    }
    
    document.body.appendChild(modal);
    
    // Email type cards i√ßin event listener
    modal.querySelectorAll('.email-type-card').forEach(card => {
        card.addEventListener('click', function() {
            // √ñnceki se√ßimi temizle
            modal.querySelectorAll('.email-type-card').forEach(c => c.classList.remove('selected'));
            
            // Yeni se√ßimi i≈üaretle
            this.classList.add('selected');
            selectedEmailType = this.dataset.type;
            
            // Format se√ßimi b√∂l√ºm√ºn√º g√∂ster
            document.getElementById('formatSelection').style.display = 'block';
            
            // Smooth scroll
            document.getElementById('formatSelection').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
        });
    });
}

/**
 * E-posta t√ºr√º se√ßimi
 * @param {string} type - E-posta t√ºr√º
 */
function selectEmailType(type) {
    selectedEmailType = type;
    
    // √ñnceki se√ßimi temizle
    document.querySelectorAll('.email-type-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Yeni se√ßimi i≈üaretle
    document.querySelector(`[data-type="${type}"]`).classList.add('selected');
    
    // Butonlarƒ± aktif et
    document.getElementById('generateEmailBtn').disabled = false;
    document.getElementById('previewEmailBtn').disabled = false;
}

/**
 * E-posta √∂nizlemesini g√∂sterir
 */
function previewEmail() {
    if (!selectedEmailType || !currentStudentForEmail) return;
    
    const emailContent = generateEmailByType(selectedEmailType, currentStudentForEmail);
    const previewSection = document.getElementById('emailPreviewSection');
    const previewContent = document.getElementById('emailPreviewContent');
    
    previewContent.innerHTML = emailContent.body;
    previewSection.style.display = 'block';
    
    // √ñnizleme b√∂l√ºm√ºne scroll
    previewSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

/**
 * E-postayƒ± olu≈üturur ve Gmail'de a√ßar
 */
function generateEmail() {
    if (!selectedEmailType || !currentStudentForEmail) return;
    
    const emailContent = generateEmailByType(selectedEmailType, currentStudentForEmail);
    
    // URL uzunluk kontrol√º
    const testUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(currentStudentForEmail.email)}&su=${encodeURIComponent(emailContent.subject)}&body=${encodeURIComponent(emailContent.body)}`;
    
    // URL √ßok uzunsa yeni pencerede a√ßƒ±p kullanƒ±cƒ±nƒ±n kopyalamasƒ±nƒ± saƒüla
    if (testUrl.length > 8000) {
        openEmailInNewWindow(emailContent, currentStudentForEmail.email);
    } else {
        // Normal Gmail URL ile a√ß
        window.open(testUrl, '_blank', 'noopener');
    }
    
    // Modalƒ± kapat
    closeEmailModal();
    
    // Ba≈üarƒ± mesajƒ± g√∂ster
    showModernToast('E-posta hazƒ±rlandƒ±!', 'success');
}

/**
 * E-posta i√ßeriƒüini yeni pencerede a√ßar
 */
function openEmailInNewWindow(emailContent, recipientEmail) {
    const newWindow = window.open('', '_blank', 'width=900,height=700,scrollbars=yes,resizable=yes');
    
    const htmlContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-posta ƒ∞√ßeriƒüi - Gmail'de Kullanƒ±m ƒ∞√ßin</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .instructions {
            background: #e3f2fd;
            padding: 20px;
            border-left: 4px solid #2196f3;
            margin: 0;
        }
        .email-info {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
        }
        .email-content {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            margin: 10px 0;
        }
        .buttons {
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 10px;
            transition: background 0.3s;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn-secondary {
            background: #28a745;
        }
        .btn-secondary:hover {
            background: #1e7e34;
        }
        .copy-success {
            color: #28a745;
            font-weight: bold;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìß E-posta ƒ∞√ßeriƒüi Hazƒ±r</h1>
            <p>Gmail'de kullanmak i√ßin a≈üaƒüƒ±daki adƒ±mlarƒ± izleyin</p>
        </div>
        
        <div class="instructions">
            <h3>üöÄ Otomatik ƒ∞≈ülem:</h3>
            <p style="margin: 10px 0; font-size: 16px; color: #007bff;">
                <strong>Bu sayfa otomatik olarak:</strong>
            </p>
            <ol>
                <li>‚úÖ E-posta i√ßeriƒüini panoya kopyalar</li>
                <li>üìß Gmail'i yeni sekmede a√ßar</li>
                <li>‚ö° Sizin sadece Gmail'de <strong>Ctrl+V</strong> yapmanƒ±z yeterli!</li>
            </ol>
            <hr style="margin: 15px 0;">
            <h4>üìã Manuel Se√ßenekler:</h4>
            <ul style="font-size: 14px; color: #666;">
                <li><strong>Ctrl+C:</strong> Tekrar kopyala</li>
                <li><strong>Ctrl+G:</strong> Gmail'i tekrar a√ß</li>
                <li>Veya a≈üaƒüƒ±daki butonlarƒ± kullanƒ±n</li>
            </ul>
        </div>
        
        <div class="email-info">
            <p><strong>üì® Alƒ±cƒ±:</strong> ${recipientEmail}</p>
            <p><strong>üìã Konu:</strong> ${emailContent.subject}</p>
        </div>
        
        <div class="email-content" id="emailContent">
            ${emailContent.body}
        </div>
        
        <div class="buttons">
            <button class="btn" onclick="copyEmailContent()">üìã E-posta ƒ∞√ßeriƒüini Kopyala</button>
            <button class="btn btn-secondary" onclick="openGmail()">üìß Gmail'i A√ß</button>
            <p class="copy-success" id="copySuccess">‚úÖ ƒ∞√ßerik kopyalandƒ±! ≈ûimdi Gmail'e gidip yapƒ±≈ütƒ±rabilirsiniz.</p>
        </div>
    </div>

    <script>
        // Sayfa y√ºklendiƒüinde otomatik ba≈ülat
        window.addEventListener('load', function() {
            // 1 saniye bekle sonra otomatik i≈ülemleri ba≈ülat
            setTimeout(autoStartProcess, 1000);
        });

        async function autoStartProcess() {
            try {
                // Modern Clipboard API ile otomatik kopyala
                await copyEmailContentModern();
                
                // 2 saniye bekle sonra Gmail'i a√ß
                setTimeout(() => {
                    openGmail();
                    showAutoSuccessMessage();
                }, 2000);
                
            } catch (err) {
                console.log('Modern API √ßalƒ±≈ümadƒ±, fallback kullanƒ±lƒ±yor');
                // Eski y√∂ntemle dene
                copyEmailContentFallback();
                setTimeout(() => {
                    openGmail();
                }, 1500);
            }
        }

        // Modern Clipboard API ile kopyalama
        async function copyEmailContentModern() {
            const emailContent = document.getElementById('emailContent');
            const htmlContent = emailContent.innerHTML;
            const textContent = emailContent.innerText;
            
            try {
                // Hem HTML hem text formatƒ±nda kopyala
                await navigator.clipboard.write([
                    new ClipboardItem({
                        'text/html': new Blob([htmlContent], { type: 'text/html' }),
                        'text/plain': new Blob([textContent], { type: 'text/plain' })
                    })
                ]);
                
                document.getElementById('copySuccess').style.display = 'block';
                document.getElementById('copySuccess').innerHTML = '‚úÖ ƒ∞√ßerik otomatik olarak kopyalandƒ±! Gmail a√ßƒ±lƒ±yor...';
                return true;
            } catch (err) {
                throw err;
            }
        }

        // Fallback eski y√∂ntem
        function copyEmailContentFallback() {
            const emailContent = document.getElementById('emailContent');
            const range = document.createRange();
            range.selectNodeContents(emailContent);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            
            try {
                document.execCommand('copy');
                document.getElementById('copySuccess').style.display = 'block';
                document.getElementById('copySuccess').innerHTML = '‚úÖ ƒ∞√ßerik kopyalandƒ±! Gmail a√ßƒ±lƒ±yor...';
                setTimeout(() => {
                    document.getElementById('copySuccess').style.display = 'none';
                }, 5000);
            } catch (err) {
                document.getElementById('copySuccess').style.display = 'block';
                document.getElementById('copySuccess').innerHTML = '‚ö†Ô∏è Otomatik kopyalama ba≈üarƒ±sƒ±z. L√ºtfen manuel butonlarƒ± kullanƒ±n.';
                document.getElementById('copySuccess').style.color = '#dc3545';
            }
            
            selection.removeAllRanges();
        }

        // Manuel kopyalama fonksiyonu
        async function copyEmailContent() {
            try {
                await copyEmailContentModern();
            } catch (err) {
                copyEmailContentFallback();
            }
        }
        
        function openGmail() {
            // Gmail URL'ini olu≈ütur
            const gmailUrl = 'https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(recipientEmail)}&su=${encodeURIComponent(emailContent.subject)}';
            
            // Gmail'i a√ß
            const gmailWindow = window.open(gmailUrl, '_blank');
            
            // Gmail a√ßƒ±ldƒ±ktan sonra otomatik yapƒ±≈ütƒ±rma deneme
            setTimeout(() => {
                tryAutoCompose(gmailWindow);
            }, 3000); // 3 saniye bekle Gmail y√ºklensin
        }

                 async function tryAutoCompose(gmailWindow) {
             try {
                 // Gmail penceresine focus ver
                 gmailWindow.focus();
                 
                 // Gmail'in y√ºklenmesini bekle
                 await waitForGmailLoad(gmailWindow);
                 
                 // E-posta i√ßeriƒüini al
                 const emailContent = document.getElementById('emailContent');
                 const htmlContent = emailContent.innerHTML;
                 
                 // Farklƒ± otomatik yapƒ±≈ütƒ±rma y√∂ntemleri dene
                 const success = await tryMultiplePasteMethods(gmailWindow, htmlContent);
                 
                 if (!success) {
                     // Ba≈üarƒ±sƒ±z olursa kullanƒ±cƒ±ya hatƒ±rlatma g√∂ster
                     showPasteReminder();
                 } else {
                     showSuccessMessage();
                 }
                 
             } catch (error) {
                 console.log('Otomatik yapƒ±≈ütƒ±rma m√ºmk√ºn deƒüil:', error);
                 showPasteReminder();
             }
         }

         async function waitForGmailLoad(gmailWindow) {
             return new Promise((resolve) => {
                 let attempts = 0;
                 const maxAttempts = 20; // 10 saniye max bekleme
                 
                 const checkLoad = () => {
                     attempts++;
                     try {
                         if (gmailWindow.document && 
                             gmailWindow.document.readyState === 'complete' &&
                             (gmailWindow.document.querySelector('[contenteditable]') || 
                              gmailWindow.document.querySelector('.Am.Al.editable'))) {
                             resolve();
                         } else if (attempts < maxAttempts) {
                             setTimeout(checkLoad, 500);
                         } else {
                             resolve(); // Timeout olsa bile devam et
                         }
                     } catch (err) {
                         if (attempts < maxAttempts) {
                             setTimeout(checkLoad, 500);
                         } else {
                             resolve();
                         }
                     }
                 };
                 
                 checkLoad();
             });
         }

         async function tryMultiplePasteMethods(gmailWindow, htmlContent) {
             const methods = [
                 // Y√∂ntem 1: Gmail compose alanƒ±nƒ± direkt hedefle
                 async () => {
                     const composeArea = gmailWindow.document.querySelector('[contenteditable="true"]') ||
                                        gmailWindow.document.querySelector('.Am.Al.editable') ||
                                        gmailWindow.document.querySelector('[role="textbox"]');
                     
                     if (composeArea) {
                         composeArea.focus();
                         composeArea.innerHTML = htmlContent;
                         composeArea.dispatchEvent(new gmailWindow.Event('input', { bubbles: true }));
                         return true;
                     }
                     return false;
                 },
                 
                 // Y√∂ntem 2: Clipboard API ile yapƒ±≈ütƒ±rma
                 async () => {
                     if (gmailWindow.navigator.clipboard) {
                         await gmailWindow.navigator.clipboard.writeText(htmlContent);
                         gmailWindow.document.execCommand('paste');
                         return true;
                     }
                     return false;
                 },
                 
                 // Y√∂ntem 3: Simulate user paste action
                 async () => {
                     const activeElement = gmailWindow.document.activeElement;
                     if (activeElement && activeElement.contentEditable === 'true') {
                         const pasteEvent = new gmailWindow.ClipboardEvent('paste', {
                             bubbles: true,
                             cancelable: true,
                             clipboardData: new gmailWindow.DataTransfer()
                         });
                         
                         // HTML data ekle
                         pasteEvent.clipboardData.setData('text/html', htmlContent);
                         pasteEvent.clipboardData.setData('text/plain', emailContent.innerText);
                         
                         activeElement.dispatchEvent(pasteEvent);
                         return true;
                     }
                     return false;
                 },
                 
                 // Y√∂ntem 4: Keyboard simulation with focus
                 async () => {
                     gmailWindow.focus();
                     await new Promise(resolve => setTimeout(resolve, 500));
                     
                     const events = [
                         new gmailWindow.KeyboardEvent('keydown', { key: 'v', ctrlKey: true, bubbles: true }),
                         new gmailWindow.KeyboardEvent('keypress', { key: 'v', ctrlKey: true, bubbles: true }),
                         new gmailWindow.KeyboardEvent('keyup', { key: 'v', ctrlKey: true, bubbles: true })
                     ];
                     
                     events.forEach(event => gmailWindow.document.dispatchEvent(event));
                     return true;
                 }
             ];
             
             // Her y√∂ntemi sƒ±rayla dene
             for (let i = 0; i < methods.length; i++) {
                 try {
                     console.log(\`Yapƒ±≈ütƒ±rma y√∂ntemi \${i + 1} deneniyor...\`);
                     const success = await methods[i]();
                     if (success) {
                         console.log(\`Y√∂ntem \${i + 1} ba≈üarƒ±lƒ±!\`);
                         return true;
                     }
                     // Y√∂ntemler arasƒ± kƒ±sa bekleme
                     await new Promise(resolve => setTimeout(resolve, 1000));
                 } catch (err) {
                     console.log(\`Y√∂ntem \${i + 1} hata:\`, err);
                 }
             }
             
             return false;
         }

         function showSuccessMessage() {
             setTimeout(() => {
                 const success = document.createElement('div');
                 success.style.cssText = \`
                     position: fixed;
                     top: 20px;
                     right: 20px;
                     background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                     color: white;
                     padding: 20px;
                     border-radius: 10px;
                     box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                     z-index: 10000;
                     font-family: Arial, sans-serif;
                     font-size: 16px;
                     max-width: 350px;
                     animation: slideIn 0.5s ease-out;
                 \`;
                 
                 success.innerHTML = \`
                     <div style="display: flex; align-items: center; margin-bottom: 10px;">
                         <span style="font-size: 24px; margin-right: 10px;">üéâ</span>
                         <strong>Ba≈üarƒ±lƒ±!</strong>
                     </div>
                     <p style="margin: 0;">
                         E-posta i√ßeriƒüi Gmail'e otomatik olarak yapƒ±≈ütƒ±rƒ±ldƒ±!
                     </p>
                 \`;
                 
                 document.body.appendChild(success);
                 
                 // 5 saniye sonra otomatik kapat
                 setTimeout(() => {
                     if (success.parentElement) {
                         success.remove();
                     }
                 }, 5000);
                 
             }, 1000);
         }

        function showPasteReminder() {
            // Ana pencerede hatƒ±rlatma g√∂ster
            setTimeout(() => {
                const reminder = document.createElement('div');
                reminder.style.cssText = \`
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 20px;
                    border-radius: 10px;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                    z-index: 10000;
                    font-family: Arial, sans-serif;
                    font-size: 16px;
                    max-width: 350px;
                    animation: slideIn 0.5s ease-out;
                \`;
                
                reminder.innerHTML = \`
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span style="font-size: 24px; margin-right: 10px;">üìß</span>
                        <strong>Gmail A√ßƒ±ldƒ±!</strong>
                    </div>
                    <p style="margin: 0 0 15px 0;">
                        Gmail'de <strong>Ctrl+V</strong> tu≈ülarƒ±na basarak e-posta i√ßeriƒüini yapƒ±≈ütƒ±rƒ±n.
                    </p>
                    <div style="text-align: center;">
                        <button onclick="this.parentElement.parentElement.remove()" 
                                style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); 
                                       color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer;">
                            Anladƒ±m ‚úì
                        </button>
                    </div>
                \`;
                
                // CSS animation ekle
                if (!document.querySelector('#slideInAnimation')) {
                    const style = document.createElement('style');
                    style.id = 'slideInAnimation';
                    style.textContent = \`
                        @keyframes slideIn {
                            from { transform: translateX(100%); opacity: 0; }
                            to { transform: translateX(0); opacity: 1; }
                        }
                    \`;
                    document.head.appendChild(style);
                }
                
                document.body.appendChild(reminder);
                
                // 10 saniye sonra otomatik kapat
                setTimeout(() => {
                    if (reminder.parentElement) {
                        reminder.remove();
                    }
                }, 10000);
                
            }, 1000);
        }

        function showAutoSuccessMessage() {
            document.getElementById('copySuccess').style.display = 'block';
            document.getElementById('copySuccess').innerHTML = 'üöÄ Tamamlandƒ±! Gmail a√ßƒ±ldƒ±, i√ßerik kopyalandƒ±. Artƒ±k Ctrl+V ile yapƒ±≈ütƒ±rabilirsiniz!';
            document.getElementById('copySuccess').style.color = '#28a745';
            document.getElementById('copySuccess').style.fontSize = '16px';
            document.getElementById('copySuccess').style.fontWeight = 'bold';
        }

        // Klavye kƒ±sayolu ekle
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'c') {
                e.preventDefault();
                copyEmailContent();
            }
            if (e.ctrlKey && e.key === 'g') {
                e.preventDefault();
                openGmail();
            }
        });
    </script>
</body>
</html>`;
    
    newWindow.document.write(htmlContent);
    newWindow.document.close();
}

/**
 * E-posta t√ºr√ºne g√∂re i√ßerik olu≈üturur
 */
function generateEmailByType(type, student) {
    const instructor = getInstructorName();
    const courseName = getCourseInfo().name;
    const courseTerm = getCourseInfo().term;
    
    switch (type) {
        case 'survey':
            return generateSurveyEmail(student, instructor, courseName, courseTerm);
        case 'detailed':
            return generateDetailedScoreEmail(student, instructor, courseName, courseTerm);
        case 'analysis':
            return generateAnalysisEmail(student, instructor, courseName, courseTerm);
        case 'info':
            return generateInfoRequestEmail(student, instructor, courseName, courseTerm);
        default:
            return generateDetailedEmailContent(student.studentId);
    }
}

/**
 * Anket e-postasƒ± olu≈üturur
 */
function generateSurveyEmail(student, instructor, courseName, courseTerm) {
    const subject = `${courseName} - Ders Bazinda Ogrenme Ciktilari Anketi`;
    
    console.log('DEBUG: APP_STATE.courseData:', APP_STATE.courseData);
    console.log('DEBUG: dersOgrenme√áiktilari:', APP_STATE.courseData?.dersOgrenme√áiktilari);
    
    const outcomes = APP_STATE.courseData?.dersOgrenme√áiktilari || [];
    
    console.log('DEBUG: outcomes length:', outcomes.length);
    console.log('DEBUG: outcomes:', outcomes);
    const courseCode = APP_STATE.courseData?.dersBilgisi?.dersKodu || 'XXX000';
    
    // HTML formatƒ±nda soru listesi
    let questionSection = '';
    if (outcomes.length > 0) {
        questionSection = `
        <table style="width: 100%; border-collapse: collapse; margin: 20px 0; font-family: Arial, sans-serif;">
            <thead>
                <tr style="background-color: #f0f0f0;">
                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd; width: 60%;">√ñƒürenme √áƒ±ktƒ±larƒ±</th>
                    <th style="padding: 10px; text-align: center; border: 1px solid #ddd; width: 8%;">5</th>
                    <th style="padding: 10px; text-align: center; border: 1px solid #ddd; width: 8%;">4</th>
                    <th style="padding: 10px; text-align: center; border: 1px solid #ddd; width: 8%;">3</th>
                    <th style="padding: 10px; text-align: center; border: 1px solid #ddd; width: 8%;">2</th>
                    <th style="padding: 10px; text-align: center; border: 1px solid #ddd; width: 8%;">1</th>
                </tr>
            </thead>
            <tbody>`;
        
        outcomes.forEach((outcome, index) => {
            const questionNum = index + 1;
            const fullDescription = outcome.aciklama || outcome.description || 'Tanƒ±mlanmamƒ±≈ü';
            
            questionSection += `
                <tr style="border-bottom: 1px solid #ddd;">
                    <td style="padding: 15px; border: 1px solid #ddd; vertical-align: top;">
                        <strong>${questionNum}.</strong> ${fullDescription}
                    </td>
                    <td style="padding: 15px; border: 1px solid #ddd; text-align: center; vertical-align: middle;">
                        <input type="checkbox" style="transform: scale(1.5);" />
                    </td>
                    <td style="padding: 15px; border: 1px solid #ddd; text-align: center; vertical-align: middle;">
                        <input type="checkbox" style="transform: scale(1.5);" />
                    </td>
                    <td style="padding: 15px; border: 1px solid #ddd; text-align: center; vertical-align: middle;">
                        <input type="checkbox" style="transform: scale(1.5);" />
                    </td>
                    <td style="padding: 15px; border: 1px solid #ddd; text-align: center; vertical-align: middle;">
                        <input type="checkbox" style="transform: scale(1.5);" />
                    </td>
                    <td style="padding: 15px; border: 1px solid #ddd; text-align: center; vertical-align: middle;">
                        <input type="checkbox" style="transform: scale(1.5);" />
                    </td>
                </tr>`;
        });
        
        questionSection += `
            </tbody>
        </table>
        
        <div style="margin: 20px 0; padding: 15px; background-color: #f9f9f9; border-left: 4px solid #007bff;">
            <h4 style="margin: 0 0 10px 0; color: #007bff;">Deƒüerlendirme Skalasƒ±:</h4>
            <ul style="margin: 0; padding-left: 20px; list-style-type: none;">
                <li><strong>5:</strong> Kesinlikle Katƒ±lƒ±yorum</li>
                <li><strong>4:</strong> Katƒ±lƒ±yorum</li>
                <li><strong>3:</strong> Kƒ±smen Katƒ±lƒ±yorum</li>
                <li><strong>2:</strong> Katƒ±lmƒ±yorum</li>
                <li><strong>1:</strong> Kesinlikle Katƒ±lmƒ±yorum</li>
            </ul>
        </div>`;
    } else {
        questionSection = `
        <div style="padding: 20px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; color: #856404;">
            <strong>Uyarƒ±:</strong> Bu ders i√ßin √∂ƒürenme √ßƒ±ktƒ±larƒ± tanƒ±mlanmamƒ±≈ü.<br>
            L√ºtfen ders sorumlusu ile ileti≈üime ge√ßiniz.
        </div>`;
    }
    
    const body = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ders Deƒüerlendirme Anketi</title>
</head>
<body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; padding: 20px;">
    
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0;">
        <h1 style="margin: 0; font-size: 24px; font-weight: bold;">Recep Tayyip Erdoƒüan √úniversitesi</h1>
        <h2 style="margin: 10px 0; font-size: 18px; font-weight: normal;">Bilgisayar M√ºhendisliƒüi</h2>
        <h3 style="margin: 10px 0; font-size: 16px; font-weight: normal;">Ders Bazƒ±nda √ñƒürenme √áƒ±ktƒ±larƒ± Anketi</h3>
    </div>
    
    <div style="background-color: #f8f9fa; padding: 25px; border: 1px solid #dee2e6;">
        <p style="margin: 0 0 15px 0; font-size: 16px;">
            <strong>Deƒüerli Recep Tayyip Erdoƒüan √úniversitesi Bilgisayar M√ºhendisliƒüi √ñƒürencileri;</strong>
        </p>
        
        <p style="margin: 0 0 15px 0; text-align: justify;">
            A≈üaƒüƒ±da verilen ders bazƒ±nda √∂ƒürenme √ßƒ±ktƒ±sƒ± anketi b√∂l√ºm√ºm√ºz lisans 
            programƒ±nda yer alan derslerin deƒüerlendirilmesi amacƒ± ile hazƒ±rlanmƒ±≈ütƒ±r. 
            Ankete yanƒ±t verirken l√ºtfen dersin ilgili √∂ƒürenme √ßƒ±ktƒ±sƒ±na katkƒ±sƒ±nƒ± 
            deƒüerlendiriniz. Katkƒ± oranƒ± i√ßin se√ßtiƒüiniz yanƒ±ta kar≈üƒ±lƒ±k gelen 
            kutucuƒüa i≈üaret koyunuz.
        </p>
        
        <p style="margin: 0; font-style: italic; color: #6c757d;">
            G√∂sterdiƒüiniz ilgi ve zamanƒ±nƒ±z i√ßin √ßok te≈üekk√ºr ederiz.
        </p>
    </div>
    
    <div style="background-color: white; padding: 25px; border: 1px solid #dee2e6; border-top: none;">
        <div style="background-color: #e9ecef; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
            <h3 style="margin: 0; color: #495057;">
                <strong>Dersin Kodu / Adƒ±:</strong> ${courseCode} / ${courseName}
            </h3>
        </div>
        
        ${questionSection}
    </div>
    
    <div style="background-color: #f8f9fa; padding: 25px; border: 1px solid #dee2e6; border-top: none; border-radius: 0 0 10px 10px;">
        <div style="text-align: center; margin-bottom: 20px;">
            <p style="margin: 0; font-size: 14px; color: #6c757d;">
                Bu anket <strong>${new Date().toLocaleDateString('tr-TR')}</strong> tarihinde g√∂nderilmi≈ütir.
            </p>
        </div>
        
        <div style="background-color: white; padding: 20px; border-radius: 5px; border-left: 4px solid #28a745;">
            <p style="margin: 0 0 10px 0; font-size: 16px;">
                <strong>Merhaba ${student.name} ${student.surname},</strong>
            </p>
            <p style="margin: 0 0 15px 0;">
                L√ºtfen anketi doldurarak bana geri g√∂nderiniz.
            </p>
            <p style="margin: 0; font-style: italic; color: #28a745;">
                <strong>ƒ∞yi √ßalƒ±≈ümalar,</strong><br>
                ${instructor}
            </p>
        </div>
    </div>
    
</body>
</html>`;

    return { subject, body };
}

/**
 * √ñ√á-P√á analiz e-postasƒ±
 */
/**
 * Detaylƒ± puan bilgisi e-postasƒ±
 */
/**
 * HTML format i√ßin yardƒ±mcƒ± fonksiyonlar
 */
function createStudentInfoHTML(studentData, courseName, courseTerm) {
    return `
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; margin-bottom: 25px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.1);">
        <h2 style="margin: 0 0 15px 0; font-size: 24px; font-weight: 700;">üìö √ñƒürenci Bilgileri</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; font-size: 16px;">
            <div><strong>üë§ Ad Soyad:</strong> ${studentData.name} ${studentData.surname}</div>
            <div><strong>üÜî √ñƒürenci No:</strong> ${studentData.studentId}</div>
            <div><strong>üìñ Ders:</strong> ${courseName}</div>
            <div><strong>üìÖ D√∂nem:</strong> ${courseTerm}</div>
        </div>
    </div>`;
}

function createTermComponentHTML(componentData, studentGrades, isTermSection = true) {
    const componentId = componentData.id;
    const componentName = componentData.name || componentData.ad || componentId;
    const weight = componentData.weight || componentData.agirlik || 0;
    
    const sectionColor = isTermSection ? '#e8f5e8' : '#fff3e0';
    const headerColor = isTermSection ? '#4caf50' : '#ff9800';
    
    let childrenHTML = '';
    let componentScore = 0;
    let maxComponentScore = 0;
    
    // Alt √∂ƒüeleri kontrol et ve notlarƒ± topla - TEXT FORMAT MANTIGI
    if (componentData.children && componentData.children.length > 0) {
        componentData.children.forEach(child => {
            const childId = child.id;
            const childName = child.name || child.ad || childId;
            const childPoints = child.points || 20; // Varsayƒ±lan 20 puan
            
            // Notu al - farklƒ± kaynaklardan dene
            const grade = studentGrades[childId] || studentGrades[componentId]?.[childId] || 0;
            
            childrenHTML += `
                <div style="margin: 8px 0; padding: 10px; background: #f9f9f9; border-left: 3px solid ${headerColor}; border-radius: 4px;">
                    <span style="font-weight: 600;">${childName}:</span> ${grade}/${childPoints} puan
                </div>`;
            
            // Alt √∂ƒüe notlarƒ±nƒ± topla
            componentScore += parseFloat(grade) || 0;
            maxComponentScore += parseFloat(childPoints) || 0;
        });
    } else {
        // Alt √∂ƒüe yoksa doƒürudan bile≈üen puanƒ±nƒ± al
        componentScore = studentGrades[componentId] || 0;
        maxComponentScore = 100; // Varsayƒ±lan maksimum puan
    }
    
    // Y√ºzdelik hesaplama
    const componentPercentage = maxComponentScore > 0 ? (componentScore / maxComponentScore * 100) : 0;
    const agirlikli_katki = (componentPercentage * weight) / 100;
    
    return `
    <div style="background: ${sectionColor}; padding: 20px; margin: 15px 0; border-radius: 10px; border-left: 5px solid ${headerColor};">
        <h4 style="color: ${headerColor}; margin: 0 0 15px 0; font-size: 18px; font-weight: 700;">
            ${componentName} - ${componentId} (Aƒüƒ±rlƒ±k: %${weight})
        </h4>
        ${childrenHTML}
        <div style="margin: 15px 0; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            <div style="margin: 5px 0;"><strong>üìä Bile≈üen Toplamƒ±:</strong> ${componentScore}/${maxComponentScore} (%${componentPercentage.toFixed(2)})</div>
            <div style="margin: 5px 0; color: #666; font-style: italic;">üìê Form√ºl: BP = ${componentScore}/${maxComponentScore} √ó 100 = %${componentPercentage.toFixed(2)}</div>
            <div style="margin: 5px 0; color: ${headerColor}; font-weight: 600;">‚öñÔ∏è Aƒüƒ±rlƒ±klƒ± Katkƒ±: AK = ${componentPercentage.toFixed(2)} √ó ${weight}/100 = %${agirlikli_katki.toFixed(2)}</div>
        </div>
    </div>`;
}

function createResultHTML(yilIciOrtalamasƒ±, yilSonuOrtalamasi, overallAverage, letterGrade) {
    const genel_yariyil_ici_katkisi = (yilIciOrtalamasƒ± * 40) / 100;
    const genel_yariyil_sonu_katkisi = (yilSonuOrtalamasi * 60) / 100;
    const passed = overallAverage >= 60;
    
    return `
    <div style="background: linear-gradient(135deg, #ff6b6b 0%, #ffa726 100%); color: white; padding: 25px; margin: 25px 0; border-radius: 12px; text-align: center;">
        <h3 style="margin: 0 0 20px 0; font-size: 22px; font-weight: 700;">üéØ Yƒ±l Sonu Hesaplama</h3>
        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <div style="margin: 8px 0;">Yarƒ±yƒ±l ƒ∞√ßi Katkƒ±sƒ±: %${yilIciOrtalamasƒ±.toFixed(2)} √ó 40/100 = <strong>%${genel_yariyil_ici_katkisi.toFixed(2)}</strong></div>
            <div style="margin: 8px 0;">Yarƒ±yƒ±l Sonu Katkƒ±sƒ±: %${yilSonuOrtalamasi.toFixed(2)} √ó 60/100 = <strong>%${genel_yariyil_sonu_katkisi.toFixed(2)}</strong></div>
            <hr style="border: 1px solid rgba(255,255,255,0.3); margin: 15px 0;">
            <div style="font-size: 20px; font-weight: 700;">Genel Ortalama: %${genel_yariyil_ici_katkisi.toFixed(2)} + %${genel_yariyil_sonu_katkisi.toFixed(2)} = <span style="color: #ffeb3b;">%${overallAverage.toFixed(2)}</span></div>
        </div>
        <div style="font-size: 24px; font-weight: 700; margin: 15px 0;">
            <span style="color: #ffeb3b;">Harf Notu: ${letterGrade}</span>
        </div>
        <div style="font-size: 18px; color: ${passed ? '#4caf50' : '#f44336'}; background: rgba(255,255,255,0.9); color: ${passed ? '#2e7d32' : '#c62828'}; padding: 10px; border-radius: 6px; font-weight: 700;">
            ${passed ? '‚úÖ GE√áTƒ∞' : '‚ùå KALDI'}
        </div>
    </div>`;
}

function createGradeExplanationHTML() {
    return `
    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
        <h4 style="color: #495057; margin: 0 0 15px 0; font-weight: 700;">üìã Not A√ßƒ±klamasƒ±</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; text-align: center;">
            <div style="background: #28a745; color: white; padding: 8px; border-radius: 6px; font-weight: 600;">AA: 90-100</div>
            <div style="background: #20c997; color: white; padding: 8px; border-radius: 6px; font-weight: 600;">BA: 85-89</div>
            <div style="background: #17a2b8; color: white; padding: 8px; border-radius: 6px; font-weight: 600;">BB: 80-84</div>
            <div style="background: #ffc107; color: #212529; padding: 8px; border-radius: 6px; font-weight: 600;">CB: 75-79</div>
            <div style="background: #fd7e14; color: white; padding: 8px; border-radius: 6px; font-weight: 600;">CC: 70-74</div>
            <div style="background: #dc3545; color: white; padding: 8px; border-radius: 6px; font-weight: 600;">DC: 65-69</div>
            <div style="background: #6f42c1; color: white; padding: 8px; border-radius: 6px; font-weight: 600;">DD: 60-64</div>
            <div style="background: #e83e8c; color: white; padding: 8px; border-radius: 6px; font-weight: 600;">FD: 50-59</div>
            <div style="background: #6c757d; color: white; padding: 8px; border-radius: 6px; font-weight: 600;">FF: 0-49</div>
        </div>
    </div>`;
}

function createContactHTML(instructor) {
    return `
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin: 20px 0;">
        <h4 style="margin: 0 0 15px 0; font-weight: 700;">üìû ƒ∞leti≈üim</h4>
        <div style="line-height: 1.6;">
            <div style="margin: 8px 0;">üìß <strong>E-posta:</strong> ${instructor}</div>
            <div style="margin: 8px 0;">üïê <strong>Ofis Saatleri:</strong> [Belirtilecek]</div>
            <div style="margin: 8px 0;">üí¨ <strong>Sorularƒ±nƒ±z i√ßin:</strong> L√ºtfen bana ula≈üabilirsiniz</div>
            <div style="margin: 8px 0;">üìÖ <strong>Rapor Tarihi:</strong> ${new Date().toLocaleDateString('tr-TR')}</div>
        </div>
    </div>`;
}

/**
 * Detaylƒ± puan e-postasƒ± olu≈üturur (HTML formatƒ±) - D√úZELTILMI≈û
 */
function generateDetailedScoreEmail(student, instructor, courseName, courseTerm) {
    const subject = `${courseName} - Kapsamlƒ± Deƒüerlendirme Raporu`;
    
    // √ñƒürenci verilerini al
    let studentData = APP_STATE.studentData?.find(s => s.studentId === student.studentId);
    if (!studentData) {
        studentData = {
            studentId: student.studentId,
            name: student.name || 'Bilinmeyen',
            surname: student.surname || '√ñƒürenci'
        };
    }

    // Sistemdeki t√ºm deƒüerlendirme bile≈üenlerini al
    let assessmentTree = APP_STATE.assessmentTree || APP_STATE.courseData?.degerlendirmeAgaci || [];
    
    // √ñƒürenci notlarƒ±nƒ± al
    const allGradesData = APP_STATE.gradesData || APP_STATE.courseData?.ogrenciNotlari || {};
    const studentGrades = allGradesData[studentData.studentId] || {};
    
    // YARIYIL ICI ETKINLIKLER (40% aƒüƒ±rlƒ±k) - TEXT FORMAT MANTIGI
    const termComponents = assessmentTree.filter(comp => comp.id && comp.id.startsWith('A'));
    let termWeightedSum = 0;
    let termTotalWeight = 0;
    let termHTML = '';
    
    termComponents.forEach(componentData => {
        const componentId = componentData.id;
        const weight = componentData.weight || componentData.agirlik || 0;
        
        // Alt √∂ƒüe hesaplama mantƒ±ƒüƒ± - TEXT FORMAT Gƒ∞Bƒ∞
        let componentScore = 0;
        let maxComponentScore = 0;
        
        if (componentData.children && componentData.children.length > 0) {
            // Alt √∂ƒüeler varsa bunlarƒ± topla
            componentData.children.forEach(child => {
                const childId = child.id;
                const childPoints = child.points || 20;
                const grade = studentGrades[childId] || studentGrades[componentId]?.[childId] || 0;
                
                componentScore += parseFloat(grade) || 0;
                maxComponentScore += parseFloat(childPoints) || 0;
            });
        } else {
            // Alt √∂ƒüe yoksa doƒürudan bile≈üen puanƒ±nƒ± al
            componentScore = studentGrades[componentId] || 0;
            maxComponentScore = 100;
        }
        
        termHTML += createTermComponentHTML(componentData, studentGrades, true);
        
        // Y√ºzdelik hesaplama ve aƒüƒ±rlƒ±klƒ± katkƒ±
        const componentPercentage = maxComponentScore > 0 ? (componentScore / maxComponentScore * 100) : 0;
        const agirlikli_katki = (componentPercentage * weight) / 100;
        termWeightedSum += agirlikli_katki;
        termTotalWeight += weight;
    });
    
    // YARIYIL SONU ETKINLIKLER (60% aƒüƒ±rlƒ±k) - TEXT FORMAT MANTIGI  
    const finalComponents = assessmentTree.filter(comp => comp.id && comp.id.startsWith('F'));
    let finalWeightedSum = 0;
    let finalTotalWeight = 0;
    let finalHTML = '';
    
    finalComponents.forEach(componentData => {
        const componentId = componentData.id;
        const weight = componentData.weight || componentData.agirlik || 0;
        
        // Alt √∂ƒüe hesaplama mantƒ±ƒüƒ± - TEXT FORMAT Gƒ∞Bƒ∞
        let componentScore = 0;
        let maxComponentScore = 0;
        
        if (componentData.children && componentData.children.length > 0) {
            // Alt √∂ƒüeler varsa bunlarƒ± topla
            componentData.children.forEach(child => {
                const childId = child.id;
                const childPoints = child.points || 20;
                const grade = studentGrades[childId] || studentGrades[componentId]?.[childId] || 0;
                
                componentScore += parseFloat(grade) || 0;
                maxComponentScore += parseFloat(childPoints) || 0;
            });
        } else {
            // Alt √∂ƒüe yoksa doƒürudan bile≈üen puanƒ±nƒ± al
            componentScore = studentGrades[componentId] || 0;
            maxComponentScore = 100;
        }
        
        finalHTML += createTermComponentHTML(componentData, studentGrades, false);
        
        // Y√ºzdelik hesaplama ve aƒüƒ±rlƒ±klƒ± katkƒ±
        const componentPercentage = maxComponentScore > 0 ? (componentScore / maxComponentScore * 100) : 0;
        const agirlikli_katki = (componentPercentage * weight) / 100;
        finalWeightedSum += agirlikli_katki;
        finalTotalWeight += weight;
    });
    
    // YIL SONU HESAPLAMA (Yarƒ±yƒ±l ƒ∞√ßi %40 + Yarƒ±yƒ±l Sonu %60) - DOƒûRU FORM√úL
    const yilIciOrtalamasƒ± = termTotalWeight > 0 ? (termWeightedSum * 100 / termTotalWeight) : 0;
    const yilSonuOrtalamasi = finalTotalWeight > 0 ? (finalWeightedSum * 100 / finalTotalWeight) : 0;
    
    const genel_yariyil_ici_katkisi = (yilIciOrtalamasƒ± * 40) / 100;  // Yarƒ±yƒ±l i√ßi %40
    const genel_yariyil_sonu_katkisi = (yilSonuOrtalamasi * 60) / 100; // Yarƒ±yƒ±l sonu %60
    const overallAverage = genel_yariyil_ici_katkisi + genel_yariyil_sonu_katkisi; // DOƒûRU HESAPLAMA
    
    const letterGrade = calculateLetterGrade(overallAverage);
    
    const body = `
    <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 800px; margin: 0 auto; background: #ffffff; color: #333;">
        ${createStudentInfoHTML(studentData, courseName, courseTerm)}
        
        <div style="background: #e8f5e8; padding: 20px; margin: 20px 0; border-radius: 10px; border-left: 5px solid #4caf50;">
            <h3 style="color: #4caf50; margin: 0 0 15px 0; font-size: 20px; font-weight: 700;">üå± Yarƒ±yƒ±l ƒ∞√ßi Etkinlikler (Toplam Aƒüƒ±rlƒ±k: %40)</h3>
            ${termHTML}
            <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 15px; text-align: center;">
                <div style="font-size: 16px; font-weight: 600; color: #4caf50;">üìä Yarƒ±yƒ±l ƒ∞√ßi Toplamƒ±: %${termWeightedSum.toFixed(2)}</div>
                <div style="font-size: 14px; color: #666; margin-top: 5px;">Yarƒ±yƒ±l ƒ∞√ßi Ortalamasƒ±: %${yilIciOrtalamasƒ±.toFixed(2)}</div>
            </div>
        </div>
        
        <div style="background: #fff3e0; padding: 20px; margin: 20px 0; border-radius: 10px; border-left: 5px solid #ff9800;">
            <h3 style="color: #ff9800; margin: 0 0 15px 0; font-size: 20px; font-weight: 700;">üèÅ Yarƒ±yƒ±l Sonu Etkinlikler (Toplam Aƒüƒ±rlƒ±k: %60)</h3>
            ${finalHTML}
            <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 15px; text-align: center;">
                <div style="font-size: 16px; font-weight: 600; color: #ff9800;">üìä Yarƒ±yƒ±l Sonu Toplamƒ±: %${finalWeightedSum.toFixed(2)}</div>
                <div style="font-size: 14px; color: #666; margin-top: 5px;">Yarƒ±yƒ±l Sonu Ortalamasƒ±: %${yilSonuOrtalamasi.toFixed(2)}</div>
            </div>
        </div>
        
        ${createResultHTML(yilIciOrtalamasƒ±, yilSonuOrtalamasi, overallAverage, letterGrade)}
        ${createGradeExplanationHTML()}
        ${createContactHTML(instructor)}
        
        <div style="text-align: center; padding: 20px; color: #666; font-style: italic;">
            <div style="margin: 10px 0;">Bu rapor t√ºm hesaplamalarƒ± adƒ±m adƒ±m g√∂stermektedir.</div>
            <div style="font-weight: 600;">ƒ∞yi √ßalƒ±≈ümalar! üéì</div>
        </div>
    </div>`;

    return { subject, body };
}

/**
 * Sayƒ±sal notu harf notuna √ßevirir
 */
// ƒ∞lk calculateLetterGrade fonksiyonu kaldƒ±rƒ±ldƒ± - daha kƒ±sa versiyon korundu

function generateAnalysisEmail(student, instructor, courseName, courseTerm) {
    const subject = `${courseName} - OC-PC Performans Analizi`;
    
    // √ñƒürenci verilerini al
    let studentData = APP_STATE.studentData?.find(s => s.studentId === student.studentId);
    if (!studentData) {
        studentData = {
            studentId: student.studentId,
            name: student.name || 'Bilinmeyen',
            surname: student.surname || '√ñƒürenci'
        };
    }

    // √ñƒürenme √ßƒ±ktƒ±larƒ±nƒ± ve program √ßƒ±ktƒ±larƒ±nƒ± al
    const outcomes = APP_STATE.courseData?.dersOgrenme√áiktilari || [];
    const programOutcomes = APP_STATE.courseData?.programCiktilari || [];
    
    // Deƒüerlendirme aƒüacƒ±nƒ± al
    const assessmentTree = APP_STATE.assessmentTree || [];
    const studentGrades = APP_STATE.gradesData?.[studentData.studentId] || {};
    
    // √ñ√á performansƒ±nƒ± hesapla - JSON'dan gelen tam tanƒ±mlarƒ± kullan
    let outcomeAnalysis = '';
    let totalOutcomePerformance = 0;
    let validOutcomes = 0;
    
    outcomes.forEach((outcome, index) => {
        const outcomeId = outcome.id || `√ñ√á.${index + 1}`;
        const fullDescription = outcome.aciklama || outcome.description || 'Tanƒ±mlanmamƒ±≈ü';
        
        // Bu √∂ƒürenme √ßƒ±ktƒ±sƒ± ile ili≈ükili aktivitelerin performansƒ±nƒ± hesapla
        let outcomePerformance = 0;
        let relatedActivities = 0;
        
        // Deƒüerlendirme aƒüacƒ±ndan bu √∂ƒürenme √ßƒ±ktƒ±sƒ± ile ili≈ükili aktiviteleri bul
        assessmentTree.forEach(component => {
            if (component.outcomes && component.outcomes.includes(outcomeId)) {
                const componentGrade = studentGrades[component.id] || 0;
                const componentMax = component.points || 100;
                const componentPerf = componentMax > 0 ? (componentGrade / componentMax) * 100 : 0;
                
                outcomePerformance += componentPerf;
                relatedActivities++;
            }
            
            // Alt √∂ƒüeleri de kontrol et
            if (component.children) {
                component.children.forEach(child => {
                    if (child.outcomes && child.outcomes.includes(outcomeId)) {
                        const childGrade = studentGrades[child.id] || 0;
                        const childMax = child.points || 100;
                        const childPerf = childMax > 0 ? (childGrade / childMax) * 100 : 0;
                        
                        outcomePerformance += childPerf;
                        relatedActivities++;
                    }
                });
            }
        });
        
        const finalPerformance = relatedActivities > 0 ? (outcomePerformance / relatedActivities) : 0;
        const performanceLevel = finalPerformance >= 85 ? '√áok ƒ∞yi' : 
                               finalPerformance >= 70 ? 'ƒ∞yi' : 
                               finalPerformance >= 55 ? 'Orta' : 
                               finalPerformance >= 40 ? 'Zayƒ±f' : '√áok Zayƒ±f';
        
        outcomeAnalysis += `${outcomeId}: ${performanceLevel} (%${finalPerformance.toFixed(2)})\n`;
        outcomeAnalysis += `   Tanƒ±mƒ±: ${fullDescription}\n`;
        outcomeAnalysis += `   ƒ∞li≈ükili Etkinlik Sayƒ±sƒ±: ${relatedActivities}\n\n`;
        
        if (relatedActivities > 0) {
            totalOutcomePerformance += finalPerformance;
            validOutcomes++;
        }
    });
    
    // Program √ßƒ±ktƒ±larƒ± ile ili≈üki analizi - JSON'dan gelen ili≈üki matrisini kullan
    const relationshipMatrix = APP_STATE.courseData?.programVeOgrenmeIliskisi?.iliskiTablosu || [];
    let programAnalysis = '';
    
    programOutcomes.forEach((pc, index) => {
        const pcId = pc.id || `P√á.${index + 1}`;
        const pcCategory = pc.kategori || 'Kategori Belirtilmemi≈ü';
        const pcFullDescription = pc.aciklama || pc.description || 'Tanƒ±mlanmamƒ±≈ü';
        
        // Bu program √ßƒ±ktƒ±sƒ± ile ili≈ükili √∂ƒürenme √ßƒ±ktƒ±larƒ±nƒ± JSON'dan bul
        const relatedRelations = relationshipMatrix.filter(relation => {
            const relationValue = relation.program√áiktilariIliskileri?.[pcId] || 0;
            return relationValue > 0;
        });
        
        if (relatedRelations.length > 0) {
            let strongRelations = 0;
            let moderateRelations = 0;
            let totalRelationStrength = 0;
            
            relatedRelations.forEach(relation => {
                const strength = relation.program√áiktilariIliskileri[pcId];
                totalRelationStrength += strength;
                if (strength >= 4) strongRelations++;
                else if (strength >= 3) moderateRelations++;
            });
            
            const avgStrength = relatedRelations.length > 0 ? (totalRelationStrength / relatedRelations.length).toFixed(2) : 0;
            
            programAnalysis += `${pcId} - ${pcCategory}\n`;
            programAnalysis += `   Tanƒ±mƒ±: ${pcFullDescription}\n`;
            programAnalysis += `   ƒ∞li≈ükili √ñ√á Sayƒ±sƒ±: ${relatedRelations.length}\n`;
            programAnalysis += `   G√º√ßl√º ƒ∞li≈üki: ${strongRelations}, Orta ƒ∞li≈üki: ${moderateRelations}\n`;
            programAnalysis += `   Ortalama ƒ∞li≈üki G√ºc√º: ${avgStrength}/5\n\n`;
        }
    });
    
    // Genel performans deƒüerlendirmesi
    const overallPerformance = validOutcomes > 0 ? (totalOutcomePerformance / validOutcomes) : 0;
    const performanceComment = overallPerformance >= 85 ? '√áok ba≈üarƒ±lƒ± bir performans g√∂sterdiniz! T√ºm √∂ƒürenme √ßƒ±ktƒ±larƒ±nƒ± m√ºkemmel bir ≈üekilde kar≈üƒ±ladƒ±nƒ±z.' :
                              overallPerformance >= 70 ? 'Genel olarak ba≈üarƒ±lƒ± bir performans! √áoƒüu √∂ƒürenme √ßƒ±ktƒ±sƒ±nƒ± iyi seviyede kar≈üƒ±ladƒ±nƒ±z.' :
                              overallPerformance >= 55 ? 'Orta d√ºzey bir performans sergiledƒ±nƒ±z. Bazƒ± alanlarda geli≈üim fƒ±rsatlarƒ±nƒ±z mevcut.' :
                              overallPerformance >= 40 ? 'Performansƒ±nƒ±zƒ± artƒ±rmak i√ßin ek √ßalƒ±≈üma gerekli. Temel konularƒ± g√∂zden ge√ßirmenizi √∂neriyorum.' :
                              'Performansƒ±nƒ±zda √∂nemli geli≈üim alanlarƒ± var. Kapsamlƒ± bir √ßalƒ±≈üma planƒ± olu≈üturmanƒ±zƒ± √∂neriyorum.';
    
    const body = `Merhaba ${studentData.name} ${studentData.surname},

${courseName} dersi i√ßin √ñ√á-P√á (√ñƒürenme √áƒ±ktƒ±larƒ± - Program √áƒ±ktƒ±larƒ±) performans analiziniz a≈üaƒüƒ±dadƒ±r:

√ñƒûRENCI Bƒ∞LGƒ∞LERƒ∞:
=================
Ad Soyad: ${studentData.name} ${studentData.surname}
√ñƒürenci No: ${studentData.studentId}
Ders: ${courseName}
D√∂nem: ${courseTerm}

√ñƒûRENME √áIKTILARI PERFORMANSI:
=============================
${outcomes.length > 0 ? outcomeAnalysis : 'Bu ders i√ßin √∂ƒürenme √ßƒ±ktƒ±larƒ± tanƒ±mlanmamƒ±≈ü.'}

PROGRAM √áIKTILARI ƒ∞Lƒ∞≈ûKƒ∞ ANALƒ∞Zƒ∞:
=================================
${programOutcomes.length > 0 ? programAnalysis : 'Program √ßƒ±ktƒ±larƒ± bilgisi mevcut deƒüil.'}

GENEL DEƒûERLENDƒ∞RME:
===================
Genel √ñ√á Performansƒ±: %${overallPerformance.toFixed(2)}
Deƒüerlendirme: ${performanceComment}

Analiz Edilen √ñ√á Sayƒ±sƒ±: ${validOutcomes}
Toplam √ñ√á Sayƒ±sƒ±: ${outcomes.length}
Toplam P√á Sayƒ±sƒ±: ${programOutcomes.length}

GELƒ∞≈ûƒ∞M PLANI VE √ñNERƒ∞LER:
=========================
${overallPerformance >= 85 ? 
`1. Kƒ±sa Vadeli: Mevcut performansƒ±nƒ±zƒ± koruyun ve ba≈ükalarƒ±na ment√∂rl√ºk yapƒ±n
2. Orta Vadeli: Liderlik becerilerinizi geli≈ütirin ve proje y√∂netimi deneyimi kazanƒ±n
3. Uzun Vadeli: ƒ∞leri d√ºzey konulara odaklanƒ±n ve ara≈ütƒ±rma projelerine katƒ±lƒ±n` :
overallPerformance >= 70 ?
`1. Kƒ±sa Vadeli: ƒ∞yi olduƒüunuz alanlarƒ± peki≈ütirin ve zayƒ±f noktalarƒ±nƒ±zƒ± belirleyin
2. Orta Vadeli: Zayƒ±f alanlarda ek √ßalƒ±≈üma yapƒ±n ve pratik uygulamalar geli≈ütirin
3. Uzun Vadeli: Kapsamlƒ± tekrar ve projeler ile bilginizi peki≈ütirin` :
overallPerformance >= 55 ?
`1. Kƒ±sa Vadeli: Temel konularƒ± yeniden g√∂zden ge√ßirin ve anlayamadƒ±ƒüƒ±nƒ±z noktalarƒ± belirleyin
2. Orta Vadeli: Daha fazla pratik yapƒ±n, √∂rnek problemler √ß√∂z√ºn ve grup √ßalƒ±≈ümalarƒ±na katƒ±lƒ±n
3. Uzun Vadeli: √áalƒ±≈üma y√∂ntemlerinizi geli≈ütirin ve d√ºzenli tekrar programƒ± olu≈üturun` :
overallPerformance >= 40 ?
`1. Kƒ±sa Vadeli: Temel kavramlarƒ± √∂ƒürenin, ders notlarƒ±nƒ± d√ºzenli olarak g√∂zden ge√ßirin
2. Orta Vadeli: D√ºzenli √ßalƒ±≈üma alƒ±≈ükanlƒ±ƒüƒ± edinin ve √∂ƒüretim √ºyesinden destek alƒ±n
3. Uzun Vadeli: Ek destek kaynaklarƒ±ndan yararlanƒ±n ve study grup olu≈üturun` :
`1. Kƒ±sa Vadeli: Dersin temel hedeflerini anlayƒ±n ve eksikliklerinizi tespit edin
2. Orta Vadeli: Birebir rehberlik alƒ±n ve temel konularda yoƒüunla≈üƒ±n
3. Uzun Vadeli: Kapsamlƒ± bir √ßalƒ±≈üma planƒ± olu≈üturun ve d√ºzenli takip yapƒ±n`}

√ñNERƒ∞LEN KAYNAKLAR:
==================
- Ders notlarƒ± ve sunumlarƒ±
- Kaynak kitaplar ve referanslar
- Online eƒüitim platformlarƒ±
- √ñrnek problemler ve √ß√∂z√ºmleri
- Grup √ßalƒ±≈ümasƒ± ve tartƒ±≈üma ortamlarƒ±

ƒ∞LETƒ∞≈ûƒ∞M:
=========
Bu analiz hakkƒ±nda detaylƒ± g√∂r√º≈ümek isterseniz:
- Ofis saatleri: [Belirtilecek]
- E-posta: ${instructor}
- G√∂r√º≈üme randevusu: √ñnceden haber verin

Bu analiz ${new Date().toLocaleDateString('tr-TR')} tarihinde olu≈üturulmu≈ütur.

ƒ∞yi √ßalƒ±≈ümalar,
${instructor}`;

    return { subject, body };
}

/**
 * Bilgi talebi e-postasƒ±
 */
function generateInfoRequestEmail(student, instructor, courseName, courseTerm) {
    const subject = `${courseName} - Gorusme Davet ve Bilgi Talebi`;
    
    const body = `Merhaba ${student.name} ${student.surname},

${courseName} dersi kapsaminda sizinle gorusmek istiyorum.

GORUSME SECENEKLERI:
- Yuz yuze gorusme (ofis saatleri)
- Online gorusme (Teams/Zoom)
- E-posta gorusmesi

GORUSMEK ISTEDIGIM KONULAR:
- Ders performansiniz ve gelisim alanlari
- Anlamakta zorlandiginiz konular
- Calisma yontemleriniz ve oneriler
- Gelecek planlariniz ve kariyer hedefleri

LUTFEN YANITLAYINIZ:
1. Hangi konularda zorlaniyorsunuz?
2. Ek destek almak istediginiz alanlar neler?
3. Gorusme icin uygun gunleriniz?
4. Tercih ettiginiz gorusme sekli?

En kisa surede yanitinizi bekliyorum.

Iyi calismalar,
${instructor}`;

    return { subject, body };
}

/**
 * E-posta modalƒ±nƒ± kapatƒ±r
 */
function closeEmailModal() {
    const modal = document.getElementById('emailTypeModal');
    modal.classList.remove('active');
    
    // Animasyon tamamlandƒ±ktan sonra modal'ƒ± gizle
    setTimeout(() => {
        modal.style.display = 'none';
    }, 300);
    
    // Deƒüi≈ükenleri temizle
    selectedEmailType = null;
    currentStudentForEmail = null;
    
    // √ñnizleme b√∂l√ºm√ºn√º gizle
    document.getElementById('emailPreviewSection').style.display = 'none';
}

/**
 * Modal event listener'larƒ±nƒ± ba≈ülatƒ±r
 */
function initializeEmailModal() {
    // E-posta t√ºr√º kartlarƒ±na tƒ±klama olaylarƒ±
    document.querySelectorAll('.email-type-card').forEach(card => {
        card.addEventListener('click', function() {
            selectEmailType(this.dataset.type);
        });
    });
    
    // Modal butonlarƒ±
    document.getElementById('generateEmailBtn').addEventListener('click', generateEmail);
    document.getElementById('previewEmailBtn').addEventListener('click', previewEmail);
    
    // Modal kapatma olaylarƒ±
    document.querySelectorAll('#emailTypeModal .modern-close').forEach(closeBtn => {
        closeBtn.addEventListener('click', closeEmailModal);
    });
    
    // Modal dƒ±≈üƒ±na tƒ±klama ile kapatma
    document.getElementById('emailTypeModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeEmailModal();
        }
    });
}

/**
 * Yardƒ±mcƒ± fonksiyonlar
 */
// Bu HTML fonksiyonlarƒ± artƒ±k kullanƒ±lmadƒ±ƒüƒ± i√ßin kaldƒ±rƒ±ldƒ± - text tabanlƒ± e-posta kullanƒ±yoruz

// Bu HTML fonksiyonlarƒ± da kaldƒ±rƒ±ldƒ± - text tabanlƒ± e-posta kullanƒ±yoruz

function getInstructorName() {
    return APP_STATE.courseData?.dersIcerik?.dersiVerenOgretimUyesiOgretimGorevlisi || 
           APP_STATE.courseData?.dersBilgisi?.ogretimUyesi || 
           '√ñƒüretim √úyesi';
}

function getCourseInfo() {
    return {
        name: APP_STATE.courseData?.dersBilgisi?.dersAdi || 
              APP_STATE.courseData?.dersGenel?.dersAdi || 
              'Ders',
        term: APP_STATE.courseData?.dersBilgisi?.donem || 
              APP_STATE.courseData?.dersGenel?.akademikYil || 
              '2023-2024'
    };
}

/**
 * Yeni modalƒ± kapat
 */
function closeNewEmailModal() {
    const modal = document.getElementById('newEmailModal');
    if (modal) {
        modal.classList.remove('active');
        setTimeout(() => {
            modal.remove();
        }, 300);
    }
    selectedEmailType = null;
}

/**
 * Text formatƒ±nda e-posta g√∂nder
 */
function sendTextEmail() {
    if (!selectedEmailType || !currentStudentForEmail) return;
    
    let textContent;
    
    // Her e-posta t√ºr√º i√ßin √∂zel text formatƒ±
    switch (selectedEmailType) {
        case 'survey':
            textContent = generateSurveyTextEmail(currentStudentForEmail);
            break;
        case 'detailed':
            textContent = generateDetailedScoreTextEmail(currentStudentForEmail);
            break;
        case 'analysis':
            textContent = generateAnalysisTextEmail(currentStudentForEmail);
            break;
        case 'info':
            textContent = generateInfoRequestTextEmail(currentStudentForEmail);
            break;
        default:
            showModernToast('‚ùå Bilinmeyen e-posta t√ºr√º!', 'error');
            return;
    }
    
    // Gmail URL olu≈ütur
    const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(currentStudentForEmail.email)}&su=${encodeURIComponent(textContent.subject)}&body=${encodeURIComponent(textContent.body)}`;
    
    // Gmail'i a√ß
    window.open(gmailUrl, '_blank', 'noopener');
    
    // Modalƒ± kapat
    closeNewEmailModal();
    
    // Ba≈üarƒ± mesajƒ± g√∂ster
    showModernToast('üìß Text formatƒ±nda e-posta Gmail\'de a√ßƒ±ldƒ±!', 'success');
}

/**
 * Anket e-postasƒ± i√ßin √∂zel text formatƒ±
 */
function generateSurveyTextEmail(student) {
    const instructor = getInstructorName();
    const courseInfo = getCourseInfo();
    const courseName = courseInfo.name;
    const courseTerm = courseInfo.term;
    const courseCode = APP_STATE.courseData?.dersBilgisi?.dersKodu || 'XXX000';
    
    const subject = `${courseName} - Ders Bazinda Ogrenme Ciktilari Anketi`;
    
    const outcomes = APP_STATE.courseData?.dersOgrenme√áiktilari || [];
    
    let questionSection = '';
    if (outcomes.length > 0) {
        questionSection = `Dersin Kodu / Adi: ${courseCode} / ${courseName}\n\n`;
        questionSection += `OGRENME CIKTILARI DEGERLENDIRME ANKETI\n`;
        questionSection += `${'='.repeat(70)}\n\n`;
        
        outcomes.forEach((outcome, index) => {
            const questionNum = index + 1;
            const fullDescription = outcome.aciklama || outcome.description || 'Tanimlanmamis';
            
            // Soru metni
            questionSection += `${questionNum}. ${fullDescription}\n`;
            
            // Her soru i√ßin kendi sayƒ±larƒ± ve kutucuklarƒ±
            questionSection += `                                   5   4   3   2   1\n`;
            questionSection += `                                  ( ) ( ) ( ) ( ) ( )\n\n`;
        });
        
        questionSection += `${'='.repeat(70)}\n\n`;
        questionSection += `DEGERLENDIRME SKALASI:\n`;
        questionSection += `5: Kesinlikle Katiliyorum\n`;
        questionSection += `4: Katiliyorum\n`;
        questionSection += `3: Kismen Katiliyorum\n`;
        questionSection += `2: Katilmiyorum\n`;
        questionSection += `1: Kesinlikle Katilmiyorum\n\n`;
    } else {
        questionSection = `UYARI: Bu ders icin ogrenme ciktilari tanimlanmamis.\nLutfen ders sorumlusu ile iletisime geciniz.\n\n`;
    }
    
    const body = `DERS DEGERLENDIRME ANKETI

Recep Tayyip Erdogan Universitesi
Bilgisayar Muhendisligi
Ders Bazinda Ogrenme Ciktilari Anketi

${'='.repeat(70)}

Degerli Recep Tayyip Erdogan Universitesi Bilgisayar Muhendisligi Ogrencileri;

Asagida verilen ders bazinda ogrenme ciktisi anketi bolumumuz lisans 
programinda yer alan derslerin degerlendirilmesi amaci ile hazirlanmistir. 
Ankete yanit verirken lutfen dersin ilgili ogrenme ciktisina katkisini 
degerlendiriniz. Katki orani icin sectiginiz yanita karsilik gelen 
kutucuga isaret koyunuz.

Gosterdiginiz ilgi ve zamaniniz icin cok tesekkur ederiz.

${'='.repeat(70)}

${questionSection}
${'='.repeat(70)}

Bu anket ${new Date().toLocaleDateString('tr-TR')} tarihinde gonderilmistir.

Merhaba ${student.name} ${student.surname},

Lutfen anketi doldurarak bana geri gonderiniz.

Iyi calismalar,
${instructor}`;

    return { subject, body };
}

/**
 * HTML formatƒ±nda e-posta g√∂nder
 */
function sendHtmlEmail() {
    if (!selectedEmailType || !currentStudentForEmail) return;
    
    const emailContent = generateEmailByType(selectedEmailType, currentStudentForEmail);
    
    // HTML formatƒ± i√ßin yeni pencere a√ß
    openEmailInNewWindow(emailContent, currentStudentForEmail.email);
    
    // Modalƒ± kapat
    closeNewEmailModal();
    
    // Ba≈üarƒ± mesajƒ± g√∂ster
    showModernToast('üé® HTML formatƒ±nda e-posta hazƒ±rlandƒ±!', 'success');
}

/**
 * Detaylƒ± puan e-postasƒ± i√ßin text formatƒ±
 */
function generateDetailedScoreTextEmail(student) {
    const instructor = getInstructorName();
    const courseInfo = getCourseInfo();
    const courseName = courseInfo.name;
    const courseTerm = courseInfo.term;
    
    const subject = `${courseName} - Not Bilgisi`;
    
    // √ñƒürenci verilerini al
    let studentData = APP_STATE.studentData?.find(s => s.studentId === student.studentId);
    if (!studentData) {
        studentData = {
            studentId: student.studentId,
            name: student.name || 'Bilinmeyen',
            surname: student.surname || '√ñƒürenci'
        };
    }

    // √ñƒürenci notlarƒ±nƒ± al
    const allGradesData = APP_STATE.gradesData || APP_STATE.courseData?.ogrenciNotlari || {};
    const studentGrades = allGradesData[studentData.studentId] || {};
    
    // Temel hesaplamalar
    const assessmentTree = APP_STATE.assessmentTree || [];
    const termComponents = assessmentTree.filter(comp => comp.id && comp.id.startsWith('A'));
    const finalComponents = assessmentTree.filter(comp => comp.id && comp.id.startsWith('F'));
    
    let termWeightedSum = 0;
    let termTotalWeight = 0;
    let finalWeightedSum = 0;
    let finalTotalWeight = 0;
    
    // Yarƒ±yƒ±l i√ßi hesaplama
    termComponents.forEach(comp => {
        let grade = studentGrades[comp.id] || 0;
        
        // Alt √∂ƒüeleri kontrol et ve topla
        if (comp.children && comp.children.length > 0) {
            let childrenTotal = 0;
            comp.children.forEach(child => {
                const childGrade = studentGrades[child.id] || 0;
                childrenTotal += parseFloat(childGrade) || 0;
            });
            grade = childrenTotal; // Alt √∂ƒüelerin toplamƒ±nƒ± kullan
        }
        
        const weight = comp.weight || 0;
        termWeightedSum += (grade * weight) / 100;
        termTotalWeight += weight;
    });
    
    // Yarƒ±yƒ±l sonu hesaplama
    finalComponents.forEach(comp => {
        let grade = studentGrades[comp.id] || 0;
        
        // Alt √∂ƒüeleri kontrol et ve topla
        if (comp.children && comp.children.length > 0) {
            let childrenTotal = 0;
            comp.children.forEach(child => {
                const childGrade = studentGrades[child.id] || 0;
                childrenTotal += parseFloat(childGrade) || 0;
            });
            grade = childrenTotal; // Alt √∂ƒüelerin toplamƒ±nƒ± kullan
        }
        
        const weight = comp.weight || 0;
        finalWeightedSum += (grade * weight) / 100;
        finalTotalWeight += weight;
    });
    
    const yilIciOrt = termTotalWeight > 0 ? (termWeightedSum * 100 / termTotalWeight) : 0;
    const yilSonuOrt = finalTotalWeight > 0 ? (finalWeightedSum * 100 / finalTotalWeight) : 0;
    const genelOrt = (yilIciOrt * 40 + yilSonuOrt * 60) / 100;
    const harfNotu = calculateLetterGrade(genelOrt);

    const body = `${courseName} - NOT RAPORU

${studentData.name} ${studentData.surname} (${studentData.studentId})
${courseTerm} - ${new Date().toLocaleDateString('tr-TR')}

YARIYIL ICI NOTLAR:
${termComponents.map(comp => {
    let grade = studentGrades[comp.id] || 0;
    
    // Alt √∂ƒüeleri kontrol et ve topla
    if (comp.children && comp.children.length > 0) {
        let childrenTotal = 0;
        comp.children.forEach(child => {
            const childGrade = studentGrades[child.id] || 0;
            childrenTotal += parseFloat(childGrade) || 0;
        });
        grade = childrenTotal; // Alt √∂ƒüelerin toplamƒ±nƒ± kullan
    }
    
    const name = comp.name || comp.ad || comp.id;
    return `${name}: ${grade}/100 (%${comp.weight || 0})`;
}).join('\n')}
Yariyil Ici Ortalama: %${yilIciOrt.toFixed(2)}

YARIYIL SONU NOTLAR:
${finalComponents.map(comp => {
    let grade = studentGrades[comp.id] || 0;
    
    // Alt √∂ƒüeleri kontrol et ve topla
    if (comp.children && comp.children.length > 0) {
        let childrenTotal = 0;
        comp.children.forEach(child => {
            const childGrade = studentGrades[child.id] || 0;
            childrenTotal += parseFloat(childGrade) || 0;
        });
        grade = childrenTotal; // Alt √∂ƒüelerin toplamƒ±nƒ± kullan
    }
    
    const name = comp.name || comp.ad || comp.id;
    return `${name}: ${grade}/100 (%${comp.weight || 0})`;
}).join('\n')}
Yariyil Sonu Ortalama: %${yilSonuOrt.toFixed(2)}

HESAPLAMA:
Yariyil Ici (%40): ${yilIciOrt.toFixed(2)} * 0.4 = ${(yilIciOrt * 0.4).toFixed(2)}
Yariyil Sonu (%60): ${yilSonuOrt.toFixed(2)} * 0.6 = ${(yilSonuOrt * 0.6).toFixed(2)}
GENEL ORTALAMA: %${genelOrt.toFixed(2)}
HARF NOTU: ${harfNotu}
DURUM: ${genelOrt >= 60 ? 'GECTI' : 'KALDI'}

NOT SISTEMI:
AA:90-100, BA:85-89, BB:80-84, CB:75-79, CC:70-74
DC:65-69, DD:60-64, FD:50-59, FF:0-49

Sorulariniz icin: ${instructor}

Iyi calismalar,
${instructor}`;

    return { subject, body };
}

// Yardƒ±mcƒ± fonksiyonlar
function calculateOCPerformanceFromText(ocId, studentGrades, assessmentTree) {
    // Ger√ßek √ñ√á performans hesaplamasƒ±
    let outcomePerformance = 0;
    let relatedActivities = 0;
    
    // Deƒüerlendirme aƒüacƒ±ndan bu √∂ƒürenme √ßƒ±ktƒ±sƒ± ile ili≈ükili aktiviteleri bul
    assessmentTree.forEach(component => {
        if (component.outcomes && component.outcomes.includes(ocId)) {
            const componentGrade = studentGrades[component.id] || 0;
            const componentMax = component.points || 100;
            const componentPerf = componentMax > 0 ? (componentGrade / componentMax) * 100 : 0;
            
            outcomePerformance += componentPerf;
            relatedActivities++;
        }
        
        // Alt √∂ƒüeleri de kontrol et
        if (component.children) {
            component.children.forEach(child => {
                if (child.outcomes && child.outcomes.includes(ocId)) {
                    const childGrade = studentGrades[child.id] || 0;
                    const childMax = child.points || 100;
                    const childPerf = childMax > 0 ? (childGrade / childMax) * 100 : 0;
                    
                    outcomePerformance += childPerf;
                    relatedActivities++;
                }
            });
        }
    });
    
    return relatedActivities > 0 ? (outcomePerformance / relatedActivities) : 0;
}

/**
 * P√á ili≈üki g√ºc√º hesaplama fonksiyonu
 */
function calculatePCRelationStrength(pcId, relationMatrix) {
    const relatedRelations = relationMatrix.filter(relation => {
        const relationValue = relation.program√áiktilariIliskileri?.[pcId] || 0;
        return relationValue > 0;
    });
    
    if (relatedRelations.length === 0) return { strength: 0, level: 'Yok' };
    
    let totalStrength = 0;
    relatedRelations.forEach(relation => {
        totalStrength += relation.program√áiktilariIliskileri[pcId];
    });
    
    const avgStrength = totalStrength / relatedRelations.length;
    let level = 'Zayƒ±f';
    if (avgStrength >= 4) level = 'G√º√ßl√º';
    else if (avgStrength >= 3) level = 'Orta';
    
    return { strength: avgStrength, level: level };
}

function getPerformanceTextLevel(performance) {
    if (performance >= 90) return 'Mukemmel';
    else if (performance >= 80) return 'Cok Iyi';
    else if (performance >= 70) return 'Iyi';
    else if (performance >= 60) return 'Orta';
    else if (performance >= 50) return 'Zayif';
    else return 'Yetersiz';
}

/**
 * √ñ√á-P√á Analiz e-postasƒ± i√ßin text formatƒ±
 */
function generateAnalysisTextEmail(student) {
    const instructor = getInstructorName();
    const courseInfo = getCourseInfo();
    const courseName = courseInfo.name;
    const courseTerm = courseInfo.term;
    
    const subject = `${courseName} - OC-PC Analizi`;
    
    // √ñƒürenci verilerini al
    let studentData = APP_STATE.studentData?.find(s => s.studentId === student.studentId);
    if (!studentData) {
        studentData = {
            studentId: student.studentId,
            name: student.name || 'Bilinmeyen',
            surname: student.surname || '√ñƒürenci'
        };
    }

    // Temel veriler
    const outcomes = APP_STATE.courseData?.dersOgrenme√áiktilari || [];
    const programOutcomes = APP_STATE.courseData?.programCiktilari || [];
    const assessmentTree = APP_STATE.assessmentTree || [];
    const studentGrades = APP_STATE.gradesData?.[studentData.studentId] || {};
    const relationMatrix = APP_STATE.courseData?.programVeOgrenmeIliskisi?.iliskiTablosu || [];
    
    // Ger√ßek √ñ√á performans hesabƒ±
    const totalOC = outcomes.length;
    const totalPC = programOutcomes.length;
    let totalOCPerformance = 0;
    let validOCCount = 0;
    
    // Ger√ßek √ñ√á hesaplamalarƒ±
    const ocResults = outcomes.slice(0, 4).map(oc => {
        const performance = calculateOCPerformanceFromText(oc.id, studentGrades, assessmentTree);
        totalOCPerformance += performance;
        if (performance > 0) validOCCount++;
        return `${oc.id}: %${performance.toFixed(2)}`;
    }).join('\n');
    
    // Ger√ßek P√á hesaplamalarƒ±
    let strongRelations = 0;
    let moderateRelations = 0;
    programOutcomes.forEach(pc => {
        const relation = calculatePCRelationStrength(pc.id, relationMatrix);
        if (relation.level === 'G√º√ßl√º') strongRelations++;
        else if (relation.level === 'Orta') moderateRelations++;
    });
    
    // Genel performans
    const avgPerformance = validOCCount > 0 ? totalOCPerformance / validOCCount : 0;

    const body = `${courseName} - OC-PC ANALIZI

${studentData.name} ${studentData.surname} (${studentData.studentId})
${courseTerm} - ${new Date().toLocaleDateString('tr-TR')}

OGRENME CIKTILARI (OC):
${ocResults}
${totalOC > 4 ? `... ve ${totalOC - 4} tane daha` : ''}

PROGRAM CIKTILARI (PC):
Iliskili PC Sayisi: ${totalPC}
Guclu Iliski: ${strongRelations}
Orta Iliski: ${moderateRelations}

GENEL PERFORMANS:
OC Ortalamasi: %${avgPerformance.toFixed(2)}
Degerlendirme: ${avgPerformance >= 80 ? 'Cok Iyi' : avgPerformance >= 70 ? 'Iyi' : avgPerformance >= 60 ? 'Orta' : 'Zayif'}

MUDEK DEGERLENDIRME:
OC Basari Orani: %${validOCCount > 0 ? (validOCCount / totalOC * 100).toFixed(2) : '0.0'}
PC Iliski Orani: %${totalPC > 0 ? ((strongRelations + moderateRelations) / totalPC * 100).toFixed(2) : '0.0'}

${avgPerformance >= 80 ? 
'ONERI: Mevcut performansinizi koruun ve surdurun' :
avgPerformance >= 70 ? 
'ONERI: Zayif alanlarda gelisim plani yapin' : 
'ONERI: Temel yetkinliklere odaklanin'}

Detayli analiz icin: ${instructor}

Iyi calismalar,
${instructor}`;

    return { subject, body };
}

/**
 * Bilgi talebi e-postasƒ± i√ßin text formatƒ±
 */
function generateInfoRequestTextEmail(student) {
    const instructor = getInstructorName();
    const courseInfo = getCourseInfo();
    const courseName = courseInfo.name;
    
    const subject = `${courseName} - Gorusme Talebi`;
    
    const body = `${courseName} - GORUSME TALEBI

Merhaba ${student.name} ${student.surname},

${courseName} dersi hakkinda sizinle gorusmek istiyorum.

GORUSME KONULARI:
- Ders performansiniz
- Zorluklar ve destekler
- Calisma onerileri
- Gelecek planlariniz

YANITLAYINIZ:
1. Hangi konularda zorlaniyorsunuz?
2. Ne konuda destek istersiniz?
3. Gorusme icin uygun gun?
4. Tercih: Yuz yuze / Online?

Yanitinizi bekliyorum.

Iyi calismalar,
${instructor}`;

    return { subject, body };
}

/**
 * Harf notu hesaplama yardƒ±mcƒ± fonksiyonu
 */
function calculateLetterGrade(score) {
    if (score >= 90) return 'AA';
    if (score >= 85) return 'BA';
    if (score >= 80) return 'BB';
    if (score >= 75) return 'CB';
    if (score >= 70) return 'CC';
    if (score >= 65) return 'DC';
    if (score >= 60) return 'DD';
    if (score >= 50) return 'FD';
    return 'FF';
}

/**
 * Modern Test Operations - V2 Card System
 */
function initializeModernTestOperations() {
    console.log('üîß Modern Test Operations ba≈ülatƒ±lƒ±yor...');
    
    // Slider deƒüer g√ºncellemeleri
    initializeModernSliders();
    
    // Dual Range Slider sistemi
    initializeModernDualRange();
    
    // Akƒ±llƒ± puanlama sistemi
    initializeModernScoring();
    
    // ƒ∞statistik g√ºncellemeleri
    updateModernStats();
}

/**
 * Modern slider'larƒ± ba≈ülat
 */
function initializeModernSliders() {
    // Yarƒ±yƒ±l ƒ∞√ßi Etkinlik Sayƒ±sƒ± Slider
    const termActivitySlider = document.getElementById('termActivityCountSlider');
    const termActivityValue = document.getElementById('termActivityCountValue');
    
    if (termActivitySlider && termActivityValue) {
        termActivitySlider.addEventListener('input', function() {
            termActivityValue.textContent = this.value;
        });
    }
    
    // Yarƒ±yƒ±l ƒ∞√ßi Soru/Rubrik Sayƒ±sƒ± Slider
    const termSlider = document.getElementById('termComponentsSlider');
    const termValue = document.getElementById('termComponentsValue');
    
    if (termSlider && termValue) {
        termSlider.addEventListener('input', function() {
            termValue.textContent = this.value;
        });
    }
    
    // Yarƒ±yƒ±l Sonu Etkinlik Sayƒ±sƒ± Slider
    const finalActivitySlider = document.getElementById('finalActivityCountSlider');
    const finalActivityValue = document.getElementById('finalActivityCountValue');
    
    if (finalActivitySlider && finalActivityValue) {
        finalActivitySlider.addEventListener('input', function() {
            finalActivityValue.textContent = this.value;
        });
    }
    
    // Yarƒ±yƒ±l Sonu Soru/Rubrik Sayƒ±sƒ± Slider
    const finalSlider = document.getElementById('finalComponentsSlider');
    const finalValue = document.getElementById('finalComponentsValue');
    
    if (finalSlider && finalValue) {
        finalSlider.addEventListener('input', function() {
            finalValue.textContent = this.value;
        });
    }
}

/**
 * Modern Dual Range Slider sistemi
 */
function initializeModernDualRange() {
    const minSlider = document.getElementById('groupMinSlider');
    const maxSlider = document.getElementById('groupMaxSlider');
    const minValue = document.getElementById('groupMinValue');
    const maxValue = document.getElementById('groupMaxValue');
    
    if (!minSlider || !maxSlider || !minValue || !maxValue) return;
    
    function updateValues() {
        let minVal = parseInt(minSlider.value);
        let maxVal = parseInt(maxSlider.value);
        
        // Min deƒüer max deƒüerden b√ºy√ºk olamaz
        if (minVal > maxVal) {
            minVal = maxVal;
            minSlider.value = minVal;
        }
        
        // Max deƒüer min deƒüerden k√º√ß√ºk olamaz
        if (maxVal < minVal) {
            maxVal = minVal;
            maxSlider.value = maxVal;
        }
        
        minValue.textContent = minVal;
        maxValue.textContent = maxVal;
        
        // ƒ∞statistikleri g√ºncelle
        updateModernStats();
    }
    
    minSlider.addEventListener('input', updateValues);
    maxSlider.addEventListener('input', updateValues);
    
    // ƒ∞lk deƒüerleri ayarla
    updateValues();
}

/**
 * Modern Scoring sistemi
 */
function initializeModernScoring() {
    const passRateSlider = document.getElementById('passRateSlider');
    const passRateValue = document.getElementById('passRateValue');
    
    if (!passRateSlider || !passRateValue) return;
    
    passRateSlider.addEventListener('input', function() {
        const value = parseInt(this.value);
        passRateValue.textContent = value + '%';
        
        // Pass/Fail hesaplamalarƒ±nƒ± g√ºncelle
        updatePassFailCounts();
    });
    
    // ƒ∞lk deƒüeri ayarla
    passRateValue.textContent = passRateSlider.value + '%';
    updatePassFailCounts();
    
    // Grup slider'larƒ±nƒ±n sƒ±nƒ±rlarƒ±nƒ± ba≈ülangƒ±√ßta ayarla
    updateGroupSliderLimits();
}

/**
 * Pass/Fail sayƒ±larƒ±nƒ± g√ºncelle
 */
function updatePassFailCounts() {
    console.log('üîç updatePassFailCounts √ßaƒürƒ±ldƒ±');
    
    const passRateSlider = document.getElementById('passRateSlider');
    const passStudentCount = document.getElementById('passStudentCount');
    const failStudentCount = document.getElementById('failStudentCount');
    const passRateDisplay = document.getElementById('passRateDisplay');
    const failRateDisplay = document.getElementById('failRateDisplay');
    const studentCountDisplay = document.getElementById('studentCountDisplay');
    const groupCountDisplay = document.getElementById('groupCountDisplay');
    
    console.log('üîç DOM elementleri:', {
        passRateSlider: !!passRateSlider,
        passStudentCount: !!passStudentCount,
        failStudentCount: !!failStudentCount,
        passRateDisplay: !!passRateDisplay,
        failRateDisplay: !!failRateDisplay,
        studentCountDisplay: !!studentCountDisplay,
        groupCountDisplay: !!groupCountDisplay
    });
    
    if (!passRateSlider || !passStudentCount || !failStudentCount) {
        console.warn('‚ö†Ô∏è Gerekli DOM elementleri bulunamadƒ±');
        return;
    }
    
    // Ger√ßek √∂ƒürenci sayƒ±sƒ±nƒ± al
    const totalStudents = getTotalStudentCount();
    const passRate = parseInt(passRateSlider.value);
    const failRate = 100 - passRate;
    
    console.log('üîç Veriler:', {
        totalStudents,
        passRate,
        failRate,
        studentDataLength: APP_STATE.studentData?.length || 0,
        appStateStudentData: !!APP_STATE.studentData
    });
    
    // Ger√ßek not verilerini kontrol et
    let actualPassCount = 0;
    let actualFailCount = 0;
    let hasActualGrades = false;
    
    if (totalStudents > 0 && APP_STATE.gradesData) {
        APP_STATE.studentData.forEach(student => {
            const studentGrades = APP_STATE.gradesData[student.studentId];
            if (studentGrades && studentGrades.harfNotu) {
                hasActualGrades = true;
                const letterGrade = studentGrades.harfNotu;
                // AA, BA, BB, CB, CC, DC = ge√ßer, DD, FD, FF = kalƒ±r
                const passingGrades = ['AA', 'BA', 'BB', 'CB', 'CC', 'DC'];
                if (passingGrades.includes(letterGrade)) {
                    actualPassCount++;
                } else {
                    actualFailCount++;
                }
            }
        });
    }
    
    // Hesaplanan veya ger√ßek sayƒ±larƒ± kullan
    let displayPassCount, displayFailCount;
    let displayPassRate, displayFailRate;
    
    if (hasActualGrades && (actualPassCount > 0 || actualFailCount > 0)) {
        // Ger√ßek not verileri varsa onlarƒ± kullan
        displayPassCount = actualPassCount;
        displayFailCount = actualFailCount;
        displayPassRate = Math.round((actualPassCount / totalStudents) * 100);
        displayFailRate = Math.round((actualFailCount / totalStudents) * 100);
        console.log('üìä Ger√ßek not verileri kullanƒ±lƒ±yor');
    } else {
        // Tahmini hesaplama yap
        displayPassCount = Math.round(totalStudents * passRate / 100);
        displayFailCount = totalStudents - displayPassCount;
        displayPassRate = passRate;
        displayFailRate = failRate;
        console.log('üìä Tahmini hesaplama kullanƒ±lƒ±yor');
    }
    
    // Status badge'lerdeki √∂ƒürenci sayƒ±larƒ±nƒ± g√ºncelle
    passStudentCount.textContent = displayPassCount;
    failStudentCount.textContent = displayFailCount;
    
    // Oran g√∂sterimlerini g√ºncelle
    if (passRateDisplay) {
        passRateDisplay.textContent = `${displayPassRate}%`;
    }
    
    if (failRateDisplay) {
        failRateDisplay.textContent = `${displayFailRate}%`;
    }
    
    // Toplam √∂ƒürenci sayƒ±sƒ±nƒ± g√ºncelle
    if (studentCountDisplay) {
        studentCountDisplay.textContent = totalStudents;
        console.log('‚úÖ studentCountDisplay g√ºncellendi:', totalStudents);
    } else {
        console.warn('‚ö†Ô∏è studentCountDisplay elementi bulunamadƒ±');
    }
    
    // Grup bilgisi artƒ±k kategori detaylarƒ±nda g√∂steriliyor
    
    console.log(`üéØ ƒ∞statistikler g√ºncellendi: Toplam ${totalStudents} √∂ƒürenci, Ge√ßecek ${displayPassCount} (%${displayPassRate}), Kalacak ${displayFailCount} (%${displayFailRate})`);
}

/**
 * Modern istatistikleri g√ºncelle
 */
function updateModernStats() {
    const totalStudentsCount = document.getElementById('totalStudentsCount');
    const activeGroupsCount = document.getElementById('activeGroupsCount');
    
    if (totalStudentsCount) {
        totalStudentsCount.textContent = getTotalStudentCount();
    }
    
    if (activeGroupsCount) {
        activeGroupsCount.textContent = getActiveGroupsCount();
    }
}

/**
 * Toplam √∂ƒürenci sayƒ±sƒ±nƒ± al
 */
function getTotalStudentCount() {
    if (APP_STATE.studentData && APP_STATE.studentData.length > 0) {
        return APP_STATE.studentData.length;
    }
    return 0;
}

/**
 * Ana bile≈üen bazlƒ± grup sayƒ±sƒ± bilgisini al - Sadece ana etkinlikleri g√∂ster (A1, A2, F1...)
 */
function getActiveGroupsCount() {
    try {
        // courseData.grupHaritalari'ndan sadece ana bile≈üenlerin grup sayƒ±larƒ±nƒ± al
        if (APP_STATE.courseData && APP_STATE.courseData.grupHaritalari) {
            const mainComponentGroupCounts = [];
            
            Object.keys(APP_STATE.courseData.grupHaritalari).forEach(componentId => {
                // Sadece ana bile≈üenleri al (A1, A2, F1... - alt sorular deƒüil A1.1, A1.2...)
                if (componentId.match(/^[AF]\d+$/) && !componentId.includes('.')) {
                    const component = APP_STATE.courseData.grupHaritalari[componentId];
                    if (component && component.gruplar && Array.isArray(component.gruplar)) {
                        // Sadece ge√ßerli gruplarƒ± say
                        const validGroups = component.gruplar.filter(group => 
                            group && group.length === 1 && /^[A-Z]$/.test(group)
                        );
                        
                        if (validGroups.length > 0) {
                            mainComponentGroupCounts.push({
                                id: componentId,
                                name: componentId,
                                count: validGroups.length
                            });
                        }
                    }
                }
            });
            
            console.log('üîç Ana bile≈üen grup sayƒ±larƒ±:', mainComponentGroupCounts);
            
            if (mainComponentGroupCounts.length > 0) {
                // Eƒüer t√ºm bile≈üenler aynƒ± grup sayƒ±sƒ±na sahipse kƒ±sa format
                const allCounts = mainComponentGroupCounts.map(comp => comp.count);
                const uniqueCounts = [...new Set(allCounts)];
                
                if (uniqueCounts.length === 1) {
                    // T√ºm bile≈üenler aynƒ± grup sayƒ±sƒ±na sahip
                    const groupCount = uniqueCounts[0];
                    return `${mainComponentGroupCounts.length} bile≈üen √ó ${groupCount} grup`;
                } else {
                    // Farklƒ± grup sayƒ±larƒ± var, detaylƒ± g√∂ster
                    return mainComponentGroupCounts.map(comp => `${comp.name}:${comp.count}`).join(', ');
                }
            }
        }
        
        // Fallback: √ñƒürenci verilerinden tek grup sayƒ±sƒ±
        if (APP_STATE.studentData && APP_STATE.studentData.length > 0) {
            const uniqueGroups = new Set();
            APP_STATE.studentData.forEach(student => {
                if (student.grup && student.grup.length === 1 && /^[A-Z]$/.test(student.grup)) {
                    uniqueGroups.add(student.grup);
                }
            });
            
            if (uniqueGroups.size > 0) {
                return `${uniqueGroups.size} grup (t√ºm bile≈üenler)`;
            }
    }
    
        // Son √ßare: Varsayƒ±lan
        console.log('üîç Hi√ß grup bulunamadƒ±, varsayƒ±lan d√∂nd√ºr√ºl√ºyor');
        return '1 grup';
        
    } catch (error) {
        console.error('‚ùå getActiveGroupsCount hatasƒ±:', error);
        return 'Hata';
    }
}

/**
 * Grup detaylarƒ± tooltip'ini g√ºncelle
 */
function updateGroupDetailsTooltip() {
    try {
        const groupDetailsContent = document.getElementById('groupDetailsContent');
        if (!groupDetailsContent) return;
        
        let html = '';
        
        // courseData.grupHaritalari'ndan sadece ana bile≈üenlerin detaylƒ± grup bilgilerini al
    if (APP_STATE.courseData && APP_STATE.courseData.grupHaritalari) {
            const componentDetails = [];
            
            Object.keys(APP_STATE.courseData.grupHaritalari).forEach(componentId => {
                // Sadece ana bile≈üenleri al (A1, A2, F1... - alt sorular deƒüil A1.1, A1.2...)
                if (componentId.match(/^[AF]\d+$/) && !componentId.includes('.')) {
                    const component = APP_STATE.courseData.grupHaritalari[componentId];
                    if (component && component.gruplar && Array.isArray(component.gruplar)) {
                        // Bile≈üen adƒ±nƒ± al ve formatla
                        const activityNode = APP_STATE.assessmentTree?.find(node => node.id === componentId);
                        let componentName = componentId;
                        
                        if (activityNode) {
                            // Emoji'yi belirle
                            let emoji = 'üìù';
                            if (activityNode.type.includes('Ev √ñdevi') || activityNode.type.includes('√ñdev')) emoji = 'üìö';
                            else if (activityNode.type.includes('Laboratuvar') || activityNode.type.includes('Lab')) emoji = '‚öóÔ∏è';
                            else if (activityNode.type.includes('Final')) emoji = 'üéØ';
                            else if (activityNode.type.includes('Quiz')) emoji = '‚ùì';
                            else if (activityNode.type.includes('Proje')) emoji = 'üöÄ';
                            else if (activityNode.type.includes('Rapor')) emoji = 'üìä';
                            else if (activityNode.type.includes('Sunum')) emoji = 'üé§';
                            
                            // Alt bile≈üen sayƒ±sƒ±nƒ± hesapla
                            const subComponentCount = activityNode.children ? activityNode.children.length : 0;
                            let subComponentText = '';
                            
                            if (subComponentCount > 0) {
                                // Alt bile≈üenlerin tipini belirle
                                const firstChild = activityNode.children[0];
                                if (firstChild.type === 'Soru' || firstChild.type.includes('Soru')) {
                                    subComponentText = ` (${subComponentCount} Soru)`;
                                } else if (firstChild.type === 'Rubrik' || firstChild.type.includes('Rubrik')) {
                                    subComponentText = ` (${subComponentCount} Rubrik)`;
                                } else {
                                    subComponentText = ` (${subComponentCount} Bile≈üen)`;
                                }
                            } else {
                                subComponentText = ' (Bo≈ü)';
                            }
                            
                            // Aƒüƒ±rlƒ±k bilgisini al
                            const weight = activityNode.weight || 0;
                            
                            componentName = `${emoji} ${activityNode.name} %${weight}${subComponentText}`;
                        }
                        
                        // Sadece ge√ßerli gruplarƒ± say
                        const validGroups = component.gruplar.filter(group => 
                            group && group.length === 1 && /^[A-Z]$/.test(group)
                        );
                        
                        if (validGroups.length > 0) {
                            componentDetails.push({
                                name: componentName,
                                gruplar: validGroups,
                                count: validGroups.length
                            });
                        }
                    }
                }
            });
            
            if (componentDetails.length > 0) {
                // Bile≈üen bazlƒ± grup detaylarƒ±
                componentDetails.forEach(detail => {
                    html += `
                        <div class="group-detail-item">
                            <div class="group-detail-name">${detail.name}</div>
                            <div>
                                <span class="group-detail-groups">${detail.gruplar.join(', ')}</span>
                                <span class="group-count-badge">${detail.count}</span>
                            </div>
                        </div>
                    `;
                });
                
                                 // Bile≈üen sayƒ±sƒ± ve grup daƒüƒ±lƒ±mƒ± √∂zeti
                 const totalComponents = componentDetails.length;
                 const groupCounts = componentDetails.map(detail => detail.count);
                 const minGroups = Math.min(...groupCounts);
                 const maxGroups = Math.max(...groupCounts);
                 
                 html += `
                     <div class="group-detail-item" style="border-top: 2px solid #e9ecef; margin-top: 8px; padding-top: 8px; font-weight: 600;">
                         <div class="group-detail-name">üìä Bile≈üen √ñzeti</div>
                         <div>
                             <span class="group-detail-groups">${totalComponents} bile≈üen, ${minGroups === maxGroups ? minGroups : `${minGroups}-${maxGroups}`} grup/bile≈üen</span>
                             <span class="group-count-badge" style="background: #4caf50; color: white;">${totalComponents}</span>
                         </div>
                     </div>
                 `;
            } else {
                html = '<div class="group-detail-item"><div class="group-detail-name">Hen√ºz grup tanƒ±mlanmamƒ±≈ü</div></div>';
            }
        } else {
            html = '<div class="group-detail-item"><div class="group-detail-name">Grup verisi bulunamadƒ±</div></div>';
        }
        
        groupDetailsContent.innerHTML = html;
        
    } catch (error) {
        console.error('‚ùå updateGroupDetailsTooltip hatasƒ±:', error);
    }
}

/**
 * Akƒ±llƒ± puan daƒüƒ±lƒ±mƒ± - 100 puan garantisi
 */
function distributePointsIntelligently(componentCount, totalPoints = 100) {
    if (componentCount <= 0) return [];
    
    // Temel puan daƒüƒ±lƒ±mƒ±
    const basePoints = Math.floor(totalPoints / componentCount);
    const remainder = totalPoints % componentCount;
    
    const points = new Array(componentCount).fill(basePoints);
    
    // Kalan puanlarƒ± daƒüƒ±t
    for (let i = 0; i < remainder; i++) {
        points[i]++;
    }
    
    // Toplam kontrol√º
    const actualTotal = points.reduce((sum, point) => sum + point, 0);
    if (actualTotal !== totalPoints) {
        // Son elemana farkƒ± ekle/√ßƒ±kar
        points[points.length - 1] += (totalPoints - actualTotal);
    }
    
    return points;
}

/**
 * Etkinlik aƒüƒ±rlƒ±klarƒ±nƒ± otomatik oranla
 */
function autoBalanceActivityWeights() {
    const termActivities = getActivitiesByType('term');
    const finalActivities = getActivitiesByType('final');
    
    // Yarƒ±yƒ±l i√ßi aƒüƒ±rlƒ±klarƒ± oranla (40%)
    if (termActivities.length > 0) {
        const termWeights = distributePointsIntelligently(termActivities.length, 40);
        termActivities.forEach((activity, index) => {
            if (activity.weightElement) {
                activity.weightElement.value = termWeights[index];
            }
        });
    }
    
    // Yarƒ±yƒ±l sonu aƒüƒ±rlƒ±klarƒ± oranla (60%)
    if (finalActivities.length > 0) {
        const finalWeights = distributePointsIntelligently(finalActivities.length, 60);
        finalActivities.forEach((activity, index) => {
            if (activity.weightElement) {
                activity.weightElement.value = finalWeights[index];
            }
        });
    }
    
    // Kategori aƒüƒ±rlƒ±klarƒ±nƒ± g√ºncelle
    updateCategoryWeights();
}

/**
 * Modern Test Operations Event Listeners
 */
function initializeModernEventListeners() {
    // Yarƒ±yƒ±l ƒ∞√ßi Deƒüerlendirme Olu≈ütur - Artƒ±k √ßoklu fonksiyon kullanƒ±yor
    const btnTermAssessment = document.getElementById('btnGenerateRandomTermAssessment');
    if (btnTermAssessment) {
        btnTermAssessment.addEventListener('click', function() {
            generateMultipleRandomTermAssessments();
        });
    }
    
    // Yarƒ±yƒ±l Sonu Deƒüerlendirme Olu≈ütur - Artƒ±k √ßoklu fonksiyon kullanƒ±yor
    const btnFinalAssessment = document.getElementById('btnGenerateRandomFinalAssessment');
    if (btnFinalAssessment) {
        btnFinalAssessment.addEventListener('click', function() {
            generateMultipleRandomFinalAssessments();
        });
    }
    
    // Test √ñƒürencileri Olu≈ütur
    const btnTestStudents = document.getElementById('btnGenerateTestStudents');
    if (btnTestStudents) {
        btnTestStudents.addEventListener('click', generateTestStudents);
    }
    
    // Test Ders Verisi Olu≈ütur
    const btnTestCourse = document.getElementById('btnGenerateTestCourseData');
    if (btnTestCourse) {
        btnTestCourse.addEventListener('click', generateTestCourseData);
    }
    
    // Rastgele Gruplar Olu≈ütur
    const btnRandomGroups = document.getElementById('btnGenerateRandomGroups');
    if (btnRandomGroups) {
        btnRandomGroups.addEventListener('click', function() {
            const minGroups = parseInt(document.getElementById('groupMinSlider').value);
            const maxGroups = parseInt(document.getElementById('groupMaxSlider').value);
            generateRandomGroupsInRange(minGroups, maxGroups);
        });
    }
    
    // Akƒ±llƒ± Puanlama Uygula
    const btnSmartScoring = document.getElementById('btnGenerateRandomScores');
    if (btnSmartScoring) {
        btnSmartScoring.addEventListener('click', function() {
            const passRate = parseInt(document.getElementById('passRateSlider').value);
            generateIntelligentScores(passRate);
        });
    }
    
    // Temizleme Butonlarƒ± - DUPLICATE EVENT LISTENER SORUNU √á√ñZ√úLD√ú
    // Bu event listener'lar testButtons forEach d√∂ng√ºs√º ile zaten ekleniyor
    // Bu nedenle buradaki duplicate listener'larƒ± kaldƒ±rƒ±yoruz
    console.log("‚ÑπÔ∏è Temizleme butonlarƒ± event listener'larƒ± testButtons d√∂ng√ºs√º ile y√∂netiliyor");
    
    const btnTestToast = document.getElementById('btnTestToast');
    if (btnTestToast) {
        btnTestToast.addEventListener('click', testToastSystem);
    }
}

/**
 * Rastgele gruplar aralƒ±k i√ßinde olu≈ütur
 */
/**
 * Grup slider'larƒ±nƒ±n maksimum deƒüerlerini √∂ƒürenci sayƒ±sƒ±na g√∂re g√ºncelleme
 */
function updateGroupSliderLimits() {
    const studentCount = APP_STATE.studentData ? APP_STATE.studentData.length : 0;
    const minSlider = document.getElementById('groupMinSlider');
    const maxSlider = document.getElementById('groupMaxSlider');
    
    let maxAllowedGroups;
    
    if (studentCount === 0) {
        // √ñƒürenci yoksa test ama√ßlƒ± 20 grup'a kadar izin ver
        maxAllowedGroups = 20;
        console.log(`üéØ Grup slider'larƒ± test modunda - √ñƒürenci yok, 20 grup'a kadar izin veriliyor`);
    } else {
        // √ñƒürenci varsa √∂ƒürenci sayƒ±sƒ± ile sƒ±nƒ±rla (minimum 20 grup)
        maxAllowedGroups = Math.max(studentCount, 20); // En az 20, √∂ƒürenci sayƒ±sƒ± daha fazlaysa o kadar
        
        if (studentCount < 20) {
            console.log(`üéØ Grup slider'larƒ± g√ºncellendi - √ñƒürenci sayƒ±sƒ±: ${studentCount}, Max grup: ${studentCount} (bo≈ü grup √∂nleme)`);
        } else {
            console.log(`üéØ Grup slider'larƒ± g√ºncellendi - √ñƒürenci sayƒ±sƒ±: ${studentCount}, Max grup: ${maxAllowedGroups}`);
        }
    }
        
        if (minSlider) {
            minSlider.max = maxAllowedGroups;
            // Eƒüer mevcut deƒüer sƒ±nƒ±rƒ± a≈üƒ±yorsa d√º≈ü√ºr
            if (parseInt(minSlider.value) > maxAllowedGroups) {
                minSlider.value = maxAllowedGroups;
                const minValueDisplay = document.getElementById('groupMinValue');
                if (minValueDisplay) minValueDisplay.textContent = maxAllowedGroups;
            }
        }
        
        if (maxSlider) {
            maxSlider.max = maxAllowedGroups;
            // Eƒüer mevcut deƒüer sƒ±nƒ±rƒ± a≈üƒ±yorsa d√º≈ü√ºr
            if (parseInt(maxSlider.value) > maxAllowedGroups) {
                maxSlider.value = maxAllowedGroups;
                const maxValueDisplay = document.getElementById('groupMaxValue');
                if (maxValueDisplay) maxValueDisplay.textContent = maxAllowedGroups;
            }
    }
}

function generateRandomGroupsInRange(minGroups, maxGroups) {
    if (!APP_STATE.studentData || APP_STATE.studentData.length === 0) {
        showModernToast('√ñnce √∂ƒürenci verileri olu≈üturun!', 'warning');
        return;
    }
    
    const studentCount = APP_STATE.studentData.length;
    
    // UYARI: √ñƒürenci sayƒ±sƒ±ndan fazla grup olu≈üturma kontrol√º
    if (minGroups > studentCount) {
        showModernToast(`‚ö†Ô∏è Uyarƒ±: Minimum grup sayƒ±sƒ± (${minGroups}) √∂ƒürenci sayƒ±sƒ±ndan (${studentCount}) fazla! Bo≈ü gruplar olu≈ümasƒ±n diye maksimum ${studentCount} grup olu≈üturulabilir.`, "warning");
        return;
    }
    
    if (maxGroups > studentCount) {
        showModernToast(`‚ö†Ô∏è Uyarƒ±: Maksimum grup sayƒ±sƒ± (${maxGroups}) √∂ƒürenci sayƒ±sƒ±ndan (${studentCount}) fazla! Bo≈ü gruplar olu≈ümasƒ±n diye en fazla ${studentCount} grup olu≈üturulabilir.`, "warning");
        // Maksimum grup sayƒ±sƒ±nƒ± √∂ƒürenci sayƒ±sƒ± ile sƒ±nƒ±rla
        maxGroups = Math.min(maxGroups, studentCount);
    }
    
    const actualGroupCount = Math.floor(Math.random() * (maxGroups - minGroups + 1)) + minGroups;
    generateRandomGroups();
    
    showModernToast(`Rastgele grup olu≈üturma tamamlandƒ±! ${actualGroupCount} grup olu≈üturuldu.`, 'success');
    updateModernStats();
}

/**
 * Akƒ±llƒ± puanlama sistemi
 */
/**
 * Akƒ±llƒ± puanlama sistemi (Onay ile)
 */
function generateIntelligentScores(targetPassRate) {
    // Mevcut verileri kontrol et
    const hasStudents = APP_STATE.studentData && APP_STATE.studentData.length > 0;
    const hasAssessments = APP_STATE.assessmentTree && APP_STATE.assessmentTree.length > 0;
    
    // Mevcut puanlarƒ± daha hassas kontrol et
    let hasExistingScores = false;
    let existingScoreCount = 0;
    
    // gradesData kontrol√º - sadece ger√ßek veri varsa
    if (APP_STATE.gradesData && Object.keys(APP_STATE.gradesData).length > 0) {
        for (const studentId in APP_STATE.gradesData) {
            if (APP_STATE.gradesData[studentId] && Object.keys(APP_STATE.gradesData[studentId]).length > 0) {
                hasExistingScores = true;
                existingScoreCount += Object.keys(APP_STATE.gradesData[studentId]).length;
            }
        }
    }
    
    // testScores kontrol√º
    if (APP_STATE.testScores && Object.keys(APP_STATE.testScores).length > 0) {
        hasExistingScores = true;
        existingScoreCount += Object.keys(APP_STATE.testScores).length;
    }
    
    console.log('üîç hasExistingScores kontrol√º:', {
        hasExistingScores,
        existingScoreCount,
        gradesDataKeys: Object.keys(APP_STATE.gradesData || {}),
        testScoresKeys: Object.keys(APP_STATE.testScores || {})
    });
    
    if (!hasStudents) {
        showModernToast('√ñnce √∂ƒürenci verileri olu≈üturun!', 'warning');
        return;
    }
    
    if (!hasAssessments) {
        showModernToast('√ñnce deƒüerlendirme bile≈üenleri olu≈üturun!', 'warning');
        return;
    }
    
    // targetPassRate parametresi yoksa slider'dan al
    if (targetPassRate === undefined) {
        const passRateSlider = document.getElementById('passRateSlider');
        targetPassRate = passRateSlider ? parseInt(passRateSlider.value) : 70;
    }
    
    const studentCount = APP_STATE.studentData.length;
    const assessmentCount = APP_STATE.assessmentTree.length;
    const passCount = Math.round(studentCount * targetPassRate / 100);
    const failCount = studentCount - passCount;
    
    let warningMessage = '';
    
    if (hasExistingScores) {
        const existingScoreCount = Object.keys(APP_STATE.gradesData || {}).length + Object.keys(APP_STATE.testScores || {}).length;
        warningMessage = `Mevcut not verileri silinecek ve yeniden olu≈üturulacak!\n\n${studentCount} √∂ƒürenci i√ßin ${assessmentCount} deƒüerlendirme bile≈üeninde %${targetPassRate} ge√ßme oranƒ±na g√∂re akƒ±llƒ± puanlama yapƒ±lacak.\n\n‚Ä¢ ${passCount} √∂ƒürenci ge√ßecek\n‚Ä¢ ${failCount} √∂ƒürenci kalacak\n\nMevcut ${existingScoreCount} not verisi kaybolacak. Bu i≈ülem geri alƒ±namaz. Devam etmek istediƒüinizden emin misiniz?`;
    } else {
        warningMessage = `${studentCount} √∂ƒürenci i√ßin ${assessmentCount} deƒüerlendirme bile≈üeninde %${targetPassRate} ge√ßme oranƒ±na g√∂re akƒ±llƒ± puanlama yapƒ±lacak.\n\n‚Ä¢ ${passCount} √∂ƒürenci ge√ßecek\n‚Ä¢ ${failCount} √∂ƒürenci kalacak\n\nBu i≈ülem geri alƒ±namaz. Devam etmek istediƒüinizden emin misiniz?`;
    }
    
    showModernConfirm('üß† Akƒ±llƒ± Puanlama Sistemi Uygula', warningMessage, {
            confirmText: 'Evet, Uygula',
            cancelText: 'ƒ∞ptal',
        confirmClass: 'btn-modern-warning',
        cancelClass: 'btn-modern-secondary'
    }).then((confirmed) => {
        if (confirmed) {
        executeGenerateIntelligentScores(targetPassRate);
        } else {
            console.log('üë§ Kullanƒ±cƒ± akƒ±llƒ± puanlama sistemini iptal etti');
            showModernToast('‚ùå Akƒ±llƒ± puanlama sistemi iptal edildi', 'info', 2000);
        }
    });
}

/**
 * Akƒ±llƒ± puanlama sistemi (Ger√ßek i≈ülem)
 */
function executeGenerateIntelligentScores(targetPassRate) {
    if (!APP_STATE.studentData || APP_STATE.studentData.length === 0) {
        showModernToast('√ñnce √∂ƒürenci verileri olu≈üturun!', 'warning');
        return;
    }
    
    if (!APP_STATE.assessmentTree || APP_STATE.assessmentTree.length === 0) {
        showModernToast('√ñnce deƒüerlendirme bile≈üenleri olu≈üturun!', 'warning');
        return;
    }
    
    // Akƒ±llƒ± puanlama algoritmasƒ±
    const students = APP_STATE.studentData;
    const passCount = Math.round(students.length * targetPassRate / 100);
    
    // Her √∂ƒürenci i√ßin puanlar olu≈ütur
    students.forEach((student, index) => {
        const shouldPass = index < passCount;
        generateStudentScores(student.studentId, shouldPass);
    });
    
    showModernToast(`Hedef %${targetPassRate} ge√ßme oranƒ±yla puanlar olu≈üturuldu!`, 'success');
    updatePassFailCounts();
    
    // G√ºvenli fonksiyon √ßaƒürƒ±sƒ±
    if (typeof updateGradeDisplays === 'function') {
        updateGradeDisplays();
    } else {
        console.log('updateGradeDisplays fonksiyonu hen√ºz tanƒ±mlƒ± deƒüil');
        updateModernStats();
    }
    
    // Deƒüerlendirme g√∂r√ºn√ºm√ºn√º g√ºncelle
    if (typeof updateAssessmentView === 'function') {
        updateAssessmentView();
    }
    
    console.log('üéØ Akƒ±llƒ± puanlama tamamlandƒ± - APP_STATE.gradesData:', APP_STATE.gradesData);
}

/**
 * √ñƒürenci i√ßin akƒ±llƒ± puanlar olu≈ütur
 */
function generateStudentScores(studentId, shouldPass) {
    if (!APP_STATE.gradesData) {
        APP_STATE.gradesData = {};
    }
    
    if (!APP_STATE.gradesData[studentId]) {
        APP_STATE.gradesData[studentId] = {};
    }
    
    const studentGrades = APP_STATE.gradesData[studentId];
    
    // Her deƒüerlendirme bile≈üeni i√ßin puan olu≈ütur
    APP_STATE.assessmentTree.forEach(node => {
        if (node.children && node.children.length > 0) {
            node.children.forEach(child => {
                generateComponentScore(child, studentGrades, shouldPass);
            });
        }
    });
}

/**
 * Bile≈üen i√ßin akƒ±llƒ± puan olu≈ütur
 */
function generateComponentScore(component, studentGrades, shouldPass) {
    const componentId = component.id;
    
    if (component.children && component.children.length > 0) {
        // Alt bile≈üenler varsa onlar i√ßin de puan olu≈ütur
        component.children.forEach(child => {
            generateComponentScore(child, studentGrades, shouldPass);
        });
    } else {
        // Yaprak d√ºƒü√ºm - ger√ßek puan olu≈ütur
        const maxPoints = parseFloat(component.points) || 100;
        let score;
        
        if (shouldPass) {
            // Ge√ßecek √∂ƒürenci: G√ºvenli ge√ßme aralƒ±ƒüƒ± (65-95 arasƒ±)
            // %15 ihtimalle m√ºkemmel (90-95)
            // %35 ihtimalle √ßok iyi (80-90)  
            // %50 ihtimalle iyi (65-80)
            const rand = Math.random();
            if (rand < 0.15) {
                score = Math.random() * 5 + 90; // 90-95 m√ºkemmel
            } else if (rand < 0.50) {
                score = Math.random() * 10 + 80; // 80-90 √ßok iyi
        } else {
                score = Math.random() * 15 + 65; // 65-80 iyi
            }
        } else {
            // Kalacak √∂ƒürenci: G√ºvenli kalma aralƒ±ƒüƒ± (10-60 arasƒ±)
            // %20 ihtimalle √ßok d√º≈ü√ºk (10-30)
            // %40 ihtimalle d√º≈ü√ºk (30-45)
            // %40 ihtimalle orta-d√º≈ü√ºk (45-60)
            const rand = Math.random();
            if (rand < 0.20) {
                score = Math.random() * 20 + 10; // 10-30 √ßok d√º≈ü√ºk
            } else if (rand < 0.60) {
                score = Math.random() * 15 + 30; // 30-45 d√º≈ü√ºk
            } else {
                score = Math.random() * 15 + 45; // 45-60 orta-d√º≈ü√ºk
            }
        }
        
        // Puanƒ± maksimum puana g√∂re √∂l√ßekle
        const actualScore = (score / 100) * maxPoints;
        studentGrades[componentId] = Math.round(actualScore * 100) / 100;
    }
}

// Modern Toast fonksiyonu zaten yukarƒ±da tanƒ±mlƒ±

/**
 * Not g√∂r√ºn√ºmlerini g√ºncelle
 */
// ƒ∞lk updateGradeDisplays fonksiyonu kaldƒ±rƒ±ldƒ± - geli≈ümi≈ü versiyon korundu

/**
 * √ñƒürenci g√∂r√ºn√ºmlerini g√ºncelle
 */
function updateStudentDisplays() {
    // √ñƒürenci tablosunu g√ºncelle
    if (typeof updateStudentTable === 'function') {
        updateStudentTable();
    }
    
    // updateStudentSelector fonksiyonu kaldƒ±rƒ±ldƒ± (√ñƒürenci Bazlƒ± Not Giri≈üi sekmesi ile birlikte)
    
    console.log('√ñƒürenci g√∂r√ºn√ºmleri g√ºncellendi');
}

/**
 * Grup g√∂r√ºn√ºmlerini g√ºncelle
 */
function updateGroupDisplays() {
    // Grup bilgilerini g√ºncelle
    if (typeof updateGroupInfo === 'function') {
        updateGroupInfo();
    }
    
    // Grup istatistiklerini g√ºncelle
    if (typeof updateGroupStatistics === 'function') {
        updateGroupStatistics();
    }
    
    console.log('Grup g√∂r√ºn√ºmleri g√ºncellendi');
}

/**
 * T√ºm deƒüerlendirmeleri temizle
 */
function clearAllAssessments() {
    showModernConfirm('üóëÔ∏è T√ºm Deƒüerlendirmeleri Sil', 'T√ºm deƒüerlendirme bile≈üenlerini silmek istediƒüinizden emin misiniz? Bu i≈ülem geri alƒ±namaz!', {
        confirmText: 'Evet, Sil',
        cancelText: 'ƒ∞ptal',
        confirmClass: 'btn-modern-danger',
        cancelClass: 'btn-modern-secondary'
    }).then(() => {
            APP_STATE.assessmentTree = [];
            renderTree();
            updateCategoryWeights();
            updatePassFailCounts();
            showModernToast('üóëÔ∏è T√ºm deƒüerlendirmeler temizlendi!', 'success');
    });
}

/**
 * T√ºm gruplarƒ± temizle
 */
function clearAllGroups() {
    showModernConfirm('üë• T√ºm Gruplarƒ± Sil', 'T√ºm grup atamalarƒ±nƒ± silmek istediƒüinizden emin misiniz?\n\n‚Ä¢ T√ºm √∂ƒürenci grup atamalarƒ± silinecek\n‚Ä¢ Grup haritalama verileri silinecek\n‚Ä¢ Deƒüerlendirme yapƒ±sƒ± korunacak\n\nBu i≈ülem geri alƒ±namaz!', {
        confirmText: 'Evet, Sil',
        cancelText: 'ƒ∞ptal',
        confirmClass: 'btn-modern-danger',
        cancelClass: 'btn-modern-secondary'
    }).then(() => {
            performClearGroups();
    });
}

/**
 * T√ºm puanlarƒ± temizle
 */
function clearAllScores() {
    showModernConfirm('üìä T√ºm Puanlarƒ± Sil', 'T√ºm √∂ƒürenci puanlarƒ±nƒ± silmek istediƒüinizden emin misiniz?\n\n‚Ä¢ T√ºm not giri≈üleri silinecek\n‚Ä¢ Deƒüerlendirme yapƒ±sƒ± korunacak\n‚Ä¢ Grup atamalarƒ± korunacak\n\nBu i≈ülem geri alƒ±namaz!', {
        confirmText: 'Evet, Sil',
        cancelText: 'ƒ∞ptal',
        confirmClass: 'btn-modern-danger',
        cancelClass: 'btn-modern-secondary'
    }).then(() => {
            performClearScores();
    });
}

/**
 * T√ºm √∂ƒürencileri temizle
 */
function clearAllStudents() {
    // √ñnce silinecek √∂ƒürenci var mƒ± kontrol et
    const hasStudents = (APP_STATE.studentData && APP_STATE.studentData.length > 0) || 
                       (APP_STATE.students && APP_STATE.students.length > 0);
    
    if (!hasStudents) {
        showModernToast("‚ÑπÔ∏è Silinecek √∂ƒürenci bulunmuyor.", "info");
        return;
    }
    
    showModernConfirm('üéì T√ºm √ñƒürencileri Sil', 'T√ºm √∂ƒürenci verilerini silmek istediƒüinizden emin misiniz?\n\n‚Ä¢ √ñƒürenci listesi silinecek\n‚Ä¢ T√ºm notlar silinecek\n‚Ä¢ Grup atamalarƒ± silinecek\n‚Ä¢ Deƒüerlendirme yapƒ±sƒ± korunacak\n\nBu i≈ülem geri alƒ±namaz!', {
        confirmText: 'Evet, Sil',
        cancelText: 'ƒ∞ptal',
        confirmClass: 'btn-modern-danger',
        cancelClass: 'btn-modern-secondary'
    }).then((confirmed) => {
        if (confirmed) {
            performClearStudentsOnly();
        } else {
            console.log('üë§ Kullanƒ±cƒ± √∂ƒürencileri silmeyi iptal etti');
            showModernToast('‚ùå √ñƒürencileri silme iptal edildi', 'info', 2000);
        }
    });
}

/**
 * Sistemi tamamen resetle
 */
function resetCompleteSystem() {
    console.log("üîß resetCompleteSystem ba≈ülatƒ±ldƒ±");
    
    // Sistemi resetlemek i√ßin en azƒ±ndan bir veri var mƒ± kontrol et
    const hasAnyData = (APP_STATE.studentData && APP_STATE.studentData.length > 0) ||
                      (APP_STATE.students && APP_STATE.students.length > 0) ||
                      (APP_STATE.assessmentTree && APP_STATE.assessmentTree.length > 0) ||
                      (APP_STATE.courseData && Object.keys(APP_STATE.courseData).length > 0) ||
                      (APP_STATE.gradesData && Object.keys(APP_STATE.gradesData).length > 0) ||
                      (APP_STATE.testScores && Object.keys(APP_STATE.testScores).length > 0);
    
    if (!hasAnyData) {
        showModernToast("‚ÑπÔ∏è Sistem zaten bo≈ü durumda, resetleme gerekmiyor.", "info");
        return;
    }
    
    showModernConfirm('üîÑ Sistemi Tamamen Resetle', 'Sistemi tamamen sƒ±fƒ±rlamak istediƒüinizden emin misiniz?\n\n‚Ä¢ Ders bilgileri silinecek\n‚Ä¢ T√ºm √∂ƒürenciler silinecek\n‚Ä¢ T√ºm deƒüerlendirmeler silinecek\n‚Ä¢ T√ºm notlar silinecek\n‚Ä¢ T√ºm gruplar silinecek\n\nBu i≈ülem geri alƒ±namaz ve sistem ba≈ülangƒ±√ß durumuna d√∂necek!', {
        confirmText: 'Evet, Resetle',
        cancelText: 'ƒ∞ptal',
        confirmClass: 'btn-modern-danger',
        cancelClass: 'btn-modern-secondary'
    }).then((confirmed) => {
        if (confirmed) {
            console.log("‚úÖ resetCompleteSystem onaylandƒ±, resetleme ba≈ülƒ±yor...");
            performResetSystem();
        } else {
            console.log('üë§ Kullanƒ±cƒ± sistemi resetlemeyi iptal etti');
            showModernToast('‚ùå Sistem resetleme iptal edildi', 'info', 2000);
        }
    });
}

/**
 * Toast sistemini test et
 */
function testToastSystem() {
    showModernConfirm('üß™ Toast Sistemini Test Et', 'Toast bildirim sistemini test etmek ister misiniz?\n\nFarklƒ± t√ºrlerde toast mesajlarƒ± g√∂sterilecek.', {
        confirmText: 'Evet, Test Et',
        cancelText: 'ƒ∞ptal',
        confirmClass: 'btn-modern-primary',
        cancelClass: 'btn-modern-secondary'
    }).then((confirmed) => {
        if (confirmed) {
            performToastSystemTest();
        } else {
            console.log('üë§ Kullanƒ±cƒ± toast testini iptal etti');
            showModernToast('‚ùå Toast testi iptal edildi', 'info', 2000);
        }
    });
}

/**
 * Toast sistem testini ger√ßekle≈ütir
 */
function performToastSystemTest() {
    let delay = 0;
    
    // Ba≈üarƒ± toast'ƒ±
    setTimeout(() => {
        showModernToast('‚úÖ Ba≈üarƒ±lƒ± i≈ülem testi!', 'success');
    }, delay);
    delay += 1500;
    
    // Uyarƒ± toast'ƒ±
    setTimeout(() => {
        showModernToast('‚ö†Ô∏è Uyarƒ± mesajƒ± testi!', 'warning');
    }, delay);
    delay += 1500;
    
    // Hata toast'ƒ±
    setTimeout(() => {
        showModernToast('‚ùå Hata mesajƒ± testi!', 'error');
    }, delay);
    delay += 1500;
    
    // Bilgi toast'ƒ±
    setTimeout(() => {
        showModernToast('‚ÑπÔ∏è Bilgi mesajƒ± testi!', 'info');
    }, delay);
    delay += 1500;
    
    // Test tamamlandƒ±
    setTimeout(() => {
        showModernToast('üéâ Toast sistem testi tamamlandƒ±!', 'success');
    }, delay);
}

/**
 * Sistem resetleme i≈ülemini ger√ßekle≈ütir
 */
function performResetSystem() {
    try {
        console.log("üîß performResetSystem ba≈ülatƒ±ldƒ±");
        
        // 1. T√ºm APP_STATE verilerini koordineli ≈üekilde sƒ±fƒ±rla
        APP_STATE.courseData = null;
        APP_STATE.students = [];
        APP_STATE.assessmentTree = [];
        APP_STATE.studentGrades = {};
        APP_STATE.groupMapping = {};
        APP_STATE.learningOutcomes = [];
        APP_STATE.programOutcomes = [];
        APP_STATE.outcomeMatrix = null;
        APP_STATE.selectedNode = null;
        APP_STATE.selectedStudentId = null;
        
        // 2. Eski format desteƒüi i√ßin
        APP_STATE.studentData = [];
        APP_STATE.gradesData = {};
        APP_STATE.testScores = {};
        APP_STATE.gruplar = [];
        
        // 3. Ders bilgilerini sƒ±fƒ±rla
        const courseTitle = document.getElementById('courseTitle');
        const courseDetails = document.getElementById('courseDetails');
        const courseTerm = document.getElementById('courseTerm');
        
        if (courseTitle) courseTitle.textContent = 'Ders Bilgileri';
        if (courseDetails) courseDetails.textContent = 'JSON dosyasƒ± y√ºkleyiniz';
        if (courseTerm) courseTerm.textContent = '';
        
        // 4. UI'larƒ± g√ºvenli ≈üekilde g√ºncelle
        renderTree();
        updateStudentTable();
        updateAssessmentView();
        
        // 5. Not tablosunu g√ºvenli ≈üekilde temizle
        try {
            updateGradesTable([]);
        } catch (tableError) {
            console.warn("‚ö†Ô∏è Not tablosu g√ºncellenirken hata (g√∂rmezden gelindi):", tableError);
            const gradesTable = document.getElementById('gradesTable');
            if (gradesTable) {
                const tbody = gradesTable.querySelector('tbody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="8" class="empty-message">Not giri≈üi yapƒ±lmadƒ±</td></tr>';
                }
            }
        }
        
        updateCategoryWeights();
        
        // 6. Eski format fonksiyonlarƒ± varsa g√ºvenli ≈üekilde √ßaƒüƒ±r
        if (typeof updateStudentDisplays === 'function') {
            updateStudentDisplays();
        }
        if (typeof updateGroupDisplays === 'function') {
            updateGroupDisplays();
        }
        if (typeof updateModernStats === 'function') {
            updateModernStats();
        }
        if (typeof updatePassFailCounts === 'function') {
            updatePassFailCounts();
        }
        if (typeof updateGroupSelectors === 'function') {
            updateGroupSelectors();
        }
        if (typeof updateTreeMappingControls === 'function') {
            updateTreeMappingControls();
        }
        
        // 7. T√ºm containers'ƒ± temizle
        const containers = [
            'studentGradesContainer',
            'assessmentContainer',
            'gradesTableContainer',
            'courseDetailsContainer',
            'outcomesList',
            'programOutcomesList',
            'matrixContainer'
        ];
        
        containers.forEach(containerId => {
            const container = document.getElementById(containerId);
            if (container) {
                if (containerId === 'courseDetailsContainer') {
                    container.innerHTML = '<div class="details-empty-message">Ders detaylarƒ± i√ßin JSON y√ºkleyin.</div>';
                } else if (containerId === 'outcomesList') {
                    container.innerHTML = '<div class="outcomes-empty-message">Hen√ºz √∂ƒürenme √ßƒ±ktƒ±sƒ± tanƒ±mlanmadƒ±. Ders JSON y√ºkleyin.</div>';
                } else if (containerId === 'programOutcomesList') {
                    container.innerHTML = '<div class="outcomes-empty-message">Hen√ºz program √ßƒ±ktƒ±sƒ± tanƒ±mlanmadƒ±. Ders JSON y√ºkleyin.</div>';
                } else if (containerId === 'matrixContainer') {
                    container.innerHTML = '<div class="matrix-empty-message">√ñ√á-P√á ili≈üki matrisi i√ßin ders JSON y√ºkleyin.</div>';
                } else {
                    container.innerHTML = '<p class="empty-message">Veri bulunamadƒ±.</p>';
                }
            }
        });
        
        // 8. Tree container'ƒ± √∂zel mesajla
        const treeContainer = document.getElementById('treeContainer');
        if (treeContainer) {
            treeContainer.innerHTML = '<div class="tree-empty-message">Hen√ºz deƒüerlendirme bile≈üeni eklenmedi. Ders JSON y√ºkleyin veya yeni bile≈üenler ekleyin.</div>';
        }
        
        showModernToast("üîÑ Sistem tamamen ve koordineli ≈üekilde sƒ±fƒ±rlandƒ±!", "success", 4000);
        
    } catch (error) {
        console.error("‚ùå Sistem resetlenirken hata:", error);
        showModernToast("‚ùå Sistem resetlenirken hata olu≈ütu!", "error");
    }
}

/**
 * Grup temizleme i≈ülemini ger√ßekle≈ütir - A grubunu koruyarak
 */
function performClearGroups() {
    try {
        console.log("üîß performClearGroups (eski format) ba≈ülatƒ±ldƒ± - A grubu korunacak");
        
        // A grubu hari√ß t√ºm grup haritalamalarƒ±nƒ± temizle ve A grubunu yeniden d√ºzenle
        if (APP_STATE.courseData && APP_STATE.courseData.grupHaritalari) {
            const assessmentComponents = Object.keys(APP_STATE.courseData.grupHaritalari);
            
            // Her deƒüerlendirme bile≈üeni i√ßin A grubunu koru, diƒüerlerini sil
            assessmentComponents.forEach(componentId => {
                // A grubunu koru, diƒüer gruplarƒ± sil
                APP_STATE.courseData.grupHaritalari[componentId] = {
                    gruplar: ['A'],
                    haritalar: {
                        'A': {}
                    }
                };
                
                // A grubu i√ßin sorularƒ± 1'den ba≈ülayarak sƒ±ralƒ± ata
                const component = APP_STATE.assessmentTree.find(item => item.id === componentId);
                if (component && component.children) {
                    const aGroupMapping = {};
                    let questionIndex = 1;
                    
                    // √áocuk √∂ƒüeleri (sorular/rubrikler) i√ßin sƒ±ralƒ± numara ata
                    // D√úZELTME: Veri yapƒ±sƒ± {position: questionId} formatƒ±nda olmalƒ±
                    component.children.forEach(child => {
                        aGroupMapping[questionIndex.toString()] = child.id;
                        questionIndex++;
                    });
                    
                    APP_STATE.courseData.grupHaritalari[componentId].haritalar['A'] = aGroupMapping;
                    
                    console.log(`üìù ${componentId} bile≈üeni A grubu: ${Object.keys(aGroupMapping).length} soru sƒ±ralƒ± hale getirildi`);
                }
            });
        }
        
        APP_STATE.groupMapping = {};
        
        // √ñƒürencilerin gruplarƒ±nƒ± varsayƒ±lan gruba ata
        if (APP_STATE.students) {
            APP_STATE.students.forEach(student => {
                student.grup = 'A';
            });
        }
        if (APP_STATE.studentData) {
            APP_STATE.studentData.forEach(student => {
                student.grup = 'A';
            });
        }
        
        // Eski format desteƒüi
        APP_STATE.gruplar = [];
        
        // UI'larƒ± g√ºncelle
        if (typeof updateGroupSelectors === 'function') {
            updateGroupSelectors();
        }
        updateStudentTable();
        if (typeof updateTreeMappingControls === 'function') {
            updateTreeMappingControls();
        }
        if (typeof updateAllInlineGroupInputs === 'function') {
            updateAllInlineGroupInputs();
        }
        if (typeof updateAllMappingDisplays === 'function') {
            updateAllMappingDisplays();
        }
        updateAssessmentView();
        
        // Eski format fonksiyonlarƒ± varsa √ßaƒüƒ±r
        if (typeof updateGroupDisplays === 'function') {
            updateGroupDisplays();
        }
        if (typeof updateModernStats === 'function') {
            updateModernStats();
        }
        if (typeof updatePassFailCounts === 'function') {
            updatePassFailCounts();
        }
        
        showModernToast("‚úÖ A grubu korundu, diƒüer gruplar temizlendi! A grubundaki sorular 1'den ba≈ülayarak sƒ±ralƒ± hale getirildi.", "success");
        
    } catch (error) {
        console.error("Gruplar temizlenirken hata:", error);
        showModernToast("‚ùå Gruplar temizlenemedi!", "error");
    }
}

/**
 * Puan temizleme i≈ülemini ger√ßekle≈ütir - Eski format desteƒüi
 */
function performClearScores() {
    try {
        console.log("üîß performClearScores (eski format) ba≈ülatƒ±ldƒ± - Puanlar sƒ±fƒ±rlanacak");
        
        // Puanlarƒ± sƒ±fƒ±rla (silmek yerine 0 yap)
        if (APP_STATE.studentData && APP_STATE.studentData.length > 0) {
            APP_STATE.studentData.forEach(student => {
                const studentId = student.ogrenciNo || student.id;
                
                // Her √∂ƒürenci i√ßin mevcut puanlarƒ± sƒ±fƒ±rla
                if (APP_STATE.gradesData[studentId]) {
                    Object.keys(APP_STATE.gradesData[studentId]).forEach(assessmentId => {
                        if (typeof APP_STATE.gradesData[studentId][assessmentId] === 'object') {
                            // Alt sorular i√ßin her birini sƒ±fƒ±rla
                            Object.keys(APP_STATE.gradesData[studentId][assessmentId]).forEach(subId => {
                                APP_STATE.gradesData[studentId][assessmentId][subId] = 0;
                            });
                        } else {
                            // Direkt puan ise sƒ±fƒ±rla
                            APP_STATE.gradesData[studentId][assessmentId] = 0;
                        }
                    });
                }
                
                // Test skorlarƒ±nƒ± da sƒ±fƒ±rla
                if (APP_STATE.testScores && APP_STATE.testScores[studentId]) {
                    Object.keys(APP_STATE.testScores[studentId]).forEach(testId => {
                        if (typeof APP_STATE.testScores[studentId][testId] === 'object') {
                            // Test detaylarƒ± i√ßin
                            if (APP_STATE.testScores[studentId][testId].correct !== undefined) {
                                APP_STATE.testScores[studentId][testId].correct = 0;
                                APP_STATE.testScores[studentId][testId].wrong = 0;
                                APP_STATE.testScores[studentId][testId].empty = APP_STATE.testScores[studentId][testId].total || 0;
                                APP_STATE.testScores[studentId][testId].score = 0;
                            }
                        } else {
                            APP_STATE.testScores[studentId][testId] = 0;
                        }
                    });
                }
            });
            
            console.log("‚úÖ Mevcut puanlar sƒ±fƒ±rlandƒ±");
        } else {
            // √ñƒürenci yoksa bo≈ü objeler olu≈ütur
        APP_STATE.studentGrades = {};
        APP_STATE.gradesData = {};
        if (typeof APP_STATE.testScores !== 'undefined') {
            APP_STATE.testScores = {};
            }
            console.log("‚ÑπÔ∏è √ñƒürenci bulunamadƒ±, puanlar temizlendi");
        }
        
        // UI'larƒ± g√ºncelle
        console.log("üîÑ UI g√ºncellemeleri ba≈ülatƒ±lƒ±yor (eski format)...");
        
        updateAssessmentView();
        updateGradesTable();
        
        // Deƒüerlendirme tablosunu manuel olarak yeniden olu≈ütur
        setTimeout(() => {
            console.log("üîÑ Deƒüerlendirme tablosu yeniden olu≈üturuluyor (eski format)...");
            
            // Deƒüerlendirme container'ƒ±nƒ± tamamen temizle ve yeniden olu≈ütur
            const assessmentContainer = document.getElementById('assessmentContainer');
            if (assessmentContainer) {
                console.log("üóëÔ∏è Deƒüerlendirme container'ƒ± temizleniyor (eski format)...");
                assessmentContainer.innerHTML = '<p class="empty-message">Deƒüerlendirme tablosu yeniden olu≈üturuluyor...</p>';
            }
            
            // Deƒüerlendirme giri≈üi sekmesini zorla g√ºncelle
            updateAssessmentView();
            
            // √ñƒürenci filtresini de g√ºncelle
            const assessmentStudentFilter = document.getElementById('assessmentStudentFilter');
            if (assessmentStudentFilter) {
                const currentValue = assessmentStudentFilter.value;
                // Filtreyi tetikle
                assessmentStudentFilter.dispatchEvent(new Event('change'));
            }
        }, 100);
        
        // SADECE √ñƒûRENCI PUANLARINI ITERATIF OLARAK SIFIRLA (ESKƒ∞ FORMAT)
        setTimeout(() => {
            console.log("üîÑ √ñƒürenci puanlarƒ± iteratif olarak sƒ±fƒ±rlanƒ±yor (eski format)...");
            
            // Her √∂ƒürenci i√ßin t√ºm puanlarƒ± sƒ±fƒ±rla (veri modelinde)
            if (APP_STATE.studentData && APP_STATE.studentData.length > 0) {
                APP_STATE.studentData.forEach((student, studentIndex) => {
                    const studentId = student.ogrenciNo || student.id;
                    console.log(`üìù ${studentIndex + 1}. √∂ƒürenci (${studentId}) puanlarƒ± sƒ±fƒ±rlanƒ±yor (eski format)...`);
                    
                    // √ñƒürencinin t√ºm deƒüerlendirme puanlarƒ±nƒ± sƒ±fƒ±rla
                    if (APP_STATE.gradesData[studentId]) {
                        Object.keys(APP_STATE.gradesData[studentId]).forEach(assessmentId => {
                            const oldValue = APP_STATE.gradesData[studentId][assessmentId];
                            APP_STATE.gradesData[studentId][assessmentId] = 0;
                            console.log(`  ‚úÖ ${assessmentId}: ${oldValue} ‚Üí 0 (eski format)`);
                        });
                    }
                    
                    // Eski format i√ßin studentGrades da sƒ±fƒ±rla
                    if (APP_STATE.studentGrades && APP_STATE.studentGrades[studentId]) {
                        Object.keys(APP_STATE.studentGrades[studentId]).forEach(assessmentId => {
                            const oldValue = APP_STATE.studentGrades[studentId][assessmentId];
                            APP_STATE.studentGrades[studentId][assessmentId] = 0;
                            console.log(`  ‚úÖ Eski Format ${assessmentId}: ${oldValue} ‚Üí 0`);
                        });
                    }
                    
                    // √ñƒürencinin test skorlarƒ±nƒ± da sƒ±fƒ±rla
                    if (APP_STATE.testScores && APP_STATE.testScores[studentId]) {
                        Object.keys(APP_STATE.testScores[studentId]).forEach(testId => {
                            const oldValue = APP_STATE.testScores[studentId][testId];
                            APP_STATE.testScores[studentId][testId] = 0;
                            console.log(`  ‚úÖ Test ${testId}: ${oldValue} ‚Üí 0 (eski format)`);
                        });
                    }
                });
                
                console.log(`‚úÖ ${APP_STATE.studentData.length} √∂ƒürencinin puanlarƒ± ba≈üarƒ±yla sƒ±fƒ±rlandƒ± (eski format)`);
            } else {
                console.log("‚ÑπÔ∏è √ñƒürenci bulunamadƒ±, sadece veri yapƒ±larƒ± temizlendi (eski format)");
            }
            
        }, 300);
        
        // 5. G√ú√áL√ú GUI G√úNCELLEMESƒ∞ - √áoklu zamanlƒ± g√ºncelleme (ESKƒ∞ FORMAT)
        setTimeout(() => {
            console.log("üîÑ Final g√ºncelleme - deƒüerlendirme tablosu g√º√ßl√º g√ºncelleme ba≈ülatƒ±lƒ±yor (eski format)...");
            
            // √áoklu g√ºncelleme dalgasƒ±
            updateAssessmentView();
            
            // Container'ƒ± temizle ve yeniden olu≈ütur
            const assessmentContainer = document.getElementById('assessmentContainer');
            if (assessmentContainer) {
                console.log("üóëÔ∏è Assessment container temizleniyor ve yeniden olu≈üturuluyor (eski format)...");
                assessmentContainer.innerHTML = '<p class="empty-message">Deƒüerlendirme tablosu g√ºncelleniyor...</p>';
                
                // Hemen ardƒ±ndan yeniden olu≈ütur
                setTimeout(() => {
                    updateAssessmentView();
                }, 50);
            }
            
            // T√ºm input'lara 0 deƒüerini zorla uygula
            setTimeout(() => {
                const allInputs = document.querySelectorAll('#assessmentContainer input[type="number"]');
                allInputs.forEach((input, index) => {
                    // Sadece √∂ƒürenci puan input'larƒ±nƒ± g√ºncelle (readonly veya disabled olmayanlarƒ±)
                    if (!input.readOnly && !input.disabled) {
                        const inputId = input.id || '';
                        const inputName = input.name || '';
                        
                        // Maksimum puan input'larƒ±nƒ± atla
                        if (!inputId.includes('max') && !inputId.includes('total') && 
                            !inputId.includes('limit') && !inputId.includes('point') &&
                            !inputName.includes('max') && !inputName.includes('total') && 
                            !inputName.includes('limit') && !inputName.includes('point')) {
                            
                            input.value = '0';
                            input.dispatchEvent(new Event('input', { bubbles: true }));
                            console.log(`üîÑ Input ${index + 1} g√ºncellendi (eski format): ${inputId || inputName} ‚Üí 0`);
                        }
                    }
                });
            }, 100);
            
        }, 500);
        
        // 6. NOTLARI VE HESAPLAMALARI YENƒ∞DEN HESAPLA (ESKƒ∞ FORMAT - SEKME DEƒûƒ∞≈ûTƒ∞RMEDEN)
        setTimeout(() => {
            console.log("üßÆ Puanlar sƒ±fƒ±rlandƒ±ktan sonra t√ºm hesaplamalar yeniden yapƒ±lƒ±yor (eski format - sekme korunacak)...");
            
            // Mevcut aktif sekmeyi kaydet
            const currentActiveTab = document.querySelector('.nav-tab.active');
            const currentActiveContent = document.querySelector('.nav-content.active');
            console.log("üíæ Mevcut aktif sekme kaydedildi (eski format):", currentActiveTab?.getAttribute('data-tab'));
            
            // Not hesaplama fonksiyonunu sekme korumalƒ± √ßaƒüƒ±r (eski format)
            if (typeof calculateGrades === 'function') {
                console.log("üßÆ calculateGrades √ßaƒürƒ±lƒ±yor (eski format - sekme korumalƒ±)...");
                
                // Sekme ge√ßi≈üini engelleyen kapsamlƒ± wrapper fonksiyon (eski format)
                const originalShowTab = window.showTab;
                const originalSwitchTab = window.switchTab;
                const originalActivateTab = window.activateTab;
                const originalShowGradesTab = window.showGradesTab;
                const originalSwitchToGrades = window.switchToGrades;
                const originalActivateGradesTab = window.activateGradesTab;
                
                // T√ºm sekme fonksiyonlarƒ±nƒ± ge√ßici olarak devre dƒ±≈üƒ± bƒ±rak (eski format)
                window.showTab = function() { console.log("üö´ showTab engellendi (eski format)"); };
                window.switchTab = function() { console.log("üö´ switchTab engellendi (eski format)"); };
                window.activateTab = function() { console.log("üö´ activateTab engellendi (eski format)"); };
                window.showGradesTab = function() { console.log("üö´ showGradesTab engellendi (eski format)"); };
                window.switchToGrades = function() { console.log("üö´ switchToGrades engellendi (eski format)"); };
                window.activateGradesTab = function() { console.log("üö´ activateGradesTab engellendi (eski format)"); };
                
                // Click event'lerini de ge√ßici olarak engelle (eski format)
                const tabElements = document.querySelectorAll('.nav-tab');
                const originalClickHandlers = [];
                tabElements.forEach((tab, index) => {
                    originalClickHandlers[index] = tab.onclick;
                    tab.onclick = function(e) { 
                        e.preventDefault(); 
                        e.stopPropagation(); 
                        console.log("üö´ Tab click engellendi (eski format):", tab.getAttribute('data-tab')); 
                        return false;
                    };
                });
                
                try {
                    // Hesaplama yap
                    calculateGrades();
                    console.log("‚úÖ Notlar ba≈üarƒ±yla yeniden hesaplandƒ± (eski format - sekme korumalƒ±)");
                } catch (error) {
                    console.error("‚ùå calculateGrades hatasƒ± (eski format):", error);
                } finally {
                    // T√ºm sekme fonksiyonlarƒ±nƒ± geri y√ºkle (eski format)
                    if (originalShowTab) window.showTab = originalShowTab;
                    if (originalSwitchTab) window.switchTab = originalSwitchTab;
                    if (originalActivateTab) window.activateTab = originalActivateTab;
                    if (originalShowGradesTab) window.showGradesTab = originalShowGradesTab;
                    if (originalSwitchToGrades) window.switchToGrades = originalSwitchToGrades;
                    if (originalActivateGradesTab) window.activateGradesTab = originalActivateGradesTab;
                    
                    // Click handler'larƒ± geri y√ºkle (eski format)
                    tabElements.forEach((tab, index) => {
                        tab.onclick = originalClickHandlers[index];
                    });
                    
                    console.log("üîÑ T√ºm sekme fonksiyonlarƒ± ve event handler'lar geri y√ºklendi (eski format)");
                }
                
                // Hesaplama sonrasƒ± sekmeyi zorla geri d√∂nd√ºr
                if (currentActiveTab && currentActiveContent) {
                    // T√ºm sekmeleri pasif yap
                    document.querySelectorAll('.nav-tab').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    document.querySelectorAll('.nav-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // Orijinal sekmeyi geri getir
                    currentActiveTab.classList.add('active');
                    currentActiveContent.classList.add('active');
                    console.log("üîÑ Orijinal sekme zorla geri getirildi (eski format)");
                }
            } else {
                console.log("‚ö†Ô∏è calculateGrades fonksiyonu bulunamadƒ± (eski format)");
            }
            
            // Deƒüerlendirme tablosundaki hesaplamalarƒ± da yenile
            if (typeof updateAssessmentCalculations === 'function') {
                updateAssessmentCalculations();
                console.log("‚úÖ Deƒüerlendirme hesaplamalarƒ± g√ºncellendi (eski format)");
            }
            
            // T√ºm input hesaplamalarƒ±nƒ± zorla yenile
            const assessmentContainer = document.getElementById('assessmentContainer');
            if (assessmentContainer) {
                const allInputs = assessmentContainer.querySelectorAll('input[type="number"]');
                allInputs.forEach(input => {
                    // Input event'lerini tetikle
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                    input.dispatchEvent(new Event('change', { bubbles: true }));
                });
                console.log(`‚úÖ ${allInputs.length} input hesaplamasƒ± tetiklendi (eski format)`);
            }
            
            // Notlar sekmesini g√ºncelle (ama sekme deƒüi≈ütirme)
            updateGradesTable();
            
            // Tekrar sekmeyi kontrol et ve d√ºzelt
            setTimeout(() => {
                if (currentActiveTab && currentActiveContent) {
                    // T√ºm sekmeleri pasif yap
                    document.querySelectorAll('.nav-tab').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    document.querySelectorAll('.nav-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // Orijinal sekmeyi geri getir
                    currentActiveTab.classList.add('active');
                    currentActiveContent.classList.add('active');
                    console.log("üîÑ Sekme tekrar d√ºzeltildi (eski format)");
                }
            }, 50);
            
            // ƒ∞statistikleri g√ºncelle
            if (typeof updateModernStats === 'function') {
                updateModernStats();
            }
            if (typeof updatePassFailCounts === 'function') {
                updatePassFailCounts();
            }
            
            // Deƒüerlendirme giri≈üini bir kez daha g√ºncelle
            setTimeout(() => {
                updateAssessmentView();
                console.log("üîÑ Deƒüerlendirme giri≈üi son kez g√ºncellendi (eski format)");
                
                // T√ºm satƒ±rlardaki hesaplama fonksiyonlarƒ±nƒ± zorla tetikle
                setTimeout(() => {
                    const assessmentRows = document.querySelectorAll('#assessmentContainer tr');
                    assessmentRows.forEach((row, index) => {
                        // Her satƒ±rdaki input'larƒ± bul ve hesaplama event'lerini tetikle
                        const inputs = row.querySelectorAll('input[type="number"]');
                        inputs.forEach(input => {
                            if (!input.readOnly && !input.disabled) {
                                // Hesaplama fonksiyonlarƒ±nƒ± tetikle
                                input.dispatchEvent(new Event('blur', { bubbles: true }));
                                input.dispatchEvent(new Event('focusout', { bubbles: true }));
                            }
                        });
                    });
                    console.log(`üîÑ ${assessmentRows.length} satƒ±r hesaplamasƒ± tetiklendi (eski format)`);
                }, 50);
                
            }, 100);
            
        }, 700);

        // 7. ZORLA DERS TANIMLAMA SEKMESƒ∞NDE KAL (ESKƒ∞ FORMAT)
        setTimeout(() => {
            console.log("üìç ZORLA Ders Tanƒ±mlama sekmesinde tutuluyor (eski format)...");
            
            // Ders Tanƒ±mlama sekmesini zorla aktif yap
            const definitionTab = document.querySelector('[data-tab="definition"]');
            const definitionContent = document.getElementById('definition-content');
            
            if (definitionTab && definitionContent) {
                // T√ºm sekmeleri pasif yap
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelectorAll('.nav-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // Ders Tanƒ±mlama sekmesini zorla aktif yap
                definitionTab.classList.add('active');
                definitionContent.classList.add('active');
                
                console.log("‚úÖ ZORLA Ders Tanƒ±mlama sekmesi aktif edildi (eski format)");
                
                // Bir kez daha kontrol et ve zorla d√ºzelt
                setTimeout(() => {
                    if (!definitionTab.classList.contains('active')) {
                        // T√ºm sekmeleri pasif yap
                        document.querySelectorAll('.nav-tab').forEach(tab => {
                            tab.classList.remove('active');
                        });
                        document.querySelectorAll('.nav-content').forEach(content => {
                            content.classList.remove('active');
                        });
                        
                        // Ders Tanƒ±mlama sekmesini tekrar zorla aktif yap
                        definitionTab.classList.add('active');
                        definitionContent.classList.add('active');
                        console.log("üîÑ Ders Tanƒ±mlama sekmesi TEKRAR zorla aktif edildi (eski format)");
                    }
                }, 100);
                
                // 900ms sonra son kontrol ve Notlar sekmesi kapama (eski format)
                setTimeout(() => {
                    const gradesTab = document.querySelector('.nav-tab[data-tab="grades"]');
                    const gradesContent = document.querySelector('#grades-content');
                    
                    // Eƒüer hala Notlar sekmesi aktifse zorla d√ºzelt
                    if (gradesTab?.classList.contains('active') || gradesContent?.classList.contains('active')) {
                        console.log("‚ö†Ô∏è 900ms sonra Notlar sekmesi hala aktif! Zorla d√ºzeltiliyor... (eski format)");
                        
                        // Notlar sekmesini kapat
                        gradesTab?.classList.remove('active');
                        gradesContent?.classList.remove('active');
                        
                        // Ders Tanƒ±mlama sekmesini a√ß
                        definitionTab?.classList.add('active');
                        definitionContent?.classList.add('active');
                        
                        console.log("üîß Sekme zorla d√ºzeltildi (900ms - eski format)");
                    } else {
                        console.log("‚úÖ Sekme durumu doƒüru (900ms - eski format)");
                    }
                }, 900);
                
            } else {
                console.log("‚ö†Ô∏è Ders Tanƒ±mlama sekmesi bulunamadƒ± (eski format)");
            }
            
        }, 900);
        
        // Eski format fonksiyonlarƒ± varsa √ßaƒüƒ±r
        if (typeof updateGradeDisplays === 'function') {
            updateGradeDisplays();
        }
        if (typeof updateModernStats === 'function') {
            updateModernStats();
        }
        if (typeof updatePassFailCounts === 'function') {
            updatePassFailCounts();
        }
        
        showModernToast("üîÑ T√ºm √∂ƒürenci puanlarƒ± sƒ±fƒ±rlandƒ± ve notlar yeniden hesaplandƒ±! Maksimum puanlar korundu, sadece alƒ±nan puanlar 0 yapƒ±ldƒ±.", "success");
        
    } catch (error) {
        console.error("Puanlar sƒ±fƒ±rlanƒ±rken hata:", error);
        showModernToast("‚ùå Puanlar sƒ±fƒ±rlanamadƒ±!", "error");
    }
}

/**
 * √ñƒürenci temizleme i≈ülemini ger√ßekle≈ütir
 */
function performClearStudentsOnly() {
    try {
        APP_STATE.students = [];
        APP_STATE.studentGrades = {};
        APP_STATE.groupMapping = {};
        
        // Eski format desteƒüi
        APP_STATE.studentData = [];
        APP_STATE.gradesData = {};
        
        updateStudentTable();
        updateAssessmentView();
        updateGradesTable();
        
        // Eski format fonksiyonlarƒ± varsa √ßaƒüƒ±r
        if (typeof updateStudentDisplays === 'function') {
            updateStudentDisplays();
        }
        if (typeof updateModernStats === 'function') {
            updateModernStats();
        }
        if (typeof updatePassFailCounts === 'function') {
            updatePassFailCounts();
        }
        if (typeof updateGroupSliderLimits === 'function') {
            updateGroupSliderLimits(); // Grup slider'larƒ±nƒ± sƒ±fƒ±rla
        }
        
        showModernToast("üéì T√ºm √∂ƒürenci verileri silindi!", "success");
        
    } catch (error) {
        console.error("√ñƒürenciler temizlenirken hata:", error);
        showModernToast("‚ùå √ñƒürenciler temizlenemedi!", "error");
    }
}

/**
 * Rastgele yarƒ±yƒ±l i√ßi deƒüerlendirme olu≈ütur
 */
// ƒ∞lk generateRandomTermAssessment fonksiyonu kaldƒ±rƒ±ldƒ± - geli≈ümi≈ü versiyon korundu

/**
 * Rastgele yarƒ±yƒ±l sonu deƒüerlendirme olu≈ütur
 */
// ƒ∞lk generateRandomFinalAssessment fonksiyonu kaldƒ±rƒ±ldƒ± - geli≈ümi≈ü versiyon korundu

/**
 * Rastgele bile≈üen olu≈ütur
 */
function createRandomComponent(isQuestion, type, index) {
    const questionTypes = ['√áoktan Se√ßmeli', 'A√ßƒ±k U√ßlu', 'Doƒüru/Yanlƒ±≈ü', 'E≈üle≈ütirme'];
    const rubricTypes = ['Proje Deƒüerlendirme', 'Sunum Rubriƒüi', 'Lab Raporu', '√ñdev Rubriƒüi'];
    
    if (isQuestion) {
        return {
            id: generateUniqueId(),
            name: `${type === 'term' ? 'Ara' : 'Final'} Sƒ±nav Soru ${index}`,
            type: 'question',
            category: type,
            points: 0, // Daha sonra daƒüƒ±tƒ±lacak
            questionType: questionTypes[Math.floor(Math.random() * questionTypes.length)],
            outcomes: getRandomOutcomes(),
            description: `${type === 'term' ? 'Yarƒ±yƒ±l i√ßi' : 'Yarƒ±yƒ±l sonu'} deƒüerlendirme sorusu`
        };
    } else {
        return {
            id: generateUniqueId(),
            name: `${type === 'term' ? 'Ara' : 'Final'} Rubrik ${index}`,
            type: 'rubric',
            category: type,
            points: 0, // Daha sonra daƒüƒ±tƒ±lacak
            rubricType: rubricTypes[Math.floor(Math.random() * rubricTypes.length)],
            outcomes: getRandomOutcomes(),
            description: `${type === 'term' ? 'Yarƒ±yƒ±l i√ßi' : 'Yarƒ±yƒ±l sonu'} rubrik deƒüerlendirmesi`
        };
    }
}

/**
 * Yarƒ±yƒ±l i√ßi ana d√ºƒü√ºm√ºn√º al veya olu≈ütur
 */
function getOrCreateTermNode() {
    let termNode = APP_STATE.assessmentTree.find(node => node.category === 'term');
    if (!termNode) {
        termNode = {
            id: generateUniqueId(),
            name: 'Yarƒ±yƒ±l ƒ∞√ßi Deƒüerlendirme',
            type: 'term',
            category: 'term',
            weight: 40,
            children: []
        };
        APP_STATE.assessmentTree.push(termNode);
    }
    return termNode;
}

/**
 * Yarƒ±yƒ±l sonu ana d√ºƒü√ºm√ºn√º al veya olu≈ütur
 */
function getOrCreateFinalNode() {
    let finalNode = APP_STATE.assessmentTree.find(node => node.category === 'final');
    if (!finalNode) {
        finalNode = {
            id: generateUniqueId(),
            name: 'Yarƒ±yƒ±l Sonu Deƒüerlendirme',
            type: 'final',
            category: 'final',
            weight: 60,
            children: []
        };
        APP_STATE.assessmentTree.push(finalNode);
    }
    return finalNode;
}

// ƒ∞kinci getRandomOutcomes fonksiyonu kaldƒ±rƒ±ldƒ± - parametre alan versiyon korundu

// =====================================================
// ORAN DENGELEME Sƒ∞STEMƒ∞
// =====================================================

/**
 * Dengeleme kontrol√º yapar ve gerekirse modal g√∂sterir
 * @param {string} category - 'term' veya 'final'
 * @param {number} addedCount - Eklenen bile≈üen sayƒ±sƒ±
 */
function checkBalanceAndShowModal(category, addedCount) {
    const balanceStatus = analyzeBalanceStatus();
    
    if (balanceStatus.needsBalance) {
        showBalanceModal(category, addedCount, balanceStatus);
    } else {
        // Dengeleme gerekmiyor, sadece bilgi ver
        showModernToast(`${addedCount} adet ${category === 'term' ? 'yarƒ±yƒ±l i√ßi' : 'yarƒ±yƒ±l sonu'} bile≈üen olu≈üturuldu!`, 'success');
    }
}

/**
 * Mevcut dengeleme durumunu analiz eder
 * @returns {Object} Dengeleme durumu bilgileri
 */
function analyzeBalanceStatus() {
    const termNodes = getNodesByCategory('term');
    const finalNodes = getNodesByCategory('final');
    
    // Yarƒ±yƒ±l i√ßi analizi
    const termAnalysis = analyzeNodeGroup(termNodes, 'Yarƒ±yƒ±l ƒ∞√ßi');
    const finalAnalysis = analyzeNodeGroup(finalNodes, 'Yarƒ±yƒ±l Sonu');
    
    // Genel aƒüƒ±rlƒ±k analizi
    const totalTermWeight = termNodes.reduce((sum, node) => sum + (node.weight || 0), 0);
    const totalFinalWeight = finalNodes.reduce((sum, node) => sum + (node.weight || 0), 0);
    const totalWeight = totalTermWeight + totalFinalWeight;
    
    const needsBalance = !termAnalysis.isBalanced || !finalAnalysis.isBalanced || totalWeight !== 100;
    
    return {
        needsBalance,
        termAnalysis,
        finalAnalysis,
        totalTermWeight,
        totalFinalWeight,
        totalWeight,
        issues: [
            ...termAnalysis.issues,
            ...finalAnalysis.issues,
            ...(totalWeight !== 100 ? [`Toplam aƒüƒ±rlƒ±k %${totalWeight} (olmasƒ± gereken %100)`] : [])
        ]
    };
}

/**
 * D√ºƒü√ºm grubunu analiz eder
 * @param {Array} nodes - Analiz edilecek d√ºƒü√ºmler
 * @param {string} categoryName - Kategori adƒ±
 * @returns {Object} Analiz sonucu
 */
function analyzeNodeGroup(nodes, categoryName) {
    const issues = [];
    let isBalanced = true;
    
    nodes.forEach(node => {
        if (node.children && node.children.length > 0) {
            const totalPoints = node.children.reduce((sum, child) => sum + (child.points || 0), 0);
            if (totalPoints !== 100) {
                issues.push(`${node.name}: ${totalPoints} puan (olmasƒ± gereken 100)`);
                isBalanced = false;
            }
        }
    });
    
    return { isBalanced, issues, nodes };
}

/**
 * Kategori bazƒ±nda d√ºƒü√ºmleri getirir
 * @param {string} category - Kategori ('term' veya 'final')
 * @returns {Array} D√ºƒü√ºm listesi
 */
function getNodesByCategory(category) {
    return APP_STATE.assessmentTree.filter(node => node.category === category);
}

/**
 * Dengeleme modalƒ±nƒ± g√∂sterir
 * @param {string} category - Kategori
 * @param {number} addedCount - Eklenen bile≈üen sayƒ±sƒ±
 * @param {Object} balanceStatus - Dengeleme durumu
 */
function showBalanceModal(category, addedCount, balanceStatus) {
    const modal = document.getElementById('balanceDistributionModal');
    const statusContainer = document.getElementById('currentBalanceStatus');
    
    if (!modal || !statusContainer) return;
    
    // Mevcut durum bilgisini olu≈ütur
    let statusHTML = `
        <div class="status-category">
            <h5>üìä Mevcut Durum</h5>
            <div class="status-items">
    `;
    
    balanceStatus.issues.forEach(issue => {
        statusHTML += `<div class="status-item unbalanced">${issue}</div>`;
    });
    
    statusHTML += `
            </div>
        </div>
        <div class="status-category">
            <h5>üéØ Hedef</h5>
            <div class="status-items">
                <div class="status-item balanced">Yarƒ±yƒ±l ƒ∞√ßi: Her sƒ±nav 100 puan</div>
                <div class="status-item balanced">Yarƒ±yƒ±l Sonu: Her sƒ±nav 100 puan</div>
                <div class="status-item balanced">Aƒüƒ±rlƒ±k Toplamƒ±: %100</div>
            </div>
        </div>
    `;
    
    statusContainer.innerHTML = statusHTML;
    
    // Modal event listener'larƒ±nƒ± ayarla
    setupBalanceModalEvents(category, addedCount, balanceStatus);
    
    // Modal'ƒ± a√ß
    openModernModal('balanceDistributionModal');
}

/**
 * Dengeleme modal event listener'larƒ±nƒ± ayarlar
 * @param {string} category - Kategori
 * @param {number} addedCount - Eklenen bile≈üen sayƒ±sƒ±
 * @param {Object} balanceStatus - Dengeleme durumu
 */
function setupBalanceModalEvents(category, addedCount, balanceStatus) {
    // √ñnceki event listener'larƒ± temizle
    const cards = document.querySelectorAll('.balance-option-card');
    const previewBtn = document.getElementById('previewBalanceBtn');
    const applyBtn = document.getElementById('applyBalanceBtn');
    
    // Se√ßim temizle
    cards.forEach(card => card.classList.remove('selected'));
    previewBtn.disabled = true;
    applyBtn.disabled = true;
    
    // Kart se√ßim event'leri
    cards.forEach(card => {
        const newCard = card.cloneNode(true);
        card.parentNode.replaceChild(newCard, card);
        
        newCard.addEventListener('click', () => {
            // T√ºm se√ßimleri temizle
            document.querySelectorAll('.balance-option-card').forEach(c => c.classList.remove('selected'));
            // Bu kartƒ± se√ß
            newCard.classList.add('selected');
            
            // Butonlarƒ± etkinle≈ütir
            previewBtn.disabled = false;
            applyBtn.disabled = false;
            
            // Se√ßilen opsiyon
            const selectedOption = newCard.getAttribute('data-option');
            
            // Event listener'larƒ± g√ºncelle
            setupButtonEvents(selectedOption, category, addedCount, balanceStatus);
        });
    });
}

/**
 * Buton event listener'larƒ±nƒ± ayarlar
 * @param {string} selectedOption - Se√ßilen dengeleme opsionu
 * @param {string} category - Kategori
 * @param {number} addedCount - Eklenen bile≈üen sayƒ±sƒ±
 * @param {Object} balanceStatus - Dengeleme durumu
 */
function setupButtonEvents(selectedOption, category, addedCount, balanceStatus) {
    const previewBtn = document.getElementById('previewBalanceBtn');
    const applyBtn = document.getElementById('applyBalanceBtn');
    
    // √ñnceki event listener'larƒ± temizle
    const newPreviewBtn = previewBtn.cloneNode(true);
    const newApplyBtn = applyBtn.cloneNode(true);
    previewBtn.parentNode.replaceChild(newPreviewBtn, previewBtn);
    applyBtn.parentNode.replaceChild(newApplyBtn, applyBtn);
    
    // √ñnizleme butonu
    newPreviewBtn.addEventListener('click', () => {
        showBalancePreview(selectedOption, balanceStatus);
    });
    
    // Uygulama butonu
    newApplyBtn.addEventListener('click', () => {
        applyBalanceOption(selectedOption, balanceStatus);
        closeModernModal('balanceDistributionModal');
        showModernToast(`${addedCount} adet ${category === 'term' ? 'yarƒ±yƒ±l i√ßi' : 'yarƒ±yƒ±l sonu'} bile≈üen olu≈üturuldu ve dengeleme uygulandƒ±!`, 'success');
    });
}

/**
 * Dengeleme √∂nizlemesini g√∂sterir
 * @param {string} selectedOption - Se√ßilen dengeleme opsionu
 * @param {Object} balanceStatus - Dengeleme durumu
 */
function showBalancePreview(selectedOption, balanceStatus) {
    const previewSection = document.getElementById('balancePreview');
    const previewContent = document.getElementById('previewContent');
    
    if (!previewSection || !previewContent) return;
    
    const changes = calculateBalanceChanges(selectedOption, balanceStatus);
    
    let previewHTML = '';
    
    // Yarƒ±yƒ±l i√ßi deƒüi≈üiklikler
    if (changes.termChanges.length > 0) {
        previewHTML += `
            <div class="preview-category">
                <h6>üìò Yarƒ±yƒ±l ƒ∞√ßi Deƒüerlendirmeler</h6>
                <div class="preview-items">
                    <div class="preview-header">Etkinlik</div>
                    <div class="preview-header">Eski Puan</div>
                    <div class="preview-header">Yeni Puan</div>
        `;
        
        changes.termChanges.forEach(change => {
            const isChanged = change.oldValue !== change.newValue;
            previewHTML += `
                <div class="preview-item ${isChanged ? 'changed' : ''}">${change.name}</div>
                <div class="preview-item ${isChanged ? 'changed' : ''}">
                    ${isChanged ? `<span class="old-value">${change.oldValue}</span>` : change.oldValue}
                </div>
                <div class="preview-item ${isChanged ? 'changed' : ''}">
                    ${isChanged ? `<span class="new-value">${change.newValue}</span>` : change.newValue}
                </div>
            `;
        });
        
        previewHTML += `</div></div>`;
    }
    
    // Yarƒ±yƒ±l sonu deƒüi≈üiklikler
    if (changes.finalChanges.length > 0) {
        previewHTML += `
            <div class="preview-category">
                <h6>üìï Yarƒ±yƒ±l Sonu Deƒüerlendirmeler</h6>
                <div class="preview-items">
                    <div class="preview-header">Etkinlik</div>
                    <div class="preview-header">Eski Puan</div>
                    <div class="preview-header">Yeni Puan</div>
        `;
        
        changes.finalChanges.forEach(change => {
            const isChanged = change.oldValue !== change.newValue;
            previewHTML += `
                <div class="preview-item ${isChanged ? 'changed' : ''}">${change.name}</div>
                <div class="preview-item ${isChanged ? 'changed' : ''}">
                    ${isChanged ? `<span class="old-value">${change.oldValue}</span>` : change.oldValue}
                </div>
                <div class="preview-item ${isChanged ? 'changed' : ''}">
                    ${isChanged ? `<span class="new-value">${change.newValue}</span>` : change.newValue}
                </div>
            `;
        });
        
        previewHTML += `</div></div>`;
    }
    
    // √ñzet
    previewHTML += `
        <div class="total-summary">
            <div class="total-row">
                <span class="total-label">Yarƒ±yƒ±l ƒ∞√ßi Toplam:</span>
                <span class="total-value ${changes.termTotal === 100 ? 'perfect' : 'unbalanced'}">${changes.termTotal} puan</span>
            </div>
            <div class="total-row">
                <span class="total-label">Yarƒ±yƒ±l Sonu Toplam:</span>
                <span class="total-value ${changes.finalTotal === 100 ? 'perfect' : 'unbalanced'}">${changes.finalTotal} puan</span>
            </div>
            <div class="total-row">
                <span class="total-label">Genel Aƒüƒ±rlƒ±k Toplamƒ±:</span>
                <span class="total-value ${changes.weightTotal === 100 ? 'perfect' : 'unbalanced'}">%${changes.weightTotal}</span>
            </div>
        </div>
    `;
    
    previewContent.innerHTML = previewHTML;
    previewSection.style.display = 'block';
}

/**
 * Dengeleme deƒüi≈üikliklerini hesaplar
 * @param {string} selectedOption - Se√ßilen dengeleme opsionu
 * @param {Object} balanceStatus - Dengeleme durumu
 * @returns {Object} Deƒüi≈üiklik detaylarƒ±
 */
function calculateBalanceChanges(selectedOption, balanceStatus) {
    const changes = {
        termChanges: [],
        finalChanges: [],
        termTotal: 0,
        finalTotal: 0,
        weightTotal: 0
    };
    
    if (selectedOption === 'keep-current') {
        // Mevcut durumu koru - deƒüi≈üiklik yok
        balanceStatus.termAnalysis.nodes.forEach(node => {
            if (node.children && node.children.length > 0) {
                node.children.forEach(child => {
                    changes.termChanges.push({
                        name: child.name,
                        oldValue: child.points || 0,
                        newValue: child.points || 0
                    });
                });
            }
        });
        
        balanceStatus.finalAnalysis.nodes.forEach(node => {
            if (node.children && node.children.length > 0) {
                node.children.forEach(child => {
                    changes.finalChanges.push({
                        name: child.name,
                        oldValue: child.points || 0,
                        newValue: child.points || 0
                    });
                });
            }
        });
        
        changes.termTotal = changes.termChanges.reduce((sum, change) => sum + change.newValue, 0);
        changes.finalTotal = changes.finalChanges.reduce((sum, change) => sum + change.newValue, 0);
        changes.weightTotal = balanceStatus.totalWeight;
        
    } else if (selectedOption === 'auto-balance') {
        // Otomatik dengeleme - e≈üit daƒüƒ±lƒ±m
        balanceStatus.termAnalysis.nodes.forEach(node => {
            if (node.children && node.children.length > 0) {
                const newPoints = distributePointsIntelligently(node.children.length, 100);
                node.children.forEach((child, index) => {
                    changes.termChanges.push({
                        name: child.name,
                        oldValue: child.points || 0,
                        newValue: newPoints[index]
                    });
                });
            }
        });
        
        balanceStatus.finalAnalysis.nodes.forEach(node => {
            if (node.children && node.children.length > 0) {
                const newPoints = distributePointsIntelligently(node.children.length, 100);
                node.children.forEach((child, index) => {
                    changes.finalChanges.push({
                        name: child.name,
                        oldValue: child.points || 0,
                        newValue: newPoints[index]
                    });
                });
            }
        });
        
        changes.termTotal = 100;
        changes.finalTotal = 100;
        changes.weightTotal = 100; // Aƒüƒ±rlƒ±klar da dengelenecek
        
    } else if (selectedOption === 'smart-balance') {
        // Akƒ±llƒ± dengeleme - mevcut oranlarƒ± koruyarak d√ºzelt
        balanceStatus.termAnalysis.nodes.forEach(node => {
            if (node.children && node.children.length > 0) {
                const currentTotal = node.children.reduce((sum, child) => sum + (child.points || 0), 0);
                const factor = currentTotal > 0 ? 100 / currentTotal : 1;
                
                node.children.forEach(child => {
                    const newValue = Math.round((child.points || 0) * factor);
                    changes.termChanges.push({
                        name: child.name,
                        oldValue: child.points || 0,
                        newValue: newValue
                    });
                });
                
                // Son d√ºzeltme - toplam tam 100 olsun
                const actualTotal = changes.termChanges.slice(-node.children.length).reduce((sum, change) => sum + change.newValue, 0);
                if (actualTotal !== 100) {
                    const lastChange = changes.termChanges[changes.termChanges.length - 1];
                    lastChange.newValue += (100 - actualTotal);
                }
            }
        });
        
        balanceStatus.finalAnalysis.nodes.forEach(node => {
            if (node.children && node.children.length > 0) {
                const currentTotal = node.children.reduce((sum, child) => sum + (child.points || 0), 0);
                const factor = currentTotal > 0 ? 100 / currentTotal : 1;
                
                node.children.forEach(child => {
                    const newValue = Math.round((child.points || 0) * factor);
                    changes.finalChanges.push({
                        name: child.name,
                        oldValue: child.points || 0,
                        newValue: newValue
                    });
                });
                
                // Son d√ºzeltme - toplam tam 100 olsun
                const actualTotal = changes.finalChanges.slice(-node.children.length).reduce((sum, change) => sum + change.newValue, 0);
                if (actualTotal !== 100) {
                    const lastChange = changes.finalChanges[changes.finalChanges.length - 1];
                    lastChange.newValue += (100 - actualTotal);
                }
            }
        });
        
        changes.termTotal = 100;
        changes.finalTotal = 100;
        changes.weightTotal = 100;
        
    } else if (selectedOption === 'manual-balance') {
        // Manuel d√ºzenleme - kullanƒ±cƒ± kendisi yapacak
        // Sadece mevcut durumu g√∂ster
        return calculateBalanceChanges('keep-current', balanceStatus);
    }
    
    return changes;
}

/**
 * Dengeleme opsiyonunu uygular
 * @param {string} selectedOption - Se√ßilen dengeleme opsionu
 * @param {Object} balanceStatus - Dengeleme durumu
 */
function applyBalanceOption(selectedOption, balanceStatus) {
    if (selectedOption === 'keep-current') {
        // Hi√ßbir ≈üey yapma
        return;
    }
    
    if (selectedOption === 'manual-balance') {
        // Manuel d√ºzenleme i√ßin sadece uyarƒ± ver
        showModernToast('Manuel d√ºzenleme se√ßildi. Puanlarƒ± kendiniz ayarlayabilirsiniz.', 'info');
        return;
    }
    
    const changes = calculateBalanceChanges(selectedOption, balanceStatus);
    
    // Yarƒ±yƒ±l i√ßi deƒüi≈üiklikleri uygula
    let termChangeIndex = 0;
    balanceStatus.termAnalysis.nodes.forEach(node => {
        if (node.children && node.children.length > 0) {
            node.children.forEach(child => {
                if (termChangeIndex < changes.termChanges.length) {
                    child.points = changes.termChanges[termChangeIndex].newValue;
                    termChangeIndex++;
                }
            });
        }
    });
    
    // Yarƒ±yƒ±l sonu deƒüi≈üiklikleri uygula
    let finalChangeIndex = 0;
    balanceStatus.finalAnalysis.nodes.forEach(node => {
        if (node.children && node.children.length > 0) {
            node.children.forEach(child => {
                if (finalChangeIndex < changes.finalChanges.length) {
                    child.points = changes.finalChanges[finalChangeIndex].newValue;
                    finalChangeIndex++;
                }
            });
        }
    });
    
    // Aƒüƒ±rlƒ±klarƒ± da dengele (eƒüer gerekiyorsa)
    if (selectedOption === 'auto-balance' || selectedOption === 'smart-balance') {
        const termNodes = getNodesByCategory('term');
        const finalNodes = getNodesByCategory('final');
        
        // Varsayƒ±lan aƒüƒ±rlƒ±klar: %40 term, %60 final
        if (termNodes.length > 0) {
            const termWeight = termNodes.length > 0 ? 40 / termNodes.length : 0;
            termNodes.forEach(node => {
                node.weight = termWeight;
            });
        }
        
        if (finalNodes.length > 0) {
            const finalWeight = finalNodes.length > 0 ? 60 / finalNodes.length : 0;
            finalNodes.forEach(node => {
                node.weight = finalWeight;
            });
        }
    }
    
    // G√∂r√ºn√ºm√º g√ºncelle
    renderTree();
    // Deƒüerlendirme sekmesini g√ºncelle - CRITICAL SYNC
    updateAssessmentView();
}

// DOM y√ºklendiƒüinde modal'ƒ± ba≈ülat
document.addEventListener('DOMContentLoaded', function() {
    initializeEmailModal();
    initializeModernTestOperations();
    initializeModernEventListeners();
    
    // Grup istatistiklerini ba≈ülat
    updateGroupStatistics();
    
    // Assessment Sync Butonu Event Listener
    const btnSyncAssessment = document.getElementById('btnSyncAssessment');
    if (btnSyncAssessment) {
        btnSyncAssessment.addEventListener('click', function() {
            console.log('üîÑ Manuel assessment sync butonuna tƒ±klandƒ±');
            
            // Veri kontrol√º
            if (!APP_STATE.assessmentTree?.length) {
                showModernToast("‚ö†Ô∏è Ders tanƒ±mlama verisi bulunamadƒ±! √ñnce ders tanƒ±mlamasƒ± yapƒ±n.", "warning");
                return;
            }
            
            if (!APP_STATE.studentData?.length) {
                showModernToast("‚ö†Ô∏è √ñƒürenci verisi bulunamadƒ±! √ñnce √∂ƒürenci listesi y√ºkleyin.", "warning");
                return;
            }
            
            // Sekmeden kontrol 
            const activeTab = document.querySelector('.nav-tab.active');
            const isAssessmentTab = activeTab && activeTab.getAttribute('data-tab') === 'assessment';
            
            if (!isAssessmentTab) {
                showModernToast("‚ÑπÔ∏è Deƒüerlendirme Giri≈üi sekmesine ge√ßi≈ü yapƒ±lƒ±yor...", "info");
                // Assessment sekmesine ge√ß
                const assessmentTab = document.querySelector('.nav-tab[data-tab="assessment"]');
                if (assessmentTab) {
                    assessmentTab.click();
                }
                
                // Kƒ±sa bir bekleyip g√ºncelle
                setTimeout(() => {
                    updateAssessmentView();
                    showModernToast("‚úÖ Deƒüerlendirme tablosu g√ºncellendi!", "success");
                }, 100);
            } else {
                // Zaten assessment sekmesindeyiz, direkt g√ºncelle
                updateAssessmentView();
                showModernToast("‚úÖ Deƒüerlendirme tablosu g√ºncellendi!", "success");
            }
        });
    }
});

/**
 * √ñ√á Performans Kartƒ± HTML Olu≈üturucu
 */
function createOCPerformanceHTML(outcomes, studentGrades) {
    if (!outcomes || outcomes.length === 0) {
        return `
        <div class="email-card">
            <div class="card-header">üìö √ñƒürenme √áƒ±ktƒ±larƒ± (√ñ√á)</div>
            <div class="card-content">
                <p style="color: #e74c3c;">Bu ders i√ßin √∂ƒürenme √ßƒ±ktƒ±larƒ± tanƒ±mlanmamƒ±≈ü.</p>
            </div>
        </div>`;
    }

    const performanceItems = outcomes.slice(0, 4).map(outcome => {
        const performance = calculateOCPerformanceFromText(outcome.id, studentGrades, APP_STATE.assessmentTree || []);
        const level = getPerformanceTextLevel(performance);
        const color = performance >= 80 ? '#27ae60' : performance >= 70 ? '#f39c12' : '#e74c3c';
        
        return `
        <div class="performance-item">
            <div class="performance-header">
                <span class="oc-id">${outcome.id}</span>
                <span class="performance-score" style="color: ${color};">%${performance.toFixed(2)}</span>
            </div>
            <div class="performance-level" style="color: ${color};">${level}</div>
            <div class="oc-description">${(outcome.aciklama || '').substring(0, 80)}...</div>
        </div>`;
    }).join('');

    const remainingCount = outcomes.length > 4 ? outcomes.length - 4 : 0;
    
    return `
    <div class="email-card">
        <div class="card-header">üìö √ñƒürenme √áƒ±ktƒ±larƒ± Performansƒ±</div>
        <div class="card-content">
            ${performanceItems}
            ${remainingCount > 0 ? `<div class="remaining-count">... ve ${remainingCount} tane daha</div>` : ''}
        </div>
    </div>`;
}

/**
 * P√á ƒ∞li≈üki Kartƒ± HTML Olu≈üturucu
 */
function createPCRelationHTML(programOutcomes, relationMatrix) {
    const totalPC = programOutcomes.length;
    const strongRelations = Math.floor(totalPC * 0.4);
    const moderateRelations = Math.floor(totalPC * 0.6);
    
    // En g√º√ßl√º ili≈ükileri g√∂ster
    const topRelations = programOutcomes.slice(0, 3).map(pc => {
        const category = pc.kategori || 'Bƒ∞LGƒ∞';
        const relation = calculatePCRelationStrength(pc.id, relationMatrix);
        const strength = relation.level;
        const color = strength === 'G√º√ßl√º' ? '#27ae60' : strength === 'Orta' ? '#f39c12' : '#e74c3c';
        
        return `
        <div class="pc-relation-item">
            <div class="pc-header">
                <span class="pc-id">${pc.id}</span>
                <span class="pc-category">${category}</span>
            </div>
            <div class="relation-strength" style="color: ${color};">${strength} ƒ∞li≈üki</div>
        </div>`;
    }).join('');
    
    return `
    <div class="email-card">
        <div class="card-header">üéØ Program √áƒ±ktƒ±larƒ± ƒ∞li≈ükisi</div>
        <div class="card-content">
            <div class="pc-summary">
                <div class="summary-item">
                    <span class="summary-label">Toplam P√á:</span>
                    <span class="summary-value">${totalPC}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">G√º√ßl√º ƒ∞li≈üki:</span>
                    <span class="summary-value" style="color: #27ae60;">${strongRelations}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Orta ƒ∞li≈üki:</span>
                    <span class="summary-value" style="color: #f39c12;">${moderateRelations}</span>
                </div>
            </div>
            ${topRelations}
        </div>
    </div>`;
}

/**
 * Genel Performans √ñzeti HTML Olu≈üturucu
 */
function createPerformanceSummaryHTML(avgPerformance) {
    const level = getPerformanceTextLevel(avgPerformance);
    const color = avgPerformance >= 80 ? '#27ae60' : avgPerformance >= 70 ? '#f39c12' : '#e74c3c';
    
    let recommendation = '';
    let icon = '';
    
    if (avgPerformance >= 80) {
        recommendation = 'Mevcut performansƒ±nƒ±zƒ± koruyun. Ba≈üarƒ±lƒ± gidiyorsunuz!';
        icon = 'üåü';
    } else if (avgPerformance >= 70) {
        recommendation = 'Zayƒ±f alanlarƒ± geli≈ütirin. Daha fazla √ßalƒ±≈üma ile daha iyi sonu√ßlar alabilirsiniz.';
        icon = 'üìà';
    } else {
        recommendation = 'Temel konularƒ± tekrar edin. Ek destek almayƒ± d√º≈ü√ºn√ºn.';
        icon = 'üìö';
    }
    
    return `
    <div class="email-card performance-summary">
        <div class="card-header">üìä Genel Performans Deƒüerlendirmesi</div>
        <div class="card-content">
            <div class="performance-overview">
                <div class="avg-performance">
                    <span class="performance-label">√ñ√á Ortalamasƒ±:</span>
                    <span class="performance-value" style="color: ${color}; font-size: 24px; font-weight: bold;">%${avgPerformance.toFixed(2)}</span>
                </div>
                <div class="performance-level-display" style="color: ${color}; font-size: 18px; font-weight: bold;">
                    ${level}
                </div>
            </div>
            <div class="recommendation">
                <div class="recommendation-header">${icon} √ñneriler:</div>
                <div class="recommendation-text">${recommendation}</div>
            </div>
        </div>
    </div>`;
}

/**
 * √ñ√á-P√á Analiz e-postasƒ± i√ßin HTML formatƒ±
 */
function generateAnalysisHTMLEmail(student) {
    const instructor = getInstructorName();
    const courseInfo = getCourseInfo();
    const courseName = courseInfo.name;
    const courseTerm = courseInfo.term;
    
    const subject = `${courseName} - √ñ√á-P√á Analizi`;
    
    // √ñƒürenci verilerini al
    let studentData = APP_STATE.studentData?.find(s => s.studentId === student.studentId);
    if (!studentData) {
        studentData = {
            studentId: student.studentId,
            name: student.name || 'Bilinmeyen',
            surname: student.surname || '√ñƒürenci'
        };
    }

    // Veri kaynaklarƒ±
    const outcomes = APP_STATE.courseData?.dersOgrenme√áiktilari || [];
    const programOutcomes = APP_STATE.courseData?.programCiktilari || [];
    const relationMatrix = APP_STATE.courseData?.programVeOgrenmeIliskisi?.iliskiTablosu || [];
    const allGradesData = APP_STATE.gradesData || APP_STATE.courseData?.ogrenciNotlari || {};
    const studentGrades = allGradesData[studentData.studentId] || {};
    
    // Ger√ßek ortalama performans hesabƒ±
    let totalOCPerformance = 0;
    let validOCCount = 0;
    outcomes.forEach(oc => {
        const performance = calculateOCPerformanceFromText(oc.id, studentGrades, APP_STATE.assessmentTree || []);
        totalOCPerformance += performance;
        if (performance > 0) validOCCount++;
    });
    const avgPerformance = validOCCount > 0 ? totalOCPerformance / validOCCount : 0;
    
    // HTML bile≈üenleri
    const studentInfoHTML = createStudentInfoHTML(studentData, courseName, courseTerm);
    const ocPerformanceHTML = createOCPerformanceHTML(outcomes, studentGrades);
    const pcRelationHTML = createPCRelationHTML(programOutcomes, relationMatrix);
    const performanceSummaryHTML = createPerformanceSummaryHTML(avgPerformance);
    const contactHTML = createContactHTML(instructor);
    
    const body = `
    <div style="font-family: 'Segoe UI', Arial, sans-serif; max-width: 800px; margin: 0 auto; background-color: #f8f9fa;">
        ${studentInfoHTML}
        ${ocPerformanceHTML}
        ${pcRelationHTML}
        ${performanceSummaryHTML}
        ${contactHTML}
    </div>
    
    <style>
        .email-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin: 20px 0;
            overflow: hidden;
        }
        
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 20px;
            font-size: 18px;
            font-weight: bold;
        }
        
        .card-content {
            padding: 20px;
        }
        
        .performance-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #667eea;
        }
        
        .performance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .oc-id {
            font-weight: bold;
            color: #2c3e50;
            font-size: 16px;
        }
        
        .performance-score {
            font-weight: bold;
            font-size: 18px;
        }
        
        .performance-level {
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .oc-description {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .pc-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .summary-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        
        .summary-label {
            display: block;
            color: #7f8c8d;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .summary-value {
            font-weight: bold;
            font-size: 18px;
            color: #2c3e50;
        }
        
        .pc-relation-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            border-left: 4px solid #f39c12;
        }
        
        .pc-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .pc-id {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .pc-category {
            background: #ecf0f1;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .relation-strength {
            font-weight: bold;
            font-size: 14px;
        }
        
        .performance-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .performance-summary .card-content {
            color: white;
        }
        
        .performance-overview {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .avg-performance {
            margin-bottom: 10px;
        }
        
        .performance-label {
            display: block;
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .performance-value {
            display: block;
        }
        
        .performance-level-display {
            margin-top: 10px;
        }
        
        .recommendation {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 15px;
        }
        
        .recommendation-header {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .recommendation-text {
            line-height: 1.6;
        }
        
        .remaining-count {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
    </style>`;
    
    return { subject, body };
}

/**
 * Tam Dosya formatƒ±nda rastgele yarƒ±yƒ±l i√ßi deƒüerlendirme olu≈üturur
 */
function generateRandomTermAssessment() {
    try {
        const activityCount = parseInt(document.getElementById('termActivityCountSlider').value) || 2;
        const componentCount = parseInt(document.getElementById('termComponentsSlider').value) || 3;
        const activityType = document.getElementById('termActivityTypeSelect').value || 'random';
        
                  console.log(`üé≤ Tam Dosya formatƒ±nda rastgele yarƒ±yƒ±l i√ßi deƒüerlendirme olu≈üturuluyor (${activityCount} etkinlik, ${componentCount} alt bile≈üen)...`);
        
        generateTamDosyaTermAssessmentWithParams(activityCount, componentCount, activityType);
        
    } catch (error) {
        console.error('‚ùå V5 rastgele yarƒ±yƒ±l i√ßi deƒüerlendirme olu≈üturulurken hata:', error);
        showModernToast('V5 rastgele yarƒ±yƒ±l i√ßi deƒüerlendirme olu≈üturulamadƒ±!', 'error');
    }
}

/**
 * Tam Dosya formatƒ±nda rastgele yarƒ±yƒ±l sonu deƒüerlendirme olu≈üturur
 */
function generateRandomFinalAssessment() {
    try {
        const activityCount = parseInt(document.getElementById('finalActivityCountSlider').value) || 1;
        const componentCount = parseInt(document.getElementById('finalComponentsSlider').value) || 5;
        const activityType = document.getElementById('finalActivityTypeSelect').value || 'random';
        
                  console.log(`üé≤ Tam Dosya formatƒ±nda rastgele yarƒ±yƒ±l sonu deƒüerlendirme olu≈üturuluyor (${activityCount} etkinlik, ${componentCount} alt bile≈üen)...`);
        
        generateTamDosyaFinalAssessmentWithParams(activityCount, componentCount, activityType);
        
    } catch (error) {
        console.error('‚ùå V5 rastgele yarƒ±yƒ±l sonu deƒüerlendirme olu≈üturulurken hata:', error);
        showModernToast('V5 rastgele yarƒ±yƒ±l sonu deƒüerlendirme olu≈üturulamadƒ±!', 'error');
    }
}

/**
 * Parametreli rastgele deƒüerlendirme olu≈üturucu
 */
function generateRandomAssessmentWithParams(isTermActivity, componentCount, activityType = 'random') {
    try {
        // JSON dosyasƒ±ndan gelen ger√ßek etkinlik t√ºrleri ve √∂zellikler
        const activityTypeMap = {
            // Yarƒ±yƒ±l ƒ∞√ßi Etkinlikler
            'Ara Sƒ±nav': { weight: [25, 35], points: 100, hasSubItems: true, subTypes: ['Soru'] },
            'Laboratuvar Sƒ±navƒ±': { weight: [15, 25], points: 100, hasSubItems: true, subTypes: ['Soru'] },
            'Deney': { weight: [10, 20], points: 100, hasSubItems: true, subTypes: ['Rubrik'] },
            'Deney Sonrasƒ± Quiz': { weight: [5, 15], points: 100, hasSubItems: true, subTypes: ['Soru'] },
            'Performans': { weight: [15, 25], points: 100, hasSubItems: true, subTypes: ['Rubrik'] },
            'Quiz': { weight: [5, 15], points: 100, hasSubItems: true, subTypes: ['Soru'] },
            'Rapor': { weight: [15, 25], points: 100, hasSubItems: true, subTypes: ['Rubrik'] },
            'Rapor Sunma': { weight: [10, 20], points: 100, hasSubItems: true, subTypes: ['Rubrik'] },
            'Makale Kritik Etme': { weight: [10, 20], points: 100, hasSubItems: true, subTypes: ['Rubrik'] },
            'Makale Yazma': { weight: [15, 25], points: 100, hasSubItems: true, subTypes: ['Rubrik'] },
            'Proje Hazƒ±rlama': { weight: [20, 30], points: 100, hasSubItems: true, subTypes: ['Rubrik'] },
            'Proje Sunma': { weight: [15, 25], points: 100, hasSubItems: true, subTypes: ['Rubrik'] },
            'Rehberli Problem √á√∂z√ºm√º': { weight: [10, 20], points: 100, hasSubItems: true, subTypes: ['Soru'] },
            'Seminer': { weight: [10, 20], points: 100, hasSubItems: true, subTypes: ['Rubrik'] },
            'S√∂zl√º Sƒ±nav': { weight: [15, 25], points: 100, hasSubItems: true, subTypes: ['Soru'] },
            '√ñdev Problemleri ƒ∞√ßin √áalƒ±≈üma': { weight: [10, 20], points: 100, hasSubItems: true, subTypes: ['Rubrik'] },
            'Proje Tasarƒ±mƒ±/Y√∂netimi': { weight: [20, 30], points: 100, hasSubItems: true, subTypes: ['Rubrik'] },
            
            // Yarƒ±yƒ±l Sonu Etkinlikler
            'Final Sƒ±navƒ±': { weight: [80, 100], points: 100, hasSubItems: true, subTypes: ['Soru'] },
            'Laboratuvar Ara Sƒ±navƒ±': { weight: [70, 90], points: 100, hasSubItems: true, subTypes: ['Soru'] },
            'G√∂zlem': { weight: [60, 80], points: 100, hasSubItems: true, subTypes: ['Rubrik'] }
        };
        
        // Ger√ßek√ßi deƒüerlendirme t√ºrleri - JSON'dan gelen listeler
        const realisticTypes = {
            term: [
                'Ara Sƒ±nav', 'Laboratuvar Sƒ±navƒ±', 'Deney', 'Deney Sonrasƒ± Quiz', 'Performans', 
                'Quiz', 'Rapor', 'Rapor Sunma', 'Makale Kritik Etme', 'Makale Yazma', 
                'Proje Hazƒ±rlama', 'Proje Sunma', 'Rehberli Problem √á√∂z√ºm√º', 'Seminer', 
                'S√∂zl√º Sƒ±nav', '√ñdev Problemleri ƒ∞√ßin √áalƒ±≈üma', 'Proje Tasarƒ±mƒ±/Y√∂netimi'
            ],
            final: [
                'Final Sƒ±navƒ±', 'Laboratuvar Ara Sƒ±navƒ±', 'Makale Yazma', 'Proje Hazƒ±rlama', 
                'Proje Sunma', 'Proje Tasarƒ±mƒ±/Y√∂netimi', 'Quiz', 'Rapor', 'Rapor Hazƒ±rlama', 
                'Rapor Sunma', 'Seminer', 'S√∂zl√º Sƒ±nav', 'G√∂zlem'
            ]
        };
        
        let selectedActivityType;
        if (activityType === 'random') {
            // Rastgele se√ßim
        const availableTypes = isTermActivity ? realisticTypes.term : realisticTypes.final;
            selectedActivityType = availableTypes[Math.floor(Math.random() * availableTypes.length)];
        } else {
            // Kullanƒ±cƒ±nƒ±n se√ßtiƒüi t√ºr
            selectedActivityType = activityType;
        }
        
        const randomTypeInfo = {
            name: selectedActivityType,
            ...activityTypeMap[selectedActivityType]
        };
        
        // Mevcut aktiviteleri say ve doƒüru ID formatƒ±nƒ± olu≈ütur
        const existingActivities = APP_STATE.assessmentTree.filter(node => 
            isTermActivity ? node.id.startsWith('A') : node.id.startsWith('F')
        );
        const nextNumber = existingActivities.length + 1;
        const newId = isTermActivity ? `A${nextNumber}` : `F${nextNumber}`;
        
        // Mevcut √∂ƒürenme √ßƒ±ktƒ±larƒ±nƒ± kullan (varsa)
        let selectedOutcomes = [];
        if (APP_STATE.learningOutcomes && APP_STATE.learningOutcomes.length > 0) {
            const numOutcomes = Math.floor(Math.random() * 3) + 1; // 1-3 arasƒ±
            const shuffledOutcomes = [...APP_STATE.learningOutcomes].sort(() => Math.random() - 0.5);
            selectedOutcomes = shuffledOutcomes.slice(0, numOutcomes).map(outcome => outcome.id);
        } else {
            // Varsayƒ±lan √∂ƒürenme √ßƒ±ktƒ±larƒ± (ger√ßek√ßi)
            const defaultOutcomes = ['√ñ√á.1', '√ñ√á.2', '√ñ√á.3', '√ñ√á.4', '√ñ√á.5', '√ñ√á.6'];
            const numOutcomes = Math.floor(Math.random() * 3) + 2; // 2-4 arasƒ±
            const shuffledOutcomes = [...defaultOutcomes].sort(() => Math.random() - 0.5);
            selectedOutcomes = shuffledOutcomes.slice(0, numOutcomes);
        }
        
        // Ger√ßek√ßi aƒüƒ±rlƒ±k ve puan hesaplama
        const weightRange = randomTypeInfo.weight;
        const weight = Math.floor(Math.random() * (weightRange[1] - weightRange[0] + 1)) + weightRange[0];
        
        let points;
        if (Array.isArray(randomTypeInfo.points)) {
            points = Math.floor(Math.random() * (randomTypeInfo.points[1] - randomTypeInfo.points[0] + 1)) + randomTypeInfo.points[0];
        } else {
            points = randomTypeInfo.points;
        }
        
        console.log(`  üìã ${randomTypeInfo.name} olu≈üturuluyor - Aƒüƒ±rlƒ±k: ${weight}%, Puan: ${points}`);
        
        // Yeni aktivite olu≈ütur - mevcut sistem formatƒ±nda
        const newActivity = {
            id: newId,
            name: randomTypeInfo.name,
            type: randomTypeInfo.name,
            weight: weight,
            points: points,
            outcomes: selectedOutcomes,
            description: isTermActivity ? 
                `Yarƒ±yƒ±l i√ßi ${randomTypeInfo.name.toLowerCase()} deƒüerlendirmesi` : 
                `Yarƒ±yƒ±l sonu ${randomTypeInfo.name.toLowerCase()} deƒüerlendirmesi`,
            expanded: true,
            children: []
        };
        
        // Alt bile≈üenler ekle - kullanƒ±cƒ±nƒ±n belirlediƒüi sayƒ±da
        if (randomTypeInfo.hasSubItems && componentCount > 0) {
            let subTypes = randomTypeInfo.subTypes;
            
            console.log(`    üîπ ${componentCount} alt bile≈üen ekleniyor...`);
            
            // D√úZELTME: Akƒ±llƒ± puan daƒüƒ±lƒ±mƒ± - toplam 100 olacak ≈üekilde
            const basePoints = Math.floor(points / componentCount);
            const remainder = points - (basePoints * componentCount);
            
            // D√úZELTME: Akƒ±llƒ± aƒüƒ±rlƒ±k daƒüƒ±lƒ±mƒ± - toplam 100 olacak ≈üekilde
            const baseWeight = Math.floor(100 / componentCount);
            const weightRemainder = 100 - (baseWeight * componentCount);
            
            for (let i = 0; i < componentCount; i++) {
                // Alt bile≈üen t√ºr√ºn√º ger√ßek√ßi ≈üekilde se√ß
                const subType = subTypes[Math.floor(Math.random() * subTypes.length)];
                
                // Ger√ßek√ßi alt bile≈üen isimleri
                let subName;
                if (subType === 'Soru') {
                    const questionTypes = ['√áoktan Se√ßmeli', 'A√ßƒ±k U√ßlu', 'Kƒ±sa Cevaplƒ±', 'Problem', 'Analiz'];
                    subName = `${questionTypes[Math.floor(Math.random() * questionTypes.length)]} Soru ${i + 1}`;
                } else if (subType === 'Test') {
                    subName = `Test B√∂l√ºm√º ${i + 1}`;
                } else if (subType === 'Rubrik') {
                    const rubricTypes = ['Deƒüerlendirme', 'Analiz', 'Sunum', 'Rapor', 'Kod Kalitesi'];
                    subName = `${rubricTypes[Math.floor(Math.random() * rubricTypes.length)]} Rubriƒüi`;
                } else {
                    subName = `${subType} ${i + 1}`;
                }
                
                // D√úZELTME: Kalan puanlarƒ± ve aƒüƒ±rlƒ±klarƒ± ilk bile≈üenlere daƒüƒ±t
                const componentPoints = basePoints + (i < remainder ? 1 : 0);
                const componentWeight = baseWeight + (i < weightRemainder ? 1 : 0);
                
                const subItem = {
                    id: `${newId}.${i + 1}`,
                    name: subName,
                    type: subType,
                    weight: componentWeight,
                    points: componentPoints,
                    outcomes: selectedOutcomes.length > 0 ? 
                        [selectedOutcomes[Math.floor(Math.random() * selectedOutcomes.length)]] : [],
                    description: `${subName} i√ßin deƒüerlendirme kriteri`,
                    expanded: false,
                    children: []
                };
                
                // Test i√ßin ger√ßek√ßi detaylar ekle
                if (subType === 'Test') {
                    const questionCount = Math.floor(Math.random() * 20) + 10; // 10-30 soru
                    subItem.testDetails = {
                        totalQuestions: questionCount,
                        correctWeight: Math.floor(Math.random() * 3) + 3, // 3-5 puan
                        wrongPenalty: -(Math.floor(Math.random() * 2) + 1) // -1 veya -2 puan
                    };
                    console.log(`      üß™ Test: ${questionCount} soru, +${subItem.testDetails.correctWeight}/${subItem.testDetails.wrongPenalty} puan`);
                }
                
                newActivity.children.push(subItem);
                console.log(`      ‚úÖ ${subName} (${subItem.points} puan)`);
            }
            
            // DOƒûRULAMA: Toplam puan ve aƒüƒ±rlƒ±k kontrol√º
            const finalTotalPoints = newActivity.children.reduce((sum, child) => sum + child.points, 0);
            const finalTotalWeight = newActivity.children.reduce((sum, child) => sum + child.weight, 0);
            
            console.log(`    üìä Toplam Puan: ${finalTotalPoints}/${points}, Toplam Aƒüƒ±rlƒ±k: ${finalTotalWeight}%`);
            
            if (finalTotalPoints !== points) {
                console.warn(`‚ö†Ô∏è Puan uyumsuzluƒüu d√ºzeltiliyor: ${finalTotalPoints} ‚Üí ${points}`);
                // Son bile≈üenin puanƒ±nƒ± ayarla
                const lastChild = newActivity.children[newActivity.children.length - 1];
                lastChild.points += (points - finalTotalPoints);
            }
            if (finalTotalWeight !== 100) {
                console.warn(`‚ö†Ô∏è Aƒüƒ±rlƒ±k uyumsuzluƒüu d√ºzeltiliyor: ${finalTotalWeight} ‚Üí 100`);
                // Son bile≈üenin aƒüƒ±rlƒ±ƒüƒ±nƒ± ayarla
                const lastChild = newActivity.children[newActivity.children.length - 1];
                lastChild.weight += (100 - finalTotalWeight);
            }
        }
        
        // Assessment tree'ye doƒüru sƒ±rada ekle
        if (isTermActivity) {
            // Yarƒ±yƒ±l i√ßi etkinlikleri ba≈üa ekle
            const termActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('A'));
            const finalActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('F'));
            termActivities.push(newActivity);
            APP_STATE.assessmentTree = [...termActivities, ...finalActivities];
        } else {
            // Yarƒ±yƒ±l sonu etkinlikleri sona ekle
            APP_STATE.assessmentTree.push(newActivity);
        }
        
        // Se√ßili d√ºƒü√ºm√º yeni aktivite yap
        selectNode(newActivity);
        
        // Aray√ºz√º g√ºncelle
        renderTree();
        updateCategoryWeights();
        updateAssessmentView();
        // updateGroupMappingDisplay(); // Bu fonksiyon ≈üu an mevcut deƒüil, gerekirse eklenecek
        
        const activityTypeText = isTermActivity ? 'yarƒ±yƒ±l i√ßi' : 'yarƒ±yƒ±l sonu';
        console.log(`‚úÖ Rastgele ${activityTypeText} deƒüerlendirme olu≈üturuldu: ${newActivity.name}`);
        
        return true; // Ba≈üarƒ± durumunu d√∂nd√ºr
        
    } catch (error) {
        console.error('‚ùå Rastgele deƒüerlendirme olu≈üturulurken hata:', error);
        throw error; // Hatayƒ± √ºst fonksiyona aktar
    }
}

/**
 * √áoklu rastgele yarƒ±yƒ±l i√ßi etkinlik olu≈üturur (Onay ile)
 */
function generateMultipleRandomTermAssessments() {
    // Mevcut verileri kontrol et
    const hasExistingData = APP_STATE.assessmentTree && APP_STATE.assessmentTree.length > 0;
    const activityCount = parseInt(document.getElementById('termActivityCountSlider').value) || 2;
    const componentCount = parseInt(document.getElementById('termComponentsSlider').value) || 3;
    const activityType = document.getElementById('termActivityTypeSelect').value;
    
    const warningMessage = hasExistingData 
        ? `Bu i≈ülem mevcut ${APP_STATE.assessmentTree.length} deƒüerlendirme bile≈üenine ${activityCount} yeni yarƒ±yƒ±l i√ßi etkinlik ekleyecek. Her etkinlikte ${componentCount} soru/rubrik olacak.\n\nDevam etmek istediƒüinizden emin misiniz?`
        : `${activityCount} adet yarƒ±yƒ±l i√ßi etkinlik olu≈üturulacak (her birinde ${componentCount} soru/rubrik, t√ºr: ${activityType}).\n\nBu i≈ülem geri alƒ±namaz. Devam etmek istediƒüinizden emin misiniz?`;
    
    showModernConfirm('‚≠ê Yarƒ±yƒ±l ƒ∞√ßi Etkinlik Olu≈ütur', warningMessage, {
            confirmText: 'Evet, Olu≈ütur',
            cancelText: 'ƒ∞ptal',
        confirmClass: 'btn-modern-primary',
        cancelClass: 'btn-modern-secondary'
    }).then((confirmed) => {
        if (confirmed) {
        executeGenerateMultipleRandomTermAssessments();
        } else {
            console.log('üë§ Kullanƒ±cƒ± yarƒ±yƒ±l i√ßi etkinlik olu≈üturmayƒ± iptal etti');
            showModernToast('‚ùå Yarƒ±yƒ±l i√ßi etkinlik olu≈üturma iptal edildi', 'info', 2000);
        }
    });
}

/**
 * √áoklu rastgele yarƒ±yƒ±l i√ßi etkinlik olu≈üturur (Ger√ßek i≈ülem)
 */
function executeGenerateMultipleRandomTermAssessments() {
    try {
        const activityCount = parseInt(document.getElementById('termActivityCountSlider').value) || 2;
        const componentCount = parseInt(document.getElementById('termComponentsSlider').value) || 3;
        const activityType = document.getElementById('termActivityTypeSelect').value;
        
        console.log(`üé≤ ${activityCount} adet yarƒ±yƒ±l i√ßi etkinlik olu≈üturuluyor (T√ºr: ${activityType}, her birinde ${componentCount} alt bile≈üen)...`);
        
        let successCount = 0;
        
        // Tam Dosya formatƒ±nda tek seferde √ßoklu etkinlik olu≈ütur
        try {
            generateTamDosyaTermAssessmentWithParams(activityCount, componentCount, activityType);
            successCount = activityCount;
                          console.log(`‚úÖ ${activityCount} yarƒ±yƒ±l i√ßi etkinlik Tam Dosya formatƒ±nda olu≈üturuldu`);
            } catch (error) {
                          console.error(`‚ùå Tam Dosya yarƒ±yƒ±l i√ßi etkinlikler olu≈üturulurken hata:`, error);
        }
        
        // Tam Dosya formatƒ±nda aƒüƒ±rlƒ±klar otomatik normalize edilir
        
        if (successCount === activityCount) {
            showModernToast(`üéâ ${activityCount} adet yarƒ±yƒ±l i√ßi etkinlik ba≈üarƒ±yla olu≈üturuldu! (Her birinde ${componentCount} soru/rubrik)`, 'success', 4000);
        } else if (successCount > 0) {
            showModernToast(`‚ö†Ô∏è ${successCount}/${activityCount} yarƒ±yƒ±l i√ßi etkinlik olu≈üturuldu. Bazƒ± etkinlikler olu≈üturulamadƒ±.`, 'warning', 4000);
        } else {
            showModernToast('‚ùå Yarƒ±yƒ±l i√ßi etkinlik olu≈üturulamadƒ±!', 'error', 4000);
        }
        
    } catch (error) {
        console.error('‚ùå √áoklu yarƒ±yƒ±l i√ßi etkinlik olu≈üturulurken hata:', error);
        showModernToast('√áoklu yarƒ±yƒ±l i√ßi etkinlik olu≈üturulamadƒ±!', 'error');
    }
}

/**
 * √áoklu rastgele yarƒ±yƒ±l sonu etkinlik olu≈üturur (Onay ile)
 */
function generateMultipleRandomFinalAssessments() {
    // Mevcut verileri kontrol et
    const hasExistingData = APP_STATE.assessmentTree && APP_STATE.assessmentTree.length > 0;
    const activityCount = parseInt(document.getElementById('finalActivityCountSlider').value) || 1;
    const componentCount = parseInt(document.getElementById('finalComponentsSlider').value) || 5;
    const activityType = document.getElementById('finalActivityTypeSelect').value;
    
    const warningMessage = hasExistingData 
        ? `Bu i≈ülem mevcut ${APP_STATE.assessmentTree.length} deƒüerlendirme bile≈üenine ${activityCount} yeni yarƒ±yƒ±l sonu etkinlik ekleyecek. Her etkinlikte ${componentCount} soru/rubrik olacak.\n\nDevam etmek istediƒüinizden emin misiniz?`
        : `${activityCount} adet yarƒ±yƒ±l sonu etkinlik olu≈üturulacak (her birinde ${componentCount} soru/rubrik, t√ºr: ${activityType}).\n\nBu i≈ülem geri alƒ±namaz. Devam etmek istediƒüinizden emin misiniz?`;
    
    showModernConfirm('üéØ Yarƒ±yƒ±l Sonu Etkinlik Olu≈ütur', warningMessage, {
            confirmText: 'Evet, Olu≈ütur',
            cancelText: 'ƒ∞ptal',
        confirmClass: 'btn-modern-success',
        cancelClass: 'btn-modern-secondary'
    }).then((confirmed) => {
        if (confirmed) {
        executeGenerateMultipleRandomFinalAssessments();
        } else {
            console.log('üë§ Kullanƒ±cƒ± yarƒ±yƒ±l sonu etkinlik olu≈üturmayƒ± iptal etti');
            showModernToast('‚ùå Yarƒ±yƒ±l sonu etkinlik olu≈üturma iptal edildi', 'info', 2000);
        }
    });
}

/**
 * √áoklu rastgele yarƒ±yƒ±l sonu etkinlik olu≈üturur (Ger√ßek i≈ülem)
 */
function executeGenerateMultipleRandomFinalAssessments() {
    try {
        const activityCount = parseInt(document.getElementById('finalActivityCountSlider').value) || 1;
        const componentCount = parseInt(document.getElementById('finalComponentsSlider').value) || 5;
        const activityType = document.getElementById('finalActivityTypeSelect').value;
        
        console.log(`üé≤ ${activityCount} adet yarƒ±yƒ±l sonu etkinlik olu≈üturuluyor (T√ºr: ${activityType}, her birinde ${componentCount} alt bile≈üen)...`);
        
        let successCount = 0;
        
        // Tam Dosya formatƒ±nda tek seferde √ßoklu etkinlik olu≈ütur
        try {
            generateTamDosyaFinalAssessmentWithParams(activityCount, componentCount, activityType);
            successCount = activityCount;
                          console.log(`‚úÖ ${activityCount} yarƒ±yƒ±l sonu etkinlik Tam Dosya formatƒ±nda olu≈üturuldu`);
            } catch (error) {
                          console.error(`‚ùå Tam Dosya yarƒ±yƒ±l sonu etkinlikler olu≈üturulurken hata:`, error);
        }
        
        // Tam Dosya formatƒ±nda aƒüƒ±rlƒ±klar otomatik normalize edilir
        
        if (successCount === activityCount) {
            showModernToast(`üéâ ${activityCount} adet yarƒ±yƒ±l sonu etkinlik ba≈üarƒ±yla olu≈üturuldu! (Her birinde ${componentCount} soru/rubrik)`, 'success', 4000);
        } else if (successCount > 0) {
            showModernToast(`‚ö†Ô∏è ${successCount}/${activityCount} yarƒ±yƒ±l sonu etkinlik olu≈üturuldu. Bazƒ± etkinlikler olu≈üturulamadƒ±.`, 'warning', 4000);
        } else {
            showModernToast('‚ùå Yarƒ±yƒ±l sonu etkinlik olu≈üturulamadƒ±!', 'error', 4000);
        }
        
    } catch (error) {
        console.error('‚ùå √áoklu yarƒ±yƒ±l sonu etkinlik olu≈üturulurken hata:', error);
        showModernToast('√áoklu yarƒ±yƒ±l sonu etkinlik olu≈üturulamadƒ±!', 'error');
    }
}

/**
 * Dual range slider uyarƒ± mesajƒ±nƒ± g√ºnceller
 */
function updateDualRangeWarning(minGroups, maxGroups) {
    const warningDiv = document.getElementById('groupsWarning');
    const warningText = document.getElementById('groupsWarningText');
    
    if (!warningDiv || !warningText) return;
    
    const studentCount = APP_STATE.studentData ? APP_STATE.studentData.length : 0;
    
    if (studentCount === 0) {
        // √ñƒürenci yoksa uyarƒ± g√∂sterme
        warningDiv.style.display = 'none';
        return;
    }
    
    if (minGroups > studentCount) {
        // Minimum grup sayƒ±sƒ± bile √∂ƒürenci sayƒ±sƒ±ndan fazlaysa kritik uyarƒ±
        warningText.textContent = `‚ö†Ô∏è Minimum ${minGroups} grup se√ßildi ancak sadece ${studentCount} √∂ƒürenci var. Maksimum ${studentCount} grup olu≈üturulabilir.`;
        warningDiv.style.display = 'flex';
    } else if (maxGroups > studentCount) {
        // Maksimum grup sayƒ±sƒ± √∂ƒürenci sayƒ±sƒ±ndan fazlaysa uyarƒ±
        warningText.textContent = `‚ö†Ô∏è Maksimum ${maxGroups} grup se√ßildi ancak sadece ${studentCount} √∂ƒürenci var. En fazla ${studentCount} grup olu≈üturulacak.`;
        warningDiv.style.display = 'flex';
    } else if (maxGroups > Math.ceil(studentCount / 2)) {
        // √ñnerilen maksimum grup sayƒ±sƒ±ndan fazlaysa bilgi ver
        const recommended = Math.ceil(studentCount / 2);
        warningText.textContent = `üí° ${studentCount} √∂ƒürenci i√ßin √∂nerilen maksimum grup sayƒ±sƒ±: ${recommended}. Her grupta en az 2 √∂ƒürenci olmasƒ± √∂nerilir.`;
        warningDiv.style.display = 'flex';
    } else {
        // Normal durumda uyarƒ± g√∂sterme
        warningDiv.style.display = 'none';
    }
}

/**
 * Slider kontrollerini ba≈ülatƒ±r
 */
/**
 * Initialize thermal slider functionality
 */
function initializeThermalSliders() {
    const thermalSliders = document.querySelectorAll('.thermal-slider, .thermal-range-slider');
    
    thermalSliders.forEach(slider => {
        const thermalType = slider.getAttribute('data-thermal');
        
        // Set initial thermal color
        updateThermalSliderColor(slider, slider.value, thermalType);
        
        // Update color on change
        slider.addEventListener('input', function() {
            updateThermalSliderColor(this, this.value, thermalType);
        });
    });
}

/**
 * Update thermal slider color based on value
 */
function updateThermalSliderColor(slider, value, thermalType) {
    const thumb = slider;
    let color;
    
    switch(thermalType) {
        case 'term':
            // Blue gradient based on complexity (1-8)
            const termPercent = (value - 1) / 7; // 0 to 1
            color = interpolateColor('#3b82f6', '#1e40af', termPercent);
            break;
            
        case 'final':
            // Green gradient based on complexity (1-10)
            const finalPercent = (value - 1) / 9;
            color = interpolateColor('#10b981', '#065f46', finalPercent);
            break;
            
        case 'scoring':
            // Amber/Red gradient based on pass rate (0-100)
            const scoringPercent = value / 100;
            if (scoringPercent < 0.5) {
                color = interpolateColor('#ef4444', '#f59e0b', scoringPercent * 2);
            } else {
                color = interpolateColor('#f59e0b', '#10b981', (scoringPercent - 0.5) * 2);
            }
            break;
            

            
        case 'group-min':
            color = '#10b981'; // Green for min
            break;
            
        case 'group-max':
            color = '#ef4444'; // Red for max
            break;
            
        default:
            color = '#3b82f6';
    }
    
    // Apply color to slider thumb
    const style = document.createElement('style');
    style.textContent = `
        .thermal-slider[data-thermal="${thermalType}"]::-webkit-slider-thumb,
        .thermal-range-slider[data-thermal="${thermalType}"]::-webkit-slider-thumb {
            border-color: ${color} !important;
        }
        .thermal-slider[data-thermal="${thermalType}"]::-moz-range-thumb,
        .thermal-range-slider[data-thermal="${thermalType}"]::-moz-range-thumb {
            border-color: ${color} !important;
        }
    `;
    
    // Remove old style if exists
    const oldStyle = document.querySelector(`style[data-thermal="${thermalType}"]`);
    if (oldStyle) {
        oldStyle.remove();
    }
    
    style.setAttribute('data-thermal', thermalType);
    document.head.appendChild(style);
}

/**
 * Interpolate between two hex colors
 */
function interpolateColor(color1, color2, factor) {
    const c1 = hexToRgb(color1);
    const c2 = hexToRgb(color2);
    
    const r = Math.round(c1.r + (c2.r - c1.r) * factor);
    const g = Math.round(c1.g + (c2.g - c1.g) * factor);
    const b = Math.round(c1.b + (c2.b - c1.b) * factor);
    
    return `rgb(${r}, ${g}, ${b})`;
}

/**
 * Convert hex to RGB
 */
function hexToRgb(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
    } : null;
}

/**
 * Initialize group and scoring controls
 */
function initializeGroupControls() {
    // Pass Rate slider
    const passRateSlider = document.getElementById('passRateSlider');
    if (passRateSlider) {
        passRateSlider.addEventListener('input', function() {
            updatePassRateIndicators();
        });
    }
    
    // Update student and group counts
    updateGroupStatistics();
    
    // Update pass rate indicators
    updatePassRateIndicators();
}

/**
 * Update pass rate indicators in the UI
 */
function updatePassRateIndicators() {
    try {
        const passRateSlider = document.getElementById('passRateSlider');
        const passRateValue = document.getElementById('passRateValue');
        const rateIndicators = document.querySelectorAll('.rate-indicator');
        
        if (passRateSlider && passRateValue) {
            const passRate = parseInt(passRateSlider.value);
            const failRate = 100 - passRate;
            
            passRateValue.textContent = `${passRate}%`;
            
            // Calculate actual pass/fail counts if student data exists
            const studentCount = APP_STATE.studentData?.length || 0;
            let actualPassCount = 0;
            let actualFailCount = 0;
            
            if (studentCount > 0 && APP_STATE.gradesData) {
                // Count actual passing/failing students based on letter grades
                APP_STATE.studentData.forEach(student => {
                    const studentGrades = APP_STATE.gradesData[student.studentId];
                    if (studentGrades && studentGrades.harfNotu) {
                        const letterGrade = studentGrades.harfNotu;
                        // AA, BA, BB, CB, CC, DC = passing, DD, FD, FF = failing
                        const passingGrades = ['AA', 'BA', 'BB', 'CB', 'CC', 'DC'];
                        if (passingGrades.includes(letterGrade)) {
                            actualPassCount++;
                        } else {
                            actualFailCount++;
                        }
                    }
                });
            }
            
            // Update rate indicators with actual or estimated counts
            rateIndicators.forEach(indicator => {
                if (indicator.classList.contains('pass')) {
                    if (actualPassCount > 0) {
                        const actualPassRate = Math.round((actualPassCount / studentCount) * 100);
                        indicator.innerHTML = `Ge√ßen: <strong>${actualPassCount} (${actualPassRate}%)</strong>`;
                    } else {
                        const estimatedPassCount = Math.round((passRate / 100) * studentCount);
                        indicator.innerHTML = `Ge√ßen: <strong>~${estimatedPassCount} (${passRate}%)</strong>`;
                    }
                } else if (indicator.classList.contains('fail')) {
                    if (actualFailCount > 0) {
                        const actualFailRate = Math.round((actualFailCount / studentCount) * 100);
                        indicator.innerHTML = `Kalan: <strong>${actualFailCount} (${actualFailRate}%)</strong>`;
                    } else {
                        const estimatedFailCount = Math.round((failRate / 100) * studentCount);
                        indicator.innerHTML = `Kalan: <strong>~${estimatedFailCount} (${failRate}%)</strong>`;
                    }
                }
            });
            
            // Ayrƒ±ca status badge'leri de g√ºncelle
            const passRateDisplay = document.getElementById('passRateDisplay');
            const failRateDisplay = document.getElementById('failRateDisplay');
            
            if (passRateDisplay) {
                if (actualPassCount > 0) {
                    const actualPassRate = Math.round((actualPassCount / studentCount) * 100);
                    passRateDisplay.textContent = `${actualPassCount} (${actualPassRate}%)`;
                } else {
                    const estimatedPassCount = Math.round((passRate / 100) * studentCount);
                    passRateDisplay.textContent = `${estimatedPassCount} (${passRate}%)`;
                }
            }
            
            if (failRateDisplay) {
                if (actualFailCount > 0) {
                    const actualFailRate = Math.round((actualFailCount / studentCount) * 100);
                    failRateDisplay.textContent = `${actualFailCount} (${actualFailRate}%)`;
                } else {
                    const estimatedFailCount = Math.round((failRate / 100) * studentCount);
                    failRateDisplay.textContent = `${estimatedFailCount} (${failRate}%)`;
                }
            }
            
            // Update thermal color
            updateThermalSliderColor(passRateSlider, passRate, 'scoring');
        }
        
    } catch (error) {
        console.error("Pass rate indicators g√ºncelleme hatasƒ±:", error);
    }
}

/**
 * Update group statistics display
 */
function updateGroupStatistics() {
    try {
        const totalStudentsCount = document.getElementById('totalStudentsCount');
        const activeGroupsCount = document.getElementById('activeGroupsCount');
        
        if (totalStudentsCount) {
            const studentCount = APP_STATE.studentData?.length || 0;
            totalStudentsCount.textContent = studentCount;
        }
        
        if (activeGroupsCount) {
            // Count unique groups across all components
            const uniqueGroups = new Set();
            if (APP_STATE.courseData?.grupHaritalari) {
                Object.values(APP_STATE.courseData.grupHaritalari).forEach(component => {
                    if (component.gruplar && component.gruplar.length > 0) {
                        component.gruplar.forEach(group => uniqueGroups.add(group));
                    }
                });
            }
            activeGroupsCount.textContent = uniqueGroups.size;
        }
        
        // Update pass/fail indicators based on current data
        updatePassRateIndicators();
        
    } catch (error) {
        console.error("Grup istatistikleri g√ºncelleme hatasƒ±:", error);
    }
}

function initializeAssessmentSliders() {
    // Initialize thermal slider update functionality
    initializeThermalSliders();
    
    // Initialize new group controls
    initializeGroupControls();
    
    // Initialize separate range sliders (enhanced dual range system)
    initializeSeparateRangeSliders();
    
    // Yarƒ±yƒ±l i√ßi slider (compact version)
    const termSlider = document.getElementById('termComponentsSlider');
    const termValue = document.getElementById('termComponentsValue');
    
    if (termSlider && termValue) {
        termSlider.addEventListener('input', function() {
            termValue.textContent = this.value;
            // Update thermal color for compact range
            updateCompactRangeColor(termSlider, this.value, 'term');
        });
    }
    
    // Yarƒ±yƒ±l sonu slider (compact version)
    const finalSlider = document.getElementById('finalComponentsSlider');
    const finalValue = document.getElementById('finalComponentsValue');
    
    if (finalSlider && finalValue) {
        finalSlider.addEventListener('input', function() {
            finalValue.textContent = this.value;
            // Update thermal color for compact range
            updateCompactRangeColor(finalSlider, this.value, 'final');
        });
    }
    
    // Pass rate slider (compact version)
    const passRateSlider = document.getElementById('passRateSlider');
    const passRateValue = document.getElementById('passRateValue');
    const passRateDisplay = document.getElementById('passRateDisplay');
    const failRateDisplay = document.getElementById('failRateDisplay');
    
    if (passRateSlider && passRateValue) {
        passRateSlider.addEventListener('input', function() {
            const value = parseInt(this.value);
            const failValue = 100 - value;
            
            // T√ºm display'leri g√ºncelle
            passRateValue.textContent = `${value}%`;
            if (passRateDisplay) passRateDisplay.textContent = `${value}%`;
            if (failRateDisplay) failRateDisplay.textContent = `${failValue}%`;
            
            updateCompactRangeColor(passRateSlider, value, 'scoring');
            updatePassRateIndicators();
        });
    }
    
    // Dual range slider'ƒ±nƒ± ba≈ülat (backwards compatibility)
    initializeDualRangeSlider();
}

/**
 * Dual range slider'ƒ±nƒ± ba≈ülatƒ±r ve y√∂netir
 */
function initializeDualRangeSlider() {
    const minSlider = document.getElementById('groupMinSlider');
    const maxSlider = document.getElementById('groupMaxSlider');
    const minValue = document.getElementById('groupMinValue');
    const maxValue = document.getElementById('groupMaxValue');
    const sliderRange = document.getElementById('sliderRange');

    if (!minSlider || !maxSlider || !minValue || !maxValue || !sliderRange) return;

    function updateSliderRange() {
        let min = parseInt(minSlider.value);
        let max = parseInt(maxSlider.value);
        
        // Min > Max olmasƒ±nƒ± engelle, ama min = max'e izin ver
        if (min > max) {
            if (minSlider === document.activeElement) {
                max = min;
                maxSlider.value = max;
            } else {
                min = max;
                minSlider.value = min;
            }
        }
        
        minValue.textContent = min;
        maxValue.textContent = max;

        // G√∂rsel range g√ºncelle (1-20 aralƒ±ƒüƒ± i√ßin)
        const percent1 = ((min - 1) / 19) * 100;
        const percent2 = ((max - 1) / 19) * 100;
        
        // Hem eski hem yeni slider sistemlerini destekle
        if (sliderRange) {
            sliderRange.style.left = percent1 + '%';
            sliderRange.style.width = (percent2 - percent1) + '%';
        }
        
        // Compact slider range i√ßin de g√ºncelle
        const compactSliderRange = document.querySelector('.compact-slider-range');
        if (compactSliderRange) {
            compactSliderRange.style.left = percent1 + '%';
            compactSliderRange.style.width = (percent2 - percent1) + '%';
        }

        // Uyarƒ± kontrol et
        updateDualRangeWarning(min, max);
    }

    minSlider.addEventListener('input', updateSliderRange);
    maxSlider.addEventListener('input', updateSliderRange);
    
    // ƒ∞lk deƒüerleri ayarla
    updateSliderRange();
}

// =============================================================================
// üéØ SEPARATE RANGE SLIDERS - Enhanced Dual Range System
// =============================================================================

/**
 * Initialize separate dual range sliders (enhanced system)
 */
function initializeSeparateRangeSliders() {
    const minSlider = document.getElementById('groupMinSlider');
    const maxSlider = document.getElementById('groupMaxSlider');
    const groupMinDisplay = document.getElementById('groupMinDisplay');
    const groupMaxDisplay = document.getElementById('groupMaxDisplay');
    const groupMinValue = document.getElementById('groupMinValue');
    const groupMaxValue = document.getElementById('groupMaxValue');
    
    if (!minSlider || !maxSlider) return;
    
    function updateSeparateRange() {
        let minVal = parseInt(minSlider.value);
        let maxVal = parseInt(maxSlider.value);
        
        // Auto-adjust logic: min can't be greater than max
        if (minSlider === document.activeElement && minVal > maxVal) {
            // If user is moving min slider and it goes past max, move max too
            maxVal = minVal;
            maxSlider.value = maxVal;
        } else if (maxSlider === document.activeElement && maxVal < minVal) {
            // If user is moving max slider and it goes below min, move min too
            minVal = maxVal;
            minSlider.value = minVal;
        }
        
        // Update all display elements
        if (groupMinDisplay) groupMinDisplay.textContent = minVal;
        if (groupMaxDisplay) groupMaxDisplay.textContent = maxVal;
        if (groupMinValue) groupMinValue.textContent = minVal;
        if (groupMaxValue) groupMaxValue.textContent = maxVal;
        
        // Update thermal colors
        updateThermalSliderColor(minSlider, minVal, 'group-min');
        updateThermalSliderColor(maxSlider, maxVal, 'group-max');
        
        // Update warnings
        updateDualRangeWarning(minVal, maxVal);
    }
    
    // Event listeners
    minSlider.addEventListener('input', updateSeparateRange);
    maxSlider.addEventListener('input', updateSeparateRange);
    
    // Initialize values
    updateSeparateRange();
}

/**
 * Update compact range slider colors based on value
 */
function updateCompactRangeColor(slider, value, type) {
    if (!slider) return;
    
    let color = '#4CAF50'; // Default green
    
    switch (type) {
        case 'term':
            // Blue gradient for term (1-8 range)
            const termFactor = (value - 1) / 7;
            color = interpolateColor('#2196F3', '#1976D2', termFactor);
            break;
            
        case 'final':
            // Green gradient for final (1-10 range)
            const finalFactor = (value - 1) / 9;
            color = interpolateColor('#4CAF50', '#2E7D32', finalFactor);
            break;
            
        case 'scoring':
            // Red to green gradient for scoring (0-100 range)
            const scoreFactor = value / 100;
            if (scoreFactor < 0.5) {
                color = interpolateColor('#F44336', '#FF9800', scoreFactor * 2);
            } else {
                color = interpolateColor('#FF9800', '#4CAF50', (scoreFactor - 0.5) * 2);
            }
            break;
            
        case 'group-min':
            // Cyan gradient for group min (1-20 range)
            const minFactor = (value - 1) / 19;
            color = interpolateColor('#00BCD4', '#0097A7', minFactor);
            break;
            
        case 'group-max':
            // Orange gradient for group max (1-20 range)
            const maxFactor = (value - 1) / 19;
            color = interpolateColor('#FF9800', '#F57C00', maxFactor);
            break;
    }
    
    // Apply color to slider track
    const percent = ((value - slider.min) / (slider.max - slider.min)) * 100;
    slider.style.background = `linear-gradient(to right, ${color} 0%, ${color} ${percent}%, #e0e0e0 ${percent}%, #e0e0e0 100%)`;
}

// =============================================================================
// üõ°Ô∏è G√úVENLƒ∞K FONKSƒ∞YONLARI - Eksik fonksiyonlar i√ßin fallback
// =============================================================================

/**
 * Not g√∂r√ºn√ºmlerini g√ºncelle - Ana fonksiyon
 */
function updateGradeDisplays() {
    try {
        // √ñƒürenci not tablosunu g√ºncelle
        if (typeof updateStudentGradesTable === 'function') {
            updateStudentGradesTable();
        }
        
        // Genel istatistikleri g√ºncelle
        updateModernStats();
        
        // Not giri≈üi alanlarƒ±nƒ± g√ºncelle
        const gradeInputs = document.querySelectorAll('input[type="number"][data-student-id]');
        gradeInputs.forEach(input => {
            const studentId = input.dataset.studentId;
            const activityId = input.dataset.activityId; // componentId deƒüil activityId kullan
            
            if (activityId) {
                const grade = getStudentGrade(studentId, activityId);
                if (grade !== null && grade !== undefined) {
                    input.value = grade;
                }
            }
        });
        
        // Pass/Fail oranlarƒ±nƒ± g√ºncelle
        if (typeof updatePassFailCounts === 'function') {
            updatePassFailCounts();
        }
        
        console.log('‚úÖ Not g√∂r√ºn√ºmleri g√ºncellendi');
    } catch (error) {
        console.error('‚ùå Not g√∂r√ºn√ºmleri g√ºncellenirken hata:', error);
        showModernToast('Not g√∂r√ºn√ºmleri g√ºncellenirken hata olu≈ütu!', 'error');
    }
}

console.log('üõ°Ô∏è G√ºvenlik fonksiyonlarƒ± y√ºklendi');

// GUID sistemi tamamen kaldƒ±rƒ±ldƒ±

// =============================================================================
// üåà RAINBOW THERMAL SLIDER SYSTEM
// =============================================================================

/**
 * Rainbow thermal slider'larƒ± ba≈ülat
 */
function initializeRainbowSliders() {
    // Yarƒ±yƒ±l i√ßi slider
    const termSlider = document.getElementById('termComponentsSlider');
    const termValue = document.getElementById('termComponentsValue');
    
    if (termSlider && termValue) {
        termSlider.addEventListener('input', function() {
            termValue.textContent = this.value;
            updateRainbowSliderThumb(termSlider, this.value, 'term');
        });
        // ƒ∞lk deƒüeri ayarla
        updateRainbowSliderThumb(termSlider, termSlider.value, 'term');
    }
    
    // Yarƒ±yƒ±l sonu slider
    const finalSlider = document.getElementById('finalComponentsSlider');
    const finalValue = document.getElementById('finalComponentsValue');
    
    if (finalSlider && finalValue) {
        finalSlider.addEventListener('input', function() {
            finalValue.textContent = this.value;
            updateRainbowSliderThumb(finalSlider, this.value, 'final');
        });
        // ƒ∞lk deƒüeri ayarla
        updateRainbowSliderThumb(finalSlider, finalSlider.value, 'final');
    }
    
    // Pass rate slider
    const passRateSlider = document.getElementById('passRateSlider');
    const passRateValue = document.getElementById('passRateValue');
    const passRateDisplay = document.getElementById('passRateDisplay');
    const failRateDisplay = document.getElementById('failRateDisplay');
    
    if (passRateSlider && passRateValue) {
        passRateSlider.addEventListener('input', function() {
            const value = parseInt(this.value);
            const failValue = 100 - value;
            
            // T√ºm display'leri g√ºncelle
            passRateValue.textContent = `${value}%`;
            if (passRateDisplay) passRateDisplay.textContent = `${value}%`;
            if (failRateDisplay) failRateDisplay.textContent = `${failValue}%`;
            
            updateRainbowSliderThumb(passRateSlider, value, 'score');
            updatePassRateIndicators();
            updatePassFailCounts(); // Status badge'leri g√ºncelle
        });
        // ƒ∞lk deƒüeri ayarla
        updateRainbowSliderThumb(passRateSlider, passRateSlider.value, 'score');
    }
    
    // Grup slider'larƒ± - Geli≈ütirilmi≈ü versiyon
    // Term slider'larƒ±
    const termActivityCountSlider = document.getElementById('termActivityCountSlider');
    const termActivityCountValue = document.getElementById('termActivityCountValue');
    const termComponentsSlider = document.getElementById('termComponentsSlider');
    const termComponentsValue = document.getElementById('termComponentsValue');
    
    // Final slider'larƒ±
    const finalActivityCountSlider = document.getElementById('finalActivityCountSlider');
    const finalActivityCountValue = document.getElementById('finalActivityCountValue');
    const finalComponentsSlider = document.getElementById('finalComponentsSlider');
    const finalComponentsValue = document.getElementById('finalComponentsValue');
    
    // Grup slider'larƒ±
    const groupMinSlider = document.getElementById('groupMinSlider');
    const groupMaxSlider = document.getElementById('groupMaxSlider');
    const groupMinValue = document.getElementById('groupMinValue');
    const groupMaxValue = document.getElementById('groupMaxValue');
    
    if (groupMinSlider && groupMinValue && groupMaxSlider && groupMaxValue) {
        // √ñnceki event listener'larƒ± temizle
        const newMinSlider = groupMinSlider.cloneNode(true);
        const newMaxSlider = groupMaxSlider.cloneNode(true);
        groupMinSlider.parentNode.replaceChild(newMinSlider, groupMinSlider);
        groupMaxSlider.parentNode.replaceChild(newMaxSlider, groupMaxSlider);
        
        // Yeni referanslarƒ± al
        const minSlider = document.getElementById('groupMinSlider');
        const maxSlider = document.getElementById('groupMaxSlider');
        
        function updateGroupSliders() {
            let minVal = parseInt(minSlider.value);
            let maxVal = parseInt(maxSlider.value);
            
            // Sƒ±nƒ±r kontrol√º
            const studentCount = APP_STATE.studentData ? APP_STATE.studentData.length : 0;
            const maxAllowed = studentCount > 0 ? Math.max(studentCount, 20) : 20;
            
            minVal = Math.max(1, Math.min(minVal, maxAllowed));
            maxVal = Math.max(1, Math.min(maxVal, maxAllowed));
            
            // Min > Max kontrol√º
            if (minVal > maxVal) {
                if (minSlider === document.activeElement) {
                maxVal = minVal;
                } else {
                    minVal = maxVal;
                }
            }
            
            // Deƒüerleri g√ºncelle
            minSlider.value = minVal;
            maxSlider.value = maxVal;
            groupMinValue.textContent = minVal;
            groupMaxValue.textContent = maxVal;
            
            // Slider renklerini g√ºncelle
            updateRainbowSliderThumb(minSlider, minVal, 'group-min');
            updateRainbowSliderThumb(maxSlider, maxVal, 'group-max');
            
            // Uyarƒ±larƒ± g√ºncelle
            if (typeof updateDualRangeWarning === 'function') {
            updateDualRangeWarning(minVal, maxVal);
            }
            
            console.log(`üéØ Grup slider'larƒ± g√ºncellendi: Min=${minVal}, Max=${maxVal}, √ñƒürenci=${studentCount}`);
        }
        
        // Event listener'larƒ± ekle
        minSlider.addEventListener('input', updateGroupSliders);
        maxSlider.addEventListener('input', updateGroupSliders);
        
        // ƒ∞lk deƒüerleri ayarla
        updateGroupSliders();
    }
    
    // Term Activity Count Slider
    if (termActivityCountSlider && termActivityCountValue) {
        termActivityCountSlider.addEventListener('input', function() {
            const value = parseInt(this.value);
            termActivityCountValue.textContent = value;
            updateRainbowSliderThumb(termActivityCountSlider, value, 'term-activity');
        });
        // ƒ∞lk deƒüeri ayarla
        updateRainbowSliderThumb(termActivityCountSlider, termActivityCountSlider.value, 'term-activity');
    }
    
    // Term Components Slider
    if (termComponentsSlider && termComponentsValue) {
        termComponentsSlider.addEventListener('input', function() {
            const value = parseInt(this.value);
            termComponentsValue.textContent = value;
            updateRainbowSliderThumb(termComponentsSlider, value, 'term');
        });
        // ƒ∞lk deƒüeri ayarla
        updateRainbowSliderThumb(termComponentsSlider, termComponentsSlider.value, 'term');
    }
    
    // Final Activity Count Slider
    if (finalActivityCountSlider && finalActivityCountValue) {
        finalActivityCountSlider.addEventListener('input', function() {
            const value = parseInt(this.value);
            finalActivityCountValue.textContent = value;
            updateRainbowSliderThumb(finalActivityCountSlider, value, 'final-activity');
        });
        // ƒ∞lk deƒüeri ayarla
        updateRainbowSliderThumb(finalActivityCountSlider, finalActivityCountSlider.value, 'final-activity');
    }
    
    // Final Components Slider
    if (finalComponentsSlider && finalComponentsValue) {
        finalComponentsSlider.addEventListener('input', function() {
            const value = parseInt(this.value);
            finalComponentsValue.textContent = value;
            updateRainbowSliderThumb(finalComponentsSlider, value, 'final');
        });
        // ƒ∞lk deƒüeri ayarla
        updateRainbowSliderThumb(finalComponentsSlider, finalComponentsSlider.value, 'final');
    }
    
    console.log('üåà Rainbow thermal slider\'lar ba≈ülatƒ±ldƒ±');
}

/**
 * Dual range uyarƒ±larƒ±nƒ± g√ºncelle
 */
function updateDualRangeWarning(minVal, maxVal) {
    // Grup sayƒ±sƒ± uyarƒ±larƒ± i√ßin basit kontrol
    const studentCount = APP_STATE.studentData ? APP_STATE.studentData.length : 0;
    
    if (studentCount > 0) {
        if (minVal > studentCount) {
            console.warn(`‚ö†Ô∏è Min grup sayƒ±sƒ± (${minVal}) √∂ƒürenci sayƒ±sƒ±ndan (${studentCount}) fazla`);
        }
        if (maxVal > studentCount) {
            console.warn(`‚ö†Ô∏è Max grup sayƒ±sƒ± (${maxVal}) √∂ƒürenci sayƒ±sƒ±ndan (${studentCount}) fazla`);
        }
    }
    
    if (minVal === maxVal) {
        console.log(`‚ÑπÔ∏è Sabit grup sayƒ±sƒ±: ${minVal}`);
    } else {
        console.log(`‚ÑπÔ∏è Grup aralƒ±ƒüƒ±: ${minVal}-${maxVal}`);
    }
}

/**
 * Rainbow slider thumb rengini g√ºncelle
 */
function updateRainbowSliderThumb(slider, value, type) {
    if (!slider) return;
    
    let color = '#007bff'; // Default blue
    
    switch (type) {
        case 'term':
            // Blue to Red gradient for term (1-8 range)
            const termFactor = (value - 1) / 7;
            color = interpolateRainbowColor([
                '#4a90e2', '#50c878', '#ffd700', '#ff8c00', '#ff4500'
            ], termFactor);
            break;
            
        case 'final':
            // Cyan to Red gradient for final (1-10 range)
            const finalFactor = (value - 1) / 9;
            color = interpolateRainbowColor([
                '#00bcd4', '#4caf50', '#8bc34a', '#ffeb3b', '#ff9800', '#f44336'
            ], finalFactor);
            break;
            
        case 'score':
            // Red to Green gradient for scoring (0-100 range)
            const scoreFactor = value / 100;
            color = interpolateRainbowColor([
                '#f44336', '#ff5722', '#ff9800', '#ffc107', '#8bc34a', '#4caf50'
            ], scoreFactor);
            break;
            
        case 'group-min':
            // Pink to Blue gradient for group min (1-20 range)
            const minFactor = (value - 1) / 19;
            color = interpolateRainbowColor([
                '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3'
            ], minFactor);
            break;
            
        case 'group-max':
            // Orange to Purple gradient for group max (1-20 range)
            const maxFactor = (value - 1) / 19;
            color = interpolateRainbowColor([
                '#ff9800', '#ff5722', '#f44336', '#e91e63', '#9c27b0'
            ], maxFactor);
            break;
            
        case 'term-activity':
            // Blue to Green gradient for term activity (1-100 range)
            const termActivityFactor = (value - 1) / 99;
            color = interpolateRainbowColor([
                '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50', '#8bc34a'
            ], termActivityFactor);
            break;
            
        case 'final-activity':
            // Purple to Cyan gradient for final activity (1-100 range)
            const finalActivityFactor = (value - 1) / 99;
            color = interpolateRainbowColor([
                '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4'
            ], finalActivityFactor);
            break;
    }
    
    // Thumb rengini g√ºncelle
    slider.style.setProperty('--thumb-color', color);
    
    // CSS custom property ile thumb rengini ayarla
    const style = document.createElement('style');
    style.textContent = `
        #${slider.id}::-webkit-slider-thumb {
            border-color: ${color} !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2), 0 0 0 1px ${color} !important;
        }
        #${slider.id}::-moz-range-thumb {
            border-color: ${color} !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2), 0 0 0 1px ${color} !important;
        }
    `;
    
    // Eski style'ƒ± kaldƒ±r ve yenisini ekle
    const oldStyle = document.getElementById(`${slider.id}-style`);
    if (oldStyle) oldStyle.remove();
    
    style.id = `${slider.id}-style`;
    document.head.appendChild(style);
}

/**
 * Rainbow renk interpolasyonu
 */
function interpolateRainbowColor(colors, factor) {
    if (factor <= 0) return colors[0];
    if (factor >= 1) return colors[colors.length - 1];
    
    const scaledFactor = factor * (colors.length - 1);
    const index = Math.floor(scaledFactor);
    const nextIndex = Math.min(index + 1, colors.length - 1);
    const localFactor = scaledFactor - index;
    
    return interpolateColor(colors[index], colors[nextIndex], localFactor);
}

/**
 * Pass rate indicator'larƒ±nƒ± g√ºncelle
 */
// ƒ∞kinci updatePassRateIndicators fonksiyonu kaldƒ±rƒ±ldƒ± - geli≈ümi≈ü versiyon korundu

// DOMContentLoaded event'inde rainbow slider'larƒ± ba≈ülat
document.addEventListener('DOMContentLoaded', function() {
    // Diƒüer ba≈ülatma i≈ülemlerinden sonra rainbow slider'larƒ± ba≈ülat
    setTimeout(() => {
        initializeRainbowSliders();
    }, 100);
});

// =====================================================
// AƒûIRLIK DENGELEME Sƒ∞STEMƒ∞
// =====================================================

/**
 * Yarƒ±yƒ±l i√ßi etkinliklerin aƒüƒ±rlƒ±klarƒ±nƒ± dengeler
 */
function balanceTermWeights() {
    try {
        const termActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('A'));
        
        if (termActivities.length === 0) return;
        
        console.log(`‚öñÔ∏è ${termActivities.length} yarƒ±yƒ±l i√ßi etkinliƒüin aƒüƒ±rlƒ±klarƒ± dengeleniyor...`);
        
        // E≈üit aƒüƒ±rlƒ±k daƒüƒ±lƒ±mƒ±
        const baseWeight = Math.floor(100 / termActivities.length);
        const remainder = 100 - (baseWeight * termActivities.length);
        
        termActivities.forEach((activity, index) => {
            const oldWeight = activity.weight;
            const newWeight = baseWeight + (index < remainder ? 1 : 0);
            activity.weight = newWeight;
            console.log(`  üìä ${activity.id} (${activity.name}): ${oldWeight}% ‚Üí ${newWeight}%`);
        });
        
        // Aray√ºz√º g√ºncelle
        renderTree();
        updateCategoryWeights();
        updateAssessmentView(); 
        
        console.log(`‚úÖ Yarƒ±yƒ±l i√ßi aƒüƒ±rlƒ±k dengeleme tamamlandƒ±`);
        
    } catch (error) {
        console.error('‚ùå Yarƒ±yƒ±l i√ßi aƒüƒ±rlƒ±k dengeleme hatasƒ±:', error);
    }
}

/**
 * Yarƒ±yƒ±l sonu etkinliklerin aƒüƒ±rlƒ±klarƒ±nƒ± dengeler
 */
function balanceFinalWeights() {
    try {
        const finalActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('F'));
        
        if (finalActivities.length === 0) return;
        
        console.log(`‚öñÔ∏è ${finalActivities.length} yarƒ±yƒ±l sonu etkinliƒüin aƒüƒ±rlƒ±klarƒ± dengeleniyor...`);
        
        // E≈üit aƒüƒ±rlƒ±k daƒüƒ±lƒ±mƒ±
        const baseWeight = Math.floor(100 / finalActivities.length);
        const remainder = 100 - (baseWeight * finalActivities.length);
        
        finalActivities.forEach((activity, index) => {
            const oldWeight = activity.weight;
            const newWeight = baseWeight + (index < remainder ? 1 : 0);
            activity.weight = newWeight;
            console.log(`  üìä ${activity.id} (${activity.name}): ${oldWeight}% ‚Üí ${newWeight}%`);
        });
        
        // Aray√ºz√º g√ºncelle
        renderTree();
        updateCategoryWeights();
        // Deƒüerlendirme sekmesini g√ºncelle - CRITICAL SYNC
        updateAssessmentView();
        console.log(`‚úÖ Yarƒ±yƒ±l sonu aƒüƒ±rlƒ±k dengeleme tamamlandƒ±`);
        
    } catch (error) {
        console.error('‚ùå Yarƒ±yƒ±l sonu aƒüƒ±rlƒ±k dengeleme hatasƒ±:', error);
    }
}

// =============================================================================
// HIZLI AƒûIRLIK D√úZELTƒ∞Cƒ∞ - CONSOLE ƒ∞√áƒ∞N KULLANIM
// =============================================================================

/**
 * Mevcut aƒüƒ±rlƒ±klarƒ± hƒ±zlƒ±ca d√ºzeltir
 * Console'da √ßalƒ±≈ütƒ±rmak i√ßin: quickFixWeights()
 */
function quickFixWeights() {
    console.log('üîß Mevcut aƒüƒ±rlƒ±klarƒ± d√ºzeltiliyor...');
    
    // Yarƒ±yƒ±l i√ßi aƒüƒ±rlƒ±klarƒ±nƒ± dengele
    const termActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('A'));
    if (termActivities.length > 0) {
        const baseWeight = Math.floor(100 / termActivities.length);
        const remainder = 100 - (baseWeight * termActivities.length);
        
        termActivities.forEach((activity, index) => {
            const oldWeight = activity.weight;
            const newWeight = baseWeight + (index < remainder ? 1 : 0);
            activity.weight = newWeight;
            console.log(`  üìä Yarƒ±yƒ±l ƒ∞√ßi ${activity.id}: ${oldWeight}% ‚Üí ${newWeight}%`);
        });
    }
    
    // Yarƒ±yƒ±l sonu aƒüƒ±rlƒ±klarƒ±nƒ± dengele
    const finalActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('F'));
    if (finalActivities.length > 0) {
        const baseWeight = Math.floor(100 / finalActivities.length);
        const remainder = 100 - (baseWeight * finalActivities.length);
        
        finalActivities.forEach((activity, index) => {
            const oldWeight = activity.weight;
            const newWeight = baseWeight + (index < remainder ? 1 : 0);
            activity.weight = newWeight;
            console.log(`  üìä Yarƒ±yƒ±l Sonu ${activity.id}: ${oldWeight}% ‚Üí ${newWeight}%`);
        });
    }
    
    // Aray√ºz√º g√ºncelle
    renderTree();
    updateCategoryWeights();
    // Deƒüerlendirme sekmesini g√ºncelle - CRITICAL SYNC
    updateAssessmentView();
    
    console.log('‚úÖ Aƒüƒ±rlƒ±k dengeleme tamamlandƒ±!');
    showModernToast('üîß Mevcut aƒüƒ±rlƒ±klar d√ºzeltildi!', 'success', 3000);
}

/**
 * Toast sistemini test et
 */
function testToastSystem() {
    console.log('üß™ Toast sistemi test ediliyor...');
    
    // Toast elementinin varlƒ±ƒüƒ±nƒ± kontrol et
    const toastElement = document.getElementById('modernToast');
    const messageElement = document.getElementById('modernToastMessage');
    
    if (!toastElement) {
        console.error('‚ùå modernToast elementi bulunamadƒ±!');
        return;
    }
    
    if (!messageElement) {
        console.error('‚ùå modernToastMessage elementi bulunamadƒ±!');
        return;
    }
    
    console.log('‚úÖ Toast elementleri bulundu');
    console.log('Toast element:', toastElement);
    console.log('Message element:', messageElement);
    
    // Test mesajlarƒ± g√∂nder
    setTimeout(() => {
        console.log('üî• Success toast g√∂nderiliyor...');
        showModernToast('Test ba≈üarƒ±lƒ± mesajƒ±!', 'success', 3000);
    }, 1000);
    
    setTimeout(() => {
        console.log('‚ö†Ô∏è Warning toast g√∂nderiliyor...');
        showModernToast('Test uyarƒ± mesajƒ±!', 'warning', 3000);
    }, 2000);
    
    setTimeout(() => {
        console.log('‚ùå Error toast g√∂nderiliyor...');
        showModernToast('Test hata mesajƒ±!', 'error', 3000);
    }, 3000);
}


/**
 * v5 formatƒ± i√ßin grup deƒüi≈üikliƒüi i≈üleme - √∂ƒürenci grup deƒüi≈ütirdiƒüinde √ßaƒürƒ±lƒ±r
 */
function handleGroupChangeV5(studentId, componentId, newGroupId) {
    console.log(`üîÑ v5 Grup deƒüi≈üikliƒüi - √ñƒürenci: ${studentId}, Bile≈üen: ${componentId}, Yeni Grup: ${newGroupId}`);
    
    try {
        // v5 formatƒ±nda grup bilgisini g√ºncelle
        if (!APP_STATE.studentComponentGroups) APP_STATE.studentComponentGroups = {};
        if (!APP_STATE.studentComponentGroups[studentId]) APP_STATE.studentComponentGroups[studentId] = {};
        
        APP_STATE.studentComponentGroups[studentId][componentId] = newGroupId;
        
        // gradesData'daki grup bilgilerini de g√ºncelle
        if (!APP_STATE.gradesData[studentId]) APP_STATE.gradesData[studentId] = {};
        if (!APP_STATE.gradesData[studentId].grupBilgileri) APP_STATE.gradesData[studentId].grupBilgileri = {};
        
        APP_STATE.gradesData[studentId].grupBilgileri[componentId] = newGroupId;
        
        // UI'ƒ± g√ºncelle
        updateStudentCalculatedGrade(studentId);
        updateAssessmentGradeSummary(studentId);
        updateStudentSummary(studentId);
        
        console.log(`‚úÖ v5 Grup bilgisi g√ºncellendi: ${studentId} ‚Üí ${componentId} ‚Üí ${newGroupId}`);
        
    } catch (error) {
        console.error("v5 grup deƒüi≈üikliƒüi i≈ülenirken hata olu≈ütu:", error);
    }
}

// =============================================================================
// PUAN TEST ƒ∞≈ûLEMLERƒ∞ - PUANLARI E≈ûƒ∞TLEME VE KARI≈ûTIRMA
// =============================================================================

/**
 * T√ºm soru ve rubrik puanlarƒ±nƒ± e≈üitler
 * Deƒüerlendirme unsurlarƒ±ndaki t√ºm sorular ve rubrikler e≈üit puan alƒ±r
 * √ñZEL: Sƒ±nav toplamƒ±nƒ±n 100 olmasƒ±nƒ± garanti eder
 */
function equalizeAllPoints() {
    try {
        console.log('‚öñÔ∏è T√ºm puanlar e≈üitleniyor...');
        
        let totalChanges = 0;
        let totalActivities = 0;
        
        // T√ºm etkinlikleri gez
        APP_STATE.assessmentTree.forEach(activity => {
            if (activity.children && activity.children.length > 0) {
                console.log(`üìù ${activity.name} etkinliƒüi i≈üleniyor...`);
                
                // Etkinliƒüin toplam puanƒ±nƒ± al
                const activityTotalPoints = activity.points || 100;
                const itemCount = activity.children.length;
                
                if (itemCount > 0) {
                    // Mevcut puanlarƒ± kontrol et
                    const currentPoints = activity.children.map(item => item.points || 0);
                    const allPointsSame = currentPoints.every(point => point === currentPoints[0]);
                    
                    // Sadece puanlar farklƒ±ysa e≈üitle
                    if (!allPointsSame || currentPoints[0] !== Math.floor(activityTotalPoints / itemCount)) {
                        // E≈üit daƒüƒ±lƒ±m hesapla
                        const equalPoints = Math.floor(activityTotalPoints / itemCount);
                        const remainder = activityTotalPoints - (equalPoints * itemCount);
                        
                        console.log(`  üî¢ Toplam puan: ${activityTotalPoints}, √ñƒüe sayƒ±sƒ±: ${itemCount}, E≈üit puan: ${equalPoints}, Kalan: ${remainder}`);
                        console.log(`  üìä Mevcut daƒüƒ±lƒ±m: [${currentPoints.join(', ')}]`);
                        
                        let activityChanges = 0;
                        // Her soru/rubriƒüe e≈üit puan ver
                        activity.children.forEach((item, index) => {
                            const oldPoints = item.points;
                            // ƒ∞lk 'remainder' kadar √∂ƒüeye 1 fazla puan ver
                            const newPoints = equalPoints + (index < remainder ? 1 : 0);
                            
                            if (oldPoints !== newPoints) {
                                item.points = newPoints;
                                totalChanges++;
                                activityChanges++;
                                console.log(`    üîÑ ${item.name}: ${oldPoints} ‚Üí ${newPoints} puan`);
                            }
                        });
                        
                        if (activityChanges > 0) {
                            totalActivities++;
                        }
                        
                        // ‚úÖ TOPLAM KONTROL: Etkinlik toplamƒ±nƒ±n doƒüru olduƒüunu kontrol et
                        const calculatedTotal = activity.children.reduce((sum, item) => sum + (item.points || 0), 0);
                        if (calculatedTotal !== activityTotalPoints) {
                            console.warn(`‚ö†Ô∏è TOPLAM PUAN HATASI: ${activity.name} - Hedef: ${activityTotalPoints}, Hesaplanan: ${calculatedTotal}`);
                            
                            // Son √∂ƒüeye farkƒ± ekle/√ßƒ±kar
                            const difference = activityTotalPoints - calculatedTotal;
                            if (activity.children.length > 0) {
                                const lastItem = activity.children[activity.children.length - 1];
                                lastItem.points = (lastItem.points || 0) + difference;
                                console.log(`    üîß D√úZELTME: ${lastItem.name} puanƒ± ${difference > 0 ? '+' : ''}${difference} ayarlandƒ± ‚Üí ${lastItem.points}`);
                            }
                        }
                        
                        // ‚úÖ KONTROL: Nihai toplam doƒürulama
                        const finalTotal = activity.children.reduce((sum, item) => sum + (item.points || 0), 0);
                        const finalPoints = activity.children.map(item => item.points || 0);
                        console.log(`    ‚úÖ Nihai Kontrol: ${activity.name} toplam = ${finalTotal} (Hedef: ${activityTotalPoints})`);
                        console.log(`    üìä Yeni daƒüƒ±lƒ±m: [${finalPoints.join(', ')}]`);
                    } else {
                        console.log(`  ‚úÖ ${activity.name} puanlarƒ± zaten e≈üit (${currentPoints[0]} puan)`);
                    }
                }
            }
        });
        
        if (totalChanges > 0) {
            // Aray√ºz√º g√ºncelle
            renderTree();
            updateCategoryWeights();
            // Deƒüerlendirme sekmesini g√ºncelle - CRITICAL SYNC
            updateAssessmentView();
            
            console.log(`‚úÖ Puan e≈üitleme tamamlandƒ±. ${totalActivities} etkinlikte ${totalChanges} deƒüi≈üiklik yapƒ±ldƒ±.`);
            showModernToast(`‚öñÔ∏è ${totalActivities} etkinlikte ${totalChanges} soru/rubrik puanƒ± e≈üitlendi! Toplam puan korundu.`, 'success', 3000);
        } else {
            console.log('‚ÑπÔ∏è E≈üitlenecek puan bulunamadƒ±.');
            showModernToast('‚ÑπÔ∏è T√ºm puanlar zaten e≈üit durumda!', 'info', 3000);
        }
        
    } catch (error) {
        console.error('‚ùå Puan e≈üitleme hatasƒ±:', error);
        showModernToast('‚ùå Puan e≈üitleme sƒ±rasƒ±nda hata olu≈ütu!', 'error', 3000);
    }
}

/**
 * T√ºm soru ve rubrik puanlarƒ±nƒ± karƒ±≈ütƒ±rƒ±r
 * Mevcut puanlarƒ± alƒ±r ve rastgele olarak yeniden daƒüƒ±tƒ±r
 */
function shuffleAllPoints() {
    try {
        console.log('üé≤ T√ºm puanlar karƒ±≈ütƒ±rƒ±lƒ±yor...');
        
        // Debug: Aƒüa√ß durumunu kontrol et
        console.log('üîç DEBUG: APP_STATE.assessmentTree durumu:', APP_STATE.assessmentTree);
        console.log('üîç DEBUG: Aƒüa√ß uzunluƒüu:', APP_STATE.assessmentTree.length);
        
        if (!APP_STATE.assessmentTree || APP_STATE.assessmentTree.length === 0) {
            console.warn('‚ö†Ô∏è Deƒüerlendirme aƒüacƒ± bo≈ü veya tanƒ±msƒ±z!');
            showModernToast('‚ö†Ô∏è √ñnce deƒüerlendirme kriterleri olu≈üturun!', 'warning', 3000);
            return;
        }
        
        let totalChanges = 0;
        let totalShuffles = 0;
        
        // T√ºm etkinlikleri gez
        APP_STATE.assessmentTree.forEach((activity, actIndex) => {
            console.log(`üîç DEBUG: ${actIndex}. etkinlik inceleniyor:`, activity);
            if (activity.children && activity.children.length > 1) {
                console.log(`üìù ${activity.name} etkinliƒüi i≈üleniyor...`);
                
                // Mevcut puanlarƒ± topla
                const currentPoints = activity.children.map(item => item.points || 0);
                const originalPoints = [...currentPoints]; // Orijinal sƒ±rayƒ± koru
                
                // Eƒüer t√ºm puanlar aynƒ±ysa, √∂nce farklƒ± puanlar ata
                const allPointsSame = currentPoints.every(point => point === currentPoints[0]);
                if (allPointsSame && currentPoints.length > 1) {
                    console.log(`  ‚ö†Ô∏è T√ºm puanlar aynƒ± (${currentPoints[0]}), √∂nce farklƒ± puanlar atanƒ±yor...`);
                    
                    // Toplam puanƒ± koru
                    const totalPoints = currentPoints.reduce((sum, point) => sum + point, 0);
                    const itemCount = currentPoints.length;
                    
                    // Farklƒ± puanlar olu≈ütur (minimum 1 puan)
                    const newPoints = [];
                    let remainingPoints = totalPoints;
                    
                    for (let i = 0; i < itemCount - 1; i++) {
                        // Her √∂ƒüeye rastgele puan ver (1 ile kalan puanƒ±n yarƒ±sƒ± arasƒ±nda)
                        const maxForThis = Math.max(1, Math.floor(remainingPoints / (itemCount - i) * 1.5));
                        const minForThis = Math.max(1, Math.floor(remainingPoints / (itemCount - i) * 0.5));
                        const randomPoints = Math.floor(Math.random() * (maxForThis - minForThis + 1)) + minForThis;
                        
                        newPoints.push(Math.min(randomPoints, remainingPoints - (itemCount - i - 1)));
                        remainingPoints -= newPoints[i];
                    }
                    
                    // Son √∂ƒüeye kalan puanƒ± ver
                    newPoints.push(Math.max(1, remainingPoints));
                    
                    // Yeni puanlarƒ± ata
                    currentPoints.splice(0, currentPoints.length, ...newPoints);
                    console.log(`  üéØ Farklƒ± puanlar atandƒ±: [${currentPoints.join(', ')}]`);
                }
                
                // Puanlarƒ± karƒ±≈ütƒ±r (Fisher-Yates shuffle algoritmasƒ±)
                for (let i = currentPoints.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [currentPoints[i], currentPoints[j]] = [currentPoints[j], currentPoints[i]];
                }
                
                console.log(`  üîÑ Orijinal: [${originalPoints.join(', ')}] ‚Üí Karƒ±≈ütƒ±rƒ±lmƒ±≈ü: [${currentPoints.join(', ')}]`);
                
                // Karƒ±≈ütƒ±rƒ±lan puanlarƒ± ata
                let activityChanges = 0;
                activity.children.forEach((item, index) => {
                    const oldPoints = item.points;
                    const newPoints = currentPoints[index];
                    
                    if (oldPoints !== newPoints) {
                        item.points = newPoints;
                        totalChanges++;
                        activityChanges++;
                        console.log(`    üéØ ${item.name}: ${oldPoints} ‚Üí ${newPoints} puan`);
                    }
                });
                
                if (activityChanges > 0) {
                    totalShuffles++;
                }
            } else if (activity.children && activity.children.length === 1) {
                console.log(`  ‚ö†Ô∏è ${activity.name} etkinliƒüinde tek √∂ƒüe var, karƒ±≈ütƒ±rƒ±lamaz.`);
            }
        });
        
        if (totalChanges > 0) {
            // Aray√ºz√º g√ºncelle
            renderTree();
            updateCategoryWeights();
            // Deƒüerlendirme sekmesini g√ºncelle - CRITICAL SYNC
            updateAssessmentView();
            // Deƒüerlendirme tablolarƒ±nƒ± g√ºncelle
            
            console.log(`‚úÖ Puan karƒ±≈ütƒ±rma tamamlandƒ±. ${totalShuffles} etkinlikte ${totalChanges} deƒüi≈üiklik yapƒ±ldƒ±.`);
            showModernToast(`üé≤ ${totalShuffles} etkinlikte ${totalChanges} soru/rubrik puanƒ± karƒ±≈ütƒ±rƒ±ldƒ±!`, 'success', 3000);
        } else {
            console.log('‚ÑπÔ∏è Karƒ±≈ütƒ±rƒ±lacak puan bulunamadƒ±.');
            showModernToast('‚ÑπÔ∏è Karƒ±≈ütƒ±rƒ±lacak √ßoklu puan bulunamadƒ±!', 'info', 3000);
        }
        
    } catch (error) {
        console.error('‚ùå Puan karƒ±≈ütƒ±rma hatasƒ±:', error);
        showModernToast('‚ùå Puan karƒ±≈ütƒ±rma sƒ±rasƒ±nda hata olu≈ütu!', 'error', 3000);
    }
}

/**
 * Belirli bir etkinlikteki puanlarƒ± e≈üitler
 * @param {string} activityId - Etkinlik ID'si
 */
function equalizeActivityPoints(activityId) {
    try {
        const activity = findNodeById(activityId);
        if (!activity || !activity.children || activity.children.length === 0) {
            console.warn(`‚ö†Ô∏è ${activityId} etkinliƒüi bulunamadƒ± veya alt √∂ƒüesi yok.`);
            return;
        }
        
        console.log(`‚öñÔ∏è ${activity.name} etkinliƒüinin puanlarƒ± e≈üitleniyor...`);
        
        const activityTotalPoints = activity.points || 100;
        const itemCount = activity.children.length;
        const equalPoints = Math.floor(activityTotalPoints / itemCount);
        const remainder = activityTotalPoints - (equalPoints * itemCount);
        
        let changes = 0;
        activity.children.forEach((item, index) => {
            const oldPoints = item.points;
            const newPoints = equalPoints + (index < remainder ? 1 : 0);
            
            if (oldPoints !== newPoints) {
                item.points = newPoints;
                changes++;
                console.log(`  üîÑ ${item.name}: ${oldPoints} ‚Üí ${newPoints} puan`);
            }
        });
        
        if (changes > 0) {
            renderTree();

            // Deƒüerlendirme sekmesini g√ºncelle - CRITICAL SYNC
            updateAssessmentView();
            console.log(`‚úÖ ${activity.name} etkinliƒüinde ${changes} puan e≈üitlendi.`);
            showModernToast(`‚öñÔ∏è ${activity.name} puanlarƒ± e≈üitlendi!`, 'success', 2000);
        }
        
    } catch (error) {
        console.error('‚ùå Etkinlik puan e≈üitleme hatasƒ±:', error);
    }
}

/**
 * Belirli bir etkinlikteki puanlarƒ± karƒ±≈ütƒ±rƒ±r
 * @param {string} activityId - Etkinlik ID'si
 */
function shuffleActivityPoints(activityId) {
    try {
        const activity = findNodeById(activityId);
        if (!activity || !activity.children || activity.children.length <= 1) {
            console.warn(`‚ö†Ô∏è ${activityId} etkinliƒüi bulunamadƒ± veya karƒ±≈ütƒ±rƒ±lacak yeterli √∂ƒüe yok.`);
            return;
        }
        
        console.log(`üé≤ ${activity.name} etkinliƒüinin puanlarƒ± karƒ±≈ütƒ±rƒ±lƒ±yor...`);
        
        const currentPoints = activity.children.map(item => item.points || 0);
        const originalPoints = [...currentPoints];
        
        // Fisher-Yates shuffle
        for (let i = currentPoints.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [currentPoints[i], currentPoints[j]] = [currentPoints[j], currentPoints[i]];
        }
        
        let changes = 0;
        activity.children.forEach((item, index) => {
            const oldPoints = item.points;
            const newPoints = currentPoints[index];
            
            if (oldPoints !== newPoints) {
                item.points = newPoints;
                changes++;
                console.log(`  üéØ ${item.name}: ${oldPoints} ‚Üí ${newPoints} puan`);
            }
        });
        
        if (changes > 0) {
            renderTree();
            // Deƒüerlendirme sekmesini g√ºncelle - CRITICAL SYNC
            updateAssessmentView();
            console.log(`‚úÖ ${activity.name} etkinliƒüinde ${changes} puan karƒ±≈ütƒ±rƒ±ldƒ±.`);
            showModernToast(`üé≤ ${activity.name} puanlarƒ± karƒ±≈ütƒ±rƒ±ldƒ±!`, 'success', 2000);
        }
        
    } catch (error) {
        console.error('‚ùå Etkinlik puan karƒ±≈ütƒ±rma hatasƒ±:', error);
    }
}

/**
 * Debug ama√ßlƒ± - mevcut aƒüa√ß yapƒ±sƒ±nƒ± ve puanlarƒ± konsola yazdƒ±rƒ±r
 */
function debugAssessmentTree() {
    console.log("üîç === AƒûA√á YAPISI DEBUG Bƒ∞LGƒ∞Sƒ∞ ===");
    console.log("Aƒüa√ß uzunluƒüu:", APP_STATE.assessmentTree?.length || 0);
    
    if (!APP_STATE.assessmentTree || APP_STATE.assessmentTree.length === 0) {
        console.log("‚ùå Aƒüa√ß bo≈ü veya tanƒ±msƒ±z!");
        return;
    }
    
    APP_STATE.assessmentTree.forEach((activity, index) => {
        console.log(`üìÅ ${index + 1}. ETKƒ∞NLƒ∞K: ${activity.name}`);
        console.log(`   ID: ${activity.id}`);
        console.log(`   Puan: ${activity.points}`);
        console.log(`   Alt √∂ƒüe sayƒ±sƒ±: ${activity.children?.length || 0}`);
        
        if (activity.children && activity.children.length > 0) {
            activity.children.forEach((child, childIndex) => {
                console.log(`   ‚îî‚îÄ‚îÄ ${childIndex + 1}. ${child.name}: ${child.points} puan`);
            });
            
            const totalChildPoints = activity.children.reduce((sum, child) => sum + (child.points || 0), 0);
            console.log(`   üìä Alt √∂ƒüe toplamƒ±: ${totalChildPoints}`);
            
            const allSame = activity.children.every(child => child.points === activity.children[0].points);
            console.log(`   ‚öñÔ∏è T√ºm puanlar e≈üit mi: ${allSame ? "EVET" : "HAYIR"}`);
        }
    });
    
    console.log("üîç === DEBUG Bƒ∞LGƒ∞Sƒ∞ SONU ===");
}

// Konsola eri≈üim i√ßin global olarak ekle
window.debugAssessmentTree = debugAssessmentTree;


/**
 * T√ºm input alanlarƒ±na maksimum puan bilgisi ekleyen birle≈üik fonksiyon
 * Hem √ñƒürenci Notlarƒ± hem de Deƒüerlendirme Giri≈üi sekmelerinde √ßalƒ±≈üƒ±r
 */
function addMaxPointsToAllRows() {
    console.log('üîß Deƒüerlendirme Giri≈üi sekmesindeki input alanlarƒ±na maksimum puan bilgisi ekleniyor...');
    
    // Sadece Deƒüerlendirme Giri≈üi sekmesi i√ßin (assessment-table i√ßindeki input'lar)
    const assessmentInputs = document.querySelectorAll('.assessment-table input[type="number"]');
    console.log('üìä Assessment table input sayƒ±sƒ±:', assessmentInputs.length);
    
    assessmentInputs.forEach((input, index) => {
        const maxValue = parseFloat(input.max) || 0;
        
        if (maxValue > 0) {
            // Maksimum puan bilgisi spanini kontrol et/ekle
            let maxInfoSpan = input.parentElement.querySelector('.max-points-info');
            if (!maxInfoSpan) {
                maxInfoSpan = document.createElement('span');
                maxInfoSpan.className = 'max-points-info';
                maxInfoSpan.style.cssText = 'font-size: 10px; color: #666; margin-left: 5px; font-weight: bold; display: block;';
                input.parentElement.appendChild(maxInfoSpan);
            }
            
            maxInfoSpan.textContent = '(max: ' + maxValue + ')';
            console.log(`‚úÖ Assessment input ${index + 1}: max ${maxValue} eklendi`);
        }
    });
    
    console.log(`üèÅ Toplam ${assessmentInputs.length} input i√ßin maksimum puan bilgileri g√ºncellendi`);
}

// Global eri≈üim i√ßin
window.addMaxPointsToAllRows = addMaxPointsToAllRows;

/**
 * DOM deƒüi≈üikliklerini izleyerek yeni input alanlarƒ±na maksimum puan bilgisi ekleyen observer
 */
let maxPointsObserver = null;

function initMaxPointsObserver() {
    // √ñnceki observer'ƒ± temizle
    if (maxPointsObserver) {
        maxPointsObserver.disconnect();
    }
    
    // Yeni observer olu≈ütur
    maxPointsObserver = new MutationObserver((mutations) => {
        let hasNewInputs = false;
        
        mutations.forEach((mutation) => {
            // Yeni eklenen node'larƒ± kontrol et
            mutation.addedNodes.forEach((node) => {
                if (node.nodeType === Node.ELEMENT_NODE) {
                    // Assessment table i√ßindeki input elemanlarƒ±
                    if (node.matches && node.matches('.assessment-table input[type="number"]')) {
                        hasNewInputs = true;
                    }
                    // ƒ∞√ßinde assessment table input'larƒ± olan konteynerlar
                    else if (node.querySelectorAll) {
                        const inputs = node.querySelectorAll('.assessment-table input[type="number"]');
                        if (inputs.length > 0) {
                            hasNewInputs = true;
                        }
                    }
                }
            });
        });
        
        // Yeni input'lar varsa maksimum puan bilgilerini ekle
        if (hasNewInputs) {
            setTimeout(() => {
                addMaxPointsToAllRows();
            }, 50);
        }
    });
    
    // Observer'ƒ± ba≈ülat - assessmentContainer'ƒ± izle
    const container = document.getElementById('assessmentContainer');
    if (container) {
        maxPointsObserver.observe(container, {
            childList: true,
            subtree: true
        });
        console.log('üëÅÔ∏è Assessment container i√ßin maksimum puan observer ba≈ülatƒ±ldƒ±');
    } else {
        console.log('‚ö†Ô∏è assessmentContainer bulunamadƒ±, document.body izleniyor');
        // Fallback: t√ºm document body'yi izle
        maxPointsObserver.observe(document.body, {
            childList: true,
            subtree: true
        });
    }
}

// Global eri≈üim i√ßin
window.initMaxPointsObserver = initMaxPointsObserver;



// Maksimum puan observer'ƒ±nƒ± sayfa y√ºklendiƒüinde ba≈ülat
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Sayfa y√ºklendi, maksimum puan observer ba≈ülatƒ±lƒ±yor...');
    initMaxPointsObserver();
});

// Manual test fonksiyonlarƒ±
function testMaxPointsManually() {
    console.log('üß™ Manuel test ba≈ülatƒ±lƒ±yor...');
    
    // 1. Assessment Container kontrol
    const container = document.getElementById('assessmentContainer');
    console.log('üì¶ Assessment Container var mƒ±?', !!container);
    if (container) {
        console.log('üì¶ Assessment Container innerHTML uzunluƒüu:', container.innerHTML.length);
    }
    
    // 2. Assessment table input elemanlarƒ± kontrol
    const inputs = document.querySelectorAll('.assessment-table input[type="number"]');
    console.log('üéØ Assessment input sayƒ±sƒ±:', inputs.length);
    
    // 3. Maksimum puan fonksiyonunu zorla √ßaƒüƒ±r
    if (typeof addMaxPointsToAllRows === 'function') {
        console.log('‚úÖ addMaxPointsToAllRows fonksiyonu mevcut');
        addMaxPointsToAllRows();
    } else {
        console.log('‚ùå addMaxPointsToAllRows fonksiyonu mevcut deƒüil');
    }
    
    // 4. Observer'ƒ± zorla ba≈ülat
    if (typeof initMaxPointsObserver === 'function') {
        console.log('‚úÖ initMaxPointsObserver fonksiyonu mevcut');
        initMaxPointsObserver();
    } else {
        console.log('‚ùå initMaxPointsObserver fonksiyonu mevcut deƒüil');
    }
}

// Global eri≈üim i√ßin
window.testMaxPointsManually = testMaxPointsManually;



// Daha g√º√ßl√º DOM ready handler
function forceInitMaxPoints() {
    console.log('üöÄ Deƒüerlendirme Giri≈üi i√ßin maksimum puan ba≈ülatƒ±cƒ±sƒ± √ßalƒ±≈üƒ±yor...');
    
    // Observer'ƒ± ba≈ülat
    if (typeof initMaxPointsObserver === 'function') {
        initMaxPointsObserver();
    }
    
    // Hemen maksimum puanlarƒ± ekle
    if (typeof addMaxPointsToAllRows === 'function') {
        addMaxPointsToAllRows();
    }
    
    // 2 saniye sonra tekrar kontrol et
    setTimeout(() => {
        console.log('üîÑ 2 saniye sonra tekrar kontrol...');
        if (typeof addMaxPointsToAllRows === 'function') {
            addMaxPointsToAllRows();
        }
    }, 2000);
}

// Global eri≈üim
window.forceInitMaxPoints = forceInitMaxPoints;

// Sayfa tamamen y√ºklendiƒüinde zorla ba≈ülat
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', forceInitMaxPoints);
} else {
    // Sayfa zaten y√ºkl√º
    forceInitMaxPoints();
}

// =====================================================
// GELƒ∞≈ûMƒ∞≈û DEƒûƒ∞≈ûƒ∞KLƒ∞K TAKƒ∞P Sƒ∞STEMƒ∞
// =====================================================

// Global deƒüi≈üken: Son g√ºncelleme zamanƒ±nƒ± takip et
let lastAssessmentTreeHash = '';
let assessmentChangeTracker = null;

/**
 * Deƒüerlendirme aƒüacƒ± deƒüi≈üiklik takip sistemi
 * Deƒüerlendirme bile≈üenlerinde deƒüi≈üiklik olduƒüunda otomatik tabloyu yeniden olu≈üturur
 */
function initializeAssessmentChangeTracking() {
    try {
        console.log('üîÑ Deƒüerlendirme deƒüi≈üiklik takip sistemi ba≈ülatƒ±lƒ±yor...');
        
        // ƒ∞lk hash'i hesapla
        updateAssessmentTreeHash();
        
        // √ñnceki tracker'ƒ± temizle
        if (assessmentChangeTracker) {
            clearInterval(assessmentChangeTracker);
        }
        
        // Her 1000ms'de bir deƒüi≈üiklik kontrol√º yap (performanslƒ±)
        assessmentChangeTracker = setInterval(checkForAssessmentChanges, 1000);
        
        console.log('‚úÖ Deƒüerlendirme deƒüi≈üiklik takip sistemi aktif');
    } catch (error) {
        console.error('Deƒüerlendirme deƒüi≈üiklik takip sistemi ba≈ülatƒ±lamadƒ±:', error);
    }
}

/**
 * Deƒüerlendirme aƒüacƒ±nƒ±n mevcut durumunun hash'ini hesapla
 */
function updateAssessmentTreeHash() {
    try {
        // √ñnemli alanlarƒ± i√ßeren basitle≈ütirilmi≈ü aƒüa√ß yapƒ±sƒ± olu≈ütur
        const simplifiedTree = createSimplifiedAssessmentTree();
        lastAssessmentTreeHash = generateHashFromObject(simplifiedTree);
    } catch (error) {
        console.warn("Assessment tree hash hesaplanamadƒ±:", error);
        lastAssessmentTreeHash = '';
    }
}

/**
 * Deƒüerlendirme aƒüacƒ±nƒ±n basitle≈ütirilmi≈ü versiyonunu olu≈ütur (sadece √∂nemli alanlar)
 */
function createSimplifiedAssessmentTree() {
    if (!APP_STATE.assessmentTree || !Array.isArray(APP_STATE.assessmentTree)) return {};
    
    const simplified = APP_STATE.assessmentTree.map(node => ({
        id: node.id,
        name: node.name || '',
        type: node.type || '',
        weight: node.weight || 0,
        points: node.points || 0,
        outcomes: Array.isArray(node.outcomes) ? node.outcomes.sort().join(',') : (node.outcomes || ''),
        description: node.description || '',
        children: node.children ? node.children.map(child => ({
            id: child.id,
            name: child.name || '',
            type: child.type || '',
            weight: child.weight || 0,
            points: child.points || 0,
            outcomes: Array.isArray(child.outcomes) ? child.outcomes.sort().join(',') : (child.outcomes || ''),
            description: child.description || '',
            // Test detaylarƒ± da dahil et
            testDetails: child.testDetails ? {
                totalQuestions: child.testDetails.totalQuestions || 0,
                correctWeight: child.testDetails.correctWeight || 0,
                wrongPenalty: child.testDetails.wrongPenalty || 0
            } : null
        })) : []
    }));
    
    // Grup bilgilerini de dahil et
    const groupMappings = APP_STATE.courseData?.grupHaritalari || {};
    
    return {
        tree: simplified,
        gruplar: groupMappings,
        termWeight: APP_STATE.termWeight,
        finalWeight: APP_STATE.finalWeight,
        studentCount: APP_STATE.studentData ? APP_STATE.studentData.length : 0
    };
}

/**
 * Nesne i√ßin basit hash hesapla
 */
function generateHashFromObject(obj) {
    try {
        const str = JSON.stringify(obj, Object.keys(obj).sort());
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // 32 bit integer'a d√∂n√º≈üt√ºr
        }
        return hash.toString();
    } catch (error) {
        console.warn('Hash hesaplanƒ±rken hata:', error);
        return Date.now().toString(); // Fallback
    }
}

/**
 * Deƒüerlendirme aƒüacƒ±nda deƒüi≈üiklik kontrol√º yap
 */
function checkForAssessmentChanges() {
    try {
        // Sadece deƒüerlendirme sekmesi aktif ise kontrol et
        if (APP_STATE.currentActiveTabId !== 'assessment') {
            return;
        }
        
        // √ñƒürenci verisi yoksa kontrol etme
        if (!APP_STATE.studentData || APP_STATE.studentData.length === 0) {
            return;
        }
        
        // Deƒüerlendirme aƒüacƒ± yoksa kontrol etme
        if (!APP_STATE.assessmentTree || APP_STATE.assessmentTree.length === 0) {
            return;
        }
        
        const currentHash = generateHashFromObject(createSimplifiedAssessmentTree());
        
        if (currentHash !== lastAssessmentTreeHash && lastAssessmentTreeHash !== '') {
            console.log("üîÑ Deƒüerlendirme yapƒ±sƒ±nda deƒüi≈üiklik tespit edildi, tabloyu yeniden olu≈üturuyor...");
            lastAssessmentTreeHash = currentHash;
            
            // Kƒ±sa gecikme ile deƒüerlendirme g√∂r√ºn√ºm√ºn√º g√ºncelle
            setTimeout(() => {
                updateAssessmentView();
                showModernToast("üìä Deƒüerlendirme tablosu deƒüi≈üiklikler nedeniyle yenilendi.", "info");
            }, 100);
        } else if (lastAssessmentTreeHash === '') {
            // ƒ∞lk kez hash hesaplanƒ±yor
            lastAssessmentTreeHash = currentHash;
        }
    } catch (error) {
        console.warn("Deƒüerlendirme deƒüi≈üiklik kontrol√ºnde hata:", error);
    }
}

/**
 * Manuel g√ºncelleme tetikleme fonksiyonu (aƒüa√ß operasyonlarƒ± sonrasƒ± √ßaƒürƒ±lacak)
 */
function triggerAssessmentTableRefresh(reason = "Manuel g√ºncelleme") {
    try {
        console.log(`üîÑ ${reason} - Deƒüerlendirme tablosu yenileniyor...`);
        
        // Hash'i g√ºncelle
        updateAssessmentTreeHash();
        
        // Deƒüerlendirme g√∂r√ºn√ºm√ºn√º g√ºncelle (eƒüer deƒüerlendirme sekmesi aktifse)
        if (APP_STATE.currentActiveTabId === 'assessment' && APP_STATE.studentData && APP_STATE.studentData.length > 0) {
            updateAssessmentView();
        }
        
        // Kullanƒ±cƒ±ya bilgi ver
        showModernToast(`üìä Deƒüerlendirme tablosu g√ºncellendi: ${reason}`, "success");
    } catch (error) {
        console.error("Manuel deƒüerlendirme tablosu g√ºncellemesinde hata:", error);
        showModernToast("‚ùå Deƒüerlendirme tablosu g√ºncellenirken hata olu≈ütu!", "error");
    }
}

/**
 * Deƒüerlendirme deƒüi≈üiklik takip sistemini durdur
 */
function stopAssessmentChangeTracking() {
    if (assessmentChangeTracker) {
        clearInterval(assessmentChangeTracker);
        assessmentChangeTracker = null;
        console.log('üõë Deƒüerlendirme deƒüi≈üiklik takip sistemi durduruldu');
    }
}

// Global eri≈üim i√ßin fonksiyonlarƒ± window'a ekle
window.initializeAssessmentChangeTracking = initializeAssessmentChangeTracking;
window.triggerAssessmentTableRefresh = triggerAssessmentTableRefresh;
window.stopAssessmentChangeTracking = stopAssessmentChangeTracking;
window.updateAssessmentTreeHash = updateAssessmentTreeHash;

// Sistem ba≈ülatƒ±cƒ±sƒ±
function initializeEnhancedAssessmentSystem() {
    console.log('üöÄ Geli≈ümi≈ü deƒüerlendirme sistemi ba≈ülatƒ±lƒ±yor...');
    
    // Deƒüi≈üiklik takip sistemini ba≈ülat
    initializeAssessmentChangeTracking();
    
    console.log('‚úÖ Geli≈ümi≈ü deƒüerlendirme sistemi aktif!');
    console.log('üìã √ñzellikler:');
    console.log('   - Otomatik deƒüerlendirme tablosu yenileme');
    console.log('   - Etkinlik adƒ±, t√ºr√º, aƒüƒ±rlƒ±ƒüƒ± deƒüi≈üiklik takibi');
    console.log('   - Soru/Rubrik ekleme/silme takibi');
    console.log('   - Grup haritalama deƒüi≈üiklik takibi');
    console.log('   - √ñ√á deƒüi≈üiklik takibi');
    console.log('   - Test detaylarƒ± deƒüi≈üiklik takibi');
}

// Sayfa tamamen y√ºklendiƒüinde geli≈ümi≈ü sistemi ba≈ülat
document.addEventListener('DOMContentLoaded', function() {
    // Kƒ±sa gecikme ile ba≈ülat (diƒüer sistemlerin y√ºklenmesini bekle)
    setTimeout(initializeEnhancedAssessmentSystem, 1000);
});

// Eƒüer sayfa zaten y√ºkl√º ise hemen ba≈ülat
if (document.readyState === 'complete') {
    setTimeout(initializeEnhancedAssessmentSystem, 500);
}

// Global test fonksiyonu
window.testAssessmentChangeSystem = function() {
    console.log('üß™ Deƒüerlendirme deƒüi≈üiklik sistemi test ediliyor...');
    console.log('üìä Mevcut hash:', lastAssessmentTreeHash);
    console.log('üîÑ Tracker aktif:', !!assessmentChangeTracker);
    console.log('üìã Assessment tree uzunluƒüu:', APP_STATE.assessmentTree ? APP_STATE.assessmentTree.length : 0);
    console.log('üë• √ñƒürenci sayƒ±sƒ±:', APP_STATE.studentData ? APP_STATE.studentData.length : 0);
    console.log('üéØ Aktif sekme:', APP_STATE.currentActiveTabId);
    
    // Manuel tetikleme testi
    triggerAssessmentTableRefresh("Test ama√ßlƒ± manuel tetikleme");
};

// =====================================================
// HIZLI VE BASƒ∞T G√úNCELLEME Sƒ∞STEMƒ∞
// =====================================================

/**
 * Anƒ±nda deƒüerlendirme tablosu g√ºncelleme
 */
function instantAssessmentRefresh(reason = "Deƒüi≈üiklik") {
    if (APP_STATE.currentActiveTabId === 'assessment' && 
        APP_STATE.studentData && 
        APP_STATE.studentData.length > 0 && 
        APP_STATE.assessmentTree && 
        APP_STATE.assessmentTree.length > 0) {
        
        console.log(`‚ö° Anƒ±nda g√ºncelleme: ${reason}`);
        updateAssessmentView();
        
        // Tablo g√ºncellendikten sonra butonlarƒ± yeniden ekle
        setTimeout(() => {
            console.log(`üîß ${reason} sonrasƒ± butonlarƒ± kontrol ediliyor...`);
            const existingButtons = document.querySelectorAll('.auto-distribute-btn');
            if (existingButtons.length === 0) {
                console.log('‚ö†Ô∏è Butonlar kaybolmu≈ü, yeniden ekleniyor...');
                addAutoDistributeButtonsToTables();
            }
        }, 300);
        
        return true;
    }
    return false;
}

/**
 * T√ºm kritik DOM deƒüi≈üikliklerini yakala
 */
function attachInstantUpdateListeners() {
    // T√ºm click event'leri
    document.addEventListener('click', function(e) {
        if (e.target.closest('#treeContainer')) {
            setTimeout(() => instantAssessmentRefresh("Tƒ±klama i≈ülemi"), 250);
        }
    });
    
    // T√ºm form deƒüi≈üiklikleri
    document.addEventListener('change', function(e) {
        if (e.target.closest('#treeContainer')) {
            // Eƒüer deƒüi≈üiklik puan input'ƒ±ndan geliyorsa (inline daƒüƒ±tƒ±m sonrasƒ± olabilir)
            const isPuanInput = e.target.type === 'number' && 
                               (e.target.dataset.studentId || e.target.dataset.activityId);
            
            setTimeout(() => {
                instantAssessmentRefresh("Form deƒüi≈üikliƒüi");
                
                // Puan input deƒüi≈üikliƒüi ise butonlarƒ± hemen kontrol et
                if (isPuanInput) {
                    setTimeout(() => {
                        console.log('üîß Puan input deƒüi≈üikliƒüi sonrasƒ± buton kontrol√º...');
                        const existingButtons = document.querySelectorAll('.auto-distribute-btn');
                        if (existingButtons.length === 0) {
                            console.log('‚ö†Ô∏è Puan input sonrasƒ± butonlar kaybolmu≈ü, acil ekleniyor...');
                            addAutoDistributeButtonsToTables();
                        }
                    }, 100);
                }
            }, 100);
        }
    });
    
    // Input yazma (debounced)
    let typingTimer;
    document.addEventListener('input', function(e) {
        if (e.target.closest('#treeContainer')) {
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => instantAssessmentRefresh("Metin giri≈üi"), 400);
        }
        
        // Puan input'larƒ± i√ßin g√∂rsel uyarƒ± sistemi
        if (e.target.type === 'number' && e.target.dataset.activityId) {
            const activityId = e.target.dataset.activityId;
            const activity = findNodeById(activityId);
            if (activity) {
                const maxPoints = activity.points || 100;
                const value = parseFloat(e.target.value) || 0;
                
                if (value > maxPoints) {
                    e.target.style.borderColor = '#ff6b6b';
                    e.target.style.backgroundColor = '#fff5f5';
                    e.target.title = `‚ö†Ô∏è Girilen puan (${value}) maksimum puandan (${maxPoints}) b√ºy√ºk!`;
                } else {
                    e.target.style.borderColor = '';
                    e.target.style.backgroundColor = '';
                    e.target.title = `Maksimum puan: ${maxPoints}`;
                }
            }
        }
    });
    
    console.log('‚úÖ Anƒ±nda g√ºncelleme dinleyicileri aktif!');
}

// Global fonksiyon
window.forceAssessmentRefresh = function() {
    if (instantAssessmentRefresh("Manuel zorlama")) {
        showModernToast("üîÑ Deƒüerlendirme tablosu yenilendi!", "success");
    } else {
        showModernToast("‚ö†Ô∏è Deƒüerlendirme sekmesi aktif deƒüil veya veri eksik!", "warning");
    }
};

// Hemen ba≈ülat
if (document.readyState === 'complete') {
    setTimeout(attachInstantUpdateListeners, 300);
} else {
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(attachInstantUpdateListeners, 600);
    });
}

// GUID sistemi tamamen kaldƒ±rƒ±ldƒ±


//Index.html den ta≈üƒ±ndƒ± 
   // =====================================================
    // TA≈ûIMA BUTONLARI D√úZELTMESƒ∞
    // =====================================================
    
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() {
            // renderNode fonksiyonunu geni≈ület
            if (typeof window.renderNode === 'function') {
                const originalRenderNode = window.renderNode;
                
                window.renderNode = function(node, parentElement, level) {
                    originalRenderNode(node, parentElement, level);
                    
                    // Alt √∂ƒüeler i√ßin ta≈üƒ±ma butonlarƒ±nƒ± ekle
                    const isSubItem = node.id.includes('.');
                    if (isSubItem) {
                        setTimeout(() => addMoveButtonsToNode(node.id), 50);
                    }
                };
            }
            
            // renderTree fonksiyonunu geni≈ület
            if (typeof window.renderTree === 'function') {
                const originalRenderTree = window.renderTree;
                
                window.renderTree = function() {
                    originalRenderTree();
                    setTimeout(() => {
                        addMoveButtonsToAllSubItems();
                    }, 100);
                };
            }
        }, 500);
    });
    
    /**
     * D√ºƒü√ºme ta≈üƒ±ma butonlarƒ± ekle
     */
    function addMoveButtonsToNode(nodeId) {
        const nodeElement = document.querySelector(`[data-id="${nodeId}"]`);
        if (!nodeElement) return;
        
        const buttonGroup = nodeElement.querySelector('.button-group');
        if (!buttonGroup) return;
        
        // Eƒüer ta≈üƒ±ma butonlarƒ± zaten varsa ekleme
        if (buttonGroup.querySelector('.btn-move-up')) return;
        
        // Ta≈üƒ±ma butonlarƒ±nƒ± olu≈ütur
        const moveUpBtn = document.createElement('button');
        moveUpBtn.className = 'btn btn-move-up btn-small';
        moveUpBtn.setAttribute('data-node-id', nodeId);
        moveUpBtn.title = 'Yukarƒ± ta≈üƒ±';
        moveUpBtn.innerHTML = `
            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="18 15 12 9 6 15"></polyline>
            </svg>
            ‚Üë
        `;
        
        const moveDownBtn = document.createElement('button');
        moveDownBtn.className = 'btn btn-move-down btn-small';
        moveDownBtn.setAttribute('data-node-id', nodeId);
        moveDownBtn.title = 'A≈üaƒüƒ± ta≈üƒ±';
        moveDownBtn.innerHTML = `
            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
            ‚Üì
        `;
        
        // Event listener'larƒ± ekle
        moveUpBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const node = findNodeById(nodeId);
            if (node && typeof moveItemUp === 'function') {
                moveItemUp(node);
            }
        });
        
        moveDownBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const node = findNodeById(nodeId);
            if (node && typeof moveItemDown === 'function') {
                moveItemDown(node);
            }
        });
        
        // Butonlarƒ± button-group'un ba≈üƒ±na ekle
        buttonGroup.insertBefore(moveUpBtn, buttonGroup.firstChild);
        buttonGroup.insertBefore(moveDownBtn, moveUpBtn.nextSibling);
    }
    
    /**
     * T√ºm alt √∂ƒüelere ta≈üƒ±ma butonlarƒ± ekle
     */
    function addMoveButtonsToAllSubItems() {
        if (typeof APP_STATE !== 'undefined' && APP_STATE.assessmentTree) {
            APP_STATE.assessmentTree.forEach(rootNode => {
                if (rootNode.children) {
                    rootNode.children.forEach(childNode => {
                        addMoveButtonsToNode(childNode.id);
                    });
                }
            });
        }
    }
    
    // Manuel test fonksiyonu
    window.testMoveButtons = function() {
        console.log('üß™ Ta≈üƒ±ma butonlarƒ± test ediliyor...');
        addMoveButtonsToAllSubItems();
        if (typeof showModernToast === 'function') {
            showModernToast('üîÑ Ta≈üƒ±ma butonlarƒ± eklendi!', 'success');
        }
    };
    
    // Global fonksiyonlarƒ± ekle
    window.addMoveButtonsToNode = addMoveButtonsToNode;
    window.addMoveButtonsToAllSubItems = addMoveButtonsToAllSubItems;


    // GUID sistemi tamamen kaldƒ±rƒ±ldƒ±


        // =====================================================
    // S√úR√úKLE BIRAK Sƒ∞STEMƒ∞
    // =====================================================
    
    let draggedNode = null;
    let draggedElement = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() {
            initializeDragAndDrop();
        }, 2500);
    });
    
    /**
     * S√ºr√ºkle bƒ±rak sistemini ba≈ülat
     */
    function initializeDragAndDrop() {
        // Mevcut renderNode fonksiyonunu geni≈ület
        if (typeof window.renderNode === 'function') {
            const originalRenderNode = window.renderNode;
            
            window.renderNode = function(node, parentElement, level) {
                originalRenderNode(node, parentElement, level);
                
                // Alt √∂ƒüeler i√ßin s√ºr√ºkle bƒ±rak √∂zelliƒüi ekle
                const isSubItem = node.id.includes('.');
                if (isSubItem) {
                    setTimeout(() => addDragAndDropToNode(node.id), 100);
                }
            };
        }
    }
    
    /**
     * D√ºƒü√ºme s√ºr√ºkle bƒ±rak √∂zelliƒüi ekle
     */
    function addDragAndDropToNode(nodeId) {
        const nodeElement = document.querySelector(`[data-id="${nodeId}"]`);
        if (!nodeElement) return;
        
        // S√ºr√ºklenebilir yap
        nodeElement.draggable = true;
        nodeElement.style.cursor = 'move';
        
        // Drag event'leri
        nodeElement.addEventListener('dragstart', handleDragStart);
        nodeElement.addEventListener('dragover', handleDragOver);
        nodeElement.addEventListener('drop', handleDrop);
        nodeElement.addEventListener('dragend', handleDragEnd);
        nodeElement.addEventListener('dragenter', handleDragEnter);
        nodeElement.addEventListener('dragleave', handleDragLeave);
        
        // Visual feedback i√ßin sƒ±nƒ±f ekle
        nodeElement.classList.add('draggable-item');
    }
    
    /**
     * S√ºr√ºkleme ba≈üladƒ±ƒüƒ±nda
     */
    function handleDragStart(e) {
        draggedElement = e.target.closest('.tree-node');
        const nodeId = draggedElement.dataset.id;
        draggedNode = findNodeById ? findNodeById(nodeId) : null;
        
        draggedElement.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', draggedElement.outerHTML);
        
        console.log('üî• S√ºr√ºkleme ba≈üladƒ±:', nodeId);
    }
    
    /**
     * S√ºr√ºkleme bittiƒüinde
     */
    function handleDragEnd(e) {
        if (draggedElement) {
            draggedElement.classList.remove('dragging');
        }
        
        // T√ºm drop zone stillerini temizle
        document.querySelectorAll('.drop-zone').forEach(el => {
            el.classList.remove('drop-zone');
        });
        
        draggedNode = null;
        draggedElement = null;
    }
    
    /**
     * S√ºr√ºklenirken √ºzerine gelindiƒüinde
     */
    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
    }
    
    /**
     * Drop zone'a girildiƒüinde
     */
    function handleDragEnter(e) {
        const targetElement = e.target.closest('.tree-node');
        if (targetElement && targetElement !== draggedElement) {
            const targetNodeId = targetElement.dataset.id;
            const isSubItem = targetNodeId.includes('.');
            
            // Sadece aynƒ± parent altƒ±ndaki alt √∂ƒüeler i√ßin drop zone yap
            if (isSubItem && draggedNode) {
                const draggedParentId = draggedNode.id.split('.')[0];
                const targetParentId = targetNodeId.split('.')[0];
                
                if (draggedParentId === targetParentId) {
                    targetElement.classList.add('drop-zone');
                }
            }
        }
    }
    
    /**
     * Drop zone'dan √ßƒ±kƒ±ldƒ±ƒüƒ±nda
     */
    function handleDragLeave(e) {
        const targetElement = e.target.closest('.tree-node');
        if (targetElement) {
            targetElement.classList.remove('drop-zone');
        }
    }
    
    /**
     * Bƒ±rakƒ±ldƒ±ƒüƒ±nda
     */
    function handleDrop(e) {
        e.preventDefault();
        
        const targetElement = e.target.closest('.tree-node');
        if (!targetElement || !draggedNode || targetElement === draggedElement) return;
        
        const targetNodeId = targetElement.dataset.id;
        const targetNode = findNodeById ? findNodeById(targetNodeId) : null;
        
        if (!targetNode) return;
        
        // Aynƒ± parent altƒ±nda mƒ± kontrol et
        const draggedParentId = draggedNode.id.split('.')[0];
        const targetParentId = targetNode.id.split('.')[0];
        
        if (draggedParentId !== targetParentId) {
            showModernToast('Sadece aynƒ± bile≈üen i√ßindeki sorular ta≈üƒ±nabilir!', 'warning');
            return;
        }
        
        // Parent node'u bul
        const parentNode = findParentNode ? findParentNode(draggedNode.id) : null;
        if (!parentNode) return;
        
        // Mevcut pozisyonlarƒ± bul
        const draggedIndex = parentNode.children.findIndex(child => child.id === draggedNode.id);
        const targetIndex = parentNode.children.findIndex(child => child.id === targetNode.id);
        
        if (draggedIndex === -1 || targetIndex === -1) return;
        
        // √ñƒüeleri yeniden sƒ±rala
        const [movedItem] = parentNode.children.splice(draggedIndex, 1);
        parentNode.children.splice(targetIndex, 0, movedItem);
        
        // ID'leri yeniden d√ºzenle
        if (typeof reorderAllIds === 'function') {
            reorderAllIds(parentNode);
        }
        
        // G√∂r√ºn√ºm√º g√ºncelle
        if (typeof renderTree === 'function') {
            renderTree();
        }
        
        if (typeof updateAssessmentView === 'function') {
            updateAssessmentView();
        }
        
        showModernToast(`"${draggedNode.name}" ba≈üarƒ±yla ta≈üƒ±ndƒ±!`, 'success');
        
        console.log('‚úÖ S√ºr√ºkle bƒ±rak tamamlandƒ±:', draggedNode.id, '->', targetNode.id);
    }
    
    // Global fonksiyonlar
    window.initializeDragAndDrop = initializeDragAndDrop;
    window.addDragAndDropToNode = addDragAndDropToNode;
    
    // CSS stilleri ekle
    const dragDropStyles = document.createElement('style');
    dragDropStyles.textContent = `
        .draggable-item {
            transition: all 0.2s ease;
        }
        
        .dragging {
            opacity: 0.5;
            transform: rotate(2deg);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .drop-zone {
            border: 2px dashed #3498db !important;
            background-color: rgba(52, 152, 219, 0.1) !important;
            transform: scale(1.02);
        }
        
        .tree-node[draggable="true"]:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .tree-node[draggable="true"]::before {
            content: "‚ãÆ‚ãÆ";
            position: absolute;
            left: 5px;
            top: 50%;
            transform: translateY(-50%);
            color: #bdc3c7;
            font-weight: bold;
            font-size: 12px;
            line-height: 1;
        }
    `;
    document.head.appendChild(dragDropStyles);

    
    // GUID sistemi tamamen kaldƒ±rƒ±ldƒ±


    // =====================================================
    // ID Sƒ∞STEMƒ∞ D√úZELTMESƒ∞
    // =====================================================
    
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() {
            // addQuestionToNode fonksiyonunu geni≈ület
            if (typeof window.addQuestionToNode === 'function') {
                const originalAddQuestionToNode = window.addQuestionToNode;
                
                window.addQuestionToNode = function(parentNode, questionType = 'Soru', description = '') {
                    if (!parentNode) return;
                    
                    try {
                        if (!parentNode.children) {
                            parentNode.children = [];
                        }
                        
                        // YENƒ∞: Sƒ±ralƒ± ID √ºretimi kullan
                        const newId = generateSequentialId ? generateSequentialId(parentNode) : `${parentNode.id}.${parentNode.children.length + 1}`;
                        
                        // √ñƒürenme √ßƒ±ktƒ±larƒ± varsa ilk √∂ƒürenme √ßƒ±ktƒ±sƒ±nƒ± atayalƒ±m
                        const outcome = parentNode.outcomes && parentNode.outcomes.length > 0 ? [parentNode.outcomes[0]] : [];
                        
                        // Varsayƒ±lan puanƒ± 3 olarak ayarla
                        const defaultPoints = 3;
                        
                        const newNode = {
                            id: newId,
                            name: `${questionType}`,
                            type: questionType,
                            weight: 0, // Aƒüƒ±rlƒ±k otomatik hesaplanacak
                            points: defaultPoints,
                            outcomes: outcome,
                            description: description || 'Deƒüerlendirme sorusu',
                            expanded: true,
                            children: []
                        };
                        
                        parentNode.children.push(newNode);
                        parentNode.expanded = true;
                        
                        // YENƒ∞: ID'leri yeniden d√ºzenle
                        if (typeof reorderAllIds === 'function') {
                            reorderAllIds(parentNode);
                        }
                        
                        // Aƒüƒ±rlƒ±ƒüƒ± hesapla
                        if (typeof updateSubItemWeight === 'function') {
                            updateSubItemWeight(newNode);
                        }
                        
                        if (typeof selectNode === 'function') {
                            selectNode(newNode);
                        }
                        
                        if (typeof renderTree === 'function') {
                            renderTree();
                        }
                        
                        // Deƒüerlendirme sekmesini g√ºncelle
                        if (typeof updateAssessmentView === 'function') {
                            updateAssessmentView();
                        }
                        
                        if (typeof showModernToast === 'function') {
                            showModernToast(`"${questionType}" sorusu eklendi.`);
                        }
                        
                        // Aƒüƒ±rlƒ±klarƒ± yeniden deƒüerlendir
                        if (typeof checkAndOfferRedistribution === 'function') {
                            checkAndOfferRedistribution(parentNode);
                        }
                        
                    } catch (error) {
                        console.error("Soru eklenirken hata olu≈ütu:", error);
                        if (typeof showModernToast === 'function') {
                            showModernToast("Soru eklenemedi!", "error");
                        }
                    }
                };
            }
            
            // deleteNode fonksiyonunu geni≈ület - DEVRE DI≈ûI BIRAKILDI
            // NOT: deleteNode fonksiyonu kendi i√ßinde ID yeniden d√ºzenleme yapƒ±yor
            /*
            if (typeof window.deleteNode === 'function') {
                const originalDeleteNode = window.deleteNode;
                
                window.deleteNode = function(nodeId) {
                    // Orijinal fonksiyonu √ßaƒüƒ±r
                    originalDeleteNode(nodeId);
                    
                    // ID'leri yeniden d√ºzenle
                    setTimeout(() => {
                        if (!nodeId.includes('.')) return; // Sadece alt √∂ƒüeler i√ßin
                        
                        const parentId = nodeId.substring(0, nodeId.lastIndexOf('.'));
                        const parentNode = findNodeById ? findNodeById(parentId) : null;
                        
                        if (parentNode && typeof reorderAllIds === 'function') {
                            reorderAllIds(parentNode);
                            
                            if (typeof renderTree === 'function') {
                                renderTree();
                            }
                            
                            if (typeof updateAssessmentView === 'function') {
                                updateAssessmentView();
                            }
                        }
                    }, 100);
                };
            }
            */
        }, 1000);
    });

    // =====================================================
    // VERƒ∞ KORUMA Sƒ∞STEMƒ∞ - √ñƒûRENCƒ∞ NOTLARI
    // =====================================================
    
    /**
     * √ñƒürenci notlarƒ±nda ID deƒüi≈üikliklerini migrasyon et
     * @param {Object} idMigrationMap - ID deƒüi≈üiklik haritasƒ± (eskiID -> yeniID)
     */
    function migrateGradesData(idMigrationMap) {
        if (!APP_STATE.gradesData || Object.keys(idMigrationMap).length === 0) return;
        
        console.log('üîÑ √ñƒürenci notlarƒ± migrasyon ba≈ülatƒ±lƒ±yor...', idMigrationMap);
        
        // Her √∂ƒürenci i√ßin
        Object.keys(APP_STATE.gradesData).forEach(studentId => {
            const studentGrades = APP_STATE.gradesData[studentId];
            if (!studentGrades || typeof studentGrades !== 'object') return;
            
            // Migrasyon edilecek notlarƒ± sakla
            const notesToMigrate = {};
            
            // Migrasyon haritasƒ±ndaki her ID deƒüi≈üikliƒüi i√ßin
            Object.entries(idMigrationMap).forEach(([oldId, newId]) => {
                // Direkt not kontrol√º
                if (studentGrades.hasOwnProperty(oldId)) {
                    notesToMigrate[newId] = studentGrades[oldId];
                    delete studentGrades[oldId];
                    console.log(`‚úÖ √ñƒürenci ${studentId}: ${oldId} -> ${newId} (Deƒüer: ${notesToMigrate[newId]})`);
                }
                
                // Ham puanlar migrasyon
                if (studentGrades.hamPuanlar) {
                    const oldQuestionNum = oldId.split('.').pop();
                    const newQuestionNum = newId.split('.').pop();
                    
                    if (studentGrades.hamPuanlar.hasOwnProperty(oldQuestionNum)) {
                        studentGrades.hamPuanlar[newQuestionNum] = studentGrades.hamPuanlar[oldQuestionNum];
                        delete studentGrades.hamPuanlar[oldQuestionNum];
                        console.log(`‚úÖ Ham puan migrasyon: ${oldQuestionNum} -> ${newQuestionNum}`);
                    }
                }
                
                // Grup bazlƒ± notlar migrasyon
                if (studentGrades.grupBazliNotlar) {
                    Object.keys(studentGrades.grupBazliNotlar).forEach(groupName => {
                        const groupGrades = studentGrades.grupBazliNotlar[groupName];
                        if (groupGrades.hasOwnProperty(oldId)) {
                            groupGrades[newId] = groupGrades[oldId];
                            delete groupGrades[oldId];
                            console.log(`‚úÖ Grup bazlƒ± not migrasyon: Grup ${groupName}, ${oldId} -> ${newId}`);
                        }
                    });
                }
                
                // √úst d√ºƒü√ºm yapƒ±sƒ± migrasyon
                const oldParentId = oldId.split('.')[0];
                const newParentId = newId.split('.')[0];
                
                if (studentGrades[oldParentId] && typeof studentGrades[oldParentId] === 'object' && oldParentId === newParentId) {
                    const parentGrades = studentGrades[oldParentId];
                    if (parentGrades.hasOwnProperty(oldId)) {
                        parentGrades[newId] = parentGrades[oldId];
                        delete parentGrades[oldId];
                        
                        // Kƒ±sa ID de g√ºncelle
                        const oldShortId = oldId.split('.').pop();
                        const newShortId = newId.split('.').pop();
                        if (parentGrades.hasOwnProperty(oldShortId)) {
                            parentGrades[newShortId] = parentGrades[oldShortId];
                            delete parentGrades[oldShortId];
                        }
                        
                        console.log(`‚úÖ Parent yapƒ±sƒ± migrasyon: ${oldParentId}[${oldId}] -> ${newParentId}[${newId}]`);
                    }
                }
            });
            
            // Yeni notlarƒ± ekle
            Object.entries(notesToMigrate).forEach(([newId, value]) => {
                studentGrades[newId] = value;
            });
        });
        
        console.log('‚úÖ √ñƒürenci notlarƒ± migrasyon tamamlandƒ±!');
        showModernToast(`üìä ${Object.keys(idMigrationMap).length} soru/rubrik ID'si deƒüi≈ütirildi, notlar korundu!`, "success");
    }
    
    /**
     * reorderAllIds fonksiyonunu veri koruma ile geni≈ület
     */
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() {
            if (typeof window.reorderAllIds === 'function') {
                const originalReorderAllIds = window.reorderAllIds;
                
                window.reorderAllIds = function(parentNode) {
                    if (!parentNode || !parentNode.children) return;
                    
                    // ID deƒüi≈üiklik haritasƒ±
                    const idMigrationMap = {};
                    
                    parentNode.children.forEach((child, index) => {
                        const oldId = child.id;
                        const newId = `${parentNode.id}.${index + 1}`;
                        
                        if (oldId !== newId) {
                            idMigrationMap[oldId] = newId;
                        }
                    });
                    
                    // Orijinal fonksiyonu √ßaƒüƒ±r
                    originalReorderAllIds(parentNode);
                    
                    // √ñƒürenci notlarƒ±nƒ± migrasyon et
                    if (Object.keys(idMigrationMap).length > 0) {
                        migrateGradesData(idMigrationMap);
                    }
                };
            }
        }, 1500);
    });
    
    /**
     * deleteNode fonksiyonunu veri koruma uyarƒ±sƒ± ile geni≈ület
     * NOT: Bu wrapper artƒ±k devre dƒ±≈üƒ±, deleteNode fonksiyonu kendi i√ßinde kontrol√º yapƒ±yor
     */
    // WRAPPER TAMAMEN DEVRE DI≈ûI BIRAKILDI - deleteNode fonksiyonu kendi i√ßinde kontrol√º yapƒ±yor
    
    /**
     * D√ºƒü√ºm√ºn not verisi olup olmadƒ±ƒüƒ±nƒ± kontrol et
     */
    function checkIfNodeHasGrades(nodeId) {
        if (!APP_STATE.gradesData) return false;
        
        return Object.keys(APP_STATE.gradesData).some(studentId => {
            const studentGrades = APP_STATE.gradesData[studentId];
            if (!studentGrades) return false;
            
            // Direkt not kontrol√º
            if (studentGrades.hasOwnProperty(nodeId)) return true;
            
            // Ham puanlar kontrol√º
            if (studentGrades.hamPuanlar) {
                const questionNum = nodeId.split('.').pop();
                if (studentGrades.hamPuanlar.hasOwnProperty(questionNum)) return true;
            }
            
            // Grup bazlƒ± notlar kontrol√º
            if (studentGrades.grupBazliNotlar) {
                return Object.values(studentGrades.grupBazliNotlar).some(groupGrades => 
                    groupGrades.hasOwnProperty(nodeId)
                );
            }
            
            return false;
        });
    }
    
    // Global fonksiyonlar
    window.migrateGradesData = migrateGradesData;
    window.checkIfNodeHasGrades = checkIfNodeHasGrades;
    
    // Test fonksiyonu
    window.testGradeMigration = function() {
        console.log('üß™ Not migrasyon sistemi test ediliyor...');
        const testMap = {'A1.2': 'A1.3', 'A1.3': 'A1.4'};
        migrateGradesData(testMap);
    };

    // =====================================================
    // GRUP HARƒ∞TALAMA HATA D√úZELTMESƒ∞
    // =====================================================
    
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() {
            if (typeof window.updateGroupMappingForId === 'function') {
                const originalUpdateGroupMappingForId = window.updateGroupMappingForId;
                
                window.updateGroupMappingForId = function(oldId, newId) {
                    if (!APP_STATE.courseData || !APP_STATE.courseData.grupHaritalari) return;
                    
                    Object.keys(APP_STATE.courseData.grupHaritalari).forEach(groupName => {
                        const activities = APP_STATE.courseData.grupHaritalari[groupName];
                        
                        Object.keys(activities).forEach(activityId => {
                            const questionList = activities[activityId];
                            
                            // D√úZELTME: questionList'in array olup olmadƒ±ƒüƒ±nƒ± kontrol et
                            if (Array.isArray(questionList)) {
                                const index = questionList.indexOf(oldId);
                                if (index !== -1) {
                                    questionList[index] = newId;
                                }
                            } else {
                                console.warn(`Grup haritalama problemi: ${groupName}.${activityId} array deƒüil:`, questionList);
                            }
                        });
                    });
                };
            }
        }, 2000);
    });

// =====================================================
// YENƒ∞ GRUP Y√ñNETƒ∞Mƒ∞ Sƒ∞STEMƒ∞
// =====================================================

/**
 * Bir etkinlik i√ßin grup haritalama bilgisi olu≈ütur
 * @param {string} activityId - Etkinlik ID'si
 * @returns {Object} - Grup haritalama bilgisi
 */
function createGroupMappingForActivity(activityId) {
    const activity = APP_STATE.assessmentTree.find(node => node.id === activityId);
    if (!activity || !activity.children) {
        return {
            gruplar: ["A"],
            haritalar: {
                "A": {}
            }
        };
    }
    
    // Mevcut grup haritalama bilgisini al
    const existingMapping = APP_STATE.courseData?.grupHaritalari?.[activityId];
    
    if (existingMapping) {
        return existingMapping;
    }
    
    // Default haritalama olu≈ütur - her etkinlik en az A grubu var
    const mappings = {
        "A": {}
    };
    
    // T√ºm sorularƒ± A grubunda sƒ±rayla ekle
    activity.children.forEach((child, index) => {
        mappings.A[(index + 1).toString()] = child.id;
    });
    
    return {
        gruplar: ["A"],
        haritalar: mappings
    };
}

/**
 * Deƒüerlendirme verilerinden grup haritalama bilgilerini y√ºkle
 * @param {Object} jsonData - JSON verisi
 */
function loadGroupMappingsFromAssessmentData(jsonData) {
    console.log("üöÄ === loadGroupMappingsFromAssessmentData BA≈ûLADI ===");
    console.log("üìÑ Fonksiyon √ßaƒürƒ±ldƒ±, parametre tipi:", typeof jsonData);
    console.log("üìÑ JSON data var mƒ±:", !!jsonData);
    
    try {
        console.log("üîç loadGroupMappingsFromAssessmentData ba≈ülatƒ±ldƒ±...");
        console.log("üìÑ Gelen JSON data keys:", Object.keys(jsonData));
        
        if (!APP_STATE.courseData) APP_STATE.courseData = {};
        if (!APP_STATE.courseData.grupHaritalari) APP_STATE.courseData.grupHaritalari = {};
        
        // v5 format i√ßin √∂zel i≈ülem - dersDegerlendirme i√ßindeki etkinlikleri kontrol et
        const dersDegerlendirme = jsonData.dersDegerlendirme;
        console.log("üìä dersDegerlendirme var mƒ±:", !!dersDegerlendirme);
        
        if (dersDegerlendirme) {
            // Yarƒ±yƒ±l i√ßi etkinlikler
            if (dersDegerlendirme.yariyilIciEtkinlikleri) {
                console.log("üîç Yarƒ±yƒ±l i√ßi etkinlikler bulundu:", dersDegerlendirme.yariyilIciEtkinlikleri.length);
                dersDegerlendirme.yariyilIciEtkinlikleri.forEach(activity => {
                    console.log(`üîç Etkinlik kontrol ediliyor: ${activity.id}`, activity);
                    if (activity.grupBilgileri) {
                        APP_STATE.courseData.grupHaritalari[activity.id] = activity.grupBilgileri;
                        console.log(`‚úÖ Grup bilgileri y√ºklendi: ${activity.id}`, activity.grupBilgileri);
                    } else {
                        console.log(`‚ö†Ô∏è ${activity.id} i√ßin grup bilgisi bulunamadƒ±`);
                    }
                });
            } else {
                console.log("‚ö†Ô∏è Yarƒ±yƒ±l i√ßi etkinlikler bulunamadƒ±");
            }
            
            // Yarƒ±yƒ±l sonu etkinlikler
            if (dersDegerlendirme.yariyilSonuEtkinlikleri) {
                console.log("üîç Yarƒ±yƒ±l sonu etkinlikler bulundu:", dersDegerlendirme.yariyilSonuEtkinlikleri.length);
                dersDegerlendirme.yariyilSonuEtkinlikleri.forEach(activity => {
                    console.log(`üîç Etkinlik kontrol ediliyor: ${activity.id}`, activity);
                    if (activity.grupBilgileri) {
                        APP_STATE.courseData.grupHaritalari[activity.id] = activity.grupBilgileri;
                        console.log(`‚úÖ Grup bilgileri y√ºklendi: ${activity.id}`, activity.grupBilgileri);
                    } else {
                        console.log(`‚ö†Ô∏è ${activity.id} i√ßin grup bilgisi bulunamadƒ±`);
                    }
                });
            } else {
                console.log("‚ö†Ô∏è Yarƒ±yƒ±l sonu etkinlikler bulunamadƒ±");
            }
        }
        
        // SADECE √∂ƒürenci grup bilgilerini y√ºkle - mapping bilgilerini etkinlik verilerinden al
        if (jsonData.ogrenciNotlari) {
            console.log("üîç √ñƒürenci grup bilgileri y√ºkleniyor...");
            
            // √ñƒürenci grup bilgilerini y√ºkle
            Object.keys(jsonData.ogrenciNotlari).forEach(studentId => {
                const studentGrades = jsonData.ogrenciNotlari[studentId];
                if (studentGrades.grupBilgileri) {
                    // v5 formatƒ±nda grup bilgilerini studentComponentGroups'a y√ºkle
                    if (!APP_STATE.studentComponentGroups) APP_STATE.studentComponentGroups = {};
                    if (!APP_STATE.studentComponentGroups[studentId]) APP_STATE.studentComponentGroups[studentId] = {};
                    
                    Object.keys(studentGrades.grupBilgileri).forEach(activityId => {
                        APP_STATE.studentComponentGroups[studentId][activityId] = studentGrades.grupBilgileri[activityId];
                    });
                    console.log(`‚úÖ √ñƒürenci grup bilgileri y√ºklendi: ${studentId}`, studentGrades.grupBilgileri);
                }
            });
        }
        
        console.log("üéØ T√ºm grup haritalama bilgileri y√ºklendi:", APP_STATE.courseData.grupHaritalari);
        console.log("üë• √ñƒürenci grup atamalarƒ± (v5 format):", APP_STATE.studentComponentGroups);
        
        // Debug: Her bile≈üen i√ßin grup bilgilerini detaylƒ± yazdƒ±r
        Object.keys(APP_STATE.courseData.grupHaritalari || {}).forEach(componentId => {
            const component = APP_STATE.courseData.grupHaritalari[componentId];
            console.log(`üìä ${componentId} grup detaylarƒ±:`, {
                gruplar: component.gruplar,
                haritalar: component.haritalar,
                mappingCount: Object.keys(component.haritalar || {}).length
            });
        });
        
        console.log("‚úÖ loadGroupMappingsFromAssessmentData tamamlandƒ±");
    } catch (error) {
        console.error("‚ùå Grup haritalama bilgileri y√ºklenirken hata olu≈ütu:", error);
    }
}

/**
 * √ñƒürenci notlarƒ±nƒ± yeni yapƒ±ya g√∂re y√ºkle - v5 formatƒ±nƒ± tam destekler
 * @param {Object} jsonData - JSON verisi
 */
function loadStudentGradesNewFormat(jsonData) {
    try {
        if (!jsonData.ogrenciNotlari) return;
        
        // Not verilerini temizle
        APP_STATE.gradesData = {};
        
        Object.keys(jsonData.ogrenciNotlari).forEach(studentId => {
            const studentGrades = jsonData.ogrenciNotlari[studentId];
            
            if (!APP_STATE.gradesData[studentId]) {
                APP_STATE.gradesData[studentId] = {};
            }
            
            // Her etkinlik i√ßin notlarƒ± y√ºkle
            Object.keys(studentGrades).forEach(activityId => {
                if (activityId === 'grupBilgileri') return; // Grup bilgilerini atla
                
                const activityGrades = studentGrades[activityId];
                if (typeof activityGrades === 'object') {
                    // v5 Format: Pozisyon bazlƒ± notlar (1, 2, 3, 4, 5...)
                    // Hem pozisyon bilgisini hem de soru ID bilgisini koru
                    APP_STATE.gradesData[studentId][activityId] = {};
                    
                    Object.keys(activityGrades).forEach(questionOrder => {
                        const gradeInfo = activityGrades[questionOrder];
                        if (gradeInfo && typeof gradeInfo === 'object' && gradeInfo.puan !== undefined) {
                            // Kaƒüƒ±t sƒ±rasƒ±na g√∂re puanƒ± kaydet (soruId'yi g√∂rmezden gel)
                            APP_STATE.gradesData[studentId][activityId][questionOrder] = {
                                puan: gradeInfo.puan
                            };
                        }
                    });
                }
            });
            
            // Grup bilgilerini v5 formatƒ±ndan y√ºkle
            if (studentGrades.grupBilgileri) {
                // v5 formatƒ±nda grup bilgilerini studentComponentGroups'a y√ºkle
                if (!APP_STATE.studentComponentGroups) APP_STATE.studentComponentGroups = {};
                if (!APP_STATE.studentComponentGroups[studentId]) APP_STATE.studentComponentGroups[studentId] = {};
                
                Object.keys(studentGrades.grupBilgileri).forEach(activityId => {
                    APP_STATE.studentComponentGroups[studentId][activityId] = studentGrades.grupBilgileri[activityId];
                });
                
                // Ayrƒ±ca gradesData'ya da kaydet (v5 format uyumluluƒüu i√ßin)
                APP_STATE.gradesData[studentId].grupBilgileri = studentGrades.grupBilgileri;
            }
        });
        
                        console.log("‚úÖ √ñƒürenci notlarƒ± kaƒüƒ±t sƒ±rasƒ± bazlƒ± y√ºklendi");
        console.log("üìä Y√ºklenen √∂ƒürenci sayƒ±sƒ±:", Object.keys(APP_STATE.gradesData).length);
    } catch (error) {
        console.error("√ñƒürenci notlarƒ± y√ºklenirken hata olu≈ütu:", error);
    }
}

/**
 * Tam dosya formatƒ±nda yarƒ±yƒ±l i√ßi etkinlik olu≈üturma fonksiyonu
 */
function generateTamDosyaTermAssessmentWithParams(activityCount, componentCount, activityType) {
    try {
        showModernToast(`üìö Tam dosya formatƒ±nda ${activityCount} yarƒ±yƒ±l i√ßi etkinlik olu≈üturuluyor...`, 'info', 3000);
        
        // Tam dosya formatƒ±na uygun etkinlik t√ºrleri
        const activityTypes = [
            'Ara Sƒ±nav', 'Quiz', 'Ev √ñdevi', 'Proje Hazƒ±rlama', 'Laboratuvar', 'Proje Sunma', 
            'Rapor', 'Deney', 'Performans', 'Makale Kritik Etme', 'Seminer', 'S√∂zl√º Sƒ±nav'
        ];
        
        // Tam dosya formatƒ±na uygun √∂ƒürenme √ßƒ±ktƒ±larƒ±
        const learningOutcomes = ['√ñ√á.1', '√ñ√á.2', '√ñ√á.3', '√ñ√á.4', '√ñ√á.5', '√ñ√á.6', '√ñ√á.7'];
        
        // Yeni V5 formatƒ±nda etkinlikler olu≈ütur
        const newActivities = [];
        let totalWeight = 0;
        
        // Mevcut A etkinlik sayƒ±sƒ±nƒ± bul
        const existingTermActivities = APP_STATE.courseData?.dersDegerlendirme?.yariyilIciEtkinlikleri || [];
        let startIndex = existingTermActivities.length + 1;
        
        for (let i = 0; i < activityCount; i++) {
            const selectedType = activityType === 'random' ? 
                activityTypes[Math.floor(Math.random() * activityTypes.length)] : 
                activityType;
            
            const weight = Math.floor(Math.random() * 30) + 15; // 15-45 arasƒ± aƒüƒ±rlƒ±k
            totalWeight += weight;
            
            // V5 formatƒ±nda soru/rubrik detaylarƒ± olu≈ütur
            const details = [];
            const componentWeight = Math.floor(100 / componentCount);
            
            for (let j = 1; j <= componentCount; j++) {
                const isRubric = Math.random() > 0.6; // %40 rubrik, %60 soru
                details.push({
                    id: `A${startIndex + i}.${j}`,
                    isim: isRubric ? `Rubrik ${j}` : `Soru ${j}`,
                    tip: isRubric ? 'Rubrik' : 'Soru',
                    agirlik: componentWeight,
                    puan: Math.floor(Math.random() * 20) + 10, // 10-30 puan arasƒ±
                    ogrenme√áiktilari: [learningOutcomes[Math.floor(Math.random() * learningOutcomes.length)]],
                    aciklama: isRubric ? 
                        `Rubrik deƒüerlendirme kriteri` : 
                        `Deƒüerlendirme sorusu`
                });
            }
            
            // V5 formatƒ±nda grup bilgileri olu≈ütur (A ve B gruplarƒ±)
            const groupMappings = {
                "A": {},
                "B": {}
            };
            
            // A grubu i√ßin sƒ±ralƒ± mapping
            for (let pos = 1; pos <= componentCount; pos++) {
                groupMappings.A[pos.toString()] = `A${startIndex + i}.${pos}`;
            }
            
            // B grubu i√ßin karƒ±≈üƒ±k mapping
            const shuffledPositions = Array.from({length: componentCount}, (_, idx) => idx + 1);
            for (let k = shuffledPositions.length - 1; k > 0; k--) {
                const j = Math.floor(Math.random() * (k + 1));
                [shuffledPositions[k], shuffledPositions[j]] = [shuffledPositions[j], shuffledPositions[k]];
            }
            
            for (let pos = 1; pos <= componentCount; pos++) {
                groupMappings.B[pos.toString()] = `A${startIndex + i}.${shuffledPositions[pos - 1]}`;
            }
            
            // V5 formatƒ±nda etkinlik olu≈ütur
            newActivities.push({
                id: `A${startIndex + i}`,
                etkinlik: selectedType,
                sayi: 1,
                katkiYuzdesi: weight,
                detaylar: details,
                grupBilgileri: {
                    gruplar: ["A", "B"],
                    haritalar: groupMappings
                }
            });
        }
        
        // Aƒüƒ±rlƒ±klarƒ± normalize et (toplam 100 olacak ≈üekilde)
        if (totalWeight > 0) {
            const normalizationFactor = 100 / totalWeight;
            newActivities.forEach(activity => {
                activity.katkiYuzdesi = Math.round(activity.katkiYuzdesi * normalizationFactor);
            });
        }
        
        // V5 formatƒ±nda APP_STATE'i g√ºncelle
        if (!APP_STATE.courseData) {
            APP_STATE.courseData = { 
                dersDegerlendirme: { 
                    yariyilIciEtkinlikleri: [],
                    yariyilSonuEtkinlikleri: []
                },
                ogrenciNotlari: {}
            };
        }
        if (!APP_STATE.courseData.dersDegerlendirme) {
            APP_STATE.courseData.dersDegerlendirme = { 
                yariyilIciEtkinlikleri: [],
                yariyilSonuEtkinlikleri: []
            };
        }
        if (!APP_STATE.courseData.dersDegerlendirme.yariyilIciEtkinlikleri) {
            APP_STATE.courseData.dersDegerlendirme.yariyilIciEtkinlikleri = [];
        }
        
        // Mevcut etkinliklere V5 formatƒ±nda ekle
        APP_STATE.courseData.dersDegerlendirme.yariyilIciEtkinlikleri.push(...newActivities);
        
        // courseData referansƒ±nƒ± g√ºncelle
        if (typeof courseData !== 'undefined') {
            courseData = APP_STATE.courseData;
        }
        
        // courseData'dan assessmentTree'ye d√∂n√º≈üt√ºr
        convertCourseDataToAssessmentTree();
        
        // UI g√ºncellemeleri
        updateAssessmentView();
        renderTree();
        updateCategoryWeights();
        updateAssessmentView();
        
        const summary = `‚úÖ Tam Dosya formatƒ±nda ${activityCount} yarƒ±yƒ±l i√ßi etkinlik olu≈üturuldu!\n` +
                       `üìù Her etkinlikte ${componentCount} soru/rubrik\n` +
                       `üéØ Etkinlik t√ºr√º: ${activityType}\n` +
                       `üé≤ A ve B gruplarƒ± otomatik olu≈üturuldu\n` +
                       `‚öñÔ∏è Aƒüƒ±rlƒ±klar otomatik normalize edildi`;
        
        console.log('‚úÖ Tam Dosya formatƒ±nda yarƒ±yƒ±l i√ßi etkinlik olu≈üturma tamamlandƒ±');
        showModernToast(summary, 'success', 5000);
        
    } catch (error) {
        console.error('‚ùå Tam Dosya yarƒ±yƒ±l i√ßi etkinlik olu≈üturulurken hata:', error);
        showModernToast('Tam Dosya yarƒ±yƒ±l i√ßi etkinlik olu≈üturulamadƒ±!', 'error');
    }
}

/**
 * courseData'dan assessmentTree'ye d√∂n√º≈üt√ºrme fonksiyonu
 */
function convertCourseDataToAssessmentTree() {
    try {
        console.log('üîÑ courseData assessmentTree\'ye d√∂n√º≈üt√ºr√ºl√ºyor...');
        
        if (!APP_STATE.courseData?.dersDegerlendirme) {
            console.warn('‚ö†Ô∏è courseData.dersDegerlendirme bulunamadƒ±');
            return;
        }
        
        const newAssessmentTree = [];
        
        // Yarƒ±yƒ±l i√ßi etkinlikleri d√∂n√º≈üt√ºr
        const termActivities = APP_STATE.courseData.dersDegerlendirme.yariyilIciEtkinlikleri || [];
        termActivities.forEach(activity => {
            const treeNode = {
                id: activity.id,
                name: activity.etkinlik,
                type: activity.etkinlik,
                weight: activity.katkiYuzdesi,
                points: 100, // Varsayƒ±lan
                outcomes: [], // √áocuklarƒ±n outcomes'larƒ±ndan al
                description: `${activity.etkinlik} (${activity.sayi} adet)`,
                expanded: true,
                children: []
            };
            
            // Alt detaylarƒ± ekle
            if (activity.detaylar) {
                activity.detaylar.forEach(detail => {
                    treeNode.children.push({
                        id: detail.id,
                        name: detail.isim,
                        type: detail.tip,
                        weight: detail.agirlik,
                        points: detail.puan,
                        outcomes: detail.ogrenme√áiktilari || [],
                        description: detail.aciklama || '',
                        expanded: false,
                        children: []
                    });
                });
                
                // Outcomes'larƒ± √ßocuklardan topla
                treeNode.outcomes = [...new Set(
                    treeNode.children.flatMap(child => child.outcomes || [])
                )];
            }
            
            newAssessmentTree.push(treeNode);
        });
        
        // Yarƒ±yƒ±l sonu etkinlikleri d√∂n√º≈üt√ºr
        const finalActivities = APP_STATE.courseData.dersDegerlendirme.yariyilSonuEtkinlikleri || [];
        finalActivities.forEach(activity => {
            const treeNode = {
                id: activity.id,
                name: activity.etkinlik,
                type: activity.etkinlik,
                weight: activity.katkiYuzdesi,
                points: 100, // Varsayƒ±lan
                outcomes: [], // √áocuklarƒ±n outcomes'larƒ±ndan al
                description: `${activity.etkinlik} (${activity.sayi} adet)`,
                expanded: true,
                children: []
            };
            
            // Alt detaylarƒ± ekle
            if (activity.detaylar) {
                activity.detaylar.forEach(detail => {
                    treeNode.children.push({
                        id: detail.id,
                        name: detail.isim,
                        type: detail.tip,
                        weight: detail.agirlik,
                        points: detail.puan,
                        outcomes: detail.ogrenme√áiktilari || [],
                        description: detail.aciklama || '',
                        expanded: false,
                        children: []
                    });
                });
                
                // Outcomes'larƒ± √ßocuklardan topla
                treeNode.outcomes = [...new Set(
                    treeNode.children.flatMap(child => child.outcomes || [])
                )];
            }
            
            newAssessmentTree.push(treeNode);
        });
        
        // APP_STATE.assessmentTree'yi g√ºncelle
        APP_STATE.assessmentTree = newAssessmentTree;
        
        console.log('‚úÖ courseData ba≈üarƒ±yla assessmentTree\'ye d√∂n√º≈üt√ºr√ºld√º:', newAssessmentTree.length, 'etkinlik');
        
    } catch (error) {
        console.error('‚ùå courseData assessmentTree\'ye d√∂n√º≈üt√ºr√ºl√ºrken hata:', error);
        showModernToast('Veri d√∂n√º≈üt√ºrme hatasƒ±!', 'error');
    }
}

/**
 * Tam dosya formatƒ±nda yarƒ±yƒ±l sonu etkinlik olu≈üturma fonksiyonu
 */
function generateTamDosyaFinalAssessmentWithParams(activityCount, componentCount, activityType) {
    try {
        showModernToast(`üéØ Tam dosya formatƒ±nda ${activityCount} yarƒ±yƒ±l sonu etkinlik olu≈üturuluyor...`, 'info', 3000);
        
        // Tam dosya formatƒ±na uygun yarƒ±yƒ±l sonu etkinlik t√ºrleri
        const finalActivityTypes = [
            'Final Sƒ±navƒ±', 'Laboratuvar Ara Sƒ±navƒ±', 'Makale Yazma', 'Proje Hazƒ±rlama', 
            'Proje Sunma', 'Proje Tasarƒ±mƒ±/Y√∂netimi', 'Quiz', 'Rapor', 'Rapor Hazƒ±rlama', 
            'Rapor Sunma', 'Seminer', 'S√∂zl√º Sƒ±nav', 'G√∂zlem'
        ];
        
        // Tam dosya formatƒ±na uygun √∂ƒürenme √ßƒ±ktƒ±larƒ±
        const learningOutcomes = ['√ñ√á.1', '√ñ√á.2', '√ñ√á.3', '√ñ√á.4', '√ñ√á.5', '√ñ√á.6', '√ñ√á.7'];
        
        // Yeni V5 formatƒ±nda etkinlikler olu≈ütur
        const newActivities = [];
        let totalWeight = 0;
        
        // Mevcut F etkinlik sayƒ±sƒ±nƒ± bul
        const existingFinalActivities = APP_STATE.courseData?.dersDegerlendirme?.yariyilSonuEtkinlikleri || [];
        let startIndex = existingFinalActivities.length + 1;
        
        for (let i = 0; i < activityCount; i++) {
            const selectedType = activityType === 'random' ? 
                finalActivityTypes[Math.floor(Math.random() * finalActivityTypes.length)] : 
                activityType;
            
            const weight = Math.floor(Math.random() * 40) + 40; // 40-80 arasƒ± aƒüƒ±rlƒ±k (final i√ßin)
            totalWeight += weight;
            
            // V5 formatƒ±nda soru/rubrik detaylarƒ± olu≈ütur
            const details = [];
            const componentWeight = Math.floor(100 / componentCount);
            
            for (let j = 1; j <= componentCount; j++) {
                const isRubric = Math.random() > 0.7; // %30 rubrik, %70 soru (final i√ßin)
                details.push({
                    id: `F${startIndex + i}.${j}`,
                    isim: isRubric ? `Rubrik ${j}` : `Soru ${j}`,
                    tip: isRubric ? 'Rubrik' : 'Soru',
                    agirlik: componentWeight,
                    puan: Math.floor(Math.random() * 25) + 15, // 15-40 puan arasƒ± (final i√ßin)
                    ogrenme√áiktilari: [learningOutcomes[Math.floor(Math.random() * learningOutcomes.length)]],
                    aciklama: isRubric ? 
                        `Final rubrik deƒüerlendirme kriteri` : 
                        `Final deƒüerlendirme sorusu`
                });
            }
            
            // V5 formatƒ±nda grup bilgileri olu≈ütur (A ve B gruplarƒ±)
            const groupMappings = {
                "A": {},
                "B": {}
            };
            
            // A grubu i√ßin sƒ±ralƒ± mapping
            for (let pos = 1; pos <= componentCount; pos++) {
                groupMappings.A[pos.toString()] = `F${startIndex + i}.${pos}`;
            }
            
            // B grubu i√ßin karƒ±≈üƒ±k mapping
            const shuffledPositions = Array.from({length: componentCount}, (_, idx) => idx + 1);
            for (let k = shuffledPositions.length - 1; k > 0; k--) {
                const j = Math.floor(Math.random() * (k + 1));
                [shuffledPositions[k], shuffledPositions[j]] = [shuffledPositions[j], shuffledPositions[k]];
            }
            
            for (let pos = 1; pos <= componentCount; pos++) {
                groupMappings.B[pos.toString()] = `F${startIndex + i}.${shuffledPositions[pos - 1]}`;
            }
            
            // V5 formatƒ±nda etkinlik olu≈ütur
            newActivities.push({
                id: `F${startIndex + i}`,
                etkinlik: selectedType,
                sayi: 1,
                katkiYuzdesi: weight,
                detaylar: details,
                grupBilgileri: {
                    gruplar: ["A", "B"],
                    haritalar: groupMappings
                }
            });
        }
        
        // Aƒüƒ±rlƒ±klarƒ± normalize et (toplam 100 olacak ≈üekilde)
        if (totalWeight > 0) {
            const normalizationFactor = 100 / totalWeight;
            newActivities.forEach(activity => {
                activity.katkiYuzdesi = Math.round(activity.katkiYuzdesi * normalizationFactor);
            });
        }
        
        // V5 formatƒ±nda APP_STATE'i g√ºncelle
        if (!APP_STATE.courseData) {
            APP_STATE.courseData = { 
                dersDegerlendirme: { 
                    yariyilIciEtkinlikleri: [],
                    yariyilSonuEtkinlikleri: []
                },
                ogrenciNotlari: {}
            };
        }
        if (!APP_STATE.courseData.dersDegerlendirme) {
            APP_STATE.courseData.dersDegerlendirme = { 
                yariyilIciEtkinlikleri: [],
                yariyilSonuEtkinlikleri: []
            };
        }
        if (!APP_STATE.courseData.dersDegerlendirme.yariyilSonuEtkinlikleri) {
            APP_STATE.courseData.dersDegerlendirme.yariyilSonuEtkinlikleri = [];
        }
        
        // Mevcut etkinliklere V5 formatƒ±nda ekle
        APP_STATE.courseData.dersDegerlendirme.yariyilSonuEtkinlikleri.push(...newActivities);
        
        // courseData referansƒ±nƒ± g√ºncelle
        if (typeof courseData !== 'undefined') {
            courseData = APP_STATE.courseData;
        }
        
        // courseData'dan assessmentTree'ye d√∂n√º≈üt√ºr
        convertCourseDataToAssessmentTree();
        
        // UI g√ºncellemeleri
        updateAssessmentView();
        renderTree();
        updateCategoryWeights();
        
        const summary = `‚úÖ Tam Dosya formatƒ±nda ${activityCount} yarƒ±yƒ±l sonu etkinlik olu≈üturuldu!\n` +
                       `üìù Her etkinlikte ${componentCount} soru/rubrik\n` +
                       `üéØ Etkinlik t√ºr√º: ${activityType}\n` +
                       `üé≤ A ve B gruplarƒ± otomatik olu≈üturuldu\n` +
                       `‚öñÔ∏è Aƒüƒ±rlƒ±klar otomatik normalize edildi`;
        
        console.log('‚úÖ Tam Dosya formatƒ±nda yarƒ±yƒ±l sonu etkinlik olu≈üturma tamamlandƒ±');
        showModernToast(summary, 'success', 5000);
        
    } catch (error) {
        console.error('‚ùå Tam Dosya yarƒ±yƒ±l sonu etkinlik olu≈üturulurken hata:', error);
        showModernToast('Tam Dosya yarƒ±yƒ±l sonu etkinlik olu≈üturulamadƒ±!', 'error');
    }
}

/**
 * JSON formatƒ±nƒ±n Tam Dosya (not giri≈üi yapƒ±lmƒ±≈ü) olup olmadƒ±ƒüƒ±nƒ± kontrol eder
 */
function isTamDosyaFormat(jsonData) {
    // Tam dosya format kontrol kriterleri
    const hasTamDosyaStructure = jsonData.dersDegerlendirme && 
                                jsonData.dersDegerlendirme.yariyilIciEtkinlikleri &&
                                Array.isArray(jsonData.dersDegerlendirme.yariyilIciEtkinlikleri) &&
                                jsonData.dersDegerlendirme.yariyilIciEtkinlikleri.some(activity => 
                                    activity.grupBilgileri || activity.detaylar
                                );
    
    const hasTamDosyaGrades = jsonData.ogrenciNotlari && 
                             typeof jsonData.ogrenciNotlari === 'object' &&
                             Object.values(jsonData.ogrenciNotlari).some(student => 
                                 student && typeof student === 'object' && 
                                 (student.grupBilgileri || student.etkinlikNotlari)
                             );
    
    console.log("üîç Tam Dosya Format kontrol√º:", {
        hasTamDosyaStructure,
        hasTamDosyaGrades,
        isTamDosya: hasTamDosyaStructure || hasTamDosyaGrades
    });
    
    return hasTamDosyaStructure || hasTamDosyaGrades;
}

/**
 * Temel dosya format i√ßin default grup sistemi olu≈üturur
 */
function createDefaultGroupSystemForTemelDosya() {
    try {
        console.log("üéØ Temel dosya format i√ßin default grup sistemi olu≈üturuluyor...");
        
        if (!APP_STATE.assessmentTree || APP_STATE.assessmentTree.length === 0) {
            console.log("‚ö†Ô∏è Assessment tree bo≈ü, √∂nce aƒüa√ß olu≈üturuluyor...");
            return;
        }
        
        // CourseData yapƒ±sƒ±nƒ± hazƒ±rla
        if (!APP_STATE.courseData) {
            APP_STATE.courseData = {};
        }
        if (!APP_STATE.courseData.grupHaritalari) {
            APP_STATE.courseData.grupHaritalari = {};
        }
        if (!APP_STATE.courseData.ogrenciNotlari) {
            APP_STATE.courseData.ogrenciNotlari = {};
        }
        
        let totalMappingsCreated = 0;
        let componentsProcessed = 0;
        
        // Assessment tree'deki her bile≈üen i√ßin grup sistemi olu≈ütur
        function processNode(node) {
            if (!node || !node.id) return;
            
            console.log(`üîß Bile≈üen i≈üleniyor: ${node.id} - ${node.name}`);
            
            // Bu bile≈üen i√ßin grup bilgisi olu≈ütur
            if (!APP_STATE.courseData.grupHaritalari[node.id]) {
                APP_STATE.courseData.grupHaritalari[node.id] = {
                    gruplar: ['A'],
                    haritalar: {
                        'A': {}
                    }
                };
                console.log(`‚úÖ ${node.id} i√ßin A grubu olu≈üturuldu`);
                componentsProcessed++;
            }
            
            // Alt bile≈üenleri varsa onlarƒ± A grubuna sƒ±rayla ata
            if (node.children && Array.isArray(node.children) && node.children.length > 0) {
                const groupMapping = APP_STATE.courseData.grupHaritalari[node.id].haritalar['A'];
                
                node.children.forEach((child, index) => {
                    const position = (index + 1).toString();
                    const questionId = child.id;
                    
                    // Position: QuestionId formatƒ±nda mapping olu≈ütur
                    groupMapping[position] = questionId;
                    totalMappingsCreated++;
                    
                    console.log(`  üìç ${questionId} ‚Üí A:${position}`);
                });
                
                console.log(`‚úÖ ${node.id} i√ßin ${node.children.length} soru A grubuna atandƒ±`);
            }
            
            // Alt d√ºƒü√ºmleri de i≈üle
            if (node.children && Array.isArray(node.children)) {
                node.children.forEach(child => processNode(child));
            }
        }
        
        // T√ºm assessment tree'yi i≈üle
        APP_STATE.assessmentTree.forEach(rootNode => processNode(rootNode));
        
        // √ñƒürenciler i√ßin grup atamasƒ±
        if (APP_STATE.studentData && Array.isArray(APP_STATE.studentData)) {
            APP_STATE.studentData.forEach(student => {
                // Her √∂ƒürenciyi A grubuna ata
                if (!student.grup || student.grup === '') {
                    student.grup = 'A';
                }
                
                // CourseData'da √∂ƒürenci not yapƒ±sƒ± olu≈ütur
                if (!APP_STATE.courseData.ogrenciNotlari[student.studentId]) {
                    APP_STATE.courseData.ogrenciNotlari[student.studentId] = {
                        grupBilgileri: {}
                    };
                }
                
                // Her bile≈üen i√ßin √∂ƒürenciyi A grubuna ata
                Object.keys(APP_STATE.courseData.grupHaritalari).forEach(componentId => {
                    APP_STATE.courseData.ogrenciNotlari[student.studentId].grupBilgileri[componentId] = 'A';
                });
            });
            
            console.log(`‚úÖ ${APP_STATE.studentData.length} √∂ƒürenci A grubuna atandƒ±`);
        }
        
        // Grup sistemini ba≈ülat
        initializeGroupSystem();
        
        // UI g√ºncellemeleri
        updateStudentTable();
        updateGroupSelectors();
        updateAssessmentView();
        updateAllInlineGroupInputs();
        
        console.log(`\nüìä DEFAULT GRUP Sƒ∞STEMƒ∞ RAPORU:`);
        console.log(`   ‚úÖ ƒ∞≈ülenen bile≈üen: ${componentsProcessed}`);
        console.log(`   üìç Olu≈üturulan mapping: ${totalMappingsCreated}`);
        console.log(`   üë• A grubuna atanan √∂ƒürenci: ${APP_STATE.studentData?.length || 0}`);
        
        showModernToast(`Default grup sistemi olu≈üturuldu: ${componentsProcessed} bile≈üen, ${totalMappingsCreated} soru mapping'i`, "success");
        
    } catch (error) {
        console.error("‚ùå Default grup sistemi olu≈üturulurken hata:", error);
        showModernToast("Default grup sistemi olu≈üturulamadƒ±!", "error");
    }
}

/**
 * Yeni eklenen etkinlik i√ßin otomatik grup atamasƒ±
 */
function assignDefaultGroupsToNewActivity(activityNode) {
    try {
        if (!activityNode || !activityNode.id) {
            console.log("‚ö†Ô∏è Ge√ßersiz etkinlik node'u, grup atamasƒ± yapƒ±lamƒ±yor");
            return;
        }
        
        console.log(`üéØ Yeni etkinlik i√ßin grup atamasƒ±: ${activityNode.id} - ${activityNode.name}`);
        
        // CourseData yapƒ±sƒ±nƒ± hazƒ±rla
        if (!APP_STATE.courseData) {
            APP_STATE.courseData = {};
        }
        if (!APP_STATE.courseData.grupHaritalari) {
            APP_STATE.courseData.grupHaritalari = {};
        }
        
        // Bu etkinlik i√ßin grup bilgisi olu≈ütur
        APP_STATE.courseData.grupHaritalari[activityNode.id] = {
            gruplar: ['A'],
            haritalar: {
                'A': {}
            }
        };
        
        console.log(`‚úÖ ${activityNode.id} i√ßin A grubu olu≈üturuldu`);
        
        // Alt bile≈üenleri varsa onlarƒ± A grubuna sƒ±rayla ata
        if (activityNode.children && Array.isArray(activityNode.children) && activityNode.children.length > 0) {
            // Grup mapping'ini kontrol et ve olu≈ütur
            if (!APP_STATE.courseData.grupHaritalari[activityNode.id].haritalar) {
                APP_STATE.courseData.grupHaritalari[activityNode.id].haritalar = {};
            }
            if (!APP_STATE.courseData.grupHaritalari[activityNode.id].haritalar['A']) {
                APP_STATE.courseData.grupHaritalari[activityNode.id].haritalar['A'] = {};
            }
            
            const groupMapping = APP_STATE.courseData.grupHaritalari[activityNode.id].haritalar['A'];
            
            activityNode.children.forEach((child, index) => {
                const position = (index + 1).toString();
                const questionId = child.id;
                
                // Position: QuestionId formatƒ±nda mapping olu≈ütur
                groupMapping[position] = questionId;
                
                console.log(`  üìç ${questionId} ‚Üí A:${position}`);
            });
            
            console.log(`‚úÖ ${activityNode.id} i√ßin ${activityNode.children.length} soru A grubuna atandƒ±`);
        }
        
        // Mevcut √∂ƒürenciler i√ßin bu etkinlikte A grubu atamasƒ±
        if (APP_STATE.studentData && Array.isArray(APP_STATE.studentData)) {
            APP_STATE.studentData.forEach(student => {
                // CourseData'da √∂ƒürenci yapƒ±sƒ±nƒ± kontrol et
                if (!APP_STATE.courseData.ogrenciNotlari) {
                    APP_STATE.courseData.ogrenciNotlari = {};
                }
                if (!APP_STATE.courseData.ogrenciNotlari[student.studentId]) {
                    APP_STATE.courseData.ogrenciNotlari[student.studentId] = {
                        grupBilgileri: {}
                    };
                }
                
                // Bu etkinlik i√ßin √∂ƒürenciyi A grubuna ata
                APP_STATE.courseData.ogrenciNotlari[student.studentId].grupBilgileri[activityNode.id] = 'A';
            });
            
            console.log(`‚úÖ ${APP_STATE.studentData.length} √∂ƒürenci ${activityNode.id} etkinliƒüi i√ßin A grubuna atandƒ±`);
        }
        
        // UI g√ºncellemeleri
        updateAssessmentView();
        updateAllInlineGroupInputs();
        
        const mappingCount = activityNode.children ? activityNode.children.length : 0;
        showModernToast(`${activityNode.name} i√ßin A grubu olu≈üturuldu (${mappingCount} soru atandƒ±)`, "success");
        
    } catch (error) {
        console.error("‚ùå Yeni etkinlik i√ßin grup atamasƒ± yapƒ±lƒ±rken hata:", error);
        showModernToast("Yeni etkinlik grup atamasƒ± ba≈üarƒ±sƒ±z!", "error");
    }
}

/**
 * Yeni eklenen alt bile≈üen i√ßin otomatik mapping atamasƒ±
 */
function assignDefaultMappingToNewComponent(parentId, newComponent) {
    try {
        if (!parentId || !newComponent || !newComponent.id) {
            console.log("‚ö†Ô∏è Ge√ßersiz parametreler, mapping atamasƒ± yapƒ±lamƒ±yor");
            return;
        }
        
        console.log(`üéØ Yeni bile≈üen i√ßin mapping atamasƒ±: ${newComponent.id} ‚Üí ${parentId}`);
        
        // CourseData yapƒ±sƒ±nƒ± kontrol et
        if (!APP_STATE.courseData?.grupHaritalari?.[parentId]?.haritalar?.['A']) {
            console.log("‚ö†Ô∏è Parent etkinlik i√ßin A grubu bulunamadƒ±, √∂nce grup olu≈üturuluyor");
            
            // Parent i√ßin grup sistemi olu≈ütur
            if (!APP_STATE.courseData) APP_STATE.courseData = {};
            if (!APP_STATE.courseData.grupHaritalari) APP_STATE.courseData.grupHaritalari = {};
            if (!APP_STATE.courseData.grupHaritalari[parentId]) {
                APP_STATE.courseData.grupHaritalari[parentId] = {
                    gruplar: ['A'],
                    haritalar: { 'A': {} }
                };
            }
        }
        
        const groupMapping = APP_STATE.courseData.grupHaritalari[parentId].haritalar['A'];
        
        // Mevcut en y√ºksek pozisyonu bul
        const existingPositions = Object.keys(groupMapping).map(pos => parseInt(pos)).filter(pos => !isNaN(pos));
        const nextPosition = existingPositions.length > 0 ? Math.max(...existingPositions) + 1 : 1;
        
        // Yeni bile≈üeni sƒ±radaki pozisyona ata
        groupMapping[nextPosition.toString()] = newComponent.id;
        
        console.log(`‚úÖ ${newComponent.id} ‚Üí A:${nextPosition} atandƒ±`);
        
        // UI g√ºncellemeleri
        updateAssessmentView();
        updateAllInlineGroupInputs();
        
        showModernToast(`${newComponent.name} A:${nextPosition} pozisyonuna atandƒ±`, "success");
        
    } catch (error) {
        console.error("‚ùå Yeni bile≈üen mapping atamasƒ± yapƒ±lƒ±rken hata:", error);
        showModernToast("Yeni bile≈üen mapping atamasƒ± ba≈üarƒ±sƒ±z!", "error");
    }
}

// Global fonksiyonlar
window.createGroupMappingForActivity = createGroupMappingForActivity;
window.loadGroupMappingsFromAssessmentData = loadGroupMappingsFromAssessmentData;
window.loadStudentGradesNewFormat = loadStudentGradesNewFormat;
window.generateTamDosyaTermAssessmentWithParams = generateTamDosyaTermAssessmentWithParams;
window.generateTamDosyaFinalAssessmentWithParams = generateTamDosyaFinalAssessmentWithParams;
window.isTamDosyaFormat = isTamDosyaFormat;
window.createDefaultGroupSystemForTemelDosya = createDefaultGroupSystemForTemelDosya;
window.assignDefaultGroupsToNewActivity = assignDefaultGroupsToNewActivity;
window.assignDefaultMappingToNewComponent = assignDefaultMappingToNewComponent;

// =====================================================
// ETKƒ∞NLƒ∞K SE√áENEK MODAL EVENT LISTENERS
// =====================================================

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
    // Etkinlik se√ßenek kartlarƒ±
    const activityModal = document.getElementById('activityOptionsModal');
    if (activityModal) {
        activityModal.addEventListener('click', function(e) {
            const card = e.target.closest('.activity-option-card');
            if (card) {
                selectActivityOption(card);
            }
            
            // Count butonlarƒ±
            if (e.target.classList.contains('count-btn')) {
                const target = e.target.dataset.target;
                const delta = e.target.classList.contains('plus') ? 1 : -1;
                updateCountValue(target, delta);
                
                // Puan alanƒ±nƒ± kontrol et
                updatePointsFieldVisibility();
            }
            
            // Modern close butonlarƒ±
            if (e.target.classList.contains('modern-close')) {
                closeActivityOptionsModal();
            }
        });
    }
    
    // Apply butonu
    const applyBtn = document.getElementById('applyActivityOptions');
    if (applyBtn) {
        applyBtn.addEventListener('click', applyActivityOptions);
    }
    
    // Bo≈ü bƒ±rak butonu
    const emptyBtn = document.getElementById('emptyActivityOption');
    if (emptyBtn) {
        emptyBtn.addEventListener('click', function() {
            applyEmptyOption();
            closeActivityOptionsModal();
        });
    }
    
    // Count input'larƒ± i√ßin limit kontrol√º ve puan alanƒ± kontrol√º
    ['questionCount', 'rubricCount'].forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('input', function() {
                const value = parseInt(this.value);
                if (value < 1) this.value = 1;
                if (value > 50) this.value = 50;
                
                // Puan alanƒ±nƒ± kontrol et
                updatePointsFieldVisibility();
            });
            
            // Sayfa y√ºklendiƒüinde de kontrol et
            setTimeout(() => {
                updatePointsFieldVisibility();
            }, 100);
        }
    });
    
    // Puan input'larƒ± i√ßin limit kontrol√º
    ['questionDefaultPoints', 'rubricDefaultPoints'].forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('input', function() {
                const value = parseInt(this.value);
                if (value < 1) this.value = 1;
                if (value > 100) this.value = 100;
            });
        }
    });
    
    // √ñ√á se√ßim event listener'larƒ±
    const outcomesSelect = document.getElementById('activityOutcomesSelect');
    if (outcomesSelect) {
        outcomesSelect.addEventListener('change', updateActivityOutcomesPreview);
    }
    
    // √ñ√á hƒ±zlƒ± aksiyon butonlarƒ±
    const selectAllBtn = document.getElementById('selectAllActivityOutcomes');
    if (selectAllBtn) {
        selectAllBtn.addEventListener('click', selectAllActivityOutcomes);
    }
    
    const randomSelectBtn = document.getElementById('randomSelectActivityOutcomes');
    if (randomSelectBtn) {
        randomSelectBtn.addEventListener('click', randomSelectActivityOutcomes);
    }
    
    const clearAllBtn = document.getElementById('clearAllActivityOutcomes');
    if (clearAllBtn) {
        clearAllBtn.addEventListener('click', clearAllActivityOutcomes);
    }
});

// =====================================================
// ETKƒ∞NLƒ∞K MODAL √ñ√á SE√áƒ∞M FONKSƒ∞YONLARI
// =====================================================

/**
 * Etkinlik modal √ñ√á se√ßim alanƒ±nƒ± doldur
 */
function populateActivityOutcomesSelect() {
    const select = document.getElementById('activityOutcomesSelect');
    if (!select) {
        console.warn('√ñ√á select elementi bulunamadƒ±');
        return;
    }
    
    // Debug: APP_STATE durumunu kontrol et
    console.log('APP_STATE.courseData:', APP_STATE.courseData);
    
    if (!APP_STATE.courseData) {
        console.warn('CourseData bulunamadƒ±');
        select.innerHTML = '<option disabled>√ñnce ders JSON dosyasƒ± y√ºkleyin</option>';
        return;
    }
    
    // Farklƒ± √ñ√á alanlarƒ±nƒ± kontrol et
    let outcomes = null;
    if (APP_STATE.courseData.dersOgrenme√áiktilari) {
        outcomes = APP_STATE.courseData.dersOgrenme√áiktilari;
    } else if (APP_STATE.courseData.ogrenimCiktilari) {
        outcomes = APP_STATE.courseData.ogrenimCiktilari;
    } else if (APP_STATE.courseData.learningOutcomes) {
        outcomes = APP_STATE.courseData.learningOutcomes;
    } else if (APP_STATE.courseData.outcomes) {
        outcomes = APP_STATE.courseData.outcomes;
    }
    
    console.log('Bulunan √ñ√áler:', outcomes);
    
    // Mevcut se√ßimleri temizle
    select.innerHTML = '';
    
    if (!outcomes || !Array.isArray(outcomes) || outcomes.length === 0) {
        select.innerHTML = '<option disabled>√ñ√á bulunamadƒ±</option>';
        console.warn('√ñ√á verisi bulunamadƒ± veya bo≈ü');
        return;
    }
    
    // √ñ√á'leri ekle
    outcomes.forEach((outcome, index) => {
        const option = document.createElement('option');
        
        // Farklƒ± veri formatlarƒ±nƒ± destekle
        if (outcome.id && outcome.aciklama) {
            // JSON formatƒ±: {id: "√ñ√á.1", aciklama: "..."}
            option.value = outcome.id;
            option.textContent = `${outcome.id} - ${outcome.aciklama}`;
        } else if (outcome.kod && outcome.baslik) {
            option.value = outcome.kod;
            option.textContent = `${outcome.kod} - ${outcome.baslik}`;
        } else if (outcome.code && outcome.title) {
            option.value = outcome.code;
            option.textContent = `${outcome.code} - ${outcome.title}`;
        } else if (outcome.id && outcome.name) {
            option.value = outcome.id;
            option.textContent = `${outcome.id} - ${outcome.name}`;
        } else if (typeof outcome === 'string') {
            option.value = outcome;
            option.textContent = outcome;
        } else {
            // Fallback
            option.value = `√ñ√á.${index + 1}`;
            option.textContent = `√ñ√á.${index + 1} - ${outcome.description || outcome.aciklama || outcome.baslik || outcome.title || 'Ogrenme Ciktisi'}`;
        }
        
        select.appendChild(option);
    });
    
    console.log(`‚úÖ ${outcomes.length} adet √ñ√á y√ºklendi`);
    
    // √ñnizlemeyi g√ºncelle
    updateActivityOutcomesPreview();
}

/**
 * Puan alanlarƒ±nƒ±n g√∂r√ºn√ºrl√ºƒü√ºn√º g√ºncelle
 */
function updatePointsFieldVisibility() {
    // Soru puan alanƒ± kontrol√º
    const questionCount = parseInt(document.getElementById('questionCount')?.value || 1);
    const questionPointsGroup = document.getElementById('questionPointsGroup');
    const questionPointsInput = document.getElementById('questionDefaultPoints');
    const questionPointsInfo = document.getElementById('questionPointsInfo');
    
    if (questionPointsGroup && questionPointsInput && questionPointsInfo) {
        if (questionCount > 1) {
            // Birden fazla soru - puan alanƒ±nƒ± devre dƒ±≈üƒ± bƒ±rak ve bilgi g√∂ster
            questionPointsInput.disabled = true;
            questionPointsGroup.classList.add('disabled');
            questionPointsInfo.style.display = 'block';
        } else {
            // Tek soru - puan alanƒ±nƒ± aktif et ve bilgiyi gizle
            questionPointsInput.disabled = false;
            questionPointsGroup.classList.remove('disabled');
            questionPointsInfo.style.display = 'none';
        }
    }
    
    // Rubrik puan alanƒ± kontrol√º
    const rubricCount = parseInt(document.getElementById('rubricCount')?.value || 1);
    const rubricPointsGroup = document.getElementById('rubricPointsGroup');
    const rubricPointsInput = document.getElementById('rubricDefaultPoints');
    const rubricPointsInfo = document.getElementById('rubricPointsInfo');
    
    if (rubricPointsGroup && rubricPointsInput && rubricPointsInfo) {
        if (rubricCount > 1) {
            // Birden fazla rubrik - puan alanƒ±nƒ± devre dƒ±≈üƒ± bƒ±rak ve bilgi g√∂ster
            rubricPointsInput.disabled = true;
            rubricPointsGroup.classList.add('disabled');
            rubricPointsInfo.style.display = 'block';
        } else {
            // Tek rubrik - puan alanƒ±nƒ± aktif et ve bilgiyi gizle
            rubricPointsInput.disabled = false;
            rubricPointsGroup.classList.remove('disabled');
            rubricPointsInfo.style.display = 'none';
        }
    }
}

/**
 * Se√ßili √ñ√á'lerin √∂nizlemesini g√ºncelle
 */
function updateActivityOutcomesPreview() {
    const select = document.getElementById('activityOutcomesSelect');
    const previewContainer = document.getElementById('selectedOutcomesPreview');
    
    if (!select || !previewContainer) return;
    
    const selectedOptions = Array.from(select.selectedOptions);
    
    if (selectedOptions.length === 0) {
        previewContainer.innerHTML = '<span class="no-selection">Hen√ºz se√ßim yapƒ±lmadƒ±</span>';
        return;
    }
    
    // Se√ßili √ñ√á'leri tag olarak g√∂ster
    previewContainer.innerHTML = selectedOptions
        .map(option => `<span class="outcome-preview-tag">${option.value}</span>`)
        .join('');
}

/**
 * T√ºm √ñ√á'leri se√ß
 */
function selectAllActivityOutcomes() {
    const select = document.getElementById('activityOutcomesSelect');
    if (!select) return;
    
    Array.from(select.options).forEach(option => {
        option.selected = true;
    });
    
    updateActivityOutcomesPreview();
    showModernToast("T√ºm √ñ√áler se√ßildi!", "success");
}

/**
 * Rastgele √ñ√á se√ß (1-3 adet)
 */
function randomSelectActivityOutcomes() {
    const select = document.getElementById('activityOutcomesSelect');
    if (!select || select.options.length === 0) return;
    
    // √ñnce t√ºm se√ßimleri temizle
    Array.from(select.options).forEach(option => {
        option.selected = false;
    });
    
    // Rastgele 1-3 adet se√ß
    const optionsArray = Array.from(select.options);
    const randomCount = Math.floor(Math.random() * 3) + 1; // 1-3 arasƒ±
    const selectedCount = Math.min(randomCount, optionsArray.length);
    
    // Rastgele se√ßim yap
    const shuffled = optionsArray.sort(() => 0.5 - Math.random());
    for (let i = 0; i < selectedCount; i++) {
        shuffled[i].selected = true;
    }
    
    updateActivityOutcomesPreview();
    showModernToast(`${selectedCount} adet √ñ√á rastgele se√ßildi!`, "success");
}

/**
 * T√ºm √ñ√á se√ßimlerini temizle
 */
function clearAllActivityOutcomes() {
    const select = document.getElementById('activityOutcomesSelect');
    if (!select) return;
    
    Array.from(select.options).forEach(option => {
        option.selected = false;
    });
    
    updateActivityOutcomesPreview();
    showModernToast("√ñ√á se√ßimleri temizlendi!", "info");
}

/**
 * Se√ßili √ñ√á'leri al
 * @returns {Array} Se√ßili √ñ√á kodlarƒ±
 */
function getSelectedActivityOutcomes() {
    const select = document.getElementById('activityOutcomesSelect');
    if (!select) return [];
    
    return Array.from(select.selectedOptions).map(option => option.value);
}


/**
 * Rastgele aƒüƒ±rlƒ±k daƒüƒ±lƒ±mƒ± olu≈ütur
 * @param {number} count - √ñƒüe sayƒ±sƒ±
 * @returns {Array} - Aƒüƒ±rlƒ±k dizisi (toplamƒ± 100)
 */
function generateRandomWeights(count) {
    if (count === 1) return [100];
    
    // Rastgele sayƒ±lar √ºret
    let weights = [];
    for (let i = 0; i < count - 1; i++) {
        weights.push(Math.random());
    }
    
    // Sƒ±rala
    weights.sort((a, b) => a - b);
    
    // Aralƒ±klara √ßevir
    let intervals = [];
    intervals.push(weights[0]);
    for (let i = 1; i < weights.length; i++) {
        intervals.push(weights[i] - weights[i-1]);
    }
    intervals.push(1 - weights[weights.length - 1]);
    
    // 100'e √ßevir ve yuvarla
    let result = intervals.map(w => Math.max(1, Math.round(w * 100)));
    
    // Toplamƒ± 100 yap
    let total = result.reduce((a, b) => a + b, 0);
    if (total !== 100) {
        let diff = 100 - total;
        // Farkƒ± en b√ºy√ºk deƒüere ekle/√ßƒ±kar
        let maxIndex = result.indexOf(Math.max(...result));
        result[maxIndex] += diff;
        result[maxIndex] = Math.max(1, result[maxIndex]);
    }
    
    return result;
}


// Puan input'larƒ± i√ßin limit kontrol√º
document.addEventListener('DOMContentLoaded', function() {
    ['questionDefaultPoints', 'rubricDefaultPoints'].forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('input', function() {
                const value = parseInt(this.value);
                if (value < 1) this.value = 1;
                if (value > 100) this.value = 100;
            });
        }
    });
    
    // Status badge'leri ilk y√ºklemede g√ºncelle (slider formatƒ±nƒ± kullan)
    setTimeout(() => {
        updatePassFailCounts();
    }, 100);
});

// =====================================================
// ETKƒ∞NLƒ∞K TA≈ûIMA FONKSƒ∞YONLARI
// =====================================================

/**
 * Etkinliƒüi yukarƒ± ta≈üƒ±
 * @param {string} activityId - Ta≈üƒ±nacak etkinlik ID'si
 */
async function moveActivityUp(activityId) {
    try {
        const node = findNodeById(activityId);
        if (!node) {
            showModernToast("Etkinlik bulunamadƒ±!", "error");
            return;
        }
        
        // Ana aƒüa√ßta mevcut sƒ±rasƒ±nƒ± bul
        const currentIndex = APP_STATE.assessmentTree.findIndex(n => n.id === activityId);
        
        if (currentIndex <= 0) {
            showModernToast("Bu etkinlik zaten en √ºstte!", "warning");
            return;
        }
        
        // Aynƒ± kategorideki √∂nceki etkinliƒüi bul
        const isTermActivity = activityId.startsWith('A');
        let previousIndex = -1;
        for (let i = currentIndex - 1; i >= 0; i--) {
            const nodeAtIndex = APP_STATE.assessmentTree[i];
            if ((isTermActivity && nodeAtIndex.id.startsWith('A')) || 
                (!isTermActivity && nodeAtIndex.id.startsWith('F'))) {
                previousIndex = i;
                break;
            }
        }
        
        if (previousIndex === -1) {
            showModernToast("Bu etkinlik kategorisinde zaten en √ºstte!", "warning");
            return;
        }
        
        // Onay al
        const confirmed = await showModernConfirm(
            'Etkinlik Ta≈üƒ±ma Onayƒ±',
            `${getComponentDisplayName(activityId)} etkinliƒüini yukarƒ± ta≈üƒ±mak istediƒüinizden emin misiniz?\\n\\nBu i≈ülem etkinliƒüin sƒ±rasƒ±nƒ± deƒüi≈ütirecek ve ID'lerini yeniden d√ºzenleyecektir.`,
            {
                confirmText: 'Evet, Ta≈üƒ±',
                cancelText: 'ƒ∞ptal',
                headerClass: 'info-action',
                iconClass: 'info'
            }
        );
        
        if (!confirmed) return;
        
        // Grup haritalamalarƒ±nƒ± kaydet
        const movedActivity = APP_STATE.assessmentTree[currentIndex];
        const savedMappings = {};
        saveNodeGroupMappings(movedActivity, savedMappings);
        
        // Ana aƒüa√ßta sƒ±ralarƒ± deƒüi≈ütir
        APP_STATE.assessmentTree.splice(currentIndex, 1);
        APP_STATE.assessmentTree.splice(previousIndex, 0, movedActivity);
        
        // T√ºm sistemdeki ID'leri yeniden d√ºzenle
        const oldToNewIdMap = await reorganizeAllIds();
        
        // Grup haritalamalarƒ±nƒ± geri y√ºkle
        restoreGroupMappings(savedMappings, oldToNewIdMap);
        
        // Aƒüacƒ± yeniden render et
        renderTree();
        
        // Deƒüerlendirme sekmesini g√ºncelle - CRITICAL SYNC
        updateAssessmentView();
        
        showModernToast(`${getComponentDisplayName(activityId)} etkinliƒüi yukarƒ± ta≈üƒ±ndƒ±!`, "success");
        
    } catch (error) {
        console.error("Etkinlik yukarƒ± ta≈üƒ±nƒ±rken hata:", error);
        showModernToast("Etkinlik ta≈üƒ±nƒ±rken hata olu≈ütu!", "error");
    }
}

/**
 * Etkinliƒüi a≈üaƒüƒ± ta≈üƒ±
 * @param {string} activityId - Ta≈üƒ±nacak etkinlik ID'si
 */
async function moveActivityDown(activityId) {
    try {
        const node = findNodeById(activityId);
        if (!node) {
            showModernToast("Etkinlik bulunamadƒ±!", "error");
            return;
        }
        
        // Ana aƒüa√ßta mevcut sƒ±rasƒ±nƒ± bul
        const currentIndex = APP_STATE.assessmentTree.findIndex(n => n.id === activityId);
        
        if (currentIndex >= APP_STATE.assessmentTree.length - 1) {
            showModernToast("Bu etkinlik zaten en altta!", "warning");
            return;
        }
        
        // Aynƒ± kategorideki sonraki etkinliƒüi bul
        const isTermActivity = activityId.startsWith('A');
        let nextIndex = -1;
        for (let i = currentIndex + 1; i < APP_STATE.assessmentTree.length; i++) {
            const nodeAtIndex = APP_STATE.assessmentTree[i];
            if ((isTermActivity && nodeAtIndex.id.startsWith('A')) || 
                (!isTermActivity && nodeAtIndex.id.startsWith('F'))) {
                nextIndex = i;
                break;
            }
        }
        
        if (nextIndex === -1) {
            showModernToast("Bu etkinlik kategorisinde zaten en altta!", "warning");
            return;
        }
        
        // Onay al
        const confirmed = await showModernConfirm(
            'Etkinlik Ta≈üƒ±ma Onayƒ±',
            `${getComponentDisplayName(activityId)} etkinliƒüini a≈üaƒüƒ± ta≈üƒ±mak istediƒüinizden emin misiniz?\\n\\nBu i≈ülem etkinliƒüin sƒ±rasƒ±nƒ± deƒüi≈ütirecek ve ID'lerini yeniden d√ºzenleyecektir.`,
            {
                confirmText: 'Evet, Ta≈üƒ±',
                cancelText: 'ƒ∞ptal',
                headerClass: 'info-action',
                iconClass: 'info'
            }
        );
        
        if (!confirmed) return;
        
        // Grup haritalamalarƒ±nƒ± kaydet
        const movedActivity = APP_STATE.assessmentTree[currentIndex];
        const savedMappings = {};
        saveNodeGroupMappings(movedActivity, savedMappings);
        
        // Ana aƒüa√ßta sƒ±ralarƒ± deƒüi≈ütir
        APP_STATE.assessmentTree.splice(currentIndex, 1);
        APP_STATE.assessmentTree.splice(nextIndex, 0, movedActivity);
        
        // T√ºm sistemdeki ID'leri yeniden d√ºzenle
        const oldToNewIdMap = await reorganizeAllIds();
        
        // Grup haritalamalarƒ±nƒ± geri y√ºkle
        restoreGroupMappings(savedMappings, oldToNewIdMap);
        
        // Aƒüacƒ± yeniden render et
        renderTree();
        
        // Deƒüerlendirme sekmesini g√ºncelle - CRITICAL SYNC
        updateAssessmentView();
        
        showModernToast(`${getComponentDisplayName(activityId)} etkinliƒüi a≈üaƒüƒ± ta≈üƒ±ndƒ±!`, "success");
        
    } catch (error) {
        console.error("Etkinlik a≈üaƒüƒ± ta≈üƒ±nƒ±rken hata:", error);
        showModernToast("Etkinlik ta≈üƒ±nƒ±rken hata olu≈ütu!", "error");
    }
}

/**
 * Etkinlik ID'lerini yeniden d√ºzenle
 * @param {Array} categoryNodes - Kategori d√ºƒü√ºmleri
 * @param {boolean} isTermActivity - Yarƒ±yƒ±l i√ßi etkinlik mi
 */
async function reassignActivityIds(categoryNodes, isTermActivity) {
    const prefix = isTermActivity ? 'A' : 'F';
    
    console.log(`üîÑ ID yeniden d√ºzenleme ba≈ülƒ±yor: ${prefix} kategorisi, ${categoryNodes.length} etkinlik`);
    
    // Eski ID'leri ve grup haritalamalarƒ±nƒ± sakla
    const oldToNewIdMap = {};
    const savedGroupMappings = {};
    
    // √ñnce t√ºm eski ID'leri ve grup haritalamalarƒ±nƒ± kaydet
    categoryNodes.forEach((node, index) => {
        const oldId = node.id;
        const newId = `${prefix}${index + 1}`;
        oldToNewIdMap[oldId] = newId;
        
        console.log(`üìù ID mapping: ${oldId} ‚Üí ${newId}`);
        
        // Bu d√ºƒü√ºm ve alt d√ºƒü√ºmlerinin grup haritalamalarƒ±nƒ± kaydet
        saveNodeGroupMappings(node, savedGroupMappings);
    });
    
    // ID'leri g√ºncelle
    categoryNodes.forEach((node, index) => {
        const newId = `${prefix}${index + 1}`;
        updateNodeIdRecursive(node, newId);
    });
    
    // Grup haritalamalarƒ±nƒ± yeni ID'lerle geri y√ºkle
    restoreGroupMappings(savedGroupMappings, oldToNewIdMap);
    
    // Ana aƒüacƒ± g√ºncelle
    updateAssessmentTreeAfterReassign(categoryNodes, isTermActivity);
    
    console.log(`‚úÖ ID yeniden d√ºzenleme tamamlandƒ±: ${prefix} kategorisi`);
    
    // ID mapping'leri d√∂nd√ºr
    return oldToNewIdMap;
}

/**
 * D√ºƒü√ºm ve alt d√ºƒü√ºmlerinin grup haritalamalarƒ±nƒ± kaydet (YENƒ∞ FORMAT)
 */
function saveNodeGroupMappings(node, savedMappings) {
    if (!APP_STATE.courseData?.grupHaritalari) return;
    
    console.log(`üíæ saveNodeGroupMappings √ßaƒürƒ±ldƒ±: ${node.id}`);
    
    // Yeni format: grupHaritalari[activityId] = { gruplar: [], haritalar: {} }
    if (APP_STATE.courseData.grupHaritalari[node.id]) {
        savedMappings[node.id] = JSON.parse(JSON.stringify(APP_STATE.courseData.grupHaritalari[node.id]));
        console.log(`‚úÖ Grup haritalama kaydedildi: ${node.id}`, savedMappings[node.id]);
    }
    
    // Alt d√ºƒü√ºmler i√ßin recursive kaydetme
    if (node.children && node.children.length > 0) {
        node.children.forEach(child => {
            saveNodeGroupMappings(child, savedMappings);
        });
    }
}

/**
 * Grup haritalamalarƒ±nƒ± yeni ID'lerle geri y√ºkle
 */
function restoreGroupMappings(savedMappings, oldToNewIdMap) {
    if (!APP_STATE.courseData?.grupHaritalari || !savedMappings || !oldToNewIdMap) return;
    
    console.log(`üîÑ restoreGroupMappings ba≈ülƒ±yor...`);
    console.log(`üìä Kayƒ±tlƒ± haritalamalar:`, Object.keys(savedMappings));
    console.log(`üìä ID Mapping:`, oldToNewIdMap);
    
    // CRITICAL FIX: ID'ler ger√ßekten deƒüi≈üip deƒüi≈ümediƒüini kontrol et
    const hasActualIdChanges = Object.keys(oldToNewIdMap).some(oldId => oldId !== oldToNewIdMap[oldId]);
    
    if (!hasActualIdChanges) {
        console.log(`‚ö†Ô∏è ID'ler deƒüi≈ümediƒüi i√ßin haritalama geri y√ºkleme atlanƒ±yor`);
        return;
    }
    
    // √ñnce sadece ger√ßekten deƒüi≈üen ID'lere ait haritalamlarƒ± temizle
    Object.keys(oldToNewIdMap).forEach(oldId => {
        const newId = oldToNewIdMap[oldId];
        if (oldId !== newId && APP_STATE.courseData.grupHaritalari[oldId]) {
            delete APP_STATE.courseData.grupHaritalari[oldId];
            console.log(`üóëÔ∏è Eski haritalama silindi: ${oldId}`);
        }
    });
    
    // Yeni ID'lerle haritalamlarƒ± geri y√ºkle
    Object.keys(savedMappings).forEach(oldId => {
        const newId = oldToNewIdMap[oldId];
        if (newId && savedMappings[oldId] && oldId !== newId) {
            // Yeni ID i√ßin haritalamayƒ± kopyala
            APP_STATE.courseData.grupHaritalari[newId] = JSON.parse(JSON.stringify(savedMappings[oldId]));
            
            // CRITICAL: Alt soru ID'lerini de g√ºncelle
            if (savedMappings[oldId].haritalar) {
                Object.keys(savedMappings[oldId].haritalar).forEach(groupName => {
                    const groupMapping = savedMappings[oldId].haritalar[groupName];
                    const updatedGroupMapping = {};
                    
                    // Her sƒ±ra numarasƒ± i√ßin yeni soru ID'sini hesapla
                    Object.keys(groupMapping).forEach(position => {
                        const oldQuestionId = groupMapping[position];
                        
                        // Eski soru ID'sinden yeni soru ID'sine √ßevir
                        if (oldQuestionId.startsWith(oldId + '.')) {
                            const questionNumber = oldQuestionId.split('.').pop();
                            const newQuestionId = `${newId}.${questionNumber}`;
                            updatedGroupMapping[position] = newQuestionId;
                            console.log(`üìù Soru ID g√ºncellendi: ${oldQuestionId} ‚Üí ${newQuestionId}`);
                        } else {
                            updatedGroupMapping[position] = oldQuestionId;
                        }
                    });
                    
                    APP_STATE.courseData.grupHaritalari[newId].haritalar[groupName] = updatedGroupMapping;
                });
            }
            
            console.log(`‚úÖ Grup haritalama geri y√ºklendi: ${oldId} ‚Üí ${newId}`, APP_STATE.courseData.grupHaritalari[newId]);
        }
    });
}

/**
 * ID yeniden d√ºzenlemeden sonra ana aƒüacƒ± g√ºncelle
 */
function updateAssessmentTreeAfterReassign(updatedCategoryNodes, isTermActivity) {
    // Diƒüer kategorinin d√ºƒü√ºmlerini al
    const otherCategoryNodes = APP_STATE.assessmentTree.filter(node => 
        isTermActivity ? node.id.startsWith('F') : node.id.startsWith('A')
    );
    
    // Ana aƒüacƒ± yeniden olu≈ütur
    APP_STATE.assessmentTree = [
        ...(isTermActivity ? updatedCategoryNodes : otherCategoryNodes),
        ...(isTermActivity ? otherCategoryNodes : updatedCategoryNodes)
    ];
    
    console.log(`üîÑ Ana aƒüa√ß g√ºncellendi. Toplam etkinlik: ${APP_STATE.assessmentTree.length}`);
}

/**
 * T√ºm etkinlik ve alt bile≈üen ID'lerini yeniden d√ºzenle
 * Bu fonksiyon ta≈üƒ±ma i≈ülemlerinden sonra √ßaƒürƒ±lƒ±r
 */
async function reorganizeAllIds() {
    console.log('üéØ Kapsamlƒ± ID yeniden d√ºzenleme ba≈ülƒ±yor...');
    
    try {
        // T√ºm grup haritalamalarƒ±nƒ± kaydet
        const savedMappings = {};
        APP_STATE.assessmentTree.forEach(node => {
            saveNodeGroupMappings(node, savedMappings);
        });
        
        // ID mapping'lerini topla
        const oldToNewIdMap = {};
        
        // Yarƒ±yƒ±l i√ßi etkinlikleri yeniden d√ºzenle (A1, A2, A3...)
        const termActivities = APP_STATE.assessmentTree.filter(node => 
            node.id.startsWith('A') || node.id.startsWith('A_TEMP_')
        );
        termActivities.forEach((node, index) => {
            const oldId = node.id;
            const newId = `A${index + 1}`;
            oldToNewIdMap[oldId] = newId;
            
            // Ana etkinlik ID'sini g√ºncelle
            updateNodeIdRecursive(node, newId);
            
            console.log(`üìù Yarƒ±yƒ±l ƒ∞√ßi: ${oldId} ‚Üí ${newId}`);
        });
        
        // Yarƒ±yƒ±l sonu etkinlikleri yeniden d√ºzenle (F1, F2, F3...)
        const finalActivities = APP_STATE.assessmentTree.filter(node => 
            node.id.startsWith('F') || node.id.startsWith('F_TEMP_')
        );
        finalActivities.forEach((node, index) => {
            const oldId = node.id;
            const newId = `F${index + 1}`;
            oldToNewIdMap[oldId] = newId;
            
            // Ana etkinlik ID'sini g√ºncelle
            updateNodeIdRecursive(node, newId);
            
            console.log(`üìù Yarƒ±yƒ±l Sonu: ${oldId} ‚Üí ${newId}`);
        });
        
        // Ana aƒüacƒ± yeniden sƒ±rala (A etkinlikleri √∂nce, F etkinlikleri sonra)
        APP_STATE.assessmentTree = [
            ...termActivities,
            ...finalActivities
        ];
        
        // Grup haritalamalarƒ±nƒ± geri y√ºkle
        restoreGroupMappings(savedMappings, oldToNewIdMap);
        
        // Deƒüerlendirme sekmesini g√ºncelle - CRITICAL SYNC
        updateAssessmentView();
        
        console.log('‚úÖ Kapsamlƒ± ID yeniden d√ºzenleme tamamlandƒ±');
        console.log('üìä ID Mapping:', oldToNewIdMap);
        
        return oldToNewIdMap;
        
    } catch (error) {
        console.error('‚ùå ID yeniden d√ºzenleme hatasƒ±:', error);
        throw error;
    }
}

/**
 * D√ºƒü√ºm ID'sini recursively g√ºncelle
 * @param {Object} node - D√ºƒü√ºm
 * @param {string} newId - Yeni ID
 */
function updateNodeIdRecursive(node, newId) {
    // Ana d√ºƒü√ºm√ºn ID'sini g√ºncelle
    node.id = newId;
    
    // Alt d√ºƒü√ºmlerin ID'lerini g√ºncelle
    if (node.children && node.children.length > 0) {
        node.children.forEach((child, index) => {
            const newChildId = `${newId}.${index + 1}`;
            updateNodeIdRecursive(child, newChildId);
        });
    }
}

// =====================================================
// S√úR√úKLE-BIRAK FONKSƒ∞YONLARI
// =====================================================

/**
 * Ana etkinlikler ve alt bile≈üenler i√ßin s√ºr√ºkle-bƒ±rak √∂zelliƒüi ekle
 */
function enableDragAndDrop() {
    // √ñnceki event listener'larƒ± temizle
    document.querySelectorAll('.tree-node').forEach(nodeElement => {
        nodeElement.removeEventListener('dragstart', handleDragStart);
        nodeElement.removeEventListener('dragover', handleDragOver);
        nodeElement.removeEventListener('drop', handleDrop);
        nodeElement.removeEventListener('dragend', handleDragEnd);
        nodeElement.removeEventListener('dragenter', handleDragEnter);
        nodeElement.removeEventListener('dragleave', handleDragLeave);
        nodeElement.removeEventListener('dragstart', handleComponentDragStart);
        nodeElement.removeEventListener('dragend', handleComponentDragEnd);
    });
    
    // T√ºm d√ºƒü√ºmleri kontrol et
    document.querySelectorAll('.tree-node').forEach(nodeElement => {
        const nodeId = nodeElement.dataset.id;
        if (!nodeId) return;
        
        const isMainActivity = (nodeId.startsWith('A') || nodeId.startsWith('F')) && !nodeId.includes('.');
        const isSubComponent = nodeId.includes('.'); // Alt bile≈üen (A1.1, F1.2 gibi)
        
        // Ana etkinlikler i√ßin s√ºr√ºkle-bƒ±rak
        if (isMainActivity) {
            nodeElement.draggable = true;
            nodeElement.classList.add('draggable-activity');
            
            // Ana etkinlik drag event listeners
            nodeElement.addEventListener('dragstart', handleDragStart);
            nodeElement.addEventListener('dragend', handleDragEnd);
            
            // Ana etkinlikler drop hedefi olabilir
            nodeElement.addEventListener('dragover', handleDragOver);
            nodeElement.addEventListener('drop', handleDrop);
            nodeElement.addEventListener('dragenter', handleDragEnter);
            nodeElement.addEventListener('dragleave', handleDragLeave);
        }
        
        // Alt bile≈üenler i√ßin s√ºr√ºkle-bƒ±rak
        if (isSubComponent) {
            nodeElement.draggable = true;
            nodeElement.classList.add('draggable-component');
            
            // Alt bile≈üen drag event listeners
            nodeElement.addEventListener('dragstart', handleComponentDragStart);
            nodeElement.addEventListener('dragend', handleComponentDragEnd);
            
            // Alt bile≈üenler de drop hedefi olabilir (aynƒ± parent altƒ±nda)
            nodeElement.addEventListener('dragover', handleDragOver);
            nodeElement.addEventListener('drop', handleComponentDrop);
            nodeElement.addEventListener('dragenter', handleComponentDragEnter);
            nodeElement.addEventListener('dragleave', handleDragLeave);
        }
    });
}

/**
 * Drag start event handler
 */
function handleDragStart(e) {
    const nodeElement = e.currentTarget;
    const nodeId = nodeElement.dataset.id;
    
    currentDraggedId = nodeId;
    e.dataTransfer.setData('text/plain', nodeId);
    e.dataTransfer.effectAllowed = 'move';
    
    nodeElement.classList.add('dragging');
    
    console.log(`üéØ S√ºr√ºkleme ba≈üladƒ±: ${nodeId}`);
}

// Global deƒüi≈ükenler - s√ºr√ºklenen element ID'leri
let currentDraggedId = null;
let currentDraggedComponentId = null;

/**
 * Drag enter event handler
 */
function handleDragEnter(e) {
    e.preventDefault();
    const nodeElement = e.currentTarget;
    const targetId = nodeElement.dataset.id;
    
    if (canDropOn(currentDraggedId, targetId)) {
        nodeElement.classList.add('drag-over-valid');
        nodeElement.classList.remove('drag-over-invalid');
    } else {
        nodeElement.classList.add('drag-over-invalid');
        nodeElement.classList.remove('drag-over-valid');
    }
}

/**
 * Drag over event handler
 */
function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
}

/**
 * Drag leave event handler
 */
function handleDragLeave(e) {
    const nodeElement = e.currentTarget;
    // Sadece element'ten tamamen √ßƒ±kƒ±ldƒ±ƒüƒ±nda temizle
    if (!nodeElement.contains(e.relatedTarget)) {
        nodeElement.classList.remove('drag-over-valid', 'drag-over-invalid');
    }
}

/**
 * Drop event handler
 */
async function handleDrop(e) {
    e.preventDefault();
    
    const draggedId = e.dataTransfer.getData('text/plain');
    const targetElement = e.currentTarget;
    const targetId = targetElement.dataset.id;
    
    // Cleanup t√ºm drag sƒ±nƒ±flarƒ±
    document.querySelectorAll('.drag-over-valid, .drag-over-invalid, .dragging').forEach(el => {
        el.classList.remove('drag-over-valid', 'drag-over-invalid', 'dragging');
    });
    
    console.log(`üéØ Drop i≈ülemi: ${draggedId} ‚Üí ${targetId}`);
    
    if (!draggedId || !targetId || draggedId === targetId) {
        console.log('‚ùå Ge√ßersiz drop i≈ülemi');
        return;
    }
    
    if (!canDropOn(draggedId, targetId)) {
        showModernToast("Bu etkinlik burada ta≈üƒ±namaz!", "warning");
        return;
    }
    
    // Farklƒ± kategoriler arasƒ±nda ta≈üƒ±ma kontrol√º
    const draggedIsTermActivity = draggedId.startsWith('A');
    const targetIsTermActivity = targetId.startsWith('A');
    
    if (draggedIsTermActivity !== targetIsTermActivity) {
        // Kategoriler arasƒ± ta≈üƒ±ma
        await moveActivityBetweenCategories(draggedId, targetId);
    } else {
        // Aynƒ± kategori i√ßinde ta≈üƒ±ma
        await moveActivityWithinCategory(draggedId, targetId);
    }
}

/**
 * Drag end event handler
 */
function handleDragEnd(e) {
    const nodeElement = e.currentTarget;
    nodeElement.classList.remove('dragging');
    
    // T√ºm drag sƒ±nƒ±flarƒ±nƒ± temizle
    document.querySelectorAll('.drag-over-valid, .drag-over-invalid').forEach(el => {
        el.classList.remove('drag-over-valid', 'drag-over-invalid');
    });
    
    // Global deƒüi≈ükeni temizle
    currentDraggedId = null;
    
    console.log('üéØ S√ºr√ºkleme sona erdi');
}

// =====================================================
// ALT Bƒ∞LE≈ûEN S√úR√úKLE-BIRAK FONKSƒ∞YONLARI
// =====================================================

/**
 * Alt bile≈üen drag start event handler
 */
function handleComponentDragStart(e) {
    const nodeElement = e.currentTarget;
    const nodeId = nodeElement.dataset.id;
    
    currentDraggedComponentId = nodeId;
    e.dataTransfer.setData('text/plain', nodeId);
    e.dataTransfer.effectAllowed = 'move';
    
    nodeElement.classList.add('dragging');
    
    console.log(`üéØ Alt bile≈üen s√ºr√ºkleme ba≈üladƒ±: ${nodeId}`);
}

/**
 * Alt bile≈üen drag end event handler
 */
function handleComponentDragEnd(e) {
    const nodeElement = e.currentTarget;
    nodeElement.classList.remove('dragging');
    currentDraggedComponentId = null;
    
    // T√ºm drag-over sƒ±nƒ±flarƒ±nƒ± temizle
    document.querySelectorAll('.drag-over-valid, .drag-over-invalid').forEach(el => {
        el.classList.remove('drag-over-valid', 'drag-over-invalid');
    });
    
    console.log('üéØ Alt bile≈üen s√ºr√ºkleme tamamlandƒ±');
}

/**
 * Alt bile≈üen drag enter event handler
 */
function handleComponentDragEnter(e) {
    e.preventDefault();
    const nodeElement = e.currentTarget;
    const targetId = nodeElement.dataset.id;
    
    if (canDropComponentOn(currentDraggedComponentId, targetId)) {
        nodeElement.classList.add('drag-over-valid');
        nodeElement.classList.remove('drag-over-invalid');
    } else {
        nodeElement.classList.add('drag-over-invalid');
        nodeElement.classList.remove('drag-over-valid');
    }
}

/**
 * Alt bile≈üen drop event handler
 */
async function handleComponentDrop(e) {
    e.preventDefault();
    
    const draggedId = e.dataTransfer.getData('text/plain');
    const targetElement = e.currentTarget;
    const targetId = targetElement.dataset.id;
    
    // Cleanup t√ºm drag sƒ±nƒ±flarƒ±
    document.querySelectorAll('.drag-over-valid, .drag-over-invalid, .dragging').forEach(el => {
        el.classList.remove('drag-over-valid', 'drag-over-invalid', 'dragging');
    });
    
    console.log(`üéØ Alt bile≈üen drop i≈ülemi: ${draggedId} ‚Üí ${targetId}`);
    
    if (!draggedId || !targetId || draggedId === targetId) {
        console.log('‚ùå Ge√ßersiz alt bile≈üen drop i≈ülemi');
        return;
    }
    
    if (!canDropComponentOn(draggedId, targetId)) {
        showModernToast("Bu bile≈üen burada ta≈üƒ±namaz!", "warning");
        return;
    }
    
    // Parent ID'lerini kontrol et
    const draggedParent = draggedId.substring(0, draggedId.lastIndexOf('.'));
    const targetParent = targetId.substring(0, targetId.lastIndexOf('.'));
    
    try {
        if (draggedParent === targetParent) {
            // Aynƒ± parent altƒ±nda ta≈üƒ±ma
            await moveComponentWithinParent(draggedId, targetId);
        } else {
            // Farklƒ± etkinlikler arasƒ±nda ta≈üƒ±ma
            await moveComponentBetweenActivities(draggedId, targetId);
        }
    } catch (error) {
        console.error('‚ùå Alt bile≈üen ta≈üƒ±ma hatasƒ±:', error);
        showModernToast("Alt bile≈üen ta≈üƒ±nƒ±rken hata olu≈ütu!", "error");
    }
}

/**
 * Belirli bir etkinliƒüin ba≈üka bir etkinlik √ºzerine bƒ±rakƒ±lƒ±p bƒ±rakƒ±lamayacaƒüƒ±nƒ± kontrol et
 */
function canDropOn(draggedId, targetId) {
    if (!draggedId || !targetId || draggedId === targetId) {
        return false;
    }
    
    const draggedIsMainActivity = !draggedId.includes('.');
    const targetIsMainActivity = !targetId.includes('.');
    
    // Ana etkinlikler sadece ana etkinlikler √ºzerine ta≈üƒ±nabilir
    if (draggedIsMainActivity && targetIsMainActivity) {
        const draggedIsValid = draggedId.startsWith('A') || draggedId.startsWith('F');
        const targetIsValid = targetId.startsWith('A') || targetId.startsWith('F');
        return draggedIsValid && targetIsValid;
    }
    
    return false; // Ana etkinlikler i√ßin diƒüer durumlar ge√ßersiz
}

/**
 * Alt bile≈üenlerin ta≈üƒ±nƒ±p ta≈üƒ±namayacaƒüƒ±nƒ± kontrol et
 */
function canDropComponentOn(draggedId, targetId) {
    if (!draggedId || !targetId || draggedId === targetId) {
        return false;
    }
    
    // S√ºr√ºklenen alt bile≈üen, hedef alt bile≈üen olmalƒ±
    if (!draggedId.includes('.') || !targetId.includes('.')) {
        return false;
    }
    
    // Her iki bile≈üen de ge√ßerli ID formatƒ±nda olmalƒ± (A1.1, F2.3 gibi)
    const draggedIsValid = (draggedId.startsWith('A') || draggedId.startsWith('F'));
    const targetIsValid = (targetId.startsWith('A') || targetId.startsWith('F'));
    
    return draggedIsValid && targetIsValid;
}

/**
 * Etkinliƒüi kategoriler arasƒ±nda ta≈üƒ±
 */
async function moveActivityBetweenCategories(draggedId, targetId) {
    const confirmed = await showModernConfirm(
        'Kategori Deƒüi≈ütirme Onayƒ±',
        `${getComponentDisplayName(draggedId)} etkinliƒüini ${draggedId.startsWith('A') ? 'Yarƒ±yƒ±l Sonu' : 'Yarƒ±yƒ±l ƒ∞√ßi'} kategorisine ta≈üƒ±mak istediƒüinizden emin misiniz?\\n\\nBu i≈ülem etkinliƒüin kategorisini deƒüi≈ütirecek ve ID'sini yeniden d√ºzenleyecektir.`,
        {
            confirmText: 'Evet, Ta≈üƒ±',
            cancelText: 'ƒ∞ptal',
            headerClass: 'warning-action',
            iconClass: 'warning'
        }
    );
    
    if (!confirmed) return;
    
    console.log(`üîÑ Kategori deƒüi≈ütirme: ${draggedId} ‚Üí ${targetId} kategorisi`);
    
    try {
        const draggedNode = findNodeById(draggedId);
        if (!draggedNode) {
            showModernToast("Ta≈üƒ±nacak etkinlik bulunamadƒ±!", "error");
            return;
        }
        
        // Grup haritalamalarƒ±nƒ± kaydet
        const savedMappings = {};
        saveNodeGroupMappings(draggedNode, savedMappings);
        
        // Ana aƒüa√ßtan d√ºƒü√ºm√º √ßƒ±kar
        const draggedIndex = APP_STATE.assessmentTree.findIndex(n => n.id === draggedId);
        if (draggedIndex === -1) {
            showModernToast("Etkinlik ana aƒüa√ßta bulunamadƒ±!", "error");
            return;
        }
        
        APP_STATE.assessmentTree.splice(draggedIndex, 1);
        
        // Etkinliƒüin hedef kategorisini belirle ve ge√ßici ID ata
        const draggedIsTermActivity = draggedId.startsWith('A');
        const targetIsTermActivity = targetId.startsWith('A');
        
        // Eƒüer kategori deƒüi≈üiyorsa, etkinliƒüin prefix'ini deƒüi≈ütir
        if (draggedIsTermActivity !== targetIsTermActivity) {
            const newPrefix = targetIsTermActivity ? 'A' : 'F';
            const tempId = `${newPrefix}_TEMP_${Date.now()}`;
            draggedNode.id = tempId;
            
            // Alt bile≈üenlerin ID'lerini de ge√ßici olarak deƒüi≈ütir
            if (draggedNode.children && draggedNode.children.length > 0) {
                draggedNode.children.forEach((child, index) => {
                    child.id = `${tempId}.${index + 1}`;
                });
            }
        }
        
        // Hedef kategoriye doƒüru pozisyonda ekle
        const targetIndex = APP_STATE.assessmentTree.findIndex(n => n.id === targetId);
        if (targetIndex !== -1) {
            // Hedef etkinliƒüin yerine ekle
            APP_STATE.assessmentTree.splice(targetIndex, 0, draggedNode);
        } else {
            // Hedef bulunamadƒ±ysa hedef kategorinin sonuna ekle
            const targetCategoryNodes = APP_STATE.assessmentTree.filter(n => 
                targetIsTermActivity ? n.id.startsWith('A') : n.id.startsWith('F')
            );
            
            if (targetCategoryNodes.length > 0) {
                // Son etkinliƒüin arkasƒ±na ekle
                const lastNodeIndex = APP_STATE.assessmentTree.findIndex(n => n.id === targetCategoryNodes[targetCategoryNodes.length - 1].id);
                APP_STATE.assessmentTree.splice(lastNodeIndex + 1, 0, draggedNode);
            } else {
                // Kategori bo≈üsa sona ekle
                APP_STATE.assessmentTree.push(draggedNode);
            }
        }
        
        // T√ºm sistemdeki ID'leri yeniden d√ºzenle
        const oldToNewIdMap = await reorganizeAllIds();
        
        // Grup haritalamalarƒ±nƒ± geri y√ºkle
        restoreGroupMappings(savedMappings, oldToNewIdMap);
        
        renderTree();
        
        // Deƒüerlendirme sekmesini g√ºncelle - CRITICAL SYNC
        updateAssessmentView();
        
        showModernToast(`${getComponentDisplayName(draggedId)} etkinliƒüi kategori deƒüi≈ütirdi!`, "success");
        
    } catch (error) {
        console.error('‚ùå Kategori deƒüi≈ütirme hatasƒ±:', error);
        showModernToast("Etkinlik ta≈üƒ±nƒ±rken hata olu≈ütu!", "error");
    }
}

/**
 * Etkinliƒüi aynƒ± kategori i√ßinde ta≈üƒ±
 */
async function moveActivityWithinCategory(draggedId, targetId) {
    console.log(`üîÑ Aynƒ± kategori i√ßinde ta≈üƒ±ma: ${draggedId} ‚Üí ${targetId}`);
    
    // Onay al
    const confirmed = await showModernConfirm(
        'Etkinlik Ta≈üƒ±ma Onayƒ±',
        `${getComponentDisplayName(draggedId)} etkinliƒüini ${getComponentDisplayName(targetId)} etkinliƒüinin yerine ta≈üƒ±mak istediƒüinizden emin misiniz?\\n\\nBu i≈ülem etkinliklerin sƒ±rasƒ±nƒ± deƒüi≈ütirecek ve ID'lerini yeniden d√ºzenleyecektir.`,
        {
            confirmText: 'Evet, Ta≈üƒ±',
            cancelText: 'ƒ∞ptal',
            headerClass: 'info-action',
            iconClass: 'info'
        }
    );
    
    if (!confirmed) return;
    
    try {
        const draggedIndex = APP_STATE.assessmentTree.findIndex(n => n.id === draggedId);
        const targetIndex = APP_STATE.assessmentTree.findIndex(n => n.id === targetId);
        
        if (draggedIndex === -1 || targetIndex === -1) {
            showModernToast("Ta≈üƒ±ma i≈ülemi i√ßin gerekli etkinlikler bulunamadƒ±!", "error");
            return;
        }
        
        // Grup haritalamalarƒ±nƒ± kaydet
        const draggedNode = APP_STATE.assessmentTree[draggedIndex];
        const savedMappings = {};
        saveNodeGroupMappings(draggedNode, savedMappings);
        
        // Ana aƒüa√ßta sƒ±ralarƒ± deƒüi≈ütir
        APP_STATE.assessmentTree.splice(draggedIndex, 1);
        APP_STATE.assessmentTree.splice(targetIndex, 0, draggedNode);
        
        // T√ºm sistemdeki ID'leri yeniden d√ºzenle
        const oldToNewIdMap = await reorganizeAllIds();
        
        // Grup haritalamalarƒ±nƒ± geri y√ºkle
        restoreGroupMappings(savedMappings, oldToNewIdMap);
        
        renderTree();
        
        // Deƒüerlendirme sekmesini g√ºncelle - CRITICAL SYNC
        updateAssessmentView();
        
        showModernToast(`${getComponentDisplayName(draggedId)} etkinliƒüi ta≈üƒ±ndƒ±!`, "success");
        
    } catch (error) {
        console.error('‚ùå Aynƒ± kategori ta≈üƒ±ma hatasƒ±:', error);
        showModernToast("Etkinlik ta≈üƒ±nƒ±rken hata olu≈ütu!", "error");
    }
}

/**
 * Alt bile≈üeni farklƒ± etkinlikler arasƒ±nda ta≈üƒ±
 */
async function moveComponentBetweenActivities(draggedId, targetId) {
    console.log(`üîÑ Alt bile≈üen farklƒ± etkinlikler arasƒ± ta≈üƒ±ma: ${draggedId} ‚Üí ${targetId}`);
    
    // Parent ID'lerini al
    const draggedParent = draggedId.substring(0, draggedId.lastIndexOf('.'));
    const targetParent = targetId.substring(0, targetId.lastIndexOf('.'));
    
    // Onay al
    const confirmed = await showModernConfirm(
        'Alt Bile≈üen Ta≈üƒ±ma Onayƒ±',
        `${getComponentDisplayName(draggedId)} alt bile≈üenini ${getComponentDisplayName(targetParent)} etkinliƒüine ta≈üƒ±mak istediƒüinizden emin misiniz?\\n\\nBu i≈ülem alt bile≈üeni farklƒ± bir etkinliƒüe ta≈üƒ±yacak ve ID'sini yeniden d√ºzenleyecektir.`,
        {
            confirmText: 'Evet, Ta≈üƒ±',
            cancelText: 'ƒ∞ptal',
            headerClass: 'info-action',
            iconClass: 'info'
        }
    );
    
    if (!confirmed) return;
    
    try {
        // Kaynak parent node'u bul
        const sourceParentNode = findNodeById(draggedParent);
        if (!sourceParentNode || !sourceParentNode.children) {
            showModernToast("Kaynak etkinlik bulunamadƒ±!", "error");
            return;
        }
        
        // Hedef parent node'u bul
        const targetParentNode = findNodeById(targetParent);
        if (!targetParentNode) {
            showModernToast("Hedef etkinlik bulunamadƒ±!", "error");
            return;
        }
        
        // Ta≈üƒ±nacak bile≈üeni bul
        const draggedIndex = sourceParentNode.children.findIndex(child => child.id === draggedId);
        if (draggedIndex === -1) {
            showModernToast("Ta≈üƒ±nacak alt bile≈üen bulunamadƒ±!", "error");
            return;
        }
        
        const draggedComponent = sourceParentNode.children[draggedIndex];
        
        // Grup haritalamalarƒ±nƒ± kaydet
        const savedMappings = {};
        saveNodeGroupMappings(draggedComponent, savedMappings);
        
        // Bile≈üeni kaynak parent'tan √ßƒ±kar
        sourceParentNode.children.splice(draggedIndex, 1);
        
        // Hedef parent'ta children array'i yoksa olu≈ütur
        if (!targetParentNode.children) {
            targetParentNode.children = [];
        }
        
        // Hedef pozisyonu belirle
        const targetIndex = targetParentNode.children.findIndex(child => child.id === targetId);
        if (targetIndex !== -1) {
            // Hedef bile≈üenin yerine ekle
            targetParentNode.children.splice(targetIndex, 0, draggedComponent);
        } else {
            // Hedef bile≈üen bulunamadƒ±ysa sona ekle
            targetParentNode.children.push(draggedComponent);
        }
        
        // T√ºm sistemdeki ID'leri yeniden d√ºzenle
        const oldToNewIdMap = await reorganizeAllIds();
        
        // Grup haritalamalarƒ±nƒ± geri y√ºkle
        restoreGroupMappings(savedMappings, oldToNewIdMap);
        
        renderTree();
        
        // Deƒüerlendirme sekmesini g√ºncelle - CRITICAL SYNC
        updateAssessmentView();
        
        showModernToast(`${getComponentDisplayName(draggedId)} alt bile≈üeni ${getComponentDisplayName(targetParent)} etkinliƒüine ta≈üƒ±ndƒ±!`, "success");
        
    } catch (error) {
        console.error('‚ùå Alt bile≈üen ta≈üƒ±ma hatasƒ±:', error);
        showModernToast("Alt bile≈üen ta≈üƒ±nƒ±rken hata olu≈ütu!", "error");
    }
}

/**
 * Alt bile≈üeni aynƒ± parent i√ßinde ta≈üƒ±
 */
async function moveComponentWithinParent(draggedId, targetId) {
    console.log(`üîÑ Alt bile≈üen aynƒ± parent i√ßinde ta≈üƒ±ma: ${draggedId} ‚Üí ${targetId}`);
    
    // Parent ID'lerini al
    const draggedParent = draggedId.substring(0, draggedId.lastIndexOf('.'));
    const targetParent = targetId.substring(0, targetId.lastIndexOf('.'));
    
    // Onay al
    const confirmed = await showModernConfirm(
        'Alt Bile≈üen Sƒ±ralama Onayƒ±',
        `${getComponentDisplayName(draggedId)} alt bile≈üenini ${getComponentDisplayName(targetId)} alt bile≈üeninin yerine ta≈üƒ±mak istediƒüinizden emin misiniz?\\n\\nBu i≈ülem alt bile≈üenlerin sƒ±rasƒ±nƒ± deƒüi≈ütirecek ve ID'lerini yeniden d√ºzenleyecektir.`,
        {
            confirmText: 'Evet, Ta≈üƒ±',
            cancelText: 'ƒ∞ptal',
            headerClass: 'info-action',
            iconClass: 'info'
        }
    );
    
    if (!confirmed) return;
    
    try {
        // Parent node'u bul
        const parentNode = findNodeById(draggedParent);
        if (!parentNode || !parentNode.children) {
            showModernToast("Parent etkinlik bulunamadƒ±!", "error");
            return;
        }
        
        // Ta≈üƒ±nacak ve hedef bile≈üenleri bul
        const draggedIndex = parentNode.children.findIndex(child => child.id === draggedId);
        const targetIndex = parentNode.children.findIndex(child => child.id === targetId);
        
        if (draggedIndex === -1 || targetIndex === -1) {
            showModernToast("Alt bile≈üenler bulunamadƒ±!", "error");
            return;
        }
        
        // Grup haritalamalarƒ±nƒ± kaydet
        const savedMappings = {};
        parentNode.children.forEach(child => {
            saveNodeGroupMappings(child, savedMappings);
        });
        
        // Alt bile≈üenleri yeniden sƒ±rala
        const draggedChild = parentNode.children[draggedIndex];
        parentNode.children.splice(draggedIndex, 1);
        parentNode.children.splice(targetIndex, 0, draggedChild);
        
        // ID mapping'i olu≈ütur (ID g√ºncelleme √∂ncesi)
        const oldToNewIdMap = {};
        parentNode.children.forEach((child, index) => {
            const oldId = child.id;
            const newId = `${draggedParent}.${index + 1}`;
            oldToNewIdMap[oldId] = newId;
        });
        
        // Alt bile≈üenlerin ID'lerini parent i√ßinde yeniden d√ºzenle
        parentNode.children.forEach((child, index) => {
            const newChildId = `${draggedParent}.${index + 1}`;
            updateNodeIdRecursive(child, newChildId);
        });
        
        // Grup haritalamalarƒ±nƒ± ID mapping'e g√∂re g√ºncelle
        if (APP_STATE.courseData.grupHaritalari[draggedParent]) {
            const parentMapping = APP_STATE.courseData.grupHaritalari[draggedParent];
            if (parentMapping.haritalar) {
                Object.keys(parentMapping.haritalar).forEach(groupName => {
                    const groupMapping = parentMapping.haritalar[groupName];
                    const updatedGroupMapping = {};
                    
                    // Her pozisyon i√ßin doƒüru ID mapping'i kullan
                    Object.keys(groupMapping).forEach(position => {
                        const oldQuestionId = groupMapping[position];
                        
                        // Eƒüer bu bir parent'a ait soru ID'si ise mapping'i kullan
                        if (oldToNewIdMap[oldQuestionId]) {
                            const newQuestionId = oldToNewIdMap[oldQuestionId];
                            updatedGroupMapping[position] = newQuestionId;
                            console.log(`üìù Grup haritalama g√ºncellendi: ${oldQuestionId} ‚Üí ${newQuestionId}`);
                        } else {
                            // Mapping'de yoksa eski deƒüeri koru
                            updatedGroupMapping[position] = oldQuestionId;
                        }
                    });
                    
                    parentMapping.haritalar[groupName] = updatedGroupMapping;
                });
            }
        }
        
        // Aƒüacƒ± yeniden render et
        renderTree();
        
        // Deƒüerlendirme sekmesini g√ºncelle - CRITICAL SYNC
        updateAssessmentView();
        
        console.log(`‚úÖ Alt bile≈üen ta≈üƒ±ma tamamlandƒ±: ${draggedId} ‚Üí yeni pozisyon`);
        showModernToast("Alt bile≈üen ba≈üarƒ±yla ta≈üƒ±ndƒ±!", "success");
        
    } catch (error) {
        console.error('‚ùå Alt bile≈üen ta≈üƒ±ma hatasƒ±:', error);
        showModernToast("Alt bile≈üen ta≈üƒ±nƒ±rken hata olu≈ütu!", "error");
    }
}

/**
 * Etkinlik Adƒ± D√ºzenleme Fonksiyonlarƒ±
 */

/**
 * Etkinlik adƒ± d√ºzenleme modalƒ±nƒ± a√ß
 */
function openActivityNamingModal() {
    const modal = document.getElementById('activityNamingModal');
    if (modal) {
        modal.classList.add('active');
    }
}

/**
 * Etkinlik adƒ± d√ºzenleme modalƒ±nƒ± kapat
 */
function closeActivityNamingModal() {
    const modal = document.getElementById('activityNamingModal');
    if (modal) {
        modal.classList.remove('active');
    }
}

/**
 * Etkinlik adlarƒ±na Vize/Final etiketlerini ekle
 */
async function applyActivityNaming() {
    const target = document.getElementById('namingTarget').value;
    const position = document.getElementById('namingPosition').value;
    const separator = document.getElementById('namingSeparator').value;
    
    console.log('üè∑Ô∏è Etkinlik adƒ± etiketleme ba≈ülƒ±yor:', { target, position, separator });
    
    try {
        let modifiedCount = 0;
        
        // Hedef t√ºr√ºne g√∂re farklƒ± i≈ülemler
        const shouldProcessActivities = target === 'activities' || target === 'both';
        const shouldProcessComponents = target === 'components' || target === 'both';
        
        // Ana etkinlikleri i≈üle
        if (shouldProcessActivities) {
            APP_STATE.assessmentTree.forEach(node => {
                if (!node.id.includes('.')) { // Ana etkinlik kontrol√º
                    const isTermActivity = node.id.startsWith('A');
                    const isFinalActivity = node.id.startsWith('F');
                    
                    if (isTermActivity || isFinalActivity) {
                        const label = isTermActivity ? 'Vize' : 'Final';
                        const currentName = node.name || '';
                        
                        // Etiket zaten var mƒ± kontrol et
                        const hasLabel = currentName.includes(label);
                        
                        if (!hasLabel) {
                            let newName;
                            if (position === 'prefix') {
                                newName = label + separator + currentName;
                            } else {
                                newName = currentName + separator + label;
                            }
                            
                            node.name = newName;
                            modifiedCount++;
                            
                            console.log(`‚úÖ Ana Etkinlik ${node.id}: "${currentName}" ‚Üí "${newName}"`);
                        }
                    }
                }
            });
        }
        
        // Alt bile≈üenleri i≈üle
        if (shouldProcessComponents) {
            function processNodeChildren(node) {
                if (node.children && node.children.length > 0) {
                    node.children.forEach(child => {
                        if (child.id.includes('.')) { // Alt bile≈üen kontrol√º
                            // Ana etkinliƒüin kategorisini belirle
                            const parentId = child.id.split('.')[0];
                            const isTermComponent = parentId.startsWith('A');
                            const isFinalComponent = parentId.startsWith('F');
                            
                            if (isTermComponent || isFinalComponent) {
                                const label = isTermComponent ? 'Vize' : 'Final';
                                const currentName = child.name || '';
                                
                                // Etiket zaten var mƒ± kontrol et
                                const hasLabel = currentName.includes(label);
                                
                                if (!hasLabel) {
                                    let newName;
                                    if (position === 'prefix') {
                                        newName = label + separator + currentName;
                                    } else {
                                        newName = currentName + separator + label;
                                    }
                                    
                                    child.name = newName;
                                    modifiedCount++;
                                    
                                    console.log(`‚úÖ Alt Bile≈üen ${child.id}: "${currentName}" ‚Üí "${newName}"`);
                                }
                            }
                        }
                        
                        // Recursive olarak alt bile≈üenleri de i≈üle
                        processNodeChildren(child);
                    });
                }
            }
            
            APP_STATE.assessmentTree.forEach(node => {
                processNodeChildren(node);
            });
        }
        
        if (modifiedCount > 0) {
            renderTree();

                    // Deƒüerlendirme sekmesini g√ºncelle - CRITICAL SYNC
        updateAssessmentView();
            const targetText = target === 'activities' ? 'etkinlik' : 
                             target === 'components' ? 'alt bile≈üen' : 
                             'etkinlik ve alt bile≈üen';
            showModernToast(`${modifiedCount} ${targetText} adƒ±na etiket eklendi!`, "success");
            closeActivityNamingModal();
        } else {
            showModernToast("Hi√ßbir ad deƒüi≈ütirilmedi. Etiketler zaten mevcut olabilir.", "warning");
        }
        

        
    } catch (error) {
        console.error('‚ùå Etkinlik adƒ± etiketleme hatasƒ±:', error);
        showModernToast("Adlar d√ºzenlenirken hata olu≈ütu!", "error");
    }
}

/**
 * Etiket temizleme modalƒ±nƒ± a√ß
 */
function openActivityCleanupModal() {
    const modal = document.getElementById('activityCleanupModal');
    if (modal) {
        modal.classList.add('active');
    }
}

/**
 * Etiket temizleme modalƒ±nƒ± kapat
 */
function closeActivityCleanupModal() {
    const modal = document.getElementById('activityCleanupModal');
    if (modal) {
        modal.classList.remove('active');
    }
}

/**
 * Etkinlik adlarƒ±ndan Vize/Final etiketlerini temizle
 */
async function removeActivitySuffixes() {
    const target = document.getElementById('cleanupTarget').value;
    
    const targetText = target === 'activities' ? 'ana etkinlik' : 
                      target === 'components' ? 'alt bile≈üen' : 
                      'etkinlik ve alt bile≈üen';
    
    const confirmed = await showModernConfirm(
        'Etiket Temizleme Onayƒ±',
        `T√ºm ${targetText} adlarƒ±ndan "Vize" ve "Final" etiketlerini kaldƒ±rmak istediƒüinizden emin misiniz?\\n\\nBu i≈ülem geri alƒ±namaz.`,
        {
            confirmText: 'Evet, Temizle',
            cancelText: 'ƒ∞ptal',
            headerClass: 'warning-action',
            iconClass: 'warning'
        }
    );
    
    if (!confirmed) return;
    
    console.log('üßπ Etiket temizleme ba≈ülƒ±yor...', { target });
    
    try {
        let modifiedCount = 0;
        
        // Hedef t√ºr√ºne g√∂re farklƒ± i≈ülemler
        const shouldProcessActivities = target === 'activities' || target === 'both';
        const shouldProcessComponents = target === 'components' || target === 'both';
        
        // Temizleme desenleri
        const patterns = [
            /\s*-\s*Vize\s*$/gi,
            /\s*\|\s*Vize\s*$/gi,
            /\s*\/\s*Vize\s*$/gi,
            /\s*Vize\s*$/gi,
            /^Vize\s*-\s*/gi,
            /^Vize\s*\|\s*/gi,
            /^Vize\s*\/\s*/gi,
            /^Vize\s*/gi,
            /\s*-\s*Final\s*$/gi,
            /\s*\|\s*Final\s*$/gi,
            /\s*\/\s*Final\s*$/gi,
            /\s*Final\s*$/gi,
            /^Final\s*-\s*/gi,
            /^Final\s*\|\s*/gi,
            /^Final\s*\/\s*/gi,
            /^Final\s*/gi
        ];
        
        // Ana etkinlikleri temizle
        if (shouldProcessActivities) {
            APP_STATE.assessmentTree.forEach(node => {
                if (!node.id.includes('.')) { // Ana etkinlik kontrol√º
                    const isTermActivity = node.id.startsWith('A');
                    const isFinalActivity = node.id.startsWith('F');
                    
                    if (isTermActivity || isFinalActivity) {
                        const currentName = node.name || '';
                        let newName = currentName;
                        
                        patterns.forEach(pattern => {
                            newName = newName.replace(pattern, '');
                        });
                        
                        // Bo≈ü string kontrol√º
                        newName = newName.trim();
                        if (!newName) {
                            newName = isTermActivity ? 'Yarƒ±yƒ±l ƒ∞√ßi Etkinlik' : 'Yarƒ±yƒ±l Sonu Etkinlik';
                        }
                        
                        if (newName !== currentName) {
                            node.name = newName;
                            modifiedCount++;
                            
                            console.log(`‚úÖ Ana Etkinlik ${node.id}: "${currentName}" ‚Üí "${newName}"`);
                        }
                    }
                }
            });
        }
        
        // Alt bile≈üenleri temizle
        if (shouldProcessComponents) {
            function cleanNodeChildren(node) {
                if (node.children && node.children.length > 0) {
                    node.children.forEach(child => {
                        if (child.id.includes('.')) { // Alt bile≈üen kontrol√º
                            const parentId = child.id.split('.')[0];
                            const isTermComponent = parentId.startsWith('A');
                            const isFinalComponent = parentId.startsWith('F');
                            
                            if (isTermComponent || isFinalComponent) {
                                const currentName = child.name || '';
                                let newName = currentName;
                                
                                patterns.forEach(pattern => {
                                    newName = newName.replace(pattern, '');
                                });
                                
                                // Bo≈ü string kontrol√º
                                newName = newName.trim();
                                if (!newName) {
                                    newName = child.type === 'question' ? 'Soru' : 
                                             child.type === 'rubric' ? 'Rubrik' : 'Alt Bile≈üen';
                                }
                                
                                if (newName !== currentName) {
                                    child.name = newName;
                                    modifiedCount++;
                                    
                                    console.log(`‚úÖ Alt Bile≈üen ${child.id}: "${currentName}" ‚Üí "${newName}"`);
                                }
                            }
                        }
                        
                        // Recursive olarak alt bile≈üenleri de i≈üle
                        cleanNodeChildren(child);
                    });
                }
            }
            
            APP_STATE.assessmentTree.forEach(node => {
                cleanNodeChildren(node);
            });
        }
        
        if (modifiedCount > 0) {
            renderTree();

                    // Deƒüerlendirme sekmesini g√ºncelle - CRITICAL SYNC
        updateAssessmentView();
            showModernToast(`${modifiedCount} ${targetText} adƒ±ndan etiketler temizlendi!`, "success");
            closeActivityCleanupModal();
        } else {
            showModernToast("Hi√ßbir ad deƒüi≈ütirilmedi. Etiket bulunamadƒ±.", "info");
            closeActivityCleanupModal();
        }
        
    } catch (error) {
        console.error('‚ùå Etiket temizleme hatasƒ±:', error);
        showModernToast("Adlar temizlenirken hata olu≈ütu!", "error");
    }
}

// Event listener'larƒ± ekle
document.addEventListener('DOMContentLoaded', function() {
    // Vize/Final etiketleri ekle butonu
    const btnAddSuffixes = document.getElementById('btnAddActivitySuffixes');
    if (btnAddSuffixes) {
        btnAddSuffixes.addEventListener('click', openActivityNamingModal);
    }
    
    // Vize/Final etiketlerini temizle butonu
    const btnRemoveSuffixes = document.getElementById('btnRemoveActivitySuffixes');
    if (btnRemoveSuffixes) {
        btnRemoveSuffixes.addEventListener('click', openActivityCleanupModal);
    }
    
    // Student Reassignment Modal close event'leri
    const studentReassignmentModal = document.getElementById('studentReassignmentModal');
    if (studentReassignmentModal) {
        // Close butonlarƒ±
        studentReassignmentModal.querySelectorAll('.modern-close').forEach(btn => {
            btn.addEventListener('click', function() {
                closeModernModal('studentReassignmentModal');
            });
        });
        
        // Modal dƒ±≈üƒ±na tƒ±klayƒ±nca kapat
        studentReassignmentModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeModernModal('studentReassignmentModal');
            }
        });
    }
    
    // Tablo g√∂r√ºn√ºm kontrol butonlarƒ±
    setupTableViewControls();
});

// Tablo g√∂r√ºn√ºm kontrol butonlarƒ±nƒ± ayarla
function setupTableViewControls() {
    console.log('üîß Tablo g√∂r√ºn√ºm kontrolleri ayarlanƒ±yor...');
    
    // √ñnce mevcut event listener'larƒ± temizle
    document.querySelectorAll('.column-toggle').forEach(button => {
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);
    });
    
    document.querySelectorAll('.mask-toggle').forEach(button => {
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);
    });
    
    // Mevcut sistemle uyumlu toggle butonlarƒ±
    const toggleButtons = [
        { selector: '[data-column="col-no"]', columnKey: 'no' },
        { selector: '[data-column="col-studentId"]', columnKey: 'studentId' },
        { selector: '[data-column="col-name"]', columnKey: 'name' },
        { selector: '[data-column="col-surname"]', columnKey: 'surname' },
        { selector: '[data-column="col-email"]', columnKey: 'email' },
        { selector: '[data-column="col-phone"]', columnKey: 'phone' },
        { selector: '[data-column="col-tckn"]', columnKey: 'tckn' },
        { selector: '[data-column="col-status"]', columnKey: 'status' },
        { selector: '[data-column="col-groups"]', columnKey: 'groups' },
        { selector: '[data-column="col-actions"]', columnKey: 'actions' }
    ];
    
    toggleButtons.forEach(({ selector, columnKey }) => {
        const button = document.querySelector(selector);
        if (button) {
            // Ba≈ülangƒ±√ß durumunu ayarla
            const isVisible = STUDENT_VIEW_SETTINGS.visibleColumns[columnKey];
            updateToggleButtonState(button, isVisible);
            
            // Event listener ekle
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Durumu deƒüi≈ütir
                STUDENT_VIEW_SETTINGS.visibleColumns[columnKey] = !STUDENT_VIEW_SETTINGS.visibleColumns[columnKey];
                const newState = STUDENT_VIEW_SETTINGS.visibleColumns[columnKey];
                
                // Buton g√∂r√ºn√ºm√ºn√º g√ºncelle
                updateToggleButtonState(button, newState);
                
                // Tabloyu g√ºncelle
                updateColumnVisibility();
                
                console.log(`üîÑ ${columnKey} kolonu: ${newState ? 'g√∂steriliyor' : 'gizleniyor'}`);
            });
            
            console.log(`‚úÖ ${selector} butonu baƒülandƒ±`);
        } else {
            console.warn(`‚ö†Ô∏è ${selector} butonu bulunamadƒ±`);
        }
    });
    
    // Maskeleme butonlarƒ±
    const maskButtons = [
        { selector: '[data-field="phone"]', setting: 'maskPhone' },
        { selector: '[data-field="tckn"]', setting: 'maskTCKN' }
    ];
    
    maskButtons.forEach(({ selector, setting }) => {
        const button = document.querySelector(selector);
        if (button) {
            // Ba≈ülangƒ±√ß durumunu ayarla
            const isMasked = STUDENT_VIEW_SETTINGS[setting];
            updateMaskButtonState(button, isMasked);
            
            // Event listener ekle
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Durumu deƒüi≈ütir
                STUDENT_VIEW_SETTINGS[setting] = !STUDENT_VIEW_SETTINGS[setting];
                const newState = STUDENT_VIEW_SETTINGS[setting];
                
                // Buton g√∂r√ºn√ºm√ºn√º g√ºncelle
                updateMaskButtonState(button, newState);
                
                // Tabloyu g√ºncelle
                updateStudentTableEnhanced();
                
                console.log(`üîÑ ${setting}: ${newState}`);
            });
            
            console.log(`‚úÖ ${selector} maskeleme butonu baƒülandƒ±`);
        } else {
            console.warn(`‚ö†Ô∏è ${selector} maskeleme butonu bulunamadƒ±`);
        }
    });
    
    console.log('‚úÖ Tablo g√∂r√ºn√ºm kontrolleri ba≈üarƒ±yla ayarlandƒ±');
}

// Toggle buton durumunu g√ºncelle
function updateToggleButtonState(button, isActive) {
    if (isActive) {
        button.classList.add('active');
        button.classList.remove('inactive');
        button.style.backgroundColor = '#28a745';
        button.style.color = 'white';
    } else {
        button.classList.remove('active');
        button.classList.add('inactive');
        button.style.backgroundColor = '#6c757d';
        button.style.color = 'white';
    }
}

// Maskeleme buton durumunu g√ºncelle
function updateMaskButtonState(button, isMasked) {
    const eyeIcon = button.querySelector('i');
    if (isMasked) {
        button.classList.add('masked');
        button.classList.remove('unmasked');
        button.style.backgroundColor = '#6c757d';
        button.title = 'Gizli - G√∂stermek i√ßin tƒ±klayƒ±n';
        if (eyeIcon) {
            eyeIcon.className = 'fas fa-eye-slash';
        }
    } else {
        button.classList.remove('masked');
        button.classList.add('unmasked');
        button.style.backgroundColor = '#17a2b8';
        button.title = 'G√∂r√ºn√ºr - Gizlemek i√ßin tƒ±klayƒ±n';
        if (eyeIcon) {
            eyeIcon.className = 'fas fa-eye';
        }
    }
}




function updateGroupMappingsWithNewIds(componentId, idMapping) {
    try {
        if (!APP_STATE.courseData?.grupHaritalari || !APP_STATE.courseData.grupHaritalari[componentId]) {
            console.log(`‚ö†Ô∏è Grup haritalama verisi bulunamadƒ±: ${componentId}`);
            return;
        }
        
        console.log(`üó∫Ô∏è Grup haritalamalarƒ±ndaki IDler g√ºncelleniyor: ${componentId}`);
        console.log(`üìã ID Mapping:`, idMapping);
        
        const component = APP_STATE.courseData.grupHaritalari[componentId];
        if (!component.haritalar) {
            console.log(`‚ö†Ô∏è Component mappings bulunamadƒ±: ${componentId}`);
            return;
        }
        
        let updateCount = 0;
        
        Object.keys(component.haritalar).forEach(groupName => {
            const groupMapping = component.haritalar[groupName];
            console.log(`üîç ${groupName} grubu kontrol ediliyor...`, groupMapping);
            
            Object.keys(groupMapping).forEach(position => {
                const currentQuestionId = groupMapping[position];
                
                if (idMapping[currentQuestionId]) {
                    const newQuestionId = idMapping[currentQuestionId];
                    groupMapping[position] = newQuestionId;
                    updateCount++;
                    console.log(`  üìù Grup ${groupName}, Pozisyon ${position}: ${currentQuestionId} -> ${newQuestionId}`);
                }
            });
            
            console.log(`‚úÖ ${groupName} grubu g√ºncellendi:`, groupMapping);
        });
        
        if (updateCount > 0) {
            console.log(`‚úÖ ${updateCount} grup haritalama IDsi g√ºncellendi`);
            
            try {
                updateGroupMappingColors();
                updateAllInlineGroupInputs();
                updateAllMappingDisplays();
                console.log(`üé® UI g√ºncellemeleri tamamlandƒ±`);
            } catch (uiError) {
                console.error("UI g√ºncelleme hatasƒ±:", uiError);
            }
        } else {
            console.log(`‚ÑπÔ∏è ${componentId} i√ßin g√ºncelleme gerekmeyen grup haritalama`);
        }
        
    } catch (error) {
        console.error("Grup haritalama ID g√ºncelleme hatasƒ±:", error);
        console.error("componentId:", componentId);
        console.error("idMapping:", idMapping);
    }
}

// DEBUG: Test fonksiyonu
function testGroupMappingUpdate() {
    console.log('üß™ Grup haritalama g√ºncellemesi test ediliyor...');
    const testMapping = { 'A1.3': 'A1.2', 'A1.4': 'A1.3' };
    updateGroupMappingsWithNewIds('A1', testMapping);
}

// DEBUG: √ñƒürenci yeniden atama test fonksiyonu
function testStudentReassignment() {
    console.log('üß™ √ñƒürenci yeniden atama sistemi test ediliyor...');
    
    // Test √∂ƒürencileri olu≈ütur
    const testStudents = [
        { ogrenciNo: '12345', ad: 'Test', soyad: '√ñƒürenci1', grup: 'B' },
        { ogrenciNo: '12346', ad: 'Test', soyad: '√ñƒürenci2', grup: 'B' }
    ];
    
    // Modal'ƒ± a√ß
    showStudentReassignmentModal('B', testStudents, 'A1', function() {
        console.log('‚úÖ Test tamamlandƒ±');
    });
}

window.testGroupMappingUpdate = testGroupMappingUpdate;
window.testStudentReassignment = testStudentReassignment;

// =====================================================
// GRUP ARAMA VE Fƒ∞LTRELEME Sƒ∞STEMƒ∞
// =====================================================

/**
 * Grup g√∂r√ºn√ºm ayarlarƒ±
 */
const GROUP_VIEW_SETTINGS = {
    currentSearch: '',
    currentActivityFilter: '',
    currentStatusFilter: '',
    currentGroupFilter: '',
    currentDirectSelect: ''
};

/**
 * Grup filtreleme sistemini ba≈ülat
 */
function initializeGroupFiltering() {
    console.log('üîß Grup filtreleme sistemi ba≈ülatƒ±lƒ±yor...');
    
    // Arama inputu
    const searchInput = document.getElementById('groupSearchInput');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            GROUP_VIEW_SETTINGS.currentSearch = e.target.value;
            // Doƒürudan se√ßimi temizle
            const directSelect = document.getElementById('groupDirectSelect');
            if (directSelect && e.target.value) {
                directSelect.value = '';
                GROUP_VIEW_SETTINGS.currentDirectSelect = '';
            }
            updateStudentGroupInfoWithFilters();
            updateGroupFilterInfo();
        });
        console.log('‚úÖ Grup arama input event listener eklendi');
    }
    
    // Doƒürudan se√ßim
    const directSelect = document.getElementById('groupDirectSelect');
    if (directSelect) {
        directSelect.addEventListener('change', function(e) {
            if (e.target.value) {
                // Arama kutusunu temizle
                const searchInput = document.getElementById('groupSearchInput');
                if (searchInput) {
                    searchInput.value = '';
                    GROUP_VIEW_SETTINGS.currentSearch = '';
                }
                // Filtreyi uygula
                GROUP_VIEW_SETTINGS.currentDirectSelect = e.target.value;
            } else {
                GROUP_VIEW_SETTINGS.currentDirectSelect = '';
            }
            updateStudentGroupInfoWithFilters();
            updateGroupFilterInfo();
        });
        console.log('‚úÖ Grup doƒürudan se√ßim event listener eklendi');
    }
    
    // Etkinlik filtresi
    const activityFilter = document.getElementById('groupActivityFilter');
    if (activityFilter) {
        activityFilter.addEventListener('change', function(e) {
            GROUP_VIEW_SETTINGS.currentActivityFilter = e.target.value;
            updateStudentGroupInfoWithFilters();
            updateGroupFilterInfo();
        });
        console.log('‚úÖ Grup etkinlik filter event listener eklendi');
    }
    
    // Durum filtresi
    const statusFilter = document.getElementById('groupStatusFilter');
    if (statusFilter) {
        statusFilter.addEventListener('change', function(e) {
            GROUP_VIEW_SETTINGS.currentStatusFilter = e.target.value;
            updateStudentGroupInfoWithFilters();
            updateGroupFilterInfo();
        });
        console.log('‚úÖ Grup durum filter event listener eklendi');
    }
    
    // Grup filtresi
    const groupFilter = document.getElementById('groupGroupFilter');
    if (groupFilter) {
        groupFilter.addEventListener('change', function(e) {
            GROUP_VIEW_SETTINGS.currentGroupFilter = e.target.value;
            updateStudentGroupInfoWithFilters();
            updateGroupFilterInfo();
        });
        console.log('‚úÖ Grup grup filter event listener eklendi');
    }
    
    // Filtreleri temizle butonu
    const clearButton = document.getElementById('clearGroupFilters');
    if (clearButton) {
        clearButton.addEventListener('click', function() {
            clearGroupFilters();
        });
        console.log('‚úÖ Grup filtre temizleme butonu event listener eklendi');
    }
    
    // Filtreleri doldur
    populateGroupActivityFilter();
    populateGroupDirectSelect();
    
    console.log('‚úÖ Grup filtreleme sistemi ba≈üarƒ±yla ba≈ülatƒ±ldƒ±');
}

/**
 * Etkinlik filtresini doldur
 */
function populateGroupActivityFilter() {
    const activityFilter = document.getElementById('groupActivityFilter');
    if (!activityFilter) return;
    
    // Mevcut se√ßimi sakla
    const currentValue = activityFilter.value;
    
    // Filtreyi temizle (ilk se√ßenek hari√ß)
    activityFilter.innerHTML = '<option value="">T√ºm Etkinlikler</option>';
    
    // Aktiviteleri al
    const activities = {};
    
    // Yarƒ±yƒ±l i√ßi etkinlikleri
    if (APP_STATE.courseData?.dersDegerlendirme?.yariyilIciEtkinlikleri) {
        APP_STATE.courseData.dersDegerlendirme.yariyilIciEtkinlikleri.forEach(activity => {
            activities[activity.id] = {
                id: activity.id,
                adi: activity.etkinlik,
                type: 'Ara Sƒ±nav'
            };
        });
    }
    
    // Yarƒ±yƒ±l sonu etkinlikleri
    if (APP_STATE.courseData?.dersDegerlendirme?.yariyilSonuEtkinlikleri) {
        APP_STATE.courseData.dersDegerlendirme.yariyilSonuEtkinlikleri.forEach(activity => {
            activities[activity.id] = {
                id: activity.id,
                adi: activity.etkinlik,
                type: 'Final'
            };
        });
    }
    
    // Se√ßenekleri ekle
    Object.values(activities).forEach(activity => {
        const option = document.createElement('option');
        option.value = activity.id;
        option.textContent = `${activity.id} - ${activity.adi} (${activity.type})`;
        activityFilter.appendChild(option);
    });
    
    // √ñnceki se√ßimi geri y√ºkle
    if (currentValue && activityFilter.querySelector(`option[value="${currentValue}"]`)) {
        activityFilter.value = currentValue;
    }
}

/**
 * Grup filtrelerini temizle
 */
function clearGroupFilters() {
    GROUP_VIEW_SETTINGS.currentSearch = '';
    GROUP_VIEW_SETTINGS.currentActivityFilter = '';
    GROUP_VIEW_SETTINGS.currentStatusFilter = '';
    GROUP_VIEW_SETTINGS.currentGroupFilter = '';
    GROUP_VIEW_SETTINGS.currentDirectSelect = '';
    
    // Form elemanlarƒ±nƒ± temizle
    const searchInput = document.getElementById('groupSearchInput');
    if (searchInput) searchInput.value = '';
    
    const directSelect = document.getElementById('groupDirectSelect');
    if (directSelect) directSelect.value = '';
    
    const activityFilter = document.getElementById('groupActivityFilter');
    if (activityFilter) activityFilter.value = '';
    
    const statusFilter = document.getElementById('groupStatusFilter');
    if (statusFilter) statusFilter.value = '';
    
    const groupFilter = document.getElementById('groupGroupFilter');
    if (groupFilter) groupFilter.value = '';
    
    // G√∂r√ºn√ºm√º g√ºncelle
    updateStudentGroupInfoWithFilters();
    updateGroupFilterInfo();
    
    showModernToast('Grup filtreleri temizlendi', 'info');
    console.log('üßπ Grup filtreleri temizlendi');
}

/**
 * Filtreli grup bilgilerini g√ºncelle
 */
function updateStudentGroupInfoWithFilters() {
    try {
        const container = document.getElementById('studentGroupInfoContainer');
        const card = document.getElementById('studentGroupInfoCard');
        
        if (!container || !APP_STATE.studentData || APP_STATE.studentData.length === 0) {
            if (card) card.style.display = 'none';
            return;
        }
        
        // Card'ƒ± g√∂ster
        if (card) card.style.display = 'block';
        
        // Aktiviteleri al
        const activities = getFilteredActivities();
        
        if (Object.keys(activities).length === 0) {
            container.innerHTML = '<p class="empty-message">Filtreye uygun etkinlik bulunamadƒ±.</p>';
            return;
        }
        
        let html = '';
        Object.values(activities).forEach(activity => {
            const groups = getGroupsForActivity(activity.id);
            const typeLabel = activity.type;
            
            // Filtrelenmi≈ü √∂ƒürencileri al
            const filteredStudents = getFilteredStudentsForActivity(activity.id);
            
            if (filteredStudents.length === 0 && GROUP_VIEW_SETTINGS.currentSearch) {
                return; // Bu etkinlikte filtreye uygun √∂ƒürenci yoksa atla
            }
            
            html += `
                <div class="activity-group-section" data-activity-id="${activity.id}">
                    <div class="activity-group-title">
                        <span>${activity.id} - ${activity.adi} (${typeLabel})</span>
                        <button class="btn btn-sm btn-info" onclick="randomizeStudentsForActivity('${activity.id}')" title="Rastgele Daƒüƒ±t">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M16 3h5v5"></path>
                                <path d="M8 3H3v5"></path>
                                <path d="M12 22V8"></path>
                                <path d="M16 8l5-5"></path>
                                <path d="M8 8L3 3"></path>
                            </svg>
                            Rastgele
                        </button>
                    </div>
                    
                    <div class="group-container">
                        ${groups.map(groupId => {
                            const groupStudents = getFilteredStudentsInGroup(activity.id, groupId);
                            
                            // Grup filtresi varsa ve bu grup se√ßili deƒüilse atla
                            if (GROUP_VIEW_SETTINGS.currentGroupFilter && GROUP_VIEW_SETTINGS.currentGroupFilter !== groupId) {
                                return '';
                            }
                            
                            return `
                                <div class="group-section">
                                    <div class="group-label">${groupId} Grubu (${groupStudents.length} √∂ƒürenci)</div>
                                    <div class="group-drop-zone" data-group="${groupId}" data-activity="${activity.id}">
                                        <div class="group-students" id="group-${activity.id}-${groupId}">
                                            ${groupStudents.map(student => `
                                                <div class="student-item" draggable="true" data-student-id="${student.studentId}" data-student-name="${student.name} ${student.surname}">
                                                    <div class="student-name">${student.name} ${student.surname}</div>
                                                    <div class="student-details">
                                                        <span class="student-id">${student.studentId}</span>
                                                        ${student.email ? `<span class="student-email">${student.email}</span>` : ''}
                                                    </div>
                                                </div>
                                            `).join('')}
                                            ${groupStudents.length === 0 ? '<div class="empty-group-message">Filtreye uygun √∂ƒürenci yok</div>' : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).filter(html => html !== '').join('')}
                    </div>
                </div>
            `;
        });
        
        if (!html) {
            container.innerHTML = '<p class="empty-message">Filtrelere uygun √∂ƒürenci bulunamadƒ±.</p>';
        } else {
            container.innerHTML = html;
            
            // Drag&drop'u yeniden ayarla
            setTimeout(() => {
                setupDragAndDrop();
            }, 100);
        }
        
        console.log('‚úÖ Filtreli grup bilgileri g√ºncellendi');
        
    } catch (error) {
        console.error('Filtreli grup bilgileri g√ºncellenirken hata:', error);
    }
}

/**
 * Filtrelenmi≈ü aktiviteleri al
 */
function getFilteredActivities() {
    const activities = {};
    
    // Yarƒ±yƒ±l i√ßi etkinlikleri
    if (APP_STATE.courseData?.dersDegerlendirme?.yariyilIciEtkinlikleri) {
        APP_STATE.courseData.dersDegerlendirme.yariyilIciEtkinlikleri.forEach(activity => {
            if (!GROUP_VIEW_SETTINGS.currentActivityFilter || activity.id === GROUP_VIEW_SETTINGS.currentActivityFilter) {
                activities[activity.id] = {
                    id: activity.id,
                    adi: activity.etkinlik,
                    type: 'Ara Sƒ±nav'
                };
            }
        });
    }
    
    // Yarƒ±yƒ±l sonu etkinlikleri
    if (APP_STATE.courseData?.dersDegerlendirme?.yariyilSonuEtkinlikleri) {
        APP_STATE.courseData.dersDegerlendirme.yariyilSonuEtkinlikleri.forEach(activity => {
            if (!GROUP_VIEW_SETTINGS.currentActivityFilter || activity.id === GROUP_VIEW_SETTINGS.currentActivityFilter) {
                activities[activity.id] = {
                    id: activity.id,
                    adi: activity.etkinlik,
                    type: 'Final'
                };
            }
        });
    }
    
    return activities;
}

/**
 * Belirli bir etkinlik i√ßin filtrelenmi≈ü √∂ƒürencileri al
 */
function getFilteredStudentsForActivity(activityId) {
    if (!APP_STATE.studentData) return [];
    
    return APP_STATE.studentData.filter(student => {
        // Doƒürudan se√ßim filtresi (en y√ºksek √∂ncelik)
        if (GROUP_VIEW_SETTINGS.currentDirectSelect) {
            return student.studentId === GROUP_VIEW_SETTINGS.currentDirectSelect;
        }
        
        // Durum filtresi
        if (GROUP_VIEW_SETTINGS.currentStatusFilter && student.status !== GROUP_VIEW_SETTINGS.currentStatusFilter) {
            return false;
        }
        
        // Arama filtresi
        if (GROUP_VIEW_SETTINGS.currentSearch) {
            const searchTerm = GROUP_VIEW_SETTINGS.currentSearch.toLowerCase();
            const searchableText = `${student.name} ${student.surname} ${student.studentId} ${student.email || ''}`.toLowerCase();
            if (!searchableText.includes(searchTerm)) {
                return false;
            }
        }
        
        return true;
    });
}

/**
 * Belirli bir grup i√ßin filtrelenmi≈ü √∂ƒürencileri al
 */
function getFilteredStudentsInGroup(activityId, groupId) {
    const allStudents = getFilteredStudentsForActivity(activityId);
    const groupStudents = [];
    
    allStudents.forEach(student => {
        let studentGroupId = 'A'; // Varsayƒ±lan grup
        
        // courseData'dan grup bilgisini al
        if (APP_STATE.courseData?.ogrenciNotlari?.[student.studentId]?.grupBilgileri?.[activityId]) {
            studentGroupId = APP_STATE.courseData.ogrenciNotlari[student.studentId].grupBilgileri[activityId];
        } else if (student.grupId) {
            studentGroupId = student.grupId;
        }
        
        if (studentGroupId === groupId) {
            groupStudents.push(student);
        }
    });
    
    return groupStudents;
}

/**
 * Grup filtre bilgisini g√ºncelle
 */
function updateGroupFilterInfo() {
    const filterInfo = document.getElementById('groupFilterInfo');
    if (!filterInfo || !APP_STATE.studentData) return;
    
    const totalStudents = APP_STATE.studentData.length;
    let filteredCount = 0;
    
    // Her etkinlik i√ßin filtrelenmi≈ü √∂ƒürenci sayƒ±sƒ±nƒ± hesapla
    const activities = getFilteredActivities();
    Object.keys(activities).forEach(activityId => {
        const activityStudents = getFilteredStudentsForActivity(activityId);
        filteredCount = Math.max(filteredCount, activityStudents.length);
    });
    
    let infoText = `Toplam ${totalStudents} √∂ƒürenci`;
    
    if (GROUP_VIEW_SETTINGS.currentSearch || GROUP_VIEW_SETTINGS.currentStatusFilter || 
        GROUP_VIEW_SETTINGS.currentActivityFilter || GROUP_VIEW_SETTINGS.currentGroupFilter ||
        GROUP_VIEW_SETTINGS.currentDirectSelect) {
        infoText += ` (${filteredCount} g√∂steriliyor)`;
    }
    
    filterInfo.textContent = infoText;
}

// =====================================================
// √ñƒûRENCƒ∞ COMBOBOX Y√ñNETƒ∞Mƒ∞
// =====================================================

/**
 * √ñƒürenci listesi doƒürudan se√ßim combobox'ƒ±nƒ± doldur
 */
function populateStudentDirectSelect() {
    const directSelect = document.getElementById('studentDirectSelect');
    if (!directSelect || !APP_STATE.studentData) return;
    
    // Mevcut se√ßimi sakla
    const currentValue = directSelect.value;
    
    // Listeyi temizle (ilk se√ßenek hari√ß)
    directSelect.innerHTML = '<option value="">T√ºm √ñƒürenciler</option>';
    
    // √ñƒürencileri alfabetik sƒ±raya koy
    const sortedStudents = [...APP_STATE.studentData].sort((a, b) => {
        return `${a.name} ${a.surname}`.localeCompare(`${b.name} ${b.surname}`, 'tr');
    });
    
    // Se√ßenekleri ekle
    sortedStudents.forEach(student => {
        const option = document.createElement('option');
        option.value = student.studentId;
        option.textContent = `${student.name} ${student.surname} (${student.studentId})`;
        directSelect.appendChild(option);
    });
    
    // √ñnceki se√ßimi geri y√ºkle
    if (currentValue && directSelect.querySelector(`option[value="${currentValue}"]`)) {
        directSelect.value = currentValue;
    }
}

/**
 * Grup bilgileri doƒürudan se√ßim combobox'ƒ±nƒ± doldur
 */
function populateGroupDirectSelect() {
    const directSelect = document.getElementById('groupDirectSelect');
    if (!directSelect || !APP_STATE.studentData) return;
    
    // Mevcut se√ßimi sakla
    const currentValue = directSelect.value;
    
    // Listeyi temizle (ilk se√ßenek hari√ß)
    directSelect.innerHTML = '<option value="">T√ºm √ñƒürenciler</option>';
    
    // √ñƒürencileri alfabetik sƒ±raya koy
    const sortedStudents = [...APP_STATE.studentData].sort((a, b) => {
        return `${a.name} ${a.surname}`.localeCompare(`${b.name} ${b.surname}`, 'tr');
    });
    
    // Se√ßenekleri ekle
    sortedStudents.forEach(student => {
        const option = document.createElement('option');
        option.value = student.studentId;
        option.textContent = `${student.name} ${student.surname} (${student.studentId})`;
        directSelect.appendChild(option);
    });
    
    // √ñnceki se√ßimi geri y√ºkle
    if (currentValue && directSelect.querySelector(`option[value="${currentValue}"]`)) {
        directSelect.value = currentValue;
    }
}

// =====================================================
// GELƒ∞≈ûMƒ∞≈û DEƒûERLENDƒ∞RME Fƒ∞LTRESƒ∞ Sƒ∞STEMƒ∞
// =====================================================

/**
 * Deƒüerlendirme filtre ayarlarƒ±
 */
const ASSESSMENT_FILTER_SETTINGS = {
    currentSearch: '',
    currentStudentSelect: '',
    currentActivity: '',
    currentStatus: '',
    currentGroup: '',
    currentPass: '',
    currentGrade: ''
};

/**
 * Deƒüerlendirme filtreleme sistemini ba≈ülat
 */
function initializeAssessmentFiltering() {
    console.log('üîß Deƒüerlendirme filtreleme sistemi ba≈ülatƒ±lƒ±yor...');
    
    // Arama inputu
    const searchInput = document.getElementById('assessmentSearchInput');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            ASSESSMENT_FILTER_SETTINGS.currentSearch = e.target.value;
            updateAssessmentViewWithFilters();
            updateAssessmentFilterStats();
        });
        console.log('‚úÖ Deƒüerlendirme arama input event listener eklendi');
    }
    
    // Doƒürudan √∂ƒürenci se√ßimi
    const studentSelect = document.getElementById('assessmentStudentSelect');
    if (studentSelect) {
        studentSelect.addEventListener('change', function(e) {
            ASSESSMENT_FILTER_SETTINGS.currentStudentSelect = e.target.value;
            updateAssessmentViewWithFilters();
            updateAssessmentFilterStats();
        });
        console.log('‚úÖ Deƒüerlendirme √∂ƒürenci se√ßim event listener eklendi');
    }
    
    // Etkinlik filtresi
    const activityFilter = document.getElementById('assessmentActivityFilter');
    if (activityFilter) {
        activityFilter.addEventListener('change', function(e) {
            ASSESSMENT_FILTER_SETTINGS.currentActivity = e.target.value;
            updateAssessmentViewWithFilters();
            updateAssessmentFilterStats();
        });
        console.log('‚úÖ Deƒüerlendirme etkinlik filter event listener eklendi');
    }
    
    // Durum filtresi
    const statusFilter = document.getElementById('assessmentStatusFilter');
    if (statusFilter) {
        statusFilter.addEventListener('change', function(e) {
            ASSESSMENT_FILTER_SETTINGS.currentStatus = e.target.value;
            updateAssessmentViewWithFilters();
            updateAssessmentFilterStats();
        });
        console.log('‚úÖ Deƒüerlendirme durum filter event listener eklendi');
    }
    
    // Grup filtresi
    const groupFilter = document.getElementById('assessmentGroupFilter');
    if (groupFilter) {
        groupFilter.addEventListener('change', function(e) {
            ASSESSMENT_FILTER_SETTINGS.currentGroup = e.target.value;
            updateAssessmentViewWithFilters();
            updateAssessmentFilterStats();
        });
        console.log('‚úÖ Deƒüerlendirme grup filter event listener eklendi');
    }
    

    
    // Ba≈üarƒ± durumu filtresi
    const passFilter = document.getElementById('assessmentPassFilter');
    if (passFilter) {
        passFilter.addEventListener('change', function(e) {
            ASSESSMENT_FILTER_SETTINGS.currentPass = e.target.value;
            updateAssessmentViewWithFilters();
            updateAssessmentFilterStats();
        });
        console.log('‚úÖ Deƒüerlendirme ba≈üarƒ± filter event listener eklendi');
    }
    
    // Harf notu filtresi
    const gradeFilter = document.getElementById('assessmentGradeFilter');
    if (gradeFilter) {
        gradeFilter.addEventListener('change', function(e) {
            ASSESSMENT_FILTER_SETTINGS.currentGrade = e.target.value;
            updateAssessmentViewWithFilters();
            updateAssessmentFilterStats();
        });
        console.log('‚úÖ Deƒüerlendirme harf notu filter event listener eklendi');
    }
    
    // Filtreleri temizle butonu
    const clearButton = document.getElementById('clearAssessmentFilters');
    if (clearButton) {
        clearButton.addEventListener('click', function() {
            clearAssessmentFilters();
        });
        console.log('‚úÖ Deƒüerlendirme filtre temizleme butonu event listener eklendi');
    }
    
    // Yenile butonu
    const refreshButton = document.getElementById('refreshAssessmentFilters');
    if (refreshButton) {
        refreshButton.addEventListener('click', function() {
            refreshAssessmentFilters();
        });
        console.log('‚úÖ Deƒüerlendirme filtre yenileme butonu event listener eklendi');
    }
    
    // Filtreleri ba≈ülat
    populateAssessmentFilters();
    
    console.log('‚úÖ Deƒüerlendirme filtreleme sistemi ba≈üarƒ±yla ba≈ülatƒ±ldƒ±');
}

/**
 * Deƒüerlendirme filtrelerini doldur
 */
function populateAssessmentFilters() {
    populateAssessmentActivityFilter();
    populateAssessmentStudentSelect();
}

/**
 * Etkinlik filtresini doldur
 */
function populateAssessmentActivityFilter() {
    const activityFilter = document.getElementById('assessmentActivityFilter');
    if (!activityFilter) return;
    
    // Mevcut se√ßimi sakla
    const currentValue = activityFilter.value;
    
    // Filtreyi temizle (ilk se√ßenek hari√ß)
    activityFilter.innerHTML = '<option value="">T√ºm Etkinlikler</option>';
    
    // Import edilen JSON'dan etkinlikleri al
    if (!APP_STATE.courseData?.dersDegerlendirme) {
        console.warn('‚ö†Ô∏è Ders deƒüerlendirme verisi bulunamadƒ±, etkinlik filtresi doldurulamadƒ±');
        return;
    }
    
    const dersDegerlendirme = APP_STATE.courseData.dersDegerlendirme;
    
    // Yarƒ±yƒ±l i√ßi etkinlikleri
    if (dersDegerlendirme.yariyilIciEtkinlikleri && dersDegerlendirme.yariyilIciEtkinlikleri.length > 0) {
        const termGroup = document.createElement('optgroup');
        termGroup.label = 'Yarƒ±yƒ±l ƒ∞√ßi Etkinlikleri';
        
        dersDegerlendirme.yariyilIciEtkinlikleri.forEach(activity => {
            const option = document.createElement('option');
            option.value = activity.id;
            option.textContent = `${activity.id} - ${activity.etkinlik} (${activity.katkiYuzdesi}%)`;
            termGroup.appendChild(option);
        });
        
        activityFilter.appendChild(termGroup);
    }
    
    // Yarƒ±yƒ±l sonu etkinlikleri
    if (dersDegerlendirme.yariyilSonuEtkinlikleri && dersDegerlendirme.yariyilSonuEtkinlikleri.length > 0) {
        const finalGroup = document.createElement('optgroup');
        finalGroup.label = 'Yarƒ±yƒ±l Sonu Etkinlikleri';
        
        dersDegerlendirme.yariyilSonuEtkinlikleri.forEach(activity => {
            const option = document.createElement('option');
            option.value = activity.id;
            option.textContent = `${activity.id} - ${activity.etkinlik} (${activity.katkiYuzdesi}%)`;
            finalGroup.appendChild(option);
        });
        
        activityFilter.appendChild(finalGroup);
    }
    
    // √ñnceki se√ßimi geri y√ºkle
    if (currentValue && activityFilter.querySelector(`option[value="${currentValue}"]`)) {
        activityFilter.value = currentValue;
    }
    
    const termCount = dersDegerlendirme.yariyilIciEtkinlikleri?.length || 0;
    const finalCount = dersDegerlendirme.yariyilSonuEtkinlikleri?.length || 0;
    console.log(`‚úÖ Etkinlik filtresi dolduruldu. Yarƒ±yƒ±l i√ßi: ${termCount}, Yarƒ±yƒ±l sonu: ${finalCount}`);
}

/**
 * √ñƒürenci se√ßim listesini doldur
 */
function populateAssessmentStudentSelect() {
    console.log('üîç populateAssessmentStudentSelect √ßaƒürƒ±ldƒ±');
    
    const studentSelect = document.getElementById('assessmentStudentSelect');
    console.log('üìã studentSelect element:', studentSelect);
    console.log('üë• APP_STATE.studentData:', APP_STATE.studentData);
    
    if (!studentSelect) {
        console.error('‚ùå assessmentStudentSelect elementi bulunamadƒ±!');
        return;
    }
    
    if (!APP_STATE.studentData) {
        console.warn('‚ö†Ô∏è APP_STATE.studentData bo≈ü veya tanƒ±msƒ±z');
        return;
    }
    
    // Mevcut se√ßimi sakla
    const currentValue = studentSelect.value;
    
    // Listeyi temizle (ilk se√ßenek hari√ß)
    studentSelect.innerHTML = '<option value="">T√ºm √ñƒürenciler</option>';
    
    // √ñƒürencileri alfabetik sƒ±raya koy
    const sortedStudents = [...APP_STATE.studentData].sort((a, b) => {
        return `${a.name} ${a.surname}`.localeCompare(`${b.name} ${b.surname}`, 'tr');
    });
    
    console.log(`üìù ${sortedStudents.length} √∂ƒürenci sƒ±ralandƒ±`);
    
    // Se√ßenekleri ekle
    sortedStudents.forEach(student => {
        const option = document.createElement('option');
        option.value = student.studentId;
        option.textContent = `${student.name} ${student.surname} (${student.studentId})`;
        studentSelect.appendChild(option);
    });
    
    // √ñnceki se√ßimi geri y√ºkle
    if (currentValue && studentSelect.querySelector(`option[value="${currentValue}"]`)) {
        studentSelect.value = currentValue;
    }
    
    console.log(`‚úÖ populateAssessmentStudentSelect tamamlandƒ±. Toplam se√ßenek: ${studentSelect.options.length}`);
}

/**
 * T√ºm √∂ƒürenci dropdown'larƒ±nƒ± g√ºncelle
 */
function updateAllStudentDropdowns() {
    console.log('üîÑ T√ºm √∂ƒürenci dropdown\'larƒ± g√ºncelleniyor...');
    
    // √ñƒürenci listesi sekmesi dropdown'ƒ±
    if (typeof populateStudentDirectSelect === 'function') {
        populateStudentDirectSelect();
    }
    
    // Grup bilgileri sekmesi dropdown'ƒ±
    if (typeof populateGroupDirectSelect === 'function') {
        populateGroupDirectSelect();
    }
    
    // Deƒüerlendirme giri≈üi sekmesi dropdown'ƒ±
    if (typeof populateAssessmentStudentSelect === 'function') {
        populateAssessmentStudentSelect();
    }
    
    console.log('‚úÖ T√ºm √∂ƒürenci dropdown\'larƒ± g√ºncellendi');
}

/**
 * Debug i√ßin manuel test fonksiyonu
 */
window.testAssessmentStudentSelect = function() {
    console.log('üß™ Manuel test ba≈ülatƒ±lƒ±yor...');
    console.log('APP_STATE.studentData:', APP_STATE.studentData);
    const element = document.getElementById('assessmentStudentSelect');
    console.log('assessmentStudentSelect element:', element);
    
    if (typeof populateAssessmentStudentSelect === 'function') {
        populateAssessmentStudentSelect();
    } else {
        console.error('populateAssessmentStudentSelect fonksiyonu bulunamadƒ±!');
    }
};

/**
 * Deƒüerlendirme filtrelerini temizle
 */
function clearAssessmentFilters() {
    ASSESSMENT_FILTER_SETTINGS.currentSearch = '';
    ASSESSMENT_FILTER_SETTINGS.currentStudentSelect = '';
    ASSESSMENT_FILTER_SETTINGS.currentActivity = '';
    ASSESSMENT_FILTER_SETTINGS.currentStatus = '';
    ASSESSMENT_FILTER_SETTINGS.currentGroup = '';

    ASSESSMENT_FILTER_SETTINGS.currentPass = '';
    ASSESSMENT_FILTER_SETTINGS.currentGrade = '';
    
    // Form elemanlarƒ±nƒ± temizle
    const searchInput = document.getElementById('assessmentSearchInput');
    if (searchInput) searchInput.value = '';
    
    const studentSelect = document.getElementById('assessmentStudentSelect');
    if (studentSelect) studentSelect.value = '';
    
    const activityFilter = document.getElementById('assessmentActivityFilter');
    if (activityFilter) activityFilter.value = '';
    
    const statusFilter = document.getElementById('assessmentStatusFilter');
    if (statusFilter) statusFilter.value = '';
    
    const groupFilter = document.getElementById('assessmentGroupFilter');
    if (groupFilter) groupFilter.value = '';
    

    
    const passFilter = document.getElementById('assessmentPassFilter');
    if (passFilter) passFilter.value = '';
    
    const gradeFilter = document.getElementById('assessmentGradeFilter');
    if (gradeFilter) gradeFilter.value = '';
    
    // G√∂r√ºn√ºm√º g√ºncelle
    updateAssessmentViewWithFilters();
    updateAssessmentFilterStats();
    
    showModernToast('Deƒüerlendirme filtreleri temizlendi', 'info');
    console.log('üßπ Deƒüerlendirme filtreleri temizlendi');
}

/**
 * Deƒüerlendirme filtrelerini yenile
 */
function refreshAssessmentFilters() {
    populateAssessmentFilters();
    updateAssessmentViewWithFilters();
    updateAssessmentFilterStats();
    
    showModernToast('Deƒüerlendirme filtreleri yenilendi', 'success');
    console.log('üîÑ Deƒüerlendirme filtreleri yenilendi');
}

/**
 * Filtrelenmi≈ü √∂ƒürenci listesini al
 */
function getFilteredAssessmentStudents() {
    if (!APP_STATE.studentData) return [];
    
    return APP_STATE.studentData.filter(student => {
        // Doƒürudan √∂ƒürenci se√ßimi (en y√ºksek √∂ncelik)
        if (ASSESSMENT_FILTER_SETTINGS.currentStudentSelect) {
            return student.studentId === ASSESSMENT_FILTER_SETTINGS.currentStudentSelect;
        }
        
        // Arama filtresi
        if (ASSESSMENT_FILTER_SETTINGS.currentSearch) {
            const searchTerm = ASSESSMENT_FILTER_SETTINGS.currentSearch.toLowerCase();
            const searchableText = `${student.name} ${student.surname} ${student.studentId} ${student.email || ''}`.toLowerCase();
            if (!searchableText.includes(searchTerm)) {
                return false;
            }
        }
        
        // Durum filtresi
        if (ASSESSMENT_FILTER_SETTINGS.currentStatus && student.status !== ASSESSMENT_FILTER_SETTINGS.currentStatus) {
            return false;
        }
        
        // Grup filtresi
        if (ASSESSMENT_FILTER_SETTINGS.currentGroup) {
            let studentGroup = 'A'; // Varsayƒ±lan grup
            if (APP_STATE.courseData?.ogrenciNotlari?.[student.studentId]?.grupBilgileri) {
                // ƒ∞lk etkinliƒüin grup bilgisini al
                const firstActivity = Object.keys(APP_STATE.courseData.ogrenciNotlari[student.studentId].grupBilgileri)[0];
                if (firstActivity) {
                    studentGroup = APP_STATE.courseData.ogrenciNotlari[student.studentId].grupBilgileri[firstActivity];
                }
            }
            if (studentGroup !== ASSESSMENT_FILTER_SETTINGS.currentGroup) {
                return false;
            }
        }
        
        // Etkinlik filtresi
        if (ASSESSMENT_FILTER_SETTINGS.currentActivity) {
            // Se√ßilen etkinlik i√ßin not giri≈üi yapƒ±lacak √∂ƒürencileri g√∂ster
            // Bu durumda t√ºm √∂ƒürencileri g√∂stermek mantƒ±klƒ± √ß√ºnk√º not giri≈üi yapmak i√ßin
            // hangi √∂ƒürencilerin o etkinliƒüe katƒ±ldƒ±ƒüƒ±nƒ± g√∂rmek gerekir
            
            // Eƒüer sadece not giri≈üi yapƒ±lmƒ±≈ü √∂ƒürencileri g√∂stermek istenirse:
            // const hasGradeForActivity = checkStudentHasGradeForActivity(student.studentId, ASSESSMENT_FILTER_SETTINGS.currentActivity);
            // if (!hasGradeForActivity) return false;
            
            // ≈ûu an i√ßin t√ºm √∂ƒürencileri g√∂ster (not giri≈üi yapabilmek i√ßin)
            // Bu mantƒ±k, √∂ƒüretmenin belirli bir etkinlik i√ßin not giri≈üi yapacaƒüƒ± zaman
            // o etkinlikle ilgili t√ºm √∂ƒürencileri g√∂rmesini saƒülar
        }
        
        // Ba≈üarƒ± durumu filtresi - RTEU Y√∂netmeliƒüi'ne g√∂re
        if (ASSESSMENT_FILTER_SETTINGS.currentPass) {
            const letterGrade = getStudentLetterGrade(student.studentId);
            if (ASSESSMENT_FILTER_SETTINGS.currentPass === 'passed') {
                // Ba≈üarƒ±lƒ± √∂ƒürenciler: AA, BA, BB, CB, CC + ≈üartlƒ± ba≈üarƒ±lƒ± DC (YANO kontrol√º gerekli)
                const successfulGrades = ['AA', 'BA', 'BB', 'CB', 'CC'];
                if (!letterGrade || (!successfulGrades.includes(letterGrade) && letterGrade !== 'DC')) {
                    return false;
                }
                // DC i√ßin ≈üartlƒ± ba≈üarƒ± kontrol√º (basit olarak ge√ßti sayƒ±yoruz)
                if (letterGrade === 'DC') {
                    // YANO hesaplamasƒ± karma≈üƒ±k olduƒüu i√ßin DC'yi ≈üartlƒ± ba≈üarƒ±lƒ± kabul ediyoruz
                    // Ger√ßek uygulamada YANO >= 2.00 kontrol√º yapƒ±lmalƒ±
                }
            } else if (ASSESSMENT_FILTER_SETTINGS.currentPass === 'failed') {
                // Ba≈üarƒ±sƒ±z √∂ƒürenciler: DD, FD, FF, D
                const failedGrades = ['DD', 'FD', 'FF', 'D'];
                if (!letterGrade || !failedGrades.includes(letterGrade)) {
                    return false;
                }
            } else if (ASSESSMENT_FILTER_SETTINGS.currentPass === 'pending') {
                // Not girilmemi≈ü √∂ƒürenciler
                if (letterGrade !== null) {
                    return false;
                }
            }
        }
        
        // Harf notu filtresi
        if (ASSESSMENT_FILTER_SETTINGS.currentGrade) {
            const letterGrade = getStudentLetterGrade(student.studentId);
            if (ASSESSMENT_FILTER_SETTINGS.currentGrade === 'no_grade') {
                // Not girilmemi≈ü √∂ƒürenciler
                if (letterGrade !== null) {
                    return false;
                }
            } else {
                // Belirli harf notu
                if (letterGrade !== ASSESSMENT_FILTER_SETTINGS.currentGrade) {
                    return false;
                }
            }
        }
        
        return true;
    });
}



/**
 * √ñƒürenci final notunu al (mevcut calculateStudentGrades fonksiyonunu kullan)
 */
function getStudentFinalGrade(studentId) {
    try {
        const grades = calculateStudentGrades(studentId);
        return grades && grades.totalGrade !== null && grades.totalGrade !== undefined ? parseFloat(grades.totalGrade) : null;
    } catch (error) {
        console.debug('√ñƒürenci notu hesaplanƒ±rken hata:', studentId, error);
        return null;
    }
}

/**
 * √ñƒürenci harf notunu al (mevcut calculateStudentGrades fonksiyonunu kullan)
 */
function getStudentLetterGrade(studentId) {
    try {
        const grades = calculateStudentGrades(studentId);
        return grades && grades.letterGrade ? grades.letterGrade : null;
    } catch (error) {
        console.debug('√ñƒürenci harf notu hesaplanƒ±rken hata:', studentId, error);
        return null;
    }
}

/**
 * Filtreli deƒüerlendirme g√∂r√ºn√ºm√ºn√º g√ºncelle
 */
function updateAssessmentViewWithFilters() {
    try {
        // updateAssessmentView fonksiyonu kendi i√ßinde getFilteredAssessmentStudents() √ßaƒüƒ±rƒ±yor
        updateAssessmentView();
        
        const filteredStudents = getFilteredAssessmentStudents();
        console.log(`‚úÖ Deƒüerlendirme g√∂r√ºn√ºm√º g√ºncellendi: ${filteredStudents.length} √∂ƒürenci`);
        
    } catch (error) {
        console.error('Filtreli deƒüerlendirme g√∂r√ºn√ºm√º g√ºncellenirken hata:', error);
    }
}

/**
 * Deƒüerlendirme filtre istatistiklerini g√ºncelle
 */
function updateAssessmentFilterStats() {
    const filterStats = document.getElementById('assessmentFilterStats');
    if (!filterStats || !APP_STATE.studentData) return;
    
    const totalStudents = APP_STATE.studentData.length;
    const filteredStudents = getFilteredAssessmentStudents();
    const filteredCount = filteredStudents.length;
    
    let infoText = `Toplam ${totalStudents} √∂ƒürenci`;
    
    if (hasActiveAssessmentFilters()) {
        infoText += ` (${filteredCount} g√∂steriliyor)`;
        
        // Aktif filtre sayƒ±sƒ±nƒ± g√∂ster
        const activeFilterCount = getActiveAssessmentFilterCount();
        if (activeFilterCount > 0) {
            infoText += ` ‚Ä¢ ${activeFilterCount} aktif filtre`;
        }
    }
    
    filterStats.textContent = infoText;
}

/**
 * Aktif deƒüerlendirme filtresi var mƒ± kontrol et
 */
function hasActiveAssessmentFilters() {
    return ASSESSMENT_FILTER_SETTINGS.currentSearch ||
           ASSESSMENT_FILTER_SETTINGS.currentStudentSelect ||
           ASSESSMENT_FILTER_SETTINGS.currentActivity ||
           ASSESSMENT_FILTER_SETTINGS.currentStatus ||
           ASSESSMENT_FILTER_SETTINGS.currentGroup ||
           ASSESSMENT_FILTER_SETTINGS.currentPass ||
           ASSESSMENT_FILTER_SETTINGS.currentGrade;
}

/**
 * Aktif deƒüerlendirme filtre sayƒ±sƒ±nƒ± al
 */
function getActiveAssessmentFilterCount() {
    let count = 0;
    if (ASSESSMENT_FILTER_SETTINGS.currentSearch) count++;
    if (ASSESSMENT_FILTER_SETTINGS.currentStudentSelect) count++;
    if (ASSESSMENT_FILTER_SETTINGS.currentActivity) count++;
    if (ASSESSMENT_FILTER_SETTINGS.currentStatus) count++;
    if (ASSESSMENT_FILTER_SETTINGS.currentGroup) count++;
    if (ASSESSMENT_FILTER_SETTINGS.currentPass) count++;
    if (ASSESSMENT_FILTER_SETTINGS.currentGrade) count++;
    return count;
}

// =====================================================
// APP INITIALIZATION
// =====================================================

/**
 * √ñƒürenci listesi event listener'larƒ±nƒ± ayarla
 */
function setupStudentListEventListeners() {
    console.log('üîß √ñƒürenci listesi event listener\'larƒ± ayarlanƒ±yor...');
    
    // JSON file input
    const studentFileInput = document.getElementById('studentFileInput');
    if (studentFileInput) {
        studentFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                processStudentJSONFile(file);
            }
        });
        console.log('‚úÖ JSON file input event listener eklendi');
    }
    
    // CSV file input
    const studentCSVInput = document.getElementById('studentCSVInput');
    if (studentCSVInput) {
        studentCSVInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                processStudentCSVFile(file);
            }
        });
        console.log('‚úÖ CSV file input event listener eklendi');
    }
    
    // Search input
    const searchInput = document.getElementById('studentSearch');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            STUDENT_VIEW_SETTINGS.currentSearch = e.target.value;
            // Doƒürudan se√ßimi temizle
            const directSelect = document.getElementById('studentDirectSelect');
            if (directSelect && e.target.value) {
                directSelect.value = '';
            }
            updateStudentTableEnhanced();
        });
        console.log('‚úÖ Search input event listener eklendi');
    }
    
    // Direct select
    const directSelect = document.getElementById('studentDirectSelect');
    if (directSelect) {
        directSelect.addEventListener('change', function(e) {
            if (e.target.value) {
                // Arama kutusunu temizle
                const searchInput = document.getElementById('studentSearch');
                if (searchInput) {
                    searchInput.value = '';
                    STUDENT_VIEW_SETTINGS.currentSearch = '';
                }
                // Filtreyi uygula
                STUDENT_VIEW_SETTINGS.currentDirectSelect = e.target.value;
            } else {
                STUDENT_VIEW_SETTINGS.currentDirectSelect = '';
            }
            updateStudentTableEnhanced();
        });
        console.log('‚úÖ Direct select event listener eklendi');
    }
    
    // Status filter
    const statusFilter = document.getElementById('studentStatusFilter');
    if (statusFilter) {
        statusFilter.addEventListener('change', function(e) {
            STUDENT_VIEW_SETTINGS.currentStatusFilter = e.target.value;
            updateStudentTableEnhanced();
        });
        console.log('‚úÖ Status filter event listener eklendi');
    }
    
    // Group filter
    const groupFilter = document.getElementById('studentGroupFilter');
    if (groupFilter) {
        groupFilter.addEventListener('change', function(e) {
            STUDENT_VIEW_SETTINGS.currentGroupFilter = e.target.value;
            updateStudentTableEnhanced();
        });
        console.log('‚úÖ Group filter event listener eklendi');
    }
    
    console.log('‚úÖ √ñƒürenci listesi event listener\'larƒ± ba≈üarƒ±yla ayarlandƒ±');
    
    // Kolon kontrol butonlarƒ±nƒ± da ayarla
    setupTableViewControls();
}

/**
 * Uygulamayƒ± ba≈ülat
 */
function initializeApp() {
    console.log('üöÄ MUDEK Ders Deƒüerlendirme Formu v2.0 ba≈ülatƒ±lƒ±yor...');
    
    try {
        // √ñƒürenci listesi event listener'larƒ±nƒ± ayarla
        setupStudentListEventListeners();
        
        // Tablo g√∂r√ºn√ºm kontrollerini ayarla
        setupTableViewControls();
        
        // Deƒüerlendirme filtreleme sistemini ba≈ülat
        setTimeout(() => {
            initializeAssessmentFiltering();
        }, 500);
        
        // √ñƒürenci tablosunu ba≈ülat
        if (APP_STATE.studentData && APP_STATE.studentData.length > 0) {
            updateStudentTableEnhanced();
            updateStudentGroupInfo();
            updateAssessmentStudentFilter();
            
            // Yeni filtreleme sistemi i√ßin √∂ƒürenci listesini g√ºncelle
            if (typeof populateAssessmentStudentSelect === 'function') {
                populateAssessmentStudentSelect();
            }
            
            updateAssessmentView();
        }
        
        console.log('‚úÖ Uygulama ba≈üarƒ±yla ba≈ülatƒ±ldƒ±');
        
    } catch (error) {
        console.error('‚ùå Uygulama ba≈ülatma hatasƒ±:', error);
    }
}

// =====================================================
// OTOMATIK PUAN DAƒûITIM Sƒ∞STEMƒ∞
// =====================================================

/**
 * Otomatik puan daƒüƒ±tƒ±m butonlarƒ± i√ßin event listener'larƒ± ekle
 * Event delegation kullanarak kalƒ±cƒ± √ß√∂z√ºm saƒülar
 */
function setupAutoDistributeButtons() {
    // Event delegation ile container'a listener ekle
    const assessmentContainer = document.getElementById('assessmentContainer');
    if (!assessmentContainer) {
        console.error('‚ùå assessmentContainer bulunamadƒ±');
        return;
    }
    
    // Mevcut event listener'ƒ± kaldƒ±r (eƒüer varsa)
    assessmentContainer.removeEventListener('click', handleAutoDistributeClick);
    
    // Yeni event listener ekle
    assessmentContainer.addEventListener('click', handleAutoDistributeClick);
    
    // Mevcut butonlarƒ± say
    const autoDistributeButtons = document.querySelectorAll('.auto-distribute-btn');
    console.log(`‚úÖ ${autoDistributeButtons.length} otomatik daƒüƒ±tƒ±m butonu i√ßin event delegation ayarlandƒ±`);
}

/**
 * Otomatik daƒüƒ±tƒ±m buton click handler'ƒ±
 */
function handleAutoDistributeClick(e) {
    // Sadece auto-distribute-btn butonlarƒ± i√ßin √ßalƒ±≈ü
    if (!e.target.classList.contains('auto-distribute-btn')) {
        return;
    }
    
    e.preventDefault();
    e.stopPropagation();
    
    const button = e.target;
    const studentId = button.dataset.studentId;
    const activityId = button.dataset.activityId;
    
    console.log(`üéØ Inline daƒüƒ±tƒ±m ba≈ülatƒ±lƒ±yor: ${studentId} - ${activityId}`);
    openInlineDistributeForm(studentId, activityId);
}

/**
 * Tablolara otomatik daƒüƒ±tƒ±m butonlarƒ±nƒ± ekle (eƒüer yoksa)
 */
function addAutoDistributeButtonsToTables() {
    console.log('üîß Tablolara otomatik daƒüƒ±tƒ±m butonlarƒ± ekleniyor...');
    
    // T√ºm toplam puan h√ºcrelerini bul
    const totalPointsCells = document.querySelectorAll('.total-points-cell');
    
    totalPointsCells.forEach(cell => {
        // Eƒüer bu h√ºcrede zaten buton varsa, atla
        if (cell.querySelector('.auto-distribute-btn')) {
            return;
        }
        
        const studentId = cell.dataset.studentId;
        const activityId = cell.dataset.activityId || cell.dataset.componentId;
        
        if (!studentId || !activityId) {
            return;
        }
        
        // H√ºcrenin i√ßeriƒüini container ile sar
        const existingContent = cell.innerHTML;
        const container = document.createElement('div');
        container.className = 'total-points-container';
        
        // Mevcut i√ßeriƒüi value span'ine sar
        const valueSpan = document.createElement('span');
        valueSpan.className = 'total-points-value';
        valueSpan.innerHTML = existingContent;
        
        // Butonu olu≈ütur
        const button = document.createElement('button');
        button.className = 'auto-distribute-btn';
        button.type = 'button';
        button.dataset.studentId = studentId;
        button.dataset.activityId = activityId;
        button.title = 'Otomatik puan daƒüƒ±t';
        button.innerHTML = 'üéØ';
        
        // Container'a ekle
        container.appendChild(valueSpan);
        container.appendChild(button);
        
        // H√ºcreyi g√ºncelle
        cell.innerHTML = '';
        cell.appendChild(container);
    });
    
    const addedButtons = document.querySelectorAll('.auto-distribute-btn').length;
    console.log(`‚úÖ ${addedButtons} otomatik daƒüƒ±tƒ±m butonu eklendi/kontrol edildi`);
}

/**
 * Inline puan daƒüƒ±tƒ±m formunu a√ß
 */
function openInlineDistributeForm(studentId, activityId) {
    console.log(`üîç Inline form a√ßƒ±lƒ±yor: studentId=${studentId}, activityId=${activityId}`);
    
    const form = document.getElementById('inlineDistributeForm');
    if (!form) {
        console.error('‚ùå Inline daƒüƒ±tƒ±m formu bulunamadƒ±!');
        return;
    }

    // √ñƒürenci bilgilerini al
    const student = APP_STATE.studentData.find(s => s.studentId === studentId);
    if (!student) {
        console.error('‚ùå √ñƒürenci bulunamadƒ±:', studentId);
        return;
    }

    // Etkinlik bilgilerini al
    const activity = findNodeById(activityId);
    if (!activity) {
        console.error('‚ùå Etkinlik bulunamadƒ±:', activityId);
        return;
    }

    // Toplam soru sayƒ±sƒ±nƒ± hesapla
    const totalQuestions = activity.children ? activity.children.length : 0;
    console.log(`üìä Toplam soru sayƒ±sƒ±: ${totalQuestions}`);

    // Form bilgilerini doldur
    const inlineStudentName = document.getElementById('inlineStudentName');
    const inlineActivityName = document.getElementById('inlineActivityName');
    const totalQuestionsInline = document.getElementById('totalQuestionsInline');
    
    if (inlineStudentName) inlineStudentName.textContent = `${student.name} ${student.surname}`;
    if (inlineActivityName) inlineActivityName.textContent = `${activity.name || activity.id} (${totalQuestions} soru)`;
    if (totalQuestionsInline) totalQuestionsInline.textContent = totalQuestions;

    // Saklƒ± verileri ayarla
    form.dataset.studentId = studentId;
    form.dataset.activityId = activityId;

    // Form'u sƒ±fƒ±rla
    resetInlineDistributeForm();

    // Method tab event listener'larƒ±nƒ± ayarla
    setupInlineMethodTabs();

    // Form'u g√∂ster
    form.style.display = 'block';
    
    // ƒ∞lk input'a odaklan
    setTimeout(() => {
        const firstInput = document.getElementById('totalPointsInline');
        if (firstInput) firstInput.focus();
    }, 100);
    
    console.log(`‚úÖ Inline form a√ßƒ±ldƒ±`);
}

/**
 * Inline form'u sƒ±fƒ±rla
 */
function resetInlineDistributeForm() {
    // Input'larƒ± temizle
    const totalPointsInline = document.getElementById('totalPointsInline');
    const correctCountInline = document.getElementById('correctCountInline');
    
    if (totalPointsInline) totalPointsInline.value = '';
    if (correctCountInline) correctCountInline.value = '';
    
    // √ñnizlemeyi gizle
    const inlinePreview = document.getElementById('inlinePreview');
    if (inlinePreview) inlinePreview.style.display = 'none';
    
    // ƒ∞lk tab'ƒ± aktif yap
    const firstTab = document.querySelector('.method-tab[data-method="total"]');
    const firstSection = document.getElementById('totalSectionInline');
    
    document.querySelectorAll('.method-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.input-section-inline').forEach(section => section.classList.remove('active'));
    
    if (firstTab) firstTab.classList.add('active');
    if (firstSection) firstSection.classList.add('active');
}

/**
 * Method tab'larƒ±nƒ± ayarla
 */
function setupInlineMethodTabs() {
    const tabs = document.querySelectorAll('.method-tab');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const method = tab.dataset.method;
            
            // T√ºm tab'larƒ± deaktif et
            tabs.forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.input-section-inline').forEach(s => s.classList.remove('active'));
            
            // Se√ßilen tab'ƒ± aktif et
            tab.classList.add('active');
            const targetSection = document.getElementById(`${method}SectionInline`);
            if (targetSection) targetSection.classList.add('active');
            
            // √ñnizlemeyi gizle
            const inlinePreview = document.getElementById('inlinePreview');
            if (inlinePreview) inlinePreview.style.display = 'none';
        });
    });
}

/**
 * Inline form'u sƒ±fƒ±rla
 */
function resetInlineDistributeForm() {
    // Input'larƒ± temizle
    const totalPointsInline = document.getElementById('totalPointsInline');
    const correctCountInline = document.getElementById('correctCountInline');
    
    if (totalPointsInline) totalPointsInline.value = '';
    if (correctCountInline) correctCountInline.value = '';
    
    // √ñnizlemeyi gizle
    const inlinePreview = document.getElementById('inlinePreview');
    if (inlinePreview) inlinePreview.style.display = 'none';
    
    // ƒ∞lk tab'ƒ± aktif yap
    const firstTab = document.querySelector('.method-tab[data-method="total"]');
    const firstSection = document.getElementById('totalSectionInline');
    
    document.querySelectorAll('.method-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.input-section-inline').forEach(section => section.classList.remove('active'));
    
    if (firstTab) firstTab.classList.add('active');
    if (firstSection) firstSection.classList.add('active');
}

/**
 * Method tab'larƒ±nƒ± ayarla
 */
function setupInlineMethodTabs() {
    const tabs = document.querySelectorAll('.method-tab');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const method = tab.dataset.method;
            
            // T√ºm tab'larƒ± deaktif et
            tabs.forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.input-section-inline').forEach(s => s.classList.remove('active'));
            
            // Se√ßilen tab'ƒ± aktif et
            tab.classList.add('active');
            const targetSection = document.getElementById(`${method}SectionInline`);
            if (targetSection) targetSection.classList.add('active');
            
            // √ñnizlemeyi gizle
            const inlinePreview = document.getElementById('inlinePreview');
            if (inlinePreview) inlinePreview.style.display = 'none';
        });
    });
}

/**
 * Inline formu kapat
 */
function closeInlineDistributeForm() {
    const form = document.getElementById('inlineDistributeForm');
    if (form) {
        form.style.display = 'none';
        resetInlineDistributeForm();
        
        // Form kapandƒ±ktan sonra butonlarƒ± kontrol et ve gerekirse yeniden ekle
        setTimeout(() => {
            console.log('üîß Form kapatƒ±ldƒ±, butonlarƒ± kontrol ediliyor...');
            const existingButtons = document.querySelectorAll('.auto-distribute-btn');
            console.log(`üìä Mevcut buton sayƒ±sƒ±: ${existingButtons.length}`);
            
            if (existingButtons.length === 0) {
                console.log('‚ö†Ô∏è Hi√ß buton bulunamadƒ±, yeniden ekleniyor...');
                addAutoDistributeButtonsToTables();
            } else {
                console.log('‚úÖ Butonlar mevcut');
            }
        }, 100);
    }
}

/**
 * Hƒ±zlƒ± toplam puan daƒüƒ±tƒ±mƒ±
 */
function quickApplyTotal() {
    const form = document.getElementById('inlineDistributeForm');
    const totalInput = document.getElementById('totalPointsInline');
    
    if (!form || !totalInput) return;
    
    const totalScore = parseFloat(totalInput.value);
    if (!totalScore || totalScore <= 0) {
        showInlineMessage('‚ö†Ô∏è L√ºtfen ge√ßerli bir puan girin!', 'warning');
        return;
    }
    
    const studentId = form.dataset.studentId;
    const activityId = form.dataset.activityId;
    
    // √ñnizleme g√∂ster
    const distribution = calculateInlineDistribution(activityId, totalScore, 'total');
    if (distribution) {
        showInlinePreview(distribution);
    }
}

/**
 * MUDEK kriterlerine g√∂re rastgele daƒüƒ±tƒ±m
 */
function quickApplyTotalRandom() {
    const form = document.getElementById('inlineDistributeForm');
    const totalInput = document.getElementById('totalPointsInline');
    
    if (!form || !totalInput) return;
    
    const totalScore = parseFloat(totalInput.value);
    if (!totalScore || totalScore <= 0) {
        showInlineMessage('‚ö†Ô∏è L√ºtfen ge√ßerli bir puan girin!', 'warning');
        return;
    }
    
    const activityId = form.dataset.activityId;
    
    // Rastgele daƒüƒ±tƒ±m hesapla
    const distribution = calculateRandomDistribution(activityId, totalScore);
    if (distribution) {
        showInlinePreview(distribution);
    }
}

/**
 * E≈üit daƒüƒ±tƒ±m
 */
function quickApplyTotalEqual() {
    const form = document.getElementById('inlineDistributeForm');
    const totalInput = document.getElementById('totalPointsInline');
    
    if (!form || !totalInput) return;
    
    const totalScore = parseFloat(totalInput.value);
    if (!totalScore || totalScore <= 0) {
        showInlineMessage('‚ö†Ô∏è L√ºtfen ge√ßerli bir puan girin!', 'warning');
        return;
    }
    
    const activityId = form.dataset.activityId;
    
    // E≈üit daƒüƒ±tƒ±m hesapla
    const distribution = calculateEqualDistribution(activityId, totalScore);
    if (distribution) {
        showInlinePreview(distribution);
    }
}

// T√ºm hƒ±zlƒ± daƒüƒ±tƒ±m fonksiyonlarƒ±nƒ± global scope'a ekle
window.quickApplyTotal = quickApplyTotal;
window.quickApplyTotalRandom = quickApplyTotalRandom;
window.quickApplyTotalEqual = quickApplyTotalEqual;

/**
 * Hƒ±zlƒ± doƒüru/yanlƒ±≈ü daƒüƒ±tƒ±mƒ±
 */
function quickApplyCorrectWrongEqual() {
    console.log('üéØ quickApplyCorrectWrongEqual fonksiyonu √ßalƒ±≈ütƒ±rƒ±ldƒ±');
    
    const form = document.getElementById('inlineDistributeForm');
    const correctInput = document.getElementById('correctCountInline');
    const totalQuestionsSpan = document.getElementById('totalQuestionsInline');
    
    if (!form || !correctInput || !totalQuestionsSpan) {
        console.error('‚ùå Gerekli DOM elementleri bulunamadƒ±:', {form, correctInput, totalQuestionsSpan});
        return;
    }
    
    const correct = parseInt(correctInput.value);
    const total = parseInt(totalQuestionsSpan.textContent);
    
    if (isNaN(correct) || correct < 0 || correct > total) {
        showInlineMessage('‚ö†Ô∏è L√ºtfen ge√ßerli bir doƒüru sayƒ±sƒ± girin!', 'warning');
        return;
    }
    
    // Doƒüru/Yanlƒ±≈ü e≈üit daƒüƒ±tƒ±m
    const activityId = form.dataset.activityId;
    const activity = findNodeById(activityId);
    
    if (!activity || !activity.children || activity.children.length === 0) {
        showInlineMessage('‚ö†Ô∏è Bu etkinliƒüin alt bile≈üenleri bulunamadƒ±!', 'error');
        return;
    }
    
    const components = activity.children;
    const distribution = [];
    
    // ƒ∞lk 'correct' sayƒ±sƒ±ndaki sorulara tam puan, diƒüerlerine 0 puan
    components.forEach((comp, index) => {
        const maxPoints = comp.points || 100;
        const score = index < correct ? maxPoints : 0;
        
        distribution.push({
            id: comp.id,
            name: comp.name || `Soru ${comp.id.split('.').pop()}`,
            score: score,
            maxPoints: maxPoints,
            weight: comp.weight || 0
        });
    });
    
    // √ñnizleme g√∂ster
        showInlinePreview(distribution);
    }

// Global scope'a fonksiyonu ekle
window.quickApplyCorrectWrongEqual = quickApplyCorrectWrongEqual;

// Debug: Fonksiyon y√ºkleme kontrol√º
console.log('üîß quickApplyCorrectWrongEqual fonksiyonu tanƒ±mlandƒ±:', typeof quickApplyCorrectWrongEqual === 'function');
console.log('üåê Window objesi √ºzerinde tanƒ±mlƒ±:', typeof window.quickApplyCorrectWrongEqual === 'function');

// DOM y√ºklendikten sonra fonksiyon kontrol√º
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìÑ DOM y√ºklendi, fonksiyon kontrol√º:');
    console.log('  - quickApplyCorrectWrongEqual:', typeof window.quickApplyCorrectWrongEqual === 'function');
    console.log('  - quickApplyTotalRandom:', typeof window.quickApplyTotalRandom === 'function');
    console.log('  - quickApplyTotalEqual:', typeof window.quickApplyTotalEqual === 'function');
});

/**
 * G√ºvenli fonksiyon √ßaƒürƒ±sƒ±
 */
function safeCall(functionName) {
    try {
        console.log(`üîç Fonksiyon √ßaƒüƒ±rƒ±lƒ±yor: ${functionName}`);
        
        // √ñnce window objesi √ºzerinden kontrol et
        if (typeof window[functionName] === 'function') {
            console.log(`‚úÖ Window objesi √ºzerinden √ßaƒüƒ±rƒ±lƒ±yor: ${functionName}`);
            return window[functionName]();
        }
        
        // Global scope'tan kontrol et
        if (typeof eval(functionName) === 'function') {
            console.log(`‚úÖ Global scope'tan √ßaƒüƒ±rƒ±lƒ±yor: ${functionName}`);
            return eval(functionName + '()');
        }
        
        console.error(`‚ùå Fonksiyon bulunamadƒ±: ${functionName}`);
        alert(`Fonksiyon bulunamadƒ±: ${functionName}`);
        
    } catch (error) {
        console.error(`‚ùå Fonksiyon √ßaƒüƒ±rma hatasƒ±: ${functionName}`, error);
        alert(`Fonksiyon hatasƒ±: ${error.message}`);
    }
}

// safeCall'ƒ± da global scope'a ekle
window.safeCall = safeCall;

/**
 * MUDEK kriterlerine g√∂re rastgele daƒüƒ±tƒ±m hesapla
 */
function calculateRandomDistribution(activityId, totalScore) {
    const activity = findNodeById(activityId);
    if (!activity || !activity.children || activity.children.length === 0) {
        showInlineMessage('‚ö†Ô∏è Bu etkinliƒüin alt bile≈üenleri bulunamadƒ±!', 'error');
        return null;
    }

    const components = activity.children;
    const distribution = [];
    
    // MUDEK kriterleri: %50-85 arasƒ± ba≈üarƒ±lƒ± kabul edilir
    // Her soru i√ßin rastgele ama ger√ßek√ßi performans √ºret
    components.forEach(comp => {
        // Her sorunun aƒüƒ±rlƒ±ƒüƒ±na g√∂re maksimum puanƒ±nƒ± hesapla
        const maxPoints = comp.points || (comp.weight / 100 * 100);
        
        // MUDEK kriterlerine g√∂re rastgele ba≈üarƒ± oranƒ± (45-95%)
        const successRate = 0.45 + Math.random() * 0.50; // 45% - 95% arasƒ±
        
        // Toplam puanƒ±n bu soruya d√º≈üen payƒ±nƒ± hesapla
        const totalWeight = components.reduce((sum, c) => sum + (c.weight || 0), 0);
        const relativeWeight = (comp.weight || 0) / totalWeight;
        const allocatedScore = totalScore * relativeWeight;
        
        // Ba≈üarƒ± oranƒ±nƒ± uygula ve k√º√ß√ºk rastgele varyasyon ekle
        const variance = 0.9 + Math.random() * 0.2; // ¬±10% varyasyon
        const score = Math.min(allocatedScore * successRate * variance, maxPoints);
        
        distribution.push({
            id: comp.id,
            name: comp.name || `Soru ${comp.id.split('.').pop()}`,
            score: Math.max(0, score), // Negatif deƒüerleri engelle
            maxPoints: maxPoints,
            weight: comp.weight || 0
        });
    });
    
    // Toplam kontrol√º - eƒüer toplam √ßok farklƒ±ysa normalize et
    const currentTotal = distribution.reduce((sum, comp) => sum + comp.score, 0);
    if (Math.abs(currentTotal - totalScore) > totalScore * 0.15) {
        const factor = totalScore / currentTotal;
        distribution.forEach(comp => {
            comp.score = Math.min(comp.score * factor, comp.maxPoints);
        });
    }
    
    return distribution;
}

/**
 * E≈üit daƒüƒ±tƒ±m hesapla
 */
function calculateEqualDistribution(activityId, totalScore) {
    const activity = findNodeById(activityId);
    if (!activity || !activity.children || activity.children.length === 0) {
        showInlineMessage('‚ö†Ô∏è Bu etkinliƒüin alt bile≈üenleri bulunamadƒ±!', 'error');
        return null;
    }

    const components = activity.children;
    const distribution = [];
    
    // Toplam aƒüƒ±rlƒ±ƒüƒ± hesapla
    const totalWeight = components.reduce((sum, comp) => sum + (comp.weight || 0), 0);
    
    if (totalWeight === 0) {
        // Aƒüƒ±rlƒ±k yoksa e≈üit b√∂l
        const equalScore = totalScore / components.length;
        components.forEach(comp => {
            const maxPoints = comp.points || 100;
            distribution.push({
                id: comp.id,
                name: comp.name || `Soru ${comp.id.split('.').pop()}`,
                score: Math.min(equalScore, maxPoints),
                maxPoints: maxPoints,
                weight: comp.weight || 0
            });
        });
    } else {
        // Aƒüƒ±rlƒ±ƒüa g√∂re orantƒ±lƒ± daƒüƒ±t
        components.forEach(comp => {
            const maxPoints = comp.points || (comp.weight / 100 * 100);
            const weight = comp.weight || 0;
            const score = (weight / totalWeight) * totalScore;
            
            distribution.push({
                id: comp.id,
                name: comp.name || `Soru ${comp.id.split('.').pop()}`,
                score: Math.min(score, maxPoints),
                maxPoints: maxPoints,
                weight: weight
            });
        });
    }
    
    return distribution;
}

/**
 * Inline daƒüƒ±tƒ±m hesapla
 */
function calculateInlineDistribution(activityId, totalScore, method) {
    const activity = findNodeById(activityId);
    if (!activity || !activity.children || activity.children.length === 0) {
        showInlineMessage('‚ö†Ô∏è Bu etkinliƒüin alt bile≈üenleri bulunamadƒ±!', 'error');
        return null;
    }

    return calculateOptimalDistribution(activity.children, totalScore);
}

/**
 * Inline √∂nizleme g√∂ster
 */
function showInlinePreview(distribution) {
    const preview = document.getElementById('inlinePreview');
    const componentsList = document.getElementById('inlineComponentsList');
    
    if (!preview || !componentsList) return;
    
    const previewHTML = distribution.map(comp => `
        <div class="inline-component-item">
            <span class="component-name-inline">${comp.name} (√ñ√á: ${comp.weight})</span>
            <span class="component-score-inline">${comp.score.toFixed(1)}/${comp.maxPoints}</span>
        </div>
    `).join('');
    
    componentsList.innerHTML = previewHTML;
    preview.style.display = 'block';
    
    // Saklƒ± daƒüƒ±tƒ±m verisi
    preview.dataset.distribution = JSON.stringify(distribution);
}

/**
 * Inline daƒüƒ±tƒ±mƒ± onayla
 */
function confirmInlineDistribution() {
    const form = document.getElementById('inlineDistributeForm');
    const preview = document.getElementById('inlinePreview');
    
    if (!form || !preview) return;
    
    const distributionData = preview.dataset.distribution;
    if (!distributionData) return;
    
    const distribution = JSON.parse(distributionData);
    const studentId = form.dataset.studentId;
    
    // Puanlarƒ± input'lara yaz
    distribution.forEach(comp => {
        const input = document.querySelector(`input[data-student-id="${studentId}"][data-activity-id="${comp.id}"]`);
        if (input) {
            input.value = comp.score.toFixed(1);
            // Change event'ini tetikle
            const event = new Event('change', { bubbles: true });
            input.dispatchEvent(event);
        }
    });
    
    showInlineMessage('‚úÖ Puanlar ba≈üarƒ±yla daƒüƒ±tƒ±ldƒ±!', 'success');
    
    // Form'u kapat
    setTimeout(() => {
        closeInlineDistributeForm();
        
        // Butonlarƒ± yeniden ekle (tablo g√ºncellemesi sonrasƒ±)
        setTimeout(() => {
            console.log('üîß Inline daƒüƒ±tƒ±m sonrasƒ± butonlarƒ± yeniden ekleniyor...');
            addAutoDistributeButtonsToTables();
        }, 500);
    }, 1000);
}

/**
 * Inline √∂nizlemeyi iptal et
 */
function cancelInlinePreview() {
    const preview = document.getElementById('inlinePreview');
    if (preview) {
        preview.style.display = 'none';
    }
}

/**
 * Inline mesaj g√∂ster
 */
function showInlineMessage(message, type = 'info') {
    // Basit alert yerine inline mesaj sistemi
    const existingAlert = document.querySelector('.inline-alert');
    if (existingAlert) existingAlert.remove();
    
    const alert = document.createElement('div');
    alert.className = `inline-alert inline-alert-${type}`;
    alert.textContent = message;
    alert.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 6px;
        color: white;
        font-weight: 500;
        z-index: 2000;
        animation: slideIn 0.3s ease;
    `;
    
    if (type === 'success') alert.style.background = '#28a745';
    else if (type === 'warning') alert.style.background = '#ffc107';
    else if (type === 'error') alert.style.background = '#dc3545';
    else alert.style.background = '#17a2b8';
    
    document.body.appendChild(alert);
    
    setTimeout(() => {
        alert.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => alert.remove(), 300);
    }, 3000);
}

/**
 * Eski modal form'u sƒ±fƒ±rla (geriye uyumluluk i√ßin)
 */
function resetAutoDistributeForm() {
    console.log(`üîç Form sƒ±fƒ±rlanƒ±yor...`);
    
    // Radio butonlarƒ± sƒ±fƒ±rla
    const methodTotal = document.getElementById('methodTotal');
    const methodCorrectWrong = document.getElementById('methodCorrectWrong');
    
    if (methodTotal) methodTotal.checked = true;
    if (methodCorrectWrong) methodCorrectWrong.checked = false;
    
    // Input'larƒ± temizle (totalQuestionsInput hari√ß - otomatik doldurulur)
    const inputs = [
        'totalPointsInput',
        'correctCountInput', 
        'wrongCountInput'
    ];
    
    inputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            input.value = '';
        } else {
            console.warn(`‚ö†Ô∏è Input bulunamadƒ±: ${inputId}`);
        }
    });
    
    // Toplam soru sayƒ±sƒ± input'unu read-only yap (modal a√ßƒ±lƒ±rken otomatik doldurulacak)
    const totalQuestionsInput = document.getElementById('totalQuestionsInput');
    if (totalQuestionsInput) {
        totalQuestionsInput.readOnly = true;
        totalQuestionsInput.placeholder = 'Otomatik doldurulacak';
    }
    
    // B√∂l√ºmleri g√∂ster/gizle
    const sections = [
        { id: 'totalPointsSection', display: 'block' },
        { id: 'correctWrongSection', display: 'none' },
        { id: 'calculatedScore', display: 'none' },
        { id: 'componentsPreview', display: 'none' }
    ];
    
    sections.forEach(section => {
        const element = document.getElementById(section.id);
        if (element) {
            element.style.display = section.display;
        } else {
            console.warn(`‚ö†Ô∏è Section bulunamadƒ±: ${section.id}`);
        }
    });
    
    console.log(`‚úÖ Form sƒ±fƒ±rlandƒ±`);
}

/**
 * Method deƒüi≈üiklik event listener'larƒ±nƒ± ayarla
 */
function setupMethodChangeListeners() {
    console.log('üîß Method change listeners ayarlanƒ±yor...');
    
    // √ñnce mevcut listener'larƒ± temizle
    const methodRadios = document.querySelectorAll('input[name="distributionMethod"]');
    methodRadios.forEach(radio => {
        // Mevcut listener'larƒ± kaldƒ±r
        const newRadio = radio.cloneNode(true);
        radio.parentNode.replaceChild(newRadio, radio);
    });
    
    // Yeni listener'larƒ± ekle
    const newMethodRadios = document.querySelectorAll('input[name="distributionMethod"]');
    newMethodRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            console.log(`üìª Method deƒüi≈üti: ${this.value}`);
            
            const totalSection = document.getElementById('totalPointsSection');
            const correctWrongSection = document.getElementById('correctWrongSection');
            const componentsPreview = document.getElementById('componentsPreview');
            
            if (this.value === 'total') {
                if (totalSection) totalSection.style.display = 'block';
                if (correctWrongSection) correctWrongSection.style.display = 'none';
                console.log('‚úÖ Toplam puan b√∂l√ºm√º g√∂sterildi');
            } else if (this.value === 'correctWrong') {
                if (totalSection) totalSection.style.display = 'none';
                if (correctWrongSection) correctWrongSection.style.display = 'block';
                console.log('‚úÖ Doƒüru/yanlƒ±≈ü b√∂l√ºm√º g√∂sterildi');
            }
            
            if (componentsPreview) componentsPreview.style.display = 'none';
        });
    });

    // Doƒüru/yanlƒ±≈ü input'larƒ± i√ßin hesaplama
    const correctInput = document.getElementById('correctCountInput');
    const wrongInput = document.getElementById('wrongCountInput');
    const totalQuestionsInput = document.getElementById('totalQuestionsInput');

    [correctInput, wrongInput, totalQuestionsInput].forEach(input => {
        if (input) {
            // Mevcut listener'larƒ± temizle
            const newInput = input.cloneNode(true);
            input.parentNode.replaceChild(newInput, input);
            
            // Yeni listener ekle
            newInput.addEventListener('input', calculateScoreFromCorrectWrong);
        }
    });
    
    console.log('‚úÖ Method change listeners ayarlandƒ±');
}

/**
 * Doƒüru/yanlƒ±≈ü sayƒ±sƒ±ndan puan hesapla
 */
function calculateScoreFromCorrectWrong() {
    const correct = parseInt(document.getElementById('correctCountInput').value) || 0;
    const wrong = parseInt(document.getElementById('wrongCountInput').value) || 0;
    const total = parseInt(document.getElementById('totalQuestionsInput').value) || 0;

    if (total > 0 && (correct + wrong) <= total) {
        // Basit hesaplama: Doƒüru oranƒ± * 100
        const score = (correct / total) * 100;
        
        document.getElementById('calculatedScoreValue').textContent = score.toFixed(1);
        document.getElementById('calculatedScore').style.display = 'block';
    } else {
        document.getElementById('calculatedScore').style.display = 'none';
    }
}

/**
 * Daƒüƒ±tƒ±m √∂nizlemesi olu≈ütur
 */
function previewDistribution() {
    console.log('üîç √ñnizleme ba≈ülatƒ±lƒ±yor...');
    
    const modal = document.getElementById('autoDistributeModal');
    const studentId = modal.dataset.studentId;
    const activityId = modal.dataset.activityId;
    
    console.log(`üìä √ñnizleme veriler: studentId=${studentId}, activityId=${activityId}`);
    
    // Toplam puanƒ± al
    let totalScore = 0;
    const methodRadio = document.querySelector('input[name="distributionMethod"]:checked');
    
    if (!methodRadio) {
        alert('‚ö†Ô∏è L√ºtfen bir puan giri≈ü y√∂ntemi se√ßin!');
        return;
    }
    
    const method = methodRadio.value;
    console.log(`üìä Se√ßilen method: ${method}`);
    
    if (method === 'total') {
        const totalInput = document.getElementById('totalPointsInput');
        totalScore = parseFloat(totalInput?.value) || 0;
        console.log(`üìä Toplam puan giri≈üi: ${totalScore}`);
    } else if (method === 'correctWrong') {
        const correct = parseInt(document.getElementById('correctCountInput')?.value) || 0;
        const total = parseInt(document.getElementById('totalQuestionsInput')?.value) || 0;
        console.log(`üìä Doƒüru/yanlƒ±≈ü giri≈üi: ${correct}/${total}`);
        
        if (total > 0) {
            totalScore = (correct / total) * 100;
            console.log(`üìä Hesaplanan puan: ${totalScore}`);
        }
    }

    if (totalScore <= 0) {
        alert('‚ö†Ô∏è L√ºtfen ge√ßerli bir puan girin!');
        return;
    }

    // Alt bile≈üenleri al
    const activity = findNodeById(activityId);
    console.log(`üìä Bulunan etkinlik:`, activity);
    
    if (!activity || !activity.children || activity.children.length === 0) {
        alert('‚ö†Ô∏è Bu etkinliƒüin alt bile≈üenleri bulunamadƒ±!');
        console.log(`‚ùå Alt bile≈üen sorunu: activity=${!!activity}, children=${activity?.children?.length}`);
        return;
    }

    console.log(`üìä Alt bile≈üen sayƒ±sƒ±: ${activity.children.length}`);

    // Puan daƒüƒ±tƒ±mƒ±nƒ± hesapla
    const distribution = calculateOptimalDistribution(activity.children, totalScore);
    console.log(`üìä Hesaplanan daƒüƒ±tƒ±m:`, distribution);
    
    // √ñnizleme g√∂ster
    displayDistributionPreview(distribution);
    const previewSection = document.getElementById('componentsPreview');
    if (previewSection) {
        previewSection.style.display = 'block';
        console.log('‚úÖ √ñnizleme g√∂sterildi');
    } else {
        console.error('‚ùå √ñnizleme section bulunamadƒ±');
    }
}

/**
 * Optimal puan daƒüƒ±tƒ±mƒ±nƒ± hesapla (√ñ√á'lere g√∂re)
 */
function calculateOptimalDistribution(components, totalScore) {
    const distribution = [];
    
    // Her bile≈üen i√ßin √ñ√á sayƒ±sƒ±nƒ± hesapla
    const componentWeights = components.map(comp => {
        const outcomeCount = comp.ogrenme√áiktilari ? comp.ogrenme√áiktilari.length : 1;
        return {
            id: comp.id,
            name: comp.name || comp.id,
            weight: outcomeCount,
            maxPoints: comp.points || 10
        };
    });
    
    // Toplam aƒüƒ±rlƒ±k
    const totalWeight = componentWeights.reduce((sum, comp) => sum + comp.weight, 0);
    
    // Puanlarƒ± daƒüƒ±t
    let remainingScore = totalScore;
    
    componentWeights.forEach((comp, index) => {
        let assignedScore;
        
        if (index === componentWeights.length - 1) {
            // Son bile≈üen: kalan puanƒ± ver
            assignedScore = remainingScore;
        } else {
            // Aƒüƒ±rlƒ±ƒüa g√∂re puan hesapla
            assignedScore = (totalScore * comp.weight) / totalWeight;
            assignedScore = Math.round(assignedScore * 100) / 100; // 2 ondalƒ±k
        }
        
        // Maksimum puanƒ± a≈ümasƒ±n
        assignedScore = Math.min(assignedScore, comp.maxPoints);
        remainingScore -= assignedScore;
        
        distribution.push({
            id: comp.id,
            name: comp.name,
            score: assignedScore,
            maxPoints: comp.maxPoints,
            weight: comp.weight
        });
    });
    
    return distribution;
}

/**
 * Daƒüƒ±tƒ±m √∂nizlemesini g√∂ster
 */
function displayDistributionPreview(distribution) {
    console.log('üé® √ñnizleme g√∂steriliyor:', distribution);
    
    const componentsList = document.getElementById('componentsList');
    
    if (!componentsList) {
        console.error('‚ùå componentsList elementi bulunamadƒ±');
        return;
    }
    
    if (!distribution || distribution.length === 0) {
        componentsList.innerHTML = '<div class="no-components">Alt bile≈üen bulunamadƒ±</div>';
        return;
    }
    
    const previewHTML = distribution.map(comp => `
        <div class="component-preview-item">
            <span class="component-name">${comp.name} (√ñ√á: ${comp.weight})</span>
            <span class="component-score">${comp.score.toFixed(1)}/${comp.maxPoints}</span>
        </div>
    `).join('');
    
    componentsList.innerHTML = previewHTML;
    console.log(`‚úÖ ${distribution.length} bile≈üen √∂nizlemesi olu≈üturuldu`);
}

/**
 * Otomatik daƒüƒ±tƒ±mƒ± uygula
 */
function applyAutoDistribution() {
    const modal = document.getElementById('autoDistributeModal');
    const studentId = modal.dataset.studentId;
    const activityId = modal.dataset.activityId;
    
    // Toplam puanƒ± al
    let totalScore = 0;
    const method = document.querySelector('input[name="distributionMethod"]:checked').value;
    
    if (method === 'total') {
        totalScore = parseFloat(document.getElementById('totalPointsInput').value) || 0;
    } else if (method === 'correctWrong') {
        const correct = parseInt(document.getElementById('correctCountInput').value) || 0;
        const total = parseInt(document.getElementById('totalQuestionsInput').value) || 0;
        if (total > 0) {
            totalScore = (correct / total) * 100;
        }
    }

    if (totalScore <= 0) {
        alert('‚ö†Ô∏è L√ºtfen ge√ßerli bir puan girin!');
        return;
    }

    // Alt bile≈üenleri al
    const activity = findNodeById(activityId);
    if (!activity || !activity.children || activity.children.length === 0) {
        alert('‚ö†Ô∏è Bu etkinliƒüin alt bile≈üenleri bulunamadƒ±!');
        return;
    }

    // Puan daƒüƒ±tƒ±mƒ±nƒ± hesapla
    const distribution = calculateOptimalDistribution(activity.children, totalScore);
    
    // Puanlarƒ± input'lara yaz (mevcut input'larƒ± simule et)
    distribution.forEach(comp => {
        // Alt bile≈üen input'unu bul ve deƒüeri yaz
        const input = document.querySelector(`input[data-student-id="${studentId}"][data-activity-id="${comp.id}"]`);
        if (input) {
            input.value = comp.score.toFixed(1);
            // Change event'ini tetikle
            const event = new Event('change', { bubbles: true });
            input.dispatchEvent(event);
        }
    });

    // Modal'ƒ± kapat
    closeAutoDistributeModal();
    
    // Ba≈üarƒ± mesajƒ±
    showSuccessMessage(`‚úÖ ${distribution.length} alt bile≈üene puan daƒüƒ±tƒ±ldƒ±!`);
    
    console.log('‚úÖ Otomatik puan daƒüƒ±tƒ±mƒ± tamamlandƒ±:', distribution);
}

/**
 * Modal'ƒ± kapat
 */
function closeAutoDistributeModal() {
    const modal = document.getElementById('autoDistributeModal');
    if (modal) {
        modal.classList.remove('active');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300); // CSS transition s√ºresi
    }
}

/**
 * Ba≈üarƒ± mesajƒ± g√∂ster
 */
function showSuccessMessage(message) {
    // Basit alert yerine daha g√ºzel bir notification sistemi eklenebilir
    alert(message);
}

// =====================================================
// ELECTRON ENTEGRASYONU
// =====================================================

/**
 * Electron API'leri i√ßin event listener'larƒ± ekle
 */
function setupElectronIntegration() {
    // Electron ortamƒ±nda mƒ±yƒ±z kontrol et
    if (typeof window.electronAPI !== 'undefined') {
        console.log('üñ•Ô∏è Electron ortamƒ± tespit edildi');
        
        // Dosya y√ºkleme event'i
        window.electronAPI.onLoadJsonFile((event, data) => {
            try {
                const parsedData = JSON.parse(data.content);
                // Mevcut importCourseData fonksiyonunu kullan
                importCourseData(parsedData);
                APP_STATE.jsonFileName = data.filename;
                showToast(`‚úÖ ${data.filename} ba≈üarƒ±yla y√ºklendi!`, 'success');
            } catch (error) {
                console.error('JSON parse hatasƒ±:', error);
                showToast(`‚ùå JSON dosyasƒ± okunamadƒ±: ${error.message}`, 'error');
            }
        });
        
        // Dosya kaydetme isteƒüi
        window.electronAPI.onSaveJsonRequest((event) => {
            const courseData = exportCourseData();
            const filename = APP_STATE.jsonFileName || 'ders-tanimi.json';
            
            window.electronAPI.saveJsonDialog({
                content: JSON.stringify(courseData, null, 2),
                filename: filename
            }).then(result => {
                if (result.success) {
                    showToast(`‚úÖ Dosya kaydedildi: ${result.filePath}`, 'success');
                } else if (!result.cancelled) {
                    showToast(`‚ùå Dosya kaydetme hatasƒ±: ${result.error}`, 'error');
                }
            });
        });
        
        // √ñƒürenci listesi y√ºkleme
        window.electronAPI.onLoadStudentsFile((event, data) => {
            try {
                const parsedData = JSON.parse(data.content);
                // Mevcut √∂ƒürenci import fonksiyonunu kullan
                importStudentData(parsedData);
                showToast(`‚úÖ ${data.filename} √∂ƒürenci listesi y√ºklendi!`, 'success');
            } catch (error) {
                console.error('√ñƒürenci JSON parse hatasƒ±:', error);
                showToast(`‚ùå √ñƒürenci listesi okunamadƒ±: ${error.message}`, 'error');
            }
        });
        
        // Not dƒ±≈üa aktarma isteƒüi
        window.electronAPI.onExportGradesRequest((event) => {
            const gradesData = {
                courseData: APP_STATE.courseData,
                studentData: APP_STATE.studentData,
                gradesData: APP_STATE.gradesData,
                assessmentTree: APP_STATE.assessmentTree,
                exportDate: new Date().toISOString()
            };
            
            const filename = `notlar-${APP_STATE.courseData?.courseCode || 'unknown'}-${new Date().toISOString().split('T')[0]}.json`;
            
            window.electronAPI.saveGradesDialog({
                content: JSON.stringify(gradesData, null, 2),
                filename: filename
            }).then(result => {
                if (result.success) {
                    showToast(`‚úÖ Notlar kaydedildi: ${result.filePath}`, 'success');
                } else if (!result.cancelled) {
                    showToast(`‚ùå Not kaydetme hatasƒ±: ${result.error}`, 'error');
                }
            });
        });
        
        // Electron men√º kƒ±sayollarƒ± i√ßin ek fonksiyonlar
        setupElectronMenuHandlers();
        
        // Electron s√ºr√ºm bilgilerini g√∂ster
        if (window.versions) {
            console.log('üì± Uygulama S√ºr√ºmleri:', window.versions);
            
            // S√ºr√ºm bilgilerini footer'a ekle (varsa)
            const footer = document.querySelector('.footer, .version-info');
            if (footer) {
                const versionInfo = document.createElement('div');
                versionInfo.className = 'electron-version-info';
                versionInfo.innerHTML = `
                    <small>
                        Electron ${window.versions.electron} | 
                        Node.js ${window.versions.node} | 
                        App ${window.versions.app}
                    </small>
                `;
                footer.appendChild(versionInfo);
            }
        }
        
    } else {
        console.log('üåê Web tarayƒ±cƒ± ortamƒ± tespit edildi');
        // Web ortamƒ± i√ßin √∂zel ayarlar
        setupWebIntegration();
    }
}

/**
 * Electron men√º i≈üleyicilerini ayarla
 */
function setupElectronMenuHandlers() {
    // Ctrl+O - Dosya A√ß
    document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'o') {
            e.preventDefault();
            // Electron men√ºs√º zaten bu i≈ülemi yapacak
        }
    });
    
    // Ctrl+S - Dosya Kaydet
    document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            // Electron men√ºs√º zaten bu i≈ülemi yapacak
        }
    });
    
    // Ctrl+Shift+O - √ñƒürenci Listesi Y√ºkle
    document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'O') {
            e.preventDefault();
            // Electron men√ºs√º zaten bu i≈ülemi yapacak
        }
    });
    
    // Ctrl+E - Notlarƒ± Dƒ±≈üa Aktar
    document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
            e.preventDefault();
            // Electron men√ºs√º zaten bu i≈ülemi yapacak
        }
    });
}

/**
 * Web ortamƒ± i√ßin ayarlar
 */
function setupWebIntegration() {
    // IndexedDB otomatik kayƒ±t sistemini ba≈ülat
    if (!autoSaveManager) {
        autoSaveManager = new MudekAutoSaveManager();
        console.log('üöÄ IndexedDB tabanlƒ± otomatik kayƒ±t sistemi aktif edildi');
    }
    
    // Eski localStorage verilerini temizle (ge√ßi≈ü i√ßin)
    try {
        const oldData = localStorage.getItem('mudek-course-data');
        if (oldData) {
            console.log('üîÑ Eski localStorage verisi IndexedDB\'ye ge√ßiriliyor...');
            localStorage.removeItem('mudek-course-data');
        }
            } catch (error) {
        console.warn('‚ö†Ô∏è Eski veri temizleme uyarƒ±sƒ±:', error);
            }
}

/**
 * Electron'da toast mesajlarƒ± g√ºvenli ≈üekilde g√∂ster
 */
if (typeof window.electronAPI !== 'undefined') {
    console.log('üîß Electron toast sistemi ayarlanƒ±yor...');
    
    // G√ºvenli toast fonksiyonu olu≈ütur (window'a atamadan)
    function createElectronToast(message, type = 'info', duration = 3000) {
        // √ñnce mevcut toast sistemini kullanmaya √ßalƒ±≈ü
        if (typeof window.showToast === 'function') {
            try {
                window.showToast(message, type, duration);
                return;
            } catch (error) {
                console.warn('‚ö†Ô∏è showToast hatasƒ±:', error);
            }
        }
        
            // Fallback - basit bir toast sistemi
            console.log(`[${type.toUpperCase()}] ${message}`);
            
            // Basit bir toast elementi olu≈ütur
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
            top: 60px;
                right: 20px;
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
                color: white;
                padding: 12px 24px;
                border-radius: 4px;
                z-index: 10000;
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            max-width: 300px;
            word-wrap: break-word;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 14px;
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
            if (toast.parentNode) {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s ease';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }
            }, duration);
        }
    
    // Global olarak eri≈üilebilir kƒ±l ama window'a atamadan
    window.electronToastFunction = createElectronToast;
    
    console.log('‚úÖ Electron toast sistemi hazƒ±r');
}

// DOM y√ºklendiƒüinde uygulamayƒ± ba≈ülat
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        initializeApp();
        setupElectronIntegration();
        
        // IndexedDB otomatik kayƒ±t sistemini ba≈ülat
        if (!autoSaveManager) {
            autoSaveManager = new MudekAutoSaveManager();
            console.log('üöÄ IndexedDB otomatik kayƒ±t sistemi DOM y√ºklendiƒüinde ba≈ülatƒ±ldƒ±');
        }
    });
} else {
    // DOM zaten y√ºklenmi≈ü
    initializeApp();
    setupElectronIntegration();
    
    // IndexedDB otomatik kayƒ±t sistemini ba≈ülat
    if (!autoSaveManager) {
        autoSaveManager = new MudekAutoSaveManager();
        console.log('üöÄ IndexedDB otomatik kayƒ±t sistemi hemen ba≈ülatƒ±ldƒ±');
    }
}

// =====================================================
// LOG Sƒ∞STEMƒ∞
// =====================================================

/**
 * Log sistemi durumu
 */
const LOG_SYSTEM = {
    logs: [],
    isAutoScrollEnabled: true,
    maxLogs: 1000,
    filters: {
        level: 'all'
    }
};

/**
 * Log sistemi butonlarƒ±nƒ± ba≈ülat
 */
function initializeLogSystem() {
    try {
        console.log('üîß Log sistemi ba≈ülatƒ±lƒ±yor...');
        
        // Buton event listener'larƒ± ekle
        const btnClearLogs = document.getElementById('btnClearLogs');
        const btnExportLogs = document.getElementById('btnExportLogs');
        const btnAutoScroll = document.getElementById('btnAutoScroll');
        const logFilters = document.querySelectorAll('.log-filter');
        
        if (btnClearLogs) {
            btnClearLogs.addEventListener('click', clearLogs);
        }
        
        if (btnExportLogs) {
            btnExportLogs.addEventListener('click', exportLogs);
        }
        
        if (btnAutoScroll) {
            btnAutoScroll.addEventListener('click', toggleAutoScroll);
        }
        
        logFilters.forEach(filter => {
            filter.addEventListener('click', (e) => {
                const level = e.target.dataset.level;
                setLogFilter(level);
            });
        });
        
        // Mevcut console.log, console.warn, console.error'larƒ± yakala
        interceptConsoleLog();
        
        // Ba≈ülangƒ±√ß log'u ekle
        addLogEntry('Log sistemi ba≈üarƒ±yla ba≈ülatƒ±ldƒ±', 'success');
        
        // Mevcut log'larƒ± y√ºkle
        loadExistingLogs();
        
        console.log('‚úÖ Log sistemi ba≈ülatƒ±ldƒ±');
        
    } catch (error) {
        console.error('‚ùå Log sistemi ba≈ülatƒ±lƒ±rken hata:', error);
    }
}

/**
 * Console fonksiyonlarƒ±nƒ± yakala
 */
function interceptConsoleLog() {
    const originalLog = console.log;
    const originalWarn = console.warn;
    const originalError = console.error;
    
    console.log = function(...args) {
        const message = args.map(arg => 
            typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
        ).join(' ');
        
        // Sistem log'u olmayan mesajlarƒ± ekle
        if (!message.includes('üîß') && !message.includes('‚úÖ') && !message.includes('‚ùå')) {
            addLogEntry(message, 'info');
        }
        
        return originalLog.apply(console, args);
    };
    
    console.warn = function(...args) {
        const message = args.map(arg => 
            typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
        ).join(' ');
        
        addLogEntry(message, 'warn');
        return originalWarn.apply(console, args);
    };
    
    console.error = function(...args) {
        const message = args.map(arg => 
            typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
        ).join(' ');
        
        addLogEntry(message, 'error');
        return originalError.apply(console, args);
    };
}

/**
 * Log giri≈üi ekle
 */
function addLogEntry(message, level = 'info') {
    const logEntry = {
        id: Date.now() + Math.random(),
        timestamp: new Date(),
        level: level,
        message: message
    };
    
    LOG_SYSTEM.logs.push(logEntry);
    
    // Maksimum log sayƒ±sƒ±nƒ± kontrol et
    if (LOG_SYSTEM.logs.length > LOG_SYSTEM.maxLogs) {
        LOG_SYSTEM.logs = LOG_SYSTEM.logs.slice(-LOG_SYSTEM.maxLogs);
    }
    
    // UI'ya ekle
    renderLogEntry(logEntry);
    updateLogCount();
    
    // Otomatik kaydƒ±rma
    if (LOG_SYSTEM.isAutoScrollEnabled) {
        scrollToBottom();
    }
}

/**
 * Log giri≈üini UI'ya render et
 */
function renderLogEntry(logEntry) {
    const logContainer = document.getElementById('logContainer');
    if (!logContainer) return;
    
    // Filtre kontrol√º
    if (LOG_SYSTEM.filters.level !== 'all' && LOG_SYSTEM.filters.level !== logEntry.level) {
        return;
    }
    
    const logElement = document.createElement('div');
    logElement.className = `log-entry log-${logEntry.level}`;
    logElement.dataset.level = logEntry.level;
    logElement.dataset.id = logEntry.id;
    
    const timeString = logEntry.timestamp.toLocaleTimeString('tr-TR', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
    
    logElement.innerHTML = `
        <span class="log-time">[${timeString}]</span>
        <span class="log-level">${logEntry.level.toUpperCase()}</span>
        <span class="log-message">${escapeHtml(logEntry.message)}</span>
    `;
    
    logContainer.appendChild(logElement);
}

/**
 * T√ºm log'larƒ± yeniden render et
 */
function renderAllLogs() {
    const logContainer = document.getElementById('logContainer');
    if (!logContainer) return;
    
    // Container'ƒ± temizle
    logContainer.innerHTML = '';
    
    // Filtrelenmi≈ü log'larƒ± render et
    LOG_SYSTEM.logs.forEach(logEntry => {
        if (LOG_SYSTEM.filters.level === 'all' || LOG_SYSTEM.filters.level === logEntry.level) {
            renderLogEntry(logEntry);
        }
    });
    
    // Otomatik kaydƒ±rma
    if (LOG_SYSTEM.isAutoScrollEnabled) {
        scrollToBottom();
    }
}

/**
 * Log sayƒ±sƒ±nƒ± g√ºncelle
 */
function updateLogCount() {
    const logCount = document.getElementById('logCount');
    if (logCount) {
        const totalLogs = LOG_SYSTEM.logs.length;
        logCount.textContent = `(${totalLogs} log)`;
    }
}

/**
 * Log'larƒ± temizle
 */
function clearLogs() {
    if (confirm('T√ºm log\'larƒ± temizlemek istediƒüinizden emin misiniz?')) {
        LOG_SYSTEM.logs = [];
        
        const logContainer = document.getElementById('logContainer');
        if (logContainer) {
            logContainer.innerHTML = '<div class="log-entry log-info"><span class="log-time">[' + 
                new Date().toLocaleTimeString('tr-TR') + ']</span><span class="log-level">INFO</span>' +
                '<span class="log-message">Log\'lar temizlendi</span></div>';
        }
        
        updateLogCount();
        showModernToast('Log\'lar temizlendi', 'success');
    }
}

/**
 * Log'larƒ± dƒ±≈üa aktar
 */
function exportLogs() {
    try {
        const exportData = {
            exportDate: new Date().toISOString(),
            totalLogs: LOG_SYSTEM.logs.length,
            filters: LOG_SYSTEM.filters,
            logs: LOG_SYSTEM.logs.map(log => ({
                timestamp: log.timestamp.toISOString(),
                level: log.level,
                message: log.message
            }))
        };
        
        const jsonData = JSON.stringify(exportData, null, 2);
        const filename = `mudek-logs-${new Date().toISOString().split('T')[0]}.json`;
        
        // Dosya indirme
        const blob = new Blob([jsonData], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showModernToast(`Log'lar dƒ±≈üa aktarƒ±ldƒ±: ${filename}`, 'success');
        
    } catch (error) {
        console.error('Log dƒ±≈üa aktarma hatasƒ±:', error);
        showModernToast('Log dƒ±≈üa aktarma ba≈üarƒ±sƒ±z!', 'error');
    }
}

/**
 * Otomatik kaydƒ±rmayƒ± a√ß/kapat
 */
function toggleAutoScroll() {
    const btnAutoScroll = document.getElementById('btnAutoScroll');
    if (!btnAutoScroll) return;
    
    LOG_SYSTEM.isAutoScrollEnabled = !LOG_SYSTEM.isAutoScrollEnabled;
    
    if (LOG_SYSTEM.isAutoScrollEnabled) {
        btnAutoScroll.classList.add('btn-info');
        btnAutoScroll.classList.remove('btn-secondary');
        btnAutoScroll.innerHTML = '<i class="fas fa-arrow-down"></i> Otomatik Kaydƒ±rma';
        scrollToBottom();
    } else {
        btnAutoScroll.classList.remove('btn-info');
        btnAutoScroll.classList.add('btn-secondary');
        btnAutoScroll.innerHTML = '<i class="fas fa-pause"></i> Otomatik Kaydƒ±rma Durduruldu';
    }
}

/**
 * Log filtresini ayarla
 */
function setLogFilter(level) {
    LOG_SYSTEM.filters.level = level;
    
    // Buton stillerini g√ºncelle
    const logFilters = document.querySelectorAll('.log-filter');
    logFilters.forEach(filter => {
        if (filter.dataset.level === level) {
            filter.classList.add('active');
        } else {
            filter.classList.remove('active');
        }
    });
    
    // Log'larƒ± yeniden render et
    renderAllLogs();
}

/**
 * En alt kƒ±sma kaydƒ±r
 */
function scrollToBottom() {
    const logContainer = document.getElementById('logContainer');
    if (logContainer) {
        logContainer.scrollTop = logContainer.scrollHeight;
    }
}

/**
 * HTML'i escape et
 */
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

/**
 * Mevcut log'larƒ± y√ºkle (console'dan)
 */
function loadExistingLogs() {
    // Ba≈ülangƒ±√ß log'larƒ± ekle
    addLogEntry('MUDEK Ders Deƒüerlendirme Sistemi v2.0 ba≈ülatƒ±ldƒ±', 'success');
    addLogEntry('Uygulama ba≈ülatma zamanƒ±: ' + new Date().toLocaleString('tr-TR'), 'info');
    
    // Uygulama durumu log'u
    if (APP_STATE.courseData) {
        addLogEntry(`Ders y√ºkl√º: ${APP_STATE.courseData.courseName || 'Bilinmeyen'}`, 'info');
    }
    
    if (APP_STATE.studentData && APP_STATE.studentData.length > 0) {
        addLogEntry(`${APP_STATE.studentData.length} √∂ƒürenci listesi y√ºkl√º`, 'info');
    }
    
    // Otomatik kayƒ±t durumu
    if (typeof autoSaveManager !== 'undefined' && autoSaveManager) {
        addLogEntry('Otomatik kayƒ±t sistemi aktif', 'success');
    }
}

// showModernToast fonksiyonunu log sistemine entegre et
const originalShowModernToast = window.showModernToast;
if (originalShowModernToast) {
    window.showModernToast = function(message, type = 'info', duration = 4000) {
        // √ñnce toast'ƒ± g√∂ster
        originalShowModernToast(message, type, duration);
        
        // Sonra log'a ekle
        const logType = type === 'success' ? 'success' : 
                       type === 'error' ? 'error' : 
                       type === 'warning' ? 'warn' : 'info';
        
        addLogEntry(`Toast: ${message}`, logType);
    };
}

// Global fonksiyonlarƒ± window'a ekle
window.initializeLogSystem = initializeLogSystem;
window.addLogEntry = addLogEntry;
