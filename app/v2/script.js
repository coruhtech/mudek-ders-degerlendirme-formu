/**
 * Ders DeÄŸerlendirme Sistemi
 * -------------------------
 * Bu script ders deÄŸerlendirme kriterlerini ve Ã¶ÄŸrenci notlarÄ±nÄ±
 * yÃ¶netmek iÃ§in kullanÄ±lan web uygulamasÄ±nÄ± kontrol eder.
 * 
 * @version 2.0.0
 * @author Ders DeÄŸerlendirme Sistemi GeliÅŸtirme Ekibi
 */

'use strict';

// =====================================================
// SABITLER VE GLOBAL DEÄIÅKENLER
// =====================================================

/**
 * DeÄŸerlendirme etkinlik tÃ¼rleri
 */
const ACTIVITY_TYPES = {
    term: [
        "Ara SÄ±nav",
        "Laboratuvar SÄ±navÄ±",
        "Deney",
        "Deney SonrasÄ± Quiz",
        "Performans",
        "Quiz",
        "Rapor",
        "Rapor Sunma",
        "Makale Kritik Etme",
        "Makale Yazma",
        "Proje HazÄ±rlama",
        "Proje Sunma",
        "Rehberli Problem Ã‡Ã¶zÃ¼mÃ¼",
        "Seminer",
        "SÃ¶zlÃ¼ SÄ±nav",
        "Ã–dev Problemleri Ä°Ã§in Ã‡alÄ±ÅŸma",
        "Proje TasarÄ±mÄ±/YÃ¶netimi",
        "Derse KatÄ±lÄ±m",
        "Ev Ã–devi"
    ],
    final: [
        "Final SÄ±navÄ±",
        "Laboratuvar Ara SÄ±navÄ±",
        "Makale Yazma",
        "Proje HazÄ±rlama",
        "Proje Sunma",
        "Proje TasarÄ±mÄ±/YÃ¶netimi",
        "Quiz",
        "Rapor",
        "Rapor HazÄ±rlama",
        "Rapor Sunma",
        "Seminer",
        "SÃ¶zlÃ¼ SÄ±nav",
        "GÃ¶zlem"
    ],
    subItem: [
        "Soru",
        "Rubrik",
        "Test"
    ]
};

/**
 * Uygulama durum deÄŸiÅŸkenleri
 */
const APP_STATE = {
    courseData: null,        // Ders bilgileri
    learningOutcomes: [],    // Ã–ÄŸrenme Ã§Ä±ktÄ±larÄ±
    programOutcomes: [],     // Program Ã§Ä±ktÄ±larÄ±
    outcomeMatrix: null,     // Ã–Ã‡-PÃ‡ Ä°liÅŸki Matrisi
    assessmentTree: [],      // DeÄŸerlendirme aÄŸacÄ±
    selectedNode: null,      // SeÃ§ili dÃ¼ÄŸÃ¼m
	testDetailsNode: null,   // Test detaylarÄ± iÃ§in geÃ§ici dÃ¼ÄŸÃ¼m
    multipleItemsNode: null, // Ã‡oklu Ã¶ÄŸe eklemek iÃ§in geÃ§ici dÃ¼ÄŸÃ¼m
    multipleItemsType: '',   // Eklenecek Ã¶ÄŸelerin tipi (soru veya rubrik)
    termWeight: 40,          // YarÄ±yÄ±l iÃ§i aÄŸÄ±rlÄ±ÄŸÄ±
    finalWeight: 60,         // YarÄ±yÄ±l sonu aÄŸÄ±rlÄ±ÄŸÄ±
    jsonFileName: '',        // YÃ¼klenen JSON dosyasÄ±nÄ±n adÄ±
    studentData: [],         // Ã–ÄŸrenci verileri
    gradesData: {},          // Not verileri
    testDetailsNode: null,   // Test detaylarÄ± iÃ§in geÃ§ici dÃ¼ÄŸÃ¼m
    currentActiveTabId: 'definition', // Aktif sekme ID'si
    currentMappingNode: null, // Haritalama dÃ¼zenlenen dÃ¼ÄŸÃ¼m
    selectedStudentId: null  // SeÃ§ili Ã¶ÄŸrenci ID'si (student grades view iÃ§in)
};

// =====================================================
// DOM ELEMENTLERINI SEÃ‡ME
// =====================================================

// Ana konteynerlar
const treeContainer = document.getElementById('treeContainer');
const outcomesList = document.getElementById('outcomesList');
const programOutcomesList = document.getElementById('programOutcomesList');
const matrixContainer = document.getElementById('matrixContainer');
const courseDetailsContainer = document.getElementById('courseDetailsContainer');
const courseTitle = document.getElementById('courseTitle');
const courseDetails = document.getElementById('courseDetails');
const courseTerm = document.getElementById('courseTerm');
const termWeightSpan = document.getElementById('termWeight');
const finalWeightSpan = document.getElementById('finalWeight');
const termProgress = document.getElementById('termProgress');
const finalProgress = document.getElementById('finalProgress');

// Modaller
const importModal = document.getElementById('importModal');
const exportModal = document.getElementById('exportModal');
const importStudentsModal = document.getElementById('importStudentsModal');
const exportGradesModal = document.getElementById('exportGradesModal');
const testDetailsModal = document.getElementById('testDetailsModal');
const closeImportModal = document.getElementById('closeImportModal');
const closeExportModal = document.getElementById('closeExportModal');
const closeImportStudentsModal = document.getElementById('closeImportStudentsModal');
const closeExportGradesModal = document.getElementById('closeExportGradesModal');
const closeTestDetailsModal = document.getElementById('closeTestDetailsModal');

const multipleItemsModal = document.getElementById('multipleItemsModal');
const closeMultipleItemsModal = document.getElementById('closeMultipleItemsModal');
const multipleItemsTitle = document.getElementById('multipleItemsTitle');
const itemCount = document.getElementById('itemCount');
const itemType = document.getElementById('itemType');
const questionType = document.getElementById('questionType');
const rubricType = document.getElementById('rubricType');
const questionTypeContainer = document.getElementById('questionTypeContainer');
const rubricTypeContainer = document.getElementById('rubricTypeContainer');
const btnAddMultipleItems = document.getElementById('btnAddMultipleItems');

const toast = document.getElementById('toast');
const toastMessage = document.getElementById('toastMessage');

// Form ve input elementleri
const jsonContent = document.getElementById('jsonContent');
const exportJsonContent = document.getElementById('exportJsonContent');
const studentJsonContent = document.getElementById('studentJsonContent');
const exportGradesContent = document.getElementById('exportGradesContent');
const fileInput = document.getElementById('fileInput');
const selectedFileName = document.getElementById('selectedFileName');
const selectedStudentFileName = document.getElementById('selectedStudentFileName');
const studentFileInput = document.getElementById('studentFileInput');
const studentJsonInput = document.getElementById('studentJsonInput');
const studentTable = document.getElementById('studentTable');
const assessmentContainer = document.getElementById('assessmentContainer');
const gradesTable = document.getElementById('gradesTable');
const statsContent = document.getElementById('statsContent');
const chartContainer = document.getElementById('chartContainer');
const totalQuestionsInput = document.getElementById('totalQuestions');
const correctWeightInput = document.getElementById('correctWeight');
const wrongPenaltyInput = document.getElementById('wrongPenalty');

// ButonlarÄ± seÃ§me
const btnImport = document.getElementById('btnImport');
const btnExport = document.getElementById('btnExport');
const btnAddTerm = document.getElementById('btnAddTerm');
const btnAddFinal = document.getElementById('btnAddFinal');
const btnAddQuestion = document.getElementById('btnAddQuestion');
const btnAddRubric = document.getElementById('btnAddRubric');
const btnRemove = document.getElementById('btnRemove');
const btnExpandAll = document.getElementById('btnExpandAll');
const btnCollapseAll = document.getElementById('btnCollapseAll');
const btnSelectFile = document.getElementById('btnSelectFile');
const btnApplyJson = document.getElementById('btnApplyJson');
const btnCopyJson = document.getElementById('btnCopyJson');
const btnSaveJson = document.getElementById('btnSaveJson');
const btnImportStudents = document.getElementById('btnImportStudents');
const btnClearStudents = document.getElementById('btnClearStudents');
const btnSelectStudentFile = document.getElementById('btnSelectStudentFile');
const btnApplyStudentJson = document.getElementById('btnApplyStudentJson');
const btnImportGrades = document.getElementById('btnImportGrades');
const btnSaveGrades = document.getElementById('btnSaveGrades');
const btnSaveGradesToFile = document.getElementById('btnSaveGradesToFile');
const btnExportGradesJSON = document.getElementById('btnExportGradesJSON');
const btnExportGradesExcel = document.getElementById('btnExportGradesExcel');
const btnCalculateGrades = document.getElementById('btnCalculateGrades');
const btnExportFinalGrades = document.getElementById('btnExportFinalGrades');
const btnCopyGrades = document.getElementById('btnCopyGrades');
const btnSaveTestDetails = document.getElementById('btnSaveTestDetails');

// Grup yÃ¶netimi elementleri (aktif gruplar gÃ¶sterimi kaldÄ±rÄ±ldÄ±)
const groupMappingModal = document.getElementById('groupMappingModal');
const mappingContainer = document.getElementById('mappingContainer');
const addMappingRowBtn = document.getElementById('addMappingRow');
const saveMappingBtn = document.getElementById('saveMappingBtn');
const mappingActivityName = document.getElementById('mappingActivityName');

// =====================================================
// GUID SÄ°STEMÄ° KALDIRILDI - BasitleÅŸtirme
// =====================================================

// GUID sistemi geliÅŸtirmeleri kaldÄ±rÄ±ldÄ±
// Temel ID tabanlÄ± sistem korundu

// =====================================================
// ETKÄ°NLÄ°K SEÃ‡ENEK MODAL SÄ°STEMÄ°
// =====================================================

/**
 * Etkinlik eklendikten sonra seÃ§enek modalÄ±nÄ± gÃ¶ster
 * @param {string} activityType - 'term' veya 'final'
 * @param {Object} activityNode - Eklenen etkinlik dÃ¼ÄŸÃ¼mÃ¼
 */
function showActivityOptionsModal(activityType, activityNode) {
    const modal = document.getElementById('activityOptionsModal');
    const title = document.getElementById('activityOptionsTitle');
    const successText = document.getElementById('activitySuccessText');
    
    if (!modal || !title || !successText) {
        console.error('Etkinlik seÃ§enek modal elementleri bulunamadÄ±!');
        return;
    }
    
    // Modal iÃ§eriÄŸini gÃ¼ncelle
    const activityTypeText = activityType === 'term' ? 'YarÄ±yÄ±l iÃ§i' : 'YarÄ±yÄ±l sonu';
    
    if (activityNode === null) {
        // Etkinlik henÃ¼z eklenmedi - Ã¶nce seÃ§im yapÄ±lacak
        title.textContent = `ğŸ¯ ${activityTypeText} Etkinlik Ekleme`;
        successText.textContent = `${activityTypeText} etkinlik eklemek istiyorsunuz. Bu etkinliÄŸe nasÄ±l bir iÃ§erik eklemek istersiniz?`;
    } else {
        // Etkinlik zaten eklendi - eski davranÄ±ÅŸ
    title.textContent = `ğŸ¯ ${activityTypeText} Etkinlik BaÅŸarÄ±yla Eklendi!`;
    successText.textContent = `${activityTypeText} etkinlik baÅŸarÄ±yla oluÅŸturuldu. Åimdi bu etkinliÄŸe soru veya rubrik eklemek ister misiniz?`;
    }
    
    // Ã–Ã‡ seÃ§im alanÄ±nÄ± doldur
    populateActivityOutcomesSelect();
    
    // Modal'Ä± gÃ¶ster
    modal.classList.add('active');
    modal.style.display = 'flex';
    
    // Aktif etkinlik bilgisini sakla
    window.currentActivityNode = activityNode;
    window.currentActivityType = activityType;
    
    // Ã–Ã‡'leri yÃ¼kle
    populateActivityOutcomesSelect();
    
    // Ä°lk seÃ§eneÄŸi varsayÄ±lan olarak seÃ§
    const firstCard = modal.querySelector('.activity-option-card');
    if (firstCard) {
        selectActivityOption(firstCard);
    }
    
    // Puan alanlarÄ±nÄ±n durumunu kontrol et
    setTimeout(() => {
        updatePointsFieldVisibility();
    }, 100);
}

/**
 * Yeni etkinlik oluÅŸtur
 * @param {string} activityType - Etkinlik tÃ¼rÃ¼ ('term' veya 'final')
 * @returns {Object} OluÅŸturulan etkinlik node'u
 */
function createNewActivity(activityType) {
    try {
        let newNode, newId;
        
        if (activityType === 'term') {
            // Mevcut yarÄ±yÄ±l iÃ§i etkinlikleri say
            const termCount = APP_STATE.assessmentTree.filter(node => node.id.startsWith('A')).length;
            newId = `A${termCount + 1}`;
            newNode = {
                id: newId,
                name: 'YarÄ±yÄ±l Ä°Ã§i Etkinlik',
                type: ACTIVITY_TYPES.term[0],
                weight: 0,
                points: 100,
                outcomes: [],
                description: 'YarÄ±yÄ±l iÃ§i deÄŸerlendirme',
                expanded: true,
                children: []
            };
            
            // YarÄ±yÄ±l iÃ§i etkinliklerini baÅŸa ekleyin
            // Var olan yarÄ±yÄ±l iÃ§i etkinliklerini bul
            const termNodes = APP_STATE.assessmentTree.filter(node => node.id.startsWith('A'));
            
            // DiÄŸer tÃ¼m etkinlikleri al
            const otherNodes = APP_STATE.assessmentTree.filter(node => !node.id.startsWith('A'));
            
            // Yeni dÃ¼ÄŸÃ¼mÃ¼ yarÄ±yÄ±l iÃ§i etkinliklerine ekle
            termNodes.push(newNode);
            
            // AÄŸacÄ± gÃ¼ncelle - Ã¶nce tÃ¼m yarÄ±yÄ±l iÃ§i, sonra diÄŸer etkinlikler
            APP_STATE.assessmentTree = [...termNodes, ...otherNodes];
            
        } else if (activityType === 'final') {
            // Mevcut yarÄ±yÄ±l sonu etkinlikleri say
            const finalCount = APP_STATE.assessmentTree.filter(node => node.id.startsWith('F')).length;
            newId = `F${finalCount + 1}`;
            newNode = {
                id: newId,
                name: 'YarÄ±yÄ±l Sonu Etkinlik',
                type: ACTIVITY_TYPES.final[0],
                weight: 0,
                points: 100,
                outcomes: [],
                description: 'YarÄ±yÄ±l sonu deÄŸerlendirme',
                expanded: true,
                children: []
            };
            
            // YarÄ±yÄ±l sonu etkinliklerini sona ekle
            APP_STATE.assessmentTree.push(newNode);
        }
        
        selectNode(newNode);
        
        renderTree();
        
        // DeÄŸerlendirme sekmesini gÃ¼ncelle - CRITICAL SYNC
        updateAssessmentView();
        
        // Yeni eklenen etkinlik iÃ§in otomatik grup atamasÄ±
        assignDefaultGroupsToNewActivity(newNode);
        
        // Ã–ÄŸrenci grup bilgilerini gÃ¼ncelle
        updateStudentGroupInfoDisplay();
        
        const activityTypeText = activityType === 'term' ? 'YarÄ±yÄ±l iÃ§i' : 'YarÄ±yÄ±l sonu';
        showModernToast(`${activityTypeText} etkinlik eklendi.`);
        
        return newNode;
        
    } catch (error) {
        console.error("Etkinlik oluÅŸturulurken hata oluÅŸtu:", error);
        showModernToast("Etkinlik oluÅŸturulamadÄ±!", "error");
        return null;
    }
}

/**
 * Etkinlik seÃ§eneÄŸi seÃ§imi
 * @param {HTMLElement} cardElement - SeÃ§ilen kart elementi
 */
function selectActivityOption(cardElement) {
    const modal = document.getElementById('activityOptionsModal');
    if (!modal) return;
    
    // TÃ¼m kartlarÄ± deselect et
    modal.querySelectorAll('.activity-option-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // SeÃ§ilen kartÄ± select et
    cardElement.classList.add('selected');
    
    // Apply butonunu aktif et
    const applyBtn = document.getElementById('applyActivityOptions');
    if (applyBtn) {
        applyBtn.disabled = false;
    }
}

/**
 * Etkinlik seÃ§eneklerini uygula
 */
function applyActivityOptions() {
    const modal = document.getElementById('activityOptionsModal');
    const selectedCard = modal.querySelector('.activity-option-card.selected');
    
    if (!selectedCard) {
        showModernToast("Bir seÃ§enek seÃ§in!", "warning");
        return;
    }
    
    const option = selectedCard.dataset.option;
    
    try {
        // EÄŸer etkinlik henÃ¼z eklenmemiÅŸse, Ã¶nce etkinliÄŸi oluÅŸtur
        if (window.currentActivityNode === null) {
            const newNode = createNewActivity(window.currentActivityType);
            window.currentActivityNode = newNode;
        }
        
        switch (option) {
            case 'questions':
                applyQuestionOption();
                break;
            case 'rubrics':
                applyRubricOption();
                break;
            case 'empty':
                applyEmptyOption();
                break;
            default:
                showModernToast("GeÃ§ersiz seÃ§enek!", "error");
                return;
        }
        
        // Modal'Ä± kapat
        closeActivityOptionsModal();
        
    } catch (error) {
        console.error('Etkinlik seÃ§eneÄŸi uygulanÄ±rken hata:', error);
        showModernToast("SeÃ§enek uygulanamadÄ±!", "error");
    }
}

/**
 * Soru ekleme seÃ§eneÄŸini uygula
 */
function applyQuestionOption() {
    const questionCount = parseInt(document.getElementById('questionCount').value) || 3;
    const questionType = document.getElementById('questionTypeSelect').value;
    const defaultPoints = parseInt(document.getElementById('questionDefaultPoints').value) || 10;
    const weightDistribution = document.getElementById('questionWeightDistribution').value;
    const selectedOutcomes = getSelectedActivityOutcomes();
    
    const parentNode = window.currentActivityNode;
    if (!parentNode.children) {
        parentNode.children = [];
    }
    
    // Mevcut alt bileÅŸenlerin toplam aÄŸÄ±rlÄ±ÄŸÄ±nÄ± hesapla
    const existingTotalWeight = parentNode.children.reduce((sum, child) => sum + (parseFloat(child.weight) || 0), 0);
    const availableWeight = Math.max(0, 100 - existingTotalWeight);
    
    // AÄŸÄ±rlÄ±k hesaplama - mevcut bileÅŸenleri dikkate al
    let weights = [];
    if (weightDistribution === 'equal') {
        const equalWeight = Math.floor(availableWeight / questionCount);
        weights = Array(questionCount).fill(equalWeight);
        // Kalan aÄŸÄ±rlÄ±ÄŸÄ± son Ã¶ÄŸeye ekle
        const remainder = availableWeight - (equalWeight * questionCount);
        if (remainder > 0 && weights.length > 0) weights[weights.length - 1] += remainder;
    } else if (weightDistribution === 'random') {
        weights = generateRandomWeights(questionCount, availableWeight);
    } else {
        // Manuel - eÅŸit baÅŸla, kullanÄ±cÄ± sonra deÄŸiÅŸtirebilir
        const equalWeight = Math.floor(availableWeight / questionCount);
        weights = Array(questionCount).fill(equalWeight);
        const remainder = availableWeight - (equalWeight * questionCount);
        if (remainder > 0 && weights.length > 0) weights[weights.length - 1] += remainder;
    }
    
    // Puan hesaplama - aÄŸÄ±rlÄ±ÄŸa gÃ¶re otomatik daÄŸÄ±tÄ±m (varsayÄ±lan puan kullanÄ±lmaz)
    const totalActivityPoints = 100; // Her etkinlik 100 puan
    let points = weights.map(weight => Math.round((weight / 100) * totalActivityPoints));
    
    // PuanlarÄ±n toplamÄ±nÄ±n tam 100 olmasÄ±nÄ± saÄŸla
    const currentTotal = points.reduce((a, b) => a + b, 0);
    if (currentTotal !== totalActivityPoints) {
        const diff = totalActivityPoints - currentTotal;
        // FarkÄ± en bÃ¼yÃ¼k puana ekle/Ã§Ä±kar
        const maxIndex = points.indexOf(Math.max(...points));
        points[maxIndex] += diff;
        points[maxIndex] = Math.max(1, points[maxIndex]);
    }
    
    // Soru aÃ§Ä±klamasÄ±nÄ± belirle
    const questionDescriptions = {
        'Soru': 'Genel deÄŸerlendirme sorusu',
        'Ã‡oktan SeÃ§meli': 'Birden fazla ÅŸÄ±k arasÄ±ndan doÄŸru cevabÄ±n seÃ§ilmesi',
        'DoÄŸru/YanlÄ±ÅŸ': 'Ä°fadenin doÄŸru veya yanlÄ±ÅŸ olduÄŸunu belirtme',
        'KÄ±sa CevaplÄ±': 'KÄ±sa ve Ã¶z cevap gerektiren soru',
        'BoÅŸluk Doldurma': 'Metindeki boÅŸluklarÄ±n doldurulmasÄ±',
        'EÅŸleÅŸtirme': 'Birbirine uygun olan kavramlarÄ±n eÅŸleÅŸtirilmesi',
        'AÃ§Ä±k UÃ§lu': 'KapsamlÄ± ve detaylÄ± cevap gerektiren soru',
        'Problem Ã‡Ã¶zme': 'Matematiksel veya mantÄ±ksal problem Ã§Ã¶zÃ¼mÃ¼',
        'Kod Yazma': 'Belirli bir programlama dilinde kod yazma',
        'Kod Analiz': 'Verilen kodu analiz etme ve hata bulma',
        'Vaka Analizi': 'Verilen durumu analiz etme ve deÄŸerlendirme',
        'TasarÄ±m': 'ÃœrÃ¼n, sistem veya sÃ¼reÃ§ tasarÄ±mÄ± yapma',
        'GÃ¶rsel Ä°nceleme': 'Grafik, diyagram veya gÃ¶rsel analizi'
    };
    
    for (let i = 0; i < questionCount; i++) {
        const childCount = parentNode.children.length;
        const newId = `${parentNode.id}.${childCount + 1}`;
        
        const newNode = {
            id: newId,
            name: `${questionType} ${childCount + 1}`,
            type: questionType,
            weight: weights[i],
            points: points[i], // AÄŸÄ±rlÄ±ÄŸa gÃ¶re hesaplanan puan
            outcomes: selectedOutcomes.length > 0 ? selectedOutcomes : (parentNode.outcomes.length > 0 ? [parentNode.outcomes[0]] : []),
            description: questionDescriptions[questionType] || `${questionType} sorusu`,
            expanded: false
        };
        
        parentNode.children.push(newNode);
        
        // Yeni bileÅŸen iÃ§in default mapping atamasÄ±
        assignDefaultMappingToNewComponent(parentNode.id, newNode);
    }
    
    // EtkinliÄŸin toplam puanÄ±nÄ± kontrol et ve 100'e tamamla
    ensureActivityTotalPoints(parentNode);
    
    parentNode.expanded = true;
    renderTree();
    updateAssessmentView();
    
    // DÃœZELTME: Yeni sorular eklendikten sonra grup haritalamalarÄ±nÄ± gÃ¼ncelle
    updateGroupMappingsAfterNodeAdd(parentNode.id);
    
    // Ã–ÄŸrenci grup bilgilerini gÃ¼ncelle
    updateStudentGroupInfoDisplay();
    
    const outcomeText = selectedOutcomes.length > 0 ? ` (${selectedOutcomes.join(', ')} Ã–Ã‡leri ile)` : '';
    const totalWeight = weights.reduce((a,b) => a+b, 0);
    const totalPoints = points.reduce((a,b) => a+b, 0);
    showModernToast(`${questionCount} adet ${questionType} sorusu eklendi! (${totalWeight}% aÄŸÄ±rlÄ±k, ${totalPoints} puan)${outcomeText}`, "success");
}

/**
 * Rubrik ekleme seÃ§eneÄŸini uygula
 */
function applyRubricOption() {
    const rubricCount = parseInt(document.getElementById('rubricCount').value) || 2;
    const rubricType = document.getElementById('rubricTypeSelect').value;
    const defaultPoints = parseInt(document.getElementById('rubricDefaultPoints').value) || 20;
    const weightDistribution = document.getElementById('rubricWeightDistribution').value;
    const selectedOutcomes = getSelectedActivityOutcomes();
    
    const parentNode = window.currentActivityNode;
    if (!parentNode.children) {
        parentNode.children = [];
    }
    
    // Mevcut alt bileÅŸenlerin toplam aÄŸÄ±rlÄ±ÄŸÄ±nÄ± hesapla
    const existingTotalWeight = parentNode.children.reduce((sum, child) => sum + (parseFloat(child.weight) || 0), 0);
    const availableWeight = Math.max(0, 100 - existingTotalWeight);
    
    // AÄŸÄ±rlÄ±k hesaplama - mevcut bileÅŸenleri dikkate al
    let weights = [];
    if (weightDistribution === 'equal') {
        const equalWeight = Math.floor(availableWeight / rubricCount);
        weights = Array(rubricCount).fill(equalWeight);
        // Kalan aÄŸÄ±rlÄ±ÄŸÄ± son Ã¶ÄŸeye ekle
        const remainder = availableWeight - (equalWeight * rubricCount);
        if (remainder > 0 && weights.length > 0) weights[weights.length - 1] += remainder;
    } else if (weightDistribution === 'random') {
        weights = generateRandomWeights(rubricCount, availableWeight);
    } else {
        // Manuel - eÅŸit baÅŸla, kullanÄ±cÄ± sonra deÄŸiÅŸtirebilir
        const equalWeight = Math.floor(availableWeight / rubricCount);
        weights = Array(rubricCount).fill(equalWeight);
        const remainder = availableWeight - (equalWeight * rubricCount);
        if (remainder > 0 && weights.length > 0) weights[weights.length - 1] += remainder;
    }
    
    // Puan hesaplama - aÄŸÄ±rlÄ±ÄŸa gÃ¶re otomatik daÄŸÄ±tÄ±m (varsayÄ±lan puan kullanÄ±lmaz)
    const totalActivityPoints = 100; // Her etkinlik 100 puan
    let points = weights.map(weight => Math.round((weight / 100) * totalActivityPoints));
    
    // PuanlarÄ±n toplamÄ±nÄ±n tam 100 olmasÄ±nÄ± saÄŸla
    const currentTotal = points.reduce((a, b) => a + b, 0);
    if (currentTotal !== totalActivityPoints) {
        const diff = totalActivityPoints - currentTotal;
        // FarkÄ± en bÃ¼yÃ¼k puana ekle/Ã§Ä±kar
        const maxIndex = points.indexOf(Math.max(...points));
        points[maxIndex] += diff;
        points[maxIndex] = Math.max(1, points[maxIndex]);
    }
    
    // Rubrik aÃ§Ä±klamasÄ±nÄ± belirle
    const rubricDescriptions = {
        'Rubrik': 'Genel deÄŸerlendirme rubriÄŸi',
        'Proje Planlama': 'Proje planlama ve sÃ¼reÃ§ yÃ¶netimi deÄŸerlendirmesi',
        'Proje Raporu': 'Proje raporu yazÄ±mÄ± ve iÃ§erik kalitesi',
        'Proje Sunumu': 'Proje sunumu ve anlatÄ±m kalitesi',
        'Kod YapÄ±sÄ±': 'Kod organizasyonu ve mimari yapÄ±',
        'Kod Kalitesi': 'Kod kalitesi, okunabilirlik ve bakÄ±m yapÄ±labilirlik',
        'Performans': 'Kodun performans ve kaynak kullanÄ±mÄ±',
        'DokÃ¼mantasyon': 'Kod dokÃ¼mantasyonu ve yorum kalitesi',
        'Teorik Bilgi': 'Teorik bilgi ve kavramlarÄ± anlama',
        'Problem Ã‡Ã¶zme': 'Problem analizi ve Ã§Ã¶zÃ¼m yaklaÅŸÄ±mÄ±',
        'Uygulama': 'Teorik bilginin uygulamaya aktarÄ±lmasÄ±',
        'Ä°Ã§erik': 'Sunum iÃ§eriÄŸi ve bilgi doÄŸruluÄŸu',
        'GÃ¶rsel TasarÄ±m': 'Sunum gÃ¶rsel tasarÄ±mÄ± ve materyal kalitesi',
        'Sunum Becerisi': 'AnlatÄ±m becerisi ve iletiÅŸim',
        'Zaman YÃ¶netimi': 'Sunum zamanÄ±nÄ±n etkin kullanÄ±mÄ±',
        'Deney HazÄ±rlÄ±ÄŸÄ±': 'Deney Ã¶ncesi hazÄ±rlÄ±k ve planlama',
        'Deney UygulamasÄ±': 'Deney prosedÃ¼rlerinin uygulanmasÄ±',
        'Veri Analizi': 'Verilerin analizi ve deÄŸerlendirilmesi',
        'Laboratuvar Raporu': 'Laboratuvar raporu yazÄ±mÄ± ve kalitesi'
    };
    
    for (let i = 0; i < rubricCount; i++) {
        const childCount = parentNode.children.length;
        const newId = `${parentNode.id}.${childCount + 1}`;
        
        const newNode = {
            id: newId,
            name: `${rubricType} ${childCount + 1}`,
            type: rubricType,
            weight: weights[i],
            points: points[i], // AÄŸÄ±rlÄ±ÄŸa gÃ¶re hesaplanan puan
            outcomes: selectedOutcomes.length > 0 ? selectedOutcomes : (parentNode.outcomes.length > 0 ? [parentNode.outcomes[0]] : []),
            description: rubricDescriptions[rubricType] || `${rubricType} rubriÄŸi`,
            expanded: false
        };
        
        parentNode.children.push(newNode);
        
        // Yeni bileÅŸen iÃ§in default mapping atamasÄ±
        assignDefaultMappingToNewComponent(parentNode.id, newNode);
    }
    
    // EtkinliÄŸin toplam puanÄ±nÄ± kontrol et ve 100'e tamamla
    ensureActivityTotalPoints(parentNode);
    
    parentNode.expanded = true;
    renderTree();
    updateAssessmentView();
    
    // DÃœZELTME: Yeni rubrikler eklendikten sonra grup haritalamalarÄ±nÄ± gÃ¼ncelle
    updateGroupMappingsAfterNodeAdd(parentNode.id);
    
    // Ã–ÄŸrenci grup bilgilerini gÃ¼ncelle
    updateStudentGroupInfoDisplay();
    
    const outcomeText = selectedOutcomes.length > 0 ? ` (${selectedOutcomes.join(', ')} Ã–Ã‡leri ile)` : '';
    const totalWeight = weights.reduce((a,b) => a+b, 0);
    const totalPoints = points.reduce((a,b) => a+b, 0);
    showModernToast(`${rubricCount} adet ${rubricType} rubriÄŸi eklendi! (${totalWeight}% aÄŸÄ±rlÄ±k, ${totalPoints} puan)${outcomeText}`, "success");
}

/**
 * BoÅŸ bÄ±rakma seÃ§eneÄŸini uygula
 */
function applyEmptyOption() {
    // EÄŸer etkinlik henÃ¼z eklenmemiÅŸse, Ã¶nce etkinliÄŸi oluÅŸtur
    if (window.currentActivityNode === null) {
        const newNode = createNewActivity(window.currentActivityType);
        window.currentActivityNode = newNode;
        
        if (!newNode) {
            showModernToast("Etkinlik oluÅŸturulamadÄ±!", "error");
            return;
        }
    }
    
    showModernToast("Etkinlik boÅŸ bÄ±rakÄ±ldÄ±. Daha sonra manuel olarak soru/rubrik ekleyebilirsiniz.", "info");
}

/**
 * Rastgele aÄŸÄ±rlÄ±k daÄŸÄ±lÄ±mÄ± oluÅŸtur
 * @param {number} count - Ã–ÄŸe sayÄ±sÄ±
 * @param {number} totalWeight - Toplam aÄŸÄ±rlÄ±k (varsayÄ±lan: 100)
 * @returns {Array} - AÄŸÄ±rlÄ±k dizisi (toplamÄ± totalWeight)
 */
function generateRandomWeights(count, totalWeight = 100) {
    if (count === 1) return [totalWeight];
    
    // Rastgele sayÄ±lar Ã¼ret
    let weights = [];
    for (let i = 0; i < count - 1; i++) {
        weights.push(Math.random());
    }
    
    // SÄ±rala
    weights.sort((a, b) => a - b);
    
    // AralÄ±klara Ã§evir
    let intervals = [];
    intervals.push(weights[0]);
    for (let i = 1; i < weights.length; i++) {
        intervals.push(weights[i] - weights[i-1]);
    }
    intervals.push(1 - weights[weights.length - 1]);
    
    // totalWeight'e Ã§evir ve yuvarla
    let result = intervals.map(w => Math.max(1, Math.round(w * totalWeight)));
    
    // ToplamÄ± totalWeight yap
    let total = result.reduce((a, b) => a + b, 0);
    if (total !== totalWeight) {
        let diff = totalWeight - total;
        // FarkÄ± en bÃ¼yÃ¼k deÄŸere ekle/Ã§Ä±kar
        let maxIndex = result.indexOf(Math.max(...result));
        result[maxIndex] += diff;
        result[maxIndex] = Math.max(1, result[maxIndex]);
    }
    
    return result;
}

/**
 * EtkinliÄŸin toplam puanÄ±nÄ±n 100 olmasÄ±nÄ± saÄŸla
 * @param {Object} parentNode - Etkinlik dÃ¼ÄŸÃ¼mÃ¼
 */
function ensureActivityTotalPoints(parentNode) {
    if (!parentNode || !parentNode.children || parentNode.children.length === 0) return;
    
    const totalPoints = parentNode.children.reduce((sum, child) => sum + (parseFloat(child.points) || 0), 0);
    const targetPoints = 100;
    
    if (totalPoints !== targetPoints && totalPoints > 0) {
        const diff = targetPoints - totalPoints;
        
        // FarkÄ± en bÃ¼yÃ¼k puana sahip Ã¶ÄŸeye ekle/Ã§Ä±kar
        let maxPointsIndex = 0;
        let maxPoints = parseFloat(parentNode.children[0].points) || 0;
        
        for (let i = 1; i < parentNode.children.length; i++) {
            const currentPoints = parseFloat(parentNode.children[i].points) || 0;
            if (currentPoints > maxPoints) {
                maxPoints = currentPoints;
                maxPointsIndex = i;
            }
        }
        
        // PuanÄ± gÃ¼ncelle
        parentNode.children[maxPointsIndex].points = Math.max(1, maxPoints + diff);
        
        console.log(`ğŸ¯ Etkinlik ${parentNode.id} puan toplamÄ± ${totalPoints} -> ${targetPoints} olarak ayarlandÄ±`);
    }
}

/**
 * Etkinlik seÃ§enek modalÄ±nÄ± kapat
 */
function closeActivityOptionsModal() {
    const modal = document.getElementById('activityOptionsModal');
    if (modal) {
        modal.classList.remove('active');
        modal.style.display = 'none';
        
        // Temizle
        window.currentActivityNode = null;
        window.currentActivityType = null;
        
        // Ã–Ã‡ seÃ§imlerini temizle
        clearAllActivityOutcomes();
        
        // SeÃ§ili kartlarÄ± temizle
        modal.querySelectorAll('.activity-option-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        // Apply butonunu deaktif et
        const applyBtn = document.getElementById('applyActivityOptions');
        if (applyBtn) {
            applyBtn.disabled = true;
        }
    }
}

/**
 * Count selector butonlarÄ± iÃ§in event handler
 */
function updateCountValue(target, delta) {
    const input = document.getElementById(target);
    if (!input) return;
    
    const currentValue = parseInt(input.value) || 0;
    const newValue = Math.max(1, Math.min(50, currentValue + delta));
    input.value = newValue;
}

// Global fonksiyonlar
window.showActivityOptionsModal = showActivityOptionsModal;
window.selectActivityOption = selectActivityOption;
window.applyActivityOptions = applyActivityOptions;
window.closeActivityOptionsModal = closeActivityOptionsModal;
window.updateCountValue = updateCountValue;

// =====================================================
// ID YÃ–NETÄ°MÄ° SÄ°STEMÄ°
// =====================================================

/**
 * SÄ±ralÄ± ID Ã¼retimi
 * @param {Object} parentNode - Ãœst dÃ¼ÄŸÃ¼m
 * @returns {string} - SÄ±ralÄ± ID
 */
function generateSequentialId(parentNode) {
    if (!parentNode || !parentNode.children) {
        return parentNode ? `${parentNode.id}.1` : '1';
    }
    
    // Mevcut ID'leri al ve sÄ±rayla dÃ¼zenle
    const childIds = parentNode.children.map(child => {
        const parts = child.id.split('.');
        return parseInt(parts[parts.length - 1]) || 0;
    });
    
    // En bÃ¼yÃ¼k ID'yi bul ve 1 ekle
    const maxId = childIds.length > 0 ? Math.max(...childIds) : 0;
    return `${parentNode.id}.${maxId + 1}`;
}

/**
 * TÃ¼m ID'leri yeniden dÃ¼zenle
 * @param {Object} parentNode - Ãœst dÃ¼ÄŸÃ¼m
 */
function reorderAllIds(parentNode) {
    if (!parentNode || !parentNode.children) return;
    
    const idMigrationMap = {}; // ID deÄŸiÅŸikliklerini takip et
    
    parentNode.children.forEach((child, index) => {
        const oldId = child.id;
        const newId = `${parentNode.id}.${index + 1}`;
        
        if (oldId !== newId) {
            // ID deÄŸiÅŸikliÄŸini kaydet
            idMigrationMap[oldId] = newId;
            
            // Grup haritalamalarÄ±nÄ± gÃ¼ncelle
            updateGroupMappingForId(oldId, newId);
            
            // ID'yi gÃ¼ncelle
            child.id = newId;
            
            // Alt dÃ¼ÄŸÃ¼mleri de gÃ¼ncelle
            if (child.children && child.children.length > 0) {
                reorderAllIds(child);
            }
        }
    });
    
    // Basit not migrasyonu (GUID olmadan)
    if (Object.keys(idMigrationMap).length > 0) {
        migrateGradesData(idMigrationMap);
    }
}

/**
 * Basit not migrasyonu (GUID olmadan)
 */
function migrateGradesData(idMigrationMap) {
    if (!APP_STATE.gradesData || Object.keys(idMigrationMap).length === 0) return;
    
    console.log('ğŸ”„ Basit not migrasyon baÅŸlatÄ±lÄ±yor...', idMigrationMap);
    
    Object.keys(APP_STATE.gradesData).forEach(studentId => {
        const studentGrades = APP_STATE.gradesData[studentId];
        if (!studentGrades || typeof studentGrades !== 'object') return;
        
        // Her ID deÄŸiÅŸikliÄŸi iÃ§in
        Object.entries(idMigrationMap).forEach(([oldId, newId]) => {
            if (studentGrades.hasOwnProperty(oldId)) {
                const gradeValue = studentGrades[oldId];
                
                // Yeni ID ile sakla
                studentGrades[newId] = gradeValue;
                
                // Eski ID'yi sil
                delete studentGrades[oldId];
                
                console.log(`âœ… Not Migrasyon: ${studentId} - ${oldId} -> ${newId}`);
            }
        });
    });
    
    console.log('âœ… Basit not migrasyon tamamlandÄ±!');
}

/**
 * Grup haritalamalarÄ±nda ID referanslarÄ±nÄ± gÃ¼ncelle
 * @param {string} oldId - Eski ID
 * @param {string} newId - Yeni ID
 */
function updateGroupMappingForId(oldId, newId) {
    if (!APP_STATE.courseData || !APP_STATE.courseData.grupHaritalari) return;
    
    Object.keys(APP_STATE.courseData.grupHaritalari).forEach(groupName => {
        const activities = APP_STATE.courseData.grupHaritalari[groupName];
        
        Object.keys(activities).forEach(activityId => {
            const questionList = activities[activityId];
            
            // Eski ID'yi yeni ID ile deÄŸiÅŸtir
            const index = questionList.indexOf(oldId);
            if (index !== -1) {
                questionList[index] = newId;
            }
        });
    });
}

/**
 * Ã–ÄŸeyi yukarÄ± taÅŸÄ±
 * @param {Object} node - TaÅŸÄ±nacak dÃ¼ÄŸÃ¼m
 */
function moveItemUp(node) {
    const parent = findParentNode(node.id);
    if (!parent || !parent.children) return;
    
    const index = parent.children.findIndex(child => child.id === node.id);
    if (index <= 0) return; // Zaten en Ã¼stte
    
    // Ã–ÄŸeleri yer deÄŸiÅŸtir
    [parent.children[index - 1], parent.children[index]] = 
    [parent.children[index], parent.children[index - 1]];
    
    // ID'leri yeniden dÃ¼zenle
    reorderAllIds(parent);
    
    // GÃ¶rÃ¼nÃ¼mÃ¼ gÃ¼ncelle
    renderTree();
    updateAssessmentView();
    
    showModernToast(`"${node.name}" yukarÄ± taÅŸÄ±ndÄ±.`, "success");
}

/**
 * Ã–ÄŸeyi aÅŸaÄŸÄ± taÅŸÄ±
 * @param {Object} node - TaÅŸÄ±nacak dÃ¼ÄŸÃ¼m
 */
function moveItemDown(node) {
    const parent = findParentNode(node.id);
    if (!parent || !parent.children) return;
    
    const index = parent.children.findIndex(child => child.id === node.id);
    if (index >= parent.children.length - 1) return; // Zaten en altta
    
    // Ã–ÄŸeleri yer deÄŸiÅŸtir
    [parent.children[index], parent.children[index + 1]] = 
    [parent.children[index + 1], parent.children[index]];
    
    // ID'leri yeniden dÃ¼zenle
    reorderAllIds(parent);
    
    // GÃ¶rÃ¼nÃ¼mÃ¼ gÃ¼ncelle
    renderTree();
    updateAssessmentView();
    
    showModernToast(`"${node.name}" aÅŸaÄŸÄ± taÅŸÄ±ndÄ±.`, "success");
}

/**
 * Ãœst dÃ¼ÄŸÃ¼mÃ¼ bulma
 * @param {string} nodeId - DÃ¼ÄŸÃ¼m ID'si
 * @returns {Object|null} - Ãœst dÃ¼ÄŸÃ¼m
 */
function findParentNode(nodeId) {
    const searchInTree = (nodes, targetId) => {
        for (const node of nodes) {
            if (node.children) {
                for (const child of node.children) {
                    if (child.id === targetId) {
                        return node;
                    }
                }
                const found = searchInTree(node.children, targetId);
                if (found) return found;
            }
        }
        return null;
    };
    
    return searchInTree(APP_STATE.assessmentTree, nodeId);
}

// =====================================================
// YARDIMCI FONKSIYONLAR
// =====================================================

/**
 * ID'ye gÃ¶re dÃ¼ÄŸÃ¼m bulma
 * @param {string} id - Aranacak dÃ¼ÄŸÃ¼m ID'si
 * @returns {Object|null} - Bulunan dÃ¼ÄŸÃ¼m veya null
 */
function findNodeById(id) {
    // YardÄ±mcÄ± iÃ§ fonksiyon
    const searchNode = (node) => {
        if (node.id === id) return node;
        
        if (node.children && node.children.length > 0) {
            for (const child of node.children) {
                const found = searchNode(child);
                if (found) return found;
            }
        }
        
        return null;
    };
    
    // TÃ¼m aÄŸaÃ§ta ara
    for (const rootNode of APP_STATE.assessmentTree) {
        const found = searchNode(rootNode);
        if (found) return found;
    }
    
    return null;
}

/**
 * Harf notunu hesaplama
 * @param {number} totalGrade - Toplam not
 * @returns {string} - Harf notu
 */
function getLetterGrade(totalGrade) {
    if (totalGrade >= 90) return 'AA';
    if (totalGrade >= 85) return 'BA';
    if (totalGrade >= 80) return 'BB';
    if (totalGrade >= 75) return 'CB';
    if (totalGrade >= 70) return 'CC';
    if (totalGrade >= 60) return 'DC';
    if (totalGrade >= 50) return 'DD';
    if (totalGrade >= 40) return 'FD';
    return 'FF';
}

/**
 * Rastgele Ã¶ÄŸrenme Ã§Ä±ktÄ±larÄ± alma
 * @param {number} count - Ä°stenilen Ã§Ä±ktÄ± sayÄ±sÄ±
 * @returns {Array} - Rastgele Ã¶ÄŸrenme Ã§Ä±ktÄ±larÄ± ID'leri
 */
function getRandomOutcomes(count) {
    if (!APP_STATE.learningOutcomes || APP_STATE.learningOutcomes.length === 0) {
        return [];
    }
    
    // Ã–ÄŸrenme Ã§Ä±ktÄ±larÄ±ndan rastgele seÃ§
    const outcomes = [];
    const availableOutcomes = [...APP_STATE.learningOutcomes];
    
    for (let i = 0; i < Math.min(count, availableOutcomes.length); i++) {
        const randomIndex = Math.floor(Math.random() * availableOutcomes.length);
        outcomes.push(availableOutcomes[randomIndex].id);
        availableOutcomes.splice(randomIndex, 1);
    }
    
    return outcomes;
}

/**
 * AkÄ±llÄ± Ã¶ÄŸrenme Ã§Ä±ktÄ±larÄ± seÃ§me - JSON yÃ¼klendiÄŸinde kullanÄ±lÄ±r
 * @param {number} count - SeÃ§ilecek Ã¶ÄŸrenme Ã§Ä±ktÄ±sÄ± sayÄ±sÄ±
 * @returns {Array} - SeÃ§ilen Ã¶ÄŸrenme Ã§Ä±ktÄ±larÄ±
 */
function getSmartOutcomes(count) {
    if (!APP_STATE.learningOutcomes || APP_STATE.learningOutcomes.length === 0) {
        return [];
    }
    
    // Ã–ÄŸrenme Ã§Ä±ktÄ±larÄ±ndan akÄ±llÄ±ca seÃ§
    const outcomes = [];
    const availableOutcomes = [...APP_STATE.learningOutcomes];
    
    for (let i = 0; i < Math.min(count, availableOutcomes.length); i++) {
        const randomIndex = Math.floor(Math.random() * availableOutcomes.length);
        outcomes.push(availableOutcomes[randomIndex].id);
        availableOutcomes.splice(randomIndex, 1);
    }
    
    return outcomes;
}

/**
 * Alt dÃ¼ÄŸÃ¼mlerin Ã¶ÄŸrenme Ã§Ä±ktÄ±larÄ±nÄ± toplama
 * @param {Array} children - Alt dÃ¼ÄŸÃ¼mler
 * @param {Set} outcomeSet - Ã–ÄŸrenme Ã§Ä±ktÄ±larÄ± set'i
 */
function collectChildOutcomes(children, outcomeSet) {
    children.forEach(child => {
        if (child.outcomes && child.outcomes.length) {
            child.outcomes.forEach(outcome => outcomeSet.add(outcome));
        }
        
        if (child.children && child.children.length > 0) {
            collectChildOutcomes(child.children, outcomeSet);
        }
    });
}

/**
 * SeÃ§ili sekmeyi deÄŸiÅŸtirme
 * @param {string} tabId - Sekme ID'si
 */
// Ä°lk switchTab fonksiyonu silindi - Ã§akÄ±ÅŸmayÄ± Ã¶nlemek iÃ§in (daha kapsamlÄ± versiyon var)

// Ä°lk modal fonksiyonlarÄ± silindi - Ã§akÄ±ÅŸmayÄ± Ã¶nlemek iÃ§in (daha kapsamlÄ± versiyonlar var)

// =====================================================
// AÄAÃ‡ VE DEÄERLENDÄ°RME FONKSÄ°YONLARI
// =====================================================

/**
 * DÃ¼ÄŸÃ¼m seÃ§me
 * @param {Object} node - SeÃ§ilecek dÃ¼ÄŸÃ¼m
 */
function selectNode(node) {
    APP_STATE.selectedNode = node;
    renderTree();
}

/**
 * YarÄ±yÄ±l iÃ§i etkinlik ekleme
 */
function addTermActivity() {
    try {
        // Ã–nce modal gÃ¶ster - etkinlik henÃ¼z eklenmedi
        showActivityOptionsModal('term', null);
		
    } catch (error) {
        console.error("YarÄ±yÄ±l iÃ§i etkinlik modalÄ± aÃ§Ä±lÄ±rken hata oluÅŸtu:", error);
        showModernToast("Modal aÃ§Ä±lamadÄ±!", "error");
    }
}

/**
 * YarÄ±yÄ±l sonu etkinlik ekleme
 */
function addFinalActivity() {
    try {
        // Ã–nce modal gÃ¶ster - etkinlik henÃ¼z eklenmedi
        showActivityOptionsModal('final', null);
		
    } catch (error) {
        console.error("YarÄ±yÄ±l sonu etkinlik modalÄ± aÃ§Ä±lÄ±rken hata oluÅŸtu:", error);
        showModernToast("Modal aÃ§Ä±lamadÄ±!", "error");
    }
}

/**
 * DÃ¼ÄŸÃ¼me soru ekleme
 * @param {Object} parentNode - Ãœst dÃ¼ÄŸÃ¼m
 * @param {string} questionType - Soru tipi
 * @param {string} description - AÃ§Ä±klama
 */
// Ä°lk addQuestionToNode fonksiyonu silindi - Ã§akÄ±ÅŸmayÄ± Ã¶nlemek iÃ§in

/**
 * DÃ¼ÄŸÃ¼me test ekleme (toplu Ã§oktan seÃ§meli sorular)
 * @param {Object} parentNode - Ãœst dÃ¼ÄŸÃ¼m
 */
function addTestToNode(parentNode) {
    if (!parentNode) return;
    
    try {
        if (!parentNode.children) {
            parentNode.children = [];
        }
        
        const childCount = parentNode.children.length;
        const newId = `${parentNode.id}.${childCount + 1}`;
        
        // Ã–ÄŸrenme Ã§Ä±ktÄ±larÄ± varsa ilk Ã¶ÄŸrenme Ã§Ä±ktÄ±sÄ±nÄ± atayalÄ±m
        const outcome = parentNode.outcomes.length > 0 ? [parentNode.outcomes[0]] : [];
        
        const newNode = {
            id: newId,
            name: "Test SorularÄ±",
            type: "Test",
            weight: 20, // VarsayÄ±lan aÄŸÄ±rlÄ±k
            points: 100, // VarsayÄ±lan toplam puan
            outcomes: outcome,
            description: "Ã‡oktan seÃ§meli test sorularÄ±",
            expanded: true,
            children: [],
            testDetails: {
                totalQuestions: 20,
                correctWeight: 5,
                wrongPenalty: 0
            }
        };
        
        parentNode.children.push(newNode);
        parentNode.expanded = true;
        selectNode(newNode);
        renderTree();
        
        // DeÄŸerlendirme sekmesini gÃ¼ncelle
        updateAssessmentView();
        
        // Test detaylarÄ± iÃ§in modal gÃ¶ster
        APP_STATE.testDetailsNode = newNode;
        showTestDetailsModal();
        
        showModernToast("Test sorularÄ± eklendi.");
    } catch (error) {
        console.error("Test eklenirken hata oluÅŸtu:", error);
        showModernToast("Test eklenemedi!", "error");
    }
}

// Ä°lk test modal fonksiyonlarÄ± silindi - Ã§akÄ±ÅŸmayÄ± Ã¶nlemek iÃ§in

/**
 * DÃ¼ÄŸÃ¼me rubrik ekleme
 * @param {Object} parentNode - Ãœst dÃ¼ÄŸÃ¼m
 * @param {string} rubricType - Rubrik tipi
 * @param {string} description - AÃ§Ä±klama
 */
// Ä°lk addRubricToNode fonksiyonu silindi - Ã§akÄ±ÅŸmayÄ± Ã¶nlemek iÃ§in

/**
 * Soru ekleme fonksiyonu
 * Bir etkinliÄŸe soru eklemek iÃ§in kullanÄ±lÄ±r
 */
function addQuestion() {
    if (!APP_STATE.selectedNode) {
        showModernToast("LÃ¼tfen Ã¶nce bir etkinlik seÃ§in.", "warning");
        return;
    }
    
    // SeÃ§ili dÃ¼ÄŸÃ¼m kÃ¶k deÄŸilse alt dÃ¼ÄŸÃ¼m eklenmemeli
    if (APP_STATE.selectedNode.id.includes('.')) {
        showModernToast("Sorular sadece ana etkinliklere eklenebilir.", "warning");
        return;
    }
    
    // Ã‡oklu soru eklemek iÃ§in modal gÃ¶ster
    // Bu satÄ±rÄ± yorum haline getirip doÄŸrudan ekleme de yapabilirsiniz
    showMultipleItemsModal('soru');
    
    /* 
    // Tek soru eklemek iÃ§in bu kÄ±smÄ± kullanabilirsiniz
    addQuestionToNode(APP_STATE.selectedNode);
    */
}

/**
 * Rubrik ekleme fonksiyonu
 * Bir etkinliÄŸe rubrik eklemek iÃ§in kullanÄ±lÄ±r
 */
function addRubric() {
    if (!APP_STATE.selectedNode) {
        showModernToast("LÃ¼tfen Ã¶nce bir etkinlik seÃ§in.", "warning");
        return;
    }
    
    // SeÃ§ili dÃ¼ÄŸÃ¼m kÃ¶k deÄŸilse alt dÃ¼ÄŸÃ¼m eklenmemeli
    if (APP_STATE.selectedNode.id.includes('.')) {
        showModernToast("Rubrikler sadece ana etkinliklere eklenebilir.", "warning");
        return;
    }
    
    // Ã‡oklu rubrik eklemek iÃ§in modal gÃ¶ster
    showMultipleItemsModal('rubrik');
    
    /* 
    // Tek rubrik eklemek iÃ§in bu kÄ±smÄ± kullanabilirsiniz
    addRubricToNode(APP_STATE.selectedNode);
    */
}

/**
 * DÃ¼ÄŸÃ¼m silme
 */
function removeNode() {
    if (!APP_STATE.selectedNode) {
        showModernToast("LÃ¼tfen Ã¶nce bir etkinlik seÃ§in.", "warning");
        return;
    }
    
    showDeleteConfirmModal(
        function() {
            try {
                // KÃ¶k dÃ¼ÄŸÃ¼m mÃ¼ kontrol et
                const isRoot = !APP_STATE.selectedNode.id.includes('.');
                
                if (isRoot) {
                    // KÃ¶k dÃ¼ÄŸÃ¼mÃ¼ sil
                    const index = APP_STATE.assessmentTree.findIndex(node => node.id === APP_STATE.selectedNode.id);
                    if (index !== -1) {
                        APP_STATE.assessmentTree.splice(index, 1);
                    }
                } else {
                    // Alt dÃ¼ÄŸÃ¼mÃ¼ sil
                    const parentId = APP_STATE.selectedNode.id.substring(0, APP_STATE.selectedNode.id.lastIndexOf('.'));
                    const findParentAndRemoveChild = (nodes, id) => {
                        for (let i = 0; i < nodes.length; i++) {
                            const node = nodes[i];
                            if (node.id === parentId && node.children) {
                                const childIndex = node.children.findIndex(child => child.id === id);
                                if (childIndex !== -1) {
                                    node.children.splice(childIndex, 1);
                                    return true;
                                }
                            }
                            
                            if (node.children && node.children.length > 0) {
                                if (findParentAndRemoveChild(node.children, id)) {
                                    return true;
                                }
                            }
                        }
                        return false;
                    };
                    
                    findParentAndRemoveChild(APP_STATE.assessmentTree, APP_STATE.selectedNode.id);
                }
                
                APP_STATE.selectedNode = null;
                renderTree();
                
                // DeÄŸerlendirme sekmesini gÃ¼ncelle
                updateAssessmentView();
                
                showModernToast("Etkinlik baÅŸarÄ±yla silindi.");
            } catch (error) {
                console.error("DÃ¼ÄŸÃ¼m silinirken hata oluÅŸtu:", error);
                showModernToast("Etkinlik silinemedi!", "error");
            }
        },
        `"${APP_STATE.selectedNode.name}" etkinliÄŸini ve tÃ¼m alt Ã¶ÄŸelerini silmek istediÄŸinizden emin misiniz?`
    );
}

/**
 * TÃ¼m dÃ¼ÄŸÃ¼mleri geniÅŸlet
 */
function expandAll() {
    const expandNodes = (nodes) => {
        nodes.forEach(node => {
            node.expanded = true;
            if (node.children && node.children.length > 0) {
                expandNodes(node.children);
            }
        });
    };
    
    expandNodes(APP_STATE.assessmentTree);
    renderTree();
    showModernToast("TÃ¼m etkinlikler geniÅŸletildi.");
}

/**
 * TÃ¼m dÃ¼ÄŸÃ¼mleri daralt
 */
function collapseAll() {
    const collapseNodes = (nodes) => {
        nodes.forEach(node => {
            node.expanded = false;
            if (node.children && node.children.length > 0) {
                collapseNodes(node.children);
            }
        });
    };
    
    collapseNodes(APP_STATE.assessmentTree);
    renderTree();
    showModernToast("TÃ¼m etkinlikler daraltÄ±ldÄ±.");
}

/**
 * Ã–ÄŸrenme Ã§Ä±ktÄ±larÄ±nÄ± gÃ¼ncelleme
 * @param {Object} node - GÃ¼ncellenecek dÃ¼ÄŸÃ¼m
 * @param {HTMLInputElement} outcomesInput - Ã‡Ä±ktÄ±lar input elementi
 */
function updateOutcomes(node, outcomesInput) {
    try {
        const inputValue = outcomesInput.value.trim();
        
        // Alt dÃ¼ÄŸÃ¼m ise (soru veya rubrik), sadece bir Ã–Ã‡ atanabilsin
        const isSubItem = node.id.includes('.');
        
        if (isSubItem) {
            const outcomes = inputValue.split(',').map(s => s.trim()).filter(s => s);
            
            if (outcomes.length > 1) {
                showModernToast("Soru veya Rubrik sadece bir Ã–ÄŸrenme Ã‡Ä±ktÄ±sÄ±na atanabilir!", "warning");
                // Ä°lk Ã¶ÄŸrenme Ã§Ä±ktÄ±sÄ±nÄ± al
                node.outcomes = outcomes.slice(0, 1);
                outcomesInput.value = Array.isArray(node.outcomes) ? node.outcomes.join(',') : '';
            } else {
                node.outcomes = outcomes;
            }
        } else {
            // Ana etkinlik iÃ§in birden Ã§ok Ã–Ã‡ atanabilir
            node.outcomes = inputValue.split(',').map(s => s.trim()).filter(s => s);
        }
        
        // outcomes'Ä±n her zaman array olduÄŸundan emin ol
        if (!Array.isArray(node.outcomes)) {
            node.outcomes = [];
        }
        
        // Alt dÃ¼ÄŸÃ¼mlerin Ã¶ÄŸrenme Ã§Ä±ktÄ±larÄ±nÄ± ana dÃ¼ÄŸÃ¼me kopyala
        if (!isSubItem && node.children && node.children.length > 0) {
            const childOutcomes = new Set();
            collectChildOutcomes(node.children, childOutcomes);
            
            // EÄŸer childOutcomes boÅŸ deÄŸilse, ana dÃ¼ÄŸÃ¼mÃ¼n outcomes'Ä±nÄ± gÃ¼ncelle
            if (childOutcomes.size > 0) {
                node.outcomes = Array.from(childOutcomes);
                outcomesInput.value = Array.isArray(node.outcomes) ? node.outcomes.join(',') : '';
            }
        }
        
        // Ã–Ã‡ deÄŸiÅŸikliÄŸi olduÄŸunda deÄŸerlendirme sekmesini gÃ¼ncelle
        setTimeout(() => {
            updateAssessmentView();
        }, 100);
    } catch (error) {
        console.error("Ã–ÄŸrenme Ã§Ä±ktÄ±larÄ± gÃ¼ncellenirken hata oluÅŸtu:", error);
        showModernToast("Ã–ÄŸrenme Ã§Ä±ktÄ±larÄ± gÃ¼ncellenemedi!", "error");
        
        // Hata durumunda gÃ¼venli deÄŸer ata
        node.outcomes = [];
        outcomesInput.value = '';
    }
}

/**
 * Kategori aÄŸÄ±rlÄ±klarÄ±nÄ± gÃ¼ncelleme
 */
/**
 * Kategori aÄŸÄ±rlÄ±klarÄ±nÄ± gÃ¼ncelleme
 */
function updateCategoryWeights() {
    try {
        // YarÄ±yÄ±l iÃ§i ve yarÄ±yÄ±l sonu etkinlikleri ayÄ±r
        const termActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('A'));
        const finalActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('F'));
        
        // Her kategori iÃ§inde toplam aÄŸÄ±rlÄ±klarÄ± hesapla
        const termInternalTotal = termActivities.reduce((sum, node) => sum + parseFloat(node.weight || 0), 0);
        const finalInternalTotal = finalActivities.reduce((sum, node) => sum + parseFloat(node.weight || 0), 0);
        
        // Sabit tanÄ±mlÄ± genel deÄŸerlendirme aÄŸÄ±rlÄ±klarÄ± - JSON'dan geliyor, deÄŸiÅŸmez
        const termContribution = APP_STATE.courseData?.dersDegerlendirme?.genelDegerlendirme?.find(
            item => item.degerlendirme.includes("Ä°Ã§i"))?.katkiYuzdesi || 40;
        const finalContribution = APP_STATE.courseData?.dersDegerlendirme?.genelDegerlendirme?.find(
            item => item.degerlendirme.includes("Sonu"))?.katkiYuzdesi || 60;
        
        // Genel aÄŸÄ±rlÄ±klarÄ± kaydet
        APP_STATE.termWeight = termContribution;  
        APP_STATE.finalWeight = finalContribution;
        
        // Bu deÄŸerler deÄŸiÅŸmez - sabit kalmalÄ±
        document.getElementById('termGeneralWeight').textContent = termContribution;
        document.getElementById('finalGeneralWeight').textContent = finalContribution;
        
        // Ä°Ã§ aÄŸÄ±rlÄ±k toplamlarÄ± gÃ¼ncellenir
        document.getElementById('termInternalTotal').textContent = termInternalTotal;
        document.getElementById('finalInternalTotal').textContent = finalInternalTotal;
        
        // Ä°Ã§ toplamlar 100% deÄŸilse uyarÄ± rengiyle gÃ¶ster
        if (termInternalTotal !== 100) {
            document.getElementById('termInternalTotal').style.color = 'var(--danger-color)';
        } else {
            document.getElementById('termInternalTotal').style.color = '';
        }
        
        if (finalInternalTotal !== 100) {
            document.getElementById('finalInternalTotal').style.color = 'var(--danger-color)';
        } else {
            document.getElementById('finalInternalTotal').style.color = '';
        }
        
        // Progress barlarÄ± sadece gÃ¶sterim amaÃ§lÄ±
        termProgress.style.width = `${termInternalTotal}%`;
        finalProgress.style.width = `${finalInternalTotal}%`;
        
        // DetaylÄ± bilgilendirme etiketlerini gÃ¼ncelle
        updateCategoryDetails(termActivities, 'termDetails');
        updateCategoryDetails(finalActivities, 'finalDetails');
        
        // Course Data'yÄ± gÃ¼ncelle
        if (APP_STATE.courseData && APP_STATE.courseData.dersDegerlendirme) {
            // YarÄ±yÄ±l iÃ§i etkinliklerini gÃ¼ncelle
            APP_STATE.courseData.dersDegerlendirme.yariyilIciEtkinlikleri = termActivities.map(node => ({
                "etkinlik": node.type,
                "sayi": 1,
                "katkiYuzdesi": node.weight,
                "id": node.id
            }));
            
            // YarÄ±yÄ±l sonu etkinliklerini gÃ¼ncelle
            APP_STATE.courseData.dersDegerlendirme.yariyilSonuEtkinlikleri = finalActivities.map(node => ({
                "etkinlik": node.type,
                "sayi": 1,
                "katkiYuzdesi": node.weight,
                "id": node.id
            }));
            
            // ToplamlarÄ± gÃ¼ncelle
            APP_STATE.courseData.dersDegerlendirme.yariyilIciToplam = termInternalTotal;
            APP_STATE.courseData.dersDegerlendirme.yariyilSonuToplam = finalInternalTotal;
            // Genel deÄŸerlendirme deÄŸiÅŸmez (40-60)
        }
    } catch (error) {
        console.error("Kategori aÄŸÄ±rlÄ±klarÄ± gÃ¼ncellenirken hata oluÅŸtu:", error);
    }
}

/**
 * Kategori detaylarÄ±nÄ± gÃ¼ncelle (bilgilendirme etiketleri)
 * @param {Array} activities - Etkinlikler listesi
 * @param {string} containerId - Detay container ID'si
 */
function updateCategoryDetails(activities, containerId) {
    try {
        const container = document.getElementById(containerId);
        if (!container) return;
        
        // Container'Ä± temizle
        container.innerHTML = '';
        
        if (!activities || activities.length === 0) {
            // BoÅŸ durum etiketi
            const emptyTag = document.createElement('span');
            emptyTag.className = 'detail-tag empty-tag';
            emptyTag.innerHTML = '<span class="tag-icon">ğŸ“­</span> HenÃ¼z etkinlik eklenmedi';
            container.appendChild(emptyTag);
            return;
        }
        
        // Kompakt etiket sistemi - sadece etkinlikler
        activities.forEach((activity) => {
            // Bu etkinliÄŸin soru ve rubrik sayÄ±larÄ±nÄ± hesapla
            let activityQuestions = 0;
            let activityRubrics = 0;
            
            if (activity.children && activity.children.length > 0) {
                activity.children.forEach(child => {
                    if (child.type === 'Soru' || child.type.includes('Soru') || isQuestionType(child.type) || child.type === 'Test') {
                        activityQuestions++;
                    } else if (child.type === 'Rubrik' || child.type.includes('Rubrik') || isRubricType(child.type)) {
                        activityRubrics++;
                    }
                });
            }
            
            // Ä°kon seÃ§imi
            const getActivityIcon = (type) => {
                if (type.includes('SÄ±nav')) return 'ğŸ“';
                if (type.includes('Quiz')) return 'â“';
                if (type.includes('Proje')) return 'ğŸš€';
                if (type.includes('Rapor')) return 'ğŸ“Š';
                if (type.includes('Deney')) return 'ğŸ§ª';
                if (type.includes('Laboratuvar')) return 'âš—ï¸';
                if (type.includes('Sunum')) return 'ğŸ¤';
                if (type.includes('Seminer')) return 'ğŸ“';
                return 'ğŸ“š';
            };
            
            // Etkinlik adÄ±nÄ± kÄ±salt
            const activityName = activity.name || activity.type || `Etkinlik ${activity.id}`;
            const shortName = activityName.length > 15 ? activityName.substring(0, 15) + '...' : activityName;
            
            // Tek kompakt etiket oluÅŸtur - tÃ¼m bilgiler bir arada
            const activityTag = document.createElement('span');
            activityTag.className = 'detail-tag activity-single-tag';
            
            // Grup bilgisini al
            const getGroupInfo = (activityId) => {
                if (APP_STATE.courseData && APP_STATE.courseData.grupHaritalari && APP_STATE.courseData.grupHaritalari[activityId]) {
                    const component = APP_STATE.courseData.grupHaritalari[activityId];
                    if (component.gruplar && Array.isArray(component.gruplar)) {
                        const validGroups = component.gruplar.filter(group => 
                            group && group.length === 1 && /^[A-Z]$/.test(group)
                        );
                        if (validGroups.length > 0) {
                            const groupCount = validGroups.length;
                            return ` [${groupCount} Grup]`;
                        }
                    }
                }
                return ' [1 Grup]'; // VarsayÄ±lan grup
            };
            
            // TÃ¼m bilgileri tek satÄ±rda topla
            let fullInfo = `${getActivityIcon(activity.type)} ${shortName} %${activity.weight || 0}`;
            
            // Soru ve rubrik bilgilerini ekle
            if (activityQuestions > 0 && activityRubrics > 0) {
                fullInfo += ` (${activityQuestions} Soru, ${activityRubrics} Rubrik)`;
            } else if (activityQuestions > 0) {
                fullInfo += ` (${activityQuestions} Soru)`;
            } else if (activityRubrics > 0) {
                fullInfo += ` (${activityRubrics} Rubrik)`;
            } else {
                fullInfo += ` (BoÅŸ)`;
            }
            
            // Grup bilgisini ekle
            fullInfo += getGroupInfo(activity.id);
            
            activityTag.innerHTML = fullInfo;
            activityTag.title = `${activityName}\nAÄŸÄ±rlÄ±k: %${activity.weight || 0}\n${activityQuestions} Soru, ${activityRubrics} Rubrik\n${getGroupInfo(activity.id).replace(/[\[\]]/g, '')}`;
            
            container.appendChild(activityTag);
        });
        
    } catch (error) {
        console.error("Kategori detaylarÄ± gÃ¼ncellenirken hata:", error);
    }
}

// =====================================================
// RENDER VE UI GÃœNCELLEME FONKSIYONLARI
// =====================================================

/**
 * DÃ¼ÄŸÃ¼m render etme fonksiyonunu gÃ¼ncelleyelim
 * @param {Object} node - Render edilecek dÃ¼ÄŸÃ¼m
 * @param {HTMLElement} parentElement - Ãœst element
 * @param {number} level - DÃ¼ÄŸÃ¼m seviyesi
 */
function renderNode(node, parentElement, level) {
    try {
        const nodeElement = document.createElement('div');
        nodeElement.className = 'tree-node';
        nodeElement.dataset.id = node.id;
        nodeElement.dataset.nodetype = node.type; // Tip bilgisini veri Ã¶zniteliÄŸi olarak sakla
        
        // DÃ¼ÄŸÃ¼m tipine gÃ¶re stil ekle
        if (node.id.startsWith('A')) {
            nodeElement.classList.add('term-type');
        } else if (node.id.startsWith('F')) {
            nodeElement.classList.add('final-type');
        } else if (node.type === 'Soru' || node.type.includes('Soru') || isQuestionType(node.type)) {
            nodeElement.classList.add('question-type');
        } else if (node.type === 'Rubrik' || node.type.includes('Rubrik') || isRubricType(node.type)) {
            nodeElement.classList.add('rubric-type');
        } else if (node.type === 'Test') {
            nodeElement.classList.add('question-type');
        }
        
        if (APP_STATE.selectedNode && APP_STATE.selectedNode.id === node.id) {
            nodeElement.classList.add('selected');
        }
        
        // DÃ¼ÄŸÃ¼m tipine gÃ¶re seÃ§enekler oluÅŸtur
        let typeOptions = generateTypeOptions(node);
        
        // Soru veya Rubrik iÃ§in aÄŸÄ±rlÄ±k alanÄ±nÄ± readonly yapmak
        const isSubItem = node.id.includes('.');
        const isQuestionOrRubric = node.type === 'Soru' || node.type.includes('Soru') || isQuestionType(node.type) || 
                               node.type === 'Rubrik' || node.type.includes('Rubrik') || isRubricType(node.type) ||
                               node.type === 'Test';
        
        const isWeightReadonly = isSubItem && isQuestionOrRubric;
        
        // DÃ¼ÄŸÃ¼m HTML iÃ§eriÄŸi oluÅŸtur
        nodeElement.innerHTML = `
            <div class="toggle">${node.children && node.children.length > 0 ? (node.expanded ? 'â–¼' : 'â–¶') : 'â€¢'}</div>
            <div class="node-checkbox">
                <input type="checkbox" class="node-select-checkbox" data-node-id="${node.id}">
                <div class="node-id-display">${node.id}</div>
            </div>
            <div><textarea placeholder="Etkinlik adÄ±" class="nodeName auto-resize">${node.name || ''}</textarea></div>
            <div>
                <select class="nodeType" data-current-type="${node.type}">
                    ${typeOptions}
                </select>
            </div>
            <div><input type="number" value="${node.weight || 0}" min="0" max="100" class="nodeWeight" ${isWeightReadonly ? 'readonly' : ''}></div>
            <div><input type="number" value="${node.points || 0}" min="0" class="nodePoints"></div>
            <div><textarea placeholder="Ã–Ã‡.1,Ã–Ã‡.2,..." class="nodeOutcomes auto-resize">${Array.isArray(node.outcomes) ? node.outcomes.join(',') : (node.outcomes || '')}</textarea></div>
            <div>
                ${(isQuestionOrRubric && isSubItem) ? `
                    <textarea placeholder="A:1,B:2,C:3" class="nodeGroupMapping auto-resize" data-node-id="${node.id}"></textarea>
                ` : (!isSubItem && (node.id.startsWith('A') || node.id.startsWith('F'))) ? `
                    <textarea class="componentGroupInfo auto-resize" readonly data-component-id="${node.id}" placeholder="Grup bilgisi..."></textarea>
                ` : ''}
            </div>
            <div>
                <textarea placeholder="AÃ§Ä±klama..." class="nodeDescription auto-resize">${node.description || ''}</textarea>
            </div>
            <div class="actions-column">
                <div class="button-group">
                    ${(isQuestionOrRubric && isSubItem) ? `
                        <button class="btn btn-warning btn-small btn-group-mapping ${getGroupMappingStatusClass(node.id)}" data-node-id="${node.id}" title="Grup Haritalama DetaylarÄ± - Modal AÃ§ar">
                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                            Grup SeÃ§
                        </button>
                        <button class="btn btn-success btn-small btn-apply-group-mapping" data-node-id="${node.id}" title="Soldaki Grup Bilgisini Kaydet">
                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                            Grup Kaydet
                        </button>
                    ` : ''}
                    ${(!isSubItem && (node.id.startsWith('A') || node.id.startsWith('F'))) ? `
                        <button class="btn btn-warning btn-small btn-manage-component-groups" data-component-id="${node.id}" title="Bu bileÅŸenin gruplarÄ±nÄ± ekle/Ã§Ä±kar">
                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="m22 21-3-3m0 0-3-3m3 3 3-3m-3 3-3 3"/>
                            </svg>
                            Grup Ekle/Ã‡Ä±kar
                        </button>
                        <button class="btn btn-info btn-small btn-move-up tooltip" data-node-id="${node.id}" data-tooltip="Bu etkinliÄŸi yukarÄ± taÅŸÄ±" title="Bu etkinliÄŸi yukarÄ± taÅŸÄ±">
                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="18 15 12 9 6 15"></polyline>
                            </svg>
                            â†‘
                        </button>
                        <button class="btn btn-info btn-small btn-move-down tooltip" data-node-id="${node.id}" data-tooltip="Bu etkinliÄŸi aÅŸaÄŸÄ± taÅŸÄ±" title="Bu etkinliÄŸi aÅŸaÄŸÄ± taÅŸÄ±">
                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                            â†“
                        </button>
                    ` : ''}
                    <button class="btn btn-secondary btn-small btn-edit-outcomes" data-node-id="${node.id}" title="Ã–ÄŸrenme Ã‡Ä±ktÄ±larÄ±nÄ± SeÃ§ ve DÃ¼zenle">
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                        Ã–Ã‡ SeÃ§
                    </button>
                    <button class="btn btn-danger btn-small btn-delete-node" data-node-id="${node.id}" title="Bu Ã¶ÄŸeyi sil">
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </svg>
                        Sil
                </button>
                </div>
            </div>
        `;
        
        // DÃ¼ÄŸÃ¼me olay dinleyicileri ekle
        nodeElement.addEventListener('click', (e) => {
            if (!e.target.closest('input') && !e.target.closest('select') && !e.target.closest('textarea') && !e.target.closest('button')) {
                selectNode(node);
            }
        });
        
        const toggle = nodeElement.querySelector('.toggle');
        toggle.addEventListener('click', (e) => {
            e.stopPropagation();
            node.expanded = !node.expanded;
            renderTree();
        });
        
        // Silme butonu iÃ§in olay dinleyicisi
        const deleteButton = nodeElement.querySelector('.btn-delete-node');
        deleteButton.addEventListener('click', (e) => {
            e.stopPropagation();
            deleteNode(node.id);
        });
        
        // Grup haritalama butonu iÃ§in olay dinleyicisi
        const groupMappingButton = nodeElement.querySelector('.btn-group-mapping');
        if (groupMappingButton) {
            groupMappingButton.addEventListener('click', (e) => {
                e.stopPropagation();
                showGroupMappingModal(node.id);
            });
        }
        
        // Ã–Ã‡ dÃ¼zenleme butonu iÃ§in olay dinleyicisi
        const editOutcomesButton = nodeElement.querySelector('.btn-edit-outcomes');
        if (editOutcomesButton) {
            editOutcomesButton.addEventListener('click', (e) => {
                e.stopPropagation();
                showOutcomesEditModal(node.id);
            });
        }
        

        
        // BileÅŸen gruplarÄ±nÄ± yÃ¶netme butonu iÃ§in olay dinleyicisi
        const manageComponentGroupsButton = nodeElement.querySelector('.btn-manage-component-groups');
        if (manageComponentGroupsButton) {
            manageComponentGroupsButton.addEventListener('click', (e) => {
                e.stopPropagation();
                const componentId = e.target.closest('button').dataset.componentId;
                showComponentGroupManagementModal(componentId);
            });
        }
        
        // YukarÄ± taÅŸÄ±ma butonu iÃ§in olay dinleyicisi
        const moveUpButton = nodeElement.querySelector('.btn-move-up');
        if (moveUpButton) {
            moveUpButton.addEventListener('click', (e) => {
                e.stopPropagation();
                moveActivityUp(node.id);
            });
        }
        
        // AÅŸaÄŸÄ± taÅŸÄ±ma butonu iÃ§in olay dinleyicisi
        const moveDownButton = nodeElement.querySelector('.btn-move-down');
        if (moveDownButton) {
            moveDownButton.addEventListener('click', (e) => {
                e.stopPropagation();
                moveActivityDown(node.id);
            });
        }
        
        // Input deÄŸerlerini gÃ¼ncelleme
        const nameInput = nodeElement.querySelector('.nodeName');
        nameInput.addEventListener('change', () => {
            node.name = nameInput.value;
            // DeÄŸerlendirme sekmesini gÃ¼ncelle
            updateAssessmentView();
        });
        
        const typeSelect = nodeElement.querySelector('.nodeType');
        typeSelect.addEventListener('change', () => {
            const oldType = node.type;
            const newType = typeSelect.value;
            
            // Tip deÄŸiÅŸimini kaydet
            node.type = newType;
            
            // DeÄŸerlendirme sekmesini gÃ¼ncelle
            updateAssessmentView();
            
            // Soru ve Rubrik ana tipleri arasÄ±ndaki geÃ§iÅŸleri Ã¶zel ele al
            const isMainTypeChange = (
                (isQuestionMainType(oldType) && (newType === 'Rubrik' || isRubricType(newType))) ||
                ((oldType === 'Rubrik' || isRubricType(oldType)) && isQuestionMainType(newType))
            );
            
            // EÄŸer ana tÃ¼r deÄŸiÅŸimi varsa tÃ¼m aÄŸacÄ± yeniden render et
            if (isMainTypeChange) {
                renderTree();
            } else {
                // Alt tÃ¼rler arasÄ± geÃ§iÅŸlerde sadece ilgili sÄ±nÄ±flarÄ± gÃ¼ncelle
                updateNodeClassesAfterTypeChange(nodeElement, oldType, newType);
            }
        });
        
        const weightInput = nodeElement.querySelector('.nodeWeight');
        weightInput.addEventListener('change', () => {
            if (!isWeightReadonly) {
                node.weight = parseInt(weightInput.value) || 0;
                updateCategoryWeights();
                // DeÄŸerlendirme sekmesini gÃ¼ncelle
                updateAssessmentView();
            }
        });
        
        const pointsInput = nodeElement.querySelector('.nodePoints');
        pointsInput.addEventListener('change', () => {
            // Ana bileÅŸen ise (level 0) ve alt Ã¶ÄŸeleri varsa, manuel deÄŸiÅŸikliÄŸi engelle
            if (level === 0 && node.children && node.children.length > 0) {
                // Eski deÄŸeri geri yÃ¼kle
                pointsInput.value = node.points;
                showModernToast("Ana bileÅŸenin puanÄ± alt Ã¶ÄŸelerin toplamÄ±na gÃ¶re otomatik hesaplanÄ±r!", "warning");
                return;
            }
            
            node.points = parseInt(pointsInput.value) || 0;
            
            // EÄŸer bu bir soru/rubrik alt Ã¶ÄŸesi ise, aÄŸÄ±rlÄ±ÄŸÄ± otomatik hesapla
            if (isSubItem && isQuestionOrRubric) {
                updateSubItemWeight(node);
            }
            
            // DeÄŸerlendirme sekmesini gÃ¼ncelle
            updateAssessmentView();
        });
        
        const outcomesInput = nodeElement.querySelector('.nodeOutcomes');
        outcomesInput.addEventListener('change', () => {
            updateOutcomes(node, outcomesInput);
            // DeÄŸerlendirme sekmesini gÃ¼ncelle
            updateAssessmentView();
        });
        
        const descriptionInput = nodeElement.querySelector('.nodeDescription');
        descriptionInput.addEventListener('change', () => {
            node.description = descriptionInput.value;
            // DeÄŸerlendirme sekmesini gÃ¼ncelle
            updateAssessmentView();
        });
        
        // Ana ekran hÄ±zlÄ± grup giriÅŸi event listener'larÄ±
        const groupMappingInput = nodeElement.querySelector('.nodeGroupMapping');
        if (groupMappingInput) {
            // Input'u mevcut haritalama ile doldur
            const mappingText = getCurrentMappingText(node.id);
            groupMappingInput.value = mappingText;
            
            // Auto-resize for group mapping input
            setupAutoResize(groupMappingInput);
            
            // Enter tuÅŸu ile de uygulayabilsin
            groupMappingInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    applyInlineGroupMapping(node.id);
                }
            });
        }
        
        const applyGroupMappingBtn = nodeElement.querySelector('.btn-apply-group-mapping');
        if (applyGroupMappingBtn) {
            applyGroupMappingBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                applyInlineGroupMapping(node.id);
            });
        }
        
        // Setup auto-resize for all auto-resize inputs
        const autoResizeInputs = nodeElement.querySelectorAll('.auto-resize');
        autoResizeInputs.forEach(input => {
            setupAutoResize(input);
        });
        
        // GUID sistemi kaldÄ±rÄ±ldÄ± - temizlendi
        
        // BileÅŸen grup bilgisini gÃ¼ncelle (sadece ana bileÅŸenler iÃ§in)
        const componentGroupInfo = nodeElement.querySelector('.componentGroupInfo');
        if (componentGroupInfo) {
            updateComponentGroupInfo(node.id);
        }
        
        // DÃ¼ÄŸÃ¼mÃ¼ parent'a ekle
        parentElement.appendChild(nodeElement);
        
        // Alt dÃ¼ÄŸÃ¼mleri render et
        if (node.children && node.children.length > 0 && node.expanded) {
            const childrenContainer = document.createElement('div');
            childrenContainer.className = 'node-children';
            parentElement.appendChild(childrenContainer);
            
            node.children.forEach(child => {
                renderNode(child, childrenContainer, level + 1);
            });
        }
    } catch (error) {
        console.error("DÃ¼ÄŸÃ¼m render edilirken hata oluÅŸtu:", error);
        showModernToast("DeÄŸerlendirme bileÅŸenleri gÃ¶rÃ¼ntÃ¼lenirken hata oluÅŸtu!", "error");
    }
}

/**
 * Alt Ã¶ÄŸelerin (soru/rubrik) aÄŸÄ±rlÄ±ÄŸÄ±nÄ± otomatik hesaplama
 * @param {Object} node - AÄŸÄ±rlÄ±ÄŸÄ± hesaplanacak dÃ¼ÄŸÃ¼m
 */
function updateSubItemWeight(node) {
    try {
        // Ãœst dÃ¼ÄŸÃ¼mÃ¼ bul
        const parentId = node.id.substring(0, node.id.lastIndexOf('.'));
        const parentNode = findNodeById(parentId);
        
        if (!parentNode || !parentNode.children || parentNode.children.length === 0) {
            return;
        }
        
        // Toplam puan hesapla
        const totalPoints = parentNode.children.reduce((sum, child) => sum + (parseInt(child.points) || 0), 0);
        
        // Her Ã§ocuk iÃ§in aÄŸÄ±rlÄ±k hesapla
        if (totalPoints > 0) {
            parentNode.children.forEach(child => {
                const childPoints = parseInt(child.points) || 0;
                child.weight = Math.round((childPoints / totalPoints) * 100);
                
                // DOM'da aÄŸÄ±rlÄ±k alanÄ±nÄ± gÃ¼ncelle
                const weightInput = document.querySelector(`.tree-node[data-id="${child.id}"] .nodeWeight`);
                if (weightInput) {
                    weightInput.value = child.weight;
                }
            });
        }
        
        // Ana bileÅŸenin toplam puanÄ±nÄ± gÃ¼ncelle
        updateComponentTotalPoints(parentNode);
        
        // Kategori aÄŸÄ±rlÄ±klarÄ±nÄ± gÃ¼ncelle
        updateCategoryWeights();
    } catch (error) {
        console.error("Alt Ã¶ÄŸe aÄŸÄ±rlÄ±ÄŸÄ± hesaplanÄ±rken hata oluÅŸtu:", error);
    }
}

// GUID sistemi kaldÄ±rÄ±ldÄ±

/**
 * Panoya kopyalama fonksiyonu
 * @param {string} text - Kopyalanacak metin
 */
function copyToClipboard(text) {
    if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
            console.log(`ğŸ“‹ Panoya kopyalandÄ±: ${text}`);
            if (typeof showModernToast === 'function') {
                showModernToast(`ğŸ“‹ KopyalandÄ±: ${text}`, 'success');
            }
        }).catch(err => {
            console.error('âŒ Kopyalama hatasÄ±:', err);
            if (typeof showModernToast === 'function') {
                showModernToast('âŒ KopyalanamadÄ±!', 'error');
            }
        });
    } else {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            console.log(`ğŸ“‹ Panoya kopyalandÄ± (fallback): ${text}`);
            if (typeof showModernToast === 'function') {
                showModernToast(`ğŸ“‹ KopyalandÄ±: ${text}`, 'success');
            }
        } catch (err) {
            console.error('âŒ Kopyalama hatasÄ± (fallback):', err);
            if (typeof showModernToast === 'function') {
                showModernToast('âŒ KopyalanamadÄ±!', 'error');
            }
        }
        document.body.removeChild(textArea);
    }
}

/**
 * Ana bileÅŸenin toplam puanÄ±nÄ± hesaplama ve gÃ¶rÃ¼ntÃ¼leme
 * @param {Object} node - Ana bileÅŸen dÃ¼ÄŸÃ¼mÃ¼
 */
function updateComponentTotalPoints(node) {
    try {
        if (!node.children || node.children.length === 0) {
            return;
        }
        
        // Toplam puanÄ± hesapla (tÃ¼m alt Ã¶ÄŸelerin puanlarÄ±nÄ±n toplamÄ±)
        const totalPoints = node.children.reduce((sum, child) => {
            return sum + calculateNodeTotalPoints(child);
        }, 0);
        
        // Ana bileÅŸenin kendi puanÄ±nÄ± gÃ¼ncelle
        node.points = totalPoints;
        
        // DOM'da puan input'unu gÃ¼ncelle
        const nodeElement = document.querySelector(`.tree-node[data-id="${node.id}"]`);
        if (nodeElement) {
            const pointsInput = nodeElement.querySelector('.nodePoints');
            if (pointsInput) {
                pointsInput.value = totalPoints;
                
                // Input'u renklendirme
                const isStandard = totalPoints === 100;
                pointsInput.classList.remove('standard-points', 'high-points', 'low-points');
                
                                 if (isStandard) {
                     pointsInput.classList.add('standard-points');
                     pointsInput.title = 'Standart 100 puan (Alt Ã¶ÄŸelerin toplamÄ±)';
                 } else if (totalPoints > 100) {
                     pointsInput.classList.add('high-points');
                     pointsInput.title = `Standart Ã¼zeri: ${totalPoints} puan (Alt Ã¶ÄŸelerin toplamÄ±)`;
                 } else {
                     pointsInput.classList.add('low-points');
                     pointsInput.title = `Standart altÄ±: ${totalPoints} puan (Alt Ã¶ÄŸelerin toplamÄ±)`;
                 }
                 
                 // Ana bileÅŸen input'una readonly Ã¶zelliÄŸi ekle
                 pointsInput.readOnly = true;
                 pointsInput.style.cursor = 'not-allowed';
            }
            
            // GUID sistemi kaldÄ±rÄ±ldÄ±
            
            // Eski toplam puan gÃ¶sterimini kaldÄ±r (artÄ±k input'ta gÃ¶steriliyor)
            const totalPointsDisplay = nodeElement.querySelector('.total-points-display');
            if (totalPointsDisplay) {
                totalPointsDisplay.remove();
            }
        }
        
        console.log(`BileÅŸen ${node.id} toplam puanÄ± gÃ¼ncellendi: ${totalPoints}`);
        
    } catch (error) {
        console.error("BileÅŸen toplam puanÄ± hesaplanÄ±rken hata:", error);
    }
}

/**
 * Bir dÃ¼ÄŸÃ¼mÃ¼n toplam puanÄ±nÄ± hesaplama (kendisi + alt dÃ¼ÄŸÃ¼mler)
 * @param {Object} node - DÃ¼ÄŸÃ¼m
 * @returns {number} - Toplam puan
 */
function calculateNodeTotalPoints(node) {
    let totalPoints = parseInt(node.points) || 0;
    
    if (node.children && node.children.length > 0) {
        totalPoints += node.children.reduce((sum, child) => {
            return sum + calculateNodeTotalPoints(child);
        }, 0);
    }
    
    return totalPoints;
}

/**
 * DÃ¼ÄŸÃ¼me soru ekleme
 * @param {Object} parentNode - Ãœst dÃ¼ÄŸÃ¼m
 * @param {string} questionType - Soru tipi
 * @param {string} description - AÃ§Ä±klama
 */
function addQuestionToNode(parentNode, questionType = 'Soru', description = '') {
    if (!parentNode) return;
    
    try {
        if (!parentNode.children) {
            parentNode.children = [];
        }
        
        const childCount = parentNode.children.length;
        const newId = `${parentNode.id}.${childCount + 1}`;
        
        // Ã–ÄŸrenme Ã§Ä±ktÄ±larÄ± varsa ilk Ã¶ÄŸrenme Ã§Ä±ktÄ±sÄ±nÄ± atayalÄ±m
        const outcome = parentNode.outcomes.length > 0 ? [parentNode.outcomes[0]] : [];
        
        // VarsayÄ±lan puanÄ± 3 olarak ayarla (Ã¶nceki 20 yerine)
        const defaultPoints = 3;
        
        const newNode = {
            id: newId,
            name: `${questionType}`,
            type: questionType,
            weight: 0, // AÄŸÄ±rlÄ±k otomatik hesaplanacak
            points: defaultPoints, // VarsayÄ±lan puan 3
            outcomes: outcome,
            description: description || 'DeÄŸerlendirme sorusu',
            expanded: true,
            children: []
        };
        
        parentNode.children.push(newNode);
        parentNode.expanded = true;
        
        // AÄŸÄ±rlÄ±ÄŸÄ± hesapla
        updateSubItemWeight(newNode);
        
        selectNode(newNode);
        renderTree();
        
        // DeÄŸerlendirme sekmesini gÃ¼ncelle
        updateAssessmentView();
        
        // Yeni eklenen bileÅŸen iÃ§in otomatik mapping atamasÄ±
        assignDefaultMappingToNewComponent(parentNode.id, newNode);
        
        showModernToast(`"${questionType}" sorusu eklendi.`);
        
        // YENÄ° KOD: AÄŸÄ±rlÄ±klarÄ± yeniden deÄŸerlendir
        checkAndOfferRedistribution(parentNode);
        
    } catch (error) {
        console.error("Soru eklenirken hata oluÅŸtu:", error);
        showModernToast("Soru eklenemedi!", "error");
    }
}

/**
 * DÃ¼ÄŸÃ¼me rubrik ekleme
 * @param {Object} parentNode - Ãœst dÃ¼ÄŸÃ¼m
 * @param {string} rubricType - Rubrik tipi
 * @param {string} description - AÃ§Ä±klama
 */
function addRubricToNode(parentNode, rubricType = 'Rubrik', description = '') {
    if (!parentNode) return;
    
    try {
        if (!parentNode.children) {
            parentNode.children = [];
        }
        
        const childCount = parentNode.children.length;
        const newId = `${parentNode.id}.${childCount + 1}`;
        
        // Ã–ÄŸrenme Ã§Ä±ktÄ±larÄ± varsa ilk Ã¶ÄŸrenme Ã§Ä±ktÄ±sÄ±nÄ± atayalÄ±m
        const outcome = parentNode.outcomes.length > 0 ? [parentNode.outcomes[0]] : [];
        
        // VarsayÄ±lan puanÄ± 3 olarak ayarla (Ã¶nceki 20 yerine)
        const defaultPoints = 3;
        
        const newNode = {
            id: newId,
            name: `${rubricType}`,
            type: 'Rubrik',
            weight: 0, // AÄŸÄ±rlÄ±k otomatik hesaplanacak
            points: defaultPoints, // VarsayÄ±lan puan 3
            outcomes: outcome,
            description: description || 'DeÄŸerlendirme kriteri',
            expanded: true,
            children: []
        };
        
        parentNode.children.push(newNode);
        parentNode.expanded = true;
        
        // AÄŸÄ±rlÄ±ÄŸÄ± hesapla
        updateSubItemWeight(newNode);
        
        selectNode(newNode);
        renderTree();
        
        // DeÄŸerlendirme sekmesini gÃ¼ncelle
        updateAssessmentView();
        
        // Yeni eklenen bileÅŸen iÃ§in otomatik mapping atamasÄ±
        assignDefaultMappingToNewComponent(parentNode.id, newNode);
        
        showModernToast(`"${rubricType}" rubriÄŸi eklendi.`);
        
        // YENÄ° KOD: AÄŸÄ±rlÄ±klarÄ± yeniden deÄŸerlendir
        checkAndOfferRedistribution(parentNode);
        
    } catch (error) {
        console.error("Rubrik eklenirken hata oluÅŸtu:", error);
        showModernToast("Rubrik eklenemedi!", "error");
    }
}

/**
 * Ã‡oklu Ã¶ÄŸe ekleme
 */
// Ä°lk addMultipleItems fonksiyonu kaldÄ±rÄ±ldÄ± - geliÅŸmiÅŸ versiyon korundu

/**
 * Soru tipine ait bir tÃ¼r olup olmadÄ±ÄŸÄ±nÄ± kontrol eder
 * @param {string} type - Kontrol edilecek tip
 * @returns {boolean} - Soru tipine ait ise true
 */
function isQuestionType(type) {
    // Direkt 'Soru' ana tipi ise
    if (type === 'Soru') return true;
    
    // Soru iÃ§eriyorsa (Ã¶rn. "AÃ§Ä±k UÃ§lu Soru")
    if (type.includes('Soru')) return true;
    
    // Soru tÃ¼rleri listesinde var mÄ± kontrol et
    const questionTypes = Array.from(document.querySelectorAll('.question-type-item'))
        .map(item => item.getAttribute('data-type'));
    
    return questionTypes.includes(type);
}

/**
 * Rubrik tipine ait bir tÃ¼r olup olmadÄ±ÄŸÄ±nÄ± kontrol eder
 * @param {string} type - Kontrol edilecek tip
 * @returns {boolean} - Rubrik tipine ait ise true
 */
function isRubricType(type) {
    // Direkt 'Rubrik' ana tipi ise
    if (type === 'Rubrik') return true;
    
    // Rubrik tÃ¼rleri listesinde var mÄ± kontrol et
    const rubricTypes = Array.from(document.querySelectorAll('.rubric-item'))
        .map(item => item.getAttribute('data-type'));
    
    return rubricTypes.includes(type);
}

/**
 * Ana Soru tiplerinden biri olup olmadÄ±ÄŸÄ±nÄ± kontrol eder
 * @param {string} type - Kontrol edilecek tip
 * @returns {boolean} - Ana soru tiplerinden biri ise true
 */
function isQuestionMainType(type) {
    return type === 'Soru' || type.includes('Soru') || isQuestionType(type);
}

/**
 * Tipe gÃ¶re dropdown seÃ§eneklerini oluÅŸturur
 * @param {Object} node - Dropdown seÃ§enekleri oluÅŸturulacak dÃ¼ÄŸÃ¼m
 * @returns {string} - Dropdown option HTML iÃ§eriÄŸi
 */
function generateTypeOptions(node) {
    let typeOptions = '';
    
    // KÃ¶k dÃ¼ÄŸÃ¼mler iÃ§in (Ana etkinlikler)
    if (!node.id.includes('.')) {
        // YarÄ±yÄ±l iÃ§i etkinlikler
        if (node.id.startsWith('A')) {
            typeOptions = ACTIVITY_TYPES.term.map(type => 
                `<option value="${type}" ${node.type === type ? 'selected' : ''}>${type}</option>`
            ).join('');
        } 
        // YarÄ±yÄ±l sonu etkinlikler
        else if (node.id.startsWith('F')) {
            typeOptions = ACTIVITY_TYPES.final.map(type => 
                `<option value="${type}" ${node.type === type ? 'selected' : ''}>${type}</option>`
            ).join('');
        }
    } 
    // Alt dÃ¼ÄŸÃ¼mler iÃ§in (Sorular, rubrikler vb.)
    else {
        // Test tipi iÃ§in sadece Test seÃ§eneÄŸi
        if (node.type === 'Test') {
            typeOptions = `<option value="Test" selected>Test SorularÄ± (Toplu)</option>`;
        }
        // Soru tipi ve tÃ¼revleri iÃ§in
        else if (node.type === 'Soru' || node.type.includes('Soru') || isQuestionType(node.type)) {
            // Ã–nce ana 'Soru' seÃ§eneÄŸi
            typeOptions = `<option value="Soru" ${node.type === 'Soru' ? 'selected' : ''}>Soru</option>`;
            
            // Sonra diÄŸer soru tÃ¼rleri
            const questionTypes = Array.from(document.querySelectorAll('.question-type-item'))
                .map(item => item.getAttribute('data-type'))
                .filter(type => type !== 'Test'); // Test tÃ¼rÃ¼nÃ¼ hariÃ§ tut
                
            questionTypes.forEach(type => {
                typeOptions += `<option value="${type}" ${node.type === type ? 'selected' : ''}>${type}</option>`;
            });
        } 
        // Rubrik tipi ve tÃ¼revleri iÃ§in
        else {
            // Ã–nce ana 'Rubrik' seÃ§eneÄŸi
            typeOptions = `<option value="Rubrik" ${node.type === 'Rubrik' ? 'selected' : ''}>Rubrik</option>`;
            
            // Sonra diÄŸer rubrik tÃ¼rleri
            const rubricTypes = Array.from(document.querySelectorAll('.rubric-item'))
                .map(item => item.getAttribute('data-type'));
                
            rubricTypes.forEach(type => {
                typeOptions += `<option value="${type}" ${node.type === type ? 'selected' : ''}>${type}</option>`;
            });
        }
    }
    
    return typeOptions;
}

/**
 * Tip deÄŸiÅŸikliÄŸinden sonra node sÄ±nÄ±flarÄ±nÄ± gÃ¼nceller
 * @param {HTMLElement} nodeElement - DÃ¼ÄŸÃ¼m elementi
 * @param {string} oldType - Eski tip
 * @param {string} newType - Yeni tip
 */
function updateNodeClassesAfterTypeChange(nodeElement, oldType, newType) {
    // Eski tip sÄ±nÄ±flarÄ±nÄ± kaldÄ±r
    if (isQuestionType(oldType)) {
        nodeElement.classList.remove('question-type');
    } else if (isRubricType(oldType)) {
        nodeElement.classList.remove('rubric-type');
    }
    
    // Yeni tip sÄ±nÄ±flarÄ±nÄ± ekle
    if (isQuestionType(newType)) {
        nodeElement.classList.add('question-type');
    } else if (isRubricType(newType)) {
        nodeElement.classList.add('rubric-type');
    }
    
    // Tip bilgisini veri Ã¶zniteliÄŸinde gÃ¼ncelle
    nodeElement.dataset.nodetype = newType;
}
/**
 * AÄŸacÄ± render etme
 */
/**
 * AÄŸacÄ± render etme
 */
function renderTree() {
    try {
        treeContainer.innerHTML = '';
        
        if (!APP_STATE.assessmentTree || APP_STATE.assessmentTree.length === 0) {
            const emptyMessage = document.createElement('div');
            emptyMessage.className = 'tree-empty-message';
            emptyMessage.textContent = 'HenÃ¼z deÄŸerlendirme bileÅŸeni eklenmedi. Ders JSON yÃ¼kleyin veya yeni bileÅŸenler ekleyin.';
            treeContainer.appendChild(emptyMessage);
            return;
        }

        // YarÄ±yÄ±l iÃ§i bÃ¶lÃ¼mÃ¼ oluÅŸtur
        const termSection = document.createElement('div');
        termSection.className = 'tree-section term-section';
        
        // YarÄ±yÄ±l iÃ§i baÅŸlÄ±k
        const termHeader = document.createElement('div');
        termHeader.className = 'tree-section-header';
        termHeader.innerHTML = `
            <h3>YarÄ±yÄ±l Ä°Ã§i DeÄŸerlendirme BileÅŸenleri</h3>
            <div class="tree-section-controls">
                <div class="select-all-checkbox">
                    <input type="checkbox" id="selectAllTerm">
                    <label for="selectAllTerm">Hepsini SeÃ§</label>
                </div>
                <div class="bulk-action-buttons">
                    <div class="tooltip">
                        <button class="btn-bulk btn-copy" id="bulkCopyTerm" disabled>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                            Kopyala
                        </button>
                        <span class="tooltiptext">SeÃ§ili bileÅŸenlerin kopyasÄ±nÄ± oluÅŸturup yarÄ±yÄ±l iÃ§i bÃ¶lÃ¼mÃ¼nÃ¼n sonuna ekler. AynÄ± yapÄ±da yeni bileÅŸenler oluÅŸturur.</span>
                    </div>
                    <div class="tooltip">
                        <button class="btn-bulk btn-delete" id="bulkDeleteTerm" disabled>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                            Sil
                        </button>
                        <span class="tooltiptext">SeÃ§ili bileÅŸenleri kalÄ±cÄ± olarak siler. Bu iÅŸlem geri alÄ±namaz! Dikkatli kullanÄ±n.</span>
                    </div>
                </div>
            </div>
        `;
        termSection.appendChild(termHeader);
        
        // YarÄ±yÄ±l iÃ§i dÃ¼ÄŸÃ¼mleri
        const termNodes = APP_STATE.assessmentTree.filter(node => node.id.startsWith('A'));
        
        if (termNodes.length === 0) {
            const emptyTerm = document.createElement('div');
            emptyTerm.className = 'tree-section-empty';
            emptyTerm.textContent = 'HenÃ¼z yarÄ±yÄ±l iÃ§i deÄŸerlendirme bileÅŸeni eklenmedi.';
            termSection.appendChild(emptyTerm);
        } else {
            termNodes.forEach(node => {
                renderNode(node, termSection, 0);
                // Ana bileÅŸen iÃ§in toplam puan hesaplamasÄ±nÄ± tetikle
                if (node.children && node.children.length > 0) {
                    setTimeout(() => updateComponentTotalPoints(node), 100);
                }
            });
        }
        
        // YarÄ±yÄ±l iÃ§i bÃ¶lÃ¼mÃ¼ iÃ§in ekleme butonu
        const termAddButton = document.createElement('div');
        termAddButton.className = 'add-node-button';
        termAddButton.innerHTML = `
            <button class="btn btn-add-node" data-section="term">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                YarÄ±yÄ±l Ä°Ã§i Etkinlik Ekle
            </button>
        `;
        termSection.appendChild(termAddButton);
        
        // YarÄ±yÄ±l sonu bÃ¶lÃ¼mÃ¼ oluÅŸtur
        const finalSection = document.createElement('div');
        finalSection.className = 'tree-section final-section';
        
        // YarÄ±yÄ±l sonu baÅŸlÄ±k
        const finalHeader = document.createElement('div');
        finalHeader.className = 'tree-section-header';
        finalHeader.innerHTML = `
            <h3>YarÄ±yÄ±l Sonu DeÄŸerlendirme BileÅŸenleri</h3>
            <div class="tree-section-controls">
                <div class="select-all-checkbox">
                    <input type="checkbox" id="selectAllFinal">
                    <label for="selectAllFinal">Hepsini SeÃ§</label>
                </div>
                <div class="bulk-action-buttons">
                    <div class="tooltip">
                        <button class="btn-bulk btn-copy" id="bulkCopyFinal" disabled>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                            Kopyala
                        </button>
                        <span class="tooltiptext">SeÃ§ili bileÅŸenlerin kopyasÄ±nÄ± oluÅŸturup yarÄ±yÄ±l sonu bÃ¶lÃ¼mÃ¼nÃ¼n sonuna ekler. AynÄ± yapÄ±da yeni bileÅŸenler oluÅŸturur.</span>
                    </div>
                    <div class="tooltip">
                        <button class="btn-bulk btn-delete" id="bulkDeleteFinal" disabled>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                            Sil
                        </button>
                        <span class="tooltiptext">SeÃ§ili bileÅŸenleri kalÄ±cÄ± olarak siler. Bu iÅŸlem geri alÄ±namaz! Dikkatli kullanÄ±n.</span>
                    </div>
                </div>
            </div>
        `;
        finalSection.appendChild(finalHeader);
        
        // YarÄ±yÄ±l sonu dÃ¼ÄŸÃ¼mleri
        const finalNodes = APP_STATE.assessmentTree.filter(node => node.id.startsWith('F'));
        
        if (finalNodes.length === 0) {
            const emptyFinal = document.createElement('div');
            emptyFinal.className = 'tree-section-empty';
            emptyFinal.textContent = 'HenÃ¼z yarÄ±yÄ±l sonu deÄŸerlendirme bileÅŸeni eklenmedi.';
            finalSection.appendChild(emptyFinal);
        } else {
            finalNodes.forEach(node => {
                renderNode(node, finalSection, 0);
                // Ana bileÅŸen iÃ§in toplam puan hesaplamasÄ±nÄ± tetikle
                if (node.children && node.children.length > 0) {
                    setTimeout(() => updateComponentTotalPoints(node), 100);
                }
            });
        }
        
        // YarÄ±yÄ±l sonu bÃ¶lÃ¼mÃ¼ iÃ§in ekleme butonu
        const finalAddButton = document.createElement('div');
        finalAddButton.className = 'add-node-button';
        finalAddButton.innerHTML = `
            <button class="btn btn-add-node" data-section="final">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                YarÄ±yÄ±l Sonu Etkinlik Ekle
            </button>
        `;
        finalSection.appendChild(finalAddButton);
        
        // Ä°lk Ã¶nce yarÄ±yÄ±l iÃ§i, sonra yarÄ±yÄ±l sonu bÃ¶lÃ¼mlerini ekle
        treeContainer.appendChild(termSection);
        treeContainer.appendChild(finalSection);
        
        // Ekleme butonlarÄ± iÃ§in olay dinleyicileri
        document.querySelectorAll('.btn-add-node').forEach(button => {
            button.addEventListener('click', function() {
                const section = this.getAttribute('data-section');
                if (section === 'term') {
                    addTermActivity();
                } else if (section === 'final') {
                    addFinalActivity();
                }
            });
        });

        // Toplu iÅŸlem olay dinleyicileri
        setupBulkActionListeners();
        
        // AÄŸÄ±rlÄ±klarÄ± gÃ¼ncelle
        updateCategoryWeights();
        
        // Grup haritalama UI'larÄ±nÄ± gÃ¼ncelle - v5 format iÃ§in zorlamalÄ± gÃ¼ncelleme
        setTimeout(() => {
            console.log("ğŸ”„ Grup UI gÃ¼ncellemesi baÅŸlÄ±yor...");
            console.log("ğŸ“Š Mevcut grup haritalama verileri:", APP_STATE.courseData?.grupHaritalari);
            updateGroupMappingColors();
            updateAllInlineGroupInputs();
            console.log("âœ… Grup UI gÃ¼ncellemesi tamamlandÄ±");
        }, 100);
        
        // Ek gÃ¼ncelleme - bazen ilk seferde yakalanmÄ±yor
        setTimeout(() => {
            console.log("ğŸ”„ Ä°kinci grup UI gÃ¼ncellemesi...");
            updateAllInlineGroupInputs();
            
            // Her bileÅŸen iÃ§in grup bilgilerini kontrol et
            Object.keys(APP_STATE.courseData?.grupHaritalari || {}).forEach(componentId => {
                console.log(`ğŸ” ${componentId} iÃ§in grup bilgisi kontrolÃ¼...`);
                updateComponentGroupInfo(componentId);
            });
        }, 500);
        
        // SÃ¼rÃ¼kle-bÄ±rak Ã¶zelliÄŸini etkinleÅŸtir
        setTimeout(() => {
            enableDragAndDrop();
        }, 200);
        
            console.log('ğŸ¯ renderTree tamamlandÄ±');
    } catch (error) {
        console.error("AÄŸaÃ§ render edilirken hata oluÅŸtu:", error);
        showModernToast("DeÄŸerlendirme aÄŸacÄ± yÃ¼klenirken hata oluÅŸtu!", "error");
    }
}

/**
 * Toplu iÅŸlem olay dinleyicilerini kurma
 */
function setupBulkActionListeners() {
    // YarÄ±yÄ±l iÃ§i kontrolleri
    const selectAllTerm = document.getElementById('selectAllTerm');
    const bulkCopyTerm = document.getElementById('bulkCopyTerm');
    const bulkDeleteTerm = document.getElementById('bulkDeleteTerm');
    
    // YarÄ±yÄ±l sonu kontrolleri
    const selectAllFinal = document.getElementById('selectAllFinal');
    const bulkCopyFinal = document.getElementById('bulkCopyFinal');
    const bulkDeleteFinal = document.getElementById('bulkDeleteFinal');
    
    // Hepsini seÃ§/seÃ§imi kaldÄ±r - YarÄ±yÄ±l Ä°Ã§i
    if (selectAllTerm) {
        selectAllTerm.addEventListener('change', (e) => {
            const termNodes = document.querySelectorAll('.term-section .node-select-checkbox');
            termNodes.forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
            updateBulkActionButtons('term');
        });
    }
    
    // Hepsini seÃ§/seÃ§imi kaldÄ±r - YarÄ±yÄ±l Sonu
    if (selectAllFinal) {
        selectAllFinal.addEventListener('change', (e) => {
            const finalNodes = document.querySelectorAll('.final-section .node-select-checkbox');
            finalNodes.forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
            updateBulkActionButtons('final');
        });
    }
    
    // Bireysel checkbox deÄŸiÅŸiklikleri
    document.querySelectorAll('.node-select-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
            e.stopPropagation();
            const section = e.target.closest('.term-section') ? 'term' : 'final';
            updateBulkActionButtons(section);
            updateSelectAllCheckbox(section);
        });
    });
    
    // Kopyalama butonlarÄ±
    if (bulkCopyTerm) {
        bulkCopyTerm.addEventListener('click', () => {
            const selectedIds = getSelectedNodeIds('term');
            if (selectedIds.length > 0) {
                bulkCopyNodes(selectedIds, 'term');
            }
        });
    }
    
    if (bulkCopyFinal) {
        bulkCopyFinal.addEventListener('click', () => {
            const selectedIds = getSelectedNodeIds('final');
            if (selectedIds.length > 0) {
                bulkCopyNodes(selectedIds, 'final');
            }
        });
    }
    
    // Silme butonlarÄ±
    if (bulkDeleteTerm) {
        bulkDeleteTerm.addEventListener('click', () => {
            const selectedIds = getSelectedNodeIds('term');
            if (selectedIds.length > 0) {
                bulkDeleteNodes(selectedIds, 'term');
            }
        });
    }
    
    if (bulkDeleteFinal) {
        bulkDeleteFinal.addEventListener('click', () => {
            const selectedIds = getSelectedNodeIds('final');
            if (selectedIds.length > 0) {
                bulkDeleteNodes(selectedIds, 'final');
            }
        });
    }
}

/**
 * SeÃ§ili dÃ¼ÄŸÃ¼m ID'lerini al
 */
function getSelectedNodeIds(section) {
    const sectionClass = section === 'term' ? '.term-section' : '.final-section';
    const selectedCheckboxes = document.querySelectorAll(`${sectionClass} .node-select-checkbox:checked`);
    return Array.from(selectedCheckboxes).map(cb => cb.dataset.nodeId);
}

/**
 * Toplu iÅŸlem butonlarÄ±nÄ±n durumunu gÃ¼ncelle
 */
function updateBulkActionButtons(section) {
    const selectedIds = getSelectedNodeIds(section);
    const copyBtn = document.getElementById(`bulkCopy${section.charAt(0).toUpperCase() + section.slice(1)}`);
    const deleteBtn = document.getElementById(`bulkDelete${section.charAt(0).toUpperCase() + section.slice(1)}`);
    
    if (copyBtn) copyBtn.disabled = selectedIds.length === 0;
    if (deleteBtn) deleteBtn.disabled = selectedIds.length === 0;
}

/**
 * Hepsini seÃ§ checkbox'Ä±nÄ±n durumunu gÃ¼ncelle
 */
function updateSelectAllCheckbox(section) {
    const sectionClass = section === 'term' ? '.term-section' : '.final-section';
    const allCheckboxes = document.querySelectorAll(`${sectionClass} .node-select-checkbox`);
    const checkedCheckboxes = document.querySelectorAll(`${sectionClass} .node-select-checkbox:checked`);
    const selectAllCheckbox = document.getElementById(`selectAll${section.charAt(0).toUpperCase() + section.slice(1)}`);
    
    if (selectAllCheckbox && allCheckboxes.length > 0) {
        selectAllCheckbox.checked = checkedCheckboxes.length === allCheckboxes.length;
        selectAllCheckbox.indeterminate = checkedCheckboxes.length > 0 && checkedCheckboxes.length < allCheckboxes.length;
    }
}

/**
 * SeÃ§ili dÃ¼ÄŸÃ¼mleri kopyala
 */
function bulkCopyNodes(nodeIds, section) {
    // SeÃ§ili bileÅŸenleri ana etkinlik ve alt bileÅŸen olarak ayÄ±r
    const mainActivities = [];
    const subComponents = [];
    
    nodeIds.forEach(nodeId => {
        const node = findNodeById(nodeId);
        if (node) {
            const isMainActivity = !nodeId.includes('.');
            const componentInfo = {
                id: nodeId,
                name: node.name || node.type || 'Ä°simsiz',
                type: node.type || 'Bilinmeyen',
                node: node
            };
            
            if (isMainActivity) {
                mainActivities.push(componentInfo);
            } else {
                subComponents.push(componentInfo);
            }
        }
    });
    
    // MesajÄ± oluÅŸtur
    let message = `${nodeIds.length} adet seÃ§ili bileÅŸenin kopyasÄ±nÄ± oluÅŸturmak istediÄŸinizden emin misiniz?\n\n`;
    
    if (mainActivities.length > 0) {
        message += `ğŸ“‹ Ana Etkinlikler (${mainActivities.length} adet):\n`;
        mainActivities.slice(0, 5).forEach((comp, index) => {
            message += `${index + 1}. ${comp.id} - ${comp.name}\n`;
        });
        if (mainActivities.length > 5) {
            message += `... ve ${mainActivities.length - 5} tane daha\n`;
        }
        message += `â†’ Etkinliklerin sonuna eklenecek\n\n`;
    }
    
    if (subComponents.length > 0) {
        message += `ğŸ”§ Alt BileÅŸenler (${subComponents.length} adet):\n`;
        subComponents.slice(0, 5).forEach((comp, index) => {
            const parentId = comp.id.substring(0, comp.id.lastIndexOf('.'));
            message += `${index + 1}. ${comp.id} - ${comp.name} (${parentId} iÃ§ine)\n`;
        });
        if (subComponents.length > 5) {
            message += `... ve ${subComponents.length - 5} tane daha\n`;
        }
        message += `â†’ Kendi ana etkinliklerinin sonuna eklenecek\n\n`;
    }
    
    showModernConfirm(
        'SeÃ§ili BileÅŸenleri Kopyala',
        message,
        {
            confirmText: 'Evet, Kopyala',
            cancelText: 'Ä°ptal',
            headerClass: 'info-action',
            iconClass: 'info'
        }
    ).then(confirmed => {
        if (confirmed) {
            try {
                let copiedCount = 0;
                
                // Ana etkinlikleri kopyala (etkinliklerin sonuna)
                mainActivities.forEach(comp => {
                    const copiedNode = deepCopyNode(comp.node, section);
                    APP_STATE.assessmentTree.push(copiedNode);
                    
                    // Orijinal etkinliÄŸin grup haritalamalarÄ±nÄ± kopyala
                    copyGroupMappingsForActivity(comp.node.id, copiedNode.id);
                    
                    copiedCount++;
                });
                
                // Alt bileÅŸenleri kopyala (kendi parent'larÄ±nÄ±n sonuna)
                subComponents.forEach(comp => {
                    const parentId = comp.id.substring(0, comp.id.lastIndexOf('.'));
                    const parentNode = findNodeById(parentId);
                    
                    if (parentNode) {
                        const copiedSubComponent = deepCopySubComponent(comp.node, parentNode);
                        if (!parentNode.children) {
                            parentNode.children = [];
                        }
                        parentNode.children.push(copiedSubComponent);
                        
                        // Parent'Ä±n grup haritalamalarÄ±na yeni alt bileÅŸeni ekle
                        addSubComponentToGroupMappings(parentNode.id, copiedSubComponent.id);
                        
                        copiedCount++;
                    }
                });
                
                // TÃ¼m ID'leri yeniden dÃ¼zenle
                const oldToNewIdMap = reorganizeAllIds();
                
                // Grup haritalamalarÄ±nÄ± yeni ID'lerle gÃ¼ncelle
                updateGroupMappingsAfterIdChange(oldToNewIdMap);
                
                renderTree();
                updateCategoryWeights();
                updateAssessmentView();
                
                // Ã–ÄŸrenci grup bilgilerini gÃ¼ncelle
                updateStudentGroupInfoDisplay();
                
                showModernToast(`${copiedCount} adet bileÅŸen baÅŸarÄ±yla kopyalandÄ±!`, "success");
                
                // SeÃ§imleri temizle
                clearSelections(section);
                
            } catch (error) {
                console.error("Toplu kopyalama hatasÄ±:", error);
                showModernToast("Kopyalama iÅŸlemi sÄ±rasÄ±nda hata oluÅŸtu!", "error");
            }
        }
    });
}

/**
 * SeÃ§ili dÃ¼ÄŸÃ¼mleri sil
 */
function bulkDeleteNodes(nodeIds, section) {
    // SeÃ§ili bileÅŸenlerin bilgilerini topla
    const selectedComponents = nodeIds.map(nodeId => {
        const node = findNodeById(nodeId);
        return node ? {
            id: nodeId,
            name: node.name || node.type || 'Ä°simsiz',
            type: node.type || 'Bilinmeyen'
        } : null;
    }).filter(Boolean);
    
    // MesajÄ± oluÅŸtur
    let message = `${selectedComponents.length} adet seÃ§ili bileÅŸeni kalÄ±cÄ± olarak silmek istediÄŸinizden emin misiniz?\n\n`;
    
    // EÄŸer 10'dan az bileÅŸen varsa hepsini listele
    if (selectedComponents.length <= 10) {
        message += "Silinecek bileÅŸenler:\n";
        selectedComponents.forEach((comp, index) => {
            message += `${index + 1}. ${comp.id} - ${comp.name} (${comp.type})\n`;
        });
    } else {
        // 10'dan fazla varsa ilk 8'ini gÃ¶ster, sonra "..." ekle
        message += "Silinecek bileÅŸenler (ilk 8 tanesi):\n";
        selectedComponents.slice(0, 8).forEach((comp, index) => {
            message += `${index + 1}. ${comp.id} - ${comp.name} (${comp.type})\n`;
        });
        message += `... ve ${selectedComponents.length - 8} tane daha\n`;
    }
    
    message += "\nâš ï¸ Bu iÅŸlem geri alÄ±namaz!";
    
    showModernConfirm(
        'SeÃ§ili BileÅŸenleri Sil',
        message,
        {
            confirmText: 'Evet, Sil',
            cancelText: 'Ä°ptal',
            headerClass: 'danger-action',
            iconClass: 'danger'
        }
    ).then(confirmed => {
        if (confirmed) {
            try {
                let deletedCount = 0;
                
                // Silme iÅŸlemini ters sÄ±rada yap (alt dÃ¼ÄŸÃ¼mlerden baÅŸlayarak)
                nodeIds.reverse().forEach(nodeId => {
                    if (deleteNodeSilently(nodeId)) {
                        deletedCount++;
                    }
                });
                
                // TÃ¼m ID'leri yeniden dÃ¼zenle
                reorganizeAllIds();
                
                renderTree();
                updateCategoryWeights();
                updateAssessmentView();
                
                // Ã–ÄŸrenci grup bilgilerini gÃ¼ncelle
                updateStudentGroupInfoDisplay();
                
                showModernToast(`${deletedCount} adet bileÅŸen baÅŸarÄ±yla silindi!`, "success");
                
                // SeÃ§imleri temizle
                clearSelections(section);
                
            } catch (error) {
                console.error("Toplu silme hatasÄ±:", error);
                showModernToast("Silme iÅŸlemi sÄ±rasÄ±nda hata oluÅŸtu!", "error");
            }
        }
    });
}

/**
 * DÃ¼ÄŸÃ¼m kopyalama (derin kopya) - Ana etkinlikler iÃ§in
 */
function deepCopyNode(node, targetSection) {
    const prefix = targetSection === 'term' ? 'A' : 'F';
    const existingNodes = APP_STATE.assessmentTree.filter(n => n.id.startsWith(prefix));
    const newIndex = existingNodes.length + 1;
    const newId = `${prefix}${newIndex}`;
    
    const copiedNode = {
        id: newId,
        name: `${node.name} (Kopya)`,
        type: node.type,
        weight: node.weight || 0,
        points: node.points || 0,
        outcomes: Array.isArray(node.outcomes) ? [...node.outcomes] : node.outcomes,
        description: node.description || '',
        expanded: node.expanded || false,
        children: []
    };
    
    // Alt dÃ¼ÄŸÃ¼mleri de kopyala
    if (node.children && node.children.length > 0) {
        node.children.forEach((child, index) => {
            const childCopy = {
                id: `${newId}.${index + 1}`,
                name: child.name,
                type: child.type,
                weight: child.weight || 0,
                points: child.points || 0,
                outcomes: Array.isArray(child.outcomes) ? [...child.outcomes] : child.outcomes,
                description: child.description || '',
                expanded: child.expanded || false,
                children: []
            };
            copiedNode.children.push(childCopy);
        });
    }
    
    return copiedNode;
}

/**
 * Alt bileÅŸen kopyalama - Parent etkinliÄŸin iÃ§ine
 */
function deepCopySubComponent(subComponent, parentNode) {
    // Parent'Ä±n mevcut alt bileÅŸen sayÄ±sÄ±nÄ± al
    const existingChildrenCount = parentNode.children ? parentNode.children.length : 0;
    const newIndex = existingChildrenCount + 1;
    const newId = `${parentNode.id}.${newIndex}`;
    
    const copiedSubComponent = {
        id: newId,
        name: `${subComponent.name} (Kopya)`,
        type: subComponent.type,
        weight: subComponent.weight || 0,
        points: subComponent.points || 0,
        outcomes: Array.isArray(subComponent.outcomes) ? [...subComponent.outcomes] : subComponent.outcomes,
        description: subComponent.description || '',
        expanded: subComponent.expanded || false,
        children: []
    };
    
    // EÄŸer alt bileÅŸenin de Ã§ocuklarÄ± varsa onlarÄ± da kopyala (deep copy)
    if (subComponent.children && subComponent.children.length > 0) {
        subComponent.children.forEach((child, index) => {
            const childCopy = {
                id: `${newId}.${index + 1}`,
                name: child.name,
                type: child.type,
                weight: child.weight || 0,
                points: child.points || 0,
                outcomes: Array.isArray(child.outcomes) ? [...child.outcomes] : child.outcomes,
                description: child.description || '',
                expanded: child.expanded || false,
                children: []
            };
            copiedSubComponent.children.push(childCopy);
        });
    }
    
    return copiedSubComponent;
}

/**
 * Etkinlik grup haritalamalarÄ±nÄ± kopyala
 * @param {string} sourceActivityId - Kaynak etkinlik ID'si
 * @param {string} targetActivityId - Hedef etkinlik ID'si
 */
function copyGroupMappingsForActivity(sourceActivityId, targetActivityId) {
    if (!APP_STATE.courseData?.grupHaritalari) {
        APP_STATE.courseData.grupHaritalari = {};
    }
    
    const sourceMapping = APP_STATE.courseData.grupHaritalari[sourceActivityId];
    
    if (sourceMapping) {
        // Kaynak haritalamayÄ± derin kopya ile kopyala
        const targetMapping = JSON.parse(JSON.stringify(sourceMapping));
        
        // Hedef etkinlik iÃ§in haritalamayÄ± kaydet
        APP_STATE.courseData.grupHaritalari[targetActivityId] = targetMapping;
        
        console.log(`âœ… Grup haritalama kopyalandÄ±: ${sourceActivityId} â†’ ${targetActivityId}`);
    } else {
        // Kaynak haritalama yoksa varsayÄ±lan oluÅŸtur
        APP_STATE.courseData.grupHaritalari[targetActivityId] = {
            gruplar: ["A"],
            haritalar: {
                "A": {}
            }
        };
        
        console.log(`âœ… VarsayÄ±lan grup haritalama oluÅŸturuldu: ${targetActivityId}`);
    }
}

/**
 * Alt bileÅŸeni parent'Ä±n grup haritalamalarÄ±na ekle
 * @param {string} parentId - Parent etkinlik ID'si
 * @param {string} subComponentId - Alt bileÅŸen ID'si
 */
function addSubComponentToGroupMappings(parentId, subComponentId) {
    if (!APP_STATE.courseData?.grupHaritalari?.[parentId]) {
        // Parent iÃ§in grup haritalama yoksa oluÅŸtur
        APP_STATE.courseData.grupHaritalari[parentId] = {
            gruplar: ["A"],
            haritalar: {
                "A": {}
            }
        };
    }
    
    const parentMapping = APP_STATE.courseData.grupHaritalari[parentId];
    
    // Her grup iÃ§in yeni alt bileÅŸeni ekle
    parentMapping.gruplar.forEach(groupName => {
        if (!parentMapping.haritalar[groupName]) {
            parentMapping.haritalar[groupName] = {};
        }
        
        // Bu grupta kaÃ§ alt bileÅŸen var, ona gÃ¶re sÄ±ra numarasÄ± ver
        const existingMappings = parentMapping.haritalar[groupName];
        const nextPosition = Object.keys(existingMappings).length + 1;
        
        // Yeni alt bileÅŸeni haritalamaya ekle
        parentMapping.haritalar[groupName][subComponentId] = nextPosition.toString();
        
                 console.log(`âœ… Alt bileÅŸen grup haritalamaya eklendi: ${subComponentId} â†’ ${parentId} (Grup: ${groupName}, SÄ±ra: ${nextPosition})`);
     });
}

/**
 * ID deÄŸiÅŸikliÄŸi sonrasÄ± grup haritalamalarÄ±nÄ± gÃ¼ncelle
 * @param {Object} oldToNewIdMap - Eski ID'den yeni ID'ye mapping
 */
function updateGroupMappingsAfterIdChange(oldToNewIdMap) {
    if (!APP_STATE.courseData?.grupHaritalari || !oldToNewIdMap) {
        return;
    }
    
    const updatedMappings = {};
    
    // Her etkinlik iÃ§in grup haritalamalarÄ±nÄ± gÃ¼ncelle
    Object.keys(APP_STATE.courseData.grupHaritalari).forEach(activityId => {
        const newActivityId = oldToNewIdMap[activityId] || activityId;
        const activityMapping = APP_STATE.courseData.grupHaritalari[activityId];
        
        if (activityMapping && activityMapping.haritalar) {
            const updatedActivityMapping = {
                gruplar: [...activityMapping.gruplar],
                haritalar: {}
            };
            
            // Her grup iÃ§in haritalamayÄ± gÃ¼ncelle
            Object.keys(activityMapping.haritalar).forEach(groupName => {
                const groupMapping = activityMapping.haritalar[groupName];
                const updatedGroupMapping = {};
                
                // Her alt bileÅŸen iÃ§in ID'yi gÃ¼ncelle
                Object.keys(groupMapping).forEach(oldSubId => {
                    const newSubId = oldToNewIdMap[oldSubId] || oldSubId;
                    const position = groupMapping[oldSubId];
                    updatedGroupMapping[newSubId] = position;
                    
                    if (oldSubId !== newSubId) {
                        console.log(`ğŸ”„ Grup haritalama ID gÃ¼ncellendi: ${oldSubId} â†’ ${newSubId} (Grup: ${groupName})`);
                    }
                });
                
                updatedActivityMapping.haritalar[groupName] = updatedGroupMapping;
            });
            
            updatedMappings[newActivityId] = updatedActivityMapping;
            
            if (activityId !== newActivityId) {
                console.log(`ğŸ”„ Etkinlik grup haritalama ID gÃ¼ncellendi: ${activityId} â†’ ${newActivityId}`);
            }
        }
    });
    
    // GÃ¼ncellenmiÅŸ haritalamayÄ± kaydet
    APP_STATE.courseData.grupHaritalari = updatedMappings;
    
    console.log('âœ… TÃ¼m grup haritalamalar ID deÄŸiÅŸikliÄŸi sonrasÄ± gÃ¼ncellendi');
}

/**
 * SeÃ§imleri temizle
 */
function clearSelections(section) {
    const sectionClass = section === 'term' ? '.term-section' : '.final-section';
    const checkboxes = document.querySelectorAll(`${sectionClass} .node-select-checkbox`);
    checkboxes.forEach(cb => cb.checked = false);
    
    const selectAllCheckbox = document.getElementById(`selectAll${section.charAt(0).toUpperCase() + section.slice(1)}`);
    if (selectAllCheckbox) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    }
    
    updateBulkActionButtons(section);
}

/**
 * DÃ¼ÄŸÃ¼m silme - sessiz silme (onay modalÄ± olmadan)
 * @param {string} nodeId - Silinecek dÃ¼ÄŸÃ¼m ID'si
 * @returns {boolean} - Silme baÅŸarÄ±lÄ± mÄ±
 */
function deleteNodeSilently(nodeId) {
    if (!nodeId) return false;
    
    try {
        // DÃ¼ÄŸÃ¼mÃ¼ bul
        const node = findNodeById(nodeId);
        if (!node) return false;
        
        // SeÃ§ili dÃ¼ÄŸÃ¼m siliniyorsa seÃ§imi kaldÄ±r
        if (APP_STATE.selectedNode && APP_STATE.selectedNode.id === nodeId) {
            APP_STATE.selectedNode = null;
        }
        
        // KÃ¶k dÃ¼ÄŸÃ¼m mÃ¼ kontrol et
        const isRoot = !nodeId.includes('.');
        
        if (isRoot) {
            // KÃ¶k dÃ¼ÄŸÃ¼mÃ¼ sil
            const index = APP_STATE.assessmentTree.findIndex(node => node.id === nodeId);
            if (index !== -1) {
                APP_STATE.assessmentTree.splice(index, 1);
                return true;
            }
        } else {
            // Alt dÃ¼ÄŸÃ¼mÃ¼ sil
            const parentId = nodeId.substring(0, nodeId.lastIndexOf('.'));
            const findParentAndRemoveChild = (nodes, id) => {
                for (let i = 0; i < nodes.length; i++) {
                    const node = nodes[i];
                    if (node.id === parentId && node.children) {
                        const childIndex = node.children.findIndex(child => child.id === id);
                        if (childIndex !== -1) {
                            node.children.splice(childIndex, 1);
                            return true;
                        }
                    }
                    
                    if (node.children && node.children.length > 0) {
                        if (findParentAndRemoveChild(node.children, id)) {
                            return true;
                        }
                    }
                }
                return false;
            };
            
            const deleted = findParentAndRemoveChild(APP_STATE.assessmentTree, nodeId);
            
            // EÄŸer alt dÃ¼ÄŸÃ¼m silindiyse, Ã¼st dÃ¼ÄŸÃ¼mÃ¼n ID'lerini yeniden sÄ±rala
            if (deleted) {
                const parentNode = findNodeById(parentId);
                if (parentNode) {
                    reorderChildNodeIds(parentNode);
                }
                
                // DeÄŸerlendirme sekmesini gÃ¼ncelle - CRITICAL SYNC  
                updateAssessmentView();
                
                // DÃœZELTME: Silinen soru iÃ§in grup haritalamalarÄ±nÄ± temizle
                // Ã–NEMLÄ°: ID yeniden sÄ±ralama sonrasÄ± grup temizliÄŸi yap
                cleanupGroupMappingsForDeletedNode(nodeId);
            }
            
            return deleted;
        }
        
        return false;
        
    } catch (error) {
        console.error(`DÃ¼ÄŸÃ¼m ${nodeId} silinirken hata:`, error);
        return false;
    }
}

/**
 * DÃ¼ÄŸÃ¼m silme - ID'ye gÃ¶re silme yapan versiyon
 * @param {string} nodeId - Silinecek dÃ¼ÄŸÃ¼m ID'si
 */
function deleteNode(nodeId) {
    if (!nodeId) return;
    
    // Silme onayÄ± iste
    const node = findNodeById(nodeId);
    if (!node) return;
    
    // Modern silme onay modalÄ±nÄ± gÃ¶ster
    showDeleteConfirmModal(
        // Onay verildiÄŸinde Ã§alÄ±ÅŸacak fonksiyon
        function() {
            try {
                // SeÃ§ili dÃ¼ÄŸÃ¼m siliniyorsa seÃ§imi kaldÄ±r
                if (APP_STATE.selectedNode && APP_STATE.selectedNode.id === nodeId) {
                    APP_STATE.selectedNode = null;
                }
                
                // KÃ¶k dÃ¼ÄŸÃ¼m mÃ¼ kontrol et
                const isRoot = !nodeId.includes('.');
                
                if (isRoot) {
                    // KÃ¶k dÃ¼ÄŸÃ¼mÃ¼ sil
                    const index = APP_STATE.assessmentTree.findIndex(node => node.id === nodeId);
                    if (index !== -1) {
                        APP_STATE.assessmentTree.splice(index, 1);
                    }
                } else {
                    // Alt dÃ¼ÄŸÃ¼mÃ¼ sil
                    const parentId = nodeId.substring(0, nodeId.lastIndexOf('.'));
                    const findParentAndRemoveChild = (nodes, id) => {
                        for (let i = 0; i < nodes.length; i++) {
                            const node = nodes[i];
                            if (node.id === parentId && node.children) {
                                const childIndex = node.children.findIndex(child => child.id === id);
                                if (childIndex !== -1) {
                                    node.children.splice(childIndex, 1);
                                    return true;
                                }
                            }
                            
                            if (node.children && node.children.length > 0) {
                                if (findParentAndRemoveChild(node.children, id)) {
                                    return true;
                                }
                            }
                        }
                        return false;
                    };
                    
                    findParentAndRemoveChild(APP_STATE.assessmentTree, nodeId);
                }
                
                // DÃœZELTME: Ã–nce grup haritalamalarÄ±nÄ± temizle (ID deÄŸiÅŸmeden Ã¶nce)
                cleanupGroupMappingsForDeletedNode(nodeId);
                
                // YENÄ° KOD: EÄŸer bir alt dÃ¼ÄŸÃ¼m silindiyse, Ã¼st dÃ¼ÄŸÃ¼mÃ¼n aÄŸÄ±rlÄ±klarÄ±nÄ± kontrol et
                if (!isRoot) {
                    const parentId = nodeId.substring(0, nodeId.lastIndexOf('.'));
                    const parentNode = findNodeById(parentId);
                    if (parentNode) {
                        // ID'leri yeniden sÄ±rala
                        reorderChildNodeIds(parentNode);
                        checkAndOfferRedistribution(parentNode);
                    }
                }
                
                // AÄŸacÄ± yeniden render et
                renderTree();
                
                // DeÄŸerlendirme sekmesini gÃ¼ncelle
                console.log('ğŸ”„ Soru silindi, deÄŸerlendirme sekmesi gÃ¼ncelleniyor...');
                updateAssessmentView();
                console.log('âœ… DeÄŸerlendirme sekmesi gÃ¼ncelleme tamamlandÄ±');
                
                // Ã–ÄŸrenci grup bilgilerini gÃ¼ncelle
                updateStudentGroupInfoDisplay();
                
                showModernToast("Etkinlik baÅŸarÄ±yla silindi.");
            } catch (error) {
                console.error("DÃ¼ÄŸÃ¼m silinirken hata oluÅŸtu:", error);
                showModernToast("Etkinlik silinemedi!", "error");
            }
        },
        // Silme onay mesajÄ±
        `"${node.name}" etkinliÄŸini ve tÃ¼m alt Ã¶ÄŸelerini silmek istediÄŸinizden emin misiniz?`
    );
}

/**
 * Alt dÃ¼ÄŸÃ¼mlerin ID'lerini yeniden sÄ±ralar
 * Ã–rnek: A1.3 silinirse A1.4 -> A1.3, A1.5 -> A1.4 olur
 * @param {Object} parentNode - Ana dÃ¼ÄŸÃ¼m
 */
function reorderChildNodeIds(parentNode) {
    if (!parentNode || !parentNode.children || parentNode.children.length === 0) {
        return;
    }
    
    console.log(`ğŸ”„ ID yeniden sÄ±ralama baÅŸlÄ±yor: ${parentNode.id}`);
    
    // Eski ID -> Yeni ID mapping'i oluÅŸtur
    const idMapping = {};
    
    // Alt dÃ¼ÄŸÃ¼mleri yeniden numaralandÄ±r
    parentNode.children.forEach((child, index) => {
        const oldId = child.id;
        const newId = `${parentNode.id}.${index + 1}`;
        
        if (oldId !== newId) {
            console.log(`ğŸ“ ID deÄŸiÅŸikliÄŸi: ${oldId} -> ${newId}`);
            
            // ID mapping'e ekle
            idMapping[oldId] = newId;
            
            // Node'un ID'sini gÃ¼ncelle
            child.id = newId;
            
            // EÄŸer bu node'un da Ã§ocuklarÄ± varsa, onlarÄ± da gÃ¼ncelle
            if (child.children && child.children.length > 0) {
                updateChildrenIds(child.children, oldId, newId);
            }
        }
    });
    
    // EÄŸer ID deÄŸiÅŸiklikleri varsa, puan verilerini de gÃ¼ncelle
    if (Object.keys(idMapping).length > 0) {
        updateGradeDataWithNewIds(idMapping);
        
        // DÃœZELTME: Grup haritalamalarÄ±ndaki ID'leri de gÃ¼ncelle
        updateGroupMappingsWithNewIds(parentNode.id, idMapping);
        
        console.log(`âœ… ${Object.keys(idMapping).length} ID gÃ¼ncellendi ve puan verileri taÅŸÄ±ndÄ±`);
    }
}

/**
 * Alt dÃ¼ÄŸÃ¼mlerin ID'lerini recursive olarak gÃ¼nceller
 * @param {Array} children - Alt dÃ¼ÄŸÃ¼mler
 * @param {string} oldParentId - Eski parent ID
 * @param {string} newParentId - Yeni parent ID
 */
function updateChildrenIds(children, oldParentId, newParentId) {
    children.forEach(child => {
        const oldId = child.id;
        const newId = oldId.replace(oldParentId, newParentId);
        child.id = newId;
        
        if (child.children && child.children.length > 0) {
            updateChildrenIds(child.children, oldId, newId);
        }
    });
}

/**
 * Puan verilerini yeni ID'ler ile gÃ¼nceller
 * @param {Object} idMapping - Eski ID -> Yeni ID mapping'i
 */
function updateGradeDataWithNewIds(idMapping) {
    if (!APP_STATE.gradesData) return;
    
    console.log('ğŸ“Š Puan verileri ID mapping ile gÃ¼ncelleniyor...');
    
    // Her Ã¶ÄŸrenci iÃ§in puan verilerini gÃ¼ncelle
    Object.keys(APP_STATE.gradesData).forEach(studentId => {
        const studentGrades = APP_STATE.gradesData[studentId];
        
        // ID mapping'deki her deÄŸiÅŸiklik iÃ§in
        Object.keys(idMapping).forEach(oldId => {
            const newId = idMapping[oldId];
            
            // DoÄŸrudan ID eÅŸleÅŸmesi
            if (studentGrades[oldId] !== undefined) {
                studentGrades[newId] = studentGrades[oldId];
                delete studentGrades[oldId];
                console.log(`  ğŸ“ ${studentId}: ${oldId} -> ${newId} puanÄ± taÅŸÄ±ndÄ±`);
            }
            
            // Parent ID bazlÄ± eÅŸleÅŸme (A1.1 -> A1[1] formatÄ±)
            const oldParentId = oldId.substring(0, oldId.lastIndexOf('.'));
            const newParentId = newId.substring(0, newId.lastIndexOf('.'));
            
            if (studentGrades[oldParentId] && typeof studentGrades[oldParentId] === 'object') {
                // Tam ID ile eÅŸleÅŸme
                if (studentGrades[oldParentId][oldId] !== undefined) {
                    if (!studentGrades[newParentId]) studentGrades[newParentId] = {};
                    studentGrades[newParentId][newId] = studentGrades[oldParentId][oldId];
                    delete studentGrades[oldParentId][oldId];
                    console.log(`  ğŸ“ ${studentId}: ${oldParentId}[${oldId}] -> ${newParentId}[${newId}] puanÄ± taÅŸÄ±ndÄ±`);
                }
                
                // KÄ±sa ID ile eÅŸleÅŸme (A1.1 -> 1)
                const oldShortId = oldId.split('.').pop();
                const newShortId = newId.split('.').pop();
                
                if (studentGrades[oldParentId][oldShortId] !== undefined && oldShortId !== newShortId) {
                    if (!studentGrades[newParentId]) studentGrades[newParentId] = {};
                    studentGrades[newParentId][newShortId] = studentGrades[oldParentId][oldShortId];
                    delete studentGrades[oldParentId][oldShortId];
                    console.log(`  ğŸ“ ${studentId}: ${oldParentId}[${oldShortId}] -> ${newParentId}[${newShortId}] puanÄ± taÅŸÄ±ndÄ±`);
                }
            }
        });
    });
}

// GUID sistemi kaldÄ±rÄ±ldÄ± - findNodeByGuid fonksiyonu temizlendi

/**
 * Ã–ÄŸrenme Ã§Ä±ktÄ±larÄ±nÄ± listele
 */
function renderOutcomes() {
    try {
        console.log('renderOutcomes Ã§aÄŸrÄ±ldÄ±, APP_STATE.learningOutcomes:', APP_STATE.learningOutcomes);
        outcomesList.innerHTML = '';
        
        if (!APP_STATE.learningOutcomes || APP_STATE.learningOutcomes.length === 0) {
            console.log('Ã–Ã‡ verisi boÅŸ veya yok');
            const emptyMessage = document.createElement('div');
            emptyMessage.className = 'outcomes-empty-message';
            emptyMessage.textContent = 'HenÃ¼z Ã¶ÄŸrenme Ã§Ä±ktÄ±sÄ± tanÄ±mlanmadÄ±. Ders JSON yÃ¼kleyin.';
            outcomesList.appendChild(emptyMessage);
            return;
        }
        
        APP_STATE.learningOutcomes.forEach(outcome => {
            const item = document.createElement('div');
            item.className = 'outcome-item';
            item.textContent = `${outcome.id}: ${outcome.aciklama}`;
            item.title = outcome.aciklama;
            item.dataset.id = outcome.id;
            
            // Ã‡Ä±ktÄ±ya tÄ±klayarak deÄŸerlendirme aÄŸacÄ±nda seÃ§ili dÃ¼ÄŸÃ¼me ekleme
            item.addEventListener('click', () => {
                if (APP_STATE.selectedNode) {
                    const outcomesInput = document.querySelector(`.tree-node[data-id="${APP_STATE.selectedNode.id}"] .nodeOutcomes`);
                    if (outcomesInput) {
                        const currentValue = outcomesInput.value.trim();
                        
                        // Alt dÃ¼ÄŸÃ¼m ise (soru veya rubrik), sadece bir Ã–Ã‡ atanabilsin
                        const isSubItem = APP_STATE.selectedNode.id.includes('.');
                        
                        if (isSubItem) {
                            outcomesInput.value = outcome.id;
                        } else {
                            // DeÄŸer boÅŸsa veya virgÃ¼lle bitiyorsa
                            if (!currentValue) {
                                outcomesInput.value = outcome.id;
                            } else if (currentValue.endsWith(',')) {
                                outcomesInput.value = currentValue + ' ' + outcome.id;
                            } else {
                                outcomesInput.value = currentValue + ', ' + outcome.id;
                            }
                        }
                        
                        // DeÄŸeri deÄŸiÅŸmiÅŸ gibi tetikle
                        outcomesInput.dispatchEvent(new Event('change'));
                        
                        showModernToast(`"${outcome.id}" Ã¶ÄŸrenme Ã§Ä±ktÄ±sÄ± eklendi.`);
                    }
                } else {
                    showModernToast("LÃ¼tfen Ã¶nce bir etkinlik seÃ§in.", "warning");
                }
            });
            
            outcomesList.appendChild(item);
        });
        
        // Ä°Ã§erik deÄŸiÅŸtikten sonra collapsible yÃ¼ksekliklerini gÃ¼ncelle
        setTimeout(() => {
            initializeCollapsibleSections();
        }, 100);
    } catch (error) {
        console.error("Ã–ÄŸrenme Ã§Ä±ktÄ±larÄ± render edilirken hata oluÅŸtu:", error);
        showModernToast("Ã–ÄŸrenme Ã§Ä±ktÄ±larÄ± yÃ¼klenirken hata oluÅŸtu!", "error");
    }
}

/**
 * Program Ã§Ä±ktÄ±larÄ±nÄ± render etme
 */
function renderProgramOutcomes() {
    try {
        programOutcomesList.innerHTML = '';
        
        if (!APP_STATE.programOutcomes || APP_STATE.programOutcomes.length === 0) {
            const emptyMessage = document.createElement('div');
            emptyMessage.className = 'outcomes-empty-message';
            emptyMessage.textContent = 'HenÃ¼z program Ã§Ä±ktÄ±sÄ± tanÄ±mlanmadÄ±. Ders JSON yÃ¼kleyin.';
            programOutcomesList.appendChild(emptyMessage);
            return;
        }
        
        APP_STATE.programOutcomes.forEach(programOutcome => {
            const item = document.createElement('div');
            item.className = 'outcome-item program-outcome-item';
            
            // Program Ã§Ä±ktÄ±sÄ± iÃ§eriÄŸini oluÅŸtur
            const header = document.createElement('div');
            header.className = 'program-outcome-header';
            header.innerHTML = `
                <span class="program-outcome-id">${programOutcome.id}</span>
                <span class="program-outcome-category">${programOutcome.kategori}</span>
            `;
            
            const description = document.createElement('div');
            description.className = 'program-outcome-description';
            description.textContent = programOutcome.aciklama;
            
            item.appendChild(header);
            item.appendChild(description);
            item.title = `${programOutcome.id} - ${programOutcome.kategori}: ${programOutcome.aciklama}`;
            item.dataset.id = programOutcome.id;
            
            programOutcomesList.appendChild(item);
        });
        
        // Ä°Ã§erik deÄŸiÅŸtikten sonra collapsible yÃ¼ksekliklerini gÃ¼ncelle
        setTimeout(() => {
            initializeCollapsibleSections();
        }, 100);
    } catch (error) {
        console.error("Program Ã§Ä±ktÄ±larÄ± render edilirken hata oluÅŸtu:", error);
        showModernToast("Program Ã§Ä±ktÄ±larÄ± yÃ¼klenirken hata oluÅŸtu!", "error");
    }
}

/**
 * Ders detaylarÄ±nÄ± render etme
 */
function renderCourseDetails() {
    try {
        console.log('renderCourseDetails Ã§aÄŸrÄ±ldÄ±');
        console.log('APP_STATE.courseData:', APP_STATE.courseData);
        console.log('courseDetailsContainer:', courseDetailsContainer);
        
        if (!APP_STATE.courseData) {
            console.log('courseData yok - boÅŸ mesaj gÃ¶steriliyor');
            courseDetailsContainer.innerHTML = '<div class="details-empty-message">Ders detaylarÄ± iÃ§in JSON yÃ¼kleyin.</div>';
            return;
        }

        const { dersBilgisi, dersGenel, dersIcerik, haftalikDersIcerikleri } = APP_STATE.courseData;
        
        console.log('Veri parse ediliyor:');
        console.log('dersBilgisi:', dersBilgisi);
        console.log('dersGenel:', dersGenel);
        console.log('dersIcerik:', dersIcerik);
        console.log('haftalikDersIcerikleri:', haftalikDersIcerikleri);
        
        let html = '';
        
        // Ders Bilgisi (Yeni)
        if (dersBilgisi) {
            html += `
                <div class="details-section">
                    <h4 class="details-section-title">
                        <span class="section-icon">ğŸ“š</span>
                        Ders Bilgisi
                    </h4>
                    <div class="details-grid">
                        <div class="detail-item">
                            <span class="detail-label">Ders Kodu:</span>
                            <span class="detail-value">${dersBilgisi.dersKodu || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Ders AdÄ±:</span>
                            <span class="detail-value">${dersBilgisi.dersAdi || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Akademik YÄ±l:</span>
                            <span class="detail-value">${dersBilgisi.akademikYil || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">DÃ¶nem:</span>
                            <span class="detail-value">${dersBilgisi.donem || '-'}</span>
                        </div>
                        <div class="detail-item full-width">
                            <span class="detail-label">Ã–ÄŸretim Ãœyesi:</span>
                            <span class="detail-value">${dersBilgisi.ogretimUyesi || '-'}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Genel Bilgiler
        if (dersGenel) {
            html += `
                <div class="details-section">
                    <h4 class="details-section-title">
                        <span class="section-icon">ğŸ“š</span>
                        Genel Bilgiler
                    </h4>
                    <div class="details-grid">
                        <div class="detail-item">
                            <span class="detail-label">Ders Kodu:</span>
                            <span class="detail-value">${dersGenel.dersKodu || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Ders AdÄ±:</span>
                            <span class="detail-value">${dersGenel.dersAdi || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Ders TÃ¼rÃ¼:</span>
                            <span class="detail-value">${dersGenel.dersTuru || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Seviye:</span>
                            <span class="detail-value">${dersGenel.dersinSeviyesi || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">YarÄ±yÄ±l:</span>
                            <span class="detail-value">${dersGenel.dersinVerildigiYariyil || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Akademik YÄ±l:</span>
                            <span class="detail-value">${dersGenel.akademikYil || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Kredi:</span>
                            <span class="detail-value">${dersGenel.dersKredisi || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">AKTS:</span>
                            <span class="detail-value">${dersGenel.dersAKTSKredisi || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Kuramsal Saat:</span>
                            <span class="detail-value">${dersGenel.haftalikDersSaatiKuramsal || 0}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Uygulama Saat:</span>
                            <span class="detail-value">${dersGenel.haftalikUygulamaSaati || 0}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Laboratuvar Saat:</span>
                            <span class="detail-value">${dersGenel.haftalikLaboratuarSaati || 0}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">EÄŸitim Dili:</span>
                            <span class="detail-value">${dersGenel.egitimDili || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Ãœniversite:</span>
                            <span class="detail-value">${dersGenel.universite || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">FakÃ¼lte:</span>
                            <span class="detail-value">${dersGenel.fakulte || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">BÃ¶lÃ¼m:</span>
                            <span class="detail-value">${dersGenel.bolum || '-'}</span>
                        </div>
                        <div class="detail-item full-width">
                            <span class="detail-label">MÃ¼fredat YÄ±lÄ±:</span>
                            <span class="detail-value">${dersGenel.mufredatOlusturulmaYili || '-'}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Ders Ä°Ã§eriÄŸi
        if (dersIcerik) {
            html += `
                <div class="details-section">
                    <h4 class="details-section-title">
                        <span class="section-icon">ğŸ“–</span>
                        Ders Ä°Ã§eriÄŸi ve DetaylarÄ±
                    </h4>
                    <div class="content-details">
                        <div class="content-item">
                            <h5>ğŸ“‹ Dersin AmacÄ±</h5>
                            <p>${dersIcerik.dersinAmaci || '-'}</p>
                        </div>
                        <div class="content-item">
                            <h5>ğŸ“š Dersin Ä°Ã§eriÄŸi</h5>
                            <p>${dersIcerik.dersinIcerigi || '-'}</p>
                        </div>
                        <div class="content-item">
                            <h5>âš ï¸ Ã–n KoÅŸul Dersler</h5>
                            <p>${dersIcerik.dersinOnKosuluOlanDersler || '-'}</p>
                        </div>
                        <div class="content-item">
                            <h5>ğŸ’¡ Ã–nerilen Hususlar</h5>
                            <p>${dersIcerik.dersinIcinOnerilenHususlar || '-'}</p>
                        </div>
                        <div class="content-item">
                            <h5>ğŸ“š Kaynaklar ve Materyaller</h5>
                            <pre class="sources-text">${dersIcerik.dersinKitabiMalzemesiOnerilenKaynaklar || '-'}</pre>
                        </div>
                        <div class="instructor-info">
                            <h5>ğŸ‘¨â€ğŸ« Ã–ÄŸretim Ãœyesi Bilgileri</h5>
                            <div class="instructor-details">
                                <p><strong>Ad:</strong> ${dersIcerik.dersiVerenOgretimUyesiOgretimGorevlisi || '-'}</p>
                                <p><strong>E-mail:</strong> ${dersIcerik.email || '-'}</p>
                                <p><strong>Avesis:</strong> <a href="${dersIcerik.avesisProfile || '#'}" target="_blank">${dersIcerik.avesisProfile || '-'}</a></p>
                                <p><strong>HazÄ±rlama Tarihi:</strong> ${dersIcerik.hazirlanmaTarihi || '-'}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // HaftalÄ±k Ders Ä°Ã§erikleri
        if (haftalikDersIcerikleri && haftalikDersIcerikleri.length > 0) {
            html += `
                <div class="details-section">
                    <h4 class="details-section-title">
                        <span class="section-icon">ğŸ“…</span>
                        HaftalÄ±k Ders Ä°Ã§erikleri (${haftalikDersIcerikleri.length} Hafta)
                    </h4>
                    <div class="weekly-content">
                        ${haftalikDersIcerikleri.map(hafta => `
                            <div class="week-item ${hafta.hafta === 8 || hafta.hafta === 16 ? 'exam-week' : ''}">
                                <div class="week-header">
                                    <span class="week-number">Hafta ${hafta.hafta}</span>
                                    <span class="week-outcomes">${hafta.iliskiliOgrenmeÃ‡iktisi || '-'}</span>
                                </div>
                                <div class="week-content">
                                    <p class="week-description">${hafta.icerik || '-'}</p>
                                    <div class="week-details">
                                        <div class="week-detail">
                                            <strong>ğŸ›ï¸ Ortam:</strong> ${hafta.ogretimOrtami || '-'}
                                        </div>
                                        <div class="week-detail">
                                            <strong>ğŸ“š Ã–n HazÄ±rlÄ±k:</strong> ${hafta.onHazirlik || '-'}
                                        </div>
                                        <div class="week-detail">
                                            <strong>ğŸ¯ YÃ¶ntem:</strong> ${hafta.ogretimYontemleri || '-'}
                                        </div>
                                        ${hafta.odevVeCalisma && hafta.odevVeCalisma !== '-' ? `
                                            <div class="week-detail">
                                                <strong>ğŸ“ Ã–dev/Ã‡alÄ±ÅŸma:</strong> ${hafta.odevVeCalisma}
                                            </div>
                                        ` : ''}
                                        ${hafta.degerlendirmeYontemleri && hafta.degerlendirmeYontemleri !== '-' ? `
                                            <div class="week-detail evaluation">
                                                <strong>ğŸ“Š DeÄŸerlendirme:</strong> ${hafta.degerlendirmeYontemleri}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        console.log('HTML iÃ§eriÄŸi oluÅŸturuldu, uzunluk:', html.length);
        console.log('HTML ilk 300 karakter:', html.substring(0, 300));
        
        courseDetailsContainer.innerHTML = html;
        
        console.log('HTML container\'a eklendi, ÅŸu anki iÃ§erik:', courseDetailsContainer.innerHTML.substring(0, 100));
        
        // Ä°Ã§erik deÄŸiÅŸtikten sonra collapsible yÃ¼ksekliklerini gÃ¼ncelle
        setTimeout(() => {
            initializeCollapsibleSections();
        }, 100);
        
    } catch (error) {
        console.error("Ders detaylarÄ± render edilirken hata oluÅŸtu:", error);
        showModernToast("Ders detaylarÄ± yÃ¼klenirken hata oluÅŸtu!", "error");
    }
}

/**
 * Ã–Ã‡-PÃ‡ Ä°liÅŸki Matrisini render etme - Yeni basit versiyon
 */
function renderOutcomeMatrix() {
    try {
        if (!APP_STATE.outcomeMatrix || !APP_STATE.learningOutcomes || !APP_STATE.programOutcomes) {
            matrixContainer.innerHTML = '<div class="matrix-empty-message">Ã–Ã‡-PÃ‡ iliÅŸki matrisi iÃ§in ders JSON yÃ¼kleyin.</div>';
            return;
        }

        // Legend oluÅŸtur
        const legend = document.createElement('div');
        legend.className = 'matrix-legend';
        legend.innerHTML = `
            <h4>Ä°liÅŸki Seviyesi</h4>
            <div class="legend-items">
                <span class="legend-item"><span class="legend-color level-0"></span>0 - Ä°liÅŸki Yok</span>
                <span class="legend-item"><span class="legend-color level-1"></span>1 - Ã‡ok ZayÄ±f</span>
                <span class="legend-item"><span class="legend-color level-2"></span>2 - ZayÄ±f</span>
                <span class="legend-item"><span class="legend-color level-3"></span>3 - Orta</span>
                <span class="legend-item"><span class="legend-color level-4"></span>4 - GÃ¼Ã§lÃ¼</span>
                <span class="legend-item"><span class="legend-color level-5"></span>5 - Ã‡ok GÃ¼Ã§lÃ¼</span>
            </div>
        `;

        // Matrix tablosu oluÅŸtur
        const table = document.createElement('table');
        table.className = 'matrix-table';
        
        // Header row
        let headerHTML = '<thead><tr><th class="matrix-corner">Ã–Ã‡ / PÃ‡</th>';
        APP_STATE.programOutcomes.forEach(pc => {
            headerHTML += `<th class="matrix-header" title="${pc.aciklama}">${pc.id}</th>`;
        });
        headerHTML += '</tr></thead>';
        
        // Body rows
        let bodyHTML = '<tbody>';
        APP_STATE.outcomeMatrix.iliskiTablosu.forEach(relation => {
            const learningOutcome = APP_STATE.learningOutcomes.find(lo => lo.id === relation.ogrenmeÃ‡iktisiID);
            bodyHTML += `<tr>`;
            bodyHTML += `<th class="matrix-row-header" title="${learningOutcome ? learningOutcome.aciklama : ''}">${relation.ogrenmeÃ‡iktisiID}</th>`;
            
            APP_STATE.programOutcomes.forEach(pc => {
                const value = relation.programÃ‡iktilariIliskileri[pc.id] || 0;
                bodyHTML += `<td class="matrix-cell level-${value}" data-level="${value}">${value}</td>`;
            });
            
            bodyHTML += `</tr>`;
        });
        bodyHTML += '</tbody>';
        
        table.innerHTML = headerHTML + bodyHTML;
        
        // Container'Ä± temizle ve yeni iÃ§erikleri ekle
        matrixContainer.innerHTML = '';
        matrixContainer.appendChild(legend);
        matrixContainer.appendChild(table);
        
        // Ä°Ã§erik deÄŸiÅŸtikten sonra collapsible yÃ¼ksekliklerini gÃ¼ncelle
        setTimeout(() => {
            initializeCollapsibleSections();
        }, 100);
        
    } catch (error) {
        console.error("Ã–Ã‡-PÃ‡ matrisi render edilirken hata oluÅŸtu:", error);
        showModernToast("Ã–Ã‡-PÃ‡ matrisi yÃ¼klenirken hata oluÅŸtu!", "error");
    }
}

/**
 * Ders bilgilerini gÃ¶rÃ¼ntÃ¼leme
 */
function updateCourseInfo() {
    try {
        if (!APP_STATE.courseData) return;
        
        // Ders kodu ve adÄ±
        const dersKodu = APP_STATE.courseData.dersGenel?.dersKodu || '-';
        const dersAdi = APP_STATE.courseData.dersGenel?.dersAdi || '-';
        courseTitle.textContent = `${dersKodu} - ${dersAdi}`;
        
        // Akademik yÄ±l ve dÃ¶nem
        const akademikYil = APP_STATE.courseData.dersGenel?.akademikYil || '-';
        const donem = APP_STATE.courseData.dersGenel?.dersinVerildigiYariyil || '-';
        const ogretimUyesi = APP_STATE.courseData.dersIcerik?.dersiVerenOgretimUyesiOgretimGorevlisi || '-';
        
        courseDetails.textContent = `Akademik YÄ±l: ${akademikYil} | YarÄ±yÄ±l: ${donem} | Ã–ÄŸr. Ãœyesi: ${ogretimUyesi}`;
        
        // Tarih bilgisi ekle
        courseTerm.textContent = `${akademikYil} (${donem}. YarÄ±yÄ±l)`;
        
        // Ders bilgileri ekranÄ±nÄ± vurgulamak iÃ§in stil ekle
        document.getElementById('courseInfo').style.borderLeft = '5px solid var(--primary-color)';
        document.getElementById('courseInfo').style.backgroundColor = 'var(--secondary-light)';
    } catch (error) {
        console.error("Ders bilgileri gÃ¼ncellenirken hata oluÅŸtu:", error);
    }
}

// =====================================================
// NOT GÄ°RÄ°ÅÄ° VE HESAPLAMA FONKSÄ°YONLARI
// =====================================================

/**
 * DeÄŸerlendirme gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ gÃ¼ncelleme
 */
function updateAssessmentView() {
    console.log('ğŸ¯ updateAssessmentView Ã§aÄŸrÄ±ldÄ± - mevcut aÄŸaÃ§:', APP_STATE.assessmentTree);
    
    try {
        // Konteyner kontrolÃ¼
        if (!assessmentContainer) {
            console.error('âŒ assessmentContainer bulunamadÄ±');
            return;
        }
        
        // Veri kontrolÃ¼
        if (!APP_STATE.assessmentTree?.length || !APP_STATE.studentData?.length) {
            assessmentContainer.innerHTML = `
                <p class="empty-message">DeÄŸerlendirme giriÅŸi yapabilmek iÃ§in hem ders tanÄ±mlama hem de Ã¶ÄŸrenci listesi sekmelerinden gerekli bilgileri yÃ¼klemeniz gerekmektedir.</p>
            `;
            updateAssessmentFilterInfo();
            return;
        }
        
        // Orijinal Ã¶ÄŸrenci verilerini koru
        const originalStudentData = APP_STATE.studentData;
        
        try {
        // FiltrelenmiÅŸ Ã¶ÄŸrenci listesini al
        const filteredStudents = getFilteredStudentsForAssessment();
        
        // GeÃ§ici olarak APP_STATE.studentData'yÄ± deÄŸiÅŸtir
        APP_STATE.studentData = filteredStudents;
        
        // DeÄŸerlendirme konteynerini temizle
        assessmentContainer.innerHTML = '';
        
            // Etkinlikleri kategorilere ayÄ±r
        const termActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('A'));
            const finalActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('F'));
            
            // YarÄ±yÄ±l iÃ§i etkinlikleri render et
            if (termActivities.length > 0) {
                renderActivitySection(
                    'YarÄ±yÄ±l Ä°Ã§i Etkinlikler', 
                    APP_STATE.termWeight || 40, 
                    termActivities, 
                    'term'
                );
            }
            
            // YarÄ±yÄ±l sonu etkinlikleri render et
        if (finalActivities.length > 0) {
                renderActivitySection(
                    'YarÄ±yÄ±l Sonu Etkinlikler', 
                    APP_STATE.finalWeight || 60, 
                    finalActivities, 
                    'final'
                );
            }
            
            // NotlarÄ± hesaplama butonu ekle
            addCalculateGradesButton();
        
        // Filtre bilgisini gÃ¼ncelle
        updateAssessmentFilterInfo();
        
        // Ã–Ã‡ tooltip sistemini baÅŸlat
        setTimeout(() => {
                if (typeof initializeOutcomeTooltips === 'function') {
            initializeOutcomeTooltips();
                }
        }, 100);
        
        } finally {
            // Her durumda orijinal Ã¶ÄŸrenci listesini geri yÃ¼kle
            APP_STATE.studentData = originalStudentData;
        }
        
        // Ek gÃ¼ncellemeler - ders tanÄ±mlama deÄŸiÅŸikliklerini yansÄ±t (grup seÃ§icileri hariÃ§)
        setTimeout(() => {
            console.log('ğŸ”„ Ders tanÄ±mlama deÄŸiÅŸiklikleri yansÄ±tÄ±lÄ±yor (grup seÃ§icileri korunuyor)...');
            // Grup seÃ§icilerini gÃ¼ncelleme - HTML oluÅŸturma sÄ±rasÄ±nda zaten doÄŸru yapÄ±ldÄ±
            // updateGroupSelectors(); // Bu satÄ±rÄ± kaldÄ±rÄ±yoruz
            
            // DiÄŸer bileÅŸenleri gÃ¼ncelle
            if (typeof updateOutcomesTextarea === 'function') {
                updateOutcomesTextarea();
            }
            
            if (typeof updateCategoryWeights === 'function') {
                updateCategoryWeights();
            }
            
            if (typeof updateAllMappingDisplays === 'function') {
                updateAllMappingDisplays();
            }
            
            if (typeof updateAllInlineGroupInputs === 'function') {
                updateAllInlineGroupInputs();
            }
            
            console.log('âœ… Ders tanÄ±mlama deÄŸiÅŸiklikleri yansÄ±tÄ±ldÄ± (grup seÃ§icileri korundu)');
        }, 100);
        
        // DÃœZELTME: Tablo oluÅŸturulduktan sonra grup bazlÄ± maksimum puan gÃ¶sterimini dÃ¼zelt
        setTimeout(() => {
            console.log('ğŸ”„ Grup bazlÄ± maksimum puan gÃ¼ncelleme baÅŸlatÄ±lÄ±yor...');
            
            // TÃ¼m component'ler iÃ§in gÃ¼ncelleme yap
            const allComponents = document.querySelectorAll('[data-component-id]');
            const componentIds = new Set();
            
            allComponents.forEach(element => {
                const componentId = element.getAttribute('data-component-id');
                if (componentId) componentIds.add(componentId);
            });
            
            componentIds.forEach(componentId => {
                APP_STATE.studentData.forEach(student => {
                    const studentCurrentGroup = getStudentGroupForComponent(student.studentId, componentId);
                    // Her Ã¶ÄŸrenci iÃ§in grup bazlÄ± soru bilgilerini gÃ¼ncelle
                    updateQuestionInfoForComponent(student.studentId, studentCurrentGroup, componentId);
                });
            });
            
            console.log('âœ… Grup bazlÄ± maksimum puan gÃ¼ncelleme tamamlandÄ±');
        }, 150);
        
        console.log('âœ… updateAssessmentView tamamlandÄ±');
        
    } catch (error) {
        console.error("âŒ DeÄŸerlendirme gÃ¶rÃ¼nÃ¼mÃ¼ gÃ¼ncellenirken hata oluÅŸtu:", error);
        showModernToast("DeÄŸerlendirme gÃ¶rÃ¼nÃ¼mÃ¼ gÃ¼ncellenemedi!", "error");
    }
}

/**
 * Etkinlik bÃ¶lÃ¼mÃ¼ render etme
 * @param {string} title - BÃ¶lÃ¼m baÅŸlÄ±ÄŸÄ±
 * @param {number} weight - AÄŸÄ±rlÄ±k yÃ¼zdesi
 * @param {Array} activities - Etkinlikler listesi
 * @param {string} type - Etkinlik tipi ('term' veya 'final')
 */
function renderActivitySection(title, weight, activities, type) {
    const header = document.createElement('h3');
    header.textContent = `${title} (${weight}%)`;
    header.className = 'section-title';
    assessmentContainer.appendChild(header);
    
    activities.forEach(activity => {
        try {
            createAssessmentActivitySection(activity, assessmentContainer, type);
        } catch (error) {
            console.error(`âŒ ${activity.id} etkinliÄŸi render edilemedi:`, error);
        }
    });
}

/**
 * NotlarÄ± hesaplama butonu ekle
 */
function addCalculateGradesButton() {
        const calculateButton = document.createElement('button');
        calculateButton.className = 'btn btn-primary';
        calculateButton.style.marginTop = '20px';
        calculateButton.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M5 3a2 2 0 0 0-2 2v14c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2H5zm14 4h-6m-2 4h-2m-4 4h12"></path>
            </svg>
            NotlarÄ± Hesapla
        `;
        calculateButton.addEventListener('click', calculateGrades);
        assessmentContainer.appendChild(calculateButton);
}

/**
 * DeÄŸerlendirme giriÅŸi iÃ§in filtrelenmiÅŸ Ã¶ÄŸrenci listesini al
 */
function getFilteredStudentsForAssessment() {
    try {
    const filterSelect = document.getElementById('assessmentStudentFilter');
        
        // Filtre yoksa veya deÄŸer seÃ§ilmemiÅŸse tÃ¼m Ã¶ÄŸrenciler
    if (!filterSelect || !filterSelect.value) {
            return APP_STATE.studentData || [];
    }
    
    const selectedStudentId = filterSelect.value;
        
        // GÃ¼venlik kontrolÃ¼
        if (!APP_STATE.studentData || !Array.isArray(APP_STATE.studentData)) {
            console.warn('âš ï¸ Ã–ÄŸrenci verisi bulunamadÄ± veya geÃ§ersiz');
            return [];
        }
        
        // FiltrelenmiÅŸ Ã¶ÄŸrenciyi bul
        const filteredStudents = APP_STATE.studentData.filter(student => 
            student && student.studentId === selectedStudentId
        );
        
        if (filteredStudents.length === 0) {
            console.warn(`âš ï¸ ${selectedStudentId} ID'li Ã¶ÄŸrenci bulunamadÄ±`);
        }
        
        return filteredStudents;
        
    } catch (error) {
        console.error('âŒ Ã–ÄŸrenci filtresi hatasÄ±:', error);
        return APP_STATE.studentData || [];
    }
}

/**
 * DeÄŸerlendirme filtresi bilgisini gÃ¼ncelle
 */
function updateAssessmentFilterInfo() {
    try {
    const filterInfo = document.getElementById('assessmentFilterInfo');
    const filterSelect = document.getElementById('assessmentStudentFilter');
    
        if (!filterInfo) {
            console.warn('âš ï¸ assessmentFilterInfo elementi bulunamadÄ±');
            return;
        }
    
        const totalStudents = APP_STATE.studentData?.length || 0;
    const filteredStudents = getFilteredStudentsForAssessment();
    const filteredCount = filteredStudents.length;
    
    if (!filterSelect || !filterSelect.value) {
        // Filtre yok - tÃ¼m Ã¶ÄŸrenciler gÃ¶steriliyor
        filterInfo.innerHTML = `
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="8.5" cy="7" r="4"></circle>
                <line x1="20" y1="8" x2="20" y2="14"></line>
                <line x1="23" y1="11" x2="17" y2="11"></line>
            </svg>
            Toplam ${totalStudents} Ã¶ÄŸrenci gÃ¶steriliyor
        `;
        filterInfo.className = 'filter-info';
    } else {
        // Filtre aktif - seÃ§ili Ã¶ÄŸrenci gÃ¶steriliyor
        const selectedStudent = filteredStudents[0];
            
            if (selectedStudent) {
        filterInfo.innerHTML = `
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
                    ${selectedStudent.studentId} - ${selectedStudent.name} ${selectedStudent.surname}
        `;
        filterInfo.className = 'filter-info filtered';
            } else {
                filterInfo.innerHTML = `
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"/>
                    </svg>
                    Ã–ÄŸrenci bulunamadÄ± (${filterSelect.value})
                `;
                filterInfo.className = 'filter-info error';
            }
        }
        
        console.log(`ğŸ“Š Filtre bilgisi gÃ¼ncellendi: ${filteredCount}/${totalStudents} Ã¶ÄŸrenci`);
        
    } catch (error) {
        console.error('âŒ Filtre bilgisi gÃ¼ncelleme hatasÄ±:', error);
    }
}

/**
 * DeÄŸerlendirme Ã¶ÄŸrenci filtresini baÅŸlat
 */
function initializeAssessmentStudentFilter() {
    const filterSelect = document.getElementById('assessmentStudentFilter');
    if (!filterSelect) return;
    
    // Ã–ÄŸrenci listesini doldur
    updateAssessmentStudentFilterOptions();
    
    // Change event listener ekle
    filterSelect.addEventListener('change', function() {
        updateAssessmentView();
    });
}

/**
 * DeÄŸerlendirme Ã¶ÄŸrenci filtresi seÃ§eneklerini gÃ¼ncelle
 */
function updateAssessmentStudentFilterOptions() {
    try {
    const filterSelect = document.getElementById('assessmentStudentFilter');
        if (!filterSelect) {
            console.warn('âš ï¸ assessmentStudentFilter elementi bulunamadÄ±');
            return;
        }
    
    const currentValue = filterSelect.value;
    
    // SeÃ§enekleri temizle
    filterSelect.innerHTML = '<option value="">TÃ¼m Ã–ÄŸrenciler</option>';
        
        // Ã–ÄŸrenci verisi kontrolÃ¼
        if (!APP_STATE.studentData || !Array.isArray(APP_STATE.studentData)) {
            console.warn('âš ï¸ Ã–ÄŸrenci verisi bulunamadÄ±, filtre seÃ§enekleri boÅŸ bÄ±rakÄ±lÄ±yor');
            updateAssessmentFilterInfo();
            return;
        }
    
    // Ã–ÄŸrenci seÃ§eneklerini ekle
        let addedCount = 0;
    APP_STATE.studentData.forEach(student => {
            try {
                if (!student || !student.studentId) {
                    console.warn('âš ï¸ GeÃ§ersiz Ã¶ÄŸrenci verisi atlandÄ±:', student);
                    return;
                }
                
        const option = document.createElement('option');
        option.value = student.studentId;
                option.textContent = `${student.studentId} - ${student.name || 'Ad Yok'} ${student.surname || 'Soyad Yok'}`;
        
        if (student.studentId === currentValue) {
            option.selected = true;
        }
        
        filterSelect.appendChild(option);
                addedCount++;
                
            } catch (error) {
                console.error('âŒ Ã–ÄŸrenci seÃ§eneÄŸi eklenirken hata:', error, student);
            }
    });
        
        console.log(`ğŸ“ ${addedCount} Ã¶ÄŸrenci filtre seÃ§eneÄŸi eklendi`);
    
    // Filtre bilgisini gÃ¼ncelle
    updateAssessmentFilterInfo();
        
    } catch (error) {
        console.error('âŒ Ã–ÄŸrenci filtre seÃ§enekleri gÃ¼ncelleme hatasÄ±:', error);
    }
}

/**
 * Tek Ã¶ÄŸrenci iÃ§in anlÄ±k not hesaplama (DeÄŸerlendirme tablosunda kullanÄ±m iÃ§in)
 * @param {string} studentId - Ã–ÄŸrenci ID'si
 * @returns {Object} - Hesaplanan notlar
 */
function calculateStudentGrades(studentId) {
    try {
        if (!APP_STATE.assessmentTree || APP_STATE.assessmentTree.length === 0) {
            return {
                termGrade: 0.00,
                finalGrade: 0.00, 
                totalGrade: 0.00,
                letterGrade: "FF"
            };
        }
        
        // YarÄ±yÄ±l iÃ§i etkinlikler
        const termActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('A'));
        let termGrade = 0;
        
        // Ä°Ã§ aÄŸÄ±rlÄ±k toplamÄ±
        const termInternalTotal = termActivities.reduce((sum, node) => sum + parseFloat(node.weight || 0), 0);
        
        if (termInternalTotal > 0) {
            termActivities.forEach(activity => {
                // Ä°Ã§ aÄŸÄ±rlÄ±k normalleÅŸtirmesi
                const activityWeight = activity.weight / termInternalTotal; 
                let activityGrade = 0;
                
                if (activity.children && activity.children.length > 0) {
                    // Alt etkinlikler
                    const childrenTotalWeight = activity.children.reduce((sum, child) => sum + parseFloat(child.weight || 0), 0);
                    
                    if (childrenTotalWeight > 0) {
                        activity.children.forEach(subItem => {
                            // Alt Ã¶ÄŸe aÄŸÄ±rlÄ±k normalleÅŸtirmesi
                            const subItemWeight = subItem.weight / childrenTotalWeight; 
                            const grade = getStudentGrade(studentId, subItem.id) || 0;
                            const scaledGrade = (grade / (subItem.points || 1)) * 100; // 100 Ã¼zerinden
                            activityGrade += scaledGrade * subItemWeight;
                        });
                    }
                } else {
                    // Basit etkinlik
                    const grade = getStudentGrade(studentId, activity.id) || 0;
                    activityGrade = (grade / (activity.points || 1)) * 100; // 100 Ã¼zerinden
                }
                
                termGrade += activityGrade * activityWeight;
            });
        }
        
        // YarÄ±yÄ±l sonu etkinlikler
        const finalActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('F'));
        let finalGrade = 0;
        
        // Ä°Ã§ aÄŸÄ±rlÄ±k toplamÄ±
        const finalInternalTotal = finalActivities.reduce((sum, node) => sum + parseFloat(node.weight || 0), 0);
        
        if (finalInternalTotal > 0) {
            finalActivities.forEach(activity => {
                // Ä°Ã§ aÄŸÄ±rlÄ±k normalleÅŸtirmesi
                const activityWeight = activity.weight / finalInternalTotal;
                let activityGrade = 0;
                
                if (activity.children && activity.children.length > 0) {
                    // Alt etkinlikler
                    const childrenTotalWeight = activity.children.reduce((sum, child) => sum + parseFloat(child.weight || 0), 0);
                    
                    if (childrenTotalWeight > 0) {
                        activity.children.forEach(subItem => {
                            // Alt Ã¶ÄŸe aÄŸÄ±rlÄ±k normalleÅŸtirmesi
                            const subItemWeight = subItem.weight / childrenTotalWeight;
                            const grade = getStudentGrade(studentId, subItem.id) || 0;
                            const scaledGrade = (grade / (subItem.points || 1)) * 100; // 100 Ã¼zerinden
                            activityGrade += scaledGrade * subItemWeight;
                        });
                    }
                } else {
                    // Basit etkinlik
                    const grade = getStudentGrade(studentId, activity.id) || 0;
                    activityGrade = (grade / (activity.points || 1)) * 100; // 100 Ã¼zerinden
                }
                
                finalGrade += activityGrade * activityWeight;
            });
        }
        
        // Toplam ve harf notu
        const totalGrade = (termGrade * APP_STATE.termWeight / 100) + (finalGrade * APP_STATE.finalWeight / 100);
        const letterGrade = getLetterGrade(totalGrade);
        
        return {
            termGrade: parseFloat(termGrade.toFixed(2)),
            finalGrade: parseFloat(finalGrade.toFixed(2)),
            totalGrade: parseFloat(totalGrade.toFixed(2)),
            letterGrade: letterGrade
        };
        
    } catch (error) {
        console.error("Ã–ÄŸrenci notlarÄ± hesaplanÄ±rken hata:", error);
        return {
            termGrade: 0.00,
            finalGrade: 0.00,
            totalGrade: 0.00, 
            letterGrade: "FF"
        };
    }
}

/**
 * Harf notuna gÃ¶re CSS sÄ±nÄ±fÄ± getirme
 * @param {string} letterGrade - Harf notu
 * @returns {string} - CSS sÄ±nÄ±fÄ±
 */
function getLetterGradeClass(letterGrade) {
    if (['AA', 'BA', 'BB'].includes(letterGrade)) {
        return 'grade-excellent';
    } else if (['CB', 'CC'].includes(letterGrade)) {
        return 'grade-good';
    } else if (['DC', 'DD'].includes(letterGrade)) {
        return 'grade-pass';
    } else {
        return 'grade-fail';
    }
}

/**
 * DeÄŸerlendirme tablosundaki not Ã¶zeti hÃ¼crelerini gÃ¼ncelle
 * @param {string} studentId - Ã–ÄŸrenci ID'si  
 */
function updateAssessmentGradeSummary(studentId) {
    try {
        // Yeni notlarÄ± hesapla
        const studentGrades = calculateStudentGrades(studentId);
        
        // Bu Ã¶ÄŸrencinin tÃ¼m satÄ±rlarÄ±nÄ± bul
        const studentRows = document.querySelectorAll(`tr[data-student-id="${studentId}"]`);
        
        studentRows.forEach(row => {
            // Not Ã¶zeti hÃ¼crelerini bul ve gÃ¼ncelle
            const termGradeCell = row.querySelector('.grade-summary-cell.term-grade');
            const finalGradeCell = row.querySelector('.grade-summary-cell.final-grade');
            const totalGradeCell = row.querySelector('.grade-summary-cell.total-grade');
            const letterGradeCell = row.querySelector('.grade-summary-cell.letter-grade');
            
            if (termGradeCell) {
                termGradeCell.textContent = studentGrades.termGrade.toFixed(2);
            }
            
            if (finalGradeCell) {
                finalGradeCell.textContent = studentGrades.finalGrade.toFixed(2);
            }
            
            if (totalGradeCell) {
                totalGradeCell.textContent = studentGrades.totalGrade.toFixed(2);
            }
            
            if (letterGradeCell) {
                // Eski CSS sÄ±nÄ±flarÄ±nÄ± kaldÄ±r
                letterGradeCell.classList.remove('grade-excellent', 'grade-good', 'grade-pass', 'grade-fail');
                // Yeni CSS sÄ±nÄ±fÄ±nÄ± ekle
                letterGradeCell.classList.add(getLetterGradeClass(studentGrades.letterGrade));
                letterGradeCell.textContent = studentGrades.letterGrade;
            }
        });
        
    } catch (error) {
        console.error("Assessment not Ã¶zeti gÃ¼ncellenirken hata:", error);
    }
}

/**
 * DeÄŸerlendirme etkinliÄŸi bÃ¶lÃ¼mÃ¼ oluÅŸturma
 * @param {Object} activity - Etkinlik
 * @param {HTMLElement} container - Konteyner elementi
 * @param {string} type - Etkinlik tipi (term/final)
 */
function createAssessmentActivitySection(activity, container, type) {
    console.log(`ğŸ“Š createAssessmentActivitySection Ã§aÄŸrÄ±ldÄ±: ${activity.id} (${activity.name})`);
    try {
        const sectionDiv = document.createElement('div');
        sectionDiv.className = 'assessment-subsection';
        sectionDiv.dataset.activityId = activity.id;
        
        const header = document.createElement('h4');
        header.innerHTML = `${getComponentDisplayName(activity.id)} <span class="badge badge-primary">${activity.weight}%</span>`;
        sectionDiv.appendChild(header);
        
        // Aktivitenin alt Ã¶ÄŸeleri var mÄ± kontrol et
        if (activity.children && activity.children.length > 0) {
            // Test var mÄ± kontrol et
            const hasTest = activity.children.some(child => child.type === 'Test');
            
            if (hasTest) {
                // Test sorularÄ± iÃ§in Ã¶zel giriÅŸ
            activity.children.forEach(subItem => {
                if (subItem.type === 'Test') {
                    createTestInputSection(subItem, sectionDiv);
                }
            });
        } else {
                // Normal sorular iÃ§in kaÄŸÄ±t sÄ±rasÄ± bazÄ±nda tek giriÅŸ
                createComponentPaperOrderInputSection(activity, sectionDiv);
            }
        } else {
            // Alt Ã¶ÄŸe yoksa basit bir puan giriÅŸi gÃ¶ster (Laboratuvar gibi)
            const simpleInputDiv = document.createElement('div');
            simpleInputDiv.className = 'assessment-table-container';
            
            // Basit bileÅŸenler iÃ§in grup bilgisi kutusu gÃ¶sterilmez
            const componentId = getParentComponentId(activity.id) || activity.id;
            const component = APP_STATE.courseData?.grupHaritalari?.[componentId];
            const groups = component?.gruplar || ['A'];
            
            // Tablo baÅŸlÄ±klarÄ±nÄ± her zaman grup sÃ¼tunu ile gÃ¶ster
            // YarÄ±yÄ±l iÃ§i ve sonu oranlarÄ±nÄ± dinamik olarak al
            const termWeight = getTermWeight();
            const finalWeight = getFinalWeight();
            const tableHeaders = `<th>No</th><th>Ã–ÄŸrenci No</th><th>AdÄ±</th><th>SoyadÄ±</th><th>E-posta</th><th>Grup</th><th>Etkinlik Max. Puan<br/><small>(Soru/Rubrik)</small></th><th>Toplam Puan<br/><small>(DeÄŸerlendirme OranÄ±: ${getAssessmentWeight(activity.id)}%)</small></th><th>AlÄ±nan Puan<br/><small>(Etkinlik PuanÄ±)</small></th><th>YarÄ±yÄ±l Ä°Ã§i<br/><small>(${termWeight}%)</small></th><th>YarÄ±yÄ±l Sonu<br/><small>(${finalWeight}%)</small></th><th>Ortalama</th><th>Harf Notu</th>`;
            
            const tableHTML = `
                <table class="assessment-table">
                    <thead>
                        <tr>
                            ${tableHeaders}
                        </tr>
                    </thead>
                    <tbody>
                        ${APP_STATE.studentData.map((student, index) => {
                            // Sadece bu bileÅŸenin gruplarÄ±nÄ± gÃ¶ster
                            const studentCurrentGroup = getStudentGroupForComponent(student.studentId, componentId);
                            console.log(`ğŸ” ${componentId} iÃ§in Ã¶ÄŸrenci ${student.studentId}: gruplar=${groups.join(',')}, mevcut=${studentCurrentGroup}`);
                            const groupOptions = groups.map(groupId => 
                                `<option value="${groupId}" ${studentCurrentGroup === groupId ? 'selected' : ''}>${groupId}</option>`
                            ).join('');
                            console.log(`  ğŸ“ HTML groupOptions: "${groupOptions}"`);
                            
                            // Bu basit aktivite iÃ§in maksimum puan her zaman activity.points'tir
                            const maxPoints = activity.points;
                            
                            // Grup sÃ¼tununu her zaman gÃ¶ster
                            const groupColumn = `<td>
                                        <select class="group-selector compact" data-student-id="${student.studentId}" data-component-id="${componentId}" onchange="updateStudentGroupForComponent(this)">
                                            ${groupOptions}
                                        </select>
                                    </td>`;
                            console.log(`  ğŸ—ï¸ HTML grup sÃ¼tunu oluÅŸturuldu: ${student.studentId} - ${componentId}`);
                            
                            // Ã–ÄŸrenci notlarÄ±nÄ± hesapla
                            const studentGrades = calculateStudentGrades(student.studentId);
                            
                            return `
                            <tr data-student-id="${student.studentId}" data-component-id="${componentId}">
                                <td>${index + 1}</td>
                                <td>${student.studentId}</td>
                                <td>${student.name}</td>
                                <td>${student.surname}</td>
                                <td class="email-cell">
                                    <span class="email-text" title="${student.email || 'E-posta bulunamadÄ±'}">${student.email || '-'}</span>
                                    ${student.email ? `<button class="email-button" title="E-posta gÃ¶nder" onclick="openEmailModal({studentId: '${student.studentId}', name: '${student.name}', surname: '${student.surname}', email: '${student.email}'})">E-posta</button>` : ''}
                                </td>
                                ${groupColumn}
                                <td class="question-points-cell" data-student-id="${student.studentId}" data-activity-id="${activity.id}">
                                    ${maxPoints}
                                </td>
                                <td class="total-points-cell" data-student-id="${student.studentId}" data-activity-id="${activity.id}">
                                    ${getStudentTotalEarnedPointsForComponent(student.studentId, activity.id)}
                                </td>
                                <td>
                                    <input type="number" min="0" max="${maxPoints}" 
                                        data-student-id="${student.studentId}" 
                                        data-activity-id="${activity.id}" 
                                        value="${getStudentGrade(student.studentId, activity.id) || ''}"
                                        onchange="updateStudentGrade(this)"
                                        placeholder="0-${maxPoints}"
                                        title="Bu aktivitenin maksimum puanÄ±: ${maxPoints}"
                                    >
                                </td>
                                <td class="grade-summary-cell term-grade">${studentGrades.termGrade}</td>
                                <td class="grade-summary-cell final-grade">${studentGrades.finalGrade}</td>
                                <td class="grade-summary-cell total-grade">${studentGrades.totalGrade}</td>
                                <td class="grade-summary-cell letter-grade ${getLetterGradeClass(studentGrades.letterGrade)}">${studentGrades.letterGrade}</td>
                            </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            simpleInputDiv.innerHTML = tableHTML;
            sectionDiv.appendChild(simpleInputDiv);
        }
        
        container.appendChild(sectionDiv);
    } catch (error) {
        console.error("DeÄŸerlendirme etkinliÄŸi bÃ¶lÃ¼mÃ¼ oluÅŸturulurken hata oluÅŸtu:", error);
    }
}

/**
 * Test sorularÄ± iÃ§in Ã¶zel giriÅŸ bÃ¶lÃ¼mÃ¼ oluÅŸturma
 * @param {Object} testItem - Test Ã¶ÄŸesi
 * @param {HTMLElement} container - Konteyner elementi
 */
function createTestInputSection(testItem, container) {
    try {
        const testDiv = document.createElement('div');
        testDiv.className = 'assessment-subsection';
        
        // Test detaylarÄ±nÄ± gÃ¶ster
        const testDetailsDiv = document.createElement('div');
        testDetailsDiv.className = 'test-details';
        testDetailsDiv.innerHTML = `
            <h5>${testItem.name}</h5>
            <div class="test-info">
                <p>Toplam ${testItem.testDetails.totalQuestions} soru, her doÄŸru: ${testItem.testDetails.correctWeight} puan, her yanlÄ±ÅŸ: ${testItem.testDetails.wrongPenalty} puan</p>
            </div>
        `;
        testDiv.appendChild(testDetailsDiv);
        
        // Modern grup bilgileri gÃ¶sterimi
        const parentComponentId = getParentComponentId(testItem.id);
        const modernGroupInfo = createModernGroupInfoDisplay(parentComponentId, testItem.id);
        if (modernGroupInfo) {
            testDiv.appendChild(modernGroupInfo);
        }
        
        // GiriÅŸ modlarÄ± oluÅŸtur
        const inputModesDiv = document.createElement('div');
        inputModesDiv.className = 'input-modes';
        
        const detailedModeButton = document.createElement('div');
        detailedModeButton.className = 'input-mode active';
        detailedModeButton.textContent = 'DetaylÄ± GiriÅŸ';
        detailedModeButton.dataset.mode = 'detailed';
        detailedModeButton.dataset.testId = testItem.id;
        
        const simpleModeButton = document.createElement('div');
        simpleModeButton.className = 'input-mode';
        simpleModeButton.textContent = 'Basit GiriÅŸ';
        simpleModeButton.dataset.mode = 'simple';
        simpleModeButton.dataset.testId = testItem.id;
        
        // Mod butonlarÄ± iÃ§in olay dinleyicileri
        detailedModeButton.addEventListener('click', function() {
            switchTestInputMode(this.dataset.testId, 'detailed');
        });
        
        simpleModeButton.addEventListener('click', function() {
            switchTestInputMode(this.dataset.testId, 'simple');
        });
        
        inputModesDiv.appendChild(detailedModeButton);
        inputModesDiv.appendChild(simpleModeButton);
        testDiv.appendChild(inputModesDiv);
        
        // DetaylÄ± giriÅŸ formu - DoÄŸru/YanlÄ±ÅŸ sayÄ±sÄ±
        const detailedFormDiv = document.createElement('div');
        detailedFormDiv.className = 'test-input-form detailed-mode';
        detailedFormDiv.dataset.testId = testItem.id;
        
        // Tablo oluÅŸtur
        const detailedTable = document.createElement('table');
        detailedTable.className = 'assessment-table';
        
        // Bu test Ã¶ÄŸesinin baÄŸlÄ± olduÄŸu bileÅŸenin gruplarÄ±nÄ± al
        const componentId = getParentComponentId(testItem.id);
        const component = APP_STATE.courseData?.grupHaritalari?.[componentId];
        const groups = component?.gruplar || ['A'];
        
        const detailedTableHTML = `
            <thead>
                <tr>
                    <th>No</th>
                    <th>Ã–ÄŸrenci No</th>
                    <th>AdÄ±</th>
                    <th>SoyadÄ±</th>
                    <th>E-posta</th>
                    <th>Grup</th>
                    <th>DoÄŸru SayÄ±sÄ±</th>
                    <th>YanlÄ±ÅŸ SayÄ±sÄ±</th>
                    <th>BoÅŸ SayÄ±sÄ±</th>
                    <th>Toplam Puan<br/><small>(DeÄŸerlendirme OranÄ±: ${getAssessmentWeight(testItem.id)}%)</small></th>
                    <th>YarÄ±yÄ±l Ä°Ã§i<br/><small>(${getTermWeight()}%)</small></th>
                    <th>YarÄ±yÄ±l Sonu<br/><small>(${getFinalWeight()}%)</small></th>
                    <th>Ortalama</th>
                    <th>Harf Notu</th>
                </tr>
            </thead>
            <tbody>
                ${APP_STATE.studentData.map((student, index) => {
                    // Test sonuÃ§larÄ±nÄ± al
                    const testScore = getStudentTestScore(student.studentId, testItem.id);
                    const correct = testScore?.correct || 0;
                    const wrong = testScore?.wrong || 0;
                    const empty = testItem.testDetails.totalQuestions - correct - wrong;
                    const totalScore = correct * testItem.testDetails.correctWeight - wrong * Math.abs(testItem.testDetails.wrongPenalty);
                    
                    const studentCurrentGroup = getStudentGroupForComponent(student.studentId, componentId);
                    const groupOptions = groups.map(groupId => 
                        `<option value="${groupId}" ${studentCurrentGroup === groupId ? 'selected' : ''}>${groupId}</option>`
                    ).join('');
                    
                    // Ã–ÄŸrenci notlarÄ±nÄ± hesapla
                    const studentGrades = calculateStudentGrades(student.studentId);
                    
                    return `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${student.studentId}</td>
                            <td>${student.name}</td>
                            <td>${student.surname}</td>
                            <td class="email-cell">
                                <span class="email-text" title="${student.email || 'E-posta bulunamadÄ±'}">${student.email || '-'}</span>
                                ${student.email ? `<button class="email-button" title="E-posta gÃ¶nder" onclick="openEmailModal({studentId: '${student.studentId}', name: '${student.name}', surname: '${student.surname}', email: '${student.email}'})">E-posta</button>` : ''}
                            </td>
                            <td>
                                <select class="group-selector compact" data-student-id="${student.studentId}" data-component-id="${componentId}" onchange="updateStudentGroupForComponent(this)">
                                    ${groupOptions}
                                </select>
                            </td>
                            <td>
                                <input type="number" min="0" max="${testItem.testDetails.totalQuestions}" 
                                    data-student-id="${student.studentId}" 
                                    data-test-id="${testItem.id}" 
                                    data-field="correct"
                                    value="${correct}"
                                    onchange="updateTestScore(this)"
                                >
                            </td>
                            <td>
                                <input type="number" min="0" max="${testItem.testDetails.totalQuestions}" 
                                    data-student-id="${student.studentId}" 
                                    data-test-id="${testItem.id}" 
                                    data-field="wrong"
                                    value="${wrong}"
                                    onchange="updateTestScore(this)"
                                >
                            </td>
                            <td>${empty}</td>
                            <td class="total-score">${totalScore.toFixed(2)}</td>
                            <td class="grade-summary-cell term-grade">${studentGrades.termGrade}</td>
                            <td class="grade-summary-cell final-grade">${studentGrades.finalGrade}</td>
                            <td class="grade-summary-cell total-grade">${studentGrades.totalGrade}</td>
                            <td class="grade-summary-cell letter-grade ${getLetterGradeClass(studentGrades.letterGrade)}">${studentGrades.letterGrade}</td>
                        </tr>
                    `;
                }).join('')}
            </tbody>
        `;
        
        detailedTable.innerHTML = detailedTableHTML;
        detailedFormDiv.appendChild(detailedTable);
        testDiv.appendChild(detailedFormDiv);
        
        // Basit giriÅŸ formu - Sadece toplam puan
        const simpleFormDiv = document.createElement('div');
        simpleFormDiv.className = 'test-input-form simple-mode';
        simpleFormDiv.dataset.testId = testItem.id;
        simpleFormDiv.style.display = 'none'; // BaÅŸlangÄ±Ã§ta gizli
        
        // Tablo oluÅŸtur
        const simpleTable = document.createElement('table');
        simpleTable.className = 'assessment-table';
        
        const simpleTableHTML = `
            <thead>
                <tr>
                    <th>No</th>
                    <th>Ã–ÄŸrenci No</th>
                    <th>AdÄ±</th>
                    <th>SoyadÄ±</th>
                    <th>E-posta</th>
                    <th>Grup</th>
                    <th>Toplam Puan (${testItem.points})</th>
                    <th>YarÄ±yÄ±l Ä°Ã§i</th>
                    <th>YarÄ±yÄ±l Sonu</th>
                    <th>Ortalama</th>
                    <th>Harf Notu</th>
                </tr>
            </thead>
            <tbody>
                ${APP_STATE.studentData.map((student, index) => {
                    // Test sonuÃ§larÄ±nÄ± al
                    const testScore = getStudentTestScore(student.studentId, testItem.id);
                    const correct = testScore?.correct || 0;
                    const wrong = testScore?.wrong || 0;
                    const totalScore = correct * testItem.testDetails.correctWeight - wrong * Math.abs(testItem.testDetails.wrongPenalty);
                    
                    const studentCurrentGroup = getStudentGroupForComponent(student.studentId, componentId);
                    console.log(`ğŸ” Test detaylÄ± giriÅŸ - ${componentId} iÃ§in Ã¶ÄŸrenci ${student.studentId}: gruplar=${groups.join(',')}, mevcut=${studentCurrentGroup}`);
                    const groupOptions = groups.map(groupId => 
                        `<option value="${groupId}" ${studentCurrentGroup === groupId ? 'selected' : ''}>${groupId}</option>`
                    ).join('');
                    
                    // Ã–ÄŸrenci notlarÄ±nÄ± hesapla
                    const studentGrades = calculateStudentGrades(student.studentId);
                    
                    return `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${student.studentId}</td>
                            <td>${student.name}</td>
                            <td>${student.surname}</td>
                            <td class="email-cell">
                                <span class="email-text" title="${student.email || 'E-posta bulunamadÄ±'}">${student.email || '-'}</span>
                                ${student.email ? `<button class="email-button" title="E-posta gÃ¶nder" onclick="openEmailModal({studentId: '${student.studentId}', name: '${student.name}', surname: '${student.surname}', email: '${student.email}'})">E-posta</button>` : ''}
                            </td>
                            <td>
                                <select class="group-selector compact" data-student-id="${student.studentId}" data-component-id="${componentId}" onchange="updateStudentGroupForComponent(this)">
                                    ${groupOptions}
                                </select>
                            </td>
                            <td>
                                <input type="number" min="0" max="${testItem.points}" 
                                    data-student-id="${student.studentId}" 
                                    data-activity-id="${testItem.id}" 
                                    value="${totalScore.toFixed(2)}"
                                    onchange="updateStudentGrade(this)"
                                >
                            </td>
                            <td class="grade-summary-cell term-grade">${studentGrades.termGrade}</td>
                            <td class="grade-summary-cell final-grade">${studentGrades.finalGrade}</td>
                            <td class="grade-summary-cell total-grade">${studentGrades.totalGrade}</td>
                            <td class="grade-summary-cell letter-grade ${getLetterGradeClass(studentGrades.letterGrade)}">${studentGrades.letterGrade}</td>
                        </tr>
                    `;
                }).join('')}
            </tbody>
        `;
        
        simpleTable.innerHTML = simpleTableHTML;
        simpleFormDiv.appendChild(simpleTable);
        testDiv.appendChild(simpleFormDiv);
        
        container.appendChild(testDiv);
    } catch (error) {
        console.error("Test giriÅŸ bÃ¶lÃ¼mÃ¼ oluÅŸturulÃ¼rken hata oluÅŸtu:", error);
    }
}

/**
 * Modern grup bilgileri gÃ¶sterim elementi oluÅŸturma
 * @param {string} componentId - BileÅŸen ID'si
 * @param {string} questionId - Soru ID'si
 * @returns {HTMLElement|null} - Grup bilgileri elementi
 */
function createModernGroupInfoDisplay(componentId, questionId) {
    try {
        if (!APP_STATE.courseData?.grupHaritalari?.[componentId]) {
            return null;
        }

        const componentData = APP_STATE.courseData.grupHaritalari[componentId];
        const groups = componentData.gruplar || [];
        
        // Grup yoksa gÃ¶sterme, ama tek grup varsa gÃ¶ster
        if (groups.length === 0) {
            return null;
        }

        const groupInfoDiv = document.createElement('div');
        groupInfoDiv.className = 'compact-group-info';
        
        // Grup bilgilerini kompakt formatta hazÄ±rla
        const groupMappings = [];
        groups.forEach(groupId => {
            let paperOrder = '-';
            let originalOrder = '-';
            let questionPoints = '-';
            
            // Bu grubun bu soru iÃ§in haritalama bilgisi var mÄ±?
            const groupMappings_data = componentData.haritalar?.[groupId]?.[questionId];
            
            if (groupMappings_data) {
                // Haritalama varsa, kaÄŸÄ±ttaki sÄ±rayÄ± gÃ¶ster
                paperOrder = groupMappings_data;
                
                // Orijinal sÄ±rayÄ± bul (soru ID'sinden)
                const questionNode = findNodeById(questionId);
                if (questionNode) {
                    questionPoints = questionNode.points || '-';
                    const parent = findNodeById(getParentComponentId(questionId));
                    if (parent && parent.children) {
                        const index = parent.children.findIndex(child => child.id === questionId);
                        originalOrder = index >= 0 ? (index + 1) : '-';
                    }
                }
            } else {
                // Haritalama yoksa, standart sÄ±rayÄ± gÃ¶ster
                const questionNode = findNodeById(questionId);
                if (questionNode) {
                    questionPoints = questionNode.points || '-';
                    const parent = findNodeById(getParentComponentId(questionId));
                    if (parent && parent.children) {
                        const index = parent.children.findIndex(child => child.id === questionId);
                        originalOrder = index >= 0 ? (index + 1) : '-';
                        paperOrder = originalOrder; // Haritalama yoksa aynÄ±
                    }
                }
            }
            
            groupMappings.push({
                group: groupId,
                paperOrder: paperOrder,
                originalOrder: originalOrder,
                points: questionPoints
            });
        });
        
        // Kompakt tablo formatÄ±nda gÃ¶ster
        groupInfoDiv.innerHTML = `
            <div class="compact-header">
                <span class="compact-icon">ğŸ“Š</span>
                <span class="compact-title">Grup Bilgileri</span>
            </div>
            <div class="compact-table">
                <div class="compact-row compact-header-row">
                    <span>Grup</span>
                    <span>Orijinal</span>
                    <span>KaÄŸÄ±t</span>
                    <span>Puan</span>
                </div>
                ${groupMappings.map(mapping => `
                    <div class="compact-row">
                        <span class="group-badge-compact">${mapping.group}</span>
                        <span class="original-info">${mapping.originalOrder}</span>
                        <span class="paper-info">${mapping.paperOrder}</span>
                        <span class="points-info">${mapping.points}</span>
                    </div>
                `).join('')}
            </div>
        `;
        
        return groupInfoDiv;
    } catch (error) {
        console.error("Modern grup bilgileri oluÅŸturulurken hata:", error);
        return null;
    }
}

/**
 * Alt Ã¶ÄŸe giriÅŸ bÃ¶lÃ¼mÃ¼ oluÅŸturma (Soru/Rubrik)
 * @param {Object} subItem - Alt Ã¶ÄŸe
 * @param {HTMLElement} container - Konteyner elementi
 */
function createSubItemInputSection(subItem, container) {
    try {
        const subDiv = document.createElement('div');
        subDiv.className = 'assessment-subsection';
        
        const parentComponentId = getParentComponentId(subItem.id);
        
        // BaÅŸlÄ±k
        const header = document.createElement('h5');
        header.innerHTML = `${subItem.name}`;
        subDiv.appendChild(header);
        
        // BileÅŸendeki tÃ¼m sorularÄ± al
        const parentNode = findNodeById(parentComponentId);
        const allQuestions = parentNode?.children || [];
        const maxQuestions = allQuestions.length;
        
        // Grup seÃ§eneklerini gÃ¼venli ÅŸekilde oluÅŸtur
        const groups = (APP_STATE.courseData && APP_STATE.courseData.grupHaritalari && APP_STATE.courseData.grupHaritalari[parentComponentId]) 
            ? APP_STATE.courseData.grupHaritalari[parentComponentId].gruplar || ['A']
            : ['A'];
        
        // Grup sistemi her zaman kullanÄ±lÄ±r (tek grup olsa bile)
        const useGroupSystem = true;
        
        // KaÄŸÄ±t sÄ±rasÄ± bazÄ±nda bÃ¶lÃ¼mler oluÅŸtur
        for (let paperOrder = 1; paperOrder <= maxQuestions; paperOrder++) {
            const paperSection = document.createElement('div');
            paperSection.className = 'paper-order-section';
            
            const paperHeader = document.createElement('h6');
            paperHeader.innerHTML = `KaÄŸÄ±t SÄ±rasÄ± ${paperOrder}`;
            paperHeader.className = 'paper-order-header';
            paperSection.appendChild(paperHeader);
            
        const table = document.createElement('table');
            table.className = 'assessment-table paper-order-table';
            
            const tableHTML = `
            <thead>
                <tr>
                    <th>No</th>
                    <th>Ã–ÄŸrenci No</th>
                    <th>AdÄ±</th>
                    <th>SoyadÄ±</th>
                    <th>E-posta</th>
                    ${useGroupSystem ? '<th>Grup</th>' : ''}
                    ${useGroupSystem ? '<th>Cevap AnahtarÄ± SÄ±rasÄ±</th>' : ''}
                    ${useGroupSystem ? '<th>Etkinlik AdÄ±<br/><small>(Soru/Rubrik)</small></th>' : ''}
                    ${useGroupSystem ? '<th>AÃ§Ä±klama</th>' : ''}
                    <th>Etkinlik Max. Puan<br/><small>(Soru/Rubrik)</small></th>
                        <th>Toplam Puan</th>
                        ${useGroupSystem ? '<th>Ã–Ã‡</th>' : ''}
                        <th>AlÄ±nan Puan<br/><small>(Etkinlik PuanÄ±)</small></th>
                        <th>YarÄ±yÄ±l Ä°Ã§i<br/><small>(${getTermWeight()}%)</small></th>
                        <th>YarÄ±yÄ±l Sonu<br/><small>(${getFinalWeight()}%)</small></th>
                        <th>Ortalama</th>
                        <th>Harf Notu</th>
                </tr>
            </thead>
            <tbody>
                    ${APP_STATE.studentData.map((student, index) => {
                        const studentCurrentGroup = getStudentGroupForComponent(student.studentId, parentComponentId);
                        const groupOptions = groups.map(groupId => 
                            `<option value="${groupId}" ${studentCurrentGroup === groupId ? 'selected' : ''}>${groupId}</option>`
                        ).join('');
                        
                        // Bu kaÄŸÄ±t sÄ±rasÄ±ndaki sorunun gerÃ§ek ID'sini bul
                        const actualQuestionId = getQuestionIdByPaperOrder(student.studentId, paperOrder, parentComponentId);
                        const actualQuestion = findNodeById(actualQuestionId);
                        
                        // Cevap anahtarÄ±ndaki sÄ±rayÄ± bul
                        const answerKeyOrder = getAnswerKeyOrder(student.studentId, paperOrder, parentComponentId);
                        
                        // Etkinlik bilgilerini al - GerÃ§ek etkinlik adÄ±nÄ± gÃ¶ster
                        const activityName = actualQuestion?.name || `Etkinlik ${answerKeyOrder || paperOrder}`;
                        const questionDescription = actualQuestion?.description || actualQuestion?.name || '-';
                        const questionPointsForGroup = getQuestionPointsForStudentGroup(student.studentId, actualQuestionId, parentComponentId);
                        const maxPoints = questionPointsForGroup || actualQuestion?.points || 0;
                        const studentOutcomes = getQuestionOutcomesForStudent(student.studentId, actualQuestionId, parentComponentId);
                        
                        return `
                            <tr data-student-id="${student.studentId}" data-paper-order="${paperOrder}" data-component-id="${parentComponentId}">
                        <td>${index + 1}</td>
                        <td>${student.studentId}</td>
                        <td>${student.name}</td>
                        <td>${student.surname}</td>
                        <td class="email-cell">
                            <span class="email-text" title="${student.email || 'E-posta bulunamadÄ±'}">${student.email || '-'}</span>
                            ${student.email ? `<button class="email-button" title="E-posta gÃ¶nder" onclick="openEmailModal({studentId: '${student.studentId}', name: '${student.name}', surname: '${student.surname}', email: '${student.email}'})">E-posta</button>` : ''}
                        </td>
                        ${useGroupSystem ? `
                        <td>
                            <select class="group-selector compact" data-student-id="${student.studentId}" data-component-id="${parentComponentId}" onchange="updateStudentGroupForComponent(this)">
                                ${groupOptions}
                            </select>
                        </td>` : ''}
                        ${useGroupSystem ? `
                        <td class="answer-key-order-cell">
                            <span class="answer-key-badge" data-answer-key="${answerKeyOrder}" data-question-id="${actualQuestionId}">
                                ${answerKeyOrder}
                            </span>
                        </td>` : ''}
                        ${useGroupSystem ? `
                        <td class="question-name-cell">
                            <span class="question-name-badge">${activityName}</span>
                        </td>` : ''}
                        ${useGroupSystem ? `
                        <td class="question-description-cell">
                            <span class="question-desc-badge" title="${questionDescription}">${questionDescription}</span>
                        </td>` : ''}
                        <td class="question-points-cell" data-student-id="${student.studentId}" data-activity-id="${actualQuestionId}">
                            ${maxPoints}
                        </td>
                        <td class="total-points-cell" data-student-id="${student.studentId}" data-component-id="${parentComponentId}">
                            ${getStudentTotalEarnedPointsForComponent(student.studentId, parentComponentId)}
                        </td>
                        ${useGroupSystem ? `
                        <td class="outcomes-cell">
                            <span class="outcomes-badge">${Array.isArray(studentOutcomes) ? studentOutcomes.join(', ') : (studentOutcomes || '-')}</span>
                        </td>` : ''}
                        <td>
                            <input type="number" min="0" max="${maxPoints}" 
                                data-student-id="${student.studentId}" 
                                data-activity-id="${actualQuestionId}"
                                data-paper-order="${paperOrder}"
                                value="${getStudentGrade(student.studentId, actualQuestionId) || ''}"
                                onchange="updateStudentGrade(this)"
                                placeholder="0-${maxPoints}"
                                title="${useGroupSystem ? `KaÄŸÄ±t sÄ±rasÄ±: ${paperOrder}, Cevap anahtarÄ±: ${answerKeyOrder}, Maksimum puan: ${maxPoints}` : `Maksimum puan: ${maxPoints}`}"
                            >
                        </td>
                        <td class="grade-summary-cell term-grade">${calculateStudentGrades(student.studentId).termGrade}</td>
                        <td class="grade-summary-cell final-grade">${calculateStudentGrades(student.studentId).finalGrade}</td>
                        <td class="grade-summary-cell total-grade">${calculateStudentGrades(student.studentId).totalGrade}</td>
                        <td class="grade-summary-cell letter-grade ${getLetterGradeClass(calculateStudentGrades(student.studentId).letterGrade)}">${calculateStudentGrades(student.studentId).letterGrade}</td>
                    </tr>
                        `;
                    }).join('')}
            </tbody>
        `;
            
            table.innerHTML = tableHTML;
            paperSection.appendChild(table);
            subDiv.appendChild(paperSection);
        }
        
        container.appendChild(subDiv);
        
        // Ä°LK YÃœKLEME SONRASI GRUP BAZLI GÃœNCELLEMELERÄ° YAP
        // Her Ã¶ÄŸrenci iÃ§in grup bazlÄ± bilgileri gÃ¼ncelle (combobox deÄŸiÅŸimi simÃ¼lasyonu)
        if (APP_STATE.studentData && APP_STATE.studentData.length > 0) {
            setTimeout(() => {
                console.log('ğŸ”„ Ä°lk yÃ¼kleme sonrasÄ± grup bazlÄ± gÃ¼ncellemeler baÅŸlatÄ±lÄ±yor...');
                APP_STATE.studentData.forEach(student => {
                    const studentGroup = getStudentGroupForComponent(student.studentId, parentComponentId);
                    if (studentGroup) {
                        // Grup deÄŸiÅŸikliÄŸi fonksiyonunu simÃ¼le et - sadece soru bilgilerini gÃ¼ncelle
                        updateQuestionInfoForComponent(student.studentId, studentGroup, parentComponentId);
                    }
                });
                console.log('âœ… Ä°lk yÃ¼kleme grup bazlÄ± gÃ¼ncellemeleri tamamlandÄ±');
            }, 100); // KÄ±sa gecikme ile DOM'un hazÄ±r olmasÄ±nÄ± bekle
        }
        
        // GUID sistemi kaldÄ±rÄ±ldÄ±
    } catch (error) {
        console.error("Alt Ã¶ÄŸe giriÅŸ bÃ¶lÃ¼mÃ¼ oluÅŸturulurken hata oluÅŸtu:", error);
    }
}

/**
 * Test giriÅŸ modunu deÄŸiÅŸtirme
 * @param {string} testId - Test ID'si
 * @param {string} mode - Mod (detailed/simple)
 */
function switchTestInputMode(testId, mode) {
    try {
        // Mod butonlarÄ±nÄ± gÃ¼ncelle
        document.querySelectorAll(`.input-mode[data-test-id="${testId}"]`).forEach(btn => {
            if (btn.dataset.mode === mode) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
        
        // GiriÅŸ formlarÄ±nÄ± gÃ¶ster/gizle
        const detailedForm = document.querySelector(`.test-input-form.detailed-mode[data-test-id="${testId}"]`);
        const simpleForm = document.querySelector(`.test-input-form.simple-mode[data-test-id="${testId}"]`);
        
        if (mode === 'detailed') {
            detailedForm.style.display = 'block';
            simpleForm.style.display = 'none';
        } else {
            detailedForm.style.display = 'none';
            simpleForm.style.display = 'block';
        }
    } catch (error) {
        console.error("Test giriÅŸ modu deÄŸiÅŸtirilirken hata oluÅŸtu:", error);
    }
}

/**
 * Ã–ÄŸrenci notunu getirme - v5 formatÄ±nÄ± tam destekler
 * @param {string} studentId - Ã–ÄŸrenci ID'si
 * @param {string} activityId - Etkinlik ID'si
 * @returns {number|null} - Not deÄŸeri
 */
function getStudentGrade(studentId, activityId) {
    if (!APP_STATE.gradesData || !APP_STATE.gradesData[studentId]) return null;
    
    const studentGrades = APP_STATE.gradesData[studentId];
    const activity = findNodeById(activityId);
    
    // v5 FORMAT Ã–NCELÄ°ÄÄ°: Pozisyon bazlÄ± notlarÄ± kontrol et
    const parts = activityId.split('.');
    if (parts.length > 1) {
        const parentId = parts[0]; // A1.1 -> A1
        
        if (studentGrades[parentId] && typeof studentGrades[parentId] === 'object') {
            // v5 Format: Pozisyon bazlÄ± eriÅŸim (1, 2, 3, 4, 5...)
            for (const position of Object.keys(studentGrades[parentId])) {
                const gradeInfo = studentGrades[parentId][position];
                if (gradeInfo && typeof gradeInfo === 'object' && 
                    gradeInfo.soruId === activityId && gradeInfo.puan !== undefined) {
                    return gradeInfo.puan;
                }
            }
        }
    }
    
    // DURUM 1: DoÄŸrudan eriÅŸim (geriye uyumluluk)
    if (studentGrades[activityId] !== undefined) {
        const grade = studentGrades[activityId];
        
        // SayÄ±sal deÄŸer
        if (typeof grade === 'number') {
            return grade;
        }
        
        // Test notu (object formatÄ±nda)
        if (typeof grade === 'object' && grade !== null) {
            // Test tipi
            if (grade.tip === 'test' && activity && activity.type === 'Test') {
                const correct = grade.dogru || 0;
                const wrong = grade.yanlis || 0;
                return correct * (activity.testDetails?.correctWeight || 5) - 
                       wrong * Math.abs(activity.testDetails?.wrongPenalty || 0);
            }
        }
    }
    
    // DURUM 2: Ä°Ã§ iÃ§e yapÄ± kontrolÃ¼ (eski format uyumluluÄŸu)
    if (parts.length > 1) {
        const parentId = parts[0]; // A1.1 -> A1
        const shortId = parts[parts.length - 1]; // A1.1 -> 1
        
        if (studentGrades[parentId] && typeof studentGrades[parentId] === 'object') {
            // Tam ID ile eriÅŸim
            if (studentGrades[parentId][activityId] !== undefined) {
                // Test notu
                if (typeof studentGrades[parentId][activityId] === 'object' && 
                    studentGrades[parentId][activityId] !== null && 
                    studentGrades[parentId][activityId].tip === 'test') {
                    
                    const testScore = studentGrades[parentId][activityId];
                    const correct = testScore.dogru || 0;
                    const wrong = testScore.yanlis || 0;
                    
                    if (activity && activity.type === 'Test') {
                        return correct * (activity.testDetails?.correctWeight || 5) - 
                               wrong * Math.abs(activity.testDetails?.wrongPenalty || 0);
                    }
                }
                // Normal not
                else if (typeof studentGrades[parentId][activityId] === 'number') {
                    return studentGrades[parentId][activityId];
                }
            }
            
            // KÄ±sa ID ile eriÅŸim (A1.1 -> sadece 1)
            if (studentGrades[parentId][shortId] !== undefined) {
                // Test notu
                if (typeof studentGrades[parentId][shortId] === 'object' && 
                    studentGrades[parentId][shortId] !== null && 
                    studentGrades[parentId][shortId].tip === 'test') {
                    
                    const testScore = studentGrades[parentId][shortId];
                    const correct = testScore.dogru || 0;
                    const wrong = testScore.yanlis || 0;
                    
                    if (activity && activity.type === 'Test') {
                        return correct * (activity.testDetails?.correctWeight || 5) - 
                               wrong * Math.abs(activity.testDetails?.wrongPenalty || 0);
                    }
                }
                // Normal not
                else if (typeof studentGrades[parentId][shortId] === 'number') {
                    return studentGrades[parentId][shortId];
                }
            }
        }
    }
    
    return null;
}

/**
 * Aktivite ID'sinden soru numarasÄ±nÄ± Ã§Ä±karma
 * @param {string} activityId - Aktivite ID'si (Ã¶rn: A1.1, A1.2)
 * @returns {string|null} - Soru numarasÄ± (Ã¶rn: "1", "2")
 */
function getQuestionNumberFromActivity(activityId) {
    // A1.1 -> "1", A1.2 -> "2", F1.1 -> "1" 
    const parts = activityId.split('.');
    if (parts.length >= 2) {
        return parts[parts.length - 1]; // Son kÄ±smÄ± al
    }
    return null;
}

/**
 * Aktivite ID'sinden ana bileÅŸen ID'sini Ã§Ä±karma (Ã¶rn: A1.1 â†’ A1)
 * @param {string} activityId - Aktivite ID'si
 * @returns {string|null} - Ana bileÅŸen ID'si
 */
// Ä°lk getParentComponentId fonksiyonu kaldÄ±rÄ±ldÄ± - geliÅŸmiÅŸ versiyon korundu

/**
 * BileÅŸen iÃ§in grup bilgilerini formatlanmÄ±ÅŸ string olarak getir
 * @param {string} componentId - Ana bileÅŸen ID'si (A1, F1, vb)
 * @param {string} questionId - Soru ID'si
 * @returns {string} - FormatlanmÄ±ÅŸ grup bilgileri
 */
function getComponentGroupInfo(componentId, questionId) {
    try {
        if (!APP_STATE.courseData?.grupHaritalari?.[componentId]) {
            return `Grup Bilgisi: A (VarsayÄ±lan grup - hiÃ§ grup tanÄ±mlanmamÄ±ÅŸ)`;
        }
        
        const componentGroups = APP_STATE.courseData.grupHaritalari[componentId];
        const groups = componentGroups.gruplar || ['A'];
        const mappings = componentGroups.haritalar || {};
        
        let infoText = `Gruplar: ${groups.join(', ')}\n`;
        
        // Her grup iÃ§in bu sorunun haritalama bilgisini gÃ¶ster
        groups.forEach(groupName => {
            if (mappings[groupName]) {
                // DÃœZELTME: Veri yapÄ±sÄ± {position: questionId} formatÄ±nda
                const position = Object.keys(mappings[groupName]).find(pos => mappings[groupName][pos] === questionId);
                if (position) {
                    infoText += `Grup ${groupName}: Soru ${position} | `;
                } else {
                    infoText += `Grup ${groupName}: HaritalanmamÄ±ÅŸ | `;
                }
            } else {
                infoText += `Grup ${groupName}: HaritalanmamÄ±ÅŸ | `;
            }
        });
        
        // Son | karakterini kaldÄ±r
        if (infoText.endsWith(' | ')) {
            infoText = infoText.slice(0, -3);
        }
        
        return infoText;
    } catch (error) {
        console.error("Grup bilgileri oluÅŸturulurken hata:", error);
        return "Grup bilgisi yÃ¼klenirken hata oluÅŸtu";
    }
}

/**
 * Ã–ÄŸrencinin grubuna gÃ¶re belirli bir sorunun puanÄ±nÄ± getir
 * @param {string} studentId - Ã–ÄŸrenci ID'si
 * @param {string} activityId - Aktivite ID'si
 * @param {string} componentId - BileÅŸen ID'si
 * @returns {number} - Sorunun puanÄ±
 */
function getQuestionPointsForStudentGroup(studentId, activityId, componentId) {
    try {
        const studentGroup = getStudentGroupForComponent(studentId, componentId);
        
        console.log(`ğŸ” getQuestionPointsForStudentGroup DEBUG:`);
        console.log(`  - studentId: ${studentId}`);
        console.log(`  - activityId: ${activityId}`);
        console.log(`  - componentId: ${componentId}`);
        console.log(`  - studentGroup: ${studentGroup}`);
        
        // Grup haritalama verilerini al
        const componentGroupData = APP_STATE.courseData?.grupHaritalari?.[componentId];
        if (!componentGroupData || !componentGroupData.haritalar || !componentGroupData.haritalar[studentGroup]) {
            // Grup haritalama yoksa, sorunun orijinal puanÄ±nÄ± dÃ¶ndÃ¼r
            const activity = findNodeById(activityId);
            console.log(`  - Grup haritalama yok, orijinal puan: ${activity ? activity.points : 0}`);
            return activity ? activity.points : 0;
        }
        
        // Bu Ã¶ÄŸrencinin grubundaki bu sorunun kaÄŸÄ±t Ã¼zerindeki sÄ±rasÄ±nÄ± bul
        // Grup haritalama formatÄ± kontrol et: {position: questionId} VEYA {questionId: position}
        const groupMappings = componentGroupData.haritalar[studentGroup];
        let paperQuestionOrder = null;
        
        console.log(`  - groupMappings:`, groupMappings);
        
        // Format 1: {position: questionId} - DoÄŸru position deÄŸerini bul
        if (Object.values(groupMappings).includes(activityId)) {
            const position = Object.keys(groupMappings).find(pos => groupMappings[pos] === activityId);
            paperQuestionOrder = parseInt(position);
            console.log(`  - Format 1 kullanÄ±ldÄ±, position: ${position}, paperQuestionOrder: ${paperQuestionOrder}`);
        }
        // Format 2: {questionId: position} - Eski format
        else if (groupMappings[activityId]) {
            paperQuestionOrder = parseInt(groupMappings[activityId]);
            console.log(`  - Format 2 kullanÄ±ldÄ±, paperQuestionOrder: ${paperQuestionOrder}`);
        }
        
        if (!paperQuestionOrder) {
            // Haritalama yoksa, sorunun orijinal puanÄ±nÄ± dÃ¶ndÃ¼r
            const activity = findNodeById(activityId);
            console.log(`  - PaperQuestionOrder bulunamadÄ±, orijinal puan: ${activity ? activity.points : 0}`);
            return activity ? activity.points : 0;
        }
        
        // AynÄ± bileÅŸendeki tÃ¼m sorularÄ± al ve sÄ±rala
        const component = findNodeById(componentId);
        if (!component || !component.children) {
            const activity = findNodeById(activityId);
            return activity ? activity.points : 0;
        }
        
        // SorularÄ± orijinal sÄ±ralarÄ±na gÃ¶re sÄ±rala
        const questions = component.children
            .filter(child => isQuestionType(child.type) || isRubricType(child.type))
            .sort((a, b) => {
                const aNum = parseInt(a.id.split('.').pop());
                const bNum = parseInt(b.id.split('.').pop());
                return aNum - bNum;
            });
        
        // KaÄŸÄ±t sÄ±rasÄ±ndaki sorunun puanÄ±nÄ± al
        if (paperQuestionOrder >= 1 && paperQuestionOrder <= questions.length) {
            const targetQuestion = questions[paperQuestionOrder - 1]; // Array 0-indexed
            return targetQuestion.points;
        }
        
        // Hata durumunda orijinal sorunun puanÄ±nÄ± dÃ¶ndÃ¼r
        const activity = findNodeById(activityId);
        return activity ? activity.points : 0;
        
    } catch (error) {
        console.error("Grup bazlÄ± etkinlik max puanÄ± hesaplanÄ±rken hata:", error);
        const activity = findNodeById(activityId);
        return activity ? activity.points : 0;
    }
}

/**
 * Grup bazlÄ± not hesaplama
 * @param {string} studentId - Ã–ÄŸrenci ID'si
 * @param {string} activityId - Aktivite ID'si
 * @param {number} rawScore - Ham puan
 * @returns {number} - Hesaplanan not
 */
function calculateGradeBasedOnGroup(studentId, activityId, rawScore) {
    const studentGroup = getStudentGroup(studentId);
    
    // Ã–nce bu aktivitenin hangi deÄŸerlendirme bileÅŸenine ait olduÄŸunu bul
    const parentComponentId = getParentComponentId(activityId);
    if (!parentComponentId) {
        return rawScore;
    }
    
    // Bu deÄŸerlendirme bileÅŸeninin grup haritasÄ±nÄ± al
    const componentGroupData = APP_STATE.courseData?.grupHaritalari?.[parentComponentId];
    if (!componentGroupData || !componentGroupData.haritalar || !componentGroupData.haritalar[studentGroup]) {
        return rawScore;
    }
    
    // DÃœZELTME: Veri yapÄ±sÄ± {position: questionId} formatÄ±nda
    const groupMappings = componentGroupData.haritalar[studentGroup];
    const position = Object.keys(groupMappings).find(pos => groupMappings[pos] === activityId);
    
    // EÄŸer bu aktivite iÃ§in grup haritasÄ± yoksa, ham puanÄ± dÃ¶ndÃ¼r
    if (!position) {
        return rawScore;
    }
    
    console.log(`Grup bazlÄ± hesaplama: Ã–ÄŸrenci ${studentId} (Grup: ${studentGroup}), Aktivite ${activityId} â†’ Soru ${position}`);
    
    // Ham puanlardan doÄŸru sÄ±radaki puanÄ± al
    const hamPuanlar = APP_STATE.gradesData[studentId]?.hamPuanlar;
    if (hamPuanlar && hamPuanlar[position]) {
        return hamPuanlar[position];
    }
    
    return rawScore;
}

/**
 * Grup deÄŸiÅŸtiÄŸinde Ã¶ÄŸrencinin tÃ¼m notlarÄ±nÄ± yeniden hesapla
 * @param {string} studentId - Ã–ÄŸrenci ID'si
 * @param {string} newGroupId - Yeni grup ID'si
 */
function recalculateGradesForGroupChange(studentId, newGroupId) {
    if (!APP_STATE.gradesData[studentId] || !APP_STATE.gradesData[studentId].hamPuanlar) {
        console.log(`Ã–ÄŸrenci ${studentId} iÃ§in ham puan verisi bulunamadÄ±`);
        return;
    }
    
    const hamPuanlar = APP_STATE.gradesData[studentId].hamPuanlar;
    console.log(`Grup deÄŸiÅŸimi: Ã–ÄŸrenci ${studentId} â†’ Grup ${newGroupId}. Ham puanlar:`, hamPuanlar);
    
    // TÃ¼m aktiviteler iÃ§in notlarÄ± yeniden hesapla
    const allActivities = getAllQuestionActivities();
    
    allActivities.forEach(activityId => {
        const questionNumber = getQuestionNumberFromActivity(activityId);
        if (questionNumber && hamPuanlar[questionNumber]) {
            const rawScore = hamPuanlar[questionNumber];
            const calculatedGrade = calculateGradeBasedOnGroup(studentId, activityId, rawScore);
            
            // Hesaplanan notu gÃ¼ncelle
            APP_STATE.gradesData[studentId][activityId] = calculatedGrade;
            
            console.log(`Yeniden hesaplama: ${activityId} â†’ Ham: ${rawScore}, Hesaplanan: ${calculatedGrade}`);
            
            // UI'daki input alanlarÄ±nÄ± gÃ¼ncelle
            const inputs = document.querySelectorAll(`input[data-student-id="${studentId}"][data-activity-id="${activityId}"]`);
            inputs.forEach(input => {
                input.value = calculatedGrade;
            });
        }
    });
    
    console.log(`Ã–ÄŸrenci ${studentId} iÃ§in grup bazlÄ± notlar yeniden hesaplandÄ±`);
}

/**
 * TÃ¼m soru aktivitelerini getir
 * @returns {Array<string>} - Aktivite ID'leri
 */
function getAllQuestionActivities() {
    const activities = [];
    
    function collectActivities(nodes) {
        nodes.forEach(node => {
            if (node.children && node.children.length > 0) {
                collectActivities(node.children);
            } else if (isQuestionType(node.type)) {
                activities.push(node.id);
            }
        });
    }
    
    collectActivities(APP_STATE.assessmentTree);
    return activities;
}

/**
 * TÃ¼m Ã¶ÄŸrenciler iÃ§in grup bazlÄ± hesaplama yap (JSON import sonrasÄ±)
 */
function recalculateAllGradesBasedOnGroups() {
    if (!APP_STATE.studentData || !APP_STATE.gradesData) {
        console.log('Ã–ÄŸrenci verileri veya not verileri bulunamadÄ±');
        return;
    }
    
    console.log('TÃ¼m Ã¶ÄŸrenciler iÃ§in grup bazlÄ± hesaplama baÅŸlatÄ±lÄ±yor...');
    
    APP_STATE.studentData.forEach(student => {
        const studentId = student.studentId;
        const studentGrades = APP_STATE.gradesData[studentId];
        
        if (!studentGrades) {
            console.log(`Ã–ÄŸrenci ${studentId} iÃ§in not verisi bulunamadÄ±`);
            return;
        }
        
        // EÄŸer ham puanlar varsa, grup bazlÄ± hesaplama yap
        if (studentGrades.hamPuanlar) {
            console.log(`Ã–ÄŸrenci ${studentId} iÃ§in ham puanlar bulundu:`, studentGrades.hamPuanlar);
            recalculateGradesForGroupChange(studentId, student.grup);
        } else {
            // Ham puanlar yoksa, mevcut notlardan ham puanlarÄ± Ã§Ä±karmaya Ã§alÄ±ÅŸ
            console.log(`Ã–ÄŸrenci ${studentId} iÃ§in ham puanlar bulunamadÄ±, mevcut notlardan Ã§Ä±karÄ±lmaya Ã§alÄ±ÅŸÄ±lÄ±yor`);
            extractRawScoresFromExistingGrades(studentId);
        }
    });
    
    console.log('Grup bazlÄ± hesaplama tamamlandÄ±');
}

/**
 * Mevcut notlardan ham puanlarÄ± Ã§Ä±karma (geriye dÃ¶nÃ¼k uyumluluk)
 * @param {string} studentId - Ã–ÄŸrenci ID'si
 */
function extractRawScoresFromExistingGrades(studentId) {
    const studentGrades = APP_STATE.gradesData[studentId];
    if (!studentGrades) return;
    
    // Ham puanlar objesi oluÅŸtur
    if (!studentGrades.hamPuanlar) {
        studentGrades.hamPuanlar = {};
    }
    
    // TÃ¼m aktiviteler iÃ§in ham puanlarÄ± Ã§Ä±kar
    const allActivities = getAllQuestionActivities();
    
    allActivities.forEach(activityId => {
        const grade = studentGrades[activityId];
        const questionNumber = getQuestionNumberFromActivity(activityId);
        
        if (grade !== undefined && questionNumber && !studentGrades.hamPuanlar[questionNumber]) {
            // Mevcut notu ham puan olarak kabul et
            if (typeof grade === 'number') {
                studentGrades.hamPuanlar[questionNumber] = grade;
                console.log(`Ham puan Ã§Ä±karÄ±ldÄ±: Ã–ÄŸrenci ${studentId}, Soru ${questionNumber} = ${grade}`);
            }
        }
    });
    
    // Ham puanlar Ã§Ä±karÄ±ldÄ±ktan sonra grup bazlÄ± hesaplama yap
    const student = APP_STATE.studentData.find(s => s.studentId === studentId);
    if (student) {
        recalculateGradesForGroupChange(studentId, student.grup);
    }
}

/**
 * Ã–ÄŸrenci test notunu getirme
 * @param {string} studentId - Ã–ÄŸrenci ID'si
 * @param {string} testId - Test ID'si
 * @returns {Object|null} - Test notlarÄ±
 */
function getStudentTestScore(studentId, testId) {
    if (!APP_STATE.gradesData[studentId] || !APP_STATE.gradesData[studentId][testId]) return null;
    
    const testGrade = APP_STATE.gradesData[studentId][testId];
    if (testGrade.type === 'test' || testGrade.tip === 'test') {
        return {
            type: 'test',
            correct: testGrade.correct || testGrade.dogru || 0,
            wrong: testGrade.wrong || testGrade.yanlis || 0
        };
    }
    
    // Test deÄŸilse null dÃ¶n
    return null;
}

/**
 * Ã–ÄŸrenci notunu gÃ¼ncelleme - Ham puan saklama sistemi
 * @param {HTMLInputElement} input - Not input elementi
 */
function updateStudentGrade(input) {
    try {
        const studentId = input.dataset.studentId;
        const activityId = input.dataset.activityId;
        
        // Aktiviteyi bul ve maksimum puanÄ±nÄ± kontrol et
        const activity = findNodeById(activityId);
        if (!activity) {
            console.error(`Aktivite bulunamadÄ±: ${activityId}`);
            return;
        }
        
        // Maksimum puan kontrolÃ¼
        const maxPoints = activity.points || 100;
        let value = parseFloat(input.value) || 0;
        
        // Maksimum puanÄ± aÅŸan deÄŸerleri sÄ±nÄ±rla
        if (value > maxPoints) {
            value = maxPoints;
            input.value = maxPoints;
            showModernToast(`Dikkat: Puan ${maxPoints} deÄŸerinden bÃ¼yÃ¼k olamaz!`, "warning");
        }
        
        // Ã–ÄŸrenci verisi oluÅŸtur
        if (!APP_STATE.gradesData[studentId]) {
            APP_STATE.gradesData[studentId] = {};
        }
        
        // v5 FORMAT: Pozisyon bazlÄ± not saklama
        const parts = activityId.split('.');
        if (parts.length > 1) {
            const parentId = parts[0]; // A1.1 -> A1
            const componentId = getParentComponentId(activityId);
            
            // Ã–ÄŸrencinin bu bileÅŸendeki grubunu al
            const studentGroup = getStudentGroupForComponent(studentId, componentId);
            
            // v5 format yapÄ±sÄ±nÄ± oluÅŸtur
            if (!APP_STATE.gradesData[studentId][parentId]) {
                APP_STATE.gradesData[studentId][parentId] = {};
            }
            
            // KaÄŸÄ±t pozisyonunu bul
            const activity_parent = findNodeById(parentId);
            if (activity_parent && activity_parent.children) {
                const questionIndex = activity_parent.children.findIndex(child => child.id === activityId);
                if (questionIndex !== -1) {
                    const position = (questionIndex + 1).toString();
                    
                    // v5 format: pozisyon bazlÄ± kayÄ±t
                    APP_STATE.gradesData[studentId][parentId][position] = {
                        puan: value,
                        soruId: activityId
                    };
                    
                    console.log(`v5 format not kaydedildi: Ã–ÄŸrenci ${studentId}, Pozisyon ${position}, Soru ${activityId} = ${value} puan`);
                }
            }
        }
        
        // Geriye uyumluluk iÃ§in doÄŸrudan eriÅŸim de saÄŸla
        APP_STATE.gradesData[studentId][activityId] = value;
        
        // Test mi kontrol et
        if (activity && activity.type === 'Test') {
            // Test skorlarÄ± iÃ§in Ã¶zel iÅŸlem
            const correctWeight = activity.testDetails?.correctWeight || 5;
            const wrongPenalty = Math.abs(activity.testDetails?.wrongPenalty || 0);
            
            // Basit yaklaÅŸÄ±m: tÃ¼m puanÄ± doÄŸru sorudan gelecek ÅŸekilde ayarla
            const correctEstimate = Math.round(value / correctWeight);
            
            APP_STATE.gradesData[studentId][activityId] = {
                tip: 'test',
                dogru: correctEstimate,
                yanlis: 0
            };
            
            // DetaylÄ± formdaki deÄŸerleri gÃ¼ncelle (varsa)
            const correctInput = document.querySelector(`input[data-student-id="${studentId}"][data-test-id="${activityId}"][data-field="correct"]`);
            const wrongInput = document.querySelector(`input[data-student-id="${studentId}"][data-test-id="${activityId}"][data-field="wrong"]`);
            
            if (correctInput) correctInput.value = correctEstimate;
            if (wrongInput) wrongInput.value = 0;
            
            // Ã–ÄŸrenci bazlÄ± gÃ¶rÃ¼nÃ¼mdeki inputlarÄ± da gÃ¼ncelle
            const studentViewCorrectInput = document.querySelector(`#studentGradesContainer input[data-student-id="${studentId}"][data-test-id="${activityId}"][data-field="correct"]`);
            const studentViewWrongInput = document.querySelector(`#studentGradesContainer input[data-student-id="${studentId}"][data-test-id="${activityId}"][data-field="wrong"]`);
            const studentViewTotalElement = document.querySelector(`#studentGradesContainer .student-test-item[data-subitem-id="${activityId}"] .total-test-score`);
            
            if (studentViewCorrectInput) studentViewCorrectInput.value = correctEstimate;
            if (studentViewWrongInput) studentViewWrongInput.value = 0;
            if (studentViewTotalElement) studentViewTotalElement.textContent = value.toFixed(2);
            
        } else {
            // Normal not iÃ§in
            APP_STATE.gradesData[studentId][activityId] = value;
            
            // Alt dÃ¼ÄŸÃ¼m yapÄ±sÄ±nÄ± oluÅŸtur (A1.1 -> A1 altÄ±nda storlama)
            const parts = activityId.split('.');
            if (parts.length > 1) {
                const parentId = parts[0]; // A1
                const shortId = parts[parts.length - 1]; // 1
                
                // EÄŸer Ã¼st aktivite yoksa oluÅŸtur
                if (!APP_STATE.gradesData[studentId][parentId]) {
                    APP_STATE.gradesData[studentId][parentId] = {
                        toplam: 0
                    };
                }
                
                // Not deÄŸerini ekle - hem tam ID, hem kÄ±sa ID olarak
                APP_STATE.gradesData[studentId][parentId][activityId] = value;
                APP_STATE.gradesData[studentId][parentId][shortId] = value;
                
                // Toplama hesapla
                updateParentActivityTotal(studentId, parentId);
            }
            
            // Ã–ÄŸrenci bazlÄ± gÃ¶rÃ¼nÃ¼mdeki inputu gÃ¼ncelle
            const studentViewInput = document.querySelector(`#studentGradesContainer input[data-student-id="${studentId}"][data-activity-id="${activityId}"]`);
            if (studentViewInput && studentViewInput !== input) {
                studentViewInput.value = value;
            }
        }
        
        // NotlarÄ± hesapla
        updateStudentCalculatedGrade(studentId);
        
        // Assessment tablosundaki not Ã¶zeti hÃ¼crelerini gÃ¼ncelle
        updateAssessmentGradeSummary(studentId);
        
        // Ã–ÄŸrenci Ã¶zet bilgilerini gÃ¼ncelle
        updateStudentSummary(studentId);
        
        // Toplam puan hÃ¼crelerini gÃ¼ncelle
        updateTotalPointsForStudent(studentId, activityId);
        
    } catch (error) {
        console.error("Ã–ÄŸrenci notu gÃ¼ncellenirken hata oluÅŸtu:", error);
        showModernToast("Not gÃ¼ncellenirken hata oluÅŸtu!", "error");
    }
}

/**
 * TÃ¼m Ã¶ÄŸrencilerin final notlarÄ±nÄ± hesapla ve kaydet
 */
function calculateFinalGrades() {
    try {
        if (!APP_STATE.studentData || APP_STATE.studentData.length === 0) {
            return;
        }
        
        // Her Ã¶ÄŸrenci iÃ§in notlarÄ± hesapla
        APP_STATE.studentData.forEach(student => {
            const studentId = student.studentId;
            
            if (!APP_STATE.gradesData[studentId]) {
                APP_STATE.gradesData[studentId] = {};
            }
            
            // YarÄ±yÄ±l iÃ§i etkinlikler
            const termActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('A'));
            let termGrade = 0;
            
            // Ä°Ã§ aÄŸÄ±rlÄ±k toplamÄ±
            const termInternalTotal = termActivities.reduce((sum, node) => sum + parseFloat(node.weight || 0), 0);
            
            if (termInternalTotal > 0) {
                termActivities.forEach(activity => {
                    // Ä°Ã§ aÄŸÄ±rlÄ±k normalleÅŸtirmesi
                    const activityWeight = activity.weight / termInternalTotal; 
                    let activityGrade = 0;
                    
                    if (activity.children && activity.children.length > 0) {
                        // Alt etkinlikler
                        const childrenTotalWeight = activity.children.reduce((sum, child) => sum + parseFloat(child.weight || 0), 0);
                        
                        if (childrenTotalWeight > 0) {
                            activity.children.forEach(subItem => {
                                // Alt Ã¶ÄŸe aÄŸÄ±rlÄ±k normalleÅŸtirmesi
                                const subItemWeight = subItem.weight / childrenTotalWeight; 
                            const grade = getStudentGrade(studentId, subItem.id) || 0;
                                const scaledGrade = (grade / (subItem.points || 1)) * 100; // 100 Ã¼zerinden
                                activityGrade += scaledGrade * subItemWeight;
                            });
                        }
                    } else {
                        // Basit etkinlik
                        const grade = getStudentGrade(studentId, activity.id) || 0;
                        activityGrade = (grade / (activity.points || 1)) * 100; // 100 Ã¼zerinden
                    }
                    
                    termGrade += activityGrade * activityWeight;
                });
            }
            
            // YarÄ±yÄ±l sonu etkinlikler
            const finalActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('F'));
            let finalGrade = 0;
            
            // Ä°Ã§ aÄŸÄ±rlÄ±k toplamÄ±
            const finalInternalTotal = finalActivities.reduce((sum, node) => sum + parseFloat(node.weight || 0), 0);
            
            if (finalInternalTotal > 0) {
                finalActivities.forEach(activity => {
                    // Ä°Ã§ aÄŸÄ±rlÄ±k normalleÅŸtirmesi
                    const activityWeight = activity.weight / finalInternalTotal;
                    let activityGrade = 0;
                    
                    if (activity.children && activity.children.length > 0) {
                        // Alt etkinlikler
                        const childrenTotalWeight = activity.children.reduce((sum, child) => sum + parseFloat(child.weight || 0), 0);
                        
                        if (childrenTotalWeight > 0) {
                            activity.children.forEach(subItem => {
                                // Alt Ã¶ÄŸe aÄŸÄ±rlÄ±k normalleÅŸtirmesi
                                const subItemWeight = subItem.weight / childrenTotalWeight;
                            const grade = getStudentGrade(studentId, subItem.id) || 0;
                                const scaledGrade = (grade / (subItem.points || 1)) * 100; // 100 Ã¼zerinden
                                activityGrade += scaledGrade * subItemWeight;
                            });
                        }
                    } else {
                        // Basit etkinlik
                        const grade = getStudentGrade(studentId, activity.id) || 0;
                        activityGrade = (grade / (activity.points || 1)) * 100; // 100 Ã¼zerinden
                    }
                    
                    finalGrade += activityGrade * activityWeight;
                });
            }
            
            // Toplam ve harf notu
            const totalGrade = (termGrade * APP_STATE.termWeight / 100) + (finalGrade * APP_STATE.finalWeight / 100);
            const letterGrade = getLetterGrade(totalGrade);
            
            // NotlarÄ± kaydet
            APP_STATE.gradesData[studentId].yariyilIciNotu = parseFloat(termGrade.toFixed(2));
            APP_STATE.gradesData[studentId].yariyilSonuNotu = parseFloat(finalGrade.toFixed(2));
            APP_STATE.gradesData[studentId].basariNotu = parseFloat(totalGrade.toFixed(2));
            APP_STATE.gradesData[studentId].harfNotu = letterGrade;
        });
        
    } catch (error) {
        console.error("Final notlarÄ± hesaplanÄ±rken hata oluÅŸtu:", error);
    }
}

/**
 * Tek bir Ã¶ÄŸrencinin hesaplanmÄ±ÅŸ notlarÄ±nÄ± gÃ¼ncelleme
 * @param {string} studentId - Ã–ÄŸrenci ID'si
 */
function updateStudentCalculatedGrade(studentId) {
    try {
        if (!APP_STATE.gradesData[studentId]) {
            return;
        }
        
        // YarÄ±yÄ±l iÃ§i etkinlikler
        const termActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('A'));
        let termGrade = 0;
        
        // Ä°Ã§ aÄŸÄ±rlÄ±k toplamÄ±
        const termInternalTotal = termActivities.reduce((sum, node) => sum + parseFloat(node.weight || 0), 0);
        
        if (termInternalTotal > 0) {
            termActivities.forEach(activity => {
                // Ä°Ã§ aÄŸÄ±rlÄ±k normalleÅŸtirmesi
                const activityWeight = activity.weight / termInternalTotal; 
                let activityGrade = 0;
                
                if (activity.children && activity.children.length > 0) {
                    // Alt etkinlikler
                    const childrenTotalWeight = activity.children.reduce((sum, child) => sum + parseFloat(child.weight || 0), 0);
                    
                    if (childrenTotalWeight > 0) {
                        activity.children.forEach(subItem => {
                            // Alt Ã¶ÄŸe aÄŸÄ±rlÄ±k normalleÅŸtirmesi
                            const subItemWeight = subItem.weight / childrenTotalWeight; 
                            const grade = getStudentGrade(studentId, subItem.id) || 0;
                            const scaledGrade = (grade / (subItem.points || 1)) * 100; // 100 Ã¼zerinden
                            activityGrade += scaledGrade * subItemWeight;
                        });
                    }
                } else {
                    // Basit etkinlik
                    const grade = getStudentGrade(studentId, activity.id) || 0;
                    activityGrade = (grade / (activity.points || 1)) * 100; // 100 Ã¼zerinden
                }
                
                termGrade += activityGrade * activityWeight;
            });
        }
        
        // YarÄ±yÄ±l sonu etkinlikler
        const finalActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('F'));
        let finalGrade = 0;
        
        // Ä°Ã§ aÄŸÄ±rlÄ±k toplamÄ±
        const finalInternalTotal = finalActivities.reduce((sum, node) => sum + parseFloat(node.weight || 0), 0);
        
        if (finalInternalTotal > 0) {
            finalActivities.forEach(activity => {
                // Ä°Ã§ aÄŸÄ±rlÄ±k normalleÅŸtirmesi
                const activityWeight = activity.weight / finalInternalTotal;
                let activityGrade = 0;
                
                if (activity.children && activity.children.length > 0) {
                    // Alt etkinlikler
                    const childrenTotalWeight = activity.children.reduce((sum, child) => sum + parseFloat(child.weight || 0), 0);
                    
                    if (childrenTotalWeight > 0) {
                        activity.children.forEach(subItem => {
                            // Alt Ã¶ÄŸe aÄŸÄ±rlÄ±k normalleÅŸtirmesi
                            const subItemWeight = subItem.weight / childrenTotalWeight;
                            const grade = getStudentGrade(studentId, subItem.id) || 0;
                            const scaledGrade = (grade / (subItem.points || 1)) * 100; // 100 Ã¼zerinden
                            activityGrade += scaledGrade * subItemWeight;
                        });
                    }
                } else {
                    // Basit etkinlik
                    const grade = getStudentGrade(studentId, activity.id) || 0;
                    activityGrade = (grade / (activity.points || 1)) * 100; // 100 Ã¼zerinden
                }
                
                finalGrade += activityGrade * activityWeight;
            });
        }
        
        // Toplam ve harf notu
        const totalGrade = (termGrade * APP_STATE.termWeight / 100) + (finalGrade * APP_STATE.finalWeight / 100);
        const letterGrade = getLetterGrade(totalGrade);
        
        // HesaplanmÄ±ÅŸ not bilgilerini ekle
        APP_STATE.gradesData[studentId].yariyilIciNotu = parseFloat(termGrade.toFixed(2));
        APP_STATE.gradesData[studentId].yariyilSonuNotu = parseFloat(finalGrade.toFixed(2));
        APP_STATE.gradesData[studentId].basariNotu = parseFloat(totalGrade.toFixed(2));
        APP_STATE.gradesData[studentId].harfNotu = letterGrade;
        
    } catch (error) {
        console.error("Ã–ÄŸrenci notu hesaplanÄ±rken hata oluÅŸtu:", error);
    }
}

/**
 * Test skorunu gÃ¼ncelleme
 * @param {HTMLInputElement} input - Test skoru input elementi
 */
function updateTestScore(input) {
    try {
        const studentId = input.dataset.studentId;
        const testId = input.dataset.testId;
        const field = input.dataset.field;
        const value = parseInt(input.value) || 0;
        
        // Test verisini gÃ¼ncelle
        updateTestScoreData(studentId, testId, field, value);
        
        // Ä°lgili gÃ¶rÃ¼nÃ¼m alanlarÄ±nÄ± gÃ¼ncelle
        updateTestScoreViews(studentId, testId, field, value, input);
        
        // Test sorularÄ±na rastgele doÄŸru/yanlÄ±ÅŸ daÄŸÄ±lÄ±mÄ± yap
        const testScore = APP_STATE.gradesData[studentId][testId];
        if (testScore && (field === 'correct' || field === 'wrong')) {
            // DoÄŸru/yanlÄ±ÅŸ deÄŸeri deÄŸiÅŸtiÄŸinde modern test skoru daÄŸÄ±tÄ±m modalÄ±nÄ± gÃ¶ster
            showTestScoreDistributionModal(studentId, testId);
        }
    } catch (error) {
        console.error("Test skoru gÃ¼ncellenirken hata oluÅŸtu:", error);
        showModernToast("Test skoru gÃ¼ncellenirken hata oluÅŸtu!", "error");
    }
}

// Test score gÃ¶rÃ¼nÃ¼mlerini gÃ¼ncelleme (yardÄ±mcÄ± fonksiyon)
function updateTestScoreViews(studentId, testId, field, value, sourceInput) {
    const testNode = findNodeById(testId);
    if (!testNode) return;
    
    const testScore = APP_STATE.gradesData[studentId][testId];
    const correct = testScore.dogru || 0;
    const wrong = testScore.yanlis || 0;
    const correctWeight = testNode.testDetails.correctWeight;
    const wrongPenalty = Math.abs(testNode.testDetails.wrongPenalty);
    const totalScore = correct * correctWeight - wrong * wrongPenalty;
    
    // DeÄŸerlendirme sekmesindeki toplam puan hÃ¼cresini gÃ¼ncelle
    const assessmentRow = document.querySelector(`tr:has(input[data-student-id="${studentId}"][data-test-id="${testId}"])`);
    const assessmentTotalScore = assessmentRow?.querySelector('.total-score');
    if (assessmentTotalScore) {
        assessmentTotalScore.textContent = totalScore.toFixed(2);
    }
    
    // Basit giriÅŸ formundaki deÄŸeri de gÃ¼ncelle
    const simpleInput = document.querySelector(`input[data-student-id="${studentId}"][data-activity-id="${testId}"]`);
    if (simpleInput) {
        simpleInput.value = totalScore.toFixed(2);
    }
    
    // Ã–ÄŸrenci gÃ¶rÃ¼nÃ¼mÃ¼ndeki ilgili alanlarÄ± gÃ¼ncelle
    if (field === 'correct' || field === 'wrong') {
        // KarÅŸÄ±lÄ±k gelen inputu bul ve gÃ¼ncelle (kendisi deÄŸilse)
        const studentViewInput = document.querySelector(`#studentGradesContainer input[data-student-id="${studentId}"][data-test-id="${testId}"][data-field="${field}"]`);
        if (studentViewInput && studentViewInput !== sourceInput) {
            studentViewInput.value = value;
        }
    }
    
    // Ã–ÄŸrenci gÃ¶rÃ¼nÃ¼mÃ¼ndeki toplam skoru gÃ¼ncelle
    updateStudentViewTestTotal(studentId, testId);
    
    // NotlarÄ± yeniden hesapla
    updateStudentCalculatedGrade(studentId);
    
    // Ã–ÄŸrenci Ã¶zet bilgilerini gÃ¼ncelle
    updateStudentSummary(studentId);
    
    // Assessment tablosundaki not Ã¶zeti hÃ¼crelerini gÃ¼ncelle
    updateAssessmentGradeSummary(studentId);
        
        // Assessment tablosundaki not Ã¶zeti hÃ¼crelerini gÃ¼ncelle
        updateAssessmentGradeSummary(studentId);
}

/**
 * NotlarÄ± hesaplama ve gÃ¶rÃ¼ntÃ¼leme
 */
function calculateGrades() {
    try {
        if (!APP_STATE.gradesData || Object.keys(APP_STATE.gradesData).length === 0) {
            showModernToast("HenÃ¼z not giriÅŸi yapÄ±lmamÄ±ÅŸ!", "warning");
            return;
        }
        
        // TÃ¼m notlarÄ± hesapla
        calculateFinalGrades();
        
        // Notlar tablosunu gÃ¶ster
        const finalGrades = {};
        
        APP_STATE.studentData.forEach(student => {
            const studentId = student.studentId;
            if (!APP_STATE.gradesData[studentId]) {
                finalGrades[studentId] = {
                    studentId,
                    name: student.name,
                    surname: student.surname,
                    termGrade: 0,
                    finalGrade: 0,
                    totalGrade: 0,
                    letterGrade: 'FF'
                };
                return;
            }
            
            finalGrades[studentId] = {
                studentId,
                name: student.name,
                surname: student.surname,
                termGrade: APP_STATE.gradesData[studentId].yariyilIciNotu || 0,
                finalGrade: APP_STATE.gradesData[studentId].yariyilSonuNotu || 0,
                totalGrade: APP_STATE.gradesData[studentId].basariNotu || 0,
                letterGrade: APP_STATE.gradesData[studentId].harfNotu || 'FF'
            };
        });

        // Notlar sekmesine geÃ§
        switchTab('grades');
        
        // Notlar tablosunu gÃ¼ncelle
        updateGradesTable(finalGrades);
        
        // Ä°statistikleri gÃ¼ncelle
        updateGradeStatistics(finalGrades);
        
        showModernToast("Notlar baÅŸarÄ±yla hesaplandÄ±.");
    } catch (error) {
        console.error("Notlar hesaplanÄ±rken hata oluÅŸtu:", error);
        showModernToast("Notlar hesaplanÄ±rken hata oluÅŸtu!", "error");
    }
}

/**
 * Notlar tablosunu gÃ¼ncelleme
 * @param {Object} finalGrades - Hesaplanan son notlar
 */
function updateGradesTable(finalGrades) {
    try {
        const tableBody = document.createElement('tbody');
        
        APP_STATE.studentData.forEach((student, index) => {
            const studentGrade = finalGrades[student.studentId] || {
                termGrade: 0,
                finalGrade: 0,
                totalGrade: 0,
                letterGrade: 'FF'
            };
            
            const row = document.createElement('tr');
            
            // GeÃ§me/kalma durumuna gÃ¶re satÄ±r stilini belirle
            const letterGrade = studentGrade.letterGrade;
            if (['AA', 'BA', 'BB', 'CB', 'CC'].includes(letterGrade)) {
                row.style.backgroundColor = 'rgba(40, 167, 69, 0.1)'; // BaÅŸarÄ±lÄ±
            } else if (['DC', 'DD'].includes(letterGrade)) {
                row.style.backgroundColor = 'rgba(255, 193, 7, 0.1)'; // KoÅŸullu baÅŸarÄ±lÄ±
            } else {
                row.style.backgroundColor = 'rgba(220, 53, 69, 0.1)'; // BaÅŸarÄ±sÄ±z
            }
            
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${student.studentId}</td>
                <td>${student.name}</td>
                <td>${student.surname}</td>
                <td>${studentGrade.termGrade}</td>
                <td>${studentGrade.finalGrade}</td>
                <td>${studentGrade.totalGrade}</td>
                <td>${studentGrade.letterGrade}</td>
            `;
            tableBody.appendChild(row);
        });
        
        // Tabloyu gÃ¼ncelle - genel aÄŸÄ±rlÄ±klarÄ± da gÃ¶ster
        gradesTable.innerHTML = `
            <thead>
                <tr>
                    <th>No</th>
                    <th>Ã–ÄŸrenci No</th>
                    <th>AdÄ±</th>
                    <th>SoyadÄ±</th>
                    <th>YarÄ±yÄ±l Ä°Ã§i (${APP_STATE.termWeight}%)</th>
                    <th>YarÄ±yÄ±l Sonu (${APP_STATE.finalWeight}%)</th>
                    <th>Toplam Puan</th>
                    <th>Harf Notu</th>
                </tr>
            </thead>
        `;
        gradesTable.appendChild(tableBody);
    } catch (error) {
        console.error("Notlar tablosu gÃ¼ncellenirken hata oluÅŸtu:", error);
    }
}

/**
 * Not istatistiklerini gÃ¼ncelleme
 * @param {Object} finalGrades - Hesaplanan son notlar
 */
function updateGradeStatistics(finalGrades) {
    try {
        const grades = Object.values(finalGrades);
        
        // Ortalama hesapla
        const totalSum = grades.reduce((sum, grade) => sum + parseFloat(grade.totalGrade), 0);
        const average = totalSum / grades.length;
        
        // Harf notlarÄ± daÄŸÄ±lÄ±mÄ±
        const letterGradeCounts = {};
        grades.forEach(grade => {
            const letter = grade.letterGrade;
            letterGradeCounts[letter] = (letterGradeCounts[letter] || 0) + 1;
        });
        
        // GeÃ§me/kalma oranÄ±
        const passingLetters = ['AA', 'BA', 'BB', 'CB', 'CC', 'DC', 'DD'];
        const passingCount = grades.filter(grade => passingLetters.includes(grade.letterGrade)).length;
        const failingCount = grades.length - passingCount;
        const passRate = (passingCount / grades.length) * 100;
        
        // Ä°statistikleri gÃ¶ster
        statsContent.innerHTML = `
            <div class="stats-grid">
                <div class="stats-card">
                    <h5>Genel Ä°statistikler</h5>
                    <p>SÄ±nÄ±f Mevcudu: <strong>${grades.length}</strong> Ã¶ÄŸrenci</p>
                    <p>SÄ±nÄ±f OrtalamasÄ±: <strong>${average.toFixed(2)}</strong></p>
                    <p>GeÃ§en Ã–ÄŸrenci SayÄ±sÄ±: <strong>${passingCount}</strong> (${passRate.toFixed(2)}%)</p>
                    <p>Kalan Ã–ÄŸrenci SayÄ±sÄ±: <strong>${failingCount}</strong> (${(100 - passRate).toFixed(2)}%)</p>
                </div>
                
                <div class="stats-card">
                    <h5>Harf Notu DaÄŸÄ±lÄ±mÄ±</h5>
                    <ul class="grade-distribution">
                        ${Object.entries(letterGradeCounts).sort().map(([letter, count]) => {
                            // Harf notuna gÃ¶re renk belirle
                            let colorClass = '';
                            if (['AA', 'BA', 'BB'].includes(letter)) {
                                colorClass = 'grade-high';
                            } else if (['CB', 'CC'].includes(letter)) {
                                colorClass = 'grade-mid';
                            } else if (['DC', 'DD'].includes(letter)) {
                                colorClass = 'grade-low';
                            } else {
                                colorClass = 'grade-fail';
                            }
                            
                            return `
                                <li class="${colorClass}">
                                    <span class="grade-letter">${letter}</span>
                                    <span class="grade-count">${count} Ã¶ÄŸrenci</span>
                                    <span class="grade-percent">(${((count / grades.length) * 100).toFixed(2)}%)</span>
                                    <div class="grade-bar" style="width: ${(count / grades.length) * 100}%"></div>
                                </li>
                            `;
                        }).join('')}
                    </ul>
                </div>
            </div>
        `;
        
        // Grafik oluÅŸtur (eÄŸer Chart.js kÃ¼tÃ¼phanesi yÃ¼klenmiÅŸse)
        if (window.Chart) {
            chartContainer.innerHTML = '<canvas id="gradeChart"></canvas>';
            const ctx = document.getElementById('gradeChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(letterGradeCounts).sort(),
                    datasets: [{
                        data: Object.values(letterGradeCounts).sort((a, b) => b - a),
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.8)', // AA
                            'rgba(40, 167, 69, 0.6)', // BA
                            'rgba(40, 167, 69, 0.4)', // BB
                            'rgba(23, 162, 184, 0.8)', // CB
                            'rgba(23, 162, 184, 0.6)', // CC
                            'rgba(255, 193, 7, 0.8)', // DC
                            'rgba(255, 193, 7, 0.6)', // DD
                            'rgba(220, 53, 69, 0.8)', // FD
                            'rgba(220, 53, 69, 0.6)'  // FF
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    legend: {
                        position: 'right',
                    },
                    title: {
                        display: true,
                        text: 'Harf Notu DaÄŸÄ±lÄ±mÄ±'
                    }
                }
            });
        }
    } catch (error) {
        console.error("Not istatistikleri gÃ¼ncellenirken hata oluÅŸtu:", error);
    }
}

// =====================================================
// Ã–ÄRENCÄ° VERÄ°LERÄ° FONKSIYONLARI
// =====================================================

/**
 * Ã–ÄŸrenci tablosunu gÃ¼ncelleme
 */
function updateStudentTable() {
    try {
        const tableHeader = document.createElement('tr');
        tableHeader.innerHTML = `
            <th>No</th>
            <th>Ã–ÄŸrenci No</th>
            <th>AdÄ±</th>
            <th>SoyadÄ±</th>
            <th>Durum</th>
        `;
        
        const tableBody = document.createElement('tbody');
        tableBody.appendChild(tableHeader);
        
        if (!APP_STATE.studentData || APP_STATE.studentData.length === 0) {
            const emptyRow = document.createElement('tr');
            emptyRow.innerHTML = `<td colspan="5" class="empty-message">Ã–ÄŸrenci listesi yÃ¼klenmedi</td>`;
            tableBody.appendChild(emptyRow);
        } else {
            APP_STATE.studentData.forEach((student, index) => {
                const row = document.createElement('tr');
                
                // Duruma gÃ¶re satÄ±r stili
                if (student.status === 'Ä°liÅŸiÄŸi KesilmiÅŸ') {
                    row.style.color = 'var(--text-light)';
                    row.style.backgroundColor = 'rgba(0, 0, 0, 0.05)';
                }
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${student.studentId}</td>
                    <td>${student.name}</td>
                    <td>${student.surname}</td>
                    <td>${student.status || 'Aktif'}</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        studentTable.innerHTML = '';
        studentTable.appendChild(tableBody);
        
        // Grup sistemini baÅŸlat
        initializeGroupSystem();
        
        // Ã–Ã‡ tooltip sistemini baÅŸlat
        initializeOutcomeTooltips();
        
        // Default grup atamasÄ±nÄ± yap
        assignDefaultGroups();
        
        // Ã–ÄŸrenci grup bilgilerini gÃ¼ncelle
        updateStudentGroupInfoDisplay();
        
        // Debug: Grup atamalarÄ±nÄ± konsola yazdÄ±r
        debugGroupAssignments();
        
        // Ã–ÄŸrenci filtresi seÃ§eneklerini gÃ¼ncelle
        updateAssessmentStudentFilterOptions();
        
        // DeÄŸerlendirme gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ gÃ¼ncelle
        updateAssessmentView();
    } catch (error) {
        console.error("Ã–ÄŸrenci tablosu gÃ¼ncellenirken hata oluÅŸtu:", error);
        showModernToast("Ã–ÄŸrenci tablosu gÃ¼ncellenemedi!", "error");
    }
}

/**
 * Ã–ÄŸrenci grup bilgilerini gÃ¶sterme
 */
function updateStudentGroupInfoDisplay() {
    try {
        const studentGroupInfoCard = document.getElementById('studentGroupInfoCard');
        const studentGroupInfoContainer = document.getElementById('studentGroupInfoContainer');
        
        if (!studentGroupInfoCard || !studentGroupInfoContainer) {
            return;
        }
        
        // Ã–ÄŸrenci verisi yoksa kartÄ± gizle
        if (!APP_STATE.studentData || APP_STATE.studentData.length === 0) {
            studentGroupInfoCard.style.display = 'none';
            return;
        }
        
        // Grup bilgisi yoksa basit mesaj gÃ¶ster
        if (!APP_STATE.courseData?.grupHaritalari || Object.keys(APP_STATE.courseData.grupHaritalari).length === 0) {
            studentGroupInfoCard.style.display = 'block';
            studentGroupInfoContainer.innerHTML = '<p class="empty-message">HenÃ¼z grup atamasÄ± yapÄ±lmamÄ±ÅŸ. Grup dÃ¼zenlemeleri "DeÄŸerlendirme GiriÅŸi" sekmesinden yapabilirsiniz.</p>';
            return;
        }
        
        // Sadece ana etkinliklerin grup bilgilerini topla (alt bileÅŸenler hariÃ§)
        const mainComponentGroups = {};
        Object.keys(APP_STATE.courseData.grupHaritalari).forEach(componentId => {
            // Sadece ana etkinlikleri al (A1, A2, F1, F2 gibi - nokta iÃ§ermeyenler)
            if (!componentId.includes('.')) {
            const component = APP_STATE.courseData.grupHaritalari[componentId];
            if (component.gruplar && component.gruplar.length > 0) {
                    mainComponentGroups[componentId] = component.gruplar;
                }
            }
        });
        
        // Grup bilgisi varsa detaylÄ± gÃ¶sterim
        if (Object.keys(mainComponentGroups).length > 0) {
            let html = '<div class="group-info-grid">';
            
            Object.keys(mainComponentGroups).forEach(componentId => {
                const groups = mainComponentGroups[componentId];
                
                // Ana etkinlik iÃ§in grup bilgisi
                html += `
                    <div class="component-group-card">
                        <h4 class="component-title">${getComponentDisplayName(componentId)}</h4>
                        <div class="group-distribution">
                `;
                
                groups.forEach(groupId => {
                    // Ã–ÄŸrencileri bu gruba ata ve filtrele
                    const studentsInGroup = APP_STATE.studentData.filter(student => {
                        const studentGroup = getStudentGroupForComponent(student.studentId, componentId);
                        return studentGroup === groupId;
                    });
                    
                    // EÄŸer tek grup varsa ve hiÃ§ Ã¶ÄŸrenci atanmamÄ±ÅŸsa, tÃ¼m Ã¶ÄŸrencileri bu gruba ata
                    if (groups.length === 1 && studentsInGroup.length === 0 && groupId === 'A') {
                        // TÃ¼m Ã¶ÄŸrencileri A grubuna ata
                        APP_STATE.studentData.forEach(student => {
                            if (!student.grup || !groups.includes(student.grup)) {
                                student.grup = 'A';
                            }
                            // BileÅŸen bazlÄ± grup atamasÄ± da yap
                            if (!APP_STATE.studentComponentGroups) {
                                APP_STATE.studentComponentGroups = {};
                            }
                            if (!APP_STATE.studentComponentGroups[student.studentId]) {
                                APP_STATE.studentComponentGroups[student.studentId] = {};
                            }
                            APP_STATE.studentComponentGroups[student.studentId][componentId] = 'A';
                        });
                        // Yeniden filtrele
                        const allStudents = APP_STATE.studentData.slice();
                        studentsInGroup.length = 0;
                        studentsInGroup.push(...allStudents);
                    }
                    
                    html += `
                        <div class="group-item">
                            <span class="group-badge">${groupId} Grubu</span>
                            <span class="student-count">${studentsInGroup.length} Ã¶ÄŸrenci</span>
                            <div class="student-list">
                                ${studentsInGroup.map(s => `<span class="student-name">${s.name} ${s.surname}</span>`).join(', ')}
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                `;
                
                // Ana etkinliÄŸin alt bileÅŸenlerini gÃ¶ster
                const mainActivity = APP_STATE.assessmentTree.find(node => node.id === componentId);
                if (mainActivity && mainActivity.children && mainActivity.children.length > 0) {
                    html += `
                        <div class="sub-components-info">
                            <h5 class="sub-components-title">Alt BileÅŸenler:</h5>
                            <div class="sub-components-list">
                    `;
                    
                    mainActivity.children.forEach(subComponent => {
                        html += `
                            <div class="sub-component-item">
                                <span class="sub-component-id">${subComponent.id}</span>
                                <span class="sub-component-name">${subComponent.name}</span>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
                
                html += `
                    </div>
                `;
            });
            
            html += '</div>';
            studentGroupInfoContainer.innerHTML = html;
        } else {
            studentGroupInfoContainer.innerHTML = '<p class="empty-message">TÃ¼m bileÅŸenler tek grup kullanÄ±yor. Grup dÃ¼zenlemeleri "DeÄŸerlendirme GiriÅŸi" sekmesinden yapabilirsiniz.</p>';
        }
        
        studentGroupInfoCard.style.display = 'block';
        
    } catch (error) {
        console.error("Ã–ÄŸrenci grup bilgileri gÃ¼ncellenirken hata:", error);
    }
}

/**
 * BileÅŸen ID'sinden etkinlik adÄ±nÄ± getir
 * @param {string} componentId - BileÅŸen ID'si (A1, A2, F1, vb.)
 * @returns {string} - Etkinlik adÄ±
 */
function getComponentDisplayName(componentId) {
    try {
        // assessmentTree'den ilgili bileÅŸeni bul
        const component = APP_STATE.assessmentTree?.find(node => node.id === componentId);
        
        if (component && component.name) {
            return `${componentId} - ${component.name}`;
        }
        
        // EÄŸer bulunamazsa sadece ID'yi dÃ¶ndÃ¼r
        return `${componentId} BileÅŸeni`;
    } catch (error) {
        console.error('BileÅŸen adÄ± alÄ±nÄ±rken hata:', error);
        return `${componentId} BileÅŸeni`;
    }
}

/**
 * Debug: Grup atamalarÄ±nÄ± konsola yazdÄ±r
 */
function debugGroupAssignments() {
    try {
        console.log('\n=== ğŸ” DEBUG: GRUP ATAMALARI ===');
        
        if (!APP_STATE.studentData || APP_STATE.studentData.length === 0) {
            console.log('âš ï¸ Ã–ÄŸrenci verisi yok');
            return;
        }
        
        console.log(`ğŸ‘¥ Toplam Ã¶ÄŸrenci sayÄ±sÄ±: ${APP_STATE.studentData.length}`);
        
        // Genel grup atamalarÄ±
        console.log('\nğŸ“‹ Genel grup atamalarÄ±:');
        APP_STATE.studentData.forEach((student, index) => {
            console.log(`  ${index + 1}. ${student.name} ${student.surname} (${student.studentId}) â†’ Grup: ${student.grup || 'YOK'}`);
        });
        
        // BileÅŸen bazlÄ± grup atamalarÄ±
        if (APP_STATE.courseData?.grupHaritalari) {
            console.log('\nğŸ¯ BileÅŸen bazlÄ± grup atamalarÄ±:');
            Object.keys(APP_STATE.courseData.grupHaritalari).forEach(componentId => {
                const component = APP_STATE.courseData.grupHaritalari[componentId];
                console.log(`\n  ğŸ“Š ${getComponentDisplayName(componentId)} (Gruplar: ${component.gruplar?.join(', ') || 'YOK'}):`);
                
                APP_STATE.studentData.forEach((student, index) => {
                    const studentGroup = getStudentGroupForComponent(student.studentId, componentId);
                    console.log(`    ${index + 1}. ${student.name} ${student.surname} â†’ ${studentGroup}`);
                });
            });
        }
        
        console.log('\n=== ğŸ” DEBUG TAMAMLANDI ===\n');
        
    } catch (error) {
        console.error('Debug grup atamalarÄ± sÄ±rasÄ±nda hata:', error);
    }
}

/**
 * Bir Ã¶ÄŸrencinin belirli bir bileÅŸendeki grubunu al
 * @param {string} studentId - Ã–ÄŸrenci ID
 * @param {string} componentId - BileÅŸen ID
 * @returns {string} - Grup ID
 */
function getStudentGroupForComponent(studentId, componentId) {
    // Bu bileÅŸenin mevcut gruplarÄ±nÄ± kontrol et
    const component = APP_STATE.courseData?.grupHaritalari?.[componentId];
    const availableGroups = component?.gruplar || ['A'];
    
    console.log(`ğŸ” getStudentGroupForComponent(${studentId}, ${componentId}): availableGroups=${availableGroups.join(',')}`);
    
    // 1. Ã–NCELÄ°K: courseData.ogrenciNotlari v5 formatÄ±ndan grup bilgisini al (en gÃ¼ncel)
    if (APP_STATE.courseData && APP_STATE.courseData.ogrenciNotlari && APP_STATE.courseData.ogrenciNotlari[studentId] &&
        APP_STATE.courseData.ogrenciNotlari[studentId].grupBilgileri && 
        APP_STATE.courseData.ogrenciNotlari[studentId].grupBilgileri[componentId]) {
        const courseDataGroup = APP_STATE.courseData.ogrenciNotlari[studentId].grupBilgileri[componentId];
        if (availableGroups.includes(courseDataGroup)) {
            console.log(`  âœ… courseData v5 formatÄ±ndan grup bulundu: ${courseDataGroup}`);
            return courseDataGroup;
        }
    }
    
    // 2. Ä°KÄ°NCÄ° Ã–NCELÄ°K: gradesData v5 formatÄ±ndan grup bilgisini al
    if (APP_STATE.gradesData && APP_STATE.gradesData[studentId] && 
        APP_STATE.gradesData[studentId].grupBilgileri && 
        APP_STATE.gradesData[studentId].grupBilgileri[componentId]) {
        const v5Group = APP_STATE.gradesData[studentId].grupBilgileri[componentId];
        if (availableGroups.includes(v5Group)) {
            console.log(`  âœ… gradesData v5 formatÄ±ndan grup bulundu: ${v5Group}`);
            return v5Group;
        }
    }
    
    // 3. ÃœÃ‡ÃœNCÃœ Ã–NCELÄ°K: Runtime sistem (studentComponentGroups)
    if (APP_STATE.studentComponentGroups && 
        APP_STATE.studentComponentGroups[studentId] && 
        APP_STATE.studentComponentGroups[studentId][componentId]) {
        const componentGroup = APP_STATE.studentComponentGroups[studentId][componentId];
        if (availableGroups.includes(componentGroup)) {
            console.log(`  âœ… Runtime sisteminden grup bulundu: ${componentGroup}`);
            return componentGroup;
        }
    }
    
    // 4. DÃ–RDÃœNCÃœ Ã–NCELÄ°K: Ã–ÄŸrencinin genel grubu
    const student = APP_STATE.studentData?.find(s => s.studentId === studentId);
    if (student && student.grup && availableGroups.includes(student.grup)) {
        console.log(`  âœ… Ã–ÄŸrencinin genel grubundan: ${student.grup}`);
        return student.grup;
    }
    
    // 5. VARSAYILAN: Bu bileÅŸenin ilk grubunu dÃ¶ndÃ¼r (genellikle A)
    const defaultGroup = availableGroups[0] || 'A';
    console.log(`  ğŸ”§ VarsayÄ±lan grup kullanÄ±lÄ±yor: ${defaultGroup}`);
    return defaultGroup;
}

/**
 * Ã–ÄŸrenci listesini temizleme
 */
function clearStudents() {
    // Ã–nce silinecek Ã¶ÄŸrenci var mÄ± kontrol et
    const hasStudents = (APP_STATE.studentData && APP_STATE.studentData.length > 0) || 
                       (APP_STATE.students && APP_STATE.students.length > 0);
    
    if (!hasStudents) {
        showModernToast("â„¹ï¸ Silinecek Ã¶ÄŸrenci bulunmuyor.", "info");
        return;
    }
    
    showModernConfirm(
        'ğŸ“ Ã–ÄŸrenci Listesini Temizle',
        'Ã–ÄŸrenci listesini temizlemek istediÄŸinizden emin misiniz?\n\nâ€¢ Ã–ÄŸrenci listesi silinecek\nâ€¢ Notlar korunacak\nâ€¢ DeÄŸerlendirme yapÄ±sÄ± korunacak\n\nBu iÅŸlem geri alÄ±namaz!',
        function() {
            try {
                APP_STATE.studentData = [];
                APP_STATE.gradesData = {};
                updateStudentTable();
                
                // DeÄŸerlendirme gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ gÃ¼ncelle
                updateAssessmentView();
                
                showModernToast("ğŸ“ Ã–ÄŸrenci listesi temizlendi!", "success");
            } catch (error) {
                console.error("Ã–ÄŸrenci listesi temizlenirken hata oluÅŸtu:", error);
                showModernToast("âŒ Ã–ÄŸrenci listesi temizlenemedi!", "error");
            }
        }
    );
}

/**
 * Ã–ÄŸrenci verilerini iÃ§e aktarma - TÃ¼m formatlarÄ± destekler
 * @param {Object} jsonData - JSON veri
 */
function importStudentData(jsonData) {
    try {
        let studentData = [];
        let gradesData = {};
        
        // Ã–ÄŸrenci listesini farklÄ± formatlarda kontrol et
        if (jsonData.ogrenciler && Array.isArray(jsonData.ogrenciler)) {
            // Format 1: Ders deÄŸerlendirme sistemi formatÄ±
            studentData = jsonData.ogrenciler.map(student => ({
                studentId: student.ogrenciNo,
                name: student.ad,
                surname: student.soyad,
                status: student.durum || 'Aktif',
                grup: student.grup || 'A',
                email: student.email || '', // Email bilgisini koru
                tcKimlik: student.tcKimlik || '', // TC Kimlik bilgisini koru
                telefon: student.telefon || '' // Telefon bilgisini koru
            }));
            
            // ogrenciNotlari formatÄ±
            if (jsonData.ogrenciNotlari) {
                gradesData = jsonData.ogrenciNotlari;
            }
        } 
        else if (jsonData.students && Array.isArray(jsonData.students)) {
            // Format 2: Normal/Ä°ngilizce format
            studentData = jsonData.students.map(student => ({
                studentId: student.student_id || student.studentId || student.ogrenciNo,
                name: student.name || student.ad,
                surname: student.surname || student.soyad,
                status: student.status || student.durum || 'Aktif',
                grup: student.grup || student.group || 'A',
                email: student.email || '', // Email bilgisini koru
                tcKimlik: student.tcKimlik || '', // TC Kimlik bilgisini koru
                telefon: student.telefon || '' // Telefon bilgisini koru
            }));
            
            // grades veya rawGrades formatÄ±
            if (jsonData.grades) {
                gradesData = jsonData.grades;
            } else if (jsonData.rawGrades) {
                gradesData = jsonData.rawGrades;
            }
        } 
        else if (jsonData.courseData && jsonData.courseData.ogrenciler) {
            // Format 3: Excel-to-MUDEK formatÄ±
            studentData = jsonData.courseData.ogrenciler.map(student => ({
                studentId: student.ogrenciNo,
                name: student.ad,
                surname: student.soyad,
                status: student.durum || 'Aktif',
                grup: student.grup || 'A',
                email: student.email || '', // Email bilgisini koru
                tcKimlik: student.tcKimlik || '', // TC Kimlik bilgisini koru
                telefon: student.telefon || '' // Telefon bilgisini koru
            }));
        } 
        else {
            throw new Error('GeÃ§erli Ã¶ÄŸrenci verisi bulunamadÄ±.');
        }
        
        if (!studentData.length) {
            throw new Error('Ã–ÄŸrenci listesi boÅŸ.');
        }
        
        // Ã–ÄŸrenci verilerini kaydet
        APP_STATE.studentData = studentData;
        
        // Grup haritasÄ± bilgilerini yÃ¼kle
        if (jsonData.grupHaritalari) {
            if (!APP_STATE.courseData) {
                APP_STATE.courseData = {};
            }
            APP_STATE.courseData.grupHaritalari = jsonData.grupHaritalari;
            console.log('Grup haritalarÄ± yÃ¼klendi:', jsonData.grupHaritalari);
        }
        
        // Grup sistemini baÅŸlat
        initializeGroupSystem();
        
        // TÃ¼m ilgili UI'larÄ± gÃ¼ncelle
        updateStudentTable();
        updateGroupSelectors();
        // updateStudentSelector fonksiyonu kaldÄ±rÄ±ldÄ± (Ã–ÄŸrenci BazlÄ± Not GiriÅŸi sekmesi ile birlikte)
        updateAllInlineGroupInputs();
        updateAllMappingDisplays();
        
        // Not verilerini de yÃ¼kle
        if (Object.keys(gradesData).length > 0) {
            APP_STATE.gradesData = gradesData;
            console.log('Not verileri yÃ¼klendi:', Object.keys(gradesData).length, 'Ã¶ÄŸrenci');
            
            // HAM PUAN KONTROLÃœ VE GRUP BAZLI HESAPLAMA
            recalculateAllGradesBasedOnGroups();
        }
        
        // DeÄŸerlendirme gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ gÃ¼ncelle
        updateAssessmentView();
        
        // DeÄŸerlendirme sekmesine geÃ§
        switchTab('assessment');
        
        showModernToast(`${APP_STATE.studentData.length} Ã¶ÄŸrenci baÅŸarÄ±yla yÃ¼klendi.`);
    } catch (error) {
        console.error("Ã–ÄŸrenci verileri iÃ§e aktarÄ±lÄ±rken hata oluÅŸtu:", error);
        showModernToast("Ã–ÄŸrenci verileri iÃ§e aktarÄ±lamadÄ±! LÃ¼tfen dosya formatÄ±nÄ± kontrol edin.", "error");
        throw error;
    }
}

// =====================================================
// JSON VE DOSYA Ä°ÅLEMLERÄ°
// =====================================================

/**
 * Not verilerini iÃ§e aktarma
 */
function importGrades() {
    try {
        // Not giriÅŸlerinin kontrolÃ¼
        if (!APP_STATE.assessmentTree.length || !APP_STATE.studentData.length) {
            showModernToast("DeÄŸerlendirme kriterleri ve Ã¶ÄŸrenci listesi yÃ¼klenmeden not giriÅŸi yapÄ±lamaz!", "warning");
            return;
        }
        
        // Not iÃ§e aktarma modalÄ±nÄ± gÃ¶ster
        openModal(importModal);
        
        // Modalda aÃ§Ä±klama ekle
        jsonContent.value = "";
        jsonContent.placeholder = "Not verilerini JSON formatÄ±nda yapÄ±ÅŸtÄ±rÄ±n veya dosyadan yÃ¼kleyin.\n\n" +
            "Ã–rnek format:\n{\n  \"12345\": {\n    \"A1\": 85,\n    \"F1\": 75\n  }\n}";
            
        // ModalÄ±n baÅŸlÄ±ÄŸÄ±nÄ± deÄŸiÅŸtir
        document.querySelector('#importModal .modal-header h2').textContent = "NotlarÄ± Ä°Ã§e Aktar";
        
        // Apply butonuna farklÄ± bir iÅŸlev ata
        btnApplyJson.onclick = function() {
            applyGradesJson();
        };
        
    } catch (error) {
        console.error("Not iÃ§e aktarma modalÄ± gÃ¶sterilirken hata oluÅŸtu:", error);
        showModernToast("Not iÃ§e aktarma iÅŸlemi baÅŸlatÄ±lamadÄ±!", "error");
    }
}

/**
 * Not JSON verilerini uygulama
 */
function applyGradesJson() {
    try {
        const jsonString = jsonContent.value.trim();
        
        if (!jsonString) {
            showModernToast("LÃ¼tfen geÃ§erli bir JSON iÃ§eriÄŸi girin.", "warning");
            return;
        }
        
        const jsonData = JSON.parse(jsonString);
        
        // Temel doÄŸrulama
        if (!jsonData || typeof jsonData !== 'object') {
            throw new Error('GeÃ§ersiz JSON formatÄ±.');
        }
        
        // Not verilerini yÃ¼kle
        if (jsonData.grades) {
            APP_STATE.gradesData = jsonData.grades;
        } else if (jsonData.ogrenciNotlari) {
            APP_STATE.gradesData = jsonData.ogrenciNotlari;
        } else if (jsonData.rawGrades) {
            APP_STATE.gradesData = jsonData.rawGrades;
        } else {
            // DoÄŸrudan not verisi olarak kabul et
            APP_STATE.gradesData = jsonData;
        }
        
        // JSON yÃ¼klendikten sonra alanlarÄ± uyumlu hale getir
        normalizeGradeFields();
        
        // DeÄŸerlendirme gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ gÃ¼ncelle
        updateAssessmentView();
        
        closeModal(importModal);
        showModernToast("Not verileri baÅŸarÄ±yla yÃ¼klendi.");
        
        // DeÄŸerlendirme sekmesine geÃ§
        switchTab('assessment');
        
    } catch (error) {
        console.error("Not JSON verisi uygulanÄ±rken hata oluÅŸtu:", error);
        showModernToast("Not verileri yÃ¼klenemedi: " + error.message, "error");
    }
}
/**
 * Not verilerini kaydetme
 */
function saveGrades() {
    try {
        // Not giriÅŸlerinin kontrolÃ¼
        if (!APP_STATE.assessmentTree.length || !APP_STATE.studentData.length) {
            showModernToast("DeÄŸerlendirme kriterleri ve Ã¶ÄŸrenci listesi yÃ¼klenmeden not kaydÄ± yapÄ±lamaz!", "warning");
            return;
        }
        
        // NotlarÄ± kaydet - dosya sisteminde kalÄ±cÄ± olarak saklanmasÄ±na gerek yok,
        // Ã§Ã¼nkÃ¼ zaten APP_STATE.gradesData iÃ§inde tutuluyorlar
        
        showModernToast("Notlar baÅŸarÄ±yla kaydedildi.");
        
        // Ä°steÄŸe baÄŸlÄ± olarak notlarÄ± JSON olarak dÄ±ÅŸa aktarma modalÄ±nÄ± gÃ¶ster
        showExportGradesModal('json');
    } catch (error) {
        console.error("Notlar kaydedilirken hata oluÅŸtu:", error);
        showModernToast("Notlar kaydedilemedi!", "error");
    }
}

/**
 * Not dÄ±ÅŸa aktarma modalÄ±nÄ± gÃ¶sterme
 * @param {string} type - DÄ±ÅŸa aktarma tipi (json/csv)
 */
function showExportGradesModal(type) {
    try {
        // Tip kontrolÃ¼
        if (type !== 'json' && type !== 'csv') {
            throw new Error('GeÃ§ersiz dÄ±ÅŸa aktarma tipi!');
        }
        
        // Ä°Ã§erik oluÅŸtur
        let content = '';
        
        if (type === 'json') {
            // JSON verisi oluÅŸtur
            const gradesData = createGradesExportData();
            content = JSON.stringify(gradesData, null, 2);
        } else {
            // CSV verisi oluÅŸtur
            content = createGradesCSV();
        }
        
        // Modal iÃ§eriÄŸini ayarla
        exportGradesContent.value = content;
        
        // ModalÄ± gÃ¶ster
        openModal(exportGradesModal);
        
        showModernToast(`Notlar ${type.toUpperCase()} formatÄ±nda hazÄ±rlandÄ±.`);
    } catch (error) {
        console.error("Not dÄ±ÅŸa aktarma modalÄ± gÃ¶sterilirken hata oluÅŸtu:", error);
        showModernToast("Not verileri dÄ±ÅŸa aktarÄ±lamadÄ±!", "error");
    }
}

// Ä°lk applyJsonData fonksiyonu silindi - ikinci fonksiyon daha kapsamlÄ±

/**
 * Ã–ÄŸrenci JSON verilerini uygulama
 */
function applyStudentJsonData() {
    try {
        const jsonData = JSON.parse(studentJsonContent.value);
        
        // Ã–ÄŸrenci verilerini iÃ§e aktar
        importStudentData(jsonData);
        
        closeModal(importStudentsModal);
        showModernToast("Ã–ÄŸrenci listesi baÅŸarÄ±yla yÃ¼klendi.");
    } catch (error) {
        console.error("Ã–ÄŸrenci JSON verisi uygulanÄ±rken hata oluÅŸtu:", error);
        showModernToast("Ã–ÄŸrenci listesi yÃ¼klenemedi! LÃ¼tfen dosya formatÄ±nÄ± kontrol edin.", "error");
    }
}

/**
 * Ders verilerinden deÄŸerlendirme aÄŸacÄ± oluÅŸturma
 */
function createAssessmentTreeFromCourseData() {
    try {
        // Temiz bir aÄŸaÃ§ yapÄ±sÄ± oluÅŸtur
        APP_STATE.assessmentTree = [];
        
        if (!APP_STATE.courseData) return;
        
        // Derste tanÄ±mlÄ± deÄŸerlendirme etkinliklerini kontrol et
        const assessmentActivities = APP_STATE.courseData.dersDegerlendirme?.yariyilIciEtkinlikleri || [];
        const finalActivities = APP_STATE.courseData.dersDegerlendirme?.yariyilSonuEtkinlikleri || [];
        
        // YarÄ±yÄ±l iÃ§i etkinlikler
        if (assessmentActivities.length > 0) {
            assessmentActivities.forEach((activity, index) => {
                // v5 formatÄ±nda ID zaten var, yoksa oluÅŸtur
                const activityId = activity.id || `A${index + 1}`;
                
                // Ã–Ã‡'leri kullan - eÄŸer JSON'da Ã–Ã‡ varsa onlarÄ± akÄ±llÄ±ca daÄŸÄ±t
                const randomOutcomes = getSmartOutcomes(2);
                
                const node = {
                    id: activityId,
                    name: activity.etkinlik,
                    type: activity.etkinlik,
                    weight: activity.katkiYuzdesi,
                    points: 100,
                    outcomes: randomOutcomes,
                    description: 'YarÄ±yÄ±l iÃ§i deÄŸerlendirme',
                    expanded: true,
                    children: []
                };
                
                // v5 formatÄ±nda detaylar varsa onlarÄ± kullan
                if (activity.detaylar && Array.isArray(activity.detaylar)) {
                    node.children = activity.detaylar.map(detail => ({
                        id: detail.id,
                        name: detail.isim,
                        type: detail.tip,
                        weight: detail.agirlik,
                        points: detail.puan,
                        outcomes: detail.ogrenmeÃ‡iktilari || [],
                        description: detail.aciklama || 'DeÄŸerlendirme bileÅŸeni',
                        expanded: false,
                        children: []
                    }));
                }
                // Eski format veya assessment details varsa
                else if (APP_STATE.courseData.assessmentDetails && APP_STATE.courseData.assessmentDetails[activityId]) {
                    const details = APP_STATE.courseData.assessmentDetails[activityId];
                    if (details.children && Array.isArray(details.children)) {
                        node.children = details.children;
                    }
                } else {
                    // VarsayÄ±lan olarak bazÄ± soru ve rubrikler ekle
                    if (activity.etkinlik === 'Ara SÄ±nav' || activity.etkinlik === 'Quiz') {
                        // Ã–rnek sorular ekle
                        for (let i = 1; i <= 5; i++) {
                            const questionOutcome = getSmartOutcomes(1);
                            
                            node.children.push({
                                id: `${activityId}.${i}`,
                                name: `Soru ${i}`,
                                type: 'Soru',
                                weight: 20,
                                points: 20,
                                outcomes: questionOutcome,
                                description: 'DeÄŸerlendirme sorusu',
                                expanded: false,
                                children: []
                            });
                        }
                    } else if (activity.etkinlik === 'Proje HazÄ±rlama' || activity.etkinlik === 'Rapor' || activity.etkinlik === 'Ev Ã–devi') {
                        // Ã–rnek rubrikler ekle
                        const rubricTypes = [
                            { name: 'Ä°Ã§erik', desc: 'Ä°Ã§erik kalitesi ve kapsamÄ±' },
                            { name: 'Organizasyon', desc: 'Ã‡alÄ±ÅŸmanÄ±n dÃ¼zeni ve yapÄ±sÄ±' },
                            { name: 'Sunum', desc: 'Sunum kalitesi ve profesyonellik' },
                            { name: 'Kaynaklar', desc: 'KaynaklarÄ±n kullanÄ±mÄ± ve atÄ±f yapÄ±lmasÄ±' },
                            { name: 'Ã–zgÃ¼nlÃ¼k', desc: 'Ã‡alÄ±ÅŸmanÄ±n Ã¶zgÃ¼nlÃ¼k dÃ¼zeyi' }
                        ];
                        
                        rubricTypes.forEach((rubric, idx) => {
                            const rubricOutcome = getSmartOutcomes(1);
                            
                            node.children.push({
                                id: `${activityId}.${idx + 1}`,
                                name: rubric.name,
                                type: 'Rubrik',
                                weight: 20,
                                points: 20,
                                outcomes: rubricOutcome,
                                description: rubric.desc,
                                expanded: false,
                                children: []
                            });
                        });
                    }
                }
                
                APP_STATE.assessmentTree.push(node);
            });
        } else {
            // VarsayÄ±lan bir yarÄ±yÄ±l iÃ§i etkinlik ekle
            APP_STATE.assessmentTree.push({
                id: 'A1',
                name: 'Ara SÄ±nav',
                type: 'Ara SÄ±nav',
                weight: 40,
                points: 100,
                outcomes: getSmartOutcomes(3),
                description: 'YarÄ±yÄ±l iÃ§i deÄŸerlendirme',
                expanded: true,
                children: []
            });
        }
        
        // YarÄ±yÄ±l sonu etkinlikler
        if (finalActivities.length > 0) {
            finalActivities.forEach((activity, index) => {
                // v5 formatÄ±nda ID zaten var, yoksa oluÅŸtur
                const activityId = activity.id || `F${index + 1}`;
                
                // Ã–Ã‡'leri akÄ±llÄ±ca daÄŸÄ±t
                const randomOutcomes = getSmartOutcomes(3);
                
                const node = {
                    id: activityId,
                    name: activity.etkinlik,
                    type: activity.etkinlik,
                    weight: activity.katkiYuzdesi,
                    points: 100,
                    outcomes: randomOutcomes,
                    description: 'YarÄ±yÄ±l sonu deÄŸerlendirme',
                    expanded: true,
                    children: []
                };
                
                // v5 formatÄ±nda detaylar varsa onlarÄ± kullan
                if (activity.detaylar && Array.isArray(activity.detaylar)) {
                    node.children = activity.detaylar.map(detail => ({
                        id: detail.id,
                        name: detail.isim,
                        type: detail.tip,
                        weight: detail.agirlik,
                        points: detail.puan,
                        outcomes: detail.ogrenmeÃ‡iktilari || [],
                        description: detail.aciklama || 'DeÄŸerlendirme bileÅŸeni',
                        expanded: false,
                        children: []
                    }));
                }
                // Eski format veya assessment details varsa
                else if (APP_STATE.courseData.assessmentDetails && APP_STATE.courseData.assessmentDetails[activityId]) {
                    const details = APP_STATE.courseData.assessmentDetails[activityId];
                    if (details.children && Array.isArray(details.children)) {
                        node.children = details.children;
                    }
                } else {
                    // Final sÄ±navÄ± iÃ§in Ã¶rnek sorular ekle
                    if (activity.etkinlik === 'Final SÄ±navÄ±') {
                        for (let i = 1; i <= 5; i++) {
                            const questionOutcome = getSmartOutcomes(1);
                            
                            node.children.push({
                                id: `${activityId}.${i}`,
                                name: `Soru ${i}`,
                                type: 'Soru',
                                weight: 20,
                                points: 20,
                                outcomes: questionOutcome,
                                description: 'DeÄŸerlendirme sorusu',
                                expanded: false,
                                children: []
                            });
                        }
                    }
                }
                
                APP_STATE.assessmentTree.push(node);
            });
        } else {
            // VarsayÄ±lan bir yarÄ±yÄ±l sonu etkinlik ekle
            APP_STATE.assessmentTree.push({
                id: 'F1',
                name: 'Final SÄ±navÄ±',
                type: 'Final SÄ±navÄ±',
                weight: 60,
                points: 100,
                outcomes: getSmartOutcomes(4),
                description: 'YarÄ±yÄ±l sonu deÄŸerlendirme',
                expanded: true,
                children: []
            });
        }
        
        // Ana bileÅŸenler oluÅŸturuldu
        console.log('ğŸ¯ Ana deÄŸerlendirme bileÅŸenleri oluÅŸturuldu');
        // Bu noktada sadece aÄŸaÃ§ yapÄ±sÄ± hazÄ±r, DOM henÃ¼z render edilmemiÅŸ
        
    } catch (error) {
        console.error("DeÄŸerlendirme aÄŸacÄ± oluÅŸturulurken hata oluÅŸtu:", error);
        showModernToast("DeÄŸerlendirme aÄŸacÄ± oluÅŸturulamadÄ±!", "error");
    }
}

/**
 * DÄ±ÅŸa aktarÄ±lacak JSON verisi oluÅŸtur
 * @returns {Object} - DÄ±ÅŸa aktarÄ±lacak veri
 */
function createExportData() {
    try {
        // Grup haritalamalarÄ±nÄ± temizleme - sadece pozisyon->soru mapping'lerini koru
        function cleanGroupMappings(haritalar) {
            const result = {};
            const sortedGroups = Object.keys(haritalar).sort();
            
            sortedGroups.forEach(group => {
                result[group] = {};
                // Sadece sayÄ±sal anahtar (pozisyon) olan mapping'leri koru - ters mapping'leri filtrele
                Object.keys(haritalar[group]).forEach(key => {
                    if (/^\d+$/.test(key)) { // Sadece sayÄ±sal anahtarlar (1,2,3,4,5...)
                        result[group][key] = haritalar[group][key];
                    }
                });
            });
            return result;
        }
        
        // Tarih ve zaman bilgisi
        const now = new Date();
        const formattedDateTime = now.toISOString().slice(0, 19).replace('T', ' ');
        
        // DÄ±ÅŸa aktarÄ±lacak veri yapÄ±sÄ± - tamamen TÃ¼rkÃ§e anahtar isimlerini kullanÄ±yor
        const exportData = {
            disaAktarmaTarihi: now.toISOString(),
            dersBilgisi: {
                dersKodu: APP_STATE.courseData?.dersGenel?.dersKodu || '',
                dersAdi: APP_STATE.courseData?.dersGenel?.dersAdi || '',
                akademikYil: APP_STATE.courseData?.dersGenel?.akademikYil || '',
                donem: APP_STATE.courseData?.dersGenel?.ogretimYiliDonemi || 'Bahar DÃ¶nemi',
                ogretimUyesi: APP_STATE.courseData?.dersIcerik?.dersiVerenOgretimUyesiOgretimGorevlisi || ''
            },
            ogrenciler: APP_STATE.studentData.map(student => ({
                ogrenciNo: student.studentId,
                ad: student.name,
                soyad: student.surname,
                durum: student.status || 'Aktif',
                email: student.email || '', // Email korunuyor
                tcKimlik: student.tcKimlik || '', // TC Kimlik korunuyor
                telefon: student.telefon || '' // Telefon korunuyor
            })),
            dersDegerlendirme: {
                yariyilIciEtkinlikleri: APP_STATE.assessmentTree.filter(node => node.id.startsWith('A')).map(node => {
                    // Grup haritalama bilgilerini al
                    const groupMapping = APP_STATE.courseData?.grupHaritalari?.[node.id];
                    
                    return {
                        id: node.id,
                    etkinlik: node.type,
                    sayi: 1,
                    katkiYuzdesi: node.weight,
                    detaylar: node.children && node.children.map(child => ({
                        id: child.id,
                        isim: child.name,
                        tip: child.type,
                        agirlik: child.weight,
                        puan: child.points,
                        ogrenmeÃ‡iktilari: child.outcomes || [],
                        aciklama: child.description || (child.type === 'Soru' ? 'DeÄŸerlendirme sorusu' : 'DeÄŸerlendirme bileÅŸeni')
                        })) || [],
                        grupBilgileri: {
                            gruplar: groupMapping?.gruplar || groupMapping?.groups || ["A"],
                            haritalar: groupMapping?.haritalar ? 
                                // Mevcut haritalar varsa, sadece pozisyon->soru mapping'lerini koru
                                cleanGroupMappings(groupMapping.haritalar) :
                                // Yoksa varsayÄ±lan oluÅŸtur (pozisyon: soruId formatÄ±nda)
                                {
                                    "A": node.children ? node.children.reduce((acc, child, index) => {
                                        acc[(index + 1).toString()] = child.id;
                                        return acc;
                                    }, {}) : {}
                                }
                        }
                    };
                }),
                yariyilSonuEtkinlikleri: APP_STATE.assessmentTree.filter(node => node.id.startsWith('F')).map(node => {
                    // Grup haritalama bilgilerini al
                    const groupMapping = APP_STATE.courseData?.grupHaritalari?.[node.id];
                    
                    return {
                        id: node.id,
                    etkinlik: node.type,
                    sayi: 1,
                    katkiYuzdesi: node.weight,
                    detaylar: node.children && node.children.map(child => ({
                        id: child.id,
                        isim: child.name,
                        tip: child.type,
                        agirlik: child.weight,
                        puan: child.points,
                        ogrenmeÃ‡iktilari: child.outcomes || [],
                        aciklama: child.description || (child.type === 'Soru' ? 'DeÄŸerlendirme sorusu' : 'DeÄŸerlendirme bileÅŸeni')
                        })) || [],
                        grupBilgileri: {
                            gruplar: groupMapping?.gruplar || ["A"],
                            haritalar: groupMapping?.haritalar ? 
                                // Mevcut haritalar varsa, sadece pozisyon->soru mapping'lerini koru
                                cleanGroupMappings(groupMapping.haritalar) :
                                // Yoksa varsayÄ±lan oluÅŸtur (pozisyon: soruId formatÄ±nda)
                                {
                                    "A": node.children ? node.children.reduce((acc, child, index) => {
                                        acc[(index + 1).toString()] = child.id;
                                        return acc;
                                    }, {}) : {}
                                }
                        }
                    };
                })
            },
            // Ã–ÄŸrenci notlarÄ±nÄ± kaÄŸÄ±t sÄ±rasÄ±na gÃ¶re dÃ¼zenle
            ogrenciNotlari: (() => {
                const notlari = {};
                
                APP_STATE.studentData.forEach(student => {
                    const studentId = student.studentId;
                    const studentGrades = {};
                    
                    // Her etkinlik iÃ§in notlarÄ± dÃ¼zenle
                    APP_STATE.assessmentTree.forEach(activity => {
                        if (activity.children && activity.children.length > 0) {
                            const activityGrades = {};
                            
                                        // KaÄŸÄ±t sÄ±rasÄ±na gÃ¶re puanlarÄ± al
            activity.children.forEach((child, index) => {
                const questionOrder = (index + 1).toString();
                
                // Ã–ÄŸrencinin grup bilgisine gÃ¶re hangi soru ID'sine denk geldiÄŸini bul
                const studentGroup = getStudentGroupForComponent(studentId, activity.id) || 'A';
                const groupMapping = APP_STATE.courseData?.grupHaritalari?.[activity.id]?.haritalar?.[studentGroup];
                let questionId = child.id;
                
                if (groupMapping && groupMapping[questionOrder]) {
                    questionId = groupMapping[questionOrder];
                }
                
                // âœ… FIX: DoÄŸru soru ID'sinden puanÄ± al - grup haritalama sonrasÄ±
                const grade = getStudentGrade(studentId, questionId) || 0;
                
                activityGrades[questionOrder] = {
                    puan: parseFloat(grade.toFixed(2)),
                    soruId: questionId
                };
            });
                            
                            studentGrades[activity.id] = activityGrades;
                        }
                    });
                    
                    // Her Ã¶ÄŸrenci iÃ§in grup bilgilerini ekle (v5 format uyumlu)
                    studentGrades.grupBilgileri = {};
                    APP_STATE.assessmentTree.forEach(activity => {
                        studentGrades.grupBilgileri[activity.id] = getStudentGroupForComponent(studentId, activity.id) || 'A';
                    });
                    
                    notlari[studentId] = studentGrades;
                });
                
                return notlari;
            })(),
            
            // Genel ders bilgileri
            dersGenel: APP_STATE.courseData?.dersGenel || {},
            dersIcerik: APP_STATE.courseData?.dersIcerik || {},
            
            // Ã–ÄŸrenme Ã§Ä±ktÄ±larÄ± varsa ekle
            dersOgrenmeÃ‡iktilari: APP_STATE.learningOutcomes.map(outcome => ({
                id: outcome.id,
                aciklama: outcome.aciklama
            })),
            
            // Etkinlik tÃ¼rleri listesi (import'tan koru)
            etkinlikTurleri: APP_STATE.courseData?.etkinlikTurleri || [
                "Alan Ã‡alÄ±ÅŸmasÄ±", "Alan Gezisi", "Ara SÄ±nav", "Ara SÄ±nav Ä°Ã§in Bireysel Ã‡alÄ±ÅŸma",
                "Beyin FÄ±rtÄ±nasÄ±", "Bireysel Ã‡alÄ±ÅŸma", "BÃ¼tÃ¼nleme SÄ±navÄ±", "Deney",
                "Deney SonrasÄ± Quiz", "Derse KatÄ±lÄ±m", "Ev Ã–devi", "Final SÄ±navÄ±",
                "Final SÄ±navÄ± Ä°Ã§in Bireysel Ã‡alÄ±ÅŸma", "GÃ¶sterme", "GÃ¶zlem", "Laboratuvar",
                "Laboratuvar Ara SÄ±navÄ±", "Laboratuvar SÄ±navÄ±", "Makale Kritik Etme",
                "Makale Yazma", "Multirom CD Ã‡alÄ±ÅŸmasÄ±", "Ã–dev Problemleri Ä°Ã§in Ã‡alÄ±ÅŸma",
                "Okuma", "Ã–rnek Vaka Ä°ncelemesi", "Performans", "Problem Ã‡Ã¶zÃ¼mÃ¼",
                "Proje HazÄ±rlama", "Proje Sunma", "Proje TasarÄ±mÄ±/YÃ¶netimi", "Quiz",
                "Quiz Ä°Ã§in Bireysel Ã‡alÄ±ÅŸma", "Rapor", "Rapor HazÄ±rlama", "Rapor Sunma",
                "Rehberli Problem Ã‡Ã¶zÃ¼mÃ¼", "Rol Oynama / Dramatizasyon", "Seminer",
                "Soru-YanÄ±t", "SÃ¶zlÃ¼ SÄ±nav", "TakÄ±m/Grup Ã‡alÄ±ÅŸmasÄ±", "TartÄ±ÅŸma",
                "ToplantÄ± BaÅŸkanlÄ±ÄŸÄ± Yapma", "Uygulama/Pratik"
            ],
            
            // YarÄ±yÄ±l iÃ§i olasÄ± etkinlikler (import'tan koru)
            yariyilIciOlasiEtkinlikler: APP_STATE.courseData?.yariyilIciOlasiEtkinlikler || [
                "Ara SÄ±nav", "Laboratuvar SÄ±navÄ±", "Deney", "Deney SonrasÄ± Quiz",
                "Performans", "Quiz", "Rapor", "Rapor Sunma", "Makale Kritik Etme",
                "Makale Yazma", "Proje HazÄ±rlama", "Proje Sunma", "Rehberli Problem Ã‡Ã¶zÃ¼mÃ¼",
                "Seminer", "SÃ¶zlÃ¼ SÄ±nav", "Ã–dev Problemleri Ä°Ã§in Ã‡alÄ±ÅŸma", "Proje TasarÄ±mÄ±/YÃ¶netimi"
            ],
            
            // YarÄ±yÄ±l sonu olasÄ± etkinlikler (import'tan koru)
            yariyilSonuOlasiEtkinlikler: APP_STATE.courseData?.yariyilSonuOlasiEtkinlikler || [
                "Final SÄ±navÄ±", "Laboratuvar Ara SÄ±navÄ±", "Makale Yazma", "Proje HazÄ±rlama",
                "Proje Sunma", "Proje TasarÄ±mÄ±/YÃ¶netimi", "Quiz", "Rapor", "Rapor HazÄ±rlama",
                "Rapor Sunma", "Seminer", "SÃ¶zlÃ¼ SÄ±nav", "GÃ¶zlem"
            ],
            
            // Denetim bilgileri
            denetimBilgileri: {
                olusturmaTarihi: APP_STATE.courseData?.denetimBilgileri?.olusturmaTarihi || formattedDateTime,
                olusturan: APP_STATE.courseData?.denetimBilgileri?.olusturan || 'Ders DeÄŸerlendirme Sistemi',
                sonGuncellenmeTarihi: formattedDateTime,
                guncelleyen: 'Ders DeÄŸerlendirme Sistemi',
                durum: 'Taslak'
            }
        };
        
        // Ders Genel ve Ä°Ã§erik bilgilerini APP_STATE'den al
        if (APP_STATE.courseData) {
            if (APP_STATE.courseData.dersGenel) {
                exportData.dersGenel = JSON.parse(JSON.stringify(APP_STATE.courseData.dersGenel));
            }
            
            if (APP_STATE.courseData.dersIcerik) {
                exportData.dersIcerik = JSON.parse(JSON.stringify(APP_STATE.courseData.dersIcerik));
            }
            
            // DiÄŸer Ã¶nemli bilgileri koru
            if (APP_STATE.courseData.haftalikDersIcerikleri) {
                exportData.haftalikDersIcerikleri = JSON.parse(JSON.stringify(APP_STATE.courseData.haftalikDersIcerikleri));
            }
            
            if (APP_STATE.courseData.dersIsYuku) {
                exportData.dersIsYuku = JSON.parse(JSON.stringify(APP_STATE.courseData.dersIsYuku));
            }
            
            if (APP_STATE.courseData.programCiktilari) {
                exportData.programCiktilari = JSON.parse(JSON.stringify(APP_STATE.courseData.programCiktilari));
            }
            
            if (APP_STATE.courseData.programVeOgrenmeIliskisi) {
                exportData.programVeOgrenmeIliskisi = JSON.parse(JSON.stringify(APP_STATE.courseData.programVeOgrenmeIliskisi));
            }
            
            if (APP_STATE.courseData.toplumsalKatkiVeSurdurulebilirlik) {
                exportData.toplumsalKatkiVeSurdurulebilirlik = JSON.parse(JSON.stringify(APP_STATE.courseData.toplumsalKatkiVeSurdurulebilirlik));
            }
            
            if (APP_STATE.courseData.dersSekmeler) {
                exportData.dersSekmeler = JSON.parse(JSON.stringify(APP_STATE.courseData.dersSekmeler));
            }
            
            if (APP_STATE.courseData.numaralandirmaDegerleri) {
                exportData.numaralandirmaDegerleri = JSON.parse(JSON.stringify(APP_STATE.courseData.numaralandirmaDegerleri));
            }
        }
        
        return exportData;
    } catch (error) {
        console.error("DÄ±ÅŸa aktarÄ±lacak veri oluÅŸturulurken hata oluÅŸtu:", error);
        showModernToast("DÄ±ÅŸa aktarÄ±lacak veri oluÅŸturulamadÄ±!", "error");
        return {};
    }
}

/**
 * NotlarÄ± JSON olarak dÄ±ÅŸa aktarma - Yeni temiz yapÄ±
 * @returns {Object} - DÄ±ÅŸa aktarÄ±lacak not verisi
 */
function createGradesExportData() {
    try {
        // Sadece Ã¶ÄŸrenci notlarÄ± - temiz yapÄ±
        const exportData = {
            ogrenciNotlari: {}
        };
        
        // Her Ã¶ÄŸrenci iÃ§in notlarÄ± oluÅŸtur
        APP_STATE.studentData.forEach(student => {
            const studentId = student.studentId;
            const studentGrades = {};
            
            // Her etkinlik iÃ§in notlarÄ± al
            APP_STATE.assessmentTree.forEach(activity => {
                if (activity.children && activity.children.length > 0) {
                    const activityGrades = {};
                    
                    // Grup bilgisini al
                    const studentGroup = getStudentGroup(studentId, activity.id) || 'A';
                    const groupMapping = APP_STATE.courseData?.grupHaritalari?.[activity.id]?.haritalar?.[studentGroup];
                    
                    // Her soru iÃ§in puan ve soru ID'si
                    activity.children.forEach((child, index) => {
                        const questionOrder = (index + 1).toString();
                        
                        // Hangi soru ID'sine denk geldiÄŸini bul
                        let questionId = child.id;
                        if (groupMapping && groupMapping[questionOrder]) {
                            questionId = groupMapping[questionOrder];
                        }
                        
                        // âœ… FIX: DoÄŸru soru ID'sinden puanÄ± al - grup haritalama sonrasÄ±
                        const grade = getStudentGrade(studentId, questionId) || 0;
                        
                        activityGrades[questionOrder] = {
                                                            puan: parseFloat(grade.toFixed(2)),
                            soruId: questionId
                        };
                    });
                    
                    studentGrades[activity.id] = activityGrades;
                }
            });
            
            // Grup bilgilerini ekle
            studentGrades.grupBilgileri = {};
            APP_STATE.assessmentTree.forEach(activity => {
                studentGrades.grupBilgileri[activity.id] = getStudentGroup(studentId, activity.id) || 'A';
            });
            
            exportData.ogrenciNotlari[studentId] = studentGrades;
        });
        
        return exportData;
    } catch (error) {
        console.error("Not verileri dÄ±ÅŸa aktarÄ±lÄ±rken hata oluÅŸtu:", error);
        showModernToast("Not verileri dÄ±ÅŸa aktarÄ±lamadÄ±!", "error");
        return {};
    }
}

/**
 * NotlarÄ± CSV olarak dÄ±ÅŸa aktarma
 * @returns {string} - CSV formatÄ±ndaki not verisi
 */
function createGradesCSV() {
    try {
        // Final notlarÄ±nÄ± hesapla
        const finalGrades = {};
        
        APP_STATE.studentData.forEach(student => {
            const studentId = student.studentId;
            
            // YarÄ±yÄ±l iÃ§i etkinlikler
            const termActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('A'));
            let termGrade = 0;
            
            termActivities.forEach(activity => {
                const activityWeight = activity.weight / APP_STATE.termWeight; // Normalize
                let activityGrade = 0;
                
                if (activity.children && activity.children.length > 0) {
                    // Alt etkinlikler - grup haritalama dikkate alÄ±narak
                    const studentGroup = getStudentGroupForComponent(studentId, activity.id) || 'A';
                    const groupMapping = APP_STATE.courseData?.grupHaritalari?.[activity.id]?.haritalar?.[studentGroup];
                    
                    activity.children.forEach((subItem, index) => {
                        const subItemWeight = subItem.weight / 100; // subItem iÃ§inde normalize
                        
                        // Grup haritalama varsa doÄŸru soru ID'sini kullan
                        let questionId = subItem.id;
                        if (groupMapping) {
                            const questionOrder = (index + 1).toString();
                            if (groupMapping[questionOrder]) {
                                questionId = groupMapping[questionOrder];
                            }
                        }
                        
                        const grade = getStudentGrade(studentId, questionId) || 0;
                        const scaledGrade = (grade / subItem.points) * 100; // 100 Ã¼zerinden
                        activityGrade += scaledGrade * subItemWeight;
                    });
                } else {
                    // Basit etkinlik
                    const grade = getStudentGrade(studentId, activity.id) || 0;
                    activityGrade = (grade / activity.points) * 100; // 100 Ã¼zerinden
                }
                
                termGrade += activityGrade * activityWeight;
            });
            
            // YarÄ±yÄ±l sonu etkinlikler
            const finalActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('F'));
            let finalGrade = 0;
            
            finalActivities.forEach(activity => {
                const activityWeight = activity.weight / APP_STATE.finalWeight; // Normalize
                let activityGrade = 0;
                
                if (activity.children && activity.children.length > 0) {
                    // Alt etkinlikler - grup haritalama dikkate alÄ±narak
                    const studentGroup = getStudentGroupForComponent(studentId, activity.id) || 'A';
                    const groupMapping = APP_STATE.courseData?.grupHaritalari?.[activity.id]?.haritalar?.[studentGroup];
                    
                    activity.children.forEach((subItem, index) => {
                        const subItemWeight = subItem.weight / 100; // subItem iÃ§inde normalize
                        
                        // Grup haritalama varsa doÄŸru soru ID'sini kullan
                        let questionId = subItem.id;
                        if (groupMapping) {
                            const questionOrder = (index + 1).toString();
                            if (groupMapping[questionOrder]) {
                                questionId = groupMapping[questionOrder];
                            }
                        }
                        
                        const grade = getStudentGrade(studentId, questionId) || 0;
                        const scaledGrade = (grade / subItem.points) * 100; // 100 Ã¼zerinden
                        activityGrade += scaledGrade * subItemWeight;
                    });
                } else {
                    // Basit etkinlik
                    const grade = getStudentGrade(studentId, activity.id) || 0;
                    activityGrade = (grade / activity.points) * 100; // 100 Ã¼zerinden
                }
                
                finalGrade += activityGrade * activityWeight;
            });
            
            // Toplam ve harf notu
            const totalGrade = (termGrade * APP_STATE.termWeight / 100) + (finalGrade * APP_STATE.finalWeight / 100);
            const letterGrade = getLetterGrade(totalGrade);
            
            finalGrades[studentId] = {
                termGrade: termGrade.toFixed(2),
                finalGrade: finalGrade.toFixed(2),
                totalGrade: totalGrade.toFixed(2),
                letterGrade: letterGrade
            };
        });
        
        // CSV baÅŸlÄ±k satÄ±rÄ±
        let csv = "Ã–ÄŸrenci No,AdÄ±,SoyadÄ±,Durum,YarÄ±yÄ±l Ä°Ã§i,YarÄ±yÄ±l Sonu,Toplam,Harf Notu\n";
        
        // Her Ã¶ÄŸrenci iÃ§in satÄ±r ekle
        APP_STATE.studentData.forEach(student => {
            const studentGrade = finalGrades[student.studentId] || {
                termGrade: "0.00",
                finalGrade: "0.00",
                totalGrade: "0.00",
                letterGrade: "FF"
            };
            
            csv += `${student.studentId},${student.name},${student.surname},${student.status || 'Aktif'},${studentGrade.termGrade},${studentGrade.finalGrade},${studentGrade.totalGrade},${studentGrade.letterGrade}\n`;
        });
        
        return csv;
    } catch (error) {
        console.error("CSV oluÅŸturulurken hata oluÅŸtu:", error);
        showModernToast("CSV oluÅŸturulamadÄ±!", "error");
        return '';
    }
}

/**
 * JSON verisini panoya kopyala
 */
function copyJsonToClipboard() {
    try {
        exportJsonContent.select();
        document.execCommand('copy');
        showModernToast("JSON verisi panoya kopyalandÄ±.");
    } catch (error) {
        console.error("JSON verisi kopyalanÄ±rken hata oluÅŸtu:", error);
        showModernToast("JSON verisi kopyalanamadÄ±!", "error");
    }
}

/**
 * NotlarÄ± panoya kopyala
 */
function copyGradesToClipboard() {
    try {
        exportGradesContent.select();
        document.execCommand('copy');
        showModernToast("Not verileri panoya kopyalandÄ±.");
    } catch (error) {
        console.error("Not verileri kopyalanÄ±rken hata oluÅŸtu:", error);
        showModernToast("Not verileri kopyalanamadÄ±!", "error");
    }
}

/**
 * JSON verisini dosyaya kaydet
 */
function saveJsonToFile() {
    try {
        const jsonData = exportJsonContent.value;
        const blob = new Blob([jsonData], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        
        // EÄŸer orijinal dosya adÄ± varsa kullan, yoksa yeni bir ad oluÅŸtur
        if (APP_STATE.jsonFileName) {  // jsonFileName -> APP_STATE.jsonFileName
            a.download = APP_STATE.jsonFileName;
        } else {
            const dersKodu = APP_STATE.courseData?.dersGenel?.dersKodu || 'ders';
            a.download = `${dersKodu}_degerlendirme.json`;
        }
        
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showModernToast("JSON dosyasÄ± baÅŸarÄ±yla kaydedildi.");
    } catch (error) {
        console.error("JSON dosyasÄ± kaydedilirken hata oluÅŸtu:", error);
        showModernToast("JSON dosyasÄ± kaydedilemedi!", "error");
    }
}


/**
 * Dosya yÃ¼kleme iÅŸlemi
 * @param {Event} event - Dosya seÃ§me olayÄ±
 */
function loadJsonFromFile(event) {
    try {
        const file = event.target.files[0];
        if (!file) {
            showModernToast("Dosya seÃ§ilmedi.", "warning");
            return;
        }
        
        APP_STATE.jsonFileName = file.name;
        selectedFileName.textContent = file.name;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                jsonContent.value = e.target.result;
                showModernToast("Dosya baÅŸarÄ±yla yÃ¼klendi. Uygulamak iÃ§in 'Uygula' butonuna tÄ±klayÄ±n.");
            } catch (error) {
                console.error("Dosya okuma hatasÄ±:", error);
                showModernToast("Dosya okunamadÄ±: " + error.message, "error");
            }
        };
        
        reader.onerror = function() {
            showModernToast("Dosya okuma hatasÄ± oluÅŸtu.", "error");
        };
        
        reader.readAsText(file);
    } catch (error) {
        console.error("Dosya yÃ¼kleme hatasÄ±:", error);
        showModernToast("Dosya yÃ¼klenemedi: " + error.message, "error");
    }
}

/**
 * JSON verisini uygulama - TÃ¼m formatlarÄ± destekler
 */
function applyJsonData() {
    try {
        const jsonString = jsonContent.value.trim();
        
        if (!jsonString) {
            showModernToast("LÃ¼tfen geÃ§erli bir JSON iÃ§eriÄŸi girin.", "warning");
            return;
        }
        
        const jsonData = JSON.parse(jsonString);
        
        // Temel doÄŸrulama
        if (!jsonData || typeof jsonData !== 'object') {
            throw new Error('GeÃ§ersiz JSON formatÄ±.');
        }
        
        // Ders verilerini kaydet
        APP_STATE.courseData = jsonData;
        
        // Ã–ÄŸrenme Ã§Ä±ktÄ±larÄ±nÄ± ayarla
        if (jsonData.dersOgrenmeÃ‡iktilari && Array.isArray(jsonData.dersOgrenmeÃ‡iktilari)) {
            APP_STATE.learningOutcomes = jsonData.dersOgrenmeÃ‡iktilari;
            console.log('Ã–Ã‡ verileri yÃ¼klendi:', APP_STATE.learningOutcomes);
            renderOutcomes();
            showModernToast(`${APP_STATE.learningOutcomes.length} adet Ã¶ÄŸrenme Ã§Ä±ktÄ±sÄ± yÃ¼klendi.`, "success");
        } else {
            console.log('Ã–Ã‡ verileri bulunamadÄ±:', jsonData.dersOgrenmeÃ‡iktilari);
            showModernToast("JSON'da Ã¶ÄŸrenme Ã§Ä±ktÄ±sÄ± bulunamadÄ±!", "warning");
        }
        
        // Program Ã§Ä±ktÄ±larÄ±nÄ± ayarla
        if (jsonData.programCiktilari && Array.isArray(jsonData.programCiktilari)) {
            APP_STATE.programOutcomes = jsonData.programCiktilari;
            renderProgramOutcomes();
            showModernToast(`${APP_STATE.programOutcomes.length} adet program Ã§Ä±ktÄ±sÄ± yÃ¼klendi.`, "success");
        } else {
            showModernToast("JSON'da program Ã§Ä±ktÄ±sÄ± bulunamadÄ±!", "warning");
        }
        
        // Ã–Ã‡-PÃ‡ Ä°liÅŸki Matrisini ayarla
        if (jsonData.programVeOgrenmeIliskisi && jsonData.programVeOgrenmeIliskisi.iliskiTablosu) {
            APP_STATE.outcomeMatrix = jsonData.programVeOgrenmeIliskisi;
            renderOutcomeMatrix();
        }
        
        // Ders bilgilerini gÃ¼ncelle
        updateCourseInfo();
        
        // Ders detaylarÄ±nÄ± render et
        renderCourseDetails();
        
        // DeÄŸerlendirme aÄŸacÄ± iÃ§in veri yapÄ±sÄ± oluÅŸtur
        if (jsonData.degerlendirmeAgaci) {
            // DoÄŸrudan aÄŸacÄ± al (eÄŸer daha Ã¶nce kaydedilmiÅŸse)
            APP_STATE.assessmentTree = jsonData.degerlendirmeAgaci;
            showModernToast("DeÄŸerlendirme aÄŸacÄ± JSON'dan yÃ¼klendi.", "success");
        } else if (jsonData.assessmentTree) {
            APP_STATE.assessmentTree = jsonData.assessmentTree;
            showModernToast("DeÄŸerlendirme aÄŸacÄ± JSON'dan yÃ¼klendi.", "success");
        } else {
            // Ders verilerinden aÄŸaÃ§ oluÅŸtur
            createAssessmentTreeFromCourseData();
            showModernToast("DeÄŸerlendirme aÄŸacÄ± ders verilerinden oluÅŸturuldu ve Ã–Ã‡'ler otomatik atandÄ±.", "info");
        }
        
        // EÄŸer deÄŸerlendirme aÄŸacÄ± hala boÅŸsa, default sorular ekle
        if (!APP_STATE.assessmentTree || APP_STATE.assessmentTree.length === 0) {
            createDefaultAssessmentTree();
            showModernToast("VarsayÄ±lan deÄŸerlendirme aÄŸacÄ± oluÅŸturuldu ve Ã–Ã‡'ler otomatik atandÄ±.", "info");
        }
        
        // Temel dosya format iÃ§in default grup sistemi ve soru atamasÄ±
        if (!isTamDosyaFormat(jsonData)) {
            console.log("ğŸ”§ Temel dosya format tespit edildi, default grup sistemi oluÅŸturuluyor...");
            createDefaultGroupSystemForTemelDosya();
            showModernToast("Temel dosya format iÃ§in A grubu ve soru atamalarÄ± oluÅŸturuldu!", "success");
        }

        
        // Grup haritalama bilgilerini Ã–NCE yÃ¼kle
        console.log("ğŸ”§ Grup haritalama bilgileri yÃ¼kleme Ã§aÄŸrÄ±sÄ± yapÄ±lÄ±yor...");
        console.log("ğŸ“„ JSON data kontrolÃ¼:", {
            hasJsonData: !!jsonData,
            hasDersDegerlendirme: !!jsonData.dersDegerlendirme,
            jsonKeys: Object.keys(jsonData)
        });
        
        // Fonksiyonun var olup olmadÄ±ÄŸÄ±nÄ± kontrol et
        if (typeof loadGroupMappingsFromAssessmentData === 'function') {
            console.log("âœ… loadGroupMappingsFromAssessmentData fonksiyonu bulundu, Ã§aÄŸrÄ±lÄ±yor...");
            try {
                loadGroupMappingsFromAssessmentData(jsonData);
                console.log("âœ… loadGroupMappingsFromAssessmentData Ã§aÄŸrÄ±sÄ± baÅŸarÄ±yla tamamlandÄ±");
            } catch (error) {
                console.error("âŒ loadGroupMappingsFromAssessmentData Ã§aÄŸrÄ±sÄ±nda hata:", error);
            }
        } else {
            console.error("âŒ loadGroupMappingsFromAssessmentData fonksiyonu bulunamadÄ±!");
            console.log("ğŸ” Mevcut fonksiyonlar:", Object.keys(window).filter(key => key.includes('loadGroup')));
        }
        
        console.log("ğŸ”§ Grup haritalama bilgileri yÃ¼kleme Ã§aÄŸrÄ±sÄ± tamamlandÄ±");
        
        // AÄŸacÄ± render et
        renderTree();
        
        // v5 format iÃ§in ek grup bilgisi gÃ¼ncelleme
        setTimeout(() => {
            console.log("ğŸ”„ JSON import sonrasÄ± grup UI zorlamalÄ± gÃ¼ncellemesi...");
            updateAllInlineGroupInputs();
            
            // BileÅŸen grup bilgilerini de gÃ¼ncelle
            document.querySelectorAll('.componentGroupInfo').forEach(input => {
                const componentId = input.dataset.componentId;
                if (componentId) {
                    updateComponentGroupInfo(componentId);
                }
            });
        }, 200);
        
        // Ã–ÄŸrencileri iÃ§e aktar
        let hasStudentData = false;
        
        // Format 1: ogrenciler dizisi
        if (jsonData.ogrenciler && Array.isArray(jsonData.ogrenciler)) {
            APP_STATE.studentData = jsonData.ogrenciler.map((student, index) => ({
                studentId: student.ogrenciNo,
                name: student.ad,
                surname: student.soyad,
                status: student.durum || 'Aktif',
                grup: student.grup || 'A', // Default grup atamasÄ±
                email: student.email || '', // Email bilgisini koru
                tcKimlik: student.tcKimlik || '', // TC Kimlik bilgisini koru
                telefon: student.telefon || '' // Telefon bilgisini koru
            }));
            hasStudentData = true;
            showModernToast(`${APP_STATE.studentData.length} Ã¶ÄŸrenci verisi yÃ¼klendi.`, "success");
        } 
        // Format 2: students dizisi
        else if (jsonData.students && Array.isArray(jsonData.students)) {
            APP_STATE.studentData = jsonData.students.map((student, index) => ({
                studentId: student.studentId || student.student_id || student.ogrenciNo,
                name: student.name || student.ad,
                surname: student.surname || student.soyad, 
                status: student.status || student.durum || 'Aktif',
                grup: student.grup || student.group || 'A', // Default grup atamasÄ±
                email: student.email || '', // Email bilgisini koru
                tcKimlik: student.tcKimlik || '', // TC Kimlik bilgisini koru
                telefon: student.telefon || '' // Telefon bilgisini koru
            }));
            hasStudentData = true;
            showModernToast(`${APP_STATE.studentData.length} Ã¶ÄŸrenci verisi yÃ¼klendi.`, "success");
        }
        // Format 3: courseData.ogrenciler
        else if (jsonData.courseData && jsonData.courseData.ogrenciler && Array.isArray(jsonData.courseData.ogrenciler)) {
            APP_STATE.studentData = jsonData.courseData.ogrenciler.map((student, index) => ({
                studentId: student.ogrenciNo,
                name: student.ad,
                surname: student.soyad,
                status: student.durum || 'Aktif',
                grup: student.grup || 'A', // Default grup atamasÄ±
                email: student.email || '', // Email bilgisini koru
                tcKimlik: student.tcKimlik || '', // TC Kimlik bilgisini koru
                telefon: student.telefon || '' // Telefon bilgisini koru
            }));
            hasStudentData = true;
            showModernToast(`${APP_STATE.studentData.length} Ã¶ÄŸrenci verisi yÃ¼klendi.`, "success");
        } else {
            showModernToast("JSON'da Ã¶ÄŸrenci verisi bulunamadÄ±!", "warning");
        }
        
        // Ã–ÄŸrenci notlarÄ± yÃ¼kleme
        if (hasStudentData) {
            // Ã–nce not verilerini sÄ±fÄ±rla
            APP_STATE.gradesData = {};
            
            // Format 1: ogrenciNotlari (en yaygÄ±n format) - v5 formatÄ±nÄ± destekle
            if (jsonData.ogrenciNotlari && typeof jsonData.ogrenciNotlari === 'object') {
                // v5 formatÄ±nÄ± tam olarak destekle
                loadStudentGradesNewFormat(jsonData);
                const gradeCount = Object.keys(APP_STATE.gradesData).length;
                showModernToast(`${gradeCount} Ã¶ÄŸrencinin not verisi yÃ¼klendi (Tam Dosya format).`, "success");
            }
            // Format 2: grades
            else if (jsonData.grades && typeof jsonData.grades === 'object') {
                // Tam olarak kopyala - derin kopya
                APP_STATE.gradesData = JSON.parse(JSON.stringify(jsonData.grades));
                const gradeCount = Object.keys(APP_STATE.gradesData).length;
                showModernToast(`${gradeCount} Ã¶ÄŸrencinin not verisi yÃ¼klendi.`, "success");
            }
            // Format 3: rawGrades
            else if (jsonData.rawGrades && typeof jsonData.rawGrades === 'object') {
                // Tam olarak kopyala - derin kopya
                APP_STATE.gradesData = JSON.parse(JSON.stringify(jsonData.rawGrades));
                const gradeCount = Object.keys(APP_STATE.gradesData).length;
                showModernToast(`${gradeCount} Ã¶ÄŸrencinin not verisi yÃ¼klendi.`, "success");
            } else {
                showModernToast("JSON'da not verisi bulunamadÄ±!", "warning");
            }
            
            // Grup sistem bilgilerini yÃ¼kle ve doÄŸrula
            if (jsonData.grupHaritalari && typeof jsonData.grupHaritalari === 'object') {
                // Grup haritalarÄ±nÄ± courseData'ya kaydet (derin kopya ile)
                if (!APP_STATE.courseData) {
                    APP_STATE.courseData = {};
                }
                APP_STATE.courseData.grupHaritalari = JSON.parse(JSON.stringify(jsonData.grupHaritalari));
                
                // Grup veri yapÄ±sÄ±nÄ± doÄŸrula ve eksik kÄ±sÄ±mlarÄ± tamamla
                validateAndCompleteGroupData();
                
                // Grup sistemini baÅŸlat
                initializeGroupSystem();
                
                console.log('Grup haritalarÄ± yÃ¼klendi ve doÄŸrulandÄ±:', APP_STATE.courseData.grupHaritalari);
                showModernToast("Grup haritalarÄ± yÃ¼klendi ve doÄŸrulandÄ±.", "success");
            } else {
                // VarsayÄ±lan grup sistemi baÅŸlat
                initializeGroupSystem();
                
                // EÄŸer Ã¶ÄŸrencilerde grup bilgisi eksikse, hepsini A grubuna ata ve sÄ±rala
                assignDefaultGroups();
                
                console.log('VarsayÄ±lan grup sistemi oluÅŸturuldu');
                showModernToast("VarsayÄ±lan grup sistemi oluÅŸturuldu.", "info");
            }
            
            // Ã–ÄŸrenci tablosunu gÃ¼ncelle
            updateStudentTable();
            
            // Grup seÃ§icilerini gÃ¼ncelle
            updateGroupSelectors();
            
            // Dual range slider uyarÄ±sÄ±nÄ± gÃ¼ncelle
            const minSlider = document.getElementById('groupMinSlider');
            const maxSlider = document.getElementById('groupMaxSlider');
            if (minSlider && maxSlider) {
                updateDualRangeWarning(parseInt(minSlider.value), parseInt(maxSlider.value));
            }
        }
        
        // DeÄŸerlendirme gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ gÃ¼ncelle
        updateAssessmentView();
        
        // Ã–ÄŸrenci sayÄ±larÄ±nÄ± gÃ¼ncelle (JSON yÃ¼klendikten sonra)
        if (hasStudentData) {
            const passRateSlider = document.getElementById('passRateSlider');
            if (passRateSlider) {
                const passRate = parseInt(passRateSlider.value);
                updateStudentCounts(passRate);
            }
            updatePassFailCounts();
        }
        
        closeModal(importModal);
        showModernToast("JSON verisi baÅŸarÄ±yla yÃ¼klendi.");
        
        // Ã–ÄŸrenci verileri yÃ¼klendiyse deÄŸerlendirme sekmesine geÃ§
        if (hasStudentData) {
            setTimeout(() => {
                switchTab('assessment');
            }, 500);
        }
        
    } catch (error) {
        console.error("JSON verisi uygulanÄ±rken hata oluÅŸtu:", error);
        showModernToast("JSON verisi uygulanamadÄ±: " + error.message, "error");
    }
}

/**
 * Ã–ÄŸrenci dosyasÄ±nÄ± yÃ¼kleme
 * @param {Event} event - Dosya seÃ§me olayÄ±
 */
function loadStudentJsonFromFile(event) {
    try {
        const file = event.target.files[0];
        if (!file) {
            showModernToast("Dosya seÃ§ilmedi.", "warning");
            return;
        }
        
        selectedStudentFileName.textContent = file.name;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                studentJsonContent.value = e.target.result;
                showModernToast("Ã–ÄŸrenci dosyasÄ± baÅŸarÄ±yla yÃ¼klendi. Uygulamak iÃ§in 'Uygula' butonuna tÄ±klayÄ±n.");
            } catch (error) {
                console.error("Dosya okuma hatasÄ±:", error);
                showModernToast("Dosya okunamadÄ±: " + error.message, "error");
            }
        };
        
        reader.onerror = function() {
            showModernToast("Dosya okuma hatasÄ± oluÅŸtu.", "error");
        };
        
        reader.readAsText(file);
    } catch (error) {
        console.error("Ã–ÄŸrenci dosyasÄ± yÃ¼kleme hatasÄ±:", error);
        showModernToast("Ã–ÄŸrenci dosyasÄ± yÃ¼klenemedi: " + error.message, "error");
    }
}

/**
 * Ã–ÄŸrenci dosyasÄ±nÄ± doÄŸrudan yÃ¼kleme
 * @param {Event} event - Dosya seÃ§me olayÄ±
 */
function loadStudentsFromFile(event) {
    try {
        const file = event.target.files[0];
        if (!file) {
            showModernToast("Dosya seÃ§ilmedi.", "warning");
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const jsonData = JSON.parse(e.target.result);
                importStudentData(jsonData);
                showModernToast("Ã–ÄŸrenci listesi baÅŸarÄ±yla yÃ¼klendi.");
            } catch (error) {
                console.error("Ã–ÄŸrenci verisi iÅŸleme hatasÄ±:", error);
                showModernToast("Ã–ÄŸrenci dosyasÄ± iÅŸlenemedi: " + error.message, "error");
            }
        };
        
        reader.onerror = function() {
            showModernToast("Dosya okuma hatasÄ± oluÅŸtu.", "error");
        };
        
        reader.readAsText(file);
    } catch (error) {
        console.error("Ã–ÄŸrenci dosyasÄ± yÃ¼kleme hatasÄ±:", error);
        showModernToast("Ã–ÄŸrenci dosyasÄ± yÃ¼klenemedi: " + error.message, "error");
    }
}

/**
 * Not verilerini dosyaya kaydet
 */
function saveGradesToFile() {
    try {
        const data = exportGradesContent.value;
        
        // Ä°Ã§erik kontrolÃ¼
        if (!data || data.trim() === '') {
            showModernToast("Kaydedilecek veri bulunamadÄ±!", "warning");
            return;
        }
        
        const isCSV = data.startsWith("Ã–ÄŸrenci No,AdÄ±");
        const mimeType = isCSV ? 'text/csv' : 'application/json';
        const extension = isCSV ? 'csv' : 'json';
        
        const blob = new Blob([data], { type: mimeType });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        
        const dersKodu = APP_STATE.courseData?.dersGenel?.dersKodu || 'ders';
        const dateStr = new Date().toISOString().slice(0, 10);
        a.download = `${dersKodu}_notlar_${dateStr}.${extension}`;
        
        document.body.appendChild(a);
        a.click();
        
        // Temizlemeyi geciktir - indirme iÅŸleminin baÅŸlamasÄ± iÃ§in zaman ver
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 200);
        
        showModernToast(`Not dosyasÄ± (.${extension}) baÅŸarÄ±yla kaydedildi.`);
    } catch (error) {
        console.error("Not dosyasÄ± kaydedilirken hata oluÅŸtu:", error);
        showModernToast("Not dosyasÄ± kaydedilemedi: " + error.message, "error");
    }
}

/**
 * Test detaylarÄ± modalÄ±nÄ± gÃ¶sterme
 */
function showTestDetailsModal() {
    if (!APP_STATE.testDetailsNode) return;
    
    const node = APP_STATE.testDetailsNode;
    
    totalQuestionsInput.value = node.testDetails?.totalQuestions || 20;
    correctWeightInput.value = node.testDetails?.correctWeight || 5;
    wrongPenaltyInput.value = node.testDetails?.wrongPenalty || 0;
    
    openModal(testDetailsModal);
}

/**
 * Test detaylarÄ±nÄ± kaydetme
 */
function saveTestDetails() {
    if (!APP_STATE.testDetailsNode) return;
    
    try {
        const totalQuestions = parseInt(totalQuestionsInput.value) || 20;
        const correctWeight = parseFloat(correctWeightInput.value) || 5;
        const wrongPenalty = parseFloat(wrongPenaltyInput.value) || 0;
        
        APP_STATE.testDetailsNode.testDetails = {
            totalQuestions,
            correctWeight,
            wrongPenalty
        };
        
        // Toplam puanÄ± hesapla
        APP_STATE.testDetailsNode.points = totalQuestions * correctWeight;
        
        // AÄŸacÄ± yeniden render et
        renderTree();
        
        // DeÄŸerlendirme sekmesini gÃ¼ncelle
        updateAssessmentView();
        
        // ModalÄ± kapat
        closeModal(testDetailsModal);
        
        showModernToast("Test detaylarÄ± kaydedildi.");
    } catch (error) {
        console.error("Test detaylarÄ± kaydedilirken hata oluÅŸtu:", error);
        showModernToast("Test detaylarÄ± kaydedilemedi!", "error");
    }
}

/**
 * Modali aÃ§ma fonksiyonu
 * @param {HTMLElement} modal - AÃ§Ä±lacak modal elementi
 */
function openModal(modal) {
    if (modal) {
        modal.style.display = 'flex';
    }
}

/**
 * Modali kapatma fonksiyonu
 * @param {HTMLElement} modal - KapatÄ±lacak modal elementi
 */
function closeModal(modal) {
    if (modal) {
        modal.style.display = 'none';
    }
}


/**
 * SeÃ§ili sekmeyi deÄŸiÅŸtirme
 * @param {string} tabId - Sekme ID'si
 */
function switchTab(tabId) {
    const tabs = document.querySelectorAll('.nav-tab');
    const contents = document.querySelectorAll('.nav-content');
    
    // Ã–nce tÃ¼m tablarÄ± pasif yap
    tabs.forEach(tab => tab.classList.remove('active'));
    contents.forEach(content => {
        content.classList.remove('active');
        content.style.display = 'none';
    });
    
    // SeÃ§ili tabÄ± aktif yap
    const selectedTab = document.querySelector(`.nav-tab[data-tab="${tabId}"]`);
    const selectedContent = document.getElementById(`${tabId}-content`);
    
    if (selectedTab && selectedContent) {
        selectedTab.classList.add('active');
        selectedContent.classList.add('active');
        selectedContent.style.display = 'block';
        APP_STATE.currentActiveTabId = tabId;
        
        // Ã–ÄŸrenci bazlÄ± not giriÅŸi sekmesi kaldÄ±rÄ±ldÄ±
    }
}
/**
 * Tarihi okunabilir formata Ã§evirme
 * @param {string} isoDate - ISO formatlÄ± tarih
 * @returns {string} - FormatlanmÄ±ÅŸ tarih
 */
function formatDate(isoDate) {
    if (!isoDate) return '';
    
    const date = new Date(isoDate);
    return date.toLocaleDateString('tr-TR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

/**
 * Dosya adÄ±ndan uzantÄ±yÄ± Ã§Ä±karma
 * @param {string} filename - Dosya adÄ±
 * @returns {string} - UzantÄ±sÄ±z dosya adÄ±
 */
function removeExtension(filename) {
    if (!filename) return '';
    return filename.replace(/\.[^/.]+$/, "");
}

// =====================================================
// EVENT LISTENERS VE GLOBAL FONKSÄ°YONLAR
// =====================================================

// Global scope'a fonksiyonlarÄ± ekle
window.updateStudentGrade = updateStudentGrade;
window.updateTestScore = updateTestScore;
window.updateStudentGradeFromStudentView = updateStudentGradeFromStudentView;
window.updateTestScoreFromStudentView = updateTestScoreFromStudentView;

// =====================================================
// OTOMATIK GÃœNCELLEME SÄ°STEMÄ°
// =====================================================

/**
 * DeÄŸerlendirme ile ilgili bileÅŸenleri gÃ¼nceller
 * updateAssessmentView iÃ§inden Ã§aÄŸrÄ±lÄ±r
 */
function updateAssessmentRelatedComponents() {
    try {
        console.log('ğŸ”„ DeÄŸerlendirme bileÅŸenleri gÃ¼ncelleniyor...');
        
        // GÃ¼ncelleme iÅŸlemlerini sÄ±rayla yap (grup seÃ§icileri hariÃ§ - HTML oluÅŸturma sÄ±rasÄ±nda yapÄ±lÄ±yor)
        const updateOperations = [
            // { name: 'Grup seÃ§icileri', func: () => updateGroupSelectors() }, // KaldÄ±rÄ±ldÄ±
            { name: 'Ã–Ã‡ gÃ¶rÃ¼nÃ¼mleri', func: () => updateOutcomesTextarea?.() },
            { name: 'Kategori aÄŸÄ±rlÄ±klarÄ±', func: () => updateCategoryWeights?.() },
            { name: 'Grup haritalama bilgileri', func: () => updateAllMappingDisplays?.() },
            { name: 'Maksimum puan bilgileri', func: () => addMaxPointsToInputs?.() },
            { name: 'Grup bilgileri', func: () => updateAllInlineGroupInputs?.() },
            { name: 'Ã–ÄŸrenci filtre seÃ§enekleri', func: () => updateAssessmentStudentFilterOptions?.() }
        ];
        
        let successCount = 0;
        let errorCount = 0;
        
        updateOperations.forEach(operation => {
            try {
                if (operation.func) {
                    operation.func();
                    successCount++;
                    console.log(`âœ… ${operation.name} gÃ¼ncellendi`);
                } else {
                    console.warn(`âš ï¸ ${operation.name} fonksiyonu bulunamadÄ±`);
                }
            } catch (error) {
                errorCount++;
                console.error(`âŒ ${operation.name} gÃ¼ncellenirken hata:`, error);
            }
        });
        
        console.log(`ğŸ”„ DeÄŸerlendirme bileÅŸenleri gÃ¼ncellendi: ${successCount} baÅŸarÄ±lÄ±, ${errorCount} hatalÄ±`);
        
    } catch (error) {
        console.error('âŒ updateAssessmentRelatedComponents genel hatasÄ±:', error);
    }
}

// =====================================================
// MEVCUT FONKSÄ°YONLARA OTOMATÄ°K GÃœNCELLEME EKLEMESÄ°
// =====================================================

// TÃ¼m olay dinleyicileri ayarla
// TÃ¼m olay dinleyicileri ayarla
document.addEventListener('DOMContentLoaded', function() {
    try {
        // Ã–ÄŸrenci bazlÄ± not giriÅŸi sekmesi kaldÄ±rÄ±ldÄ± - butonlar temizlendi
        
        // Not iÅŸlemleri butonlarÄ±
        if (btnImportGrades) btnImportGrades.addEventListener('click', importGrades);
        if (btnSaveGrades) {
            btnSaveGrades.addEventListener('click', saveGrades);
            btnSaveGrades.addEventListener('click', saveGradesToFile);
        }
        
        // JSON iÅŸlemleri butonlarÄ±
        if (btnImport) btnImport.addEventListener('click', () => openModal(importModal));
        if (closeImportModal) closeImportModal.addEventListener('click', () => closeModal(importModal));
        if (btnExport) {
            btnExport.addEventListener('click', () => {
                try {
                    // JSON verisi oluÅŸtur
                    const exportData = createExportData();
                    if (exportJsonContent) {
                        exportJsonContent.value = JSON.stringify(exportData, null, 2);
                    }
                    openModal(exportModal);
                } catch (error) {
                    console.error("JSON dÄ±ÅŸa aktarma hatasÄ±:", error);
                    showModernToast("JSON dÄ±ÅŸa aktarma iÅŸlemi baÅŸarÄ±sÄ±z oldu!", "error");
                }
            });
        }
        
        // Modal kapatma butonlarÄ±
        if (closeExportModal) closeExportModal.addEventListener('click', () => closeModal(exportModal));
        if (closeImportStudentsModal) closeImportStudentsModal.addEventListener('click', () => closeModal(importStudentsModal));
        if (closeExportGradesModal) closeExportGradesModal.addEventListener('click', () => closeModal(exportGradesModal));
        if (closeTestDetailsModal) closeTestDetailsModal.addEventListener('click', () => closeModal(testDetailsModal));
        if (closeMultipleItemsModal) closeMultipleItemsModal.addEventListener('click', () => closeModal(multipleItemsModal));
        
        // Dosya iÅŸlemleri butonlarÄ±
        if (btnSelectFile) btnSelectFile.addEventListener('click', () => fileInput && fileInput.click());
        if (btnApplyJson) btnApplyJson.addEventListener('click', applyJsonData);
        if (fileInput) fileInput.addEventListener('change', loadJsonFromFile);
        if (btnCopyJson) btnCopyJson.addEventListener('click', copyJsonToClipboard);
        if (btnSaveJson) btnSaveJson.addEventListener('click', saveJsonToFile);
        
        // Ã–ÄŸrenci iÅŸlemleri butonlarÄ±
        if (btnImportStudents) btnImportStudents.addEventListener('click', () => openModal(importStudentsModal));
        if (btnSelectStudentFile) btnSelectStudentFile.addEventListener('click', () => studentJsonInput && studentJsonInput.click());
        if (btnApplyStudentJson) btnApplyStudentJson.addEventListener('click', applyStudentJsonData);
        if (studentJsonInput) studentJsonInput.addEventListener('change', loadStudentJsonFromFile);
        if (studentFileInput) studentFileInput.addEventListener('change', loadStudentsFromFile);
        // btnClearStudents event listener'Ä± aÅŸaÄŸÄ±da test butonlarÄ± kÄ±smÄ±nda tanÄ±mlandÄ±
        
        // Ã–ÄŸrenci listesi sekmesindeki temizleme butonu (farklÄ± ID ve fonksiyon)
        const btnClearStudentList = document.getElementById('btnClearStudentList');
        if (btnClearStudentList) btnClearStudentList.addEventListener('click', clearStudents);
        
        // Not dÄ±ÅŸa aktarma butonlarÄ±
        if (btnExportGradesJSON) btnExportGradesJSON.addEventListener('click', () => showExportGradesModal('json'));
        if (btnExportGradesExcel) btnExportGradesExcel.addEventListener('click', () => showExportGradesModal('csv'));
        if (btnCopyGrades) btnCopyGrades.addEventListener('click', copyGradesToClipboard);
        if (btnSaveGradesToFile) btnSaveGradesToFile.addEventListener('click', saveGradesToFile);
        if (btnCalculateGrades) btnCalculateGrades.addEventListener('click', calculateGrades);
        if (btnExportFinalGrades) btnExportFinalGrades.addEventListener('click', () => showExportGradesModal('csv'));
        
        // Test detaylarÄ± butonlarÄ±
        if (btnSaveTestDetails) btnSaveTestDetails.addEventListener('click', saveTestDetails);
        
        // Ä°lk yÃ¼klemede status badge'leri gÃ¼ncelle
        updatePassFailCounts();
        
        // Sekme iÅŸlemleri iÃ§in event listeners
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                if (tabId) switchTab(tabId);
            });
        });
        
        // Daha detaylÄ± tab iÅŸlemleri
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                try {
                    // Aktif sekme sÄ±nÄ±fÄ±nÄ± kaldÄ±r
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    
                    // Aktif iÃ§erik sÄ±nÄ±fÄ±nÄ± kaldÄ±r
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // SeÃ§ilen sekmeyi aktif yap
                    tab.classList.add('active');
                    
                    // Ä°lgili iÃ§eriÄŸi gÃ¶ster
                    const tabId = tab.getAttribute('data-tab');
                    if (tabId) {
                        const contentElement = document.getElementById(`${tabId}Tab`);
                        if (contentElement) contentElement.classList.add('active');
                    }
                } catch (error) {
                    console.error("Tab iÅŸlemi hatasÄ±:", error);
                }
            });
        });
        
        // Etkinlik ekleme butonlarÄ±
        if (btnAddTerm) btnAddTerm.addEventListener('click', addTermActivity);
        if (btnAddFinal) btnAddFinal.addEventListener('click', addFinalActivity);
        
        // Soru ve Rubrik ekleme butonlarÄ± - seÃ§ili unsur olmasa da Ã§alÄ±ÅŸmalÄ±
        if (btnAddQuestion) btnAddQuestion.addEventListener('click', function() {
            // Ã‡oklu soru eklemek iÃ§in modal gÃ¶ster - seÃ§ili unsur kontrolÃ¼ modal iÃ§inde yapÄ±lacak
            showMultipleItemsModal('soru');
        });
        
        if (btnAddRubric) btnAddRubric.addEventListener('click', function() {
            // Ã‡oklu rubrik eklemek iÃ§in modal gÃ¶ster - seÃ§ili unsur kontrolÃ¼ modal iÃ§inde yapÄ±lacak
            showMultipleItemsModal('rubrik');
        });
        
        // DiÄŸer aÄŸaÃ§ iÅŸlem butonlarÄ±
        if (btnRemove) btnRemove.addEventListener('click', removeNode);
        if (btnExpandAll) btnExpandAll.addEventListener('click', expandAll);
        if (btnCollapseAll) btnCollapseAll.addEventListener('click', collapseAll);
        
        // Rubrik ve soru tÃ¼rleri iÃ§in click event
        document.querySelectorAll('.rubric-item').forEach(item => {
            item.addEventListener('click', function() {
                try {
                    if (!APP_STATE.selectedNode) {
                        showModernToast("LÃ¼tfen Ã¶nce bir etkinlik seÃ§in.", "warning");
                        return;
                    }
                    
                    // SeÃ§ili dÃ¼ÄŸÃ¼m kÃ¶k deÄŸilse alt dÃ¼ÄŸÃ¼m eklenmemeli
                    if (APP_STATE.selectedNode.id.includes('.')) {
                        showModernToast("Rubrikler sadece ana etkinliklere eklenebilir.", "warning");
                        return;
                    }
                    
                    const rubricType = this.getAttribute('data-type');
                    const description = this.getAttribute('data-description');
                    addRubricToNode(APP_STATE.selectedNode, rubricType, description);
                } catch (error) {
                    console.error("Rubrik ekleme hatasÄ±:", error);
                    showModernToast("Rubrik eklenirken bir hata oluÅŸtu!", "error");
                }
            });
        });
        
        document.querySelectorAll('.question-type-item').forEach(item => {
            item.addEventListener('click', function() {
                try {
                    if (!APP_STATE.selectedNode) {
                        showModernToast("LÃ¼tfen Ã¶nce bir etkinlik seÃ§in.", "warning");
                        return;
                    }
                    
                    // SeÃ§ili dÃ¼ÄŸÃ¼m kÃ¶k deÄŸilse alt dÃ¼ÄŸÃ¼m eklenmemeli
                    if (APP_STATE.selectedNode.id.includes('.')) {
                        showModernToast("Sorular sadece ana etkinliklere eklenebilir.", "warning");
                        return;
                    }
                    
                    const questionType = this.getAttribute('data-type');
                    
                    // Test tÃ¼rÃ¼ iÃ§in Ã¶zel iÅŸlem
                    if (questionType === 'Test') {
                        addTestToNode(APP_STATE.selectedNode);
                        return;
                    }
                    
                    const description = this.getAttribute('data-description');
                    addQuestionToNode(APP_STATE.selectedNode, questionType, description);
                } catch (error) {
                    console.error("Soru ekleme hatasÄ±:", error);
                    showModernToast("Soru eklenirken bir hata oluÅŸtu!", "error");
                }
            });
        });
        
        // Ã–ÄŸrenme Ã§Ä±ktÄ±larÄ± iÃ§in tÄ±klama iÅŸlemleri
        document.querySelectorAll('.outcome-item').forEach(item => {
            item.addEventListener('click', function() {
                try {
                    if (APP_STATE.selectedNode) {
                        const outcomeId = this.getAttribute('data-id');
                        if (!outcomeId) return;
                        
                        const outcomesInput = document.querySelector(`.tree-node[data-id="${APP_STATE.selectedNode.id}"] .nodeOutcomes`);
                        if (outcomesInput) {
                            const currentValue = outcomesInput.value.trim();
                            
                            // Alt dÃ¼ÄŸÃ¼m ise (soru veya rubrik), sadece bir Ã–Ã‡ atanabilsin
                            const isSubItem = APP_STATE.selectedNode.id.includes('.');
                            
                            if (isSubItem) {
                                outcomesInput.value = outcomeId;
                            } else {
                                // DeÄŸer boÅŸsa veya virgÃ¼lle bitiyorsa
                                if (!currentValue) {
                                    outcomesInput.value = outcomeId;
                                } else if (currentValue.endsWith(',')) {
                                    outcomesInput.value = currentValue + ' ' + outcomeId;
                                } else {
                                    outcomesInput.value = currentValue + ', ' + outcomeId;
                                }
                            }
                            
                            // DeÄŸeri deÄŸiÅŸmiÅŸ gibi tetikle
                            outcomesInput.dispatchEvent(new Event('change'));
                            
                            showModernToast(`"${outcomeId}" Ã¶ÄŸrenme Ã§Ä±ktÄ±sÄ± eklendi.`);
                        }
                    } else {
                        showModernToast("LÃ¼tfen Ã¶nce bir etkinlik seÃ§in.", "warning");
                    }
                } catch (error) {
                    console.error("Ã–ÄŸrenme Ã§Ä±ktÄ±sÄ± ekleme hatasÄ±:", error);
                    showModernToast("Ã–ÄŸrenme Ã§Ä±ktÄ±sÄ± eklenirken bir hata oluÅŸtu!", "error");
                }
            });
        });
        
        // TÃ¼m close-modal sÄ±nÄ±fÄ±na sahip butonlara tÄ±klama olayÄ± ekle
        document.querySelectorAll('.close-modal').forEach(button => {
            button.addEventListener('click', function() {
                try {
                    // En yakÄ±n modal elementini bul
                    const modal = this.closest('.modal');
                    if (modal) {
                        closeModal(modal);
                    }
                } catch (error) {
                    console.error("Modal kapatma hatasÄ±:", error);
                }
            });
        });
        
        // Ä°tem tipi deÄŸiÅŸikliÄŸini dinle (Ã§oklu Ã¶ÄŸe ekleme modalÄ±nda)
        if (itemType) {
            itemType.addEventListener('change', function() {
                try {
                    const type = this.value;
                    if (questionTypeContainer && rubricTypeContainer) {
                        if (type === 'soru') {
                            questionTypeContainer.style.display = 'block';
                            rubricTypeContainer.style.display = 'none';
                        } else {
                            questionTypeContainer.style.display = 'none';
                            rubricTypeContainer.style.display = 'block';
                        }
                    }
                } catch (error) {
                    console.error("Tip deÄŸiÅŸikliÄŸi hatasÄ±:", error);
                }
            });
        }
        
        // Ã‡oklu Ã¶ÄŸe ekleme butonunu dinle
        if (btnAddMultipleItems) {
            btnAddMultipleItems.addEventListener('click', addMultipleItems);
        }
        
        // Ä°lk aÃ§Ä±lÄ±ÅŸta aktif sekmeyi ayarla
        switchTab(APP_STATE.currentActiveTabId || 'definition');

		// Puan daÄŸÄ±tma butonu
		const btnDistributePoints = document.getElementById('btnDistributePoints');
		if (btnDistributePoints) {
			btnDistributePoints.addEventListener('click', function() {
				if (!APP_STATE.selectedNode) {
					showModernToast("LÃ¼tfen Ã¶nce bir etkinlik seÃ§in.", "warning");
					return;
				}
				
				// EÄŸer alt dÃ¼ÄŸÃ¼m seÃ§iliyse Ã¼st dÃ¼ÄŸÃ¼mÃ¼ bul
				let parentNode = APP_STATE.selectedNode;
				if (parentNode.id.includes('.')) {
					const parentId = parentNode.id.substring(0, parentNode.id.lastIndexOf('.'));
					parentNode = findNodeById(parentId);
				}
				
				// PuanlarÄ± daÄŸÄ±t
				if (parentNode && parentNode.children && parentNode.children.length > 0) {
					// Alt Ã¶ÄŸelerin toplam aÄŸÄ±rlÄ±ÄŸÄ±nÄ± hesapla
					const totalWeight = parentNode.children.reduce((sum, child) => sum + (parseInt(child.weight) || 0), 0);
					
					// DaÄŸÄ±tÄ±m modalÄ±nÄ± gÃ¶ster
					showDistributePointsModal(parentNode, totalWeight);
				} else {
					showModernToast("SeÃ§ilen etkinliÄŸin alt Ã¶ÄŸeleri bulunmuyor.", "warning");
				}
			});
		}
		
		
		// Test daÄŸÄ±lÄ±m butonu
		const btnDistributeTestScores = document.getElementById('btnDistributeTestScores');
		if (btnDistributeTestScores) {
			btnDistributeTestScores.addEventListener('click', function() {
				if (!APP_STATE.testDetailsNode) {
					showModernToast("Test detaylarÄ± bulunamadÄ±.", "error");
					return;
				}
				
				// Test detaylarÄ±nÄ± al
				const testId = APP_STATE.testDetailsNode.id;
				const totalQuestions = parseInt(totalQuestionsInput.value) || 20;
				
				// Ã–ÄŸrenci verileri var mÄ± kontrol et
				if (!APP_STATE.studentData || APP_STATE.studentData.length === 0) {
					showModernToast("Ã–ÄŸrenci verisi bulunamadÄ±.", "warning");
					return;
				}
				
				// Ä°ÅŸlemi onaylamak iÃ§in modern onay modalÄ± gÃ¶ster
				showDeleteConfirmModal(
					// Onay verildiÄŸinde Ã§alÄ±ÅŸacak fonksiyon
					function() {
						// Her Ã¶ÄŸrenci iÃ§in rastgele doÄŸru/yanlÄ±ÅŸ sayÄ±sÄ± belirle ve daÄŸÄ±lÄ±m yap
						APP_STATE.studentData.forEach(student => {
							const studentId = student.studentId;
							
							// Rastgele doÄŸru sayÄ±sÄ± Ã¼ret
							const correct = Math.floor(Math.random() * (totalQuestions + 1));
							
							// Rastgele yanlÄ±ÅŸ sayÄ±sÄ± Ã¼ret (toplam soruyu geÃ§meyecek ÅŸekilde)
							const maxWrong = totalQuestions - correct;
							const wrong = Math.floor(Math.random() * (maxWrong + 1));
							
							// Not verilerini kaydeden yardÄ±mcÄ± fonksiyon kullan
							// (saveTestDistribution fonksiyonunu kullan, modal gÃ¶stermeyen)
							saveTestDistribution(studentId, testId, correct, wrong);
						});
						
						// DeÄŸerlendirme gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ gÃ¼ncelle
						updateAssessmentView();
						
						showModernToast("TÃ¼m Ã¶ÄŸrenciler iÃ§in rastgele test puanlarÄ± oluÅŸturuldu ve daÄŸÄ±tÄ±ldÄ±.", "success");
					},
					// Onay mesajÄ±
					"TÃ¼m Ã¶ÄŸrenciler iÃ§in rastgele test puanlarÄ± oluÅŸturmak istediÄŸinizden emin misiniz?"
				);
			});
		}
				
        
        // VarsayÄ±lan grup atamasÄ± yap
        assignDefaultGroups();
        
        console.log("TÃ¼m olay dinleyicileri baÅŸarÄ±yla yÃ¼klendi.");
    } catch (error) {
        console.error("Olay dinleyicileri yÃ¼klenirken hata oluÅŸtu:", error);
        showModernToast("Uygulama baÅŸlatÄ±lÄ±rken bir hata oluÅŸtu. LÃ¼tfen sayfayÄ± yenileyin veya daha sonra tekrar deneyin.", "error", 8000);
    }
});

/**
 * Alan adlarÄ±nÄ± normalleÅŸtirme (Ä°ngilizce/TÃ¼rkÃ§e uyumu)
 */
function normalizeGradeFields() {
    try {
        if (!APP_STATE.gradesData) return;
        
        // TÃ¼m Ã¶ÄŸrenciler iÃ§in
        Object.keys(APP_STATE.gradesData).forEach(studentId => {
            const studentGrades = APP_STATE.gradesData[studentId];
            
            // HesaplanmÄ±ÅŸ notlar iÃ§in standart alanlarÄ± ekle/normalleÅŸtir
            if (studentGrades.yariyilIciNotu !== undefined || studentGrades.termGrade !== undefined) {
                const termGrade = studentGrades.yariyilIciNotu || studentGrades.termGrade || 0;
                studentGrades.yariyilIciNotu = parseFloat(termGrade);
                studentGrades.termGrade = parseFloat(termGrade);
            }
            
            if (studentGrades.yariyilSonuNotu !== undefined || studentGrades.finalGrade !== undefined) {
                const finalGrade = studentGrades.yariyilSonuNotu || studentGrades.finalGrade || 0;
                studentGrades.yariyilSonuNotu = parseFloat(finalGrade);
                studentGrades.finalGrade = parseFloat(finalGrade);
            }
            
            if (studentGrades.basariNotu !== undefined || studentGrades.totalGrade !== undefined) {
                const totalGrade = studentGrades.basariNotu || studentGrades.totalGrade || 0;
                studentGrades.basariNotu = parseFloat(totalGrade);
                studentGrades.totalGrade = parseFloat(totalGrade);
            }
            
            if (studentGrades.harfNotu !== undefined || studentGrades.letterGrade !== undefined) {
                const letterGrade = studentGrades.harfNotu || studentGrades.letterGrade || 'FF';
                studentGrades.harfNotu = letterGrade;
                studentGrades.letterGrade = letterGrade;
            }
            
            // TÃ¼m aktiviteler iÃ§in
            Object.keys(studentGrades).forEach(activityId => {
                const grade = studentGrades[activityId];
                
                // Nesne ise ve test skorlarÄ±nÄ± iÃ§eriyorsa
                if (typeof grade === 'object' && grade !== null) {
                    // Type/tip alanlarÄ±nÄ± kontrol et
                    if (grade.type === 'test' || grade.tip === 'test') {
                        // Her iki dilde de alanlarÄ± ayarla
                        grade.type = 'test';
                        grade.tip = 'test';
                        
                        // DoÄŸru sayÄ±sÄ± iÃ§in
                        if (grade.correct !== undefined || grade.dogru !== undefined) {
                            const correctValue = grade.correct !== undefined ? grade.correct : grade.dogru;
                            grade.correct = correctValue;
                            grade.dogru = correctValue;
                        }
                        
                        // YanlÄ±ÅŸ sayÄ±sÄ± iÃ§in
                        if (grade.wrong !== undefined || grade.yanlis !== undefined) {
                            const wrongValue = grade.wrong !== undefined ? grade.wrong : grade.yanlis;
                            grade.wrong = wrongValue;
                            grade.yanlis = wrongValue;
                        }
                    }
                    
                    // Alt nesneleri kontrol et (iÃ§ iÃ§e yapÄ± iÃ§in)
                    Object.keys(grade).forEach(subKey => {
                        const subGrade = grade[subKey];
                        if (typeof subGrade === 'object' && subGrade !== null) {
                            if (subGrade.type === 'test' || subGrade.tip === 'test') {
                                // Her iki dilde de alanlarÄ± ayarla
                                subGrade.type = 'test';
                                subGrade.tip = 'test';
                                
                                // DoÄŸru sayÄ±sÄ± iÃ§in
                                if (subGrade.correct !== undefined || subGrade.dogru !== undefined) {
                                    const correctValue = subGrade.correct !== undefined ? subGrade.correct : subGrade.dogru;
                                    subGrade.correct = correctValue;
                                    subGrade.dogru = correctValue;
                                }
                                
                                // YanlÄ±ÅŸ sayÄ±sÄ± iÃ§in
                                if (subGrade.wrong !== undefined || subGrade.yanlis !== undefined) {
                                    const wrongValue = subGrade.wrong !== undefined ? subGrade.wrong : subGrade.yanlis;
                                    subGrade.wrong = wrongValue;
                                    subGrade.yanlis = wrongValue;
                                }
                            }
                        }
                    });
                }
            });
        });
    } catch (error) {
        console.error("Not alanlarÄ± normalleÅŸtirilirken hata oluÅŸtu:", error);
    }
}

/**
 * HesaplanmÄ±ÅŸ notlarÄ± gÃ¼ncelleme
 */
function updateCalculatedGrades() {
    try {
        if (!APP_STATE.studentData || APP_STATE.studentData.length === 0) {
            return;
        }
        
        APP_STATE.studentData.forEach(student => {
            const studentId = student.studentId;
            
            // YarÄ±yÄ±l iÃ§i etkinlikler
            const termActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('A'));
            let termGrade = 0;
            
            // Ä°Ã§ aÄŸÄ±rlÄ±k toplamÄ±
            const termInternalTotal = termActivities.reduce((sum, node) => sum + parseFloat(node.weight || 0), 0);
            
            if (termInternalTotal > 0) {
                termActivities.forEach(activity => {
                    // Ä°Ã§ aÄŸÄ±rlÄ±k normalleÅŸtirmesi
                    const activityWeight = activity.weight / termInternalTotal; 
                    let activityGrade = 0;
                    
                    if (activity.children && activity.children.length > 0) {
                        // Alt etkinlikler
                        const childrenTotalWeight = activity.children.reduce((sum, child) => sum + parseFloat(child.weight || 0), 0);
                        
                        if (childrenTotalWeight > 0) {
                            activity.children.forEach(subItem => {
                                // Alt Ã¶ÄŸe aÄŸÄ±rlÄ±k normalleÅŸtirmesi
                                const subItemWeight = subItem.weight / childrenTotalWeight; 
                            const grade = getStudentGrade(studentId, subItem.id) || 0;
                                const scaledGrade = (grade / (subItem.points || 1)) * 100; // 100 Ã¼zerinden
                                activityGrade += scaledGrade * subItemWeight;
                            });
                        }
                    } else {
                        // Basit etkinlik
                        const grade = getStudentGrade(studentId, activity.id) || 0;
                        activityGrade = (grade / (activity.points || 1)) * 100; // 100 Ã¼zerinden
                    }
                    
                    termGrade += activityGrade * activityWeight;
                });
            }
            
            // YarÄ±yÄ±l sonu etkinlikler
            const finalActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('F'));
            let finalGrade = 0;
            
            // Ä°Ã§ aÄŸÄ±rlÄ±k toplamÄ±
            const finalInternalTotal = finalActivities.reduce((sum, node) => sum + parseFloat(node.weight || 0), 0);
            
            if (finalInternalTotal > 0) {
                finalActivities.forEach(activity => {
                    // Ä°Ã§ aÄŸÄ±rlÄ±k normalleÅŸtirmesi
                    const activityWeight = activity.weight / finalInternalTotal;
                    let activityGrade = 0;
                    
                    if (activity.children && activity.children.length > 0) {
                        // Alt etkinlikler
                        const childrenTotalWeight = activity.children.reduce((sum, child) => sum + parseFloat(child.weight || 0), 0);
                        
                        if (childrenTotalWeight > 0) {
                            activity.children.forEach(subItem => {
                                // Alt Ã¶ÄŸe aÄŸÄ±rlÄ±k normalleÅŸtirmesi
                                const subItemWeight = subItem.weight / childrenTotalWeight;
                            const grade = getStudentGrade(studentId, subItem.id) || 0;
                                const scaledGrade = (grade / (subItem.points || 1)) * 100; // 100 Ã¼zerinden
                                activityGrade += scaledGrade * subItemWeight;
                            });
                        }
                    } else {
                        // Basit etkinlik
                        const grade = getStudentGrade(studentId, activity.id) || 0;
                        activityGrade = (grade / (activity.points || 1)) * 100; // 100 Ã¼zerinden
                    }
                    
                    finalGrade += activityGrade * activityWeight;
                });
            }
            
            // Toplam ve harf notu
            const totalGrade = (termGrade * APP_STATE.termWeight / 100) + (finalGrade * APP_STATE.finalWeight / 100);
            const letterGrade = getLetterGrade(totalGrade);
            
            // Ã–ÄŸrenci notlarÄ± nesnesini oluÅŸtur
            if (!APP_STATE.gradesData[studentId]) {
                APP_STATE.gradesData[studentId] = {};
            }
            
            // YarÄ±yÄ±l iÃ§i, sonu ve toplam not bilgilerini ekle
            APP_STATE.gradesData[studentId].yariyilIciNotu = parseFloat(termGrade.toFixed(2));
            APP_STATE.gradesData[studentId].yariyilSonuNotu = parseFloat(finalGrade.toFixed(2));
            APP_STATE.gradesData[studentId].basariNotu = parseFloat(totalGrade.toFixed(2));
            APP_STATE.gradesData[studentId].harfNotu = letterGrade;
        });
    } catch (error) {
        console.error("Notlar hesaplanÄ±rken hata oluÅŸtu:", error);
    }
}

// Ã–ÄŸrenci bazlÄ± not giriÅŸi sekmesi kaldÄ±rÄ±ldÄ± - updateStudentSelector fonksiyonu temizlendi

// Ã–ÄŸrenci bazlÄ± not giriÅŸi sekmesi kaldÄ±rÄ±ldÄ± - showStudentGrades fonksiyonu temizlendi

/**
 * Ã–ÄŸrenci gÃ¶rÃ¼nÃ¼mÃ¼nde etkinlik bÃ¶lÃ¼mÃ¼ oluÅŸturma
 * @param {Object} student - Ã–ÄŸrenci
 * @param {Object} activity - Etkinlik
 * @returns {string} - HTML iÃ§eriÄŸi
 */
function createStudentActivitySection(student, activity) {
    try {
        let html = `
            <div class="student-activity" data-activity-id="${activity.id}">
                <h5>${activity.name} <span class="badge badge-primary">${activity.weight}%</span></h5>
        `;
        
        // Aktivitenin alt Ã¶ÄŸeleri var mÄ± kontrol et
        if (activity.children && activity.children.length > 0) {
            // Alt Ã¶ÄŸeler var, her biri iÃ§in giriÅŸ alanÄ± oluÅŸtur
            html += '<div class="student-subitems">';
            
            activity.children.forEach(subItem => {
                if (subItem.type === 'Test') {
                    html += createStudentTestInputSection(student, subItem);
                } else {
                    html += createStudentSubItemInputSection(student, subItem);
                }
            });
            
            html += '</div>';
        } else {
            // Alt Ã¶ÄŸe yoksa basit bir puan giriÅŸi gÃ¶ster
            const grade = getStudentGrade(student.studentId, activity.id) || '';
            
            html += `
                <div class="student-grade-input">
                    <label>Puan:</label>
                    <input type="number" min="0" max="${activity.points}" 
                        data-student-id="${student.studentId}" 
                        data-activity-id="${activity.id}" 
                        value="${grade}"
                        onchange="updateStudentGradeFromStudentView(this)">
                    <span>/ ${activity.points}</span>
                </div>
            `;
        }
        
        html += '</div>';
        return html;
    } catch (error) {
        console.error("Ã–ÄŸrenci etkinlik bÃ¶lÃ¼mÃ¼ oluÅŸturulurken hata oluÅŸtu:", error);
        return '<div class="error-message">Etkinlik bilgileri yÃ¼klenemedi.</div>';
    }
}

/**
 * Ã–ÄŸrenci gÃ¶rÃ¼nÃ¼mÃ¼nde alt Ã¶ÄŸe giriÅŸ bÃ¶lÃ¼mÃ¼ oluÅŸturma (Soru/Rubrik)
 * @param {Object} student - Ã–ÄŸrenci
 * @param {Object} subItem - Alt Ã¶ÄŸe
 * @returns {string} - HTML iÃ§eriÄŸi
 */
function createStudentSubItemInputSection(student, subItem) {
    try {
        // Ãœst bileÅŸen ID'sini bul
        const parentComponentId = getParentComponentId(subItem.id) || subItem.id;
        const component = APP_STATE.courseData?.grupHaritalari?.[parentComponentId];
        const useGroupSystem = component && component.gruplar && component.gruplar.length > 1;
        
        if (!useGroupSystem || !subItem.children || subItem.children.length === 0) {
            // Grup sistemi yok veya alt sorular yok - basit giriÅŸ
        const grade = getStudentGrade(student.studentId, subItem.id) || '';
        
        return `
            <div class="student-subitem" data-subitem-id="${subItem.id}">
                <div class="subitem-header">
                    <span>${subItem.name}</span>
                    <span class="badge badge-primary">${subItem.points} puan</span>
                    <span class="badge badge-success">${subItem.outcomes.join(', ')}</span>
                </div>
                <div class="student-grade-input">
                    <input type="number" min="0" max="${subItem.points}" 
                        data-student-id="${student.studentId}" 
                        data-activity-id="${subItem.id}" 
                        value="${grade}"
                        onchange="updateStudentGradeFromStudentView(this)">
                    <span>/ ${subItem.points}</span>
                </div>
            </div>
        `;
        }
        
        // Grup sistemi var ve alt sorular var - detaylÄ± tablo (Ã–ÄŸrenci bazlÄ± gÃ¶rÃ¼nÃ¼m)
        const componentDisplayName = getComponentDisplayName(parentComponentId);
        const studentCurrentGroup = getStudentGroupForComponent(student.studentId, parentComponentId);
        
        let html = `
            <div class="student-subitem" data-subitem-id="${subItem.id}" data-component-id="${parentComponentId}">
                <div class="subitem-header">
                    <span>${componentDisplayName}</span>
                    <span class="badge badge-primary">${subItem.points} puan</span>
                    <span class="badge badge-success">${subItem.outcomes.join(', ')}</span>
                    <span class="badge badge-info">Grup: ${studentCurrentGroup}</span>
                </div>
                <div class="subitem-questions-table">
                    <table class="assessment-table">
                        <thead>
                            <tr>
                                <th>KaÄŸÄ±t SÄ±rasÄ±</th>
                                <th>Soru SÄ±rasÄ±</th>
                                <th>Etkinlik AdÄ±<br/><small>(Soru/Rubrik)</small></th>
                                <th>AÃ§Ä±klama</th>
                                <th>Etkinlik Max. Puan<br/><small>(Soru/Rubrik)</small></th>
                                <th>Toplam Puan</th>
                                <th>Ã–Ã‡</th>
                                                <th>AlÄ±nan Puan<br/><small>(Etkinlik PuanÄ±)</small></th>
            </tr>
        </thead>
        <tbody>
        `;
        
        // Her soru iÃ§in satÄ±r oluÅŸtur (Ã–ÄŸrenci bazlÄ± gÃ¶rÃ¼nÃ¼m - grup seÃ§ici yok)
        subItem.children.forEach((question, paperOrder) => {
            const actualQuestionId = getQuestionIdByPaperOrder(student.studentId, paperOrder + 1, parentComponentId);
            const actualQuestion = findNodeById(actualQuestionId);
            const answerKeyOrder = getAnswerKeyOrder(student.studentId, paperOrder + 1, parentComponentId);
            
            // Soru bilgilerini al
            const questionName = `Soru ${answerKeyOrder || paperOrder + 1}`;
            const questionDescription = actualQuestion?.description || actualQuestion?.name || '-';
            const questionPointsForGroup = getQuestionPointsForStudentGroup(student.studentId, actualQuestionId, parentComponentId);
            const maxPoints = questionPointsForGroup || actualQuestion?.points || 0;
            const studentOutcomes = getQuestionOutcomesForStudent(student.studentId, actualQuestionId, parentComponentId);
            
            // Mevcut puanÄ± al
            const currentGrade = getStudentGrade(student.studentId, actualQuestionId) || '';
            
            html += `
                <tr data-question-id="${actualQuestionId}" data-paper-order="${paperOrder + 1}" data-student-id="${student.studentId}" data-component-id="${parentComponentId}">
                    <td class="paper-order-cell">
                        <span class="paper-order-badge">${paperOrder + 1}</span>
                    </td>
                    <td class="answer-key-order-cell">
                        <span class="answer-key-badge">${answerKeyOrder}</span>
                    </td>
                    <td class="question-name-cell">
                        <span class="question-name-badge">${questionName}</span>
                    </td>
                    <td class="question-description-cell">
                        <span class="question-desc-badge" title="${questionDescription}">${questionDescription}</span>
                    </td>
                    <td class="points-cell">
                        <span class="points-badge">${maxPoints}</span>
                    </td>
                    <td class="total-points-cell">
                        <span class="total-points-badge">${getStudentTotalEarnedPointsForComponent(student.studentId, parentComponentId)}</span>
                    </td>
                    <td class="outcomes-cell">
                        <span class="outcomes-badge">${Array.isArray(studentOutcomes) ? studentOutcomes.join(', ') : (studentOutcomes || '-')}</span>
                    </td>
                    <td class="grade-input-cell">
                        <input type="number" 
                               min="0" 
                               max="${maxPoints}" 
                               step="0.1"
                               class="grade-input" 
                               data-student-id="${student.studentId}" 
                               data-activity-id="${actualQuestionId}" 
                               value="${currentGrade}"
                               onchange="updateStudentGradeFromStudentView(this)">
                    </td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        </div>
        `;
        
        return html;
    } catch (error) {
        console.error("Alt Ã¶ÄŸe giriÅŸ bÃ¶lÃ¼mÃ¼ oluÅŸturulurken hata oluÅŸtu:", error);
        return '<div class="error-message">Alt Ã¶ÄŸe bilgileri yÃ¼klenemedi.</div>';
    }
}

/**
 * Ã–ÄŸrenci gÃ¶rÃ¼nÃ¼mÃ¼nde test giriÅŸ bÃ¶lÃ¼mÃ¼ oluÅŸturma
 * @param {Object} student - Ã–ÄŸrenci
 * @param {Object} testItem - Test Ã¶ÄŸesi
 * @returns {string} - HTML iÃ§eriÄŸi
 */
function createStudentTestInputSection(student, testItem) {
    try {
        // Ãœst bileÅŸen ID'sini bul
        const parentComponentId = getParentComponentId(testItem.id) || testItem.id;
        const component = APP_STATE.courseData?.grupHaritalari?.[parentComponentId];
        const useGroupSystem = component && component.gruplar && component.gruplar.length > 1;
        
        if (!useGroupSystem || !testItem.children || testItem.children.length === 0) {
            // Grup sistemi yok veya soru detaylarÄ± yok - basit test giriÅŸi
        const testScore = getStudentTestScore(student.studentId, testItem.id);
        const correct = testScore?.correct || 0;
        const wrong = testScore?.wrong || 0;
        const totalScore = correct * testItem.testDetails.correctWeight - wrong * Math.abs(testItem.testDetails.wrongPenalty);
        
        return `
            <div class="student-subitem student-test-item" data-subitem-id="${testItem.id}">
                <div class="subitem-header">
                    <span>${testItem.name}</span>
                    <span class="badge badge-primary">${testItem.points} puan</span>
                    <span class="badge badge-success">${testItem.outcomes.join(', ')}</span>
                </div>
                <div class="test-info">
                    <p>Toplam ${testItem.testDetails.totalQuestions} soru, her doÄŸru: ${testItem.testDetails.correctWeight} puan, her yanlÄ±ÅŸ: ${testItem.testDetails.wrongPenalty} puan</p>
                </div>
                <div class="test-inputs">
                    <div class="student-grade-input">
                        <label>DoÄŸru:</label>
                        <input type="number" min="0" max="${testItem.testDetails.totalQuestions}" 
                            data-student-id="${student.studentId}" 
                            data-test-id="${testItem.id}" 
                            data-field="correct"
                            value="${correct}"
                            onchange="updateTestScoreFromStudentView(this)">
                    </div>
                    <div class="student-grade-input">
                        <label>YanlÄ±ÅŸ:</label>
                        <input type="number" min="0" max="${testItem.testDetails.totalQuestions}" 
                            data-student-id="${student.studentId}" 
                            data-test-id="${testItem.id}" 
                            data-field="wrong"
                            value="${wrong}"
                            onchange="updateTestScoreFromStudentView(this)">
                    </div>
                    <div class="student-grade-input">
                        <label>Toplam:</label>
                        <span class="total-test-score">${totalScore.toFixed(2)}</span>
                    </div>
                </div>
            </div>
        `;
        }
        
        // Grup sistemi var ve soru detaylarÄ± var - detaylÄ± tablo (Ã–ÄŸrenci bazlÄ± gÃ¶rÃ¼nÃ¼m)
        const componentDisplayName = getComponentDisplayName(parentComponentId);
        const studentCurrentGroup = getStudentGroupForComponent(student.studentId, parentComponentId);
        
        let html = `
            <div class="student-subitem student-test-item" data-subitem-id="${testItem.id}" data-component-id="${parentComponentId}">
                <div class="subitem-header">
                    <span>${componentDisplayName}</span>
                    <span class="badge badge-primary">${testItem.points} puan</span>
                    <span class="badge badge-success">${testItem.outcomes.join(', ')}</span>
                    <span class="badge badge-info">Grup: ${studentCurrentGroup}</span>
                </div>
                <div class="test-questions-table">
                    <table class="assessment-table">
                        <thead>
                            <tr>
                                <th>KaÄŸÄ±t SÄ±rasÄ±</th>
                                <th>Soru SÄ±rasÄ±</th>
                                <th>Etkinlik AdÄ±<br/><small>(Soru/Rubrik)</small></th>
                                <th>AÃ§Ä±klama</th>
                                <th>Etkinlik Max. Puan<br/><small>(Soru/Rubrik)</small></th>
                                <th>Toplam Puan</th>
                                <th>Ã–Ã‡</th>
                                                <th>AlÄ±nan Puan<br/><small>(Etkinlik PuanÄ±)</small></th>
            </tr>
        </thead>
        <tbody>
        `;
        
        // Her soru iÃ§in satÄ±r oluÅŸtur (Ã–ÄŸrenci bazlÄ± gÃ¶rÃ¼nÃ¼m - grup seÃ§ici yok)
        testItem.children.forEach((question, paperOrder) => {
            const actualQuestionId = getQuestionIdByPaperOrder(student.studentId, paperOrder + 1, parentComponentId);
            const actualQuestion = findNodeById(actualQuestionId);
            const answerKeyOrder = getAnswerKeyOrder(student.studentId, paperOrder + 1, parentComponentId);
            
            // Soru bilgilerini al
            const questionName = `Soru ${answerKeyOrder || paperOrder + 1}`;
            const questionDescription = actualQuestion?.description || actualQuestion?.name || '-';
            const questionPointsForGroup = getQuestionPointsForStudentGroup(student.studentId, actualQuestionId, parentComponentId);
            const maxPoints = questionPointsForGroup || actualQuestion?.points || 0;
            const studentOutcomes = getQuestionOutcomesForStudent(student.studentId, actualQuestionId, parentComponentId);
            
            // Mevcut puanÄ± al
            const currentGrade = getStudentGrade(student.studentId, actualQuestionId) || '';
            
            html += `
                <tr data-question-id="${actualQuestionId}" data-paper-order="${paperOrder + 1}" data-student-id="${student.studentId}" data-component-id="${parentComponentId}">
                    <td class="paper-order-cell">
                        <span class="paper-order-badge">${paperOrder + 1}</span>
                    </td>
                    <td class="answer-key-order-cell">
                        <span class="answer-key-badge">${answerKeyOrder}</span>
                    </td>
                    <td class="question-name-cell">
                        <span class="question-name-badge">${questionName}</span>
                    </td>
                    <td class="question-description-cell">
                        <span class="question-desc-badge" title="${questionDescription}">${questionDescription}</span>
                    </td>
                    <td class="points-cell">
                        <span class="points-badge">${maxPoints}</span>
                    </td>
                    <td class="total-points-cell">
                        <span class="total-points-badge">${getStudentTotalEarnedPointsForComponent(student.studentId, parentComponentId)}</span>
                    </td>
                    <td class="outcomes-cell">
                        <span class="outcomes-badge">${Array.isArray(studentOutcomes) ? studentOutcomes.join(', ') : (studentOutcomes || '-')}</span>
                    </td>
                    <td class="grade-input-cell">
                        <input type="number" 
                               min="0" 
                               max="${maxPoints}" 
                               step="0.1"
                               class="grade-input" 
                               data-student-id="${student.studentId}" 
                               data-activity-id="${actualQuestionId}" 
                               value="${currentGrade}"
                               onchange="updateStudentGradeFromStudentView(this)">
                    </td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        </div>
        `;
        
        return html;
    } catch (error) {
        console.error("Test giriÅŸ bÃ¶lÃ¼mÃ¼ oluÅŸturulurken hata oluÅŸtu:", error);
        return '<div class="error-message">Test bilgileri yÃ¼klenemedi.</div>';
    }
}

/**
 * Ã–ÄŸrenci gÃ¶rÃ¼nÃ¼mÃ¼nden not gÃ¼ncelleme
 * @param {HTMLInputElement} input - Not input elementi
 */
function updateStudentGradeFromStudentView(input) {
    try {
        const studentId = input.dataset.studentId;
        const activityId = input.dataset.activityId;
        
        // Aktiviteyi bul ve maksimum puanÄ±nÄ± kontrol et
        const activity = findNodeById(activityId);
        if (!activity) {
            console.error(`Aktivite bulunamadÄ±: ${activityId}`);
            return;
        }
        
        // Maksimum puan kontrolÃ¼
        const maxPoints = activity.points || 100;
        let value = parseFloat(input.value) || 0;
        
        // Maksimum puanÄ± aÅŸan deÄŸerleri sÄ±nÄ±rla
        if (value > maxPoints) {
            value = maxPoints;
            input.value = maxPoints;
            showModernToast(`Dikkat: Puan ${maxPoints} deÄŸerinden bÃ¼yÃ¼k olamaz!`, "warning");
        }
        
        // Ã–ÄŸrenci verisi oluÅŸtur
        if (!APP_STATE.gradesData[studentId]) {
            APP_STATE.gradesData[studentId] = {};
        }
        
        // Test mi kontrol et
        if (activity && activity.type === 'Test') {
            // Test skorlarÄ± iÃ§in Ã¶zel iÅŸlem
            const correctWeight = activity.testDetails?.correctWeight || 5;
            const wrongPenalty = Math.abs(activity.testDetails?.wrongPenalty || 0);
            
            // Basit yaklaÅŸÄ±m: tÃ¼m puanÄ± doÄŸru sorudan gelecek ÅŸekilde ayarla
            const correctEstimate = Math.round(value / correctWeight);
            
            APP_STATE.gradesData[studentId][activityId] = {
                tip: 'test',
                dogru: correctEstimate,
                yanlis: 0
            };
            
            // DeÄŸerlendirme sekmesindeki form elementlerini bul ve gÃ¼ncelle
            const assessmentCorrectInput = document.querySelector(`#assessment-content input[data-student-id="${studentId}"][data-test-id="${activityId}"][data-field="correct"]`);
            const assessmentWrongInput = document.querySelector(`#assessment-content input[data-student-id="${studentId}"][data-test-id="${activityId}"][data-field="wrong"]`);
            
            if (assessmentCorrectInput) assessmentCorrectInput.value = correctEstimate;
            if (assessmentWrongInput) assessmentWrongInput.value = 0;
            
            // Total score'u gÃ¼ncelle
            const assessmentTotalScore = document.querySelector(`#assessment-content tr:has(input[data-student-id="${studentId}"][data-test-id="${activityId}"]) .total-score`);
            if (assessmentTotalScore) {
                assessmentTotalScore.textContent = value.toFixed(2);
            }
            
        } else {
            // Normal not iÃ§in
            APP_STATE.gradesData[studentId][activityId] = value;
            
            // Alt dÃ¼ÄŸÃ¼m yapÄ±sÄ±nÄ± oluÅŸtur (A1.1 -> A1 altÄ±nda storlama)
            const parts = activityId.split('.');
            if (parts.length > 1) {
                const parentId = parts[0]; // A1
                const shortId = parts[parts.length - 1]; // 1
                
                // EÄŸer Ã¼st aktivite yoksa oluÅŸtur
                if (!APP_STATE.gradesData[studentId][parentId]) {
                    APP_STATE.gradesData[studentId][parentId] = {
                        toplam: 0
                    };
                }
                
                // Not deÄŸerini ekle - hem tam ID, hem kÄ±sa ID olarak
                APP_STATE.gradesData[studentId][parentId][activityId] = value;
                APP_STATE.gradesData[studentId][parentId][shortId] = value;
                
                // Toplama hesapla
                updateParentActivityTotal(studentId, parentId);
            }
            
            // DeÄŸerlendirme sekmesindeki aynÄ± inputu gÃ¼ncelle
            const assessmentInput = document.querySelector(`#assessment-content input[data-student-id="${studentId}"][data-activity-id="${activityId}"]`);
            if (assessmentInput && assessmentInput !== input) {
                assessmentInput.value = value;
            }
        }
        
        // NotlarÄ± yeniden hesapla
        updateStudentCalculatedGrade(studentId);
        
        // Assessment tablosundaki not Ã¶zeti hÃ¼crelerini gÃ¼ncelle
        updateAssessmentGradeSummary(studentId);
        
        // Ã–zetleme bÃ¶lÃ¼mÃ¼nÃ¼ gÃ¼ncelle
        updateStudentSummary(studentId);
        
    } catch (error) {
        console.error("Ã–ÄŸrenci notu gÃ¼ncellenirken hata oluÅŸtu:", error);
        showModernToast("Not gÃ¼ncellenirken hata oluÅŸtu!", "error");
    }
}

/**
 * Ã–ÄŸrenci gÃ¶rÃ¼nÃ¼mÃ¼nde test skorunu gÃ¼ncelleme
 * @param {HTMLInputElement} input - Test skoru input elementi
 */
function updateTestScoreFromStudentView(input) {
    try {
        const studentId = input.dataset.studentId;
        const testId = input.dataset.testId;
        const field = input.dataset.field;
        const value = parseInt(input.value) || 0;
        
        // Ã–nce verileri gÃ¼ncelle
        updateTestScoreData(studentId, testId, field, value);
        
        // DeÄŸerlendirme sekmesindeki karÅŸÄ±lÄ±k gelen test score alanlarÄ±nÄ± gÃ¼ncelle
        const assessmentInput = document.querySelector(`#assessment-content input[data-student-id="${studentId}"][data-test-id="${testId}"][data-field="${field}"]`);
        if (assessmentInput && assessmentInput !== input) {
            assessmentInput.value = value;
            // Event'i manuel tetikle
            assessmentInput.dispatchEvent(new Event('change'));
        }
        
        // YalnÄ±zca Ã¶ÄŸrenci gÃ¶rÃ¼nÃ¼mÃ¼ndeki toplam skoru gÃ¼ncelle
        updateStudentViewTestTotal(studentId, testId);
        
        // NotlarÄ± yeniden hesapla
        updateStudentCalculatedGrade(studentId);
        
        // Assessment tablosundaki not Ã¶zeti hÃ¼crelerini gÃ¼ncelle
        updateAssessmentGradeSummary(studentId);
        
        // Ã–zetleme bÃ¶lÃ¼mÃ¼nÃ¼ gÃ¼ncelle
        updateStudentSummary(studentId);
        
    } catch (error) {
        console.error("Test skoru gÃ¼ncellenirken hata oluÅŸtu:", error);
        showModernToast("Test skoru gÃ¼ncellenirken hata oluÅŸtu!", "error");
    }
}

// Test skoru verilerini gÃ¼ncelleme (yardÄ±mcÄ± fonksiyon)
function updateTestScoreData(studentId, testId, field, value) {
    // Test dÃ¼ÄŸÃ¼mÃ¼nÃ¼ bul
    const testNode = findNodeById(testId);
    if (!testNode) return;
    
    // Ã–ÄŸrenci notlarÄ± henÃ¼z yoksa oluÅŸtur
    if (!APP_STATE.gradesData[studentId]) {
        APP_STATE.gradesData[studentId] = {};
    }
    
    // Test notlarÄ± henÃ¼z yoksa oluÅŸtur
    if (!APP_STATE.gradesData[studentId][testId]) {
        APP_STATE.gradesData[studentId][testId] = {
            tip: 'test',
            dogru: 0,
            yanlis: 0
        };
    }
    
    // Ä°lgili alanÄ± gÃ¼ncelle
    if (field === 'correct') {
        APP_STATE.gradesData[studentId][testId].dogru = value;
    } else if (field === 'wrong') {
        APP_STATE.gradesData[studentId][testId].yanlis = value;
    } else {
        APP_STATE.gradesData[studentId][testId][field] = value;
    }
    
    // DoÄŸru ve yanlÄ±ÅŸ sayÄ±larÄ±nÄ± kontrol et
    const testScore = APP_STATE.gradesData[studentId][testId];
    const correct = testScore.dogru || 0;
    const wrong = testScore.yanlis || 0;
    const totalQuestions = testNode.testDetails.totalQuestions;
    
    // DoÄŸru ve yanlÄ±ÅŸ toplamÄ± toplam soru sayÄ±sÄ±nÄ± geÃ§emez
    if (correct + wrong > totalQuestions) {
        showModernToast(`Dikkat: DoÄŸru ve yanlÄ±ÅŸ sorularÄ±n toplamÄ± toplam soru sayÄ±sÄ±nÄ± (${totalQuestions}) geÃ§emez.`, "warning");
        // DeÄŸeri dÃ¼zelt
        if (field === 'correct') {
            APP_STATE.gradesData[studentId][testId].dogru = totalQuestions - wrong;
        } else {
            APP_STATE.gradesData[studentId][testId].yanlis = totalQuestions - correct;
        }
    }
    
    // Alt test yapÄ±sÄ± oluÅŸtur (gerekiyorsa)
    const parts = testId.split('.');
    if (parts.length > 1) {
        const parentId = parts[0]; // A1
        const shortId = parts[parts.length - 1]; // 1
        
        // EÄŸer Ã¼st aktivite yoksa oluÅŸtur
        if (!APP_STATE.gradesData[studentId][parentId]) {
            APP_STATE.gradesData[studentId][parentId] = {
                toplam: 0
            };
        }
        
        // KÄ±sa kod da ekle
        APP_STATE.gradesData[studentId][parentId][shortId] = {
            tip: 'test',
            dogru: testScore.dogru,
            yanlis: testScore.yanlis
        };
        
        // Alt yapÄ±ya da ekle
        if (!APP_STATE.gradesData[studentId][parentId][testId]) {
            APP_STATE.gradesData[studentId][parentId][testId] = {
                tip: 'test',
                dogru: testScore.dogru,
                yanlis: testScore.yanlis
            };
        } else {
            APP_STATE.gradesData[studentId][parentId][testId].dogru = testScore.dogru;
            APP_STATE.gradesData[studentId][parentId][testId].yanlis = testScore.yanlis;
        }
        
        // Toplama hesapla
        updateParentActivityTotal(studentId, parentId);
    }
}

// Ãœst aktivitenin toplamÄ±nÄ± gÃ¼ncelleme (yardÄ±mcÄ± fonksiyon)
function updateParentActivityTotal(studentId, parentId) {
    const parentActivity = findNodeById(parentId);
    if (parentActivity && parentActivity.children && parentActivity.children.length > 0) {
        let total = 0;
        let maxPoints = 0;
        
        parentActivity.children.forEach(child => {
            let grade = 0;
            if (child.type === 'Test') {
                // Test notlarÄ± iÃ§in Ã¶zel hesaplama
                const testScore = APP_STATE.gradesData[studentId][child.id];
                if (testScore && testScore.tip === 'test') {
                    const correct = testScore.dogru || 0;
                    const wrong = testScore.yanlis || 0;
                    grade = correct * (child.testDetails?.correctWeight || 5) - 
                            wrong * Math.abs(child.testDetails?.wrongPenalty || 0);
                }
            } else {
                grade = getStudentGrade(studentId, child.id) || 0;
            }
            total += grade;
            maxPoints += parseFloat(child.points) || 0;
        });
        
        // Toplam puanÄ± hesapla (100 Ã¼zerinden)
        const normalized = maxPoints > 0 ? (total / maxPoints) * 100 : 0;
        APP_STATE.gradesData[studentId][parentId].toplam = normalized;
    }
}

// Ã–ÄŸrenci gÃ¶rÃ¼nÃ¼mÃ¼nde test toplamÄ±nÄ± gÃ¼ncelleme (yardÄ±mcÄ± fonksiyon)
function updateStudentViewTestTotal(studentId, testId) {
    const testNode = findNodeById(testId);
    if (!testNode) return;
    
    const testScore = APP_STATE.gradesData[studentId][testId];
    if (!testScore) return;
    
    const correct = testScore.dogru || 0;
    const wrong = testScore.yanlis || 0;
    const correctWeight = testNode.testDetails?.correctWeight || 5;
    const wrongPenalty = Math.abs(testNode.testDetails?.wrongPenalty || 0);
    const totalScore = correct * correctWeight - wrong * wrongPenalty;
    
    // Ã–ÄŸrenci gÃ¶rÃ¼nÃ¼mÃ¼ndeki toplam skoru gÃ¼ncelle
    const studentViewTotalElement = document.querySelector(`#studentGradesContainer .student-test-item[data-subitem-id="${testId}"] .total-test-score`);
    if (studentViewTotalElement) {
                    studentViewTotalElement.textContent = totalScore.toFixed(2);
    }
}

// Ã–ÄŸrenci Ã¶zet bilgilerini gÃ¼ncelleme (yardÄ±mcÄ± fonksiyon)
function updateStudentSummary(studentId) {
    const studentGrades = calculateStudentGrades(studentId);
    if (!studentGrades) return;
    
    // Ã–zet alanÄ±nÄ± gÃ¼ncelle
    const summaryItems = document.querySelectorAll('#studentGradesContainer .student-summary .summary-item strong');
    if (summaryItems.length === 4) {
        summaryItems[0].textContent = studentGrades.termGrade;
        summaryItems[1].textContent = studentGrades.finalGrade;
        summaryItems[2].textContent = studentGrades.totalGrade;
        summaryItems[3].textContent = studentGrades.letterGrade;
        summaryItems[3].className = getLetterGradeClass(studentGrades.letterGrade);
    }
}

/**
 * Ã‡oklu Ã¶ÄŸe ekleme modalÄ±nÄ± gÃ¶sterme
 * @param {string} type - Eklenecek Ã¶ÄŸe tipi ('soru' veya 'rubrik')
 */
function showMultipleItemsModal(type = 'soru') {
    // Modal baÅŸlÄ±ÄŸÄ±nÄ± ayarla
    multipleItemsTitle.textContent = type === 'soru' ? 'Ã‡oklu Soru Ekle' : 'Ã‡oklu Rubrik Ekle';
    
    // Hedef etkinlik combobox'Ä±nÄ± doldur
    const targetActivitySelect = document.getElementById('targetActivitySelect');
    targetActivitySelect.innerHTML = '';
    
    // Mevcut ana etkinlikleri bul ve ekle - Ã§oklu veri kaynaÄŸÄ± kontrolÃ¼
    const activities = [];
    
    // Ã–nce APP_STATE.data.children kontrol et
    if (APP_STATE.data && APP_STATE.data.children) {
        APP_STATE.data.children.forEach(node => {
            // Ana etkinlikler (alt dÃ¼ÄŸÃ¼m olmayan)
            if (!node.id.includes('.')) {
                activities.push({
                    id: node.id,
                    name: node.name || node.type || `Etkinlik ${node.id}`,
                    type: node.type || 'Bilinmeyen',
                    category: node.id.startsWith('A') ? 'YarÄ±yÄ±l Ä°Ã§i' : 'YarÄ±yÄ±l Sonu'
                });
            }
        });
    }
    
    // EÄŸer bulunamadÄ±ysa APP_STATE.assessmentTree kontrol et
    if (activities.length === 0 && APP_STATE.assessmentTree && APP_STATE.assessmentTree.length > 0) {
        APP_STATE.assessmentTree.forEach(node => {
            // Ana etkinlikler (alt dÃ¼ÄŸÃ¼m olmayan)
            if (!node.id.includes('.')) {
                activities.push({
                    id: node.id,
                    name: node.name || node.type || `Etkinlik ${node.id}`,
                    type: node.type || 'Bilinmeyen',
                    category: node.id.startsWith('A') ? 'YarÄ±yÄ±l Ä°Ã§i' : 'YarÄ±yÄ±l Sonu'
                });
            }
        });
    }
    
    // Son olarak DOM'dan kontrol et
    if (activities.length === 0) {
        document.querySelectorAll('.tree-node').forEach(nodeEl => {
            const nodeId = nodeEl.dataset.id;
            if (nodeId && !nodeId.includes('.')) {
                const nameEl = nodeEl.querySelector('.nodeName');
                const typeEl = nodeEl.querySelector('.nodeType');
                activities.push({
                    id: nodeId,
                    name: nameEl ? nameEl.value : `Etkinlik ${nodeId}`,
                    type: typeEl ? typeEl.value : 'Bilinmeyen',
                    category: nodeId.startsWith('A') ? 'YarÄ±yÄ±l Ä°Ã§i' : 'YarÄ±yÄ±l Sonu'
                });
            }
        });
    }
    
    console.log("ğŸ” showMultipleItemsModal - Bulunan etkinlikler:", activities);
    console.log("ğŸ” APP_STATE.data:", APP_STATE.data);
    console.log("ğŸ” APP_STATE.assessmentTree:", APP_STATE.assessmentTree);
    
    if (activities.length === 0) {
        const option = document.createElement('option');
        option.disabled = true;
        option.textContent = 'HenÃ¼z etkinlik tanÄ±mlanmamÄ±ÅŸ - LÃ¼tfen Ã¶nce etkinlik oluÅŸturun';
        targetActivitySelect.appendChild(option);
        
        // Etkinlik yoksa bile modalÄ± aÃ§ ama uyarÄ± ver
        showModernToast("HenÃ¼z etkinlik tanÄ±mlanmamÄ±ÅŸ. Ã–nce 'YarÄ±yÄ±l Ä°Ã§i Ekle' veya 'YarÄ±yÄ±l Sonu Ekle' butonlarÄ±nÄ± kullanarak etkinlik oluÅŸturun.", "warning");
        // return; // Bu satÄ±rÄ± kaldÄ±rÄ±yoruz ki modal aÃ§Ä±lsÄ±n
    }
    
    // Etkinlikleri kategoriye gÃ¶re grupla ve ekle
    const termActivities = activities.filter(a => a.category === 'YarÄ±yÄ±l Ä°Ã§i');
    const finalActivities = activities.filter(a => a.category === 'YarÄ±yÄ±l Sonu');
    
    if (termActivities.length > 0) {
        const termGroup = document.createElement('optgroup');
        termGroup.label = 'ğŸ“š YarÄ±yÄ±l Ä°Ã§i DeÄŸerlendirme';
        termActivities.forEach(activity => {
            const option = document.createElement('option');
            option.value = activity.id;
            option.textContent = `${activity.id} - ${activity.name} (${activity.type})`;
            termGroup.appendChild(option);
        });
        targetActivitySelect.appendChild(termGroup);
    }
    
    if (finalActivities.length > 0) {
        const finalGroup = document.createElement('optgroup');
        finalGroup.label = 'ğŸ“ YarÄ±yÄ±l Sonu DeÄŸerlendirme';
        finalActivities.forEach(activity => {
            const option = document.createElement('option');
            option.value = activity.id;
            option.textContent = `${activity.id} - ${activity.name} (${activity.type})`;
            finalGroup.appendChild(option);
        });
        targetActivitySelect.appendChild(finalGroup);
    }
    
    // EÄŸer seÃ§ili bir etkinlik varsa onu varsayÄ±lan olarak seÃ§
    if (APP_STATE.selectedNode && !APP_STATE.selectedNode.id.includes('.')) {
        targetActivitySelect.value = APP_STATE.selectedNode.id;
    }
    
    // Tip deÄŸiÅŸimine gÃ¶re uygun container'Ä± gÃ¶ster
    if (type === 'soru') {
        questionTypeContainer.style.display = 'block';
        rubricTypeContainer.style.display = 'none';
        
        // Soru tiplerini dinamik olarak doldur
        questionType.innerHTML = '';
        
        // Ã–nce varsayÄ±lan 'Soru' seÃ§eneÄŸi
        const defaultOption = document.createElement('option');
        defaultOption.value = 'Soru';
        defaultOption.textContent = 'Soru (Genel)';
        questionType.appendChild(defaultOption);
        
        // DiÄŸer soru tÃ¼rlerini ekle
        document.querySelectorAll('.question-type-item').forEach(item => {
            const value = item.getAttribute('data-type');
            if (value !== 'Test') { // Test tÃ¼rÃ¼nÃ¼ hariÃ§ tut
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                questionType.appendChild(option);
            }
        });
    } else {
        questionTypeContainer.style.display = 'none';
        rubricTypeContainer.style.display = 'block';
        
        // Rubrik tiplerini dinamik olarak doldur
        rubricType.innerHTML = '';
        
        // Ã–nce varsayÄ±lan 'Rubrik' seÃ§eneÄŸi
        const defaultOption = document.createElement('option');
        defaultOption.value = 'Rubrik';
        defaultOption.textContent = 'Rubrik (Genel)';
        rubricType.appendChild(defaultOption);
        
        // DiÄŸer rubrik tÃ¼rlerini ekle
        document.querySelectorAll('.rubric-item').forEach(item => {
            const value = item.getAttribute('data-type');
            const option = document.createElement('option');
            option.value = value;
            option.textContent = value;
            rubricType.appendChild(option);
        });
    }
    
    // Ã–ÄŸrenme Ã‡Ä±ktÄ±larÄ±nÄ± doldur
    const outcomeSelection = document.getElementById('outcomeSelection');
    outcomeSelection.innerHTML = '';
    
    // Ã–ÄŸrenme Ã§Ä±ktÄ±larÄ±nÄ± ekle
    if (APP_STATE.learningOutcomes && APP_STATE.learningOutcomes.length > 0) {
        APP_STATE.learningOutcomes.forEach(outcome => {
            const option = document.createElement('option');
            option.value = outcome.id;
            option.textContent = `${outcome.id}: ${outcome.aciklama}`;
            outcomeSelection.appendChild(option);
        });
    } else {
        // Ã–ÄŸrenme Ã§Ä±ktÄ±sÄ± yoksa bilgi mesajÄ± ekle
        const option = document.createElement('option');
        option.disabled = true;
        option.textContent = 'HenÃ¼z Ã¶ÄŸrenme Ã§Ä±ktÄ±sÄ± tanÄ±mlanmamÄ±ÅŸ';
        outcomeSelection.appendChild(option);
    }
    
    // Global deÄŸiÅŸkenleri ayarla
    APP_STATE.multipleItemsNode = APP_STATE.selectedNode;
    APP_STATE.multipleItemsType = type;
    
    // ModalÄ± gÃ¶ster
    openModal(multipleItemsModal);
}

/**
 * Ã‡oklu Ã¶ÄŸe ekleme iÅŸlemini gerÃ§ekleÅŸtirme
 */
function addMultipleItems() {
    try {
        const count = parseInt(itemCount.value) || 5;
        const type = APP_STATE.multipleItemsType;
        
        // Hedef etkinliÄŸi combobox'tan al
        const targetActivitySelect = document.getElementById('targetActivitySelect');
        const selectedActivityId = targetActivitySelect.value;
        
        if (!selectedActivityId || selectedActivityId === '') {
            showModernToast("LÃ¼tfen hedef etkinlik listesinden bir etkinlik seÃ§in. EÄŸer liste boÅŸsa Ã¶nce 'YarÄ±yÄ±l Ä°Ã§i Ekle' veya 'YarÄ±yÄ±l Sonu Ekle' butonlarÄ±nÄ± kullanarak etkinlik oluÅŸturun.", "warning");
            return;
        }
        
        // SeÃ§ilen etkinliÄŸi bul
        const selectedNode = findNodeById(selectedActivityId);
        
        if (!selectedNode) {
            showModernToast("SeÃ§ilen etkinlik bulunamadÄ±.", "error");
            return;
        }
        
        // SeÃ§ilen etkinliÄŸin bilgilerini al
        const activityInfo = `${selectedNode.id} - ${selectedNode.name || selectedNode.type} (${selectedNode.type})`;
        const category = selectedNode.id.startsWith('A') ? 'YarÄ±yÄ±l Ä°Ã§i' : 'YarÄ±yÄ±l Sonu';
        
        // SeÃ§ilen Ã–Ã‡'leri al
        const outcomeSelection = document.getElementById('outcomeSelection');
        const selectedOutcomes = Array.from(outcomeSelection.selectedOptions).map(option => option.value);
        
        // Mevcut alt Ã¶ÄŸeleri kontrol et
        const existingChildrenCount = selectedNode.children ? selectedNode.children.length : 0;
        
        // AÄŸÄ±rlÄ±k hesaplama
        let newItemWeight = 0;
        
        if (existingChildrenCount === 0) {
            // HiÃ§ alt Ã¶ÄŸe yoksa, 100'Ã¼ eÅŸit bÃ¶l
            newItemWeight = Math.floor(100 / count);
        } else {
            // Mevcut alt Ã¶ÄŸelerin toplam aÄŸÄ±rlÄ±ÄŸÄ±nÄ± hesapla
            const totalExistingWeight = selectedNode.children.reduce((sum, child) => sum + (parseFloat(child.weight) || 0), 0);
            
            // Kalan aÄŸÄ±rlÄ±ÄŸÄ± bul (100'den fazla ise 0 olarak al)
            const remainingWeight = Math.max(0, 100 - totalExistingWeight);
            
            // Kalan aÄŸÄ±rlÄ±ÄŸÄ± eÅŸit bÃ¶l
            newItemWeight = Math.floor(remainingWeight / count);
            
            // EÄŸer kalan aÄŸÄ±rlÄ±k 0 ise, mevcut Ã¶ÄŸelerin aÄŸÄ±rlÄ±klarÄ±nÄ± yeniden daÄŸÄ±t
            if (remainingWeight <= 0) {
                // TÃ¼m alt Ã¶ÄŸelerin aÄŸÄ±rlÄ±klarÄ±nÄ± yeniden hesapla
                const totalItems = existingChildrenCount + count;
                const newWeightPerItem = Math.floor(100 / totalItems);
                
                // Mevcut alt Ã¶ÄŸelerin aÄŸÄ±rlÄ±klarÄ±nÄ± gÃ¼ncelle
                selectedNode.children.forEach(child => {
                    child.weight = newWeightPerItem;
                });
                
                newItemWeight = newWeightPerItem;
            }
        }
        
        // SeÃ§ilen tip ve sayÄ±da Ã¶ÄŸe ekle
        if (type === 'soru') {
            const selectedQuestionType = questionType.value;
            const description = Array.from(document.querySelectorAll('.question-type-item'))
                .find(item => item.getAttribute('data-type') === selectedQuestionType)?.getAttribute('data-description') || '';
            
            // Ã‡oklu soru ekle
            for (let i = 0; i < count; i++) {
                // Ã–Ã‡ atamasÄ± - dengeli daÄŸÄ±tÄ±m iÃ§in sÄ±rayla atama
                let outcome = [];
                if (selectedOutcomes.length > 0) {
                    // i. Ã¶ÄŸeye i % selectedOutcomes.length indeksindeki Ã–Ã‡'yi ata
                    outcome = [selectedOutcomes[i % selectedOutcomes.length]];
                }
                
                const newNode = {
                    id: `${selectedNode.id}.${(existingChildrenCount + i + 1)}`,
                    name: `${selectedQuestionType} ${existingChildrenCount + i + 1}`,
                    type: selectedQuestionType,
                    weight: newItemWeight,
                    points: 20, // VarsayÄ±lan puan
                    outcomes: outcome,
                    description: description || 'DeÄŸerlendirme sorusu',
                    expanded: false,
                    children: []
                };
                
                if (!selectedNode.children) {
                    selectedNode.children = [];
                }
                
                selectedNode.children.push(newNode);
            }
            
            showModernToast(`${count} adet "${selectedQuestionType}" sorusu "${activityInfo}" etkinliÄŸine eklendi.`, "success");
        } else {
            const selectedRubricType = rubricType.value;
            const description = Array.from(document.querySelectorAll('.rubric-item'))
                .find(item => item.getAttribute('data-type') === selectedRubricType)?.getAttribute('data-description') || '';
            
            // Ã‡oklu rubrik ekle
            for (let i = 0; i < count; i++) {
                // Ã–Ã‡ atamasÄ± - dengeli daÄŸÄ±tÄ±m iÃ§in sÄ±rayla atama
                let outcome = [];
                if (selectedOutcomes.length > 0) {
                    // i. Ã¶ÄŸeye i % selectedOutcomes.length indeksindeki Ã–Ã‡'yi ata
                    outcome = [selectedOutcomes[i % selectedOutcomes.length]];
                }
                
                const newNode = {
                    id: `${selectedNode.id}.${(existingChildrenCount + i + 1)}`,
                    name: `${selectedRubricType} ${existingChildrenCount + i + 1}`,
                    type: selectedRubricType,
                    weight: newItemWeight,
                    points: 20, // VarsayÄ±lan puan
                    outcomes: outcome,
                    description: description || 'DeÄŸerlendirme kriteri',
                    expanded: false,
                    children: []
                };
                
                if (!selectedNode.children) {
                    selectedNode.children = [];
                }
                
                selectedNode.children.push(newNode);
            }
            
            showModernToast(`${count} adet "${selectedRubricType}" rubriÄŸi "${activityInfo}" etkinliÄŸine eklendi.`, "success");
        }
        
        // Modal'Ä± kapat
        closeModal(multipleItemsModal);
        
        // Ana dÃ¼ÄŸÃ¼mÃ¼ geniÅŸlet
        selectedNode.expanded = true;
        
        // AÄŸacÄ± yeniden render et
        renderTree();
        
        // DeÄŸerlendirme sekmesini gÃ¼ncelle
        updateAssessmentView();
    } catch (error) {
        console.error("Ã‡oklu Ã¶ÄŸe eklenirken hata oluÅŸtu:", error);
        showModernToast("Ã–ÄŸeler eklenemedi!", "error");
    }
}

/**
 * Test sorularÄ±na rastgele doÄŸru/yanlÄ±ÅŸ daÄŸÄ±lÄ±mÄ± yapma
 * @param {string} studentId - Ã–ÄŸrenci ID'si
 * @param {string} testId - Test ID'si
 * @param {number} correct - DoÄŸru sayÄ±sÄ±
 * @param {number} wrong - YanlÄ±ÅŸ sayÄ±sÄ±
 */
function distributeTestScores(studentId, testId, correct, wrong) {
    // Modern test daÄŸÄ±tÄ±m modalÄ±nÄ± gÃ¶ster
    showTestScoreDistributionModal(studentId, testId);
}

/**
 * Diziyi karÄ±ÅŸtÄ±rma (Fisher-Yates shuffle algoritmasÄ±)
 * @param {Array} array - KarÄ±ÅŸtÄ±rÄ±lacak dizi
 */
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

/**
 * PuanlarÄ± eÅŸit olarak daÄŸÄ±t
 * @param {Object} parentNode - Ana etkinlik dÃ¼ÄŸÃ¼mÃ¼
 * @param {number} totalPoints - Toplam puan
 */
function distributePointsEqually(parentNode, totalPoints) {
    if (!parentNode || !parentNode.children || parentNode.children.length === 0) {
        return;
    }
    
    const childCount = parentNode.children.length;
    
    // EÅŸit daÄŸÄ±tÄ±m iÃ§in temel puanÄ± hesapla
    const basePoint = Math.floor(totalPoints / childCount);
    const remainder = totalPoints - (basePoint * childCount);
    
    // Her alt Ã¶ÄŸeye eÅŸit puan ver
    parentNode.children.forEach((child, index) => {
        // Son alt Ã¶ÄŸeye kalan puanlarÄ± ekle
        if (index === childCount - 1) {
            child.points = basePoint + remainder;
        } else {
            child.points = basePoint;
        }
    });
    
    // Alt Ã¶ÄŸelerin aÄŸÄ±rlÄ±klarÄ±nÄ± gÃ¼ncelle
    updateSubItemWeights(parentNode);
}

/**
 * SorularÄ±n puanlarÄ±nÄ± rastgele ama dengeli daÄŸÄ±tma
 * @param {Object} parentNode - Ana etkinlik dÃ¼ÄŸÃ¼mÃ¼
 * @param {number} totalPoints - Toplam puan
 */
function distributePointsRandomly(parentNode, totalPoints) {
    if (!parentNode || !parentNode.children || parentNode.children.length === 0) {
        return;
    }
    
    const childCount = parentNode.children.length;
    
    // Dengeli bir daÄŸÄ±lÄ±m iÃ§in Ã¶nce eÅŸit puan ver
    const basePoint = Math.floor(totalPoints / childCount);
    const remainder = totalPoints - (basePoint * childCount);
    
    // Ã–Ã‡'leri grupla
    const outcomeGroups = {};
    parentNode.children.forEach(child => {
        if (child.outcomes && child.outcomes.length > 0) {
            const key = child.outcomes.join(',');
            if (!outcomeGroups[key]) {
                outcomeGroups[key] = [];
            }
            outcomeGroups[key].push(child);
        } else {
            // Ã–Ã‡'si olmayan sorular iÃ§in Ã¶zel grup
            if (!outcomeGroups['no_outcome']) {
                outcomeGroups['no_outcome'] = [];
            }
            outcomeGroups['no_outcome'].push(child);
        }
    });
    
    // DÃ¼zgÃ¼n bir daÄŸÄ±lÄ±m yapabilmek iÃ§in puan dizisi oluÅŸtur
    let points = parentNode.children.map(() => basePoint);
    
    // Kalan puanlarÄ± rastgele daÄŸÄ±t (her Ã–Ã‡ grubuna eÅŸit daÄŸÄ±lÄ±m yaparak)
    const outcomeKeys = Object.keys(outcomeGroups);
    
    // Her gruba eÅŸit sayÄ±da ek puan daÄŸÄ±t
    const extraPointsPerGroup = Math.floor(remainder / outcomeKeys.length);
    let remainingExtra = remainder - (extraPointsPerGroup * outcomeKeys.length);
    
    outcomeKeys.forEach(key => {
        const group = outcomeGroups[key];
        const extraPointsForThisGroup = group.length > 0 ? Math.floor(extraPointsPerGroup / group.length) : 0;
        let groupRemainder = extraPointsPerGroup - (extraPointsForThisGroup * group.length);
        
        // Her soruya ek puanÄ± ata
        group.forEach(child => {
            const index = parentNode.children.indexOf(child);
            if (index !== -1) {
                points[index] += extraPointsForThisGroup;
            }
        });
        
        // Gruptaki kalan puanlarÄ± rastgele daÄŸÄ±t
        while (groupRemainder > 0 && group.length > 0) {
            const randomIndex = Math.floor(Math.random() * group.length);
            const childIndex = parentNode.children.indexOf(group[randomIndex]);
            if (childIndex !== -1) {
                points[childIndex]++;
                groupRemainder--;
            }
        }
    });
    
    // Son kalan puanlarÄ± rastgele daÄŸÄ±t
    while (remainingExtra > 0 && parentNode.children.length > 0) {
        const randomIndex = Math.floor(Math.random() * parentNode.children.length);
        points[randomIndex]++;
        remainingExtra--;
    }
    
    // PuanlarÄ± Ã§ocuk dÃ¼ÄŸÃ¼mlere ata
    parentNode.children.forEach((child, index) => {
        child.points = points[index];
    });
    
    // Alt Ã¶ÄŸelerin aÄŸÄ±rlÄ±klarÄ±nÄ± da gÃ¼ncelle
    updateSubItemWeights(parentNode);
}

/**
 * Alt Ã¶ÄŸelerin aÄŸÄ±rlÄ±klarÄ±nÄ± toplam puana gÃ¶re gÃ¼nceller
 * @param {Object} parentNode - Ana etkinlik dÃ¼ÄŸÃ¼mÃ¼
 */
function updateSubItemWeights(parentNode) {
    if (!parentNode || !parentNode.children || parentNode.children.length === 0) {
        return;
    }
    
    // Toplam puanÄ± hesapla
    const totalPoints = parentNode.children.reduce((sum, child) => sum + (parseInt(child.points) || 0), 0);
    
    // Her Ã§ocuk iÃ§in aÄŸÄ±rlÄ±k hesapla
    if (totalPoints > 0) {
        parentNode.children.forEach(child => {
            const childPoints = parseInt(child.points) || 0;
            child.weight = Math.round((childPoints / totalPoints) * 100);
        });
    }
}

/**
 * Soru veya rubrik eklendiÄŸinde/Ã§Ä±karÄ±ldÄ±ÄŸÄ±nda puanlarÄ± yeniden daÄŸÄ±tmak isteyip istemediÄŸini sor
 * @param {Object} parentNode - Ana etkinlik dÃ¼ÄŸÃ¼mÃ¼
 */
function checkAndOfferRedistribution(parentNode) {
    if (!parentNode || !parentNode.children || parentNode.children.length <= 1) {
        return;
    }
    
    // Toplam aÄŸÄ±rlÄ±ÄŸÄ± kontrol et
    const totalWeight = parentNode.children.reduce((sum, child) => sum + (parseInt(child.weight) || 0), 0);
    
    if (totalWeight !== 100) {
        // Modern daÄŸÄ±tÄ±m modalÄ±nÄ± gÃ¶ster
        showDistributePointsModal(parentNode, totalWeight);
    }
}

// =====================================================
// MODERN MODAL & TOAST SÄ°STEMÄ°
// =====================================================

/**
 * Modern onay modalÄ± gÃ¶sterir
 * @param {string} title - Modal baÅŸlÄ±ÄŸÄ±
 * @param {string} message - Onay mesajÄ±
 * @param {Function} onConfirm - OnaylandÄ±ÄŸÄ±nda Ã§alÄ±ÅŸacak fonksiyon
 * @param {Function} onCancel - Ä°ptal edildiÄŸinde Ã§alÄ±ÅŸacak fonksiyon (opsiyonel)
 * @param {Object} options - Buton metinleri ve stiller (opsiyonel)
 */
function showModernConfirm(title, message, options = {}) {
    console.log("ğŸ” showModernConfirm Ã§aÄŸrÄ±ldÄ±:", title);
    console.log("ğŸ” Options:", options);
    
    return new Promise((resolve) => {
    const modal = document.getElementById('modernConfirmModal');
    const titleElement = document.getElementById('confirmModalTitle');
    const messageElement = document.getElementById('confirmModalMessage');
    const yesButton = document.getElementById('confirmModalYes');
    const noButton = document.getElementById('confirmModalNo');
        const headerElement = modal ? modal.querySelector('.modern-modal-header') : null;
        const iconElement = modal ? modal.querySelector('.modal-icon') : null;
        
        console.log("ğŸ” Modal elementleri kontrol ediliyor:");
        console.log("- modal:", modal ? "âœ… Bulundu" : "âŒ BulunamadÄ±");
        console.log("- titleElement:", titleElement ? "âœ… Bulundu" : "âŒ BulunamadÄ±");
        console.log("- messageElement:", messageElement ? "âœ… Bulundu" : "âŒ BulunamadÄ±");
        console.log("- yesButton:", yesButton ? "âœ… Bulundu" : "âŒ BulunamadÄ±");
        console.log("- noButton:", noButton ? "âœ… Bulundu" : "âŒ BulunamadÄ±");
        console.log("- headerElement:", headerElement ? "âœ… Bulundu" : "âŒ BulunamadÄ±");
        console.log("- iconElement:", iconElement ? "âœ… Bulundu" : "âŒ BulunamadÄ±");
    
    if (!modal || !titleElement || !messageElement || !yesButton || !noButton) {
            console.error('âŒ Modern confirm modal elementleri bulunamadÄ±!');
        // Fallback olarak toast mesajÄ± gÃ¶ster
        showModernToast("Modal yÃ¼klenemedi. LÃ¼tfen sayfayÄ± yenileyin.", "error");
            resolve(false);
        return;
    }
    
    // VarsayÄ±lan buton metinleri ve stiller
    const defaultOptions = {
        confirmText: 'Evet, Sil',
        cancelText: 'Ä°ptal',
        confirmClass: 'btn-danger',
        cancelClass: 'btn-secondary',
        headerClass: 'danger-action',
        iconClass: 'danger'
    };
    
    // Options'Ä± birleÅŸtir
    const finalOptions = { ...defaultOptions, ...options };
    
    // Modal iÃ§eriÄŸini ayarla
    titleElement.textContent = title;
    messageElement.textContent = message;
    
    // Buton metinlerini gÃ¼ncelle
    yesButton.textContent = finalOptions.confirmText;
    noButton.textContent = finalOptions.cancelText;
    
    // Buton sÄ±nÄ±flarÄ±nÄ± gÃ¼ncelle
    yesButton.className = `modern-confirm-btn ${finalOptions.confirmClass}`;
    noButton.className = `modern-confirm-btn ${finalOptions.cancelClass}`;
    
    // Header renk sÄ±nÄ±fÄ±nÄ± gÃ¼ncelle
    if (headerElement) {
        // Mevcut action sÄ±nÄ±flarÄ±nÄ± temizle
        headerElement.classList.remove('create-action', 'success-action', 'info-action', 'warning-action', 'danger-action');
        // Yeni sÄ±nÄ±fÄ± ekle
        headerElement.classList.add(finalOptions.headerClass);
    }
    
    // Ä°kon sÄ±nÄ±fÄ±nÄ± ve iÃ§eriÄŸini gÃ¼ncelle
    if (iconElement) {
        // Mevcut icon sÄ±nÄ±flarÄ±nÄ± temizle
        iconElement.classList.remove('warning', 'danger', 'success', 'info');
        // Yeni sÄ±nÄ±fÄ± ekle
        iconElement.classList.add(finalOptions.iconClass);
        
        // Ä°kon SVG iÃ§eriÄŸini gÃ¼ncelle
        const iconSvg = iconElement.querySelector('svg');
        if (iconSvg) {
            // SVG boyutunu 64x64 yap
            iconSvg.setAttribute('width', '64');
            iconSvg.setAttribute('height', '64');
            
            switch(finalOptions.iconClass) {
                case 'success':
                    iconSvg.innerHTML = `
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    `;
                    break;
                case 'info':
                    iconSvg.innerHTML = `
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="16" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                    `;
                    break;
                case 'warning':
                    iconSvg.innerHTML = `
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                        <line x1="12" y1="9" x2="12" y2="13"></line>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    `;
                    break;
                case 'danger':
                default:
                    iconSvg.innerHTML = `
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                    `;
                    break;
            }
        }
    }
    
    // Promise'i yalnÄ±zca bir kez resolve etmek iÃ§in flag
    let resolved = false;
    
    function handleYesClick() {
        if (resolved) return;
        resolved = true;
        console.log("âœ… Modal EVET butonuna tÄ±klandÄ±");
            modal.classList.remove('active');
            setTimeout(() => modal.style.display = 'none', 300);
            resolve(true);
    }
    
    function handleNoClick() {
        if (resolved) return;
        resolved = true;
        console.log("âŒ Modal Ä°PTAL butonuna tÄ±klandÄ±");
            modal.classList.remove('active');
            setTimeout(() => modal.style.display = 'none', 300);
            resolve(false);
    }

    // Event listener'larÄ± temizle ve yenilerini ekle
    yesButton.onclick = null;
    noButton.onclick = null;
    yesButton.onclick = handleYesClick;
    noButton.onclick = handleNoClick;
    
    console.log("ğŸ”§ Buton event handler'larÄ± eklendi");
    
    // Close button'larÄ± da handle et
    const closeButtons = modal.querySelectorAll('.modern-close');
    closeButtons.forEach(button => {
        button.onclick = null;
        button.onclick = handleNoClick;
    });
    
    // Modal dÄ±ÅŸÄ±na tÄ±klamayÄ± handle et
    modal.onclick = null;
    modal.onclick = (e) => {
        if (e.target === modal) {
            handleNoClick();
        }
    };
    
    // ModalÄ± gÃ¶ster
        console.log("ğŸ­ Modal gÃ¶steriliyor...");
    modal.style.display = 'flex';
        // CSS animasyonlarÄ± iÃ§in active sÄ±nÄ±fÄ±nÄ± ekle
        setTimeout(() => {
            modal.classList.add('active');
            console.log("âœ… Modal active sÄ±nÄ±fÄ± eklendi");
        }, 10);
    });
}

/**
 * Modern toast bildirimi gÃ¶sterme
 * @param {string} message - Bildirim mesajÄ±
 * @param {string} type - Bildirim tipi (success, error, warning, info)
 * @param {number} duration - GÃ¶rÃ¼nme sÃ¼resi (ms)
 */
function showModernToast(message, type = 'success', duration = 4000) {
    const toast = document.getElementById('modernToast');
    const messageElement = document.getElementById('modernToastMessage');
    const iconElement = toast.querySelector('.modern-toast-icon');
    const progressBar = toast.querySelector('.modern-toast-progress-bar');
    
    // MesajÄ± ayarla
    messageElement.textContent = message;
    
    // Ä°kon ve renk sÄ±nÄ±flarÄ±nÄ± temizle
    iconElement.classList.remove('success', 'error', 'warning', 'info');
    
    // Ä°kon ve renk ayarla
    switch(type) {
        case 'error':
            iconElement.classList.add('error');
            iconElement.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>';
            progressBar.style.backgroundColor = 'var(--danger-color)';
            break;
        case 'warning':
            iconElement.classList.add('warning');
            iconElement.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>';
            progressBar.style.backgroundColor = 'var(--warning-color)';
            break;
        case 'info':
            iconElement.classList.add('info');
            iconElement.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>';
            progressBar.style.backgroundColor = 'var(--info-color)';
            break;
        default: // success
            iconElement.classList.add('success');
            iconElement.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>';
            progressBar.style.backgroundColor = 'var(--success-color)';
    }
    
    // Animasyon sÃ¼resini ayarla
    progressBar.style.animation = `progressShrink ${duration/1000}s linear forwards`;
    
    // ToastÄ± gÃ¶ster
    toast.style.display = 'block';
    
    // Belirtilen sÃ¼re sonra kapat
    const toastTimeout = setTimeout(() => {
        toast.style.display = 'none';
    }, duration);
    
    // Kapatma butonuna tÄ±klandÄ±ÄŸÄ±nda
    toast.querySelector('.modern-toast-close').onclick = function() {
        clearTimeout(toastTimeout);
        toast.style.display = 'none';
    };
}

/**
 * Modern modal aÃ§ma
 * @param {string} modalId - Modal element ID'si
 */
function openModernModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('active'), 10);
        
        // Close butonlarÄ± iÃ§in event listener ekle
        modal.querySelectorAll('.modern-close').forEach(closeBtn => {
            closeBtn.onclick = () => closeModernModal(modalId);
        });
        
        // Modal dÄ±ÅŸÄ±na tÄ±klama ile kapatma
        modal.onclick = function(e) {
            if (e.target === modal) {
                closeModernModal(modalId);
            }
        };
        
        // Escape tuÅŸu ile kapatma
        const escapeHandler = (e) => {
            if (e.key === 'Escape') {
                closeModernModal(modalId);
                document.removeEventListener('keydown', escapeHandler);
            }
        };
        document.addEventListener('keydown', escapeHandler);
    }
}

/**
 * Modern modal kapatma
 * @param {string} modalId - Modal element ID'si
 */
function closeModernModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('active');
        setTimeout(() => {
        modal.style.display = 'none';
            // Event listener'larÄ± temizle
            modal.onclick = null;
        }, 300);
    }
}

/**
 * Silme onay modalÄ±nÄ± gÃ¶sterme
 * @param {Function} confirmCallback - Onay verildiÄŸinde Ã§alÄ±ÅŸacak fonksiyon
 * @param {string} message - GÃ¶sterilecek mesaj
 */
function showDeleteConfirmModal(confirmCallback, message = 'Bu Ã¶ÄŸeyi silmek istediÄŸinizden emin misiniz?') {
    // Modern confirm sistemini kullan
    showModernConfirm(
        'Etkinlik Silme OnayÄ±',
        message,
        {
            confirmText: 'Evet, Sil',
            cancelText: 'Ä°ptal',
            headerClass: 'danger-action',
            iconClass: 'danger'
        }
    ).then(confirmed => {
        if (confirmed && typeof confirmCallback === 'function') {
            confirmCallback();
        }
    });
}

/**
 * Puan daÄŸÄ±tÄ±m modalÄ±nÄ± gÃ¶sterme
 * @param {Object} parentNode - Ana dÃ¼ÄŸÃ¼m
 * @param {number} totalWeight - Mevcut toplam aÄŸÄ±rlÄ±k
 */
function showDistributePointsModal(parentNode, totalWeight) {
    const modal = document.getElementById('distributePointsModal');
    const totalWeightElement = document.getElementById('currentTotalWeight');
    const confirmButton = document.getElementById('confirmDistributeBtn');
    const totalPointsInput = document.getElementById('totalPointsInput');
    const equalOption = document.getElementById('equalOption');
    const randomOption = document.getElementById('randomOption');
    
    let selectedDistribution = null;
    
    // Toplam aÄŸÄ±rlÄ±ÄŸÄ± gÃ¶ster
    totalWeightElement.textContent = totalWeight;
    
    // SeÃ§im yapÄ±lana kadar onay butonunu devre dÄ±ÅŸÄ± bÄ±rak
    confirmButton.disabled = true;
    
    // DaÄŸÄ±tÄ±m seÃ§eneklerine tÄ±klandÄ±ÄŸÄ±nda
    equalOption.onclick = function() {
        equalOption.classList.add('selected');
        randomOption.classList.remove('selected');
        selectedDistribution = 'equal';
        confirmButton.disabled = false;
    };
    
    randomOption.onclick = function() {
        randomOption.classList.add('selected');
        equalOption.classList.remove('selected');
        selectedDistribution = 'random';
        confirmButton.disabled = false;
    };
    
    // Onay butonuna tÄ±klandÄ±ÄŸÄ±nda
    confirmButton.onclick = function() {
        const totalPoints = parseInt(totalPointsInput.value) || 100;
        
        if (selectedDistribution === 'equal') {
            distributePointsEqually(parentNode, totalPoints);
            showModernToast(`Puanlar ${parentNode.name} etkinliÄŸine eÅŸit olarak daÄŸÄ±tÄ±ldÄ±.`, 'success');
        } else if (selectedDistribution === 'random') {
            distributePointsRandomly(parentNode, totalPoints);
            showModernToast(`Puanlar ${parentNode.name} etkinliÄŸine rastgele daÄŸÄ±tÄ±ldÄ±.`, 'success');
        }
        
        // ModalÄ± kapat
        closeModernModal('distributePointsModal');
        
        // AÄŸacÄ± yeniden render et
        renderTree();
        
        // DeÄŸerlendirme sekmesini gÃ¼ncelle
        updateAssessmentView();
    };
    
    // ModalÄ± gÃ¶ster
    openModernModal('distributePointsModal');
    
    // SeÃ§imleri sÄ±fÄ±rla
    equalOption.classList.remove('selected');
    randomOption.classList.remove('selected');
}

/**
 * Test skoru daÄŸÄ±tÄ±m modalÄ±nÄ± gÃ¶sterme
 * @param {string} studentId - Ã–ÄŸrenci ID'si
 * @param {string} testId - Test ID'si
 */
function showTestScoreDistributionModal(studentId, testId) {
    const modal = document.getElementById('testScoreDistributionModal');
    const testNode = findNodeById(testId);
    const student = APP_STATE.studentData.find(s => s.studentId === studentId);
    
    if (!testNode || !student) {
        showModernToast("Test veya Ã¶ÄŸrenci bilgisi bulunamadÄ±!", "error");
        return;
    }
    
    // Test bilgilerini ayarla
    document.getElementById('testStudentName').textContent = `${student.name} ${student.surname} (${studentId})`;
    document.getElementById('testName').textContent = testNode.name;
    document.getElementById('testTotalQuestions').textContent = testNode.testDetails.totalQuestions;
    
    const totalQuestions = testNode.testDetails.totalQuestions;
    const correctWeight = testNode.testDetails.correctWeight;
    const wrongPenalty = Math.abs(testNode.testDetails.wrongPenalty);
    
    // Slider'larÄ± ayarla
    const correctSlider = document.getElementById('testCorrectSlider');
    const wrongSlider = document.getElementById('testWrongSlider');
    correctSlider.max = totalQuestions;
    wrongSlider.max = totalQuestions;
    
    // Mevcut deÄŸerleri al
    let correct = 0;
    let wrong = 0;
    
    // Ã–ÄŸrencinin mevcut test verilerini kontrol et
    if (APP_STATE.gradesData[studentId] && APP_STATE.gradesData[studentId][testId]) {
        const testData = APP_STATE.gradesData[studentId][testId];
        if (testData.tip === 'test' || testData.type === 'test') {
            correct = testData.dogru || testData.correct || 0;
            wrong = testData.yanlis || testData.wrong || 0;
        }
    }
    
    // Slider ve deÄŸerleri gÃ¼ncelle
    correctSlider.value = correct;
    wrongSlider.value = wrong;
    updateTestDistributionPreview(correct, wrong, totalQuestions, correctWeight, wrongPenalty);
    
    // Slider olaylarÄ±
    correctSlider.oninput = function() {
        const correctValue = parseInt(this.value);
        const wrongValue = parseInt(wrongSlider.value);
        
        // Toplam soru sayÄ±sÄ±nÄ± kontrol et
        if (correctValue + wrongValue > totalQuestions) {
            wrongSlider.value = totalQuestions - correctValue;
            wrong = totalQuestions - correctValue;
        }
        
        correct = correctValue;
        updateTestDistributionPreview(correct, wrong, totalQuestions, correctWeight, wrongPenalty);
    };
    
    wrongSlider.oninput = function() {
        const wrongValue = parseInt(this.value);
        const correctValue = parseInt(correctSlider.value);
        
        // Toplam soru sayÄ±sÄ±nÄ± kontrol et
        if (correctValue + wrongValue > totalQuestions) {
            correctSlider.value = totalQuestions - wrongValue;
            correct = totalQuestions - wrongValue;
        }
        
        wrong = wrongValue;
        updateTestDistributionPreview(correct, wrong, totalQuestions, correctWeight, wrongPenalty);
    };
    
    // Rastgele daÄŸÄ±t butonu
    document.getElementById('randomizeTestDistribution').onclick = function() {
        // Rastgele doÄŸru sayÄ±sÄ± Ã¼ret
        const randomCorrect = Math.floor(Math.random() * (totalQuestions + 1));
        
        // Rastgele yanlÄ±ÅŸ sayÄ±sÄ± Ã¼ret (toplam soruyu geÃ§meyecek ÅŸekilde)
        const maxWrong = totalQuestions - randomCorrect;
        const randomWrong = Math.floor(Math.random() * (maxWrong + 1));
        
        // DeÄŸerleri gÃ¼ncelle
        correctSlider.value = randomCorrect;
        wrongSlider.value = randomWrong;
        correct = randomCorrect;
        wrong = randomWrong;
        
        updateTestDistributionPreview(correct, wrong, totalQuestions, correctWeight, wrongPenalty);
    };
    
    // Uygula butonu
    document.getElementById('applyTestDistribution').onclick = function() {
        // Test skorunu kaydet
        saveTestDistribution(studentId, testId, correct, wrong);
        
        // ModalÄ± kapat
        closeModernModal('testScoreDistributionModal');
        
        showModernToast(`${student.name} ${student.surname} iÃ§in test puanÄ± gÃ¼ncellendi.`, "success");
    };
    
    // ModalÄ± gÃ¶ster
    openModernModal('testScoreDistributionModal');
}

/**
 * Test daÄŸÄ±lÄ±m Ã¶nizlemesini gÃ¼ncelleme
 */
function updateTestDistributionPreview(correct, wrong, totalQuestions, correctWeight, wrongPenalty) {
    document.getElementById('testCorrectValue').textContent = correct;
    document.getElementById('testWrongValue').textContent = wrong;
    
    const empty = totalQuestions - correct - wrong;
    document.getElementById('testEmptyValue').textContent = empty;
    
    // Toplam puanÄ± hesapla
    const totalScore = (correct * correctWeight) - (wrong * wrongPenalty);
    document.getElementById('testTotalScore').textContent = totalScore.toFixed(2);
    
    // DaÄŸÄ±lÄ±m Ã¶nizlemesini gÃ¼ncelle
    const previewElement = document.getElementById('distributionPreview');
    previewElement.innerHTML = '';
    
    // DoÄŸru oranÄ±
    if (correct > 0) {
        const correctBlock = document.createElement('div');
        correctBlock.className = 'question-block question-correct';
        correctBlock.style.width = `${(correct / totalQuestions) * 100}%`;
        previewElement.appendChild(correctBlock);
    }
    
    // YanlÄ±ÅŸ oranÄ±
    if (wrong > 0) {
        const wrongBlock = document.createElement('div');
        wrongBlock.className = 'question-block question-wrong';
        wrongBlock.style.width = `${(wrong / totalQuestions) * 100}%`;
        previewElement.appendChild(wrongBlock);
    }
    
    // BoÅŸ oranÄ±
    if (empty > 0) {
        const emptyBlock = document.createElement('div');
        emptyBlock.className = 'question-block question-empty';
        emptyBlock.style.width = `${(empty / totalQuestions) * 100}%`;
        previewElement.appendChild(emptyBlock);
    }
}

/**
 * Test daÄŸÄ±lÄ±mÄ±nÄ± kaydetme
 */
function saveTestDistribution(studentId, testId, correct, wrong) {
    // Ã–ÄŸrenci verisi oluÅŸtur
    if (!APP_STATE.gradesData[studentId]) {
        APP_STATE.gradesData[studentId] = {};
    }
    
    // Test verisini kaydet
    APP_STATE.gradesData[studentId][testId] = {
        tip: 'test',
        type: 'test',
        dogru: correct,
        correct: correct,
        yanlis: wrong,
        wrong: wrong
    };
    
    // Alt dÃ¼ÄŸÃ¼m yapÄ±sÄ±nÄ± oluÅŸtur (gerekiyorsa)
    const parts = testId.split('.');
    if (parts.length > 1) {
        const parentId = parts[0]; // Ã–rneÄŸin: A1
        const shortId = parts[parts.length - 1]; // Ã–rneÄŸin: 1
        
        // EÄŸer Ã¼st aktivite yoksa oluÅŸtur
        if (!APP_STATE.gradesData[studentId][parentId]) {
            APP_STATE.gradesData[studentId][parentId] = {
                toplam: 0
            };
        }
        
        // KÄ±sa kod da ekle
        APP_STATE.gradesData[studentId][parentId][shortId] = {
            tip: 'test',
            type: 'test',
            dogru: correct,
            correct: correct,
            yanlis: wrong,
            wrong: wrong
        };
        
        // Alt yapÄ±ya da ekle
        APP_STATE.gradesData[studentId][parentId][testId] = {
            tip: 'test',
            type: 'test',
            dogru: correct,
            correct: correct,
            yanlis: wrong,
            wrong: wrong
        };
        
        // Toplama hesapla
        updateParentActivityTotal(studentId, parentId);
    }
    
    // DeÄŸerlendirme sekmesini gÃ¼ncelle
    updateAssessmentView();
    
    // NotlarÄ± yeniden hesapla
    updateStudentCalculatedGrade(studentId);
    
    // Ã–ÄŸrenci gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ gÃ¼ncelle
    updateStudentViewTestTotal(studentId, testId);
}

// Modal kapatma dÃ¼ÄŸmelerini ayarla
document.addEventListener('DOMContentLoaded', function() {
    // TÃ¼m modern kapatma butonlarÄ±na tÄ±klama olayÄ± ekle
    document.querySelectorAll('.modern-close').forEach(button => {
        button.addEventListener('click', function() {
            // En yakÄ±n modal elementini bul
            const modal = this.closest('.modern-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        });
    });
    
    // Modal dÄ±ÅŸÄ±na tÄ±klanÄ±nca kapatma
    document.querySelectorAll('.modern-modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });
    });
});

// =====================================================
// GRUP YÃ–NETÄ°MÄ° FONKSÄ°YONLARI
// =====================================================

/**
 * Grup sistemini baÅŸlatma
 */
function initializeGroupSystem() {
    // EÄŸer grup haritalama yoksa varsayÄ±lan oluÅŸtur
    if (!APP_STATE.courseData) {
        APP_STATE.courseData = {};
    }
    
    if (!APP_STATE.courseData.grupHaritalari) {
        APP_STATE.courseData.grupHaritalari = {};
    }
    
    // Her zaman en az bir grup olmasÄ±nÄ± garanti et
    ensureDefaultGroupExists();
    
    // Ã–ÄŸrencilere grup atanmamÄ±ÅŸsa A grubu ata
    if (APP_STATE.studentData && APP_STATE.studentData.length > 0) {
        APP_STATE.studentData.forEach(student => {
            if (!student.grup) {
                student.grup = "A";
            }
        });
    }
    
    // Sorular iÃ§in otomatik 1:1 haritalama oluÅŸtur (her parent activity kendi iÃ§inde)
    createDefaultMapping();
    
    // Grup haritalama verilerini debug et
    console.log('ğŸ“Š Grup haritalama durumu:', APP_STATE.courseData?.grupHaritalari);
    
    // TÃ¼m ilgili UI'larÄ± gÃ¼ncelle
    updateGroupSelectors();
    updateAllInlineGroupInputs();
}

/**
 * Her deÄŸerlendirme bileÅŸeni iÃ§in varsayÄ±lan A grubunun var olmasÄ±nÄ± garanti eder
 * A GRUBU HER ZAMAN MEVCUT OLMALI - Bu sistem kuralÄ±dÄ±r
 */
function ensureDefaultGroupExists() {
    console.log(`ğŸ”§ ensureDefaultGroupExists Ã§alÄ±ÅŸÄ±yor...`);
    
    // Ana deÄŸerlendirme bileÅŸenlerini bul
    const mainComponents = APP_STATE.assessmentTree.filter(node => 
        node.id.startsWith('A') || node.id.startsWith('F')
    );
    
    console.log(`ğŸ“‹ ${mainComponents.length} ana bileÅŸen bulundu:`, mainComponents.map(c => c.id));
    
    mainComponents.forEach(component => {
        console.log(`\nğŸ” ${component.id} bileÅŸeni kontrol ediliyor...`);
        
        if (!APP_STATE.courseData.grupHaritalari[component.id]) {
            // HiÃ§ grup yapÄ±sÄ± yoksa oluÅŸtur
            APP_STATE.courseData.grupHaritalari[component.id] = {
                gruplar: ["A"],
                haritalar: {
                    "A": {}
                }
            };
            console.log(`âœ… ${component.id}: Yeni grup yapÄ±sÄ± oluÅŸturuldu (A grubu)`);
        } else {
            // Mevcut bileÅŸeni kontrol et ve dÃ¼zelt
            const existingComponent = APP_STATE.courseData.grupHaritalari[component.id];
            let needsUpdate = false;
            
            // Grup listesi kontrolÃ¼
            if (!existingComponent.gruplar || existingComponent.gruplar.length === 0) {
                existingComponent.gruplar = ["A"];
                needsUpdate = true;
                console.log(`ğŸ”§ ${component.id}: Grup listesi dÃ¼zeltildi (A grubu eklendi)`);
            } else if (!existingComponent.gruplar.includes("A")) {
                // A grubu listede yoksa baÅŸa ekle
                existingComponent.gruplar.unshift("A");
                needsUpdate = true;
                console.log(`ğŸ”§ ${component.id}: A grubu listeye eklendi`);
            }
            
            // Mapping yapÄ±sÄ± kontrolÃ¼
            if (!existingComponent.haritalar) {
                existingComponent.haritalar = {};
                needsUpdate = true;
                console.log(`ğŸ”§ ${component.id}: Mapping yapÄ±sÄ± oluÅŸturuldu`);
            }
            
            if (!existingComponent.haritalar["A"]) {
                existingComponent.haritalar["A"] = {};
                needsUpdate = true;
                console.log(`ğŸ”§ ${component.id}: A grubu mapping'i oluÅŸturuldu`);
            }
            
            if (needsUpdate) {
                console.log(`âœ… ${component.id}: Grup yapÄ±sÄ± gÃ¼ncellendi`);
            } else {
                console.log(`âœ… ${component.id}: Grup yapÄ±sÄ± zaten uygun`);
            }
        }
        
        // Son kontrol
        const finalCheck = APP_STATE.courseData.grupHaritalari[component.id];
        console.log(`ğŸ“Š ${component.id} final durum:`, {
            gruplar: finalCheck.gruplar,
            mappingKeys: Object.keys(finalCheck.haritalar || {}),
            hasAGroup: finalCheck.gruplar?.includes("A"),
            hasAMapping: !!finalCheck.haritalar?.["A"]
        });
    });
    
    console.log(`âœ… ensureDefaultGroupExists tamamlandÄ± - TÃ¼m bileÅŸenlerde A grubu garantili`);
}

/**
 * YarÄ±yÄ±l iÃ§i aÄŸÄ±rlÄ±ÄŸÄ±nÄ± getir
 */
function getTermWeight() {
    return APP_STATE.termWeight || 40;
}

/**
 * YarÄ±yÄ±l sonu aÄŸÄ±rlÄ±ÄŸÄ±nÄ± getir
 */
function getFinalWeight() {
    return APP_STATE.finalWeight || 60;
}

/**
 * Belirli bir deÄŸerlendirmenin aÄŸÄ±rlÄ±ÄŸÄ±nÄ± getir
 * @param {string} activityId - Aktivite ID'si
 * @returns {number} - AÄŸÄ±rlÄ±k yÃ¼zdesi
 */
function getAssessmentWeight(activityId) {
    try {
        const activity = findNodeById(activityId);
        if (!activity) return 0;
        
        // Ana bileÅŸen mi yoksa alt bileÅŸen mi kontrol et
        if (activity.id.startsWith('A')) {
            // YarÄ±yÄ±l iÃ§i deÄŸerlendirme
            return activity.weight || 0;
        } else if (activity.id.startsWith('F')) {
            // YarÄ±yÄ±l sonu deÄŸerlendirme
            return activity.weight || 0;
        }
        
        // Alt bileÅŸen ise, Ã¼st bileÅŸenin aÄŸÄ±rlÄ±ÄŸÄ±nÄ± al
        const parentId = getParentComponentId(activityId);
        if (parentId) {
            const parentActivity = findNodeById(parentId);
            return parentActivity?.weight || 0;
        }
        
        return 0;
    } catch (error) {
        console.error("DeÄŸerlendirme aÄŸÄ±rlÄ±ÄŸÄ± alÄ±nÄ±rken hata:", error);
        return 0;
    }
}

/**
 * VarsayÄ±lan 1:1 haritalama oluÅŸturma - Her deÄŸerlendirme bileÅŸeni iÃ§in ayrÄ± grup sistemi
 */
function createDefaultMapping() {
    // Grup haritalama yapÄ±sÄ±nÄ± baÅŸlat
    if (!APP_STATE.courseData.grupHaritalari) {
        APP_STATE.courseData.grupHaritalari = {};
    }
    
    // Her ana deÄŸerlendirme bileÅŸeni iÃ§in ayrÄ± grup sistemi oluÅŸtur
    APP_STATE.assessmentTree.forEach(parentNode => {
        // TÃ¼m ana bileÅŸenler iÃ§in grup yapÄ±sÄ± oluÅŸtur (soru/rubrik olsun olmasÄ±n)
        if (!APP_STATE.courseData.grupHaritalari[parentNode.id]) {
            APP_STATE.courseData.grupHaritalari[parentNode.id] = {
                gruplar: ["A"], // VarsayÄ±lan olarak sadece A grubu
                haritalar: {
                    "A": {}
                }
            };
        }
        
        // EÄŸer alt sorularÄ± varsa haritalama oluÅŸtur
        if (parentNode.children && parentNode.children.length > 0) {
            let questionIndex = 1;
            parentNode.children.forEach(childNode => {
                if (isQuestionType(childNode.type) || isRubricType(childNode.type)) {
                    // A grubu iÃ§in varsayÄ±lan 1:1 haritalama
                    APP_STATE.courseData.grupHaritalari[parentNode.id].haritalar.A[childNode.id] = questionIndex.toString();
                    questionIndex++;
                }
            });
        }
        // EÄŸer alt sorularÄ± yoksa (Laboratuvar gibi), haritalama gerekmez
        // Sadece grup yapÄ±sÄ± yeterli
    });
    
    // TÃ¼m Ã¶ÄŸrencileri A grubuna ata (grup bilgisi yoksa)
    if (APP_STATE.studentData && APP_STATE.studentData.length > 0) {
        APP_STATE.studentData.forEach(student => {
            if (!student.grup) {
                student.grup = 'A';
            }
        });
    }
}

/**
 * Mevcut haritalamayÄ± temizleyip yeniden oluÅŸturma
 */
function recreateDefaultMapping() {
    // TÃ¼m deÄŸerlendirme bileÅŸenleri iÃ§in haritalamayÄ± temizle
    APP_STATE.courseData.grupHaritalari = {};
    
    // Yeniden oluÅŸtur
    createDefaultMapping();
    
    // UI'larÄ± gÃ¼ncelle
    updateAllInlineGroupInputs();
    updateGroupMappingColors();
    updateAllMappingDisplays();
    
    showModernToast("Grup haritalamalar dÃ¼zeltildi - her deÄŸerlendirme bileÅŸeni kendi grup sistemine sahip", "success");
}

/**
 * TÃ¼m sorularÄ± toplama
 */
function getAllQuestions() {
    const questions = [];
    
    function collectQuestions(nodes) {
        nodes.forEach(node => {
            if (isQuestionType(node.type) || isRubricType(node.type)) {
                questions.push({
                    id: node.id,
                    name: node.name,
                    type: node.type
                });
            }
            if (node.children && node.children.length > 0) {
                collectQuestions(node.children);
            }
        });
    }
    
    collectQuestions(APP_STATE.assessmentTree);
    return questions;
}

/**
 * Belirli bir deÄŸerlendirme bileÅŸenine yeni grup ekleme
 */
async function addNewGroupToComponent(componentId) {
    const groupNames = ['B', 'C', 'D', 'E', 'F', 'G', 'H'];
    const component = APP_STATE.courseData.grupHaritalari[componentId];
    
    if (!component) {
        showModernToast("DeÄŸerlendirme bileÅŸeni bulunamadÄ±", "error");
        return;
    }
    
    const existingGroups = component.gruplar || [];
    const newGroupName = groupNames.find(name => !existingGroups.includes(name));
    
    if (!newGroupName) {
        showModernToast("Bu bileÅŸen iÃ§in maksimum grup sayÄ±sÄ±na ulaÅŸÄ±ldÄ±", "warning");
        return;
    }
    
    // Modern confirm dialog ile onay al
    const confirmed = await showModernConfirm(
        'Grup Ekleme OnayÄ±',
        `${getComponentDisplayName(componentId)} bileÅŸenine grup ${newGroupName} eklemek istediÄŸinizden emin misiniz?`,
        {
            confirmText: 'Evet, Ekle',
            cancelText: 'Ä°ptal',
            headerClass: 'success-action',
            iconClass: 'success'
        }
    );
    
    if (!confirmed) {
        return;
    }
    
        // Yeni grubu listeye ekle
        component.gruplar.push(newGroupName);
        
        // A grubunun kopyasÄ± olarak mapping oluÅŸtur (derin kopya)
        const groupAMapping = component.haritalar.A || {};
        component.haritalar[newGroupName] = JSON.parse(JSON.stringify(groupAMapping));
        
        // EÄŸer A grubunda mapping yoksa, varsayÄ±lan 1:1 mapping oluÅŸtur
        if (Object.keys(groupAMapping).length === 0) {
            const componentNode = findNodeById(componentId);
            if (componentNode && componentNode.children) {
                let questionIndex = 1;
                componentNode.children.forEach(childNode => {
                    if (isQuestionType(childNode.type) || isRubricType(childNode.type)) {
                        // DÃœZELTME: Veri yapÄ±sÄ± {position: questionId} formatÄ±nda
                        component.haritalar.A[questionIndex.toString()] = childNode.id;
                        component.haritalar[newGroupName][questionIndex.toString()] = childNode.id;
                        questionIndex++;
                    }
                });
            }
        }
        
        // UI'larÄ± gÃ¼ncelle
        updateGroupSelectors();
        updateStudentTable();
        updateAssessmentView();
        updateAllInlineGroupInputs();
        updateAllMappingDisplays();
        updateGroupMappingColors();
        
        // Grup sayÄ±sÄ±nÄ± gÃ¼ncelle
        updateComponentGroupCounts();
        
        // Modal'Ä± gÃ¼ncelle (eÄŸer aÃ§Ä±ksa)
        updateComponentGroupList(componentId);
        
        // Ders tanÄ±mlama sayfasÄ±ndaki grup bilgilerini gÃ¼ncelle
        updateComponentGroupInfo(componentId);
        
        showModernToast(`${getComponentDisplayName(componentId)} bileÅŸenine grup ${newGroupName} eklendi`, "success");
}

/**
 * TÃ¼m deÄŸerlendirme bileÅŸenlerine yeni grup ekleme (eski davranÄ±ÅŸ iÃ§in)
 */
function addNewGroup() {
    const groupNames = ['B', 'C', 'D', 'E', 'F', 'G', 'H'];
    let addedToAny = false;
    
    // Her deÄŸerlendirme bileÅŸenine grup ekle
    Object.keys(APP_STATE.courseData.grupHaritalari || {}).forEach(componentId => {
        const component = APP_STATE.courseData.grupHaritalari[componentId];
        const existingGroups = component.gruplar || [];
        const newGroupName = groupNames.find(name => !existingGroups.includes(name));
        
        if (newGroupName) {
            component.gruplar.push(newGroupName);
            const groupAMapping = component.haritalar.A || {};
            component.haritalar[newGroupName] = {...groupAMapping};
            addedToAny = true;
        }
    });
    
    if (addedToAny) {
        // UI'larÄ± gÃ¼ncelle
        updateGroupSelectors();
        updateStudentTable();
        updateAssessmentView();
        updateAllInlineGroupInputs();
        updateAllMappingDisplays();
        updateGroupMappingColors();
        
        showModernToast("TÃ¼m deÄŸerlendirme bileÅŸenlerine yeni grup eklendi", "success");
    } else {
        showModernToast("Maksimum grup sayÄ±sÄ±na ulaÅŸÄ±ldÄ±", "warning");
    }
}

/**
 * Belirli bir deÄŸerlendirme bileÅŸeninden grup silme
 */
async function deleteGroupFromComponent(componentId, groupName) {
    const component = APP_STATE.courseData.grupHaritalari[componentId];
    
    if (!component || groupName === 'A') {
        showModernToast("A grubu silinemez", "warning");
        return;
    }
    
    if (!component.gruplar.includes(groupName)) {
        showModernToast("Grup bulunamadÄ±", "warning");
        return;
    }
    
    // Modern confirm dialog ile onay al
    const confirmed = await showModernConfirm(
        'Grup Silme OnayÄ±',
        `${getComponentDisplayName(componentId)} bileÅŸeninden grup ${groupName}'Ä± silmek istediÄŸinizden emin misiniz?`,
        {
            confirmText: 'Evet, Sil',
            cancelText: 'Ä°ptal',
            headerClass: 'danger-action',
            iconClass: 'danger'
        }
    );
    
    if (!confirmed) {
        return;
    }
    
            // Grubu listeden Ã§Ä±kar
            component.gruplar = component.gruplar.filter(g => g !== groupName);
            
            // Mapping'i sil
            delete component.haritalar[groupName];
            
            // Bu gruptaki Ã¶ÄŸrencileri A grubuna taÅŸÄ± (sadece bu bileÅŸen iÃ§in)
            // Not: Ã–ÄŸrenci grup atamasÄ± global olduÄŸu iÃ§in dikkatli olmalÄ±yÄ±z
            
            // UI'larÄ± gÃ¼ncelle
            updateGroupSelectors();
            updateStudentTable();
            updateAssessmentView();
            updateAllInlineGroupInputs();
            updateAllMappingDisplays();
            updateGroupMappingColors();
            
            // Grup sayÄ±sÄ±nÄ± gÃ¼ncelle
            updateComponentGroupCounts();
            
            // Modal'Ä± gÃ¼ncelle (eÄŸer aÃ§Ä±ksa)
            updateComponentGroupList(componentId);
            
            // TÃ¼m UI'larÄ± gÃ¼ncelle
            updateAllInlineGroupInputs();
            updateGroupSelectors();
            updateAssessmentView();
            
            showModernToast(`${getComponentDisplayName(componentId)} bileÅŸeninden grup ${groupName} silindi`, "success");
}

/**
 * BileÅŸen grup yÃ¶netimi modalÄ± gÃ¶sterme
 */
function showComponentGroupManagementModal(componentId) {
    const component = APP_STATE.courseData.grupHaritalari[componentId];
    if (!component) {
        showModernToast("DeÄŸerlendirme bileÅŸeni bulunamadÄ±", "error");
        return;
    }
    
    const groups = component.gruplar || ['A'];
    const totalQuestions = countQuestionsInComponent(componentId);
    
    // Modal body iÃ§eriÄŸi oluÅŸtur
    const modalBodyContent = `
        <div class="component-summary">
            <div class="summary-item">
                <span class="summary-label">Toplam Soru:</span>
                <span class="summary-value">${totalQuestions}</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Mevcut Grup SayÄ±sÄ±:</span>
                <span class="summary-value">${groups.length}</span>
            </div>
        </div>
        
        <div class="groups-container">
            <h4>Gruplar ve DurumlarÄ±:</h4>
            <div class="groups-grid">
                ${groups.map(group => {
                    // DÃœZELTME: Sadece bu bileÅŸendeki sorularÄ±n eÅŸleÅŸtirme durumunu kontrol et
                    const componentQuestionCount = getComponentSpecificQuestionMappingCount(componentId, group);
                    const isComplete = componentQuestionCount === totalQuestions;
                    return `
                        <div class="group-card ${isComplete ? 'complete' : 'incomplete'}">
                            <div class="group-header">
                                <span class="group-name">Grup ${group}</span>
                                ${group !== 'A' ? `
                                    <button class="btn-delete-group" data-component-id="${componentId}" data-group="${group}" title="Grubu Sil">
                                        Ã—
                                    </button>
                                ` : '<span class="default-badge">VarsayÄ±lan</span>'}
                            </div>
                            <div class="group-stats">
                                <span class="mapped-count">${componentQuestionCount}/${totalQuestions} soru eÅŸleÅŸtirildi</span>
                                <span class="status-badge ${isComplete ? 'complete' : 'incomplete'}">
                                    ${isComplete ? 'TamamlandÄ±' : 'Eksik'}
                                </span>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
        
        <div class="group-actions">
            <button class="btn btn-success" id="addNewGroupBtn" data-component-id="${componentId}">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <line x1="19" y1="8" x2="19" y2="14"/>
                    <line x1="22" y1="11" x2="16" y2="11"/>
                </svg>
                Yeni Grup Ekle
            </button>
        </div>
    `;
    
    // Modal body'yi gÃ¼ncelle
    const modalBody = document.getElementById('componentGroupModalBody');
    if (modalBody) {
        modalBody.innerHTML = modalBodyContent;
        
        // Modal baÅŸlÄ±ÄŸÄ±nÄ± gÃ¼ncelle
        const modalHeader = document.querySelector('#componentGroupManagementModal .modern-modal-header h2');
        if (modalHeader) {
            modalHeader.textContent = `${componentId} BileÅŸeni - Grup Ekle/Ã‡Ä±kar`;
        }
        
        // Event listener'larÄ± ekle
        setupComponentGroupModalEvents(componentId);
        
        // Modal'Ä± gÃ¶ster
        openModernModal('componentGroupManagementModal');
    }
}

/**
 * Belirli bir bileÅŸen ve grup iÃ§in eÅŸleÅŸtirilmiÅŸ soru sayÄ±sÄ±nÄ± hesaplama
 */
function getComponentSpecificQuestionMappingCount(componentId, groupId) {
    const component = APP_STATE.courseData.grupHaritalari[componentId];
    if (!component || !component.haritalar || !component.haritalar[groupId]) {
        return 0;
    }
    
    // Bu bileÅŸendeki tÃ¼m sorularÄ± bul
    const componentNode = findNodeById(componentId);
    if (!componentNode || !componentNode.children) {
        return 0;
    }
    
    const componentQuestionIds = [];
    componentNode.children.forEach(child => {
        if (isQuestionType(child.type) || isRubricType(child.type)) {
            componentQuestionIds.push(child.id);
        }
    });
    
    // Bu bileÅŸendeki sorulardan kaÃ§ tanesi bu grupta eÅŸleÅŸtirilmiÅŸ
    let mappedCount = 0;
    const groupMappings = component.haritalar[groupId];
    
    componentQuestionIds.forEach(questionId => {
        // DÃœZELTME: Veri yapÄ±sÄ± {position: questionId} formatÄ±nda, {questionId: position} deÄŸil
        // Bu yÃ¼zden Object.values() ile questionId'leri kontrol etmeliyiz
        const isQuestionMapped = Object.values(groupMappings).includes(questionId);
        
        if (isQuestionMapped) {
            mappedCount++;
        }
    });
    
    return mappedCount;
}

/**
 * BileÅŸen grup modalÄ± event listener'larÄ±nÄ± kurma
 */
function setupComponentGroupModalEvents(componentId) {
    // Grup silme butonlarÄ±
    document.querySelectorAll('#componentGroupManagementModal .btn-delete-group').forEach(btn => {
        btn.addEventListener('click', function() {
            const groupName = this.dataset.group;
            const compId = this.dataset.componentId;
            deleteGroupFromComponent(compId, groupName);
        });
    });
    
    // Yeni grup ekleme butonu
    const addNewGroupBtn = document.getElementById('addNewGroupBtn');
    if (addNewGroupBtn) {
        addNewGroupBtn.addEventListener('click', function() {
            const compId = this.dataset.componentId;
            addNewGroupToComponent(compId);
        });
    }
}

/**
 * BileÅŸen grup listesini gÃ¼ncelleme
 */
function updateComponentGroupList(componentId) {
    // Modal aÃ§Ä±k mÄ± kontrol et
    const modal = document.getElementById('componentGroupManagementModal');
    if (modal && (modal.classList.contains('active') || modal.style.display === 'block')) {
        // Modal iÃ§eriÄŸini yeniden oluÅŸtur
        showComponentGroupManagementModal(componentId);
    }
}

/**
 * Grup haritalama Ã¶nizlemesi oluÅŸturma
 */
function generateGroupMappingsPreview(componentId) {
    const component = APP_STATE.courseData.grupHaritalari[componentId];
    if (!component || !component.haritalar) {
        return '<p>HenÃ¼z haritalama yapÄ±lmamÄ±ÅŸ</p>';
    }
    
    const groups = component.gruplar || ['A'];
    let preview = '<div class="mappings-grid">';
    
    groups.forEach(group => {
        const mappings = component.haritalar[group] || {};
        const mappingCount = Object.keys(mappings).length;
        
        preview += `
            <div class="mapping-preview-item">
                <div class="group-header">Grup ${group}</div>
                <div class="mapping-count">${mappingCount} haritalama</div>
                <div class="mapping-details">
                    ${Object.entries(mappings).map(([position, questionId]) => 
                        `<span class="mapping-detail">Soru ${position} â†’ ${questionId}</span>`
                    ).join('')}
                </div>
            </div>
        `;
    });
    
    preview += '</div>';
    return preview;
}

/**
 * TÃ¼m deÄŸerlendirme bileÅŸenlerinden grup silme (eski davranÄ±ÅŸ iÃ§in)
 */
function deleteGroup() {
    // TÃ¼m bileÅŸenlerde ortak olan gruplarÄ± bul
    const allGroups = new Set();
    Object.values(APP_STATE.courseData.grupHaritalari || {}).forEach(component => {
        (component.gruplar || []).forEach(group => allGroups.add(group));
    });
    
    const nonAGroups = Array.from(allGroups).filter(g => g !== 'A');
    
    if (nonAGroups.length === 0) {
        showModernToast("A grubu dÄ±ÅŸÄ±nda silinecek grup yok", "warning");
        return;
    }
    
    // Son grubu sil (alfabetik sÄ±rayla son)
    const lastGroup = nonAGroups.sort().pop();
    
    showDeleteConfirmModal(
        function() {
            // TÃ¼m bileÅŸenlerden bu grubu sil
            Object.keys(APP_STATE.courseData.grupHaritalari || {}).forEach(componentId => {
                const component = APP_STATE.courseData.grupHaritalari[componentId];
                if (component.gruplar && component.gruplar.includes(lastGroup)) {
                    component.gruplar = component.gruplar.filter(g => g !== lastGroup);
                    delete component.haritalar[lastGroup];
                }
            });
            
            // Bu gruptaki Ã¶ÄŸrencileri A grubuna taÅŸÄ±
            APP_STATE.studentData.forEach(student => {
                if (student.grup === lastGroup) {
                    student.grup = 'A';
                }
            });
            
            // TÃ¼m ilgili UI'larÄ± gÃ¼ncelle
            updateGroupSelectors();
            updateStudentTable();
            updateAssessmentView();
            updateAllInlineGroupInputs();
            updateAllMappingDisplays();
            updateGroupMappingColors();
            
            // Ã–ÄŸrenci bazlÄ± not giriÅŸi ekranÄ±nÄ± da gÃ¼ncelle
            if (APP_STATE.selectedStudentId) {
                showStudentGrades(APP_STATE.selectedStudentId);
            }
            
            showModernToast(`Grup ${lastGroup} tÃ¼m bileÅŸenlerden silindi, Ã¶ÄŸrenciler A grubuna taÅŸÄ±ndÄ±`, "success");
        },
        `Grup ${lastGroup}'Ä± tÃ¼m deÄŸerlendirme bileÅŸenlerinden silmek istediÄŸinizden emin misiniz? Bu gruptaki tÃ¼m Ã¶ÄŸrenciler A grubuna taÅŸÄ±nacak.`
    );
}

/**
 * Aktif gruplarÄ± gÃ¶rÃ¼ntÃ¼leme
 */
// updateActiveGroupsDisplay fonksiyonu kaldÄ±rÄ±ldÄ± - artÄ±k her bileÅŸenin kendi grup bilgisi var

/**
 * Grup seÃ§icileri gÃ¼ncelleme - BileÅŸen bazlÄ±
 */
function updateGroupSelectors() {
    console.log('ğŸ”„ updateGroupSelectors Ã§aÄŸrÄ±ldÄ±');
    
    try {
        // Ã–ÄŸrenci tablosundaki grup seÃ§icilerini gÃ¼ncelle (genel gruplar)
        updateStudentTableGroupSelectors();
        
        // DeÄŸerlendirme giriÅŸindeki grup seÃ§icilerini gÃ¼ncelle (bileÅŸen bazlÄ±)
        updateAssessmentGroupSelectors();
        
        // Ã–ÄŸrenci bazlÄ± not giriÅŸindeki grup seÃ§icilerini gÃ¼ncelle
        updateStudentGradesGroupSelectors();
        
    } catch (error) {
        console.error('Grup seÃ§icileri gÃ¼ncellenirken hata:', error);
    }
}

/**
 * Ã–ÄŸrenci tablosundaki grup seÃ§icilerini gÃ¼ncelle (genel sistem gruplarÄ±)
 */
function updateStudentTableGroupSelectors() {
    // Ã–ÄŸrenci tablosunda genel sistem gruplarÄ± kullanÄ±lÄ±r
    const allGroups = new Set(['A']); // A grubu her zaman var
    
    // Mevcut Ã¶ÄŸrencilerin gruplarÄ±ndan grup listesi oluÅŸtur
    if (APP_STATE.studentData && APP_STATE.studentData.length > 0) {
        APP_STATE.studentData.forEach(student => {
            if (student.grup) {
                allGroups.add(student.grup);
            }
        });
    }
    
    // EÄŸer grup sistemi varsa, tÃ¼m mevcut gruplarÄ± ekle
    if (APP_STATE.courseData?.grupHaritalari) {
        Object.values(APP_STATE.courseData.grupHaritalari).forEach(component => {
            if (component.gruplar) {
                component.gruplar.forEach(group => {
                    // Sadece tek harf olan gruplarÄ± ekle (A, B, C, D... - bileÅŸen kodlarÄ± deÄŸil)
                    if (group.length === 1 && /^[A-Z]$/.test(group)) {
                        allGroups.add(group);
                    }
                });
            }
        });
    }
    
    const groups = Array.from(allGroups).sort();
    
    // Sadece Ã¶ÄŸrenci tablosundaki grup seÃ§icilerini gÃ¼ncelle
    document.querySelectorAll('#student-content .group-selector').forEach(select => {
        const currentValue = select.value;
        const studentId = select.dataset.studentId;
        select.innerHTML = '';
        
        groups.forEach(groupId => {
            const option = document.createElement('option');
            option.value = groupId;
            option.textContent = groupId;
            if (groupId === currentValue) {
                option.selected = true;
            }
            select.appendChild(option);
        });
        
        // EÄŸer Ã¶ÄŸrencinin grubu seÃ§enekler arasÄ±nda yoksa, varsayÄ±lan grubu seÃ§
        if (!groups.includes(currentValue) && groups.length > 0) {
            select.value = groups[0];
            if (studentId) {
                const student = APP_STATE.studentData.find(s => s.studentId === studentId);
                if (student) {
                    student.grup = groups[0];
                }
            }
        }
    });
}

/**
 * DeÄŸerlendirme giriÅŸindeki grup seÃ§icilerini gÃ¼ncelle (bileÅŸen bazlÄ±)
 */
function updateAssessmentGroupSelectors() {
    console.log('ğŸ¯ updateAssessmentGroupSelectors Ã§aÄŸrÄ±ldÄ±');
    
    // DeÄŸerlendirme giriÅŸindeki her bileÅŸen iÃ§in ayrÄ± ayrÄ± grup seÃ§icilerini gÃ¼ncelle
    const groupSelectors = document.querySelectorAll('#assessment-content .group-selector');
    console.log(`  ğŸ“‹ Toplam ${groupSelectors.length} grup seÃ§ici bulundu`);
    
    groupSelectors.forEach((select, index) => {
        const studentId = select.dataset.studentId;
        let componentId = select.dataset.componentId;
        
        console.log(`  ğŸ” SeÃ§ici ${index + 1}: studentId=${studentId}, componentId=${componentId}`);
        
        if (!componentId) {
            // Component ID yoksa, en yakÄ±n assessment-subsection'dan bul
            const subsection = select.closest('.assessment-subsection');
            if (subsection && subsection.dataset.activityId) {
                componentId = subsection.dataset.activityId;
                console.log(`    ğŸ“ Subsection'dan componentId bulundu: ${componentId}`);
            }
            
            // Hala yoksa TR elementinden bul
            if (!componentId) {
                const row = select.closest('tr');
                if (row && row.dataset.componentId) {
                    componentId = row.dataset.componentId;
                    console.log(`    ğŸ“ TR'den componentId bulundu: ${componentId}`);
                }
            }
        }
        
        if (componentId && studentId) {
            // Bu bileÅŸenin gruplarÄ±nÄ± al
            const component = APP_STATE.courseData?.grupHaritalari?.[componentId];
            const componentGroups = component?.gruplar || ['A'];
            
            console.log(`    ğŸ“Š ${componentId} bileÅŸeni gruplarÄ±:`, componentGroups);
            
            // Ã–ÄŸrencinin bu bileÅŸendeki mevcut grubunu al
            const currentGroup = getStudentGroupForComponent(studentId, componentId);
            console.log(`    ğŸ‘¤ Ã–ÄŸrenci ${studentId} mevcut grup: ${currentGroup}`);
            
            // SeÃ§iciyi gÃ¼ncelle - DOM manipulation ile
            const currentValue = select.value; // Mevcut deÄŸeri koru
            
            // Ã–nce mevcut option'larÄ± temizle
            while (select.firstChild) {
                select.removeChild(select.firstChild);
            }
            
            // Yeni option'larÄ± ekle
            componentGroups.forEach(groupId => {
                const option = document.createElement('option');
                option.value = groupId;
                option.textContent = groupId;
                if (groupId === currentGroup) {
                    option.selected = true;
                }
                select.appendChild(option);
                console.log(`      â• Option eklendi: ${groupId} ${groupId === currentGroup ? '(seÃ§ili)' : ''}`);
            });
            
            // Son kontrol
            console.log(`      ğŸ” Select element option sayÄ±sÄ±: ${select.children.length}`);
            
            console.log(`    âœ… ${componentId} bileÅŸeni iÃ§in Ã¶ÄŸrenci ${studentId}: ${componentGroups.join(', ')} gruplarÄ±, seÃ§ili: ${currentGroup}`);
        } else {
            console.warn(`    âš ï¸ ComponentId veya StudentId eksik: componentId=${componentId}, studentId=${studentId}`);
            
            // En azÄ±ndan A grubunu ekle
            if (select.children.length === 0) {
                const option = document.createElement('option');
                option.value = 'A';
                option.textContent = 'A';
                option.selected = true;
                select.appendChild(option);
                console.log(`    ğŸ”§ VarsayÄ±lan A grubu eklendi`);
            }
        }
    });
    
    console.log('âœ… updateAssessmentGroupSelectors tamamlandÄ±');
}

/**
 * Ã–ÄŸrenci bazlÄ± not giriÅŸindeki grup seÃ§icilerini gÃ¼ncelle
 */
function updateStudentGradesGroupSelectors() {
    // Ã–ÄŸrenci bazlÄ± not giriÅŸinde genel sistem gruplarÄ± kullanÄ±lÄ±r
    const allGroups = new Set(['A']); // A grubu her zaman var
    
    // Mevcut Ã¶ÄŸrencilerin gruplarÄ±ndan grup listesi oluÅŸtur
    if (APP_STATE.studentData && APP_STATE.studentData.length > 0) {
        APP_STATE.studentData.forEach(student => {
            if (student.grup) {
                allGroups.add(student.grup);
            }
        });
    }
    
    const groups = Array.from(allGroups).sort();
    
    // Sadece Ã¶ÄŸrenci bazlÄ± not giriÅŸindeki grup seÃ§icilerini gÃ¼ncelle
    document.querySelectorAll('#assessment-content .group-selector').forEach(select => {
        const currentValue = select.value;
        const studentId = select.dataset.studentId;
        select.innerHTML = '';
        
        groups.forEach(groupId => {
            const option = document.createElement('option');
            option.value = groupId;
            option.textContent = groupId;
            if (groupId === currentValue) {
                option.selected = true;
            }
            select.appendChild(option);
        });
        
        // EÄŸer Ã¶ÄŸrencinin grubu seÃ§enekler arasÄ±nda yoksa, varsayÄ±lan grubu seÃ§
        if (!groups.includes(currentValue) && groups.length > 0) {
            select.value = groups[0];
            if (studentId) {
                const student = APP_STATE.studentData.find(s => s.studentId === studentId);
                if (student) {
                    student.grup = groups[0];
                }
            }
        }
    });
}

/**
 * Ã–ÄŸrenci grup gÃ¼ncelleme (TÃ¼m sekmelerde senkronize)
 */
function updateStudentGroup(selectElement) {
    const studentId = selectElement.dataset.studentId;
    const groupId = selectElement.value;
    
    console.log(`ğŸ”„ updateStudentGroup Ã§aÄŸrÄ±ldÄ±:`);
    console.log(`  - studentId: ${studentId}`);
    console.log(`  - groupId: ${groupId}`);
    console.log(`  - selectElement:`, selectElement);
    
    // Hangi etkinlik iÃ§inde bu grup deÄŸiÅŸikliÄŸi yapÄ±ldÄ±ÄŸÄ±nÄ± bul
    const componentId = findComponentIdFromGroupSelector(selectElement);
    console.log(`  - componentId: ${componentId}`);
    
    if (!componentId) {
        console.error("âŒ Component ID bulunamadÄ±!");
        return;
    }
    
    // Ã–ÄŸrenci verilerini gÃ¼ncelle (sadece bu etkinlik iÃ§in)
    setStudentGroupForComponent(studentId, groupId, componentId);
    
    // Sadece bu etkinlikteki aynÄ± Ã¶ÄŸrencinin diÄŸer satÄ±rlarÄ±nÄ± gÃ¼ncelle
    updateComponentGroupSelectors(studentId, groupId, componentId);
    
    // Sadece bu etkinlikteki soru bilgilerini gÃ¼ncelle
    updateQuestionInfoForComponent(studentId, groupId, componentId);
    
    // Toast mesajÄ±
    const student = APP_STATE.studentData.find(s => s.studentId === studentId);
    const studentName = student ? `${student.name} ${student.surname}` : studentId;
    showModernToast(`${studentName} Ã¶ÄŸrencisi ${getComponentDisplayName(componentId)} etkinliÄŸinde ${groupId} grubuna atandÄ±`, "success");
}

/**
 * Grup bazlÄ± notlarÄ± yÃ¼kleme
 * @param {string} studentId - Ã–ÄŸrenci ID'si
 * @param {string} newGroupId - Yeni grup ID'si
 */
function loadGroupBasedGrades(studentId, newGroupId) {
    console.log(`ğŸ”„ loadGroupBasedGrades Ã§aÄŸrÄ±ldÄ± - Ã–ÄŸrenci: ${studentId}, Yeni Grup: ${newGroupId}`);
    
    try {
        // Ã–ÄŸrencinin not verilerini kontrol et
        if (!APP_STATE.gradesData || !APP_STATE.gradesData[studentId]) {
            console.log(`âš ï¸ ${studentId} Ã¶ÄŸrencisi iÃ§in not verisi bulunamadÄ±`);
            return;
        }
        
        const studentGrades = APP_STATE.gradesData[studentId];
        
        // Grup bazlÄ± notlar kontrolÃ¼
        if (!studentGrades.grupBazliNotlar) {
            console.log(`ğŸ“ ${studentId} Ã¶ÄŸrencisi iÃ§in grup bazlÄ± not yapÄ±sÄ± oluÅŸturuluyor`);
            studentGrades.grupBazliNotlar = {};
            return;
        }
        
        const groupGrades = studentGrades.grupBazliNotlar[newGroupId];
        if (!groupGrades) {
            console.log(`ğŸ“ ${studentId} Ã¶ÄŸrencisi iÃ§in ${newGroupId} grubunda henÃ¼z not girilmemiÅŸ`);
            return;
        }
        
        console.log(`ğŸ“‹ ${studentId} Ã¶ÄŸrencisi iÃ§in ${newGroupId} grubundaki notlar yÃ¼kleniyor:`, groupGrades);
        
        // Grup bazlÄ± notlarÄ± input alanlarÄ±na yÃ¼kle
        Object.keys(groupGrades).forEach(activityId => {
            const grade = groupGrades[activityId];
            
            // Input alanÄ±nÄ± bul ve deÄŸeri yÃ¼kle
            const assessmentInput = document.querySelector(`input[data-student-id="${studentId}"][data-activity-id="${activityId}"]`);
            if (assessmentInput) {
                assessmentInput.value = grade;
                assessmentInput.style.borderColor = "";
                
                // Maksimum puan kontrolÃ¼
                const maxPoints = parseFloat(assessmentInput.max) || 100;
                if (grade > maxPoints) {
                    assessmentInput.style.borderColor = "#ff6b6b";
                    assessmentInput.title = `Bu Ã¶ÄŸrencinin grubundaki bu sorunun maksimum puanÄ±: ${maxPoints} (Mevcut deÄŸer ${grade} maksimumdan bÃ¼yÃ¼k!)`;
                }
                
                console.log(`  âœ… ${activityId}: ${grade} puan yÃ¼klendi`);
            } else {
                console.log(`  âš ï¸ ${activityId} iÃ§in input alanÄ± bulunamadÄ±`);
            }
            
            // Ana not verisini gÃ¼ncelle
            APP_STATE.gradesData[studentId][activityId] = grade;
        });
        
        // HesaplanmÄ±ÅŸ notlarÄ± gÃ¼ncelle
        updateStudentCalculatedGrade(studentId);
        updateAssessmentGradeSummary(studentId);
        updateStudentSummary(studentId);
        
        console.log(`âœ… ${studentId} Ã¶ÄŸrencisi iÃ§in ${newGroupId} grubundaki notlar baÅŸarÄ±yla yÃ¼klendi`);
        
    } catch (error) {
        console.error("Grup bazlÄ± notlar yÃ¼klenirken hata oluÅŸtu:", error);
    }
}

/**
 * Grup seÃ§icisinden hangi etkinlik iÃ§inde olduÄŸunu bul
 */
function findComponentIdFromGroupSelector(selectElement) {
    // Ãœst elementlerde component ID'si arayalÄ±m
    let currentElement = selectElement;
    
    while (currentElement && currentElement !== document.body) {
        // TR elementinde data-component-id var mÄ±?
        if (currentElement.dataset && currentElement.dataset.componentId) {
            return currentElement.dataset.componentId;
        }
        
        // Assessment subsection iÃ§inde mi?
        if (currentElement.classList && currentElement.classList.contains('assessment-subsection')) {
            // BaÅŸlÄ±k elementini bul ve component ID'sini Ã§Ä±kar
            const header = currentElement.querySelector('h5');
            if (header && header.textContent) {
                // "Ara SÄ±nav" gibi baÅŸlÄ±ktan component ID'sini bulmaya Ã§alÄ±ÅŸ
                const allActivities = [...(APP_STATE.courseData?.ara || []), ...(APP_STATE.courseData?.final || [])];
                const activity = allActivities.find(act => act.name === header.textContent.trim());
                if (activity) {
                    return activity.id;
                }
            }
        }
        
        currentElement = currentElement.parentElement;
    }
    
    console.warn("Component ID bulunamadÄ±, selectElement'in parent elementleri kontrol ediliyor...");
    return null;
}

/**
 * BileÅŸen iÃ§in grup seÃ§enekleri oluÅŸturma
 * @param {string} studentId - Ã–ÄŸrenci ID'si
 * @param {string} componentId - BileÅŸen ID'si
 * @returns {string} - HTML option elemanlarÄ±
 */
function createGroupOptions(studentId, componentId) {
    // Bu bileÅŸenin gruplarÄ±nÄ± al
    const component = APP_STATE.courseData?.grupHaritalari?.[componentId];
    const groups = component?.gruplar || ['A'];
    
    // Ã–ÄŸrencinin bu bileÅŸendeki mevcut grubunu al
    const studentCurrentGroup = getStudentGroupForComponent(studentId, componentId);
    
    // Grup seÃ§eneklerini oluÅŸtur
    return groups.map(groupId => 
        `<option value="${groupId}" ${studentCurrentGroup === groupId ? 'selected' : ''}>${groupId}</option>`
    ).join('');
}

/**
 * Ã–ÄŸrenci bazlÄ± not giriÅŸindeki ana grup seÃ§ici iÃ§in - tÃ¼m bileÅŸenler iÃ§in grup gÃ¼nceller
 */
function updateStudentGroupForAllComponents(selectElement) {
    const studentId = selectElement.dataset.studentId;
    const groupId = selectElement.value;
    
    console.log(`ğŸ”„ updateStudentGroupForAllComponents Ã§aÄŸrÄ±ldÄ±:`);
    console.log(`  - studentId: ${studentId}`);
    console.log(`  - groupId: ${groupId}`);
    
    // Ã–ÄŸrencinin genel grubunu gÃ¼ncelle
    const student = APP_STATE.studentData.find(s => s.studentId === studentId);
    if (student) {
        student.grup = groupId;
    }
    
    // TÃ¼m bileÅŸenler iÃ§in grup gÃ¼ncelle
    if (APP_STATE.courseData?.grupHaritalari) {
        Object.keys(APP_STATE.courseData.grupHaritalari).forEach(componentId => {
            setStudentGroupForComponent(studentId, groupId, componentId);
        });
    }
    
    // Ã–ÄŸrenci gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ yeniden oluÅŸtur
    showStudentGrades(studentId);
    
    // Toast mesajÄ±
    const studentName = student ? `${student.name} ${student.surname}` : studentId;
    showModernToast(`${studentName} Ã¶ÄŸrencisi tÃ¼m bileÅŸenlerde ${groupId} grubuna atandÄ±`, "success");
}

/**
 * DOM event iÃ§in wrapper fonksiyon
 */
function updateStudentGroupForComponent(selectElement) {
    const studentId = selectElement.dataset.studentId;
    const groupId = selectElement.value;
    const componentId = selectElement.dataset.componentId;
    
    console.log(`ğŸ”„ updateStudentGroupForComponent (DOM wrapper) Ã§aÄŸrÄ±ldÄ±:`);
    console.log(`  - studentId: ${studentId}`);
    console.log(`  - groupId: ${groupId}`);
    console.log(`  - componentId: ${componentId}`);
    
    if (!componentId) {
        console.error("âŒ Component ID bulunamadÄ±!");
        return;
    }
    
    // Ã–ÄŸrenci verilerini gÃ¼ncelle (sadece bu etkinlik iÃ§in)
    setStudentGroupForComponent(studentId, groupId, componentId);
    
    // SENKRONIZASYON: TÃ¼m sistemi gÃ¼ncelle
    synchronizeStudentGroupChanges(studentId, groupId, componentId);
    
    // Toast mesajÄ±
    const student = APP_STATE.studentData.find(s => s.studentId === studentId);
    const studentName = student ? `${student.name} ${student.surname}` : studentId;
    showModernToast(`${studentName} Ã¶ÄŸrencisi ${getComponentDisplayName(componentId)} etkinliÄŸinde ${groupId} grubuna atandÄ± - TÃ¼m sistem senkronize edildi`, "success");
}

/**
 * Ã–ÄŸrenci grup deÄŸiÅŸikliÄŸini tÃ¼m sisteme senkronize et
 */
function synchronizeStudentGroupChanges(studentId, groupId, componentId) {
    console.log(`ğŸ”„ synchronizeStudentGroupChanges baÅŸlatÄ±ldÄ±:`);
    console.log(`  - studentId: ${studentId}`);
    console.log(`  - groupId: ${groupId}`);
    console.log(`  - componentId: ${componentId}`);
    
    // 1. Bu etkinlikteki aynÄ± Ã¶ÄŸrencinin diÄŸer satÄ±rlarÄ±nÄ± gÃ¼ncelle
    updateComponentGroupSelectors(studentId, groupId, componentId);
    
    // 2. Bu etkinlikteki soru bilgilerini gÃ¼ncelle
    updateQuestionInfoForComponent(studentId, groupId, componentId);
    
    // 3. DeÄŸerlendirme tablosundaki genel soru puanlarÄ±nÄ± gÃ¼ncelle
    updateQuestionPointsInAssessmentTable(studentId);
    
    // 4. Ã–ÄŸrenci Listesi sekmesindeki grup bilgilerini gÃ¼ncelle
    updateStudentListGroupInfo();
    
    // 5. TÃ¼m sekmelerdeki grup seÃ§icilerini gÃ¼ncelle
    updateAllTabGroupSelectors(studentId, groupId, componentId);
    
    // 6. Grup bazlÄ± not yÃ¼kleme
    loadGroupBasedGrades(studentId, groupId);
    
    // 7. Notlar sekmesini gÃ¼ncelle (eÄŸer aÃ§Ä±ksa)
    if (document.querySelector('#grades-content.active')) {
        updateGradesView();
    }
    
    // 8. DeÄŸerlendirme gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ yenile (grup deÄŸiÅŸikliÄŸi sonrasÄ±)
    setTimeout(() => {
        refreshAssessmentViewForStudent(studentId, componentId);
    }, 100);
    
    console.log(`âœ… Sistem senkronizasyonu tamamlandÄ±`);
}

/**
 * Ã–ÄŸrenci Listesi sekmesindeki grup bilgilerini gÃ¼ncelle
 */
function updateStudentListGroupInfo() {
    console.log(`ğŸ“‹ Ã–ÄŸrenci Listesi grup bilgileri gÃ¼ncelleniyor...`);
    
    // Ã–ÄŸrenci grup bilgileri kartÄ±nÄ± gÃ¼ncelle
    const groupInfoCard = document.getElementById('studentGroupInfoCard');
    const groupInfoContainer = document.getElementById('studentGroupInfoContainer');
    
    if (!groupInfoCard || !groupInfoContainer) {
        console.log(`âš ï¸ Ã–ÄŸrenci grup bilgi bileÅŸenleri bulunamadÄ±`);
        return;
    }
    
    // Grup bilgilerini yeniden oluÅŸtur
    const hasGroupData = APP_STATE.studentComponentGroups && Object.keys(APP_STATE.studentComponentGroups).length > 0;
    
    if (!hasGroupData) {
        groupInfoCard.style.display = 'none';
        return;
    }
    
    groupInfoCard.style.display = 'block';
    
    // Grup bilgilerini dÃ¼zenle
    let groupInfoHTML = '';
    const students = APP_STATE.studentData || [];
    const components = getAllComponents();
    
    if (students.length === 0 || components.length === 0) {
        groupInfoHTML = '<p class="empty-message">Ã–ÄŸrenci veya etkinlik verisi bulunmuyor.</p>';
    } else {
        // Etkinlik bazÄ±nda grup bilgilerini gÃ¶ster
        components.forEach(component => {
            const componentGroups = {};
            
            students.forEach(student => {
                const studentGroup = getStudentGroupForComponent(student.studentId, component.id);
                if (studentGroup && studentGroup !== 'A') { // VarsayÄ±lan A grubunu gÃ¶sterme
                    if (!componentGroups[studentGroup]) {
                        componentGroups[studentGroup] = [];
                    }
                    componentGroups[studentGroup].push(student);
                }
            });
            
            if (Object.keys(componentGroups).length > 0) {
                groupInfoHTML += `
                    <div class="component-group-info">
                        <h4 class="component-title">${getComponentDisplayName(component.id)}</h4>
                        <div class="groups-container">
                `;
                
                Object.keys(componentGroups).sort().forEach(groupId => {
                    const groupStudents = componentGroups[groupId];
                    groupInfoHTML += `
                        <div class="group-info">
                            <div class="group-header">
                                <span class="group-badge">${groupId} Grubu</span>
                                <span class="student-count">${groupStudents.length} Ã¶ÄŸrenci</span>
                            </div>
                            <div class="group-students">
                                ${groupStudents.map(student => 
                                    `<span class="student-tag">${student.studentId} - ${student.name} ${student.surname}</span>`
                                ).join('')}
                            </div>
                        </div>
                    `;
                });
                
                groupInfoHTML += `
                        </div>
                    </div>
                `;
            }
        });
        
        if (!groupInfoHTML) {
            groupInfoHTML = '<p class="empty-message">HenÃ¼z grup atamasÄ± yapÄ±lmamÄ±ÅŸ.</p>';
        }
    }
    
    groupInfoContainer.innerHTML = groupInfoHTML;
    console.log(`âœ… Ã–ÄŸrenci Listesi grup bilgileri gÃ¼ncellendi`);
}

/**
 * TÃ¼m sekmelerdeki grup seÃ§icilerini gÃ¼ncelle
 */
function updateAllTabGroupSelectors(studentId, groupId, componentId) {
    console.log(`ğŸ”„ TÃ¼m sekmelerdeki grup seÃ§icileri gÃ¼ncelleniyor...`);
    
    // DeÄŸerlendirme GiriÅŸi sekmesindeki grup seÃ§icilerini gÃ¼ncelle
    const assessmentSelectors = document.querySelectorAll(`#assessment-content select[data-student-id="${studentId}"][data-component-id="${componentId}"]`);
    assessmentSelectors.forEach(selector => {
        if (selector.value !== groupId) {
            selector.value = groupId;
            console.log(`âœ… Assessment sekmesi grup seÃ§icisi gÃ¼ncellendi: ${groupId}`);
        }
    });
    
    // DiÄŸer sekmelerdeki benzer seÃ§icileri de gÃ¼ncelle (gelecekte eklenebilir)
    console.log(`âœ… TÃ¼m sekmelerdeki grup seÃ§icileri gÃ¼ncellendi`);
}

/**
 * Belirli Ã¶ÄŸrenci iÃ§in deÄŸerlendirme gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ yenile
 */
function refreshAssessmentViewForStudent(studentId, componentId) {
    console.log(`ğŸ”„ Ã–ÄŸrenci ${studentId} iÃ§in deÄŸerlendirme gÃ¶rÃ¼nÃ¼mÃ¼ yenileniyor...`);
    
    // Sadece bu Ã¶ÄŸrencinin satÄ±rlarÄ±nÄ± yenile
    const studentRows = document.querySelectorAll(`#assessment-content tr[data-student-id="${studentId}"][data-component-id="${componentId}"]`);
    
    studentRows.forEach(row => {
        // Grup seÃ§icisini kontrol et
        const groupSelector = row.querySelector('select[data-student-id]');
        if (groupSelector) {
            const currentGroup = getStudentGroupForComponent(studentId, componentId);
            if (groupSelector.value !== currentGroup) {
                groupSelector.value = currentGroup;
            }
        }
        
        // Soru bilgilerini gÃ¼ncelle
        const paperOrder = row.dataset.paperOrder;
        if (paperOrder) {
            const questionId = getQuestionIdByPaperOrder(studentId, parseInt(paperOrder), componentId);
            const question = findNodeById(questionId);
            
            // Puan bilgisini gÃ¼ncelle
            const pointsCell = row.querySelector('.question-points-cell');
            if (pointsCell && question) {
                pointsCell.textContent = question.points;
                pointsCell.dataset.activityId = questionId;
            }
            
            // Input alanÄ±nÄ± gÃ¼ncelle
            const input = row.querySelector('input[data-student-id]');
            if (input && question) {
                input.max = question.points;
                input.placeholder = `0-${question.points}`;
                input.dataset.activityId = questionId;
                
                // Max puan bilgisini gÃ¼ncelle
                let maxInfoSpan = input.parentElement.querySelector('.max-points-info');
                if (maxInfoSpan) {
                    maxInfoSpan.textContent = `(max: ${question.points})`;
                }
            }
        }
    });
    
    console.log(`âœ… Ã–ÄŸrenci ${studentId} deÄŸerlendirme gÃ¶rÃ¼nÃ¼mÃ¼ yenilendi`);
}

/**
 * TÃ¼m bileÅŸenleri (etkinlikleri) al
 */
function getAllComponents() {
    const components = [];
    
    if (!APP_STATE.courseData || !APP_STATE.courseData.children) {
        return components;
    }
    
    function collectComponents(nodes) {
        nodes.forEach(node => {
            if (node.type === 'activity') {
                components.push(node);
            }
            if (node.children && node.children.length > 0) {
                collectComponents(node.children);
            }
        });
    }
    
    collectComponents(APP_STATE.courseData.children);
    return components;
}

/**
 * Notlar sekmesini gÃ¼ncelle
 */
function updateGradesView() {
    console.log(`ğŸ“Š Notlar sekmesi gÃ¼ncelleniyor...`);
    
    // NotlarÄ± yeniden hesapla
    if (typeof calculateGrades === 'function') {
        calculateGrades();
    }
    
    console.log(`âœ… Notlar sekmesi gÃ¼ncellendi`);
}

/**
 * Belirli bir etkinlik iÃ§in Ã¶ÄŸrenci grubunu gÃ¼ncelle (veri iÅŸleme)
 */
function setStudentGroupForComponent(studentId, groupId, componentId) {
    // Etkinlik bazlÄ± grup verilerini sakla
    if (!APP_STATE.studentComponentGroups) {
        APP_STATE.studentComponentGroups = {};
    }
    
    if (!APP_STATE.studentComponentGroups[studentId]) {
        APP_STATE.studentComponentGroups[studentId] = {};
    }
    
    APP_STATE.studentComponentGroups[studentId][componentId] = groupId;
    
    // v5 formatÄ±ndaki grup bilgilerini de gÃ¼ncelle (en yÃ¼ksek Ã¶ncelikli)
    if (!APP_STATE.gradesData) {
        APP_STATE.gradesData = {};
    }
    
    if (!APP_STATE.gradesData[studentId]) {
        APP_STATE.gradesData[studentId] = {};
    }
    
    if (!APP_STATE.gradesData[studentId].grupBilgileri) {
        APP_STATE.gradesData[studentId].grupBilgileri = {};
    }
    
    APP_STATE.gradesData[studentId].grupBilgileri[componentId] = groupId;
    
    // EKLEME: courseData iÃ§indeki ogrenciNotlari yapÄ±sÄ±nÄ± da gÃ¼ncelle (v5 format iÃ§in kritik!)
    if (APP_STATE.courseData && APP_STATE.courseData.ogrenciNotlari && APP_STATE.courseData.ogrenciNotlari[studentId]) {
        if (!APP_STATE.courseData.ogrenciNotlari[studentId].grupBilgileri) {
            APP_STATE.courseData.ogrenciNotlari[studentId].grupBilgileri = {};
        }
        APP_STATE.courseData.ogrenciNotlari[studentId].grupBilgileri[componentId] = groupId;
        console.log(`ğŸ“ courseData v5 formatÄ±nda grup bilgisi gÃ¼ncellendi: ${studentId} -> ${componentId} -> ${groupId}`);
    }
    
    console.log(`ğŸ“ Ã–ÄŸrenci ${studentId} iÃ§in ${componentId} etkinliÄŸinde grup ${groupId} olarak gÃ¼ncellendi`);
    console.log(`  - GÃ¼ncel componentGroups:`, APP_STATE.studentComponentGroups[studentId]);
    console.log(`  - GÃ¼ncel v5 grupBilgileri:`, APP_STATE.gradesData[studentId].grupBilgileri);
}

/**
 * Belirli bir etkinlikteki grup seÃ§icilerini gÃ¼ncelle
 */
function updateComponentGroupSelectors(studentId, groupId, componentId) {
    // Sadece deÄŸerlendirme giriÅŸindeki grup seÃ§icilerini bul (Ã¶ÄŸrenci bazlÄ± not giriÅŸi kaldÄ±rÄ±ldÄ±)
    const assessmentRows = document.querySelectorAll(`#assessment-content tr[data-student-id="${studentId}"][data-component-id="${componentId}"]`);
    const componentRows = [...assessmentRows];
    
    console.log(`ğŸ”„ ${componentId} etkinliÄŸinde ${studentId} Ã¶ÄŸrencisi iÃ§in ${componentRows.length} satÄ±r bulundu (Assessment: ${assessmentRows.length})`);
    
    componentRows.forEach((row, index) => {
        const groupSelector = row.querySelector(`select[data-student-id="${studentId}"]`);
        if (groupSelector && groupSelector.value !== groupId) {
            console.log(`  - SatÄ±r ${index + 1} grup seÃ§icisi gÃ¼ncellendi: ${groupSelector.value} â†’ ${groupId}`);
            groupSelector.value = groupId;
        }
    });
}

/**
 * Belirli bir etkinlik iÃ§in soru bilgilerini gÃ¼ncelle
 */
function updateQuestionInfoForComponent(studentId, groupId, componentId) {
    console.log(`ğŸ”„ updateQuestionInfoForComponent Ã§aÄŸrÄ±ldÄ±:`);
    console.log(`  - studentId: ${studentId}`);
    console.log(`  - groupId: ${groupId}`);
    console.log(`  - componentId: ${componentId}`);
    
    // Sadece deÄŸerlendirme giriÅŸindeki satÄ±rlarÄ± bul (Ã¶ÄŸrenci bazlÄ± not giriÅŸi kaldÄ±rÄ±ldÄ±)
    const assessmentRows = document.querySelectorAll(`#assessment-content tr[data-student-id="${studentId}"][data-component-id="${componentId}"]`);
    const componentRows = [...assessmentRows];
    console.log(`ğŸ“‹ ${componentId} etkinliÄŸinde ${studentId} iÃ§in ${componentRows.length} satÄ±r bulundu (Assessment: ${assessmentRows.length})`);
    
    if (componentRows.length === 0) {
        console.warn(`âš ï¸ ${studentId} Ã¶ÄŸrencisi iÃ§in ${componentId} etkinliÄŸinde hiÃ§ satÄ±r bulunamadÄ±!`);
        return;
    }
    
    componentRows.forEach((row, index) => {
        const paperOrder = row.dataset.paperOrder;
        
        console.log(`ğŸ“ SatÄ±r ${index + 1} (paperOrder: ${paperOrder}):`);
        
        if (paperOrder) {
            // KaÄŸÄ±t sÄ±rasÄ±ndan gerÃ§ek soru ID'sini al (yeni grupla)
            const questionId = getQuestionIdByPaperOrder(studentId, parseInt(paperOrder), componentId);
            const answerKeyOrder = getAnswerKeyOrder(studentId, parseInt(paperOrder), componentId);
            const outcomes = getQuestionOutcomesForStudent(studentId, questionId, componentId);
            
            console.log(`ğŸ” Hesaplanan deÄŸerler:`);
            console.log(`  - questionId: ${questionId}`);
            console.log(`  - answerKeyOrder: ${answerKeyOrder}`);
            console.log(`  - outcomes:`, outcomes);
            
            // Etkinlik max puanÄ±nÄ± gÃ¼ncelle
            const pointsCell = row.querySelector('.question-points-cell');
            if (pointsCell && questionId) {
                // Points cell'in data-activity-id deÄŸerini gÃ¼ncelle
                if (pointsCell.dataset.activityId !== questionId) {
                    console.log(`ğŸ”„ Points cell data-activity-id gÃ¼ncellendi: ${pointsCell.dataset.activityId} â†’ ${questionId}`);
                    pointsCell.dataset.activityId = questionId;
                }
                
                // Sorunun ID'si bulunduysa, doÄŸrudan o sorunun puanÄ±nÄ± al
                const question = findNodeById(questionId);
                const newPoints = question ? question.points : 0;
                console.log(`  - Soru bulundu: ${!!question}, Yeni puan: ${newPoints}`);
                pointsCell.textContent = newPoints;
                
                // Input alanÄ±nÄ±n max deÄŸerini gÃ¼ncelle
                const input = row.querySelector(`input[data-student-id="${studentId}"]`);
                if (input) {
                    // Input'un data-activity-id deÄŸerini gÃ¼ncelle (grup deÄŸiÅŸtiÄŸinde soru ID'si deÄŸiÅŸebilir)
                    if (questionId && input.dataset.activityId !== questionId) {
                        console.log(`ğŸ”„ Input data-activity-id gÃ¼ncellendi: ${input.dataset.activityId} â†’ ${questionId}`);
                        input.dataset.activityId = questionId;
                    }
                    
                    input.max = newPoints;
                    input.placeholder = `0-${newPoints}`;
                    
                    // Maksimum puan bilgisini title'da gÃ¶ster
                    const maxPointsInfo = `ğŸ“Š Maksimum Puan: ${newPoints}`;
                    input.title = `${maxPointsInfo} - Bu Ã¶ÄŸrencinin grubundaki bu sorunun maksimum puanÄ±`;
                    
                    // Input yanÄ±na maksimum puan bilgisi ekle
                    let maxInfoSpan = input.parentElement.querySelector('.max-points-info');
                    if (!maxInfoSpan) {
                        maxInfoSpan = document.createElement('span');
                        maxInfoSpan.className = 'max-points-info';
                        maxInfoSpan.style.cssText = 'font-size: 10px; color: #666; margin-left: 5px; font-weight: bold;';
                        input.parentElement.appendChild(maxInfoSpan);
                    }
                    maxInfoSpan.textContent = `(max: ${newPoints})`;
                    
                    // EÄŸer mevcut deÄŸer yeni maksimumdan bÃ¼yÃ¼kse, uyarÄ± ver ve dÃ¼zelt
                    const currentValue = parseFloat(input.value);
                    if (currentValue > newPoints) {
                        const oldValue = currentValue;
                        input.value = newPoints; // Otomatik dÃ¼zelt
                        input.style.borderColor = '#ff6b6b';
                        input.style.backgroundColor = '#fff5f5';
                        
                        // DÃ¼zeltilmiÅŸ deÄŸeri kaydet
                        if (questionId) {
                            // Grup bazlÄ± not saklama sistemi
                            if (!APP_STATE.gradesData[studentId]) {
                                APP_STATE.gradesData[studentId] = {};
                            }
                            if (!APP_STATE.gradesData[studentId].grupBazliNotlar) {
                                APP_STATE.gradesData[studentId].grupBazliNotlar = {};
                            }
                            
                            const studentGroup = getStudentGroupForComponent(studentId, componentId);
                            if (!APP_STATE.gradesData[studentId].grupBazliNotlar[studentGroup]) {
                                APP_STATE.gradesData[studentId].grupBazliNotlar[studentGroup] = {};
                            }
                            
                            APP_STATE.gradesData[studentId].grupBazliNotlar[studentGroup][questionId] = newPoints;
                            APP_STATE.gradesData[studentId][questionId] = newPoints;
                            
                            console.log(`ğŸ”§ Puan otomatik dÃ¼zeltildi: ${oldValue} â†’ ${newPoints}`);
                        }
                        
                        showModernToast(`${studentId} Ã¶ÄŸrencisinin kaÄŸÄ±t sÄ±rasÄ± ${paperOrder} sorusundaki puanÄ± otomatik olarak ${oldValue} â†’ ${newPoints} dÃ¼zeltildi!`, "warning");
                        
                        // Borderi 3 saniye sonra temizle
                        setTimeout(() => {
                            input.style.borderColor = '';
                            input.style.backgroundColor = '';
                        }, 3000);
                    } else {
                        input.style.borderColor = '';
                        input.style.backgroundColor = '';
                    }
                    
                    // GRUP BAZLI NOT YÃœKLEME: Yeni gruba geÃ§ince o grubun notunu yÃ¼kle
                    const studentGroup = getStudentGroupForComponent(studentId, componentId);
                    if (APP_STATE.gradesData[studentId]?.grupBazliNotlar?.[studentGroup]?.[questionId] !== undefined) {
                        const savedGrade = APP_STATE.gradesData[studentId].grupBazliNotlar[studentGroup][questionId];
                        if (input.value !== savedGrade.toString()) {
                            input.value = savedGrade;
                            console.log(`ğŸ“š Grup bazlÄ± not yÃ¼klendi: ${studentId} (${studentGroup} grubu) â†’ Soru ${questionId} = ${savedGrade} puan`);
                        }
                    }
                }
            }
            
            // Cevap anahtarÄ± sÄ±rasÄ±nÄ± gÃ¼ncelle
            const answerKeyBadge = row.querySelector('.answer-key-badge');
            if (answerKeyBadge) {
                const oldValue = answerKeyBadge.textContent;
                answerKeyBadge.textContent = answerKeyOrder || '?';
                console.log(`  - Cevap anahtarÄ± sÄ±rasÄ± gÃ¼ncellendi: ${oldValue} â†’ ${answerKeyOrder || '?'}`);
            }
            
            // Etkinlik adÄ±nÄ± gÃ¼ncelle - GerÃ§ek etkinlik adÄ±nÄ± gÃ¶ster
            const questionNameBadge = row.querySelector('.question-name-badge');
            if (questionNameBadge) {
                const question = findNodeById(questionId);
                const realQuestionName = question?.name || `Soru ${answerKeyOrder || paperOrder}`;
                const oldName = questionNameBadge.textContent;
                questionNameBadge.textContent = realQuestionName;
                questionNameBadge.title = `${realQuestionName} (Cevap anahtarÄ± sÄ±rasÄ±: ${answerKeyOrder})`;
                console.log(`  - Etkinlik adÄ± gÃ¼ncellendi: "${oldName}" â†’ "${realQuestionName}"`);
            }
            
            // Soru aÃ§Ä±klamasÄ±nÄ± gÃ¼ncelle
            const questionDescBadge = row.querySelector('.question-desc-badge');
            if (questionDescBadge && questionId) {
                const question = findNodeById(questionId);
                const description = question ? (question.description || question.name || '-') : 'Soru bulunamadÄ±';
                const oldValue = questionDescBadge.textContent;
                questionDescBadge.textContent = description;
                questionDescBadge.title = description;
                console.log(`  - Soru aÃ§Ä±klamasÄ± gÃ¼ncellendi: "${oldValue}" â†’ "${description}"`);
            }
            
            // Ã–Ã‡ deÄŸerini gÃ¼ncelle
            const outcomesBadge = row.querySelector('.outcomes-badge');
            if (outcomesBadge) {
                const oldValue = outcomesBadge.textContent;
                if (outcomes && outcomes.length > 0) {
                    outcomesBadge.textContent = outcomes.join(', ');
                    outcomesBadge.title = `Ã–ÄŸrenme Ã‡Ä±ktÄ±larÄ±: ${outcomes.join(', ')}`;
                    console.log(`  - Ã–Ã‡ gÃ¼ncellendi: "${oldValue}" â†’ "${outcomes.join(', ')}"`);
                } else {
                    outcomesBadge.textContent = '';
                    outcomesBadge.title = 'Ã–ÄŸrenme Ã§Ä±ktÄ±sÄ± tanÄ±mlanmamÄ±ÅŸ';
                    console.log(`  - Ã–Ã‡ temizlendi: "${oldValue}" â†’ ""`);
                }
            }
            
            // Her satÄ±r iÃ§in toplam puanÄ± gÃ¼ncelle
            const totalPointsCell = row.querySelector('.total-points-cell');
            if (totalPointsCell) {
                const totalPoints = getStudentTotalEarnedPointsForComponent(studentId, componentId);
                totalPointsCell.textContent = totalPoints;
                
                // Badge iÃ§inde ise badge'i gÃ¼ncelle
                const totalPointsBadge = totalPointsCell.querySelector('.total-points-badge');
                if (totalPointsBadge) {
                    totalPointsBadge.textContent = totalPoints;
                }
                console.log(`  - Toplam puan gÃ¼ncellendi: ${totalPoints}`);
            }
            
            console.log(`âœ… SatÄ±r ${index + 1} iÅŸlendi`);
        } else {
            // Basit etkinlik (paperOrder yok)
            console.log(`ğŸ“ Basit etkinlik satÄ±rÄ± ${index + 1}:`);
            
            // Etkinlik max puanÄ±nÄ± gÃ¼ncelle
            const pointsCell = row.querySelector('.question-points-cell');
            if (pointsCell) {
                const activityId = pointsCell.dataset.activityId;
                if (activityId) {
                    const activity = findNodeById(activityId);
                    const newPoints = activity?.points || 0;
                    console.log(`  - Yeni puan: ${newPoints}`);
                    pointsCell.textContent = newPoints;
                    
                    // Input alanÄ±nÄ±n max deÄŸerini gÃ¼ncelle
                    const input = row.querySelector(`input[data-student-id="${studentId}"]`);
                    if (input) {
                        input.max = newPoints;
                        input.placeholder = `0-${newPoints}`;
                        input.title = `Bu aktivitenin maksimum puanÄ±: ${newPoints}`;
                        
                        // Input yanÄ±na maksimum puan bilgisi ekle (basit etkinlik iÃ§in)
                        let maxInfoSpan = input.parentElement.querySelector('.max-points-info');
                        if (!maxInfoSpan) {
                            maxInfoSpan = document.createElement('span');
                            maxInfoSpan.className = 'max-points-info';
                            maxInfoSpan.style.cssText = 'font-size: 10px; color: #666; margin-left: 5px; font-weight: bold;';
                            input.parentElement.appendChild(maxInfoSpan);
                        }
                        maxInfoSpan.textContent = `(max: ${newPoints})`;
                    }
                }
            }
            
            // Her satÄ±r iÃ§in toplam puanÄ± gÃ¼ncelle
            const totalPointsCell = row.querySelector('.total-points-cell');
            if (totalPointsCell) {
                const totalPoints = getStudentTotalEarnedPointsForComponent(studentId, componentId);
                totalPointsCell.textContent = totalPoints;
                
                // Badge iÃ§inde ise badge'i gÃ¼ncelle
                const totalPointsBadge = totalPointsCell.querySelector('.total-points-badge');
                if (totalPointsBadge) {
                    totalPointsBadge.textContent = totalPoints;
                }
                console.log(`  - Toplam puan gÃ¼ncellendi: ${totalPoints}`);
            }
            
            console.log(`âœ… Basit etkinlik satÄ±rÄ± ${index + 1} iÅŸlendi`);
        }
    });
    
    console.log(`ğŸ updateQuestionInfoForComponent tamamlandÄ±`);
}

/**
 * DeÄŸerlendirme giriÅŸi sekmesindeki soru bilgilerini gÃ¼ncelleme (puan, aÃ§Ä±klama, cevap anahtarÄ± sÄ±rasÄ±, Ã–Ã‡)
 */
function updateQuestionPointsInAssessmentTable(studentId) {
    console.log(`ğŸ”„ updateQuestionPointsInAssessmentTable Ã§aÄŸrÄ±ldÄ± - Ã–ÄŸrenci: ${studentId}`);
    
    // Bu Ã¶ÄŸrencinin tÃ¼m kaÄŸÄ±t sÄ±rasÄ± satÄ±rlarÄ±nÄ± bul
    const paperOrderRows = document.querySelectorAll(`tr[data-student-id="${studentId}"]`);
    console.log(`ğŸ“‹ Bulunan satÄ±r sayÄ±sÄ±: ${paperOrderRows.length}`);
    
    if (paperOrderRows.length === 0) {
        console.warn(`âš ï¸ ${studentId} Ã¶ÄŸrencisi iÃ§in hiÃ§ satÄ±r bulunamadÄ±!`);
        console.log(`ğŸ” TÃ¼m tr elementleri:`, document.querySelectorAll('tr[data-student-id]'));
        return;
    }
    
    paperOrderRows.forEach((row, index) => {
        const paperOrder = row.dataset.paperOrder;
        const componentId = row.dataset.componentId;
        
        console.log(`ğŸ“ SatÄ±r ${index + 1}:`);
        console.log(`  - paperOrder: ${paperOrder}`);
        console.log(`  - componentId: ${componentId}`);
        console.log(`  - row.dataset:`, row.dataset);
        
        if (paperOrder && componentId) {
            // Ã–ÄŸrencinin grubunu al
            const studentGroup = getStudentGroupForComponent(studentId, componentId);
            console.log(`ğŸ‘¥ Ã–ÄŸrenci grubu: ${studentGroup}`);
            
            // KaÄŸÄ±t sÄ±rasÄ±ndan gerÃ§ek soru ID'sini al
            const questionId = getQuestionIdByPaperOrder(studentId, parseInt(paperOrder), componentId);
            const answerKeyOrder = getAnswerKeyOrder(studentId, parseInt(paperOrder), componentId);
            const outcomes = getQuestionOutcomesForStudent(studentId, questionId, componentId);
            
            console.log(`ğŸ” Hesaplanan deÄŸerler:`);
            console.log(`  - questionId: ${questionId}`);
            console.log(`  - answerKeyOrder: ${answerKeyOrder}`);
            console.log(`  - outcomes:`, outcomes);
            
            // Etkinlik max puanÄ±nÄ± gÃ¼ncelle
            const pointsCell = row.querySelector('.question-points-cell');
            console.log(`ğŸ’° Points cell bulundu: ${!!pointsCell}`);
            
            if (pointsCell && questionId) {
                // Points cell'in data-activity-id deÄŸerini gÃ¼ncelle
                if (pointsCell.dataset.activityId !== questionId) {
                    console.log(`ğŸ”„ Points cell data-activity-id gÃ¼ncellendi: ${pointsCell.dataset.activityId} â†’ ${questionId}`);
                    pointsCell.dataset.activityId = questionId;
                }
                
                // Sorunun ID'si bulunduysa, doÄŸrudan o sorunun puanÄ±nÄ± al
                const question = findNodeById(questionId);
                const newPoints = question ? question.points : 0;
                console.log(`  - Soru bulundu: ${!!question}, Yeni puan: ${newPoints}`);
                pointsCell.textContent = newPoints;
                
                // Input alanÄ±nÄ±n max deÄŸerini gÃ¼ncelle
                const input = row.querySelector(`input[data-student-id="${studentId}"]`);
                console.log(`  - Input bulundu: ${!!input}`);
                
                if (input) {
                    // Input'un data-activity-id deÄŸerini gÃ¼ncelle (grup deÄŸiÅŸtiÄŸinde soru ID'si deÄŸiÅŸebilir)
                    if (questionId && input.dataset.activityId !== questionId) {
                        console.log(`ğŸ”„ Input data-activity-id gÃ¼ncellendi: ${input.dataset.activityId} â†’ ${questionId}`);
                        input.dataset.activityId = questionId;
                    }
                    
                    input.max = newPoints;
                    input.placeholder = `0-${newPoints}`;
                    input.title = `Bu Ã¶ÄŸrencinin grubundaki bu sorunun maksimum puanÄ±: ${newPoints}`;
                    
                    // Input yanÄ±na maksimum puan bilgisi ekle
                    let maxInfoSpan = input.parentElement.querySelector('.max-points-info');
                    if (!maxInfoSpan) {
                        maxInfoSpan = document.createElement('span');
                        maxInfoSpan.className = 'max-points-info';
                        maxInfoSpan.style.cssText = 'font-size: 10px; color: #666; margin-left: 5px; font-weight: bold;';
                        input.parentElement.appendChild(maxInfoSpan);
                    }
                    maxInfoSpan.textContent = `(max: ${newPoints})`;
                    
                    // EÄŸer mevcut deÄŸer yeni maksimumdan bÃ¼yÃ¼kse, uyarÄ± ver
                    const currentValue = parseFloat(input.value);
                    if (currentValue > newPoints) {
                        input.style.borderColor = '#ff6b6b';
                        input.title += ` (Mevcut deÄŸer ${currentValue} maksimumdan bÃ¼yÃ¼k!)`;
                        showModernToast(`${studentId} Ã¶ÄŸrencisinin kaÄŸÄ±t sÄ±rasÄ± ${paperOrder} sorusundaki puanÄ± (${currentValue}) yeni maksimumdan (${newPoints}) bÃ¼yÃ¼k!`, "warning");
                    } else {
                        input.style.borderColor = '';
                    }
                }
            }
            
            // Cevap anahtarÄ± sÄ±rasÄ±nÄ± gÃ¼ncelle
            const answerKeyCell = row.querySelector('.answer-key-order-cell');
            const answerKeyBadge = answerKeyCell?.querySelector('.answer-key-badge');
            console.log(`ğŸ”‘ Answer key cell bulundu: ${!!answerKeyCell}, badge bulundu: ${!!answerKeyBadge}`);
            
            if (answerKeyBadge) {
                const oldValue = answerKeyBadge.textContent;
                answerKeyBadge.textContent = answerKeyOrder || '?';
                console.log(`  - Cevap anahtarÄ± sÄ±rasÄ± gÃ¼ncellendi: ${oldValue} â†’ ${answerKeyOrder || '?'}`);
            }
            
            // Soru aÃ§Ä±klamasÄ±nÄ± gÃ¼ncelle
            const descriptionCell = row.querySelector('.question-description-cell');
            const questionDescBadge = descriptionCell?.querySelector('.question-desc-badge');
            console.log(`ğŸ“ Description cell bulundu: ${!!descriptionCell}, badge bulundu: ${!!questionDescBadge}`);
            
            if (questionDescBadge && questionId) {
                const question = findNodeById(questionId);
                const description = question ? question.description : 'Soru bulunamadÄ±';
                const oldValue = questionDescBadge.textContent;
                questionDescBadge.textContent = description;
                questionDescBadge.title = description; // Full text tooltip
                console.log(`  - Soru aÃ§Ä±klamasÄ± gÃ¼ncellendi: "${oldValue}" â†’ "${description}"`);
            }
            
            // Ã–Ã‡ deÄŸerini gÃ¼ncelle
            const outcomesCell = row.querySelector('.outcomes-cell');
            const outcomesBadge = outcomesCell?.querySelector('.outcomes-badge');
            console.log(`ğŸ¯ Outcomes cell bulundu: ${!!outcomesCell}, badge bulundu: ${!!outcomesBadge}`);
            
            if (outcomesBadge) {
                const oldValue = outcomesBadge.textContent;
                if (outcomes && outcomes.length > 0) {
                    outcomesBadge.textContent = outcomes.join(', ');
                    outcomesBadge.title = `Ã–ÄŸrenme Ã‡Ä±ktÄ±larÄ±: ${outcomes.join(', ')}`;
                    console.log(`  - Ã–Ã‡ gÃ¼ncellendi: "${oldValue}" â†’ "${outcomes.join(', ')}"`);
                } else {
                    outcomesBadge.textContent = '';
                    outcomesBadge.title = 'Ã–ÄŸrenme Ã§Ä±ktÄ±sÄ± tanÄ±mlanmamÄ±ÅŸ';
                    console.log(`  - Ã–Ã‡ temizlendi: "${oldValue}" â†’ ""`);
                }
            }
            
            console.log(`âœ… SatÄ±r ${index + 1} iÅŸlendi`);
        } else {
            console.warn(`âš ï¸ SatÄ±r ${index + 1} atlandÄ± - paperOrder veya componentId eksik`);
        }
    });
    
    console.log(`ğŸ updateQuestionPointsInAssessmentTable tamamlandÄ±`);
}

/**
 * Soru bilgilerini gÃ¼ncelleme
 */
function updateQuestionInfoDisplay(studentId, groupId) {
    const infoElement = document.getElementById(`questionInfo-${studentId}`);
    if (!infoElement || !groupId) {
        if (infoElement) infoElement.textContent = '';
        return;
    }
    
    // Grup haritalamalarÄ±nÄ± kontrol et
    const mappings = APP_STATE.courseData?.grupHaritalari?.[groupId];
    if (mappings) {
        const info = [];
        // DÃœZELTME: Veri yapÄ±sÄ± {position: questionId} formatÄ±nda
        Object.keys(mappings).forEach(position => {
            const questionId = mappings[position];
            info.push(`S${position}â†’${questionId}`);
        });
        infoElement.textContent = `(${groupId} grubunda: ${info.join(', ')})`;
    }
}

/**
 * TÃ¼m haritalama gÃ¶rÃ¼ntÃ¼leri gÃ¼ncelleme
 */
function updateAllMappingDisplays() {
    // Ã–ÄŸrenci tablosundaki tÃ¼m grup bilgilerini gÃ¼ncelle
    APP_STATE.studentData.forEach(student => {
        if (student.grup) {
            updateQuestionInfoDisplay(student.studentId, student.grup);
        }
    });
    
    // Tree'deki haritalama kontrollerini gÃ¼ncelle
    updateTreeMappingControls();
}

/**
 * Tree'deki haritalama kontrollerini gÃ¼ncelleme
 */
function updateTreeMappingControls() {
    // Bu fonksiyon tree render edildiÄŸinde Ã§aÄŸrÄ±lacak
    // renderNode fonksiyonunda haritalama kontrolleri eklenecek
}

/**
 * Ã–ÄŸrenci grubunu alma (etkinlik bazlÄ±)
 */
function getStudentGroup(studentId, componentId = null) {
    // EÄŸer componentId verilmiÅŸse, etkinlik bazlÄ± grup al
    if (componentId && APP_STATE.studentComponentGroups && 
        APP_STATE.studentComponentGroups[studentId] && 
        APP_STATE.studentComponentGroups[studentId][componentId]) {
        return APP_STATE.studentComponentGroups[studentId][componentId];
    }
    
    // Yoksa genel grup bilgisini al
    const student = APP_STATE.studentData.find(s => s.studentId === studentId);
    return student?.grup || 'A'; // VarsayÄ±lan grup A
}

/**
 * BileÅŸen grup sayÄ±sÄ±nÄ± alma
 */
function getComponentGroupCount(componentId) {
    const component = APP_STATE.courseData?.grupHaritalari?.[componentId];
    if (!component || !component.gruplar) {
        return 1; // En azÄ±ndan A grubu var
    }
    return component.gruplar.length;
}

/**
 * BileÅŸenin toplam puanÄ±nÄ± hesaplama (maksimum puan)
 */
function getComponentTotalPoints(componentId) {
    if (!componentId) return 0;
    
    try {
        const component = findNodeById(componentId);
        if (!component) return 0;
        
        // EÄŸer direkt points varsa kullan
        if (component.points) {
            return component.points;
        }
        
        // Alt Ã¶ÄŸelerin toplam puanÄ±nÄ± hesapla
        let totalPoints = 0;
        if (component.children && Array.isArray(component.children)) {
            component.children.forEach(child => {
                if (child.points) {
                    totalPoints += child.points;
                } else if (child.children) {
                    totalPoints += getComponentTotalPoints(child.id);
                }
            });
        }
        
        return totalPoints;
    } catch (error) {
        console.error(`getComponentTotalPoints hatasÄ± (${componentId}):`, error);
        return 0;
    }
}

/**
 * Ã–ÄŸrencinin belirli bir etkinlikten aldÄ±ÄŸÄ± toplam puanÄ± hesaplama (grup bazlÄ±)
 */
function getStudentTotalEarnedPointsForComponent(studentId, componentId) {
    if (!studentId || !componentId) return 0;
    
    try {
        const component = findNodeById(componentId);
        if (!component) return 0;
        
        let totalEarnedPoints = 0;
        
        // EÄŸer basit etkinlik ise (alt Ã¶ÄŸe yok)
        if (!component.children || component.children.length === 0) {
            const grade = getStudentGrade(studentId, componentId) || 0;
            return grade;
        }
        
        // Alt Ã¶ÄŸelerin aldÄ±ÄŸÄ± puanlarÄ± topla
        component.children.forEach(child => {
            if (child.children && child.children.length > 0) {
                // Alt Ã¶ÄŸenin de Ã§ocuklarÄ± varsa recursive Ã§aÄŸÄ±r
                totalEarnedPoints += getStudentTotalEarnedPointsForComponent(studentId, child.id);
            } else {
                // Basit alt Ã¶ÄŸe - Ã¶ÄŸrencinin aldÄ±ÄŸÄ± puanÄ± al
                const grade = getStudentGrade(studentId, child.id) || 0;
                totalEarnedPoints += grade;
            }
        });
        
        return parseFloat(totalEarnedPoints.toFixed(2));
    } catch (error) {
        console.error(`getStudentTotalEarnedPointsForComponent hatasÄ± (${studentId}, ${componentId}):`, error);
        return 0;
    }
}

/**
 * Ã–ÄŸrencinin grubuna gÃ¶re bileÅŸen maksimum puanÄ±nÄ± hesaplama
 */
function getStudentTotalMaxPointsForComponent(studentId, componentId) {
    if (!studentId || !componentId) return 0;
    
    try {
        const component = findNodeById(componentId);
        if (!component) return 0;
        
        let totalMaxPoints = 0;
        
        // EÄŸer basit etkinlik ise (alt Ã¶ÄŸe yok)
        if (!component.children || component.children.length === 0) {
            return component.points || 0;
        }
        
        // Alt Ã¶ÄŸelerin maksimum puanlarÄ±nÄ± topla (grup bazlÄ±)
        component.children.forEach(child => {
            if (child.children && child.children.length > 0) {
                // Alt Ã¶ÄŸenin de Ã§ocuklarÄ± varsa recursive Ã§aÄŸÄ±r
                totalMaxPoints += getStudentTotalMaxPointsForComponent(studentId, child.id);
            } else {
                // Basit alt Ã¶ÄŸe - Ã¶ÄŸrencinin grubuna gÃ¶re maksimum puanÄ± al
                const maxPoints = getQuestionPointsForStudentGroup(studentId, child.id, componentId);
                totalMaxPoints += maxPoints;
            }
        });
        
        return parseFloat(totalMaxPoints.toFixed(2));
    } catch (error) {
        console.error(`getStudentTotalMaxPointsForComponent hatasÄ± (${studentId}, ${componentId}):`, error);
        return 0;
    }
}

/**
 * Aktivitenin baÄŸlÄ± olduÄŸu Ã¼st bileÅŸeni bulma
 */
function getParentComponentId(activityId) {
    // A1.1 -> A1, F2.3 -> F2 gibi
    const parts = activityId.split('.');
    if (parts.length > 1) {
        return parts[0];
    }
    return activityId;
}

/**
 * Ã–ÄŸrencinin toplam puanlarÄ±nÄ± gÃ¼ncelleme
 */
function updateTotalPointsForStudent(studentId, activityId) {
    try {
        // Aktivitenin baÄŸlÄ± olduÄŸu bileÅŸeni bul
        const componentId = getParentComponentId(activityId) || activityId;
        
        // Bu Ã¶ÄŸrencinin bu bileÅŸenle ilgili tÃ¼m satÄ±rlarÄ±nÄ± bul
        const relatedRows = document.querySelectorAll(`tr[data-student-id="${studentId}"][data-component-id="${componentId}"], tr[data-student-id="${studentId}"] .total-points-cell[data-student-id="${studentId}"][data-activity-id="${activityId}"]`);
        
        relatedRows.forEach(row => {
            const totalPointsCell = row.querySelector('.total-points-cell');
            if (totalPointsCell) {
                const totalPoints = getStudentTotalEarnedPointsForComponent(studentId, componentId);
                totalPointsCell.textContent = totalPoints;
                
                // Badge iÃ§inde ise badge'i gÃ¼ncelle
                const totalPointsBadge = totalPointsCell.querySelector('.total-points-badge');
                if (totalPointsBadge) {
                    totalPointsBadge.textContent = totalPoints;
                }
            }
        });
        
        // Ã–ÄŸrenci bazlÄ± not giriÅŸi sekmesindeki badge'leri de gÃ¼ncelle
        const studentGradesBadges = document.querySelectorAll(`#studentGradesContainer .total-points-badge`);
        studentGradesBadges.forEach(badge => {
            const componentElement = badge.closest('[data-component-id]');
            if (componentElement && componentElement.dataset.componentId === componentId) {
                const totalPoints = getStudentTotalEarnedPointsForComponent(studentId, componentId);
                badge.textContent = totalPoints;
            }
        });
        
        console.log(`ğŸ”„ Toplam puanlar gÃ¼ncellendi - Ã–ÄŸrenci: ${studentId}, BileÅŸen: ${componentId}`);
        
    } catch (error) {
        console.error(`updateTotalPointsForStudent hatasÄ±:`, error);
    }
}

/**
 * BileÅŸendeki soru sayÄ±sÄ±nÄ± hesaplama
 */
function countQuestionsInComponent(componentId) {
    const node = findNodeById(componentId);
    if (!node || !node.children) {
        return 0;
    }
    
    let questionCount = 0;
    node.children.forEach(child => {
        if (isQuestionType(child.type) || isRubricType(child.type)) {
            questionCount++;
        }
    });
    
    return questionCount;
}

/**
 * TÃ¼m bileÅŸenlerin grup sayÄ±sÄ±nÄ± gÃ¼ncelleme
 */
function updateComponentGroupCounts() {
    document.querySelectorAll('.component-group-info').forEach(element => {
        const componentId = element.dataset.componentId;
        if (componentId) {
            const groupCount = getComponentGroupCount(componentId);
            const countElement = element.querySelector('.group-count');
            if (countElement) {
                countElement.textContent = `${groupCount} grup`;
            }
        }
    });
}

/**
 * Grup haritalama modal'Ä±nÄ± gÃ¶sterme
 */
function showGroupMappingModal(activityId) {
    const activity = findNodeById(activityId);
    if (!activity) return;
    
    APP_STATE.currentMappingNode = activity;
    mappingActivityName.textContent = activity.name;
    
    // Soru sayÄ±sÄ± bilgisini gÃ¶ster
    let parentNode;
    if (activity && activity.id.includes('.')) {
        const parentId = activity.id.substring(0, activity.id.lastIndexOf('.'));
        parentNode = findNodeById(parentId);
    }
    
    const relatedQuestions = parentNode && parentNode.children ? parentNode.children.length : 1;
    const infoElement = document.querySelector('#groupMappingModal .info-message p');
    if (infoElement) {
        infoElement.textContent = `Bu sorunun hangi gruplarda hangi sÄ±rada yer alacaÄŸÄ±nÄ± belirleyin (Toplam ${relatedQuestions} soru):`;
    }
    
    // Mevcut haritalamlarÄ± gÃ¶ster
    renderMappingRows(activityId);
    
    // HÄ±zlÄ± giriÅŸ alanÄ±nÄ± da gÃ¼ncelle
    updateBulkInputFromModalRows();
    
    // Hata mesajlarÄ±nÄ± temizle
    const errorContainer = document.getElementById('bulkErrorMessages');
    if (errorContainer) {
        errorContainer.innerHTML = '';
    }
    
    // Modal'Ä± gÃ¶ster
    openModernModal('groupMappingModal');
}

/**
 * Haritalama satÄ±rlarÄ±nÄ± render etme
 */
function renderMappingRows(activityId) {
    const mappingContainer = document.getElementById('mappingContainer');
    if (!mappingContainer) return;
    
    mappingContainer.innerHTML = '';
    
    // Bu sorunun hangi bileÅŸene ait olduÄŸunu bul
    const parentComponentId = getParentComponentId(activityId);
    if (!parentComponentId) {
        mappingContainer.innerHTML = '<p class="error-message">Soru iÃ§in bileÅŸen bulunamadÄ±</p>';
        return;
    }
    
    const component = APP_STATE.courseData?.grupHaritalari?.[parentComponentId];
    if (!component) {
        mappingContainer.innerHTML = '<p class="error-message">BileÅŸen grup verisi bulunamadÄ±</p>';
        return;
    }
    
    const groups = component.gruplar || ['A'];
    const activity = findNodeById(activityId);
    
    // Sadece bu aktivitenin Ã¼st dÃ¼ÄŸÃ¼mÃ¼ndeki sorularÄ± al
    let parentNode;
    if (activity && activity.id.includes('.')) {
        const parentId = activity.id.substring(0, activity.id.lastIndexOf('.'));
        parentNode = findNodeById(parentId);
    }
    
    const relatedQuestions = parentNode && parentNode.children ? parentNode.children.length : 1;
    const maxPosition = relatedQuestions;
    
    groups.forEach(groupName => {
        // DÃœZELTME: Veri yapÄ±sÄ± {position: questionId} formatÄ±nda
        const groupMappings = component.haritalar?.[groupName];
        const currentPosition = groupMappings ? Object.keys(groupMappings).find(pos => groupMappings[pos] === activityId) : null;
        
        const row = document.createElement('div');
        row.className = 'mapping-row-modal';
        row.innerHTML = `
            <select class="group-select" data-group="${groupName}">
                ${groups.map(g => `<option value="${g}" ${g === groupName ? 'selected' : ''}>Grup ${g}</option>`).join('')}
            </select>
            <select class="position-select" data-group="${groupName}">
                <option value="">SÄ±ra SeÃ§</option>
                ${Array.from({length: maxPosition}, (_, i) => {
                    const pos = i + 1;
                    const selected = currentPosition && currentPosition === pos.toString() ? 'selected' : '';
                    return `<option value="${pos}" ${selected}>${pos}. Soru</option>`;
                }).join('')}
            </select>
            <button class="remove-mapping-btn" onclick="removeMappingRow(this, '${groupName}', '${activityId}')">Ã—</button>
        `;
        
        // Event listener'lar ekle - sadece gÃ¶rsel gÃ¼ncelleme iÃ§in
        const groupSelect = row.querySelector('.group-select');
        const positionSelect = row.querySelector('.position-select');
        
        // Sadece hÄ±zlÄ± giriÅŸ alanÄ±nÄ± gÃ¼ncelle, veriyi kaydetme
        groupSelect.addEventListener('change', () => {
            updateBulkInputFromModalRows();
        });
        
        positionSelect.addEventListener('change', () => {
            updateBulkInputFromModalRows();
        });
        
        mappingContainer.appendChild(row);
    });
}

/**
 * Haritalama satÄ±rÄ± kaldÄ±rma (sadece modal'dan, veri kaydedilmez)
 */
function removeMappingRow(button, groupName, activityId) {
    // Sadece satÄ±rÄ± kaldÄ±r, veriyi kaydetme
    button.closest('.mapping-row-modal').remove();
    
    // HÄ±zlÄ± giriÅŸ alanÄ±nÄ± gÃ¼ncelle
    updateBulkInputFromModalRows();
    
    showModernToast(`${groupName} grubundan haritalama kaldÄ±rÄ±ldÄ± (geÃ§ici)`, "info");
}

/**
 * Haritalama kaydetme
 */
function saveGroupMapping() {
    if (!APP_STATE.currentMappingNode) return;
    
    const activityId = APP_STATE.currentMappingNode.id;
    const mappingContainer = document.getElementById('mappingContainer');
    
    // Validation: Duplicate ve hata kontrolÃ¼
    const newMappings = new Map(); // groupId -> position
    const usedPositions = new Map(); // groupId -> Set<position>
    let hasErrors = false;
    const errors = [];
    
    // TÃ¼m grup seÃ§icilerini kontrol et ve yeni haritalamayÄ± topla
    mappingContainer.querySelectorAll('.mapping-row-modal').forEach(row => {
        const groupSelect = row.querySelector('.group-select');
        const positionSelect = row.querySelector('.position-select');
        
        const groupId = groupSelect.value;
        const position = parseInt(positionSelect.value);
        
        if (groupId && position) {
            // AynÄ± grup iÃ§in duplicate position kontrolÃ¼
            if (!usedPositions.has(groupId)) {
                usedPositions.set(groupId, new Set());
            }
            
            if (usedPositions.get(groupId).has(position)) {
                hasErrors = true;
                errors.push(`Grup ${groupId}'da ${position}. sÄ±ra birden fazla kez atanmÄ±ÅŸ`);
            } else {
                usedPositions.get(groupId).add(position);
                newMappings.set(groupId, position);
            }
        }
    });
    
    // Hata varsa kullanÄ±cÄ±yÄ± bilgilendir
    if (hasErrors) {
        showModernToast(`Haritalama hatalarÄ±:<br>${errors.join('<br>')}`, "error", 6000);
        return;
    }
    
    // Bu sorunun hangi bileÅŸene ait olduÄŸunu bul
    const parentComponentId = getParentComponentId(activityId);
    if (!parentComponentId) {
        showModernToast('Soru iÃ§in bileÅŸen bulunamadÄ±', 'error');
        return;
    }
    
    const component = APP_STATE.courseData?.grupHaritalari?.[parentComponentId];
    if (!component || !component.haritalar) {
        showModernToast('BileÅŸen grup verisi bulunamadÄ±', 'error');
        return;
    }
    
    // Ã–nce bu sorunun mevcut haritalamalarÄ±nÄ± kontrol et ve sil
    const oldMappings = [];
    Object.keys(component.haritalar).forEach(existingGroupName => {
        if (component.haritalar[existingGroupName]) {
            const existingPosition = Object.keys(component.haritalar[existingGroupName]).find(pos => 
                component.haritalar[existingGroupName][pos] === activityId
            );
            if (existingPosition) {
                oldMappings.push(`Grup ${existingGroupName} (${existingPosition}. sÄ±ra)`);
                // Eski pozisyonu sil
                delete component.haritalar[existingGroupName][existingPosition];
            }
        }
    });
    
    // Yeni haritalamayÄ± uygula
    // DÃœZELTME: Veri yapÄ±sÄ± {position: questionId} formatÄ±nda
    newMappings.forEach((position, groupName) => {
        if (!component.haritalar[groupName]) {
            component.haritalar[groupName] = {};
        }
        
        component.haritalar[groupName][position.toString()] = activityId;
    });
    
    // KullanÄ±cÄ±ya bilgi ver
    const activity = findNodeById(activityId);
    const activityName = activity ? activity.name : activityId;
    
    let message = `ğŸ“ "${activityName}" sorusu haritalama kaydedildi:`;
    if (oldMappings.length > 0) {
        message += `\nğŸ—‘ï¸ Eski haritalamalar silindi: ${oldMappings.join(', ')}`;
    }
    if (newMappings.size > 0) {
        const newMappingList = Array.from(newMappings.entries()).map(([group, pos]) => `Grup ${group} (${pos}. sÄ±ra)`);
        message += `\nâœ… Yeni haritalamalar: ${newMappingList.join(', ')}`;
    }
    
    showModernToast(message, "success", 4000);
    
    // Modal'Ä± kapat
    closeModernModal('groupMappingModal');
    
    // GÃ¶rÃ¼ntÃ¼leri gÃ¼ncelle
    updateAllMappingDisplays();
    updateTreeMappingControls();
    
    // AÄŸaÃ§taki buton renklerini gÃ¼ncelle
    updateGroupMappingColors();
    
    // Ana ekran grup giriÅŸlerini gÃ¼ncelle
    updateAllInlineGroupInputs();
    
    APP_STATE.currentMappingNode = null;
}

/**
 * Yeni haritalama satÄ±rÄ± ekleme
 */
async function addMappingRow() {
    if (!APP_STATE.currentMappingNode) return;
    
    const activityId = APP_STATE.currentMappingNode.id;
    
    // Bu sorunun hangi bileÅŸene ait olduÄŸunu bul
    const parentComponentId = getParentComponentId(activityId);
    if (!parentComponentId) {
        showModernToast("Soru iÃ§in bileÅŸen bulunamadÄ±", "error");
        return;
    }
    
    const component = APP_STATE.courseData?.grupHaritalari?.[parentComponentId];
    if (!component) {
        showModernToast("BileÅŸen grup verisi bulunamadÄ±", "error");
        return;
    }
    
    const groups = component.gruplar || ['A'];
    const groupNames = ['B', 'C', 'D', 'E', 'F', 'G', 'H'];
    const newGroupName = groupNames.find(name => !groups.includes(name));
    
    if (!newGroupName) {
        showModernToast("Bu etkinlik iÃ§in maksimum grup sayÄ±sÄ±na ulaÅŸÄ±ldÄ± (H grubuna kadar)", "warning");
        return;
    }
    
    // Modern confirm dialog ile onay al
    const confirmed = await showModernConfirm(
        'EtkinliÄŸe Grup Ekleme OnayÄ±',
        `${getComponentDisplayName(parentComponentId)} etkinliÄŸine grup ${newGroupName} eklenecek.\n\nBu grup eklendikten sonra:\nâ€¢ Haritalama modalÄ±nda gÃ¶rÃ¼necek\nâ€¢ Ã–ÄŸrenci gruplarÄ±nda seÃ§ilebilir olacak\nâ€¢ A grubunun kopyasÄ± olarak oluÅŸturulacak`,
        {
            confirmText: 'Evet, Ekle',
            cancelText: 'Ä°ptal',
            headerClass: 'success-action',
            iconClass: 'success'
        }
    );
    
    if (!confirmed) {
        return;
    }
    
    // Yeni grubu listeye ekle
    component.gruplar.push(newGroupName);
    
    // A grubunun kopyasÄ± olarak mapping oluÅŸtur (derin kopya)
    const groupAMapping = component.haritalar.A || {};
    component.haritalar[newGroupName] = JSON.parse(JSON.stringify(groupAMapping));
    
    // EÄŸer A grubunda mapping yoksa, varsayÄ±lan 1:1 mapping oluÅŸtur
    if (Object.keys(groupAMapping).length === 0) {
        const componentNode = findNodeById(parentComponentId);
        if (componentNode && componentNode.children) {
            let questionIndex = 1;
            componentNode.children.forEach(childNode => {
                if (isQuestionType(childNode.type) || isRubricType(childNode.type)) {
                    // DÃœZELTME: Veri yapÄ±sÄ± {position: questionId} formatÄ±nda
                    component.haritalar.A[questionIndex.toString()] = childNode.id;
                    component.haritalar[newGroupName][questionIndex.toString()] = childNode.id;
                    questionIndex++;
                }
            });
        }
    }
    
    // UI'larÄ± gÃ¼ncelle
    updateGroupSelectors();
    updateStudentTable();
    updateAssessmentView();
    updateAllInlineGroupInputs();
    updateAllMappingDisplays();
    updateGroupMappingColors();
    
    // Grup sayÄ±sÄ±nÄ± gÃ¼ncelle
    updateComponentGroupCounts();
    
    // Modal iÃ§eriÄŸini yeniden render et
    renderMappingRows(activityId);
    
    showModernToast(`${getComponentDisplayName(parentComponentId)} etkinliÄŸine grup ${newGroupName} baÅŸarÄ±yla eklendi`, "success");
}

// =====================================================
// EVENT LÄ°STENER'LAR
// =====================================================

// Grup butonlarÄ± HTML'den kaldÄ±rÄ±ldÄ± - artÄ±k bileÅŸen bazlÄ± grup yÃ¶netimi kullanÄ±lÄ±yor

// Haritalama kaydetme butonu
if (saveMappingBtn) {
    saveMappingBtn.addEventListener('click', saveGroupMapping);
}

// Haritalama satÄ±rÄ± ekleme butonu
if (addMappingRowBtn) {
    addMappingRowBtn.addEventListener('click', addMappingRow);
}

// Toplu grup haritalama butonu
const applyBulkMappingBtn = document.getElementById('applyBulkMapping');
if (applyBulkMappingBtn) {
    applyBulkMappingBtn.addEventListener('click', applyBulkMapping);
}

/**
 * Ã–ÄŸrenci tablosundaki grup gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ gÃ¼ncelleme
 */
function updateStudentTableGroupDisplay(studentId, groupId) {
    // Bu fonksiyon artÄ±k kullanÄ±lmÄ±yor - Ã¶ÄŸrenci listesinde grup gÃ¶sterimi yok
    // Grup bilgileri ayrÄ± bir kartta gÃ¶steriliyor
}

/**
 * DeÄŸerlendirme giriÅŸi sekmesindeki grup gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ gÃ¼ncelleme
 */
function updateAssessmentGroupDisplay(studentId, groupId) {
    const assessmentContainer = document.getElementById('assessmentContainer');
    if (assessmentContainer) {
        // TÃ¼m assessment containerÄ±ndaki grup seÃ§icileri gÃ¼ncelle
        assessmentContainer.querySelectorAll(`select[data-student-id="${studentId}"]`).forEach(select => {
            if (select.value !== groupId) {
                select.value = groupId;
            }
        });
        
        // EÄŸer assessment sekmesi aktif ise ve seÃ§enekler arasÄ±nda grup yoksa view'Ä± yenile
        const activeTab = document.querySelector('.nav-content.active');
        if (activeTab && activeTab.id === 'assessment-content') {
            const groupOption = assessmentContainer.querySelector(`select[data-student-id="${studentId}"] option[value="${groupId}"]`);
            if (!groupOption) {
                // Grup seÃ§eneÄŸi yoksa assessment view'Ä±nÄ± yenile
                updateAssessmentView();
            }
        }
    }
}

/**
 * Ã–ÄŸrenci bazlÄ± not giriÅŸi sekmesindeki grup gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ gÃ¼ncelleme
 */
function updateStudentGradesGroupDisplay(studentId, groupId) {
    const studentGradesContainer = document.getElementById('studentGradesContainer');
    if (studentGradesContainer) {
        const groupSelector = studentGradesContainer.querySelector(`select[data-student-id="${studentId}"]`);
        if (groupSelector && groupSelector.value !== groupId) {
            groupSelector.value = groupId;
        }
    }
}



/**
 * Grup haritalama durumunu kontrol etme
 * @param {string} nodeId - Kontrol edilecek dÃ¼ÄŸÃ¼m ID'si
 * @returns {Object} - Haritalama durumu bilgisi
 */
function checkGroupMappingStatus(nodeId) {
    // Bu sorunun hangi bileÅŸene ait olduÄŸunu bul
    const parentComponentId = getParentComponentId(nodeId);
    if (!parentComponentId) {
        return { isComplete: true, missingGroups: [], duplicatePositions: {}, hasMapping: false };
    }
    
    // Bu bileÅŸenin gruplarÄ±nÄ± al
    const component = APP_STATE.courseData?.grupHaritalari?.[parentComponentId];
    const activeGroups = component?.gruplar || ['A'];
    const mappingStatus = {
        isComplete: true,
        missingGroups: [],
        duplicatePositions: {},
        hasMapping: false
    };
    
    if (activeGroups.length <= 1) {
        // Tek grup varsa haritalama gerekmez
        mappingStatus.isComplete = true;
        return mappingStatus;
    }
    
    // Her grup iÃ§in kontrol et
    activeGroups.forEach(groupId => {
        const groupMappings = component?.haritalar?.[groupId];
        // DÃœZELTME: Veri yapÄ±sÄ± {position: questionId} formatÄ±nda
        const hasMapping = groupMappings && Object.values(groupMappings).includes(nodeId);
        if (!hasMapping) {
            mappingStatus.missingGroups.push(groupId);
            mappingStatus.isComplete = false;
        } else {
            mappingStatus.hasMapping = true;
        }
    });
    
    // AynÄ± pozisyonda birden fazla soru var mÄ± kontrol et
    const positionGroups = {};
    activeGroups.forEach(groupId => {
        const groupMappings = component?.haritalar?.[groupId];
        if (groupMappings) {
            // DÃœZELTME: Veri yapÄ±sÄ± {position: questionId} formatÄ±nda
            const position = Object.keys(groupMappings).find(pos => groupMappings[pos] === nodeId);
            if (position) {
            if (!positionGroups[position]) {
                positionGroups[position] = [];
            }
            positionGroups[position].push(groupId);
            }
        }
    });
    
    // Duplicate pozisyonlarÄ± tespit et
    Object.keys(positionGroups).forEach(position => {
        if (positionGroups[position].length > 1) {
            mappingStatus.duplicatePositions[position] = positionGroups[position];
            mappingStatus.isComplete = false;
        }
    });
    
    return mappingStatus;
}

/**
 * Grup haritalama durumuna gÃ¶re CSS sÄ±nÄ±fÄ± dÃ¶ndÃ¼rme
 * @param {string} nodeId - DÃ¼ÄŸÃ¼m ID'si
 * @returns {string} - CSS sÄ±nÄ±f adÄ±
 */
function getGroupMappingStatusClass(nodeId) {
    const status = checkGroupMappingStatus(nodeId);
    
    // Bu sorunun hangi bileÅŸene ait olduÄŸunu bul
    const parentComponentId = getParentComponentId(nodeId);
    if (!parentComponentId) {
        return 'group-single';
    }
    
    const component = APP_STATE.courseData?.grupHaritalari?.[parentComponentId];
    const activeGroups = component?.gruplar || ['A'];
    
    if (activeGroups.length <= 1) {
        return 'group-single'; // Tek grup
    }
    
    if (!status.hasMapping) {
        return 'group-unmapped'; // HiÃ§ haritalama yok
    }
    
    if (!status.isComplete) {
        if (status.missingGroups.length > 0) {
            return 'group-incomplete'; // Eksik gruplar var
        }
        if (Object.keys(status.duplicatePositions).length > 0) {
            return 'group-duplicate'; // Duplicate pozisyonlar var
        }
    }
    
    return 'group-complete'; // Tam haritalanmÄ±ÅŸ
}

/**
 * Toplu grup haritalama iÃ§in format ayrÄ±ÅŸtÄ±rma
 * @param {string} input - GiriÅŸ metni (Ã¶rn: "A:1,B:2,C:3")
 * @param {string} nodeId - DÃ¼ÄŸÃ¼m ID'si
 * @returns {Object} - AyrÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ haritalama
 */
function parseBulkGroupMapping(input, nodeId) {
    const mappings = {};
    const errors = [];
    
    if (!input.trim()) {
        return { mappings, errors };
    }
    
    // Bu sorunun hangi bileÅŸene ait olduÄŸunu bul
    const parentComponentId = getParentComponentId(nodeId);
    if (!parentComponentId) {
        errors.push('Soru iÃ§in bileÅŸen bulunamadÄ±');
        return { mappings, errors };
    }
    
    const component = APP_STATE.courseData?.grupHaritalari?.[parentComponentId];
    if (!component) {
        errors.push('BileÅŸen grup verisi bulunamadÄ±');
        return { mappings, errors };
    }
    
    const availableGroups = component.gruplar || ['A'];
    const parts = input.split(',').map(p => p.trim());
    
    parts.forEach(part => {
        const colonIndex = part.indexOf(':');
        if (colonIndex === -1) {
            errors.push(`GeÃ§ersiz format: "${part}". "Grup:Pozisyon" formatÄ±nda olmalÄ±.`);
            return;
        }
        
        const groupId = part.substring(0, colonIndex).trim().toUpperCase();
        const position = part.substring(colonIndex + 1).trim();
        
        if (!availableGroups.includes(groupId)) {
            errors.push(`GeÃ§ersiz grup: "${groupId}". Bu bileÅŸende mevcut gruplar: ${availableGroups.join(', ')}`);
            return;
        }
        
        if (!/^\d+$/.test(position) || parseInt(position) < 1) {
            errors.push(`GeÃ§ersiz pozisyon: "${position}". Pozitif sayÄ± olmalÄ±.`);
            return;
        }
        
        mappings[groupId] = position;
    });
    
    return { mappings, errors };
}

/**
 * Toplu grup haritalama uygulama
 */
function applyBulkMapping() {
    try {
        const bulkInput = document.getElementById('bulkMappingInput');
        const errorContainer = document.getElementById('bulkErrorMessages');
        
        if (!bulkInput || !APP_STATE.currentMappingNode) {
            return;
        }
        
        const input = bulkInput.value.trim();
        const nodeId = APP_STATE.currentMappingNode.id;
        
        // Hata mesajlarÄ±nÄ± temizle
        errorContainer.innerHTML = '';
        
        // GiriÅŸ ayrÄ±ÅŸtÄ±rma
        const { mappings, errors } = parseBulkGroupMapping(input, nodeId);
        
        // Hata varsa gÃ¶ster
        if (errors.length > 0) {
            errors.forEach(error => {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'bulk-error-message';
                errorDiv.textContent = error;
                errorContainer.appendChild(errorDiv);
            });
            return;
        }
        
        // BaÅŸarÄ±lÄ± giriÅŸ
        if (Object.keys(mappings).length > 0) {
            // Modal satÄ±rlarÄ±nÄ± gÃ¼ncelle (bu haritalamayÄ± da CourseData'ya kaydeder)
            updateModalRowsFromBulkInput(mappings);
            
            // BaÅŸarÄ± animasyonu
            bulkInput.classList.add('success');
            setTimeout(() => {
                bulkInput.classList.remove('success');
            }, 600);
            
            showModernToast('Toplu haritalama baÅŸarÄ±yla uygulandÄ±', 'success');
        }
        
    } catch (error) {
        console.error('Toplu haritalama hatasÄ±:', error);
        showModernToast('Toplu haritalama uygulanamadÄ±!', 'error');
    }
}

/**
 * Grup haritalama modal'Ä±nÄ± kapattÄ±ÄŸÄ±nda aÄŸaÃ§taki buton renklerini gÃ¼ncelle
 */
function updateGroupMappingColors() {
    document.querySelectorAll('.btn-group-mapping').forEach(button => {
        const nodeId = button.dataset.nodeId;
        if (nodeId) {
            // Eski sÄ±nÄ±flarÄ± kaldÄ±r
            button.classList.remove('group-single', 'group-unmapped', 'group-incomplete', 'group-duplicate', 'group-complete');
            // Yeni sÄ±nÄ±fÄ± ekle
            button.classList.add(getGroupMappingStatusClass(nodeId));
        }
    });
}

/**
 * Modal satÄ±rlarÄ±ndan hÄ±zlÄ± giriÅŸ alanÄ±nÄ± gÃ¼ncelleme
 */
function updateBulkInputFromModalRows() {
    if (!APP_STATE.currentMappingNode) return;
    
    const nodeId = APP_STATE.currentMappingNode.id;
    const bulkInput = document.getElementById('bulkMappingInput');
    
    if (!bulkInput) return;
    
    // Bu sorunun hangi bileÅŸene ait olduÄŸunu bul
    const parentComponentId = getParentComponentId(nodeId);
    if (!parentComponentId) return;
    
    const component = APP_STATE.courseData?.grupHaritalari?.[parentComponentId];
    if (!component || !component.haritalar) return;
    
    const mappingPairs = [];
    const groups = component.gruplar || ['A'];
    
    // Her grup iÃ§in haritalama bilgisini topla
    // DÃœZELTME: Veri yapÄ±sÄ± {position: questionId} formatÄ±nda
    groups.forEach(groupName => {
        const groupMappings = component.haritalar[groupName];
        if (groupMappings) {
            const position = Object.keys(groupMappings).find(pos => groupMappings[pos] === nodeId);
            if (position) {
                mappingPairs.push(`${groupName}:${position}`);
            }
        }
    });
    
    // Alfabetik sÄ±rala
    mappingPairs.sort();
    
    // HÄ±zlÄ± giriÅŸ alanÄ±nÄ± gÃ¼ncelle
    bulkInput.value = mappingPairs.join(',');
}

/**
 * HÄ±zlÄ± giriÅŸten modal satÄ±rlarÄ±nÄ± gÃ¼ncelleme
 */
function updateModalRowsFromBulkInput(mappings) {
    if (!APP_STATE.currentMappingNode) return;
    
    const nodeId = APP_STATE.currentMappingNode.id;
    
    // Bu sorunun hangi bileÅŸene ait olduÄŸunu bul
    const parentComponentId = getParentComponentId(nodeId);
    if (!parentComponentId) return;
    
    const component = APP_STATE.courseData?.grupHaritalari?.[parentComponentId];
    if (!component || !component.haritalar) return;
    
    // HaritalamayÄ± CourseData'ya uygula
    // DÃœZELTME: Veri yapÄ±sÄ± {position: questionId} formatÄ±nda
    Object.keys(mappings).forEach(groupName => {
        if (!component.haritalar[groupName]) {
            component.haritalar[groupName] = {};
        }
        const position = mappings[groupName];
        component.haritalar[groupName][position] = nodeId;
    });
    
    // Modal satÄ±rlarÄ±nÄ± yenile
    renderMappingRows(nodeId);
}

/**
 * Mevcut haritalama metnini getirme
 * @param {string} nodeId - DÃ¼ÄŸÃ¼m ID'si
 * @returns {string} - Haritalama metni (Ã¶rn: "A:1,B:2,C:3")
 */
function getCurrentMappingText(nodeId) {
    try {
        // Ã–nce bu sorunun hangi bileÅŸene ait olduÄŸunu bul
        const parentComponentId = getParentComponentId(nodeId);
        if (!parentComponentId) {
            return '';
        }
        
        const component = APP_STATE.courseData?.grupHaritalari?.[parentComponentId];
        if (!component || !component.haritalar) {
            return '';
        }
        
        const mappingPairs = [];
        const groups = component.gruplar || ['A'];
        
        groups.forEach(groupName => {
            const groupMapping = component.haritalar[groupName];
            if (groupMapping) {
                // DÃœZELTME: Veri yapÄ±sÄ± {position: questionId} formatÄ±nda
                // Bu sorunun hangi pozisyonda olduÄŸunu bul
                const position = Object.keys(groupMapping).find(pos => groupMapping[pos] === nodeId);
                if (position) {
                    mappingPairs.push(`${groupName}:${position}`);
                }
            }
        });
        
        // Duplicate'leri temizle
        const uniquePairs = [...new Set(mappingPairs)];
        uniquePairs.sort();
        const result = uniquePairs.join(',');
        
        console.log(`ğŸ“‹ getCurrentMappingText(${nodeId}): "${result}"`, {
            parentComponentId,
            component: component ? {
                gruplar: component.gruplar,
                mappingKeys: Object.keys(component.haritalar || {}),
                fullMappings: component.haritalar
            } : null,
            mappingPairs: uniquePairs,
            foundMappings: mappingPairs
        });
        
        return result;
    } catch (error) {
        console.error('getCurrentMappingText hatasÄ±:', error);
        return '';
    }
}

/**
 * Ana ekran hÄ±zlÄ± grup haritalama uygulama
 * @param {string} nodeId - DÃ¼ÄŸÃ¼m ID'si
 */
function applyInlineGroupMapping(nodeId) {
    try {
        const inputElement = document.querySelector(`.nodeGroupMapping[data-node-id="${nodeId}"]`);
        const buttonElement = document.querySelector(`.btn-apply-group-mapping[data-node-id="${nodeId}"]`);
        
        if (!inputElement) return;
        
        const input = inputElement.value.trim();
        
        // Buton loading durumu
        if (buttonElement) {
            buttonElement.classList.add('loading');
        }
        
        // Input'u normal duruma getir
        inputElement.classList.remove('success', 'error');
        
        // GiriÅŸ ayrÄ±ÅŸtÄ±rma
        const { mappings, errors } = parseBulkGroupMapping(input, nodeId);
        
        // Hata varsa gÃ¶ster
        if (errors.length > 0) {
            inputElement.classList.add('error');
            showModernToast(errors.join('<br>'), 'error', 4000);
            
            if (buttonElement) {
                buttonElement.classList.remove('loading');
            }
            return;
        }
        
        // BaÅŸarÄ±lÄ± giriÅŸ
        if (Object.keys(mappings).length > 0) {
            // Bu sorunun hangi bileÅŸene ait olduÄŸunu bul
            const parentComponentId = getParentComponentId(nodeId);
            if (!parentComponentId) {
                showModernToast('Soru iÃ§in bileÅŸen bulunamadÄ±', 'error');
                return;
            }
            
            const component = APP_STATE.courseData?.grupHaritalari?.[parentComponentId];
            if (!component || !component.haritalar) {
                showModernToast('BileÅŸen grup verisi bulunamadÄ±', 'error');
                return;
            }
            
            // Ã–nce mevcut haritalamlarÄ± kontrol et ve eski pozisyonlarÄ± temizle
            const oldMappings = [];
            Object.keys(component.haritalar).forEach(existingGroupName => {
                if (component.haritalar[existingGroupName]) {
                    const existingPosition = Object.keys(component.haritalar[existingGroupName]).find(pos => 
                        component.haritalar[existingGroupName][pos] === nodeId
                    );
                    if (existingPosition) {
                        // EÄŸer yeni haritalamada bu grup yoksa, eski pozisyonu kaydet
                        if (!mappings[existingGroupName]) {
                            oldMappings.push(`Grup ${existingGroupName} (${existingPosition}. sÄ±ra)`);
                        }
                        // Eski pozisyonu sil
                        delete component.haritalar[existingGroupName][existingPosition];
                    }
                }
            });
            
            // HaritalamayÄ± uygula
            // DÃœZELTME: Veri yapÄ±sÄ± {position: questionId} formatÄ±nda
            Object.keys(mappings).forEach(groupName => {
                if (!component.haritalar[groupName]) {
                    component.haritalar[groupName] = {};
                }
                const position = mappings[groupName];
                component.haritalar[groupName][position] = nodeId;
            });
            
            // BaÅŸarÄ± animasyonu
            inputElement.classList.add('success');
            setTimeout(() => {
                inputElement.classList.remove('success');
            }, 600);
            
            // Grup butonunun rengini gÃ¼ncelle
            updateGroupMappingColors();
            
            // DeÄŸerlendirme sekmesini gÃ¼ncelle
            setTimeout(() => {
                updateAssessmentView();
            }, 100);
            
            // KullanÄ±cÄ±ya bilgi ver
            const activity = findNodeById(nodeId);
            const activityName = activity ? activity.name : nodeId;
            const newMappingText = Object.keys(mappings).map(g => `Grup ${g} (${mappings[g]}. sÄ±ra)`).join(', ');
            
            if (oldMappings.length > 0) {
                showModernToast(
                    `ğŸ“ "${activityName}" sorusu:<br>` +
                    `ğŸ—‘ï¸ Åu gruplardan silindi: ${oldMappings.join(', ')}<br>` +
                    `âœ… Yeni atama: ${newMappingText}`, 
                    'info', 
                    4000
                );
            } else {
                showModernToast(
                    `ğŸ“ "${activityName}" sorusu:<br>` +
                    `âœ… Grup haritalama uygulandÄ±: ${newMappingText}`, 
                    'success', 
                    3000
                );
            }
        } else {
            // BoÅŸ giriÅŸ - mevcut haritalamayÄ± temizle
            const parentComponentId = getParentComponentId(nodeId);
            if (parentComponentId) {
                const component = APP_STATE.courseData?.grupHaritalari?.[parentComponentId];
                if (component && component.haritalar) {
                    // DÃœZELTME: Veri yapÄ±sÄ± {position: questionId} formatÄ±nda
                    Object.keys(component.haritalar).forEach(groupName => {
                        if (component.haritalar[groupName]) {
                            // Bu sorunun pozisyonunu bul ve sil
                            const position = Object.keys(component.haritalar[groupName]).find(pos => 
                                component.haritalar[groupName][pos] === nodeId
                            );
                            if (position) {
                                delete component.haritalar[groupName][position];
                            }
                        }
                    });
                }
            }
            
            updateGroupMappingColors();
            showModernToast('Grup haritalama temizlendi', 'info', 2000);
        }
        
        // Loading durumunu kaldÄ±r
        if (buttonElement) {
            setTimeout(() => {
                buttonElement.classList.remove('loading');
            }, 300);
        }
        
    } catch (error) {
        console.error('Ana ekran grup haritalama hatasÄ±:', error);
        showModernToast('Grup haritalama uygulanamadÄ±!', 'error');
        
        const buttonElement = document.querySelector(`.btn-apply-group-mapping[data-node-id="${nodeId}"]`);
        if (buttonElement) {
            buttonElement.classList.remove('loading');
        }
    }
}

/**
 * Silinen soru/rubrik iÃ§in grup haritalamalarÄ±nÄ± temizle ve pozisyonlarÄ± yeniden dÃ¼zenle
 * @param {string} nodeId - Silinen dÃ¼ÄŸÃ¼m ID'si
 */
function cleanupGroupMappingsForDeletedNode(nodeId) {
    try {
        if (!APP_STATE.courseData?.grupHaritalari) return;
        
        console.log(`ğŸ§¹ Silinen dÃ¼ÄŸÃ¼m iÃ§in grup haritalama temizliÄŸi ve yeniden dÃ¼zenleme: ${nodeId}`);
        
        // Bu sorunun hangi bileÅŸene ait olduÄŸunu bul
        const parentComponentId = getParentComponentId(nodeId);
        if (!parentComponentId) {
            console.log(`âš ï¸ Parent component bulunamadÄ±: ${nodeId}`);
            return;
        }
        
        const component = APP_STATE.courseData.grupHaritalari[parentComponentId];
        if (!component || !component.haritalar) {
            console.log(`âš ï¸ Component mapping bulunamadÄ±: ${parentComponentId}`);
            return;
        }
        
        let cleanupCount = 0;
        
        // Her grup iÃ§in haritalamayÄ± temizle ve yeniden dÃ¼zenle
        Object.keys(component.haritalar).forEach(groupName => {
            if (component.haritalar[groupName]) {
                const groupMapping = component.haritalar[groupName];
                
                console.log(`ğŸ” Grup ${groupName} - silme Ã¶ncesi mapping:`, {...groupMapping});
                
                // 1. Silinen sorunun pozisyonunu bul
                let deletedPosition = null;
                Object.keys(groupMapping).forEach(position => {
                    if (groupMapping[position] === nodeId) {
                        deletedPosition = parseInt(position);
                        delete groupMapping[position];
                        cleanupCount++;
                        console.log(`ğŸ—‘ï¸ Silindi: Grup ${groupName}, Pozisyon ${position}, Soru ${nodeId}`);
                    }
                });
                
                // 2. EÄŸer silinen pozisyon varsa, sonraki pozisyonlarÄ± kaydÄ±r
                if (deletedPosition !== null) {
                    console.log(`ğŸ“ Pozisyon kaymasÄ± baÅŸlatÄ±lÄ±yor: ${deletedPosition} pozisyonundan itibaren`);
                    
                    // Mevcut pozisyonlarÄ± sÄ±rala
                    const sortedPositions = Object.keys(groupMapping)
                        .map(pos => parseInt(pos))
                        .filter(pos => !isNaN(pos))
                        .sort((a, b) => a - b);
                    
                    console.log(`ğŸ“‹ SÄ±ralÄ± pozisyonlar:`, sortedPositions);
                    
                    // Yeni mapping oluÅŸtur - pozisyonlarÄ± sÄ±kÄ±ÅŸtÄ±r
                    const newMapping = {};
                    let newPosition = 1;
                    
                    sortedPositions.forEach(oldPosition => {
                        const questionId = groupMapping[oldPosition.toString()];
                        if (questionId) {
                            newMapping[newPosition.toString()] = questionId;
                            console.log(`ğŸ”„ Pozisyon deÄŸiÅŸimi: ${questionId} => ${oldPosition} â†’ ${newPosition}`);
                            newPosition++;
                        }
                    });
                    
                    // Eski mapping'i temizle ve yenisini ata
                    component.haritalar[groupName] = newMapping;
                    
                    console.log(`âœ… Grup ${groupName} - yeniden dÃ¼zenleme sonrasÄ±:`, {...newMapping});
                }
            }
        });
        
        if (cleanupCount > 0) {
            console.log(`âœ… ${cleanupCount} grup haritalama temizlendi ve pozisyonlar yeniden dÃ¼zenlendi`);
            
            // UI gÃ¼ncellemeleri
            updateGroupMappingColors();
            updateAllInlineGroupInputs();
            updateAllMappingDisplays();
            
            showModernToast(`Soru silindi ve grup pozisyonlarÄ± gÃ¼ncellendi`, "success", 3000);
        } else {
            console.log(`â„¹ï¸ ${nodeId} iÃ§in temizlenecek grup haritalama bulunamadÄ±`);
        }
        
    } catch (error) {
        console.error("Grup haritalama temizliÄŸi sÄ±rasÄ±nda hata:", error);
        showModernToast("Grup haritalama temizliÄŸi baÅŸarÄ±sÄ±z!", "warning");
    }
}

/**
 * Soru/rubrik eklendikten sonra grup haritalamalarÄ±nÄ± gÃ¼ncelle
 * @param {string} parentComponentId - Ana bileÅŸen ID'si
 */
function updateGroupMappingsAfterNodeAdd(parentComponentId) {
    try {
        if (!APP_STATE.courseData?.grupHaritalari) return;
        
        console.log(`ğŸ”„ Soru ekleme sonrasÄ± grup haritalama gÃ¼ncelleniyor: ${parentComponentId}`);
        
        const component = APP_STATE.courseData.grupHaritalari[parentComponentId];
        if (!component) {
            console.log(`â„¹ï¸ ${parentComponentId} iÃ§in grup yapÄ±sÄ± bulunamadÄ±, varsayÄ±lan oluÅŸturuluyor...`);
            createDefaultMappingForComponent(parentComponentId);
            return;
        }
        
        // Mevcut sorular ile haritalamayÄ± senkronize et
        const parentNode = findNodeById(parentComponentId);
        if (parentNode && parentNode.children) {
            const questions = parentNode.children.filter(child => 
                isQuestionType(child.type) || isRubricType(child.type)
            );
            
            // Her grup iÃ§in eksik haritalamlarÄ± kontrol et ve otomatik ekle
            const groups = component.gruplar || ['A'];
            groups.forEach(groupName => {
                if (!component.haritalar[groupName]) {
                    component.haritalar[groupName] = {};
                }
                
                // Yeni eklenen sorular iÃ§in otomatik haritalama oluÅŸtur
                questions.forEach((question, index) => {
                    const hasMapping = Object.values(component.haritalar[groupName]).includes(question.id);
                    if (!hasMapping) {
                        // Mevcut pozisyonlarÄ± kontrol et ve sÄ±ralÄ± olarak en sona ekle
                        const existingPositions = Object.keys(component.haritalar[groupName])
                            .map(pos => parseInt(pos))
                            .filter(pos => !isNaN(pos))
                            .sort((a, b) => a - b);
                        
                        // SÄ±ralÄ± pozisyon ata (boÅŸluk varsa doldur, yoksa en sona ekle)
                        let nextPosition = 1;
                        for (let i = 0; i < existingPositions.length; i++) {
                            if (existingPositions[i] !== nextPosition) {
                                break; // BoÅŸluk bulundu
                            }
                            nextPosition++;
                        }
                        
                        component.haritalar[groupName][nextPosition.toString()] = question.id;
                        console.log(`â• Otomatik haritalama: Grup ${groupName}, Pozisyon ${nextPosition}, Soru ${question.id}`);
                    }
                });
            });
        }
        
        // UI gÃ¼ncellemeleri
        updateGroupMappingColors();
        updateAllInlineGroupInputs();
        updateAllMappingDisplays();
        
        console.log(`âœ… Grup haritalama gÃ¼ncelleme tamamlandÄ±: ${parentComponentId}`);
        
    } catch (error) {
        console.error("Grup haritalama gÃ¼ncelleme hatasÄ±:", error);
    }
}

/**
 * Grup haritalamalarÄ±nda pozisyon deÄŸiÅŸtirme (sÄ±ralama deÄŸiÅŸikliÄŸi)
 * @param {string} componentId - BileÅŸen ID'si
 * @param {string} groupName - Grup adÄ±
 * @param {string} questionId - Soru ID'si
 * @param {number} newPosition - Yeni pozisyon
 */
function changeQuestionPosition(componentId, groupName, questionId, newPosition) {
    try {
        if (!APP_STATE.courseData?.grupHaritalari?.[componentId]?.haritalar?.[groupName]) {
            console.error(`Grup ${groupName} haritalama bulunamadÄ±: ${componentId}`);
            return false;
        }
        
        const groupMapping = APP_STATE.courseData.grupHaritalari[componentId].haritalar[groupName];
        
        console.log(`ğŸ”„ Pozisyon deÄŸiÅŸikliÄŸi: ${questionId} â†’ Pozisyon ${newPosition}`);
        console.log(`ğŸ“‹ DeÄŸiÅŸiklik Ã¶ncesi mapping:`, {...groupMapping});
        
        // 1. Mevcut pozisyonu bul ve kaldÄ±r
        let oldPosition = null;
        Object.keys(groupMapping).forEach(pos => {
            if (groupMapping[pos] === questionId) {
                oldPosition = parseInt(pos);
                delete groupMapping[pos];
            }
        });
        
        if (oldPosition === null) {
            console.error(`Soru ${questionId} grup ${groupName} haritalamada bulunamadÄ±`);
            return false;
        }
        
        // 2. Yeni pozisyonda baÅŸka soru varsa yer deÄŸiÅŸtir
        const existingQuestionAtNewPos = groupMapping[newPosition.toString()];
        if (existingQuestionAtNewPos) {
            // Yer deÄŸiÅŸtirme
            groupMapping[oldPosition.toString()] = existingQuestionAtNewPos;
            console.log(`ğŸ”„ Yer deÄŸiÅŸimi: ${existingQuestionAtNewPos} => ${newPosition} â†’ ${oldPosition}`);
        }
        
        // 3. Soruyu yeni pozisyona yerleÅŸtir
        groupMapping[newPosition.toString()] = questionId;
        
        console.log(`âœ… Pozisyon deÄŸiÅŸikliÄŸi tamamlandÄ±:`, {...groupMapping});
        
        // UI gÃ¼ncellemeleri
        updateGroupMappingColors();
        updateAllInlineGroupInputs();
        updateAllMappingDisplays();
        updateAssessmentView();
        
        showModernToast(`Soru pozisyonu deÄŸiÅŸtirildi: ${oldPosition} â†’ ${newPosition}`, "success");
        return true;
        
    } catch (error) {
        console.error("Pozisyon deÄŸiÅŸikliÄŸi hatasÄ±:", error);
        showModernToast("Pozisyon deÄŸiÅŸtirilemedi!", "error");
        return false;
    }
}

/**
 * TÃ¼m ana ekran grup giriÅŸlerini gÃ¼ncelleme
 */
function updateAllInlineGroupInputs() {
    document.querySelectorAll('.nodeGroupMapping').forEach(input => {
        const nodeId = input.dataset.nodeId;
        if (nodeId) {
            const mappingText = getCurrentMappingText(nodeId);
            input.value = mappingText;
        }
    });
    
    // BileÅŸen grup bilgilerini de gÃ¼ncelle
    document.querySelectorAll('.componentGroupInfo').forEach(input => {
        const componentId = input.dataset.componentId;
        if (componentId) {
            updateComponentGroupInfo(componentId);
        }
    });
}

/**
 * BileÅŸen grup bilgisini gÃ¼ncelleme - v5 format uyumlu
 * @param {string} componentId - BileÅŸen ID'si
 */
function updateComponentGroupInfo(componentId) {
    // Alt Ã¶ÄŸeler (soru/rubrik) iÃ§in textarea yoksa sessizce geÃ§
    if (componentId.includes('.')) {
        return; // Alt Ã¶ÄŸeler iÃ§in grup bilgisi textarea'sÄ± yok, normal durum
    }
    
    const componentGroupTextarea = document.querySelector(`.componentGroupInfo[data-component-id="${componentId}"]`);
    if (!componentGroupTextarea) {
        console.log(`âš ï¸ updateComponentGroupInfo: ${componentId} iÃ§in textarea bulunamadÄ±`);
        return;
    }
    
    const component = APP_STATE.courseData?.grupHaritalari?.[componentId];
    if (!component) {
        console.log(`âš ï¸ updateComponentGroupInfo: ${componentId} iÃ§in grup bilgisi bulunamadÄ±`);
        componentGroupTextarea.value = 'A (Tek grup - Grup bilgisi yÃ¼klenemedi)';
        return;
    }
    
    const groups = component.gruplar || ['A'];
    console.log(`ğŸ“Š updateComponentGroupInfo(${componentId}): Gruplar:`, groups);
    console.log(`ğŸ“Š updateComponentGroupInfo(${componentId}): Mappings:`, component.haritalar);
    
    // v5 formatÄ±nda detaylÄ± grup bilgisi gÃ¶ster
    let groupInfo = `Gruplar: ${groups.join(', ')}`;
    
    // Mapping bilgisi varsa Ã¶rnekle - v5 format uyumlu
    if (component.haritalar && Object.keys(component.haritalar).length > 0) {
        const sampleMappings = [];
        groups.slice(0, 2).forEach(groupName => { // Ä°lk 2 grubu gÃ¶ster
            const groupMapping = component.haritalar[groupName];
            if (groupMapping && Object.keys(groupMapping).length > 0) {
                // v5 formatÄ±nda pozisyon anahtarlarÄ± string olabilir
                const positions = Object.keys(groupMapping).sort((a, b) => {
                    const numA = parseInt(a) || 0;
                    const numB = parseInt(b) || 0;
                    return numA - numB;
                });
                
                if (positions.length > 0) {
                    const samplePositions = positions.slice(0, 3); // Ä°lk 3 pozisyonu gÃ¶ster
                    const positionInfo = samplePositions.map(pos => {
                        const soruId = groupMapping[pos];
                        // v5 formatÄ±nda soruId uzun olabilir, kÄ±salt
                        const shortSoruId = soruId.length > 10 ? soruId.substring(0, 10) + '...' : soruId;
                        return `${shortSoruId}:${pos}`;
                    }).join(',');
                    sampleMappings.push(`${groupName}(${positionInfo})`);
                }
            }
        });
        
        if (sampleMappings.length > 0) {
            groupInfo += `\nSoru SÄ±ralamasÄ±: ${sampleMappings.join('; ')}`;
        } else {
            groupInfo += `\n(HenÃ¼z soru sÄ±ralamasÄ± atanmamÄ±ÅŸ)`;
        }
    } else {
        groupInfo += `\n(HenÃ¼z grup mapping'i yapÄ±lmamÄ±ÅŸ)`;
    }
    
    componentGroupTextarea.value = groupInfo;
    
    console.log(`âœ… updateComponentGroupInfo(${componentId}): "${groupInfo}"`);
    
    // Auto-resize tetikle
    const event = new Event('input');
    componentGroupTextarea.dispatchEvent(event);
}

/**
 * Auto-resize textarea based on content - vertical expansion
 * @param {HTMLTextAreaElement} textarea - Textarea element to setup auto-resize
 */
function setupAutoResize(textarea) {
    if (!textarea) return;
    
    function adjustHeight() {
        // Reset height to auto to get the natural content height
        textarea.style.height = 'auto';
        
        // Calculate the scroll height
        const scrollHeight = textarea.scrollHeight;
        
        // Set minimum and maximum heights
        const minHeight = 32;
        const maxHeight = 150; // Maximum height before scroll
        
        // Set the new height
        const newHeight = Math.min(Math.max(scrollHeight, minHeight), maxHeight);
        textarea.style.height = newHeight + 'px';
        
        // Enable scroll if content exceeds max height
        if (scrollHeight > maxHeight) {
            textarea.style.overflowY = 'auto';
        } else {
            textarea.style.overflowY = 'hidden';
        }
    }
    
    // Add event listeners for height adjustment
    textarea.addEventListener('input', adjustHeight);
    textarea.addEventListener('change', adjustHeight);
    textarea.addEventListener('keyup', adjustHeight);
    textarea.addEventListener('focus', adjustHeight);
    textarea.addEventListener('paste', () => setTimeout(adjustHeight, 0));
    
    // Initial adjustment
    setTimeout(adjustHeight, 0);
}

/**
 * Default deÄŸerlendirme aÄŸacÄ± oluÅŸturur
 */
function createDefaultAssessmentTree() {
    try {
        APP_STATE.assessmentTree = [
            {
                id: 'A1',
                name: 'Ara SÄ±nav',
                type: 'Ara SÄ±nav',
                weight: 40,
                points: 100,
                outcomes: getSmartOutcomes(3),
                description: 'YarÄ±yÄ±l iÃ§i deÄŸerlendirme',
                expanded: true,
                children: [
                    {
                        id: 'A1.1',
                        name: 'Soru 1',
                        type: 'Soru',
                        weight: 20,
                        points: 20,
                        outcomes: getSmartOutcomes(1),
                        description: 'DeÄŸerlendirme sorusu',
                        expanded: false,
                        children: []
                    },
                    {
                        id: 'A1.2',
                        name: 'Soru 2',
                        type: 'Soru',
                        weight: 20,
                        points: 20,
                        outcomes: getSmartOutcomes(1),
                        description: 'DeÄŸerlendirme sorusu',
                        expanded: false,
                        children: []
                    },
                    {
                        id: 'A1.3',
                        name: 'Soru 3',
                        type: 'Soru',
                        weight: 20,
                        points: 20,
                        outcomes: getSmartOutcomes(1),
                        description: 'DeÄŸerlendirme sorusu',
                        expanded: false,
                        children: []
                    },
                    {
                        id: 'A1.4',
                        name: 'Soru 4',
                        type: 'Soru',
                        weight: 20,
                        points: 20,
                        outcomes: getSmartOutcomes(1),
                        description: 'DeÄŸerlendirme sorusu',
                        expanded: false,
                        children: []
                    },
                    {
                        id: 'A1.5',
                        name: 'Soru 5',
                        type: 'Soru',
                        weight: 20,
                        points: 20,
                        outcomes: getSmartOutcomes(1),
                        description: 'DeÄŸerlendirme sorusu',
                        expanded: false,
                        children: []
                    }
                ]
            },
            {
                id: 'F1',
                name: 'Final SÄ±navÄ±',
                type: 'Final SÄ±navÄ±',
                weight: 60,
                points: 100,
                outcomes: getSmartOutcomes(4),
                description: 'YarÄ±yÄ±l sonu deÄŸerlendirme',
                expanded: true,
                children: [
                    {
                        id: 'F1.1',
                        name: 'Soru 1',
                        type: 'Soru',
                        weight: 20,
                        points: 20,
                        outcomes: [], // Ã–Ã‡'leri boÅŸ bÄ±rak, kullanÄ±cÄ± manuel olarak atayacak
                        description: 'DeÄŸerlendirme sorusu',
                        expanded: false,
                        children: []
                    },
                    {
                        id: 'F1.2',
                        name: 'Soru 2',
                        type: 'Soru',
                        weight: 20,
                        points: 20,
                        outcomes: [], // Ã–Ã‡'leri boÅŸ bÄ±rak, kullanÄ±cÄ± manuel olarak atayacak
                        description: 'DeÄŸerlendirme sorusu',
                        expanded: false,
                        children: []
                    },
                    {
                        id: 'F1.3',
                        name: 'Soru 3',
                        type: 'Soru',
                        weight: 20,
                        points: 20,
                        outcomes: [], // Ã–Ã‡'leri boÅŸ bÄ±rak, kullanÄ±cÄ± manuel olarak atayacak
                        description: 'DeÄŸerlendirme sorusu',
                        expanded: false,
                        children: []
                    },
                    {
                        id: 'F1.4',
                        name: 'Soru 4',
                        type: 'Soru',
                        weight: 20,
                        points: 20,
                        outcomes: [], // Ã–Ã‡'leri boÅŸ bÄ±rak, kullanÄ±cÄ± manuel olarak atayacak
                        description: 'DeÄŸerlendirme sorusu',
                        expanded: false,
                        children: []
                    },
                    {
                        id: 'F1.5',
                        name: 'Soru 5',
                        type: 'Soru',
                        weight: 20,
                        points: 20,
                        outcomes: [], // Ã–Ã‡'leri boÅŸ bÄ±rak, kullanÄ±cÄ± manuel olarak atayacak
                        description: 'DeÄŸerlendirme sorusu',
                        expanded: false,
                        children: []
                    }
                ]
            }
        ];
        
        console.log('Default deÄŸerlendirme aÄŸacÄ± oluÅŸturuldu');
    } catch (error) {
        console.error("Default deÄŸerlendirme aÄŸacÄ± oluÅŸturulurken hata:", error);
    }
}

/**
 * Grup veri yapÄ±sÄ±nÄ± doÄŸrulama ve tamamlama
 */
function validateAndCompleteGroupData() {
    try {
        if (!APP_STATE.courseData?.grupHaritalari) {
            console.log('Grup haritalarÄ± bulunamadÄ±, yeniden oluÅŸturuluyor...');
            createDefaultMapping();
            return;
        }
        
        const grupHaritalari = APP_STATE.courseData.grupHaritalari;
        let hasChanges = false;
        
        // Her deÄŸerlendirme bileÅŸeni iÃ§in doÄŸrula
        APP_STATE.assessmentTree.forEach(mainComponent => {
            if (mainComponent.id.startsWith('A') || mainComponent.id.startsWith('F')) {
                const componentId = mainComponent.id;
                
                // BileÅŸen iÃ§in grup verisi yoksa oluÅŸtur
                if (!grupHaritalari[componentId]) {
                    grupHaritalari[componentId] = {
                        gruplar: ['A'],
                        haritalar: { A: {} }
                    };
                    hasChanges = true;
                    console.log(`${componentId} iÃ§in varsayÄ±lan grup verisi oluÅŸturuldu`);
                }
                
                const component = grupHaritalari[componentId];
                
                // Groups dizisi yoksa veya boÅŸsa
                if (!component.gruplar || !Array.isArray(component.gruplar) || component.gruplar.length === 0) {
                    component.gruplar = ['A'];
                    hasChanges = true;
                }
                
                // A grubu yoksa ekle
                if (!component.gruplar.includes('A')) {
                    component.gruplar.unshift('A');
                    hasChanges = true;
                }
                
                // Mappings objesi yoksa oluÅŸtur
                if (!component.haritalar || typeof component.haritalar !== 'object') {
                    component.haritalar = {};
                    hasChanges = true;
                }
                
                // Her grup iÃ§in mapping yoksa oluÅŸtur
                component.gruplar.forEach(groupName => {
                    if (!component.haritalar[groupName]) {
                        // A grubunun kopyasÄ±nÄ± oluÅŸtur (eÄŸer varsa)
                        if (groupName !== 'A' && component.haritalar.A && Object.keys(component.haritalar.A).length > 0) {
                            component.haritalar[groupName] = JSON.parse(JSON.stringify(component.haritalar.A));
                        } else {
                            component.haritalar[groupName] = {};
                        }
                        hasChanges = true;
                        console.log(`${componentId}: ${groupName} grubu iÃ§in mapping oluÅŸturuldu`);
                    } else if (groupName !== 'A' && Object.keys(component.haritalar[groupName]).length === 0 && 
                              component.haritalar.A && Object.keys(component.haritalar.A).length > 0) {
                        // EÄŸer grup mapping'i boÅŸsa ve A grubunda veri varsa, A'dan kopyala
                        component.haritalar[groupName] = JSON.parse(JSON.stringify(component.haritalar.A));
                        hasChanges = true;
                        console.log(`${componentId}: ${groupName} grubu iÃ§in boÅŸ mapping A grubundan kopyalandÄ±`);
                    }
                });
            }
        });
        
        if (hasChanges) {
            console.log('Grup veri yapÄ±sÄ± gÃ¼ncellendi:', grupHaritalari);
        }
        
    } catch (error) {
        console.error('Grup veri doÄŸrulamasÄ± sÄ±rasÄ±nda hata:', error);
        createDefaultMapping();
    }
}

/**
 * Ã–ÄŸrencilere default grup atamasÄ± yapar - HER Ã–ÄRENCÄ° MUTLAKA BÄ°R GRUBA ATANMALI
 */
function assignDefaultGroups() {
    try {
        console.log(`ğŸ¯ assignDefaultGroups baÅŸlatÄ±ldÄ±...`);
        
        if (!APP_STATE.studentData || !Array.isArray(APP_STATE.studentData)) {
            console.log(`âš ï¸ Ã–ÄŸrenci verisi yok, iÅŸlem atlanÄ±yor`);
            return;
        }
        
        console.log(`ğŸ‘¥ ${APP_STATE.studentData.length} Ã¶ÄŸrenci kontrol ediliyor...`);
        
        let hasChanges = false;
        let assignedToA = 0;
        let alreadyAssigned = 0;
        
        // Mevcut gruplarÄ± kontrol et - A grubu her zaman geÃ§erli
        const availableGroups = Object.keys(APP_STATE.courseData?.grupHaritalari || {});
        let validGroups = ['A']; // Her zaman A grubu geÃ§erli
        
        if (availableGroups.length > 0) {
            // TÃ¼m bileÅŸenlerin gruplarÄ±nÄ± topla
            const allGroupsSet = new Set(['A']); // A grubu garantili
            
            availableGroups.forEach(componentId => {
                const component = APP_STATE.courseData.grupHaritalari[componentId];
                if (component && component.gruplar && Array.isArray(component.gruplar)) {
                    component.gruplar.forEach(group => {
                        if (group && typeof group === 'string' && group.length === 1) {
                            allGroupsSet.add(group);
                        }
                    });
                }
            });
            
            validGroups = Array.from(allGroupsSet).sort();
        }
        
        console.log(`ğŸ“‹ GeÃ§erli gruplar:`, validGroups);
        
        // TÃœM Ã–ÄRENCÄ°LERÄ° KONTROL ET VE ATANMAMIÅ OLANLARI A GRUBUNA ATA
        APP_STATE.studentData.forEach((student, index) => {
            const studentInfo = `${student.name} ${student.surname} (${student.studentId})`;
            
            if (!student.grup || student.grup === '' || !validGroups.includes(student.grup)) {
                const oldGroup = student.grup || 'YOK';
                student.grup = 'A'; // VarsayÄ±lan grup A
                hasChanges = true;
                assignedToA++;
                
                console.log(`ğŸ”§ ${index + 1}. ${studentInfo}: ${oldGroup} â†’ A`);
                
                // BileÅŸen bazlÄ± grup atamalarÄ±nÄ± da gÃ¼ncelle
                if (!APP_STATE.studentComponentGroups) {
                    APP_STATE.studentComponentGroups = {};
                }
                if (!APP_STATE.studentComponentGroups[student.studentId]) {
                    APP_STATE.studentComponentGroups[student.studentId] = {};
                }
                
                // Her bileÅŸen iÃ§in A grubu ata
                availableGroups.forEach(componentId => {
                    APP_STATE.studentComponentGroups[student.studentId][componentId] = 'A';
                });
            } else {
                alreadyAssigned++;
                console.log(`âœ… ${index + 1}. ${studentInfo}: Zaten ${student.grup} grubunda`);
            }
        });
        
        // DOÄRULAMA: HiÃ§bir Ã¶ÄŸrenci atanmamÄ±ÅŸ kalmamalÄ±
        const unassignedStudents = APP_STATE.studentData.filter(s => !s.grup || s.grup === '');
        if (unassignedStudents.length > 0) {
            console.error(`âŒ HATA: ${unassignedStudents.length} Ã¶ÄŸrenci hala atanmamÄ±ÅŸ!`);
            unassignedStudents.forEach(s => {
                console.error(`  - ${s.name} ${s.surname} (${s.studentId})`);
                s.grup = 'A'; // GÃ¼venlik iÃ§in A grubuna ata
            });
            hasChanges = true;
        }
        
        // RAPOR
        console.log(`\nğŸ“Š GRUP ATAMA RAPORU:`);
        console.log(`   âœ… Zaten atanmÄ±ÅŸ: ${alreadyAssigned} Ã¶ÄŸrenci`);
        console.log(`   ğŸ”§ A grubuna atanan: ${assignedToA} Ã¶ÄŸrenci`);
        console.log(`   ğŸ“‹ Toplam: ${APP_STATE.studentData.length} Ã¶ÄŸrenci`);
        
        if (hasChanges) {
            // UI'larÄ± gÃ¼ncelle
            updateStudentTable();
            updateGroupSelectors();
            updateAssessmentView();
            updateAllInlineGroupInputs();
            updateAllMappingDisplays();
            
            console.log(`âœ… Grup atamalarÄ± tamamlandÄ±, UI gÃ¼ncellemeleri yapÄ±ldÄ±`);
            showModernToast(`${assignedToA} Ã¶ÄŸrenci A grubuna atandÄ±. TÃ¼m Ã¶ÄŸrenciler artÄ±k gruplarda.`, "success");
        } else {
            console.log(`âœ… TÃ¼m Ã¶ÄŸrenciler zaten uygun gruplarda, deÄŸiÅŸiklik gerekmedi`);
        }
        
    } catch (error) {
        console.error("âŒ Default grup atamasÄ± yapÄ±lÄ±rken hata:", error);
        showModernToast("Grup atamasÄ± sÄ±rasÄ±nda hata oluÅŸtu!", "error");
    }
}

/**
 * Ã–Ã‡ dÃ¼zenleme modalÄ±nÄ± gÃ¶sterme
 */
function showOutcomesEditModal(nodeId) {
    const node = findNodeById(nodeId);
    if (!node) {
        showModernToast("DÃ¼ÄŸÃ¼m bulunamadÄ±!", "error");
        return;
    }
    
    // Modal elementlerini al
    const modal = document.getElementById('outcomesEditModal');
    const activityName = document.getElementById('outcomesActivityName');
    const outcomesTextarea = document.getElementById('outcomesTextarea');
    const outcomesList = document.getElementById('availableOutcomesList');
    
    if (!modal || !activityName || !outcomesTextarea || !outcomesList) {
        showModernToast("Modal elemanlarÄ± bulunamadÄ±!", "error");
        return;
    }
    
    // Modal baÅŸlÄ±ÄŸÄ±nÄ± gÃ¼ncelle
    activityName.textContent = `${node.id} - ${node.name}`;
    
    // Mevcut Ã¶ÄŸrenme Ã§Ä±ktÄ±larÄ±nÄ± textarea'ya yÃ¼kle
    outcomesTextarea.value = (node.outcomes || []).join(', ');
    
    // Mevcut Ã¶ÄŸrenme Ã§Ä±ktÄ±larÄ± listesini oluÅŸtur
    renderAvailableOutcomes(outcomesList, node.outcomes || []);
    
    // Modal aÃ§ma butonu event listener'larÄ±nÄ± kur
    setupOutcomesModalEvents(nodeId);
    
    // Modal'Ä± aÃ§
    openModernModal('outcomesEditModal');
}

/**
 * Mevcut Ã¶ÄŸrenme Ã§Ä±ktÄ±larÄ± listesini render etme
 */
function renderAvailableOutcomes(container, selectedOutcomes = []) {
    container.innerHTML = '';
    
    // TÃ¼m mevcut Ã¶ÄŸrenme Ã§Ä±ktÄ±larÄ±nÄ± bul (kod ve aÃ§Ä±klama ile)
    const allOutcomes = new Map(); // kod -> {kod, aÃ§Ä±klama}
    
    // Ã–ncelikle APP_STATE.learningOutcomes'dan al (ana veri kaynaÄŸÄ±)
    if (APP_STATE.learningOutcomes && APP_STATE.learningOutcomes.length > 0) {
        APP_STATE.learningOutcomes.forEach(outcome => {
            const outcomeCode = outcome.id || outcome.kod || outcome.kodu || outcome;
            const description = outcome.aciklama || outcome.aÃ§Ä±klama || outcome.description || outcome.desc || '';
            
            allOutcomes.set(outcomeCode, { 
                kod: outcomeCode, 
                aciklama: description 
            });
        });
    } else {
        // Fallback: APP_STATE.courseData'dan Ã¶ÄŸrenme Ã§Ä±ktÄ±larÄ±nÄ± topla
        if (APP_STATE.courseData && APP_STATE.courseData.ogrenmeciktorilari) {
            APP_STATE.courseData.ogrenmeciktorilari.forEach(outcome => {
                const outcomeCode = outcome.kod || outcome.kodu || outcome.id || outcome;
                const description = outcome.aciklama || outcome.aÃ§Ä±klama || outcome.description || outcome.desc || '';
                
                if (typeof outcome === 'string') {
                    // EÄŸer sadece string ise, kod olarak al
                    allOutcomes.set(outcome, { kod: outcome, aciklama: '' });
                } else {
                    // Object ise kod ve aÃ§Ä±klamayÄ± al
                    allOutcomes.set(outcomeCode, { kod: outcomeCode, aciklama: description });
                }
            });
        }
    }
    
    // Assessment tree'den Ã¶ÄŸrenme Ã§Ä±ktÄ±larÄ±nÄ± topla (sadece eksik olanlar iÃ§in)
    function collectOutcomesFromTree(nodes) {
        nodes.forEach(node => {
            if (node.outcomes && Array.isArray(node.outcomes)) {
                node.outcomes.forEach(outcome => {
                    if (!allOutcomes.has(outcome)) {
                        // Tree'den gelen outcome'lar genelde sadece kod
                        allOutcomes.set(outcome, { kod: outcome, aciklama: '' });
                    }
                });
            }
            if (node.children) {
                collectOutcomesFromTree(node.children);
            }
        });
    }
    
    collectOutcomesFromTree(APP_STATE.assessmentTree);
    
    if (allOutcomes.size === 0) {
        container.innerHTML = '<div class="empty-outcomes-message">HenÃ¼z Ã¶ÄŸrenme Ã§Ä±ktÄ±sÄ± tanÄ±mlanmamÄ±ÅŸ</div>';
        return;
    }
    
    // Ã–ÄŸrenme Ã§Ä±ktÄ±larÄ±nÄ± kod'a gÃ¶re sÄ±rala
    const sortedOutcomes = Array.from(allOutcomes.entries()).sort((a, b) => a[0].localeCompare(b[0]));
    
    // Badge'leri oluÅŸtur
    sortedOutcomes.forEach(([code, outcomeData]) => {
        const badge = document.createElement('div');
        badge.className = 'outcome-badge';
        badge.dataset.outcome = code;
        
        // Badge iÃ§eriÄŸini oluÅŸtur
        const codeSpan = document.createElement('div');
        codeSpan.className = 'outcome-code';
        codeSpan.textContent = outcomeData.kod;
        
        const descSpan = document.createElement('div');
        descSpan.className = 'outcome-description';
        descSpan.textContent = outcomeData.aciklama || 'AÃ§Ä±klama yok';
        
        badge.appendChild(codeSpan);
        badge.appendChild(descSpan);
        
        // EÄŸer seÃ§ili ise iÅŸaretle
        if (selectedOutcomes.includes(code)) {
            badge.classList.add('selected');
        }
        
        // Click event listener
        badge.addEventListener('click', () => {
            badge.classList.toggle('selected');
            updateOutcomesTextarea();
        });
        
        container.appendChild(badge);
    });
}

/**
 * SeÃ§ili Ã¶ÄŸrenme Ã§Ä±ktÄ±larÄ±nÄ± textarea'ya yansÄ±tma
 */
function updateOutcomesTextarea() {
    const selectedBadges = document.querySelectorAll('.outcome-badge.selected');
    const selectedOutcomes = Array.from(selectedBadges).map(badge => badge.dataset.outcome);
    const outcomesTextarea = document.getElementById('outcomesTextarea');
    
    if (outcomesTextarea) {
        outcomesTextarea.value = selectedOutcomes.join(', ');
    }
}

/**
 * Ã–Ã‡ modal event listener'larÄ±nÄ± kurma
 */
function setupOutcomesModalEvents(nodeId) {
    const selectAllBtn = document.getElementById('selectAllOutcomes');
    const clearAllBtn = document.getElementById('clearAllOutcomes');
    const randomSelectBtn = document.getElementById('randomSelectOutcomes');
    const saveBtn = document.getElementById('saveOutcomesBtn');
    const outcomesTextarea = document.getElementById('outcomesTextarea');
    
    // Ã–nceki event listener'larÄ± temizle
    const newSelectAllBtn = selectAllBtn.cloneNode(true);
    const newClearAllBtn = clearAllBtn.cloneNode(true);
    const newRandomSelectBtn = randomSelectBtn.cloneNode(true);
    const newSaveBtn = saveBtn.cloneNode(true);
    
    selectAllBtn.parentNode.replaceChild(newSelectAllBtn, selectAllBtn);
    clearAllBtn.parentNode.replaceChild(newClearAllBtn, clearAllBtn);
    randomSelectBtn.parentNode.replaceChild(newRandomSelectBtn, randomSelectBtn);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
    
    // TÃ¼mÃ¼nÃ¼ seÃ§
    newSelectAllBtn.addEventListener('click', () => {
        document.querySelectorAll('.outcome-badge').forEach(badge => {
            badge.classList.add('selected');
        });
        updateOutcomesTextarea();
    });
    
    // Temizle
    newClearAllBtn.addEventListener('click', () => {
        document.querySelectorAll('.outcome-badge').forEach(badge => {
            badge.classList.remove('selected');
        });
        updateOutcomesTextarea();
    });
    
    // Rastgele seÃ§ (2-3 tane)
    newRandomSelectBtn.addEventListener('click', () => {
        // Ã–nce tÃ¼mÃ¼nÃ¼ temizle
        document.querySelectorAll('.outcome-badge').forEach(badge => {
            badge.classList.remove('selected');
        });
        
        const allBadges = Array.from(document.querySelectorAll('.outcome-badge'));
        const randomCount = Math.floor(Math.random() * 2) + 2; // 2-3 tane
        const selectedIndices = [];
        
        while (selectedIndices.length < Math.min(randomCount, allBadges.length)) {
            const randomIndex = Math.floor(Math.random() * allBadges.length);
            if (!selectedIndices.includes(randomIndex)) {
                selectedIndices.push(randomIndex);
                allBadges[randomIndex].classList.add('selected');
            }
        }
        
        updateOutcomesTextarea();
    });
    
    // Textarea deÄŸiÅŸikliklerini badge'lere yansÄ±t
    outcomesTextarea.addEventListener('input', () => {
        const textValue = outcomesTextarea.value;
        const outcomes = textValue.split(',').map(o => o.trim()).filter(o => o.length > 0);
        
        // TÃ¼m badge'leri temizle
        document.querySelectorAll('.outcome-badge').forEach(badge => {
            badge.classList.remove('selected');
        });
        
        // Matching badge'leri seÃ§
        outcomes.forEach(outcome => {
            const badge = document.querySelector(`.outcome-badge[data-outcome="${outcome}"]`);
            if (badge) {
                badge.classList.add('selected');
            }
        });
    });
    
    // Kaydet
    newSaveBtn.addEventListener('click', () => {
        const textValue = outcomesTextarea.value;
        const outcomes = textValue.split(',').map(o => o.trim()).filter(o => o.length > 0);
        
        const node = findNodeById(nodeId);
        if (node) {
            node.outcomes = outcomes;
            
            // Ana ekrandaki textarea'yÄ± gÃ¼ncelle
            const nodeTextarea = document.querySelector(`.tree-node[data-id="${nodeId}"] .nodeOutcomes`);
            if (nodeTextarea) {
                nodeTextarea.value = outcomes.join(',');
            }
            
            // DeÄŸerlendirme gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ gÃ¼ncelle
            updateAssessmentView();
            
            showModernToast("Ã–ÄŸrenme Ã§Ä±ktÄ±larÄ± baÅŸarÄ±yla gÃ¼ncellendi!", "success");
            closeModernModal('outcomesEditModal');
        }
    });
}

// =====================================================
// COLLAPSE/EXPAND FONKSÄ°YONLARI
// =====================================================

/**
 * BÃ¶lÃ¼mÃ¼ collapse/expand yapma
 * @param {string} sectionId - BÃ¶lÃ¼m ID'si
 */
function toggleCollapse(sectionId) {
    const collapseElement = document.getElementById(sectionId + 'Collapse');
    const header = collapseElement.parentElement.querySelector('.collapsible-header');
    
    if (collapseElement.classList.contains('collapsed')) {
        // Expand - dinamik yÃ¼kseklik hesapla
        collapseElement.style.maxHeight = 'none'; // Ã–nce sÄ±nÄ±rsÄ±z yaparak Ã¶lÃ§
        const fullHeight = collapseElement.scrollHeight;
        collapseElement.style.maxHeight = '0px'; // Sonra sÄ±fÄ±ra dÃ¶ndÃ¼r
        
        // Animasyon iÃ§in kÄ±sa bir gecikme sonra gerÃ§ek yÃ¼ksekliÄŸi ver
        setTimeout(() => {
            collapseElement.style.maxHeight = fullHeight + 'px';
            collapseElement.classList.remove('collapsed');
            header.classList.remove('collapsed');
        }, 10);
    } else {
        // Collapse
        collapseElement.style.maxHeight = '0px';
        collapseElement.classList.add('collapsed');
        header.classList.add('collapsed');
    }
}

/**
 * TÃ¼m bÃ¶lÃ¼mleri expand yapma
 */
function expandAllSections() {
    const collapsibleSections = document.querySelectorAll('.collapsible-content');
    const headers = document.querySelectorAll('.collapsible-header');
    
    collapsibleSections.forEach(section => {
        // Dinamik yÃ¼kseklik hesapla
        section.style.maxHeight = 'none';
        const fullHeight = section.scrollHeight;
        section.style.maxHeight = fullHeight + 'px';
        section.classList.remove('collapsed');
    });
    
    headers.forEach(header => {
        header.classList.remove('collapsed');
    });
}

/**
 * TÃ¼m bÃ¶lÃ¼mleri collapse yapma
 */
function collapseAllSections() {
    const collapsibleSections = document.querySelectorAll('.collapsible-content');
    const headers = document.querySelectorAll('.collapsible-header');
    
    collapsibleSections.forEach(section => {
        section.style.maxHeight = '0px';
        section.classList.add('collapsed');
    });
    
    headers.forEach(header => {
        header.classList.add('collapsed');
    });
}

// Mevcut fonksiyonlarÄ± global hale getir
window.updateStudentGroup = updateStudentGroup;
window.showGroupMappingModal = showGroupMappingModal;
window.removeMappingRow = removeMappingRow;
window.applyBulkMapping = applyBulkMapping;
window.applyInlineGroupMapping = applyInlineGroupMapping;
window.showOutcomesEditModal = showOutcomesEditModal;
/**
 * Sayfa yÃ¼klendiÄŸinde doÄŸru yÃ¼kseklikleri ayarlama
 */
function initializeCollapsibleSections() {
    const collapsibleSections = document.querySelectorAll('.collapsible-content:not(.collapsed)');
    
    collapsibleSections.forEach(section => {
        // AÃ§Ä±k olan bÃ¶lÃ¼mlerin doÄŸru yÃ¼ksekliÄŸini ayarla
        const fullHeight = section.scrollHeight;
        section.style.maxHeight = fullHeight + 'px';
    });
}

// Sayfa yÃ¼klendiÄŸinde ve iÃ§erik deÄŸiÅŸtiÄŸinde Ã§alÄ±ÅŸtÄ±r
document.addEventListener('DOMContentLoaded', initializeCollapsibleSections);

// ResizeObserver ile iÃ§erik deÄŸiÅŸikliklerini izle
if (window.ResizeObserver) {
    const resizeObserver = new ResizeObserver(() => {
        // AÃ§Ä±k olan bÃ¶lÃ¼mlerin yÃ¼ksekliÄŸini yeniden hesapla
        const openSections = document.querySelectorAll('.collapsible-content:not(.collapsed)');
        openSections.forEach(section => {
            const fullHeight = section.scrollHeight;
            section.style.maxHeight = fullHeight + 'px';
        });
    });

    // TÃ¼m collapsible section'larÄ± izle
    setTimeout(() => {
        document.querySelectorAll('.collapsible-content').forEach(section => {
            resizeObserver.observe(section);
        });
    }, 100);
}

window.toggleCollapse = toggleCollapse;
window.expandAllSections = expandAllSections;
window.collapseAllSections = collapseAllSections;
window.initializeCollapsibleSections = initializeCollapsibleSections;

// ============================================================================
// SÄ°STEM TEST Ä°ÅLEMLERÄ°
// ============================================================================

/**
 * Rastgele deÄŸerlendirme bileÅŸeni ekleme
 */
function generateRandomAssessment() {
    try {
        console.log('ğŸ² Rastgele deÄŸerlendirme oluÅŸturuluyor...');
        
        // YarÄ±yÄ±l iÃ§i mi yarÄ±yÄ±l sonu mu belirle (gerÃ§ekÃ§i daÄŸÄ±lÄ±m)
        const isTermActivity = Math.random() > 0.25; // %75 yarÄ±yÄ±l iÃ§i, %25 yarÄ±yÄ±l sonu
        
        // GerÃ§ekÃ§i deÄŸerlendirme tÃ¼rleri
        const realisticTypes = {
            term: [
                { name: 'Ara SÄ±nav', weight: [25, 35], points: 100, hasSubItems: true, subTypes: ['Soru', 'Test'] },
                { name: 'Quiz', weight: [5, 15], points: 100, hasSubItems: false },
                { name: 'Ev Ã–devi', weight: [10, 20], points: 100, hasSubItems: true, subTypes: ['Soru', 'Rubrik'] },
                { name: 'Laboratuvar', weight: [15, 25], points: 100, hasSubItems: true, subTypes: ['Rubrik', 'Soru'] },
                { name: 'Proje', weight: [20, 30], points: 100, hasSubItems: true, subTypes: ['Rubrik'] },
                { name: 'Sunum', weight: [10, 20], points: 100, hasSubItems: true, subTypes: ['Rubrik'] },
                { name: 'Rapor', weight: [15, 25], points: 100, hasSubItems: true, subTypes: ['Rubrik'] }
            ],
            final: [
                { name: 'Final SÄ±navÄ±', weight: [80, 100], points: 100, hasSubItems: true, subTypes: ['Soru', 'Test'] },
                { name: 'BÃ¼tÃ¼nleme SÄ±navÄ±', weight: [80, 100], points: 100, hasSubItems: true, subTypes: ['Soru', 'Test'] },
                { name: 'Final Projesi', weight: [70, 90], points: 100, hasSubItems: true, subTypes: ['Rubrik'] }
            ]
        };
        
        const availableTypes = isTermActivity ? realisticTypes.term : realisticTypes.final;
        const randomTypeInfo = availableTypes[Math.floor(Math.random() * availableTypes.length)];
        
        // Mevcut aktiviteleri say ve doÄŸru ID formatÄ±nÄ± oluÅŸtur
        const existingActivities = APP_STATE.assessmentTree.filter(node => 
            isTermActivity ? node.id.startsWith('A') : node.id.startsWith('F')
        );
        const nextNumber = existingActivities.length + 1;
        const newId = isTermActivity ? `A${nextNumber}` : `F${nextNumber}`;
        
        // Mevcut Ã¶ÄŸrenme Ã§Ä±ktÄ±larÄ±nÄ± kullan (varsa)
        let selectedOutcomes = [];
        if (APP_STATE.learningOutcomes && APP_STATE.learningOutcomes.length > 0) {
            const numOutcomes = Math.floor(Math.random() * 3) + 1; // 1-3 arasÄ±
            const shuffledOutcomes = [...APP_STATE.learningOutcomes].sort(() => Math.random() - 0.5);
            selectedOutcomes = shuffledOutcomes.slice(0, numOutcomes).map(outcome => outcome.id);
        } else {
            // VarsayÄ±lan Ã¶ÄŸrenme Ã§Ä±ktÄ±larÄ± (gerÃ§ekÃ§i)
            const defaultOutcomes = ['Ã–Ã‡.1', 'Ã–Ã‡.2', 'Ã–Ã‡.3', 'Ã–Ã‡.4', 'Ã–Ã‡.5', 'Ã–Ã‡.6'];
            const numOutcomes = Math.floor(Math.random() * 3) + 2; // 2-4 arasÄ±
            const shuffledOutcomes = [...defaultOutcomes].sort(() => Math.random() - 0.5);
            selectedOutcomes = shuffledOutcomes.slice(0, numOutcomes);
        }
        
        // GerÃ§ekÃ§i aÄŸÄ±rlÄ±k ve puan hesaplama
        const weightRange = randomTypeInfo.weight;
        const weight = Math.floor(Math.random() * (weightRange[1] - weightRange[0] + 1)) + weightRange[0];
        
        let points;
        if (Array.isArray(randomTypeInfo.points)) {
            points = Math.floor(Math.random() * (randomTypeInfo.points[1] - randomTypeInfo.points[0] + 1)) + randomTypeInfo.points[0];
        } else {
            points = randomTypeInfo.points;
        }
        
        console.log(`  ğŸ“‹ ${randomTypeInfo.name} oluÅŸturuluyor - AÄŸÄ±rlÄ±k: ${weight}%, Puan: ${points}`);
        
        // Yeni aktivite oluÅŸtur - mevcut sistem formatÄ±nda
        const newActivity = {
            id: newId,
            name: randomTypeInfo.name,
            type: randomTypeInfo.name,
            weight: weight,
            points: points,
            outcomes: selectedOutcomes,
            description: isTermActivity ? 
                `YarÄ±yÄ±l iÃ§i ${randomTypeInfo.name.toLowerCase()} deÄŸerlendirmesi` : 
                `YarÄ±yÄ±l sonu ${randomTypeInfo.name.toLowerCase()} deÄŸerlendirmesi`,
            expanded: true,
            children: []
        };
        
        // Alt bileÅŸenler ekle (gerÃ§ekÃ§i yaklaÅŸÄ±m)
        if (randomTypeInfo.hasSubItems) {
            let numSubItems;
            let subTypes = randomTypeInfo.subTypes;
            
            // DeÄŸerlendirme tÃ¼rÃ¼ne gÃ¶re alt bileÅŸen sayÄ±sÄ±
            if (randomTypeInfo.name.includes('SÄ±nav')) {
                numSubItems = Math.floor(Math.random() * 4) + 3; // 3-6 soru/test
            } else if (randomTypeInfo.name === 'Quiz') {
                numSubItems = Math.floor(Math.random() * 3) + 2; // 2-4 soru
            } else if (randomTypeInfo.name.includes('Proje')) {
                numSubItems = Math.floor(Math.random() * 3) + 2; // 2-4 rubrik
            } else {
                numSubItems = Math.floor(Math.random() * 3) + 2; // 2-4 bileÅŸen
            }
            
            console.log(`    ğŸ”¹ ${numSubItems} alt bileÅŸen ekleniyor...`);
            
            for (let i = 0; i < numSubItems; i++) {
                // Alt bileÅŸen tÃ¼rÃ¼nÃ¼ gerÃ§ekÃ§i ÅŸekilde seÃ§
                const subType = subTypes[Math.floor(Math.random() * subTypes.length)];
                
                // GerÃ§ekÃ§i alt bileÅŸen isimleri
                let subName;
                if (subType === 'Soru') {
                    const questionTypes = ['Ã‡oktan SeÃ§meli', 'AÃ§Ä±k UÃ§lu', 'KÄ±sa CevaplÄ±', 'Problem', 'Analiz'];
                    subName = `${questionTypes[Math.floor(Math.random() * questionTypes.length)]} Soru ${i + 1}`;
                } else if (subType === 'Test') {
                    subName = `Test BÃ¶lÃ¼mÃ¼ ${i + 1}`;
                } else if (subType === 'Rubrik') {
                    const rubricTypes = ['DeÄŸerlendirme', 'Analiz', 'Sunum', 'Rapor', 'Kod Kalitesi'];
                    subName = `${rubricTypes[Math.floor(Math.random() * rubricTypes.length)]} RubriÄŸi`;
                } else {
                    subName = `${subType} ${i + 1}`;
                }
                
                const subItem = {
                    id: `${newId}.${i + 1}`,
                    name: subName,
                    type: subType,
                    weight: Math.floor(100 / numSubItems), // EÅŸit aÄŸÄ±rlÄ±k daÄŸÄ±lÄ±mÄ±
                    points: Math.floor(points / numSubItems),
                    outcomes: selectedOutcomes.length > 0 ? 
                        [selectedOutcomes[Math.floor(Math.random() * selectedOutcomes.length)]] : [],
                    description: `${subName} iÃ§in deÄŸerlendirme kriteri`,
                    expanded: false,
                    children: []
                };
                
                // Test iÃ§in gerÃ§ekÃ§i detaylar ekle
                if (subType === 'Test') {
                    const questionCount = Math.floor(Math.random() * 20) + 10; // 10-30 soru
                    subItem.testDetails = {
                        totalQuestions: questionCount,
                        correctWeight: Math.floor(Math.random() * 3) + 3, // 3-5 puan
                        wrongPenalty: -(Math.floor(Math.random() * 2) + 1) // -1 veya -2 puan
                    };
                    console.log(`      ğŸ§ª Test: ${questionCount} soru, +${subItem.testDetails.correctWeight}/${subItem.testDetails.wrongPenalty} puan`);
                }
                
                newActivity.children.push(subItem);
                console.log(`      âœ… ${subName} (${subItem.points} puan)`);
            }
            
            // Alt bileÅŸenlerin aÄŸÄ±rlÄ±klarÄ±nÄ± normalize et
            const totalWeight = newActivity.children.reduce((sum, child) => sum + child.weight, 0);
            if (totalWeight !== 100) {
                newActivity.children.forEach(child => {
                    child.weight = Math.round((child.weight / totalWeight) * 100);
                });
            }
        }
        
        // Assessment tree'ye doÄŸru sÄ±rada ekle
        if (isTermActivity) {
            // YarÄ±yÄ±l iÃ§i etkinlikleri baÅŸa ekle
            const termActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('A'));
            const finalActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('F'));
            termActivities.push(newActivity);
            APP_STATE.assessmentTree = [...termActivities, ...finalActivities];
        } else {
            // YarÄ±yÄ±l sonu etkinlikleri sona ekle
            APP_STATE.assessmentTree.push(newActivity);
        }
        
        // SeÃ§ili dÃ¼ÄŸÃ¼mÃ¼ yeni aktivite yap
        selectNode(newActivity);
        
        // Yeni eklenen sorularÄ± tÃ¼m gruplara farklÄ± sÄ±ralarda ata
        if (APP_STATE.courseData && APP_STATE.courseData.grupHaritalari) {
            const activeGroups = Object.keys(APP_STATE.courseData.grupHaritalari);
            if (activeGroups.length > 0 && newActivity.children && newActivity.children.length > 0) {
                // Yeni aktivitedeki sorularÄ± topla
                const newQuestions = newActivity.children.filter(child => child.type === 'Soru');
                
                if (newQuestions.length > 0) {
                    // Her grup iÃ§in tÃ¼m sorularÄ± farklÄ± sÄ±ralarda ata
                    activeGroups.forEach((groupName, groupIndex) => {
                        console.log(`\nYeni sorular Grup ${groupName} iÃ§in sÄ±ralanÄ±yor:`);
                        
                        // Yeni sorularÄ± kopyala ve karÄ±ÅŸtÄ±r
                        const shuffledQuestions = [...newQuestions];
                        
                        // Her grup iÃ§in farklÄ± karÄ±ÅŸtÄ±rma
                        for (let i = 0; i < groupIndex + 1; i++) {
                            for (let j = shuffledQuestions.length - 1; j > 0; j--) {
                                const k = Math.floor(Math.random() * (j + 1));
                                [shuffledQuestions[j], shuffledQuestions[k]] = [shuffledQuestions[k], shuffledQuestions[j]];
                            }
                        }
                        
                        // Grup haritasÄ±nÄ± gÃ¼ncelle
                        if (!APP_STATE.courseData.grupHaritalari[groupName][newId]) {
                            APP_STATE.courseData.grupHaritalari[groupName][newId] = [];
                        }
                        
                        // TÃ¼m yeni sorularÄ± bu gruba ata (karÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ sÄ±rada)
                        shuffledQuestions.forEach((question, index) => {
                            APP_STATE.courseData.grupHaritalari[groupName][newId].push(question.id);
                            console.log(`  ${index + 1}. ${question.name} (${question.id})`);
                        });
                    });
                }
            }
        }
        
        // UI'larÄ± gÃ¼ncelle
        renderTree();
        updateAssessmentView();
        updateCategoryWeights();
        updateTreeMappingControls();
        updateAllInlineGroupInputs();
        updateAllMappingDisplays();
        
        // Ã–ÄŸrenci grup bilgilerini gÃ¼ncelle
        updateStudentGroupInfoDisplay();
        
        console.log('âœ… Rastgele deÄŸerlendirme baÅŸarÄ±yla eklendi:', newActivity);
        showModernToast(`ğŸ“ ${randomTypeInfo.name} deÄŸerlendirmesi eklendi! (${newId})`, "success");
        
    } catch (error) {
        console.error("âŒ Rastgele deÄŸerlendirme oluÅŸturulurken hata:", error);
        showModernToast("Rastgele deÄŸerlendirme oluÅŸturulamadÄ±!", "error");
    }
}

/**
 * ğŸ§¹ DeÄŸerlendirmeleri Temizle
 */
function clearAssessments() {
    console.log("ğŸ” clearAssessments fonksiyonu Ã§aÄŸrÄ±ldÄ±");
    try {
        // Ã–nce silinecek veri var mÄ± kontrol et
        if (!APP_STATE.assessmentTree || APP_STATE.assessmentTree.length === 0) {
            console.log("â„¹ï¸ Silinecek deÄŸerlendirme bileÅŸeni bulunmuyor");
            showModernToast("â„¹ï¸ Silinecek deÄŸerlendirme bileÅŸeni bulunmuyor.", "info");
            return;
        }
        
        console.log("ğŸ“‹ showModernConfirm Ã§aÄŸrÄ±lÄ±yor...");
        showModernConfirm(
            "DeÄŸerlendirme BileÅŸenlerini Sil",
            "TÃ¼m deÄŸerlendirme bileÅŸenleri silinecek. Bu iÅŸlem geri alÄ±namaz. Emin misiniz?",
            function() {
                console.log("âœ… Onay verildi, performClearAssessments Ã§aÄŸrÄ±lÄ±yor");
                // Onay verildiÄŸinde Ã§alÄ±ÅŸacak kod
                performClearAssessments();
            }
        );
    } catch (error) {
        console.error("âŒ DeÄŸerlendirmeler temizlenirken hata:", error);
        showModernToast("DeÄŸerlendirmeler temizlenemedi!", "error");
    }
}

function performClearAssessments() {
    try {
        console.log("ğŸ”§ performClearAssessments baÅŸlatÄ±ldÄ±");
        
        // 1. DeÄŸerlendirme aÄŸacÄ±nÄ± temizle
        APP_STATE.assessmentTree = [];
        APP_STATE.selectedNode = null;
        
        // 2. Ä°LGÄ°LÄ° PUANLARI DA TEMÄ°ZLE (BaÄŸÄ±mlÄ±lÄ±k Ã§Ã¶zÃ¼mÃ¼)
        console.log("ğŸ”— DeÄŸerlendirmelerle ilgili puanlar da temizleniyor...");
        APP_STATE.gradesData = {};
        APP_STATE.testScores = {};
        
        // 3. Grup haritalamalarÄ±nÄ± temizle (deÄŸerlendirme yok ise grup da anlamsÄ±z)
        if (APP_STATE.courseData) {
            APP_STATE.courseData.grupHaritalari = {};
        }
        
        // 4. UI'larÄ± gÃ¼ncelle
        renderTree();
        updateAssessmentView();
        updateCategoryWeights();
        
        // 5. GÃ¼venli UI gÃ¼ncellemeleri
        if (typeof updateTreeMappingControls === 'function') {
        updateTreeMappingControls();
        }
        if (typeof updateAllInlineGroupInputs === 'function') {
        updateAllInlineGroupInputs();
        }
        
        // 6. Not tablolarÄ±nÄ± temizle
        const gradesTableContainer = document.getElementById('gradesTableContainer');
        if (gradesTableContainer) {
            gradesTableContainer.innerHTML = '<p class="empty-message">HenÃ¼z not hesaplanmadÄ±.</p>';
        }
        
        // 7. Ã–ÄŸrenci grup bilgilerini gÃ¼ncelle
        updateStudentGroupInfoDisplay();
        
        showModernToast("ğŸ—‘ï¸ TÃ¼m deÄŸerlendirme bileÅŸenleri ve ilgili puanlar temizlendi!", "success");
        
    } catch (error) {
        console.error("âŒ DeÄŸerlendirmeler temizlenirken hata:", error);
        showModernToast("DeÄŸerlendirmeler temizlenemedi!", "error");
    }
}

/**
 * ğŸ§¹ GruplarÄ± Temizle
 */
function clearGroups() {
    try {
        // Ã–nce silinecek veri var mÄ± kontrol et
        if (!APP_STATE.courseData || !APP_STATE.courseData.grupHaritalari || Object.keys(APP_STATE.courseData.grupHaritalari).length === 0) {
            showModernToast("â„¹ï¸ Silinecek grup verisi bulunmuyor.", "info");
            return;
        }
        
        showModernConfirm(
            "Grup Verilerini Sil",
            "TÃ¼m grup haritalama verileri silinecek. Bu iÅŸlem geri alÄ±namaz. Emin misiniz?",
            function() {
                // Onay verildiÄŸinde Ã§alÄ±ÅŸacak kod
                performClearGroups();
            }
        );
    } catch (error) {
        console.error("Gruplar temizlenirken hata:", error);
        showModernToast("Gruplar temizlenemedi!", "error");
    }
}

function performClearGroups() {
    try {
        console.log("ğŸ”§ performClearGroups baÅŸlatÄ±ldÄ±");
        
        // 1. Grup haritalamalarÄ±nÄ± temizle
        if (APP_STATE.courseData) {
            APP_STATE.courseData.grupHaritalari = {};
        }
        
        // 2. Ã–ÄŸrencilerin gruplarÄ±nÄ± varsayÄ±lan gruba ata
        if (APP_STATE.studentData) {
            APP_STATE.studentData.forEach(student => {
                student.grup = 'A';
            });
        }
        
        // 3. GRUP DEÄÄ°ÅÄ°KLÄ°ÄÄ° PUANLARI ETKÄ°LEYEBÄ°LÄ°R - UyarÄ± ver
        const hasGrades = (APP_STATE.gradesData && Object.keys(APP_STATE.gradesData).length > 0) ||
                         (APP_STATE.testScores && Object.keys(APP_STATE.testScores).length > 0);
        
        if (hasGrades) {
            console.log("âš ï¸ Grup deÄŸiÅŸikliÄŸi mevcut puanlarÄ± etkileyebilir");
            showModernToast("âš ï¸ Grup haritalama temizlendi. Mevcut puanlar grup deÄŸiÅŸikliÄŸinden etkilenebilir!", "warning", 6000);
        }
        
        // 4. UI'larÄ± gÃ¼venli ÅŸekilde gÃ¼ncelle
        if (typeof updateGroupSelectors === 'function') {
        updateGroupSelectors();
        }
        updateStudentTable();
        if (typeof updateTreeMappingControls === 'function') {
        updateTreeMappingControls();
        }
        if (typeof updateAllInlineGroupInputs === 'function') {
        updateAllInlineGroupInputs();
        }
        if (typeof updateAllMappingDisplays === 'function') {
        updateAllMappingDisplays();
        }
        updateAssessmentView();
        
        showModernToast("ğŸ—‘ï¸ TÃ¼m grup haritalama verileri temizlendi!", "success");
        
    } catch (error) {
        console.error("âŒ Gruplar temizlenirken hata:", error);
        showModernToast("Gruplar temizlenemedi!", "error");
    }
}

/**
 * ğŸ§¹ PuanlarÄ± Temizle
 */
function clearScores() {
    try {
        // Ã–nce silinecek veri var mÄ± kontrol et
        const hasGrades = APP_STATE.gradesData && Object.keys(APP_STATE.gradesData).length > 0;
        const hasTestScores = APP_STATE.testScores && Object.keys(APP_STATE.testScores).length > 0;
        
        if (!hasGrades && !hasTestScores) {
            showModernToast("â„¹ï¸ Silinecek puan verisi bulunmuyor.", "info");
            return;
        }
        
        showModernConfirm(
            "Ã–ÄŸrenci PuanlarÄ±nÄ± Sil",
            "TÃ¼m Ã¶ÄŸrenci puanlarÄ± silinecek. Bu iÅŸlem geri alÄ±namaz. Emin misiniz?",
            function() {
                // Onay verildiÄŸinde Ã§alÄ±ÅŸacak kod
                performClearScores();
            }
        );
    } catch (error) {
        console.error("Puanlar temizlenirken hata:", error);
        showModernToast("Puanlar temizlenemedi!", "error");
    }
}

function performClearScores() {
    try {
        console.log("ğŸ”§ performClearScores baÅŸlatÄ±ldÄ±");
        
        // 1. PuanlarÄ± temizle
        APP_STATE.gradesData = {};
        APP_STATE.testScores = {};
        
        // 2. UI'larÄ± GÃœVENLÄ° ÅEKÄ°LDE gÃ¼ncelle
        updateAssessmentView();
        
        // 3. Ã–ÄŸrenci bazlÄ± not giriÅŸi sekmesini temizle
        const studentGradesContainer = document.getElementById('studentGradesContainer');
        if (studentGradesContainer) {
            studentGradesContainer.innerHTML = '<p class="empty-message">Veri bulunamadÄ±.</p>';
        }
        
        // 4. Not tablosunu GÃœVENLÄ° ÅEKÄ°LDE temizle
        const gradesTableContainer = document.getElementById('gradesTableContainer');
        if (gradesTableContainer) {
            gradesTableContainer.innerHTML = '<p class="empty-message">HenÃ¼z not hesaplanmadÄ±.</p>';
        }
        
        // 5. Not tablosunu gÃ¼venli gÃ¼ncelleme
        try {
            // BoÅŸ final grades ile tabloyu gÃ¼ncelle
            updateGradesTable([]);
        } catch (tableError) {
            console.warn("âš ï¸ Not tablosu gÃ¼ncellenirken hata (gÃ¶rmezden gelindi):", tableError);
            // Hata olursa manuel temizle
            const gradesTable = document.getElementById('gradesTable');
            if (gradesTable) {
                const tbody = gradesTable.querySelector('tbody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="8" class="empty-message">Not giriÅŸi yapÄ±lmadÄ±</td></tr>';
                }
            }
        }
        
        showModernToast("ğŸ—‘ï¸ TÃ¼m Ã¶ÄŸrenci puanlarÄ± temizlendi!", "success");
        
    } catch (error) {
        console.error("âŒ Puanlar temizlenirken hata:", error);
        showModernToast("Puanlar temizlenemedi!", "error");
    }
}

/**
 * ğŸ§¹ Ã–ÄŸrencileri Temizle
 */
function clearStudentsOnly() {
    try {
        showModernConfirm(
            "Ã–ÄŸrenci Listesini Sil",
            "TÃ¼m Ã¶ÄŸrenci listesi silinecek. Bu iÅŸlem geri alÄ±namaz. Emin misiniz?",
            function() {
                // Onay verildiÄŸinde Ã§alÄ±ÅŸacak kod
                performClearStudentsOnly();
            }
        );
    } catch (error) {
        console.error("Ã–ÄŸrenciler temizlenirken hata:", error);
        showModernToast("Ã–ÄŸrenciler temizlenemedi!", "error");
    }
}

function performClearStudentsOnly() {
    try {
        
        APP_STATE.studentData = [];
        APP_STATE.selectedStudentId = null;
        
        // Ã–ÄŸrenci verilerine baÄŸlÄ± puanlarÄ± da temizle
        APP_STATE.gradesData = {};
        APP_STATE.testScores = {};
        
        // UI'larÄ± gÃ¼ncelle
        updateStudentTable();
        // updateStudentSelector fonksiyonu kaldÄ±rÄ±ldÄ± (Ã–ÄŸrenci BazlÄ± Not GiriÅŸi sekmesi ile birlikte)
        updateAssessmentView();
        
        // Ã–ÄŸrenci bazlÄ± not giriÅŸi sekmesini temizle
        const studentGradesContainer = document.getElementById('studentGradesContainer');
        if (studentGradesContainer) {
            studentGradesContainer.innerHTML = '<p class="empty-message">Veri bulunamadÄ±.</p>';
        }
        
        showModernToast("ğŸ—‘ï¸ TÃ¼m Ã¶ÄŸrenci listesi temizlendi!", "success");
        
    } catch (error) {
        console.error("Ã–ÄŸrenciler temizlenirken hata:", error);
        showModernToast("Ã–ÄŸrenciler temizlenemedi!", "error");
    }
}

/**
 * ğŸ”„ Sistemi Resetle
 */
function resetSystem() {
    try {
        showModernConfirm(
            "âš ï¸ SÄ°STEMÄ° TAMAMEN RESETLE",
            "TÃœM VERÄ°LER SÄ°LÄ°NECEK! Bu iÅŸlem geri alÄ±namaz. Sistem tamamen sÄ±fÄ±rlanacak. Devam etmek istediÄŸinizden emin misiniz?",
            function() {
                // Onay verildiÄŸinde Ã§alÄ±ÅŸacak kod
                performResetSystem();
            }
        );
    } catch (error) {
        console.error("Sistem resetlenirken hata:", error);
        showModernToast("Sistem resetlenemedi!", "error");
    }
}

function performResetSystem() {
    try {
        
        // TÃ¼m verileri sÄ±fÄ±rla
        APP_STATE.studentData = [];
        APP_STATE.assessmentTree = [];
        APP_STATE.gradesData = {};
        APP_STATE.testScores = {};
        APP_STATE.courseData = {
            grupHaritalari: {}
        };
        APP_STATE.selectedNode = null;
        APP_STATE.selectedStudentId = null;
        APP_STATE.learningOutcomes = [];
        APP_STATE.programOutcomes = [];
        
        // UI'larÄ± tamamen yenile
        updateStudentTable();
        // updateStudentSelector fonksiyonu kaldÄ±rÄ±ldÄ± (Ã–ÄŸrenci BazlÄ± Not GiriÅŸi sekmesi ile birlikte)
        renderTree();
        updateGroupSelectors();
        updateAssessmentView();
        updateCategoryWeights();
        updateTreeMappingControls();
        updateAllInlineGroupInputs();
        updateAllMappingDisplays();
        
        // TÃ¼m containers'Ä± temizle
        const containers = [
            'studentGradesContainer',
            'assessmentContainer',
            'gradesTableContainer',
            'courseDetailsContainer',
            'outcomesContainer',
            'programOutcomesContainer',
            'outcomeMatrixContainer'
        ];
        
        containers.forEach(containerId => {
            const container = document.getElementById(containerId);
            if (container) {
                if (containerId === 'courseDetailsContainer') {
                    container.innerHTML = '<div class="details-empty-message">Ders detaylarÄ± iÃ§in JSON yÃ¼kleyin.</div>';
                } else if (containerId === 'outcomesContainer') {
                    container.innerHTML = '<div class="outcomes-empty-message">HenÃ¼z Ã¶ÄŸrenme Ã§Ä±ktÄ±sÄ± eklenmedi.</div>';
                } else if (containerId === 'programOutcomesContainer') {
                    container.innerHTML = '<div class="outcomes-empty-message">HenÃ¼z program Ã§Ä±ktÄ±sÄ± eklenmedi.</div>';
                } else if (containerId === 'outcomeMatrixContainer') {
                    container.innerHTML = '<div class="matrix-empty-message">HenÃ¼z iliÅŸki matrisi oluÅŸturulmadÄ±.</div>';
                } else {
                    container.innerHTML = '<p class="empty-message">Veri bulunamadÄ±.</p>';
                }
            }
        });
        
        // Tree container'Ä± Ã¶zel mesajla
        const treeContainer = document.getElementById('treeContainer');
        if (treeContainer) {
            treeContainer.innerHTML = '<div class="tree-empty-message">HenÃ¼z deÄŸerlendirme bileÅŸeni eklenmedi. Ders JSON yÃ¼kleyin veya yeni bileÅŸenler ekleyin.</div>';
        }
        
        showModernToast("ğŸ”„ Sistem tamamen sÄ±fÄ±rlandÄ±! Temiz bir baÅŸlangÄ±Ã§ yapabilirsiniz.", "success", 5000);
        
    } catch (error) {
        console.error("Sistem resetlenirken hata:", error);
        showModernToast("Sistem resetlenemedi!", "error");
    }
}

/**
 * Rastgele gruplar oluÅŸturma ve soru-grup eÅŸleÅŸtirmesi
 */
/**
 * Rastgele grup oluÅŸturma (Onay ile)
 */
function generateRandomGroups() {
    console.log('ğŸš€ generateRandomGroups() fonksiyonu baÅŸlatÄ±ldÄ±');
    console.log('ğŸ“Š DEBUG: APP_STATE kontrolÃ¼ yapÄ±lÄ±yor...');
    
    // Mevcut grup verilerini kontrol et
    const hasExistingGroups = APP_STATE.courseData && APP_STATE.courseData.grupHaritalari && 
        Object.keys(APP_STATE.courseData.grupHaritalari).length > 0;
    const hasExistingAssessments = APP_STATE.assessmentTree && APP_STATE.assessmentTree.length > 0;
    const studentCount = APP_STATE.studentData ? APP_STATE.studentData.length : 0;
    
    console.log('ğŸ“Š DEBUG: Durum KontrolÃ¼:');
    console.log('  - APP_STATE.courseData:', !!APP_STATE.courseData);
    console.log('  - APP_STATE.courseData.grupHaritalari:', !!APP_STATE.courseData?.grupHaritalari);
    console.log('  - hasExistingGroups:', hasExistingGroups);
    console.log('  - APP_STATE.assessmentTree length:', APP_STATE.assessmentTree?.length || 0);
    console.log('  - hasExistingAssessments:', hasExistingAssessments);
    console.log('  - APP_STATE.studentData length:', APP_STATE.studentData?.length || 0);
    console.log('  - studentCount:', studentCount);
    
    const minSlider = document.getElementById('groupMinSlider');
    const maxSlider = document.getElementById('groupMaxSlider');
    const minGroups = minSlider ? parseInt(minSlider.value) : 1;
    const maxGroups = maxSlider ? parseInt(maxSlider.value) : 2;
    
    console.log('ğŸšï¸ DEBUG: Slider DeÄŸerleri:');
    console.log('  - minSlider element:', !!minSlider);
    console.log('  - maxSlider element:', !!maxSlider);
    console.log('  - minGroups:', minGroups);
    console.log('  - maxGroups:', maxGroups);
    
    let warningMessage = '';
    
    if (!hasExistingAssessments) {
        console.log('âŒ DEBUG: DeÄŸerlendirme bileÅŸeni bulunamadÄ±!');
        console.log('   - APP_STATE.assessmentTree:', APP_STATE.assessmentTree);
        warningMessage = 'HenÃ¼z deÄŸerlendirme bileÅŸeni bulunmuyor. Ã–nce yarÄ±yÄ±l iÃ§i veya yarÄ±yÄ±l sonu etkinlikleri oluÅŸturun.';
        showModernToast(warningMessage, 'warning');
        return;
    }
    
    if (studentCount === 0) {
        warningMessage = `${minGroups}-${maxGroups} arasÄ±nda rastgele grup oluÅŸturulacak (Ã¶ÄŸrenci verisi yok, sadece yapÄ± oluÅŸturulacak).\n\nDevam etmek istediÄŸinizden emin misiniz?`;
    } else if (hasExistingGroups) {
        const existingGroupCount = Object.keys(APP_STATE.courseData.grupHaritalari).length;
        warningMessage = `Mevcut ${existingGroupCount} deÄŸerlendirme bileÅŸeninin grup haritalarÄ± deÄŸiÅŸecek. ${studentCount} Ã¶ÄŸrenci iÃ§in ${minGroups}-${maxGroups} arasÄ±nda yeni grup dÃ¼zeni oluÅŸturulacak.\n\nMevcut grup haritalama verileri kaybolacak. Devam etmek istediÄŸinizden emin misiniz?`;
    } else {
        warningMessage = `${studentCount} Ã¶ÄŸrenci iÃ§in ${minGroups}-${maxGroups} arasÄ±nda rastgele grup oluÅŸturulacak.\n\nBu iÅŸlem geri alÄ±namaz. Devam etmek istediÄŸinizden emin misiniz?`;
    }
    
    showModernConfirm(
        'ğŸ² Rastgele Ã–ÄŸrenci GruplarÄ± OluÅŸtur',
        warningMessage,
        {
            confirmText: 'Evet, OluÅŸtur',
            cancelText: 'Ä°ptal',
            confirmClass: 'btn-modern-primary',
            cancelClass: 'btn-modern-secondary',
            headerClass: 'warning-action',
            iconClass: 'warning'
        }
    ).then((result) => {
        console.log('ğŸ” Modal sonucu:', result);
        if (result) {
            console.log('âœ… KullanÄ±cÄ± onayladÄ±, executeGenerateRandomGroups Ã§aÄŸrÄ±lÄ±yor...');
            executeGenerateRandomGroups();
        } else {
            console.log('âŒ KullanÄ±cÄ± iptal etti');
        }
    });
}

/**
 * Rastgele grup oluÅŸturma (GerÃ§ek iÅŸlem)
 */
function executeGenerateRandomGroups() {
    console.log('ğŸ¯ executeGenerateRandomGroups() fonksiyonu baÅŸlatÄ±ldÄ±');
    console.log('ğŸ“Š DEBUG: Ana iÅŸlem baÅŸlÄ±yor, tÃ¼m kontroller yapÄ±lacak...');
    
    try {
        // Dual range slider'dan min ve max grup sayÄ±larÄ±nÄ± al
        const minSlider = document.getElementById('groupMinSlider');
        const maxSlider = document.getElementById('groupMaxSlider');
        let minGroups = minSlider ? parseInt(minSlider.value) : 1;
        let maxGroups = maxSlider ? parseInt(maxSlider.value) : 2;
        
        console.log('ğŸšï¸ DEBUG: executeGenerateRandomGroups - Slider DeÄŸerleri:');
        console.log('  - minSlider element:', !!minSlider, minSlider?.value);
        console.log('  - maxSlider element:', !!maxSlider, maxSlider?.value);
        console.log('  - minGroups (parsed):', minGroups);
        console.log('  - maxGroups (parsed):', maxGroups);
        
        // Ã–ÄŸrenci sayÄ±sÄ±nÄ± kontrol et
        const studentCount = APP_STATE.studentData ? APP_STATE.studentData.length : 0;
        
        console.log('ğŸ‘¥ DEBUG: Ã–ÄŸrenci Verileri:');
        console.log('  - APP_STATE.studentData:', !!APP_STATE.studentData);
        console.log('  - studentCount:', studentCount);
        if (APP_STATE.studentData && APP_STATE.studentData.length > 0) {
            console.log('  - Ä°lk Ã¶ÄŸrenci Ã¶rneÄŸi:', APP_STATE.studentData[0]);
        }
        
        // UYARI: Ã–ÄŸrenci sayÄ±sÄ±ndan fazla grup oluÅŸturma kontrolÃ¼
        if (minGroups > studentCount && studentCount > 0) {
            showModernToast(`âš ï¸ UyarÄ±: Minimum grup sayÄ±sÄ± (${minGroups}) Ã¶ÄŸrenci sayÄ±sÄ±ndan (${studentCount}) fazla! Maksimum ${studentCount} grup oluÅŸturulabilir.`, "warning");
            return;
        }
        
        if (maxGroups > studentCount && studentCount > 0) {
            showModernToast(`âš ï¸ UyarÄ±: Maksimum grup sayÄ±sÄ± (${maxGroups}) Ã¶ÄŸrenci sayÄ±sÄ±ndan (${studentCount}) fazla! En fazla ${studentCount} grup oluÅŸturulabilir.`, "warning");
            // Maksimum grup sayÄ±sÄ±nÄ± Ã¶ÄŸrenci sayÄ±sÄ± ile sÄ±nÄ±rla
            maxGroups = Math.min(maxGroups, studentCount);
            maxSlider.value = maxGroups;
            document.getElementById('groupMaxValue').textContent = maxGroups;
        }
        
        // AralÄ±ktan rastgele bir grup sayÄ±sÄ± seÃ§ (Ã¶ÄŸrenci sayÄ±sÄ± ile sÄ±nÄ±rlÄ±)
        const effectiveMaxGroups = Math.min(maxGroups, studentCount || 20); // Ã–ÄŸrenci yoksa 20 ile sÄ±nÄ±rla
        const requestedGroupCount = Math.floor(Math.random() * (effectiveMaxGroups - minGroups + 1)) + minGroups;
        
        const groupNames = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T'];
        
        // Mevcut grup haritalarÄ±nÄ± temizle ama her zaman A grubu olacak
        if (!APP_STATE.courseData) {
            APP_STATE.courseData = {};
        }
        APP_STATE.courseData.grupHaritalari = {};
        
        console.log('ğŸ” DEBUG: Ana deÄŸerlendirme bileÅŸenlerini bulma iÅŸlemi baÅŸlatÄ±ldÄ±');
        console.log('  - APP_STATE.assessmentTree:', APP_STATE.assessmentTree);
        console.log('  - assessmentTree length:', APP_STATE.assessmentTree?.length || 0);
        
        // Ana deÄŸerlendirme bileÅŸenlerini bul (A1, A2, F1 vb.)
        const mainComponents = APP_STATE.assessmentTree.filter(node => 
            node.id.startsWith('A') || node.id.startsWith('F')
        );
        
        console.log('ğŸ” DEBUG: Ana bileÅŸen filtreleme sonucu:');
        console.log('  - mainComponents length:', mainComponents.length);
        console.log('  - mainComponents:', mainComponents);
        if (mainComponents.length > 0) {
            mainComponents.forEach((comp, index) => {
                console.log(`    ${index + 1}. ${comp.id} - ${comp.name} (${comp.type})`);
                console.log(`       children length: ${comp.children?.length || 0}`);
            });
        }
        
        if (mainComponents.length === 0) {
            console.log('âŒ DEBUG: Ana bileÅŸen bulunamadÄ±!');
            showModernToast("Ã–nce deÄŸerlendirme bileÅŸenleri oluÅŸturun!", "warning");
            return;
        }
        
        console.log(`ğŸ“Š DEBUG: Ana bileÅŸenler:`, mainComponents.map(c => c.id));
        console.log(`ğŸ‘¥ DEBUG: Ã–ÄŸrenci sayÄ±sÄ±: ${studentCount}`);
        const rangeText = minGroups === maxGroups ? `${minGroups}` : `${minGroups}-${effectiveMaxGroups}`;
        console.log(`ğŸ¯ DEBUG: Grup aralÄ±ÄŸÄ±: ${rangeText}, SeÃ§ilen grup sayÄ±sÄ±: ${requestedGroupCount}`);
        
        // TÃ¼m gruplarÄ± toplamak iÃ§in - her zaman A grubu dahil
        const allGroupsSet = new Set(['A']); // A grubu her zaman var
        const componentGroupData = {};
        if (studentCount === 0) {
            // Ã–ÄŸrenci yoksa sadece A grubu ile devam et
            console.log("âš ï¸ Ã–ÄŸrenci verisi yok, sadece A grubu oluÅŸturuluyor");
            mainComponents.forEach(component => {
                APP_STATE.courseData.grupHaritalari[component.id] = {
                    gruplar: ['A'],
                    haritalar: { 'A': {} }
                };
            });
            
            // VarsayÄ±lan haritalamayÄ± oluÅŸtur
            ensureDefaultGroupExists();
            createDefaultMapping();
            
            // UI gÃ¼ncellemeleri
            updateGroupSelectors();
            updateTreeMappingControls();
            updateAllInlineGroupInputs();
            updateAllMappingDisplays();
            renderTree();
            updateAssessmentView();
            
            showModernToast("Sadece A grubu oluÅŸturuldu (Ã¶ÄŸrenci verisi yok)", "info");
            return;
        }
        
        // Grup sayÄ±sÄ±nÄ± Ã¶ÄŸrenci sayÄ±sÄ± ve istenen sayÄ± ile sÄ±nÄ±rla
        const maxPossibleGroups = Math.min(requestedGroupCount, studentCount, groupNames.length);
        const finalGroupCount = Math.max(1, maxPossibleGroups); // En az 1 grup (A grubu)
        
        console.log(`ğŸ‘¥ Ã–ÄŸrenci sayÄ±sÄ±: ${studentCount}`);
        console.log(`ğŸ¯ Ä°stenen grup sayÄ±sÄ±: ${requestedGroupCount}`);
        console.log(`ğŸ“Š Maksimum mÃ¼mkÃ¼n grup sayÄ±sÄ±: ${maxPossibleGroups}`);
        console.log(`âœ… Final grup sayÄ±sÄ±: ${finalGroupCount}`);
        
        // Her ana bileÅŸen iÃ§in uygun grup sayÄ±sÄ± oluÅŸtur - Ã–ÄRENCÄ° SAYISINI AÅMAYACAK
        mainComponents.forEach(component => {
            let numGroups, componentGroups;
            
            // Belirlenen grup sayÄ±sÄ±nÄ± kullan
            numGroups = finalGroupCount;
            componentGroups = groupNames.slice(0, numGroups);
            
            console.log(`ğŸ“Š ${component.id} iÃ§in grup bilgileri:`);
            console.log(`   - Ã–ÄŸrenci sayÄ±sÄ±: ${studentCount}`);
            console.log(`   - Ä°stenen grup sayÄ±sÄ±: ${requestedGroupCount}`);
            console.log(`   - KullanÄ±lan grup sayÄ±sÄ±: ${numGroups}`);
            
            console.log(`\n=== ${component.id} bileÅŸeni iÃ§in ${numGroups} grup oluÅŸturuluyor: ${componentGroups.join(', ')} ===`);
            
            // Bu bileÅŸenin gruplarÄ±nÄ± global grup setine ekle
            componentGroups.forEach(group => allGroupsSet.add(group));
            
            // BileÅŸen grup verisini sakla
            componentGroupData[component.id] = {
                gruplar: [...componentGroups],
                numGroups: numGroups
            };
            
            // Bu bileÅŸenin grup yapÄ±sÄ±nÄ± oluÅŸtur
            APP_STATE.courseData.grupHaritalari[component.id] = {
                gruplar: [...componentGroups], // Bu bileÅŸen iÃ§in grup listesi
                haritalar: {}
            };
            
            // Her grup iÃ§in mapping objesi oluÅŸtur
            componentGroups.forEach(groupName => {
                APP_STATE.courseData.grupHaritalari[component.id].haritalar[groupName] = {};
            });
            
            // Bu bileÅŸenin alt sorularÄ±nÄ± topla
            const componentQuestions = [];
            
            function collectComponentQuestions(nodes) {
                nodes.forEach(node => {
                    if (isQuestionType(node.type) || isRubricType(node.type)) {
                        componentQuestions.push({
                            id: node.id,
                            name: node.name || node.type,
                            questionNumber: getQuestionNumberFromActivity(node.id)
                        });
                    }
                    if (node.children && node.children.length > 0) {
                        collectComponentQuestions(node.children);
                    }
                });
            }
            
            if (component.children && component.children.length > 0) {
                collectComponentQuestions(component.children);
            }
            
            console.log(`  ${component.id} sorularÄ±:`, componentQuestions.map(q => q.id));
            
            // HER GRUP Ä°Ã‡Ä°N GARANTÄ°LÄ° SORU DAÄILIMI - TÃœM SORULAR HER GRUPTA OLMALI
            if (componentQuestions.length > 0) {
                console.log(`ğŸ“ ${componentQuestions.length} soru ${componentGroups.length} gruba daÄŸÄ±tÄ±lÄ±yor...`);
                
                componentGroups.forEach((groupName, groupIndex) => {
                    console.log(`\nğŸ¯ Grup ${groupName} (${groupIndex + 1}/${componentGroups.length}) iÃ§in sÄ±ralama:`);
                    
                    // TÃœM SORULARI KOPYALA - HiÃ§bir soru eksik kalmamalÄ±
                    const shuffledQuestions = [...componentQuestions];
                    
                    // HER GRUP Ä°Ã‡Ä°N FARKLI KARIÅTIRILMIÅ SIRALAMA
                    // Grup indeksine gÃ¶re farklÄ± seed ile karÄ±ÅŸtÄ±rma
                    for (let shuffleRound = 0; shuffleRound <= groupIndex; shuffleRound++) {
                        for (let i = shuffledQuestions.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [shuffledQuestions[i], shuffledQuestions[j]] = [shuffledQuestions[j], shuffledQuestions[i]];
                        }
                    }
                    
                    // DOÄRULAMA: TÃ¼m sorular mevcut mu?
                    const originalQuestionIds = componentQuestions.map(q => q.id).sort();
                    const shuffledQuestionIds = shuffledQuestions.map(q => q.id).sort();
                    
                    if (originalQuestionIds.length !== shuffledQuestionIds.length) {
                        console.error(`âŒ HATA: Grup ${groupName} iÃ§in soru sayÄ±sÄ± uyuÅŸmuyor!`);
                        console.error(`   Orijinal: ${originalQuestionIds.length}, KarÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ: ${shuffledQuestionIds.length}`);
                    }
                    
                    // Eksik sorularÄ± kontrol et
                    const missingQuestions = originalQuestionIds.filter(id => !shuffledQuestionIds.includes(id));
                    const extraQuestions = shuffledQuestionIds.filter(id => !originalQuestionIds.includes(id));
                    
                    if (missingQuestions.length > 0) {
                        console.error(`âŒ EKSIK SORULAR (Grup ${groupName}):`, missingQuestions);
                    }
                    if (extraQuestions.length > 0) {
                        console.error(`âŒ FAZLA SORULAR (Grup ${groupName}):`, extraQuestions);
                    }
                    
                    // SORU HARITASINI OLUÅTUR - Her soruya kaÄŸÄ±t sÄ±rasÄ± ata
                    // DÃœZELTME: Veri yapÄ±sÄ± {position: questionId} formatÄ±nda
                    shuffledQuestions.forEach((question, index) => {
                        const paperOrderNumber = (index + 1).toString();
                        APP_STATE.courseData.grupHaritalari[component.id].haritalar[groupName][paperOrderNumber] = question.id;
                        
                        console.log(`      ğŸ“„ KaÄŸÄ±t sÄ±rasÄ± ${paperOrderNumber}: ${question.id} (${question.name})`);
                    });
                    
                    console.log(`âœ… Grup ${groupName}: ${shuffledQuestions.length} soru baÅŸarÄ±yla haritalandÄ±`);
                });
                
                // Ã‡APRAZ DOÄRULAMA: TÃ¼m gruplarda aynÄ± sorular var mÄ±?
                console.log(`\nğŸ” Ã‡APRAZ DOÄRULAMA - TÃ¼m gruplarda aynÄ± sorular var mÄ±?`);
                // DÃœZELTME: Veri yapÄ±sÄ± {position: questionId} formatÄ±nda, values'larÄ± karÅŸÄ±laÅŸtÄ±rmalÄ±yÄ±z
                const baseGroupQuestions = Object.values(APP_STATE.courseData.grupHaritalari[component.id].haritalar[componentGroups[0]] || {}).sort();
                
                let allGroupsValid = true;
                componentGroups.forEach(groupName => {
                    const groupQuestions = Object.values(APP_STATE.courseData.grupHaritalari[component.id].haritalar[groupName] || {}).sort();
                    
                    if (JSON.stringify(baseGroupQuestions) !== JSON.stringify(groupQuestions)) {
                        console.error(`âŒ HATA: Grup ${groupName} farklÄ± sorulara sahip!`);
                        console.error(`   Beklenen: ${baseGroupQuestions}`);
                        console.error(`   Mevcut: ${groupQuestions}`);
                        allGroupsValid = false;
                    } else {
                        console.log(`âœ… Grup ${groupName}: TÃ¼m sorular mevcut (${groupQuestions.length} soru)`);
                    }
                });
                
                if (allGroupsValid) {
                    console.log(`ğŸ‰ ${component.id} bileÅŸeni: TÃ¼m gruplarda aynÄ± sorular mevcut!`);
                } else {
                    console.error(`âŒ ${component.id} bileÅŸeni: Grup soru daÄŸÄ±lÄ±mÄ±nda hata var!`);
                }
            } else {
                console.log(`â„¹ï¸ ${component.id} bileÅŸeninde soru yok (Laboratuvar tipi)`);
            }
        });
        
        // TÃ¼m gruplarÄ± birleÅŸtir (A, B, C, D, E... ÅŸeklinde)
        const allGroups = Array.from(allGroupsSet).sort();
        console.log(`\n=== Toplam ${allGroups.length} farklÄ± grup oluÅŸturuldu: ${allGroups.join(', ')} ===`);
        
        // AKILLI Ã–ÄRENCI GRUP ATAMALARI - HER Ã–ÄRENCÄ° MUTLAKA BÄ°R GRUBA ATANACAK
        if (APP_STATE.studentData && APP_STATE.studentData.length > 0) {
            console.log(`\n=== ${APP_STATE.studentData.length} Ã¶ÄŸrenci akÄ±llÄ± ÅŸekilde gruplara atanÄ±yor ===`);
            
            // TÃ¼m Ã¶ÄŸrencileri kopyala ve karÄ±ÅŸtÄ±r
            const students = [...APP_STATE.studentData];
            
            // Fisher-Yates karÄ±ÅŸtÄ±rma algoritmasÄ± ile Ã¶ÄŸrencileri tamamen rastgele sÄ±rala
            for (let i = students.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [students[i], students[j]] = [students[j], students[i]];
            }
            
            // Grup atama sayaÃ§larÄ±
            const groupAssignments = {};
            allGroups.forEach(group => {
                groupAssignments[group] = [];
            });
            
            // ROUND-ROBIN ATAMA: Her Ã¶ÄŸrenci sÄ±rayla gruplara atanÄ±r
            console.log(`ğŸ”„ Round-robin atama baÅŸlatÄ±lÄ±yor...`);
            students.forEach((student, index) => {
                const groupIndex = index % allGroups.length;
                const assignedGroup = allGroups[groupIndex];
                
                // Ã–ÄŸrencinin ana grup bilgisini gÃ¼ncelle
                student.grup = assignedGroup;
                groupAssignments[assignedGroup].push(student);
                
                console.log(`  ${index + 1}. ${student.name} ${student.surname} (${student.studentId}) â†’ Grup ${assignedGroup}`);
                
                // BileÅŸen bazlÄ± grup atamalarÄ±nÄ± baÅŸlat
                if (!APP_STATE.studentComponentGroups) {
                    APP_STATE.studentComponentGroups = {};
                }
                if (!APP_STATE.studentComponentGroups[student.studentId]) {
                    APP_STATE.studentComponentGroups[student.studentId] = {};
                }
                
                // Her bileÅŸen iÃ§in aynÄ± grubu ata (baÅŸlangÄ±Ã§ deÄŸeri olarak)
                mainComponents.forEach(component => {
                    APP_STATE.studentComponentGroups[student.studentId][component.id] = assignedGroup;
                });
            });
            
            // GRUP DAÄILIMI KONTROLÃœ VE RAPORU
            console.log(`\n=== ğŸ“Š DETAYLI GRUP DAÄILIMI RAPORU ===`);
            let totalAssigned = 0;
            let emptyGroups = [];
            
            allGroups.forEach(group => {
                const studentsInGroup = groupAssignments[group];
                const studentCount = studentsInGroup.length;
                totalAssigned += studentCount;
                
                if (studentCount === 0) {
                    emptyGroups.push(group);
                    console.log(`âŒ Grup ${group}: BOÅ GRUP!`);
                } else {
                    console.log(`âœ… Grup ${group}: ${studentCount} Ã¶ÄŸrenci`);
                    studentsInGroup.forEach((s, idx) => {
                        console.log(`     ${idx + 1}. ${s.name} ${s.surname} (${s.studentId})`);
                    });
                }
            });
            
            // DOÄRULAMA KONTROLLERI
            console.log(`\n=== ğŸ” DOÄRULAMA KONTROLLERI ===`);
            console.log(`ğŸ“‹ Toplam Ã¶ÄŸrenci sayÄ±sÄ±: ${students.length}`);
            console.log(`ğŸ“‹ Atanan Ã¶ÄŸrenci sayÄ±sÄ±: ${totalAssigned}`);
            console.log(`ğŸ“‹ Grup sayÄ±sÄ±: ${allGroups.length}`);
            console.log(`ğŸ“‹ BoÅŸ grup sayÄ±sÄ±: ${emptyGroups.length}`);
            
            // Hata kontrolÃ¼
            if (totalAssigned !== students.length) {
                console.error(`âŒ HATA: Atanan Ã¶ÄŸrenci sayÄ±sÄ± toplam Ã¶ÄŸrenci sayÄ±sÄ±na eÅŸit deÄŸil!`);
                showModernToast("Grup atama hatasÄ±: BazÄ± Ã¶ÄŸrenciler atanmadÄ±!", "error");
                return;
            }
            
            if (emptyGroups.length > 0) {
                console.warn(`âš ï¸ UYARI: ${emptyGroups.length} boÅŸ grup var: ${emptyGroups.join(', ')}`);
            }
            
            // Atanmayan Ã¶ÄŸrenci kontrolÃ¼
            const unassignedStudents = students.filter(s => !s.grup || s.grup === '');
            if (unassignedStudents.length > 0) {
                console.error(`âŒ HATA: ${unassignedStudents.length} Ã¶ÄŸrenci atanmadÄ±!`);
                unassignedStudents.forEach(s => {
                    console.error(`  - ${s.name} ${s.surname} (${s.studentId})`);
                    s.grup = 'A'; // GÃ¼venlik iÃ§in A grubuna ata
                });
            }
            
            console.log(`âœ… TÃ¼m Ã¶ÄŸrenciler baÅŸarÄ±yla gruplara atandÄ±!`);
            
            // UI gÃ¼ncellemeleri
            updateStudentTable();
            updateStudentGroupInfoDisplay();
        }
        
        // Grup sistemini yeniden baÅŸlat
        initializeGroupSystem();
        
        // UI gÃ¼ncellemeleri - sÄ±ra Ã¶nemli!
        updateGroupSelectors();
        updateTreeMappingControls();
        updateAllInlineGroupInputs(); // Grup haritalama textarea'larÄ±nÄ± gÃ¼ncelle
        updateAllMappingDisplays();
        
        // Tree'yi yeniden render et (grup bilgileri ile)
        renderTree();
        
        // Grup eÅŸleÅŸtirme renklerini gÃ¼ncelle
        updateGroupMappingColors();
        
        // DeÄŸerlendirme bileÅŸenlerini en son gÃ¼ncelle (grup alanlarÄ± iÃ§in)
        updateAssessmentView();
        
        // DeÄŸerlendirme bileÅŸenlerindeki grup dropdown'larÄ±nÄ± manuel gÃ¼ncelle
        setTimeout(() => {
            updateAssessmentGroupSelectors();
            // updateStudentSelector fonksiyonu kaldÄ±rÄ±ldÄ± (Ã–ÄŸrenci BazlÄ± Not GiriÅŸi sekmesi ile birlikte)
            console.log('Grup dropdown\'larÄ± gÃ¼ncellendi');
        }, 200); // updateAssessmentView'Ä±n tamamlanmasÄ±nÄ± bekle
        
        // BileÅŸen baÅŸÄ±na grup sayÄ±sÄ±nÄ± ve toplam soru sayÄ±sÄ±nÄ± hesapla
        const componentSummary = mainComponents.map(comp => {
            const componentGroups = componentGroupData[comp.id];
            const questions = [];
            function countQuestions(nodes) {
                nodes.forEach(node => {
                    if (isQuestionType(node.type) || isRubricType(node.type)) {
                        questions.push(node.id);
                    }
                    if (node.children && node.children.length > 0) {
                        countQuestions(node.children);
                    }
                });
            }
            if (comp.children) countQuestions(comp.children);
            return {
                componentId: comp.id,
                groupCount: componentGroups.numGroups,
                questionCount: questions.length
            };
        });
        
        const totalQuestions = componentSummary.reduce((sum, comp) => sum + comp.questionCount, 0);
        const totalUniqueGroups = allGroups.length;
        
        // DetaylÄ± bilgi iÃ§in
        const componentDetails = componentSummary.map(comp => 
            `${comp.componentId}: ${comp.groupCount} grup (${comp.questionCount} soru)`
        ).join(', ');
        
        console.log(`\n=== RASTGELE GRUP OLUÅTURMA TAMAMLANDI ===`);
        console.log(`Toplam ${totalUniqueGroups} farklÄ± grup: ${allGroups.join(', ')}`);
        console.log(`BileÅŸen detaylarÄ±: ${componentDetails}`);
        console.log(`Toplam ${APP_STATE.studentData?.length || 0} Ã¶ÄŸrenci rastgele gruplara atandÄ±`);
        console.log(`ğŸ¯ GRUP ATAMALARI TAMAMLANDI`);
        console.log(`APP_STATE.studentComponentGroups:`, APP_STATE.studentComponentGroups);
        
        // Grup daÄŸÄ±lÄ±m Ã¶zetini hazÄ±rla
        const groupDistribution = allGroups.map(group => {
            const studentsInGroup = APP_STATE.studentData.filter(s => s.grup === group);
            return `${group}(${studentsInGroup.length})`;
        }).join(', ');
        
        showModernToast(
            `ğŸ² Rastgele grup daÄŸÄ±lÄ±mÄ± tamamlandÄ±! (${finalGroupCount} grup)\n` +
            `ğŸ“Š ${totalUniqueGroups} grup: ${groupDistribution}\n` +
            `ğŸ“ ${mainComponents.length} bileÅŸende toplam ${totalQuestions} soru eÅŸleÅŸtirildi\n` +
            `ğŸ‘¥ ${APP_STATE.studentData?.length || 0} Ã¶ÄŸrenci dengeli daÄŸÄ±tÄ±ldÄ±`, 
            "success", 6000
        );
        
        // Ã–ÄŸrenci grup bilgilerini gÃ¼ncelle
        updateStudentGroupInfoDisplay();
        
        // Grup istatistiklerini gÃ¼ncelle
        updateGroupStatistics();
        
        // Ä°statistikleri gÃ¼ncelle
        updatePassFailCounts();
        
        // Grup slider'larÄ±nÄ±n sÄ±nÄ±rlarÄ±nÄ± gÃ¼ncelle
        updateGroupSliderLimits();
        
    } catch (error) {
        console.error("âŒ FATAL ERROR: Rastgele gruplar oluÅŸturulurken hata:", error);
        console.error("âŒ ERROR STACK:", error.stack);
        console.error("âŒ ERROR MESSAGE:", error.message);
        console.error("âŒ ERROR NAME:", error.name);
        console.error("âŒ CURRENT APP_STATE:", {
            courseData: APP_STATE.courseData,
            assessmentTree: APP_STATE.assessmentTree,
            studentData: APP_STATE.studentData,
            studentComponentGroups: APP_STATE.studentComponentGroups
        });
        showModernToast("Rastgele gruplar oluÅŸturulamadÄ±! Detay iÃ§in console'u kontrol edin.", "error");
    }
}

/**
 * Rastgele puanlama yapma (Onay ile)
 */
function generateRandomScores() {
    // Mevcut verileri kontrol et
    const hasStudents = APP_STATE.studentData && APP_STATE.studentData.length > 0;
    const hasAssessments = APP_STATE.assessmentTree && APP_STATE.assessmentTree.length > 0;
    const hasExistingScores = (APP_STATE.gradesData && Object.keys(APP_STATE.gradesData).length > 0) ||
                              (APP_STATE.testScores && Object.keys(APP_STATE.testScores).length > 0);
    
    let warningMessage = '';
    
    if (!hasStudents) {
        warningMessage = 'Ã–nce Ã¶ÄŸrenci listesi yÃ¼kleyin!';
        showModernToast(warningMessage, 'warning');
        return;
    }
    
    if (!hasAssessments) {
        warningMessage = 'Ã–nce deÄŸerlendirme bileÅŸenleri oluÅŸturun!';
        showModernToast(warningMessage, 'warning');
        return;
    }
    
    const passRateSlider = document.getElementById('passRateSlider');
    const passRate = passRateSlider ? parseInt(passRateSlider.value) : 70;
    const studentCount = APP_STATE.studentData.length;
    const assessmentCount = APP_STATE.assessmentTree.length;
    
    if (hasExistingScores) {
        const existingScoreCount = Object.keys(APP_STATE.gradesData || {}).length + Object.keys(APP_STATE.testScores || {}).length;
        warningMessage = `Mevcut not verileri silinecek ve yeniden oluÅŸturulacak!\n\n${studentCount} Ã¶ÄŸrenci iÃ§in ${assessmentCount} deÄŸerlendirme bileÅŸeninde %${passRate} geÃ§me oranÄ±na gÃ¶re akÄ±llÄ± puanlama yapÄ±lacak.\n\nMevcut ${existingScoreCount} not verisi kaybolacak. Bu iÅŸlem geri alÄ±namaz. Devam etmek istediÄŸinizden emin misiniz?`;
    } else {
        warningMessage = `${studentCount} Ã¶ÄŸrenci iÃ§in ${assessmentCount} deÄŸerlendirme bileÅŸeninde %${passRate} geÃ§me oranÄ±na gÃ¶re akÄ±llÄ± puanlama yapÄ±lacak.\n\nBu iÅŸlem geri alÄ±namaz. Devam etmek istediÄŸinizden emin misiniz?`;
    }
    
    showModernConfirm(
        'ğŸ§  AkÄ±llÄ± Puanlama Sistemi Uygula',
        warningMessage,
        () => {
            executeGenerateRandomScores();
        }
    );
}

/**
 * Rastgele puanlama yapma (GerÃ§ek iÅŸlem)
 */
function executeGenerateRandomScores() {
    try {
        if (!APP_STATE.studentData || APP_STATE.studentData.length === 0) {
            showModernToast("Ã–nce Ã¶ÄŸrenci listesi yÃ¼kleyin!", "warning");
            return;
        }
        
        if (!APP_STATE.assessmentTree || APP_STATE.assessmentTree.length === 0) {
            showModernToast("Ã–nce deÄŸerlendirme bileÅŸenleri oluÅŸturun!", "warning");
            return;
        }
        
        // APP_STATE.gradesData'yÄ± baÅŸlat
        if (!APP_STATE.gradesData) {
            APP_STATE.gradesData = {};
        }
        
        // GeÃ§en Ã¶ÄŸrenci oranÄ±nÄ± al
        const passRateSlider = document.getElementById('passRateSlider');
        const passRate = passRateSlider ? parseInt(passRateSlider.value) : 70; // VarsayÄ±lan %70
        
        console.log("ğŸ¯ AkÄ±llÄ± rastgele puan oluÅŸturma baÅŸlatÄ±ldÄ±:");
        console.log("ğŸ“Š GeÃ§en Ã¶ÄŸrenci oranÄ±:", passRate + '%');
        console.log("ğŸ‘¥ Ã–ÄŸrenci sayÄ±sÄ±:", APP_STATE.studentData.length);
        console.log("ğŸ“‹ DeÄŸerlendirme aÄŸacÄ±:", APP_STATE.assessmentTree.length);
        
        let scoreCount = 0;
        const totalStudents = APP_STATE.studentData.length;
        
        // AkÄ±llÄ± not daÄŸÄ±lÄ±mÄ± - geÃ§en Ã¶ÄŸrenci oranÄ±na gÃ¶re
        const passingStudents = Math.round(totalStudents * passRate / 100);
        const failingStudents = totalStudents - passingStudents;
        
        console.log(`âœ… GeÃ§ecek Ã¶ÄŸrenci: ${passingStudents} (${passRate}%)`);
        console.log(`âŒ Kalacak Ã¶ÄŸrenci: ${failingStudents} (${100-passRate}%)`);
        
        // GeÃ§en Ã¶ÄŸrenciler iÃ§in not aralÄ±klarÄ± (60-100) - daha gerÃ§ekÃ§i daÄŸÄ±lÄ±m
        const passingGrades = [
            { min: 90, max: 100, grade: 'AA', ratio: 0.10 },  // %10 AA
            { min: 85, max: 89, grade: 'BA', ratio: 0.15 },   // %15 BA
            { min: 80, max: 84, grade: 'BB', ratio: 0.25 },   // %25 BB
            { min: 75, max: 79, grade: 'CB', ratio: 0.25 },   // %25 CB
            { min: 70, max: 74, grade: 'CC', ratio: 0.20 },   // %20 CC
            { min: 60, max: 69, grade: 'DC', ratio: 0.05 }    // %5 DC
        ];
        
        // Kalan Ã¶ÄŸrenciler iÃ§in not aralÄ±klarÄ± (0-59)
        const failingGrades = [
            { min: 50, max: 59, grade: 'DD', ratio: 0.70 },   // %70 DD (50-59)
            { min: 40, max: 49, grade: 'FD', ratio: 0.25 },   // %25 FD (40-49)
            { min: 0, max: 39, grade: 'FF', ratio: 0.05 }     // %5 FF (0-39)
        ];
        
        // Ã–ÄŸrencileri karÄ±ÅŸtÄ±r
        const shuffledStudents = [...APP_STATE.studentData].sort(() => Math.random() - 0.5);
        
        // Her Ã¶ÄŸrenci iÃ§in hedef not aralÄ±ÄŸÄ±nÄ± belirle
        const studentGradeTargets = {};
        let studentIndex = 0;
        
        // GeÃ§en Ã¶ÄŸrencileri daÄŸÄ±t
        for (const gradeInfo of passingGrades) {
            const studentsForThisGrade = Math.round(passingStudents * gradeInfo.ratio);
            for (let i = 0; i < studentsForThisGrade && studentIndex < totalStudents; i++) {
                if (studentIndex < shuffledStudents.length) {
                    studentGradeTargets[shuffledStudents[studentIndex].studentId] = gradeInfo;
                    studentIndex++;
                }
            }
        }
        
        // Kalan geÃ§en Ã¶ÄŸrencileri CC'ye ata
        while (studentIndex < passingStudents && studentIndex < totalStudents) {
            studentGradeTargets[shuffledStudents[studentIndex].studentId] = passingGrades[4]; // CC
            studentIndex++;
        }
        
        // Kalan Ã¶ÄŸrencileri (kalanlar) daÄŸÄ±t
        for (const gradeInfo of failingGrades) {
            const studentsForThisGrade = Math.round(failingStudents * gradeInfo.ratio);
            for (let i = 0; i < studentsForThisGrade && studentIndex < totalStudents; i++) {
                if (studentIndex < shuffledStudents.length) {
                    studentGradeTargets[shuffledStudents[studentIndex].studentId] = gradeInfo;
                    studentIndex++;
                }
            }
        }
        
        // Kalan Ã¶ÄŸrencileri DD'ye ata
        while (studentIndex < totalStudents) {
            studentGradeTargets[shuffledStudents[studentIndex].studentId] = failingGrades[0]; // DD
            studentIndex++;
        }
        
        // Her Ã¶ÄŸrenci iÃ§in hedef nota uygun puanlar oluÅŸtur
        console.log("ğŸ¯ Hedef not daÄŸÄ±lÄ±mÄ± Ã¶rnekleri:", Object.entries(studentGradeTargets).slice(0, 5).map(([id, grade]) => `${id}: ${grade.grade} (${grade.min}-${grade.max})`));
        
        APP_STATE.studentData.forEach(student => {
            const targetGrade = studentGradeTargets[student.studentId];
            
            APP_STATE.assessmentTree.forEach(activity => {
                if (activity.children && activity.children.length > 0) {
                    // Alt bileÅŸenler varsa onlara puan ver
                    activity.children.forEach(subItem => {
                        if (subItem.type === 'Test' && subItem.testDetails) {
                            // Test iÃ§in doÄŸru/yanlÄ±ÅŸ sayÄ±sÄ± - hedef nota gÃ¶re ayarla
                            const totalQuestions = subItem.testDetails.totalQuestions;
                            const targetPercentage = (targetGrade.min + Math.random() * (targetGrade.max - targetGrade.min)) / 100;
                            const correct = Math.floor(totalQuestions * targetPercentage);
                            const remaining = totalQuestions - correct;
                            const wrong = Math.floor(Math.random() * remaining);
                            
                            if (!APP_STATE.testScores) APP_STATE.testScores = {};
                            if (!APP_STATE.testScores[student.studentId]) APP_STATE.testScores[student.studentId] = {};
                            
                            APP_STATE.testScores[student.studentId][subItem.id] = {
                                correct: correct,
                                wrong: wrong,
                                empty: totalQuestions - correct - wrong
                            };
                        } else {
                            // Normal puan - hedef nota gÃ¶re ayarla
                            const maxPoints = subItem.points || 100;
                            const targetScore = targetGrade.min + Math.random() * (targetGrade.max - targetGrade.min);
                            const score = Math.round((targetScore / 100) * maxPoints);
                            
                            if (!APP_STATE.gradesData[student.studentId]) {
                                APP_STATE.gradesData[student.studentId] = {};
                            }
                            APP_STATE.gradesData[student.studentId][subItem.id] = Math.max(0, Math.min(maxPoints, score));
                        }
                        scoreCount++;
                    });
                } else {
                    // Ana aktiviteye direkt puan ver - hedef nota gÃ¶re ayarla
                    const maxPoints = activity.points || 100;
                    const targetScore = targetGrade.min + Math.random() * (targetGrade.max - targetGrade.min);
                    const score = Math.round((targetScore / 100) * maxPoints);
                    
                    if (!APP_STATE.gradesData[student.studentId]) {
                        APP_STATE.gradesData[student.studentId] = {};
                    }
                    APP_STATE.gradesData[student.studentId][activity.id] = Math.max(0, Math.min(maxPoints, score));
                    scoreCount++;
                }
            });
        });
        
        // NotlarÄ± hesapla
        calculateFinalGrades();
        
        // TÃ¼m gÃ¶rÃ¼nÃ¼mleri gÃ¼ncelle
        updateAssessmentView();
        // updateStudentSelector fonksiyonu kaldÄ±rÄ±ldÄ± (Ã–ÄŸrenci BazlÄ± Not GiriÅŸi sekmesi ile birlikte)
        
        // EÄŸer Ã¶ÄŸrenci bazlÄ± not giriÅŸi aÃ§Ä±ksa, seÃ§ili Ã¶ÄŸrenciyi yenile
        if (APP_STATE.selectedStudentId) {
            const container = document.getElementById('studentGradesContainer');
            if (container && container.innerHTML !== '<p class="empty-message">Veri bulunamadÄ±.</p>') {
                showStudentGrades(APP_STATE.selectedStudentId);
            }
        }
        
        // Harf notu daÄŸÄ±lÄ±mÄ±nÄ± hesapla ve gÃ¶ster
        console.log("Final notlarÄ± hesaplanÄ±yor...");
        calculateFinalGrades(); // NotlarÄ± hesapla
        console.log("Final notlarÄ± hesaplandÄ±.");
        
        const gradeDistribution = {};
        
        // APP_STATE.gradesData'dan harf notlarÄ±nÄ± al
        APP_STATE.studentData.forEach(student => {
            const studentGrades = APP_STATE.gradesData[student.studentId];
            if (studentGrades && studentGrades.harfNotu) {
                const letterGrade = studentGrades.harfNotu;
                gradeDistribution[letterGrade] = (gradeDistribution[letterGrade] || 0) + 1;
            }
        });
        
        const distributionText = Object.entries(gradeDistribution)
            .sort(([a], [b]) => {
                const gradeOrder = ['AA', 'BA', 'BB', 'CB', 'CC', 'DC', 'DD', 'FD', 'FF'];
                return gradeOrder.indexOf(a) - gradeOrder.indexOf(b);
            })
            .map(([grade, count]) => `${grade}: ${count}`)
            .join(', ');
        
        // GeÃ§me/kalma analizi
        const actualPassing = Object.values(gradeDistribution).slice(0, 6).reduce((sum, count) => sum + count, 0); // AA-DC arasÄ±
        const actualFailing = Object.values(gradeDistribution).slice(6).reduce((sum, count) => sum + count, 0); // DD-FF arasÄ±
        const actualPassRate = Math.round((actualPassing / totalStudents) * 100);
        
        console.log(`ğŸ“Š GerÃ§ekleÅŸen daÄŸÄ±lÄ±m: GeÃ§en ${actualPassing} (${actualPassRate}%), Kalan ${actualFailing} (${100-actualPassRate}%)`);
        
        showModernToast(`ğŸ¯ ${scoreCount} akÄ±llÄ± puan oluÅŸturuldu! Hedef: %${passRate} geÃ§en â†’ GerÃ§ek: %${actualPassRate} geÃ§en\nğŸ“Š ${distributionText}`, "success", 5000);
        
        // Pass rate gÃ¶stergelerini gÃ¼ncelle
        updatePassRateIndicators();
        
        // Ä°statistikleri gÃ¼ncelle
        updatePassFailCounts();
        
    } catch (error) {
        console.error("Rastgele puanlama yapÄ±lÄ±rken hata:", error);
        showModernToast("Rastgele puanlama yapÄ±lamadÄ±!", "error");
    }
}

/**
 * Test Ã¶ÄŸrencileri oluÅŸturma (Onay ile)
 */
function generateTestStudents() {
    // Mevcut Ã¶ÄŸrenci verilerini kontrol et
    const hasExistingStudents = APP_STATE.studentData && APP_STATE.studentData.length > 0;
    const currentStudentCount = hasExistingStudents ? APP_STATE.studentData.length : 0;
    
    const warningMessage = hasExistingStudents 
        ? `Sistemde zaten ${currentStudentCount} Ã¶ÄŸrenci mevcut. Bu iÅŸlem mevcut Ã¶ÄŸrencilerin Ã¼zerine yazacak ve tÃ¼m not verilerini sÄ±fÄ±rlayacak.\n\nBu iÅŸlem geri alÄ±namaz. Devam etmek istediÄŸinizden emin misiniz?`
        : `10-24 arasÄ± rastgele test Ã¶ÄŸrencisi oluÅŸturulacak. Bu iÅŸlem geri alÄ±namaz.\n\nDevam etmek istediÄŸinizden emin misiniz?`;
    
    showModernConfirm('ğŸ‘¥ Rastgele Test Ã–ÄŸrencileri OluÅŸtur', warningMessage, {
            confirmText: 'Evet, OluÅŸtur',
            cancelText: 'Ä°ptal',
        confirmClass: 'btn-modern-primary',
        cancelClass: 'btn-modern-secondary'
    }).then(() => {
        executeGenerateTestStudents();
    });
}

/**
 * Test Ã¶ÄŸrencileri oluÅŸturma (GerÃ§ek iÅŸlem - Tam Dosya Format uyumlu)
 */
function executeGenerateTestStudents() {
    try {
        const firstNames = ['Ahmet', 'Mehmet', 'AyÅŸe', 'Fatma', 'Ali', 'Veli', 'Zeynep', 'Elif', 'Mustafa', 'Hatice', 'Ä°brahim', 'Emine', 'HÃ¼seyin', 'Meryem', 'Ã–mer', 'Selin', 'Burak', 'Deniz', 'Can', 'Seda'];
        const lastNames = ['YÄ±lmaz', 'Kaya', 'Demir', 'Ã‡elik', 'Åahin', 'YÄ±ldÄ±z', 'YÄ±ldÄ±rÄ±m', 'Ã–ztÃ¼rk', 'Aydin', 'Ã–zdemir', 'Arslan', 'DoÄŸan', 'KÄ±lÄ±Ã§', 'Aslan', 'Ã‡etin', 'KoÃ§', 'Kurt', 'Ã–zkan', 'ErdoÄŸan', 'GÃ¼neÅŸ'];
        
        const numStudents = Math.floor(Math.random() * 15) + 10; // 10-24 Ã¶ÄŸrenci
        const testStudents = [];
        
        console.log(`ğŸ‘¥ ${numStudents} test Ã¶ÄŸrencisi oluÅŸturuluyor...`);
        
        for (let i = 0; i < numStudents; i++) {
            const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
            const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
            const studentId = `2114010${String(i + 50).padStart(2, '0')}`;
            
            // updateStudentTable() ile uyumlu format
            testStudents.push({
                studentId: studentId,
                name: firstName,
                surname: lastName,
                status: Math.random() > 0.9 ? 'Ä°liÅŸiÄŸi KesilmiÅŸ' : 'Aktif', // %10 iliÅŸiÄŸi kesilmiÅŸ
                email: `${firstName.toLowerCase()}_${lastName.toLowerCase()}@erdogan.edu.tr`,
                tcKimlik: `${Math.floor(Math.random() * 90000000000) + 10000000000}`,
                telefon: `05${Math.floor(Math.random() * 900000000) + 100000000}`,
                // Tam dosya formatÄ± iÃ§in alias'lar
                ogrenciNo: studentId,
                ad: firstName,
                soyad: lastName,
                durum: Math.random() > 0.9 ? 'Ä°liÅŸiÄŸi KesilmiÅŸ' : 'Aktif'
            });
        }
        
        // Tam dosya formatÄ±na uygun olarak courseData.ogrenciler'e kaydet
        if (!APP_STATE.courseData) {
            APP_STATE.courseData = {};
        }
        
        // Hem eski sistem hem tam dosya uyumluluÄŸu iÃ§in
        APP_STATE.studentData = testStudents;
        APP_STATE.courseData.ogrenciler = testStudents;
        
        // Ã–ÄŸrenci tablosunu gÃ¼ncelle
        updateStudentTable();
        // updateStudentSelector fonksiyonu kaldÄ±rÄ±ldÄ± (Ã–ÄŸrenci BazlÄ± Not GiriÅŸi sekmesi ile birlikte)
        
        // DeÄŸerlendirme gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ gÃ¼ncelle
        updateAssessmentView();
        
        // AkÄ±llÄ± puanlama Ã¶ÄŸrenci sayÄ±larÄ±nÄ± gÃ¼ncelle
        const passRateSlider = document.getElementById('passRateSlider');
        if (passRateSlider) {
            const passRate = parseInt(passRateSlider.value);
            updateStudentCounts(passRate);
        }
        
        // Ä°statistikleri gÃ¼ncelle
        updatePassFailCounts();
        
        // Dual range slider uyarÄ±sÄ±nÄ± gÃ¼ncelle
        const minSlider = document.getElementById('groupMinSlider');
        const maxSlider = document.getElementById('groupMaxSlider');
        if (minSlider && maxSlider) {
            updateDualRangeWarning(parseInt(minSlider.value), parseInt(maxSlider.value));
        }
        
        // Grup istatistiklerini gÃ¼ncelle
        updateGroupStatistics();
        
        // Grup slider'larÄ±nÄ±n sÄ±nÄ±rlarÄ±nÄ± gÃ¼ncelle
        updateGroupSliderLimits();
        
        showModernToast(`âœ… Tam dosya formatÄ±nda ${numStudents} test Ã¶ÄŸrencisi oluÅŸturuldu!`, "success");
        
    } catch (error) {
        console.error("Test Ã¶ÄŸrencileri oluÅŸturulurken hata:", error);
        showModernToast("Test Ã¶ÄŸrencileri oluÅŸturulamadÄ±!", "error");
    }
}

/**
 * Tam test verisi oluÅŸturma (hepsini birden)
 */
function generateFullTestData() {
    try {
        showModernToast("ğŸš€ KapsamlÄ± test verisi oluÅŸturuluyor...", "info", 3000);
        
        console.log("ğŸ¯ TAM TEST VERÄ°SÄ° OLUÅTURMA BAÅLADI");
        
        // 1. Test Ã¶ÄŸrencileri oluÅŸtur
        console.log("ğŸ‘¥ 1/5 - Test Ã¶ÄŸrencileri oluÅŸturuluyor...");
        generateTestStudents();
        
        // 2. Ã‡eÅŸitli deÄŸerlendirme bileÅŸenleri ekle (gerÃ§ekÃ§i sayÄ±da)
        setTimeout(() => {
            console.log("ğŸ“ 2/5 - DeÄŸerlendirme bileÅŸenleri oluÅŸturuluyor...");
            const assessmentCount = Math.floor(Math.random() * 3) + 4; // 4-6 deÄŸerlendirme
            
            for (let i = 0; i < assessmentCount; i++) {
                generateRandomAssessment();
            }
            
            // 3. Rastgele gruplar oluÅŸtur (deÄŸerlendirmeler oluÅŸturulduktan sonra)
            setTimeout(() => {
                console.log("ğŸ² 3/5 - Grup sistemleri oluÅŸturuluyor...");
                generateRandomGroups();
                
                // 4. Rastgele puanlar ver
                setTimeout(() => {
                    console.log("ğŸ“Š 4/5 - Rastgele puanlar oluÅŸturuluyor...");
                    generateRandomScores();
                    
                    // 5. TÃ¼m gÃ¶rÃ¼nÃ¼mleri gÃ¼ncelle ve finalize et
                    setTimeout(() => {
                        console.log("ğŸ”„ 5/5 - UI gÃ¼ncellemeleri yapÄ±lÄ±yor...");
                        
                        // KapsamlÄ± UI gÃ¼ncellemeleri
                        updateAssessmentView();
                        updateCategoryWeights();
                        renderTree();
                        // updateStudentSelector fonksiyonu kaldÄ±rÄ±ldÄ± (Ã–ÄŸrenci BazlÄ± Not GiriÅŸi sekmesi ile birlikte)
                        updateGroupSelectors();
                        updateTreeMappingControls();
                        updateAllInlineGroupInputs();
                        updateAllMappingDisplays();
                        
                        // EÄŸer farklÄ± sekmeler aÃ§Ä±ksa onlarÄ± da gÃ¼ncelle
                        const activeTab = document.querySelector('.nav-tab.active');
                        if (activeTab) {
                            const tabId = activeTab.getAttribute('data-tab');
                            if (tabId === 'assessment') {
                                updateAssessmentView();
                                                         // Ã–ÄŸrenci bazlÄ± not giriÅŸi sekmesi kaldÄ±rÄ±ldÄ±
                            }
                        }
                        
                        // Ã–zet bilgileri
                        const studentCount = APP_STATE.studentData?.length || 0;
                        const assessmentCount = APP_STATE.assessmentTree?.length || 0;
                        const groupCount = Object.keys(APP_STATE.courseData?.grupHaritalari || {}).length;
                        
                        console.log("âœ… TAM TEST VERÄ°SÄ° OLUÅTURMA TAMAMLANDI");
                        console.log(`ğŸ“Š Ã–zet: ${studentCount} Ã¶ÄŸrenci, ${assessmentCount} deÄŸerlendirme, ${groupCount} grup sistemi`);
                        
                        showModernToast(
                            `ğŸ‰ Tam test verisi baÅŸarÄ±yla oluÅŸturuldu!\n` +
                            `ğŸ‘¥ ${studentCount} Ã¶ÄŸrenci\n` +
                            `ğŸ“ ${assessmentCount} deÄŸerlendirme bileÅŸeni\n` +
                            `ğŸ² ${groupCount} grup sistemi\n` +
                            `ğŸ“Š Rastgele puanlar atandÄ±`, 
                            "success", 6000
                        );
                        
                    }, 800);
                }, 1200);
            }, 800);
        }, 600);
        
    } catch (error) {
        console.error("âŒ Tam test verisi oluÅŸturulurken hata:", error);
        showModernToast("Tam test verisi oluÅŸturulamadÄ±!", "error");
    }
}

/**
 * TÃ¼m test verilerini temizleme
 */
function clearAllTestData() {
    try {
        console.log("ğŸ”§ clearAllTestData baÅŸlatÄ±ldÄ±");
        
        // Ã–nce silinecek veri var mÄ± kontrol et
        const hasData = (APP_STATE.studentData && APP_STATE.studentData.length > 0) ||
                       (APP_STATE.assessmentTree && APP_STATE.assessmentTree.length > 0) ||
                       (APP_STATE.gradesData && Object.keys(APP_STATE.gradesData).length > 0) ||
                       (APP_STATE.testScores && Object.keys(APP_STATE.testScores).length > 0);
        
        if (!hasData) {
            showModernToast("â„¹ï¸ Silinecek test verisi bulunmuyor.", "info");
            return;
        }
        
        // Modern onay modalÄ± kullan
        showModernConfirm('ğŸ§ª TÃ¼m Test Verilerini Sil', 'TÃ¼m test verileri silinecek (Ã¶ÄŸrenciler, deÄŸerlendirmeler, notlar, gruplar). Bu iÅŸlem geri alÄ±namaz! Emin misiniz?', {
            confirmText: 'Evet, Sil',
            cancelText: 'Ä°ptal',
            confirmClass: 'btn-modern-danger',
            cancelClass: 'btn-modern-secondary'
        }).then(() => {
                console.log("âœ… clearAllTestData onaylandÄ±, temizleme baÅŸlÄ±yor...");
        
                // 1. TÃ¼m verileri koordineli ÅŸekilde temizle
        APP_STATE.studentData = [];
        APP_STATE.assessmentTree = [];
        APP_STATE.gradesData = {};
        APP_STATE.testScores = {};
        APP_STATE.courseData = {
            grupHaritalari: { A: {} }
        };
        APP_STATE.selectedStudentId = null;
                APP_STATE.selectedNode = null;
        
                // 2. UI'larÄ± gÃ¼venli ÅŸekilde gÃ¼ncelle
        updateStudentTable();
        renderTree();
                if (typeof updateGroupSelectors === 'function') {
        updateGroupSelectors();
                }
        updateAssessmentView();
        updateCategoryWeights();
                if (typeof updateTreeMappingControls === 'function') {
        updateTreeMappingControls();
                }
        
                // 3. Containers'Ä± temizle
        const containers = [
            'studentGradesContainer',
            'assessmentContainer',
            'gradesTableContainer'
        ];
        
        containers.forEach(containerId => {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = '<p class="empty-message">Veri bulunamadÄ±.</p>';
            }
        });
        
                // 4. Not tablosunu gÃ¼venli ÅŸekilde temizle
                try {
                    updateGradesTable([]);
                } catch (tableError) {
                    console.warn("âš ï¸ Not tablosu gÃ¼ncellenirken hata (gÃ¶rmezden gelindi):", tableError);
                    const gradesTable = document.getElementById('gradesTable');
                    if (gradesTable) {
                        const tbody = gradesTable.querySelector('tbody');
                        if (tbody) {
                            tbody.innerHTML = '<tr><td colspan="8" class="empty-message">Not giriÅŸi yapÄ±lmadÄ±</td></tr>';
                        }
                    }
        }
        
                // 5. Grup slider'larÄ±nÄ±n sÄ±nÄ±rlarÄ±nÄ± sÄ±fÄ±rla
                if (typeof updateGroupSliderLimits === 'function') {
        updateGroupSliderLimits();
                }
        
                // 6. AkÄ±llÄ± puanlama sayÄ±larÄ±nÄ± sÄ±fÄ±rla (Ã¶ÄŸrenci kalmadÄ±ÄŸÄ± iÃ§in)
        const passRateSlider = document.getElementById('passRateSlider');
        if (passRateSlider) {
            const passRate = parseInt(passRateSlider.value);
                    if (typeof updateStudentCounts === 'function') {
            updateStudentCounts(passRate);
                    }
        }
        
                // 7. Dual range slider uyarÄ±sÄ±nÄ± gÃ¼ncelle (Ã¶ÄŸrenci kalmadÄ±ÄŸÄ± iÃ§in)
        const minSlider = document.getElementById('groupMinSlider');
        const maxSlider = document.getElementById('groupMaxSlider');
                if (minSlider && maxSlider && typeof updateDualRangeWarning === 'function') {
            updateDualRangeWarning(parseInt(minSlider.value), parseInt(maxSlider.value));
        }
        
                showModernToast("ğŸ§ª TÃ¼m test verileri koordineli ÅŸekilde temizlendi!", "success");
        });
        
    } catch (error) {
        console.error("âŒ Test verileri temizlenirken hata:", error);
        showModernToast("Test verileri temizlenemedi!", "error");
    }
}

/**
 * Test ders datasÄ± oluÅŸturma (data-input Ã¶rneklerine benzer)
 */
/**
 * Test ders verisi oluÅŸturma (Onay ile)
 */
function generateTestCourseData() {
    // Mevcut verileri kontrol et
    const hasExistingData = APP_STATE.courseData && (
        (APP_STATE.courseData.ogrenciler && APP_STATE.courseData.ogrenciler.length > 0) ||
        (APP_STATE.assessmentTree && APP_STATE.assessmentTree.length > 0)
    );
    
    const warningMessage = hasExistingData 
        ? `Bu iÅŸlem mevcut tÃ¼m ders verilerini (Ã¶ÄŸrenciler, deÄŸerlendirmeler, notlar) tamamen deÄŸiÅŸtirecek ve kapsamlÄ± MUDEK uyumlu test verisi oluÅŸturacak.\n\nBu iÅŸlem geri alÄ±namaz. Devam etmek istediÄŸinizden emin misiniz?`
        : `KapsamlÄ± MUDEK uyumlu test ders verisi oluÅŸturulacak (Ã¶ÄŸrenciler, deÄŸerlendirmeler, haftalÄ±k iÃ§erikler, Ã¶ÄŸrenme Ã§Ä±ktÄ±larÄ±).\n\nBu iÅŸlem geri alÄ±namaz. Devam etmek istediÄŸinizden emin misiniz?`;
    
        showModernConfirm('ğŸ“š Test Ders Verisi OluÅŸtur', warningMessage, {
                confirmText: 'Evet, OluÅŸtur',
                cancelText: 'Ä°ptal',
            confirmClass: 'btn-modern-primary',
            cancelClass: 'btn-modern-secondary'
        }).then(() => {
            executeGenerateTestCourseData();
        });
}

/**
 * Test ders verisi oluÅŸturma (GerÃ§ek iÅŸlem)
 */
function executeGenerateTestCourseData() {
    try {
        showModernToast("ğŸ“ Tam dosya formatÄ±nda tam MUDEK uyumlu test ders verisi oluÅŸturuluyor...", "info", 4000);
        
        // Test Ã¶ÄŸrencileri oluÅŸtur (kiÅŸisel veriler deÄŸiÅŸtirilecek)
        const testStudents = [];
        const turkishNames = [
            'Ahmet', 'Mehmet', 'Ali', 'Mustafa', 'Hasan', 'HÃ¼seyin', 'Ä°brahim', 'Osman', 'Yusuf', 'Murat',
            'Fatma', 'AyÅŸe', 'Emine', 'Hatice', 'Zeynep', 'Elif', 'Merve', 'BÃ¼ÅŸra', 'Seda', 'Ã–zge',
            'Emre', 'Burak', 'Cem', 'Deniz', 'Ege', 'Furkan', 'GÃ¶khan', 'Halil', 'Ä°smail', 'Kemal',
            'Selin', 'TuÄŸba', 'ÃœlkÃ¼', 'Vildan', 'Wanda', 'Ximena', 'Yasemin', 'Zara', 'AslÄ±', 'Berna'
        ];
        const turkishSurnames = [
            'YÄ±lmaz', 'Kaya', 'Demir', 'Åahin', 'Ã‡elik', 'YÄ±ldÄ±z', 'YÄ±ldÄ±rÄ±m', 'Ã–ztÃ¼rk', 'Aydin', 'Ã–zdemir',
            'Arslan', 'DoÄŸan', 'KÄ±lÄ±Ã§', 'Aslan', 'Ã‡etin', 'Kara', 'KoÃ§', 'Kurt', 'Ã–zkan', 'ÅimÅŸek',
            'Polat', 'GÃ¼ler', 'TÃ¼rk', 'Acar', 'Bulut', 'ErdoÄŸan', 'Keskin', 'TaÅŸ', 'AkÄ±n', 'Bayram'
        ];
        
        // 15-25 arasÄ± Ã¶ÄŸrenci oluÅŸtur
        const numStudents = Math.floor(Math.random() * 11) + 15;
        
        for (let i = 0; i < numStudents; i++) {
            const firstName = turkishNames[Math.floor(Math.random() * turkishNames.length)];
            const lastName = turkishSurnames[Math.floor(Math.random() * turkishSurnames.length)];
            const studentNo = `2114010${String(i + 50).padStart(2, '0')}`;
            const tcKimlik = String(Math.floor(Math.random() * 90000000000) + 10000000000);
            const phone = `05${Math.floor(Math.random() * 900000000) + 100000000}`;
            
            testStudents.push({
                ogrenciNo: studentNo,
                ad: firstName,
                soyad: lastName,
                durum: Math.random() > 0.85 ? 'Ä°liÅŸiÄŸi KesilmiÅŸ' : 'Aktif',
                email: `${firstName.toLowerCase()}_${lastName.toLowerCase()}21@erdogan.edu.tr`,
                tcKimlik: tcKimlik,
                telefon: phone
            });
        }
        
        // GerÃ§ek MUDEK dosyasÄ±ndan test ders datasÄ± oluÅŸtur (sadece kiÅŸisel veriler deÄŸiÅŸtirilir)
        const testCourseData = {
            "disaAktarmaTarihi": new Date().toISOString(),
            "dersBilgisi": {
                "dersKodu": "CE100",
                "dersAdi": "Algorithms And Programming II",
                "akademikYil": "2024-2025",
                "donem": "Bahar DÃ¶nemi",
                "ogretimUyesi": "DOKTOR Ã–ÄRETÄ°M ÃœYESÄ° TEST HOCASI"
            },
            "ogrenciler": testStudents,
            "dersDegerlendirme": {
                "yariyilIciEtkinlikleri": [
                    {
                        "etkinlik": "Ara SÄ±nav",
                        "sayi": 1,
                        "katkiYuzdesi": 50
                    },
                    {
                        "etkinlik": "Ev Ã–devi",
                        "sayi": 4,
                        "katkiYuzdesi": 33
                    },
                    {
                        "etkinlik": "Laboratuvar",
                        "sayi": 15,
                        "katkiYuzdesi": 17
                    }
                ],
                "yariyilIciToplam": 100,
                "yariyilSonuEtkinlikleri": [
                    {
                        "etkinlik": "Final SÄ±navÄ±",
                        "sayi": 1,
                        "katkiYuzdesi": 100
                    }
                ],
                "yariyilSonuToplam": 100,
                "genelDegerlendirme": [
                    {
                        "degerlendirme": "YarÄ±yÄ±l (YÄ±l) Sonu Etkinlikleri",
                        "katkiYuzdesi": 60
                    },
                    {
                        "degerlendirme": "YarÄ±yÄ±l (YÄ±l) Ä°Ã§i Etkinlikleri",
                        "katkiYuzdesi": 40
                    }
                ],
                "genelDegerlendirmeToplam": 100
            },
            "ogrenciNotlari": {},
            "dersGenel": {
                "dersTuru": "Zorunlu",
                "dersinSeviyesi": "Lisans",
                "haftalikDersSaatiKuramsal": 3,
                "haftalikUygulamaSaati": 0,
                "haftalikLaboratuarSaati": 2,
                "dersinVerildigiYariyil": 2,
                "ogretimSistemi": "Birinci Ã–ÄŸretim",
                "egitimDili": "Ä°ngilizce",
                "universite": "Recep Tayyip ErdoÄŸan Ãœniversitesi",
                "ulke": "TÃ¼rkiye",
                "il": "Rize",
                "ilce": "Merkez",
                "mahalle": "Fener Mah",
                "fakulte": "MÃ¼hendislik Ve MimarlÄ±k FakÃ¼ltesi",
                "bolum": "Bilgisayar MÃ¼hendisliÄŸi",
                "dersKodu": "CE100",
                "dersAdi": "Algorithms and Programming II",
                "ogretimYiliDonemi": "Bahar",
                "dersAKTSKredisi": 5,
                "dilSecimi": "Ä°ngilizce",
                "mufredatOlusturulmaYili": "2020",
                "akademikYil": "2024-2025 Bahar",
                "dersKredisi": 4
            },
            "dersIcerik": {
                "dersinAmaci": "Bu ders Algoritmalar ve Programlama I dersinin devamÄ± niteliÄŸindedir. Bu derste Algoritmalar ve Programlama I dersinde Ã¶ÄŸrenilen programlama becerileri, ortak problemler ve Ã§Ã¶zÃ¼m algoritmalarÄ± ile bÃ¼tÃ¼nleÅŸir. Bu ders, algoritmalarÄ±n yaygÄ±n sorunlar iÃ§in nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± analiz etmek ve anlamakla ilgilidir. SÄ±nÄ±f, uzmanlÄ±k paylaÅŸÄ±mÄ±na dayalÄ± olacak ve Ã¶ÄŸrencilerin algoritma ve programlama konularÄ± iÃ§in Ã¶ÄŸrenme yÃ¶ntemleri ve uygulamalarÄ± bulmalarÄ±na rehberlik edilecektir. Derslerde programlama uygulamalarÄ± ve projeleri yapÄ±lacaktÄ±r. Teoriden Ã§ok uygulama yapÄ±larak Ã¶ÄŸrenme sÃ¼reci gÃ¼Ã§lendirilecektir.",
                "dersinOnKosuluOlanDersler": "CE103 (Algorithms and Programming-I)",
                "dersinIcerigi": "Algoritma Temelleri, SÃ¶zde Kodlama, Zaman KarmaÅŸÄ±klÄ±ÄŸÄ± ve Asimptotik GÃ¶sterim iÃ§in Algoritma Analizi, SÄ±ralama SorunlarÄ± (Ekleme ve BirleÅŸtirme SÄ±ralamalarÄ±), Ã–zyinelemeli Algoritmalar, BÃ¶l ve Fethet Analizi (BirleÅŸtirme SÄ±ralama, Ä°kili Arama), Matris Ã‡arpma Problemi, HÄ±zlÄ± SÄ±ralama Analizi, YÄ±ÄŸÄ±nlar, YÄ±ÄŸÄ±n SÄ±ralama ve Ã–ncelik KuyruklarÄ±, BaÄŸlantÄ±lÄ± Listeler, Radix SÄ±ralamasÄ± ve Sayma SÄ±ralamasÄ±, DÄ±ÅŸbÃ¼key GÃ¶vde (Convex Hull), Dinamik Programlama, AÃ§gÃ¶zlÃ¼ Algoritmalar, Grafikler ve Grafikler Arama AlgoritmalarÄ± (GeniÅŸlik-Ä°lk Arama, Derinlik-Ä°lk Arama ve Topolojik SÄ±ralama), Grafik YapÄ±sÄ± AlgoritmalarÄ± (GÃ¼Ã§lÃ¼ BaÄŸlantÄ±lÄ± BileÅŸenler, Minimum YayÄ±lma AÄŸacÄ±), AyrÄ±k KÃ¼me Ä°ÅŸlemleri, Tek KaynaklÄ± En KÄ±sa Yol AlgoritmasÄ±, Q-Learning En KÄ±sa Yol UygulamasÄ±, AÄŸ AkÄ±ÅŸÄ± ve UygulamalarÄ±, Veri Ã–zetleme ve Åifreleme.",
                "dersinIcinOnerilenHususlar": "Ã–ÄŸrencilerin Algoritmalar ve Programlama I dersindeki temel programlama bilgisine sahip olmasÄ±, derslere dÃ¼zenli katÄ±lÄ±mÄ± ve laboratuvar Ã§alÄ±ÅŸmalarÄ±nÄ±/Ã¶devleri zamanÄ±nda yapmasÄ± beklenmektedir. Teorik konularÄ±n pratik uygulamalarla pekiÅŸtirilmesi Ã¶nemlidir.",
                "ogretimTuru": "Birinci Ã–ÄŸretim",
                "stajDurumu": "Mevcut DeÄŸil",
                "dersinKitabiMalzemesiOnerilenKaynaklar": "1. Paul Deitel ve Harvey Deitel. 2012. C How to Program (7. baskÄ±). Prentice Hall Press, USA.\n2. Intro to Java Programming, Comprehensive Version (10th Edition) 10th Edition by Y. Daniel Liang\n3. Introduction to Algorithms, Third Edition By Thomas H. Cormen, Charles E. Leiserson, Ronald L. Rivest, and Clifford Stein\n4. Problem Solving and Program Design in C, J.R. Hanly, and E.B. Koffman, 6th Edition.\n5. Robert Sedgewick and Kevin Wayne. 2011. Algorithms (4th. ed.). Addison-Wesley Professional.\n6. Harvey M. Deitel and Paul J. Deitel. 2001. Java How to Program (4th. ed.). Prentice-Hall PTR, USA.\n7. Paul Deitel ve Harvey Deitel. 2016. Visual C# How to Program (6th. ed.). Pearson.",
                "dersiVerenOgretimUyesiOgretimGorevlisi": "Dr. Ã–ÄŸr. Ãœyesi TEST HOCASI",
                "hazirlanmaTarihi": new Date().toLocaleDateString('tr-TR'),
                "email": "test.hoca@erdogan.edu.tr",
                "avesisProfile": "https://avesis.erdogan.edu.tr/test.hoca",
                "avesisId": "test.hoca"
            },
            "dersOgrenmeÃ‡iktilari": [
                {
                    "id": "Ã–Ã‡.1",
                    "aciklama": "Verilen bir hesaplama problemi iÃ§in uygun algoritmayÄ± seÃ§er, Ã§Ã¶zÃ¼mÃ¼nÃ¼ tasarlar ve seÃ§ilen bir programlama dilinde (C/C++, Java, C#) uygular."
                },
                {
                    "id": "Ã–Ã‡.2",
                    "aciklama": "AlgoritmalarÄ±n zaman ve bellek karmaÅŸÄ±klÄ±ÄŸÄ±nÄ± asimptotik gÃ¶sterim (BÃ¼yÃ¼k O, Omega, Teta) kullanarak analiz eder."
                },
                {
                    "id": "Ã–Ã‡.3",
                    "aciklama": "Ã–zyinelemeli (recursive) algoritmalarÄ± tasarlar ve yineleme baÄŸÄ±ntÄ±larÄ±nÄ± (Ã¶rn. Master Teoremi) kullanarak karmaÅŸÄ±klÄ±klarÄ±nÄ± analiz eder."
                },
                {
                    "id": "Ã–Ã‡.4",
                    "aciklama": "BÃ¶l ve fethet, dinamik programlama ve aÃ§gÃ¶zlÃ¼ (greedy) algoritma tasarÄ±m paradigmalarÄ±nÄ± anlar ve ilgili problemlere uygular (Ã¶rn. sÄ±ralama, matris Ã§arpÄ±mÄ±, en uzun ortak alt dizi, aktivite seÃ§imi)."
                },
                {
                    "id": "Ã–Ã‡.5",
                    "aciklama": "Graf veri yapÄ±sÄ±nÄ± ve temel graf algoritmalarÄ±nÄ± (BFS, DFS, topolojik sÄ±ralama, minimum yayÄ±lan aÄŸaÃ§, en kÄ±sa yol) anlar ve uygular."
                },
                {
                    "id": "Ã–Ã‡.6",
                    "aciklama": "Hashing, simetrik/asimetrik ÅŸifreleme ve dijital imza gibi temel kriptografik kavramlarÄ± ve algoritmalarÄ± anlar; gÃ¼venlik ve bÃ¼tÃ¼nlÃ¼k saÄŸlamadaki rollerini aÃ§Ä±klar."
                },
                {
                    "id": "Ã–Ã‡.7",
                    "aciklama": "FarklÄ± veri yapÄ±larÄ± (Ã¶rn. yÄ±ÄŸÄ±n, baÄŸlÄ± liste, graf) ve algoritmalarÄ±n (Ã¶rn. sÄ±ralama, arama, graf algoritmalarÄ±) performans Ã¶zelliklerini karÅŸÄ±laÅŸtÄ±rÄ±r ve problem gereksinimlerine gÃ¶re en uygun olanÄ± seÃ§er."
                }
            ],
            "haftalikDersIcerikleri": [
                {
                    "hafta": 1,
                    "icerik": "Ders PlanÄ± ve Ä°letiÅŸim Not Sistemi, Ã–devler ve SÄ±navlar. Algoritma Temelleri, SÃ¶zde Kod, RAM Modeli, Algoritma Maliyet HesaplamasÄ±. Asimptotik Notasyon. SÄ±ralama Problemi.",
                    "iliskiliOgrenmeÃ‡iktisi": "Ã–Ã‡.2, Ã–Ã‡.7",
                    "ogretimOrtami": "SÄ±nÄ±f OrtamÄ±, Bilgisayar LaboratuvarÄ±",
                    "onHazirlik": "Temel algoritma ve programlama bilgisi (CE103)",
                    "ogretimYontemleri": "AnlatÄ±m, Problem Ã‡Ã¶zme, Uygulama",
                    "aracVeGerecler": "Bilgisayar, Projeksiyon, IDE",
                    "kaynakVeMateryal": "Ders NotlarÄ±, Kaynak Kitaplar",
                    "degerlendirmeYontemleri": "-",
                    "odevVeCalisma": "Programlama Ã‡alÄ±ÅŸtayÄ±"
                },
                {
                    "hafta": 2,
                    "icerik": "Yinelemeleri Ã‡Ã¶zme (Yineleme AÄŸacÄ±, Ana YÃ¶ntem ve Geri Yerine Koyma). BÃ¶l ve Fethet Analizi.",
                    "iliskiliOgrenmeÃ‡iktisi": "Ã–Ã‡.3, Ã–Ã‡.4, Ã–Ã‡.7",
                    "ogretimOrtami": "SÄ±nÄ±f OrtamÄ±, Bilgisayar LaboratuvarÄ±",
                    "onHazirlik": "Asimptotik notasyon",
                    "ogretimYontemleri": "AnlatÄ±m, Problem Ã‡Ã¶zme, Uygulama",
                    "aracVeGerecler": "Bilgisayar, Projeksiyon, IDE",
                    "kaynakVeMateryal": "Ders NotlarÄ±, Kaynak Kitaplar",
                    "degerlendirmeYontemleri": "-",
                    "odevVeCalisma": "Programlama Ã‡alÄ±ÅŸtayÄ±"
                },
                {
                    "hafta": 3,
                    "icerik": "Matris Ã‡arpma, Quicksort, Heapsort, Radix Sort, Counting Sort.",
                    "iliskiliOgrenmeÃ‡iktisi": "Ã–Ã‡.1, Ã–Ã‡.2, Ã–Ã‡.4, Ã–Ã‡.7",
                    "ogretimOrtami": "SÄ±nÄ±f OrtamÄ±, Bilgisayar LaboratuvarÄ±",
                    "onHazirlik": "BÃ¶l ve Fethet",
                    "ogretimYontemleri": "AnlatÄ±m, Problem Ã‡Ã¶zme, Uygulama",
                    "aracVeGerecler": "Bilgisayar, Projeksiyon, IDE",
                    "kaynakVeMateryal": "Ders NotlarÄ±, Kaynak Kitaplar",
                    "degerlendirmeYontemleri": "-",
                    "odevVeCalisma": "Programlama Ã‡alÄ±ÅŸtayÄ± (Ara SÄ±nav Ã–devi-1 GÃ¶nderilecek)"
                },
                {
                    "hafta": 4,
                    "icerik": "ArasÄ±nav Ã–devi-1 Kontroller ve Ã–zetle Tekrar",
                    "iliskiliOgrenmeÃ‡iktisi": "Ã–Ã‡.1, Ã–Ã‡.2, Ã–Ã‡.3, Ã–Ã‡.4, Ã–Ã‡.7",
                    "ogretimOrtami": "Bilgisayar LaboratuvarÄ±",
                    "onHazirlik": "Ã–dev-1",
                    "ogretimYontemleri": "Soru-Cevap, DeÄŸerlendirme",
                    "aracVeGerecler": "Bilgisayar, IDE",
                    "kaynakVeMateryal": "Ã–devler",
                    "degerlendirmeYontemleri": "-",
                    "odevVeCalisma": "-"
                },
                {
                    "hafta": 5,
                    "icerik": "Konveks GÃ¶vde (Convex Hull). Dinamik Programlama (Fibonacci, Matris Zinciri Ã‡arpÄ±mÄ±).",
                    "iliskiliOgrenmeÃ‡iktisi": "Ã–Ã‡.4, Ã–Ã‡.7",
                    "ogretimOrtami": "SÄ±nÄ±f OrtamÄ±, Bilgisayar LaboratuvarÄ±",
                    "onHazirlik": "Temel algoritmalar",
                    "ogretimYontemleri": "AnlatÄ±m, Problem Ã‡Ã¶zme, Uygulama",
                    "aracVeGerecler": "Bilgisayar, Projeksiyon, IDE",
                    "kaynakVeMateryal": "Ders NotlarÄ±, Kaynak Kitaplar",
                    "degerlendirmeYontemleri": "-",
                    "odevVeCalisma": "Programlama Ã‡alÄ±ÅŸtayÄ±"
                },
                {
                    "hafta": 6,
                    "icerik": "Dinamik Programlama (LCS). AÃ§gÃ¶zlÃ¼ Algoritmalar (Aktivite SeÃ§imi, SÄ±rt Ã‡antasÄ±).",
                    "iliskiliOgrenmeÃ‡iktisi": "Ã–Ã‡.4, Ã–Ã‡.7",
                    "ogretimOrtami": "SÄ±nÄ±f OrtamÄ±, Bilgisayar LaboratuvarÄ±",
                    "onHazirlik": "Dinamik Programlama temelleri",
                    "ogretimYontemleri": "AnlatÄ±m, Problem Ã‡Ã¶zme, Uygulama",
                    "aracVeGerecler": "Bilgisayar, Projeksiyon, IDE",
                    "kaynakVeMateryal": "Ders NotlarÄ±, Kaynak Kitaplar",
                    "degerlendirmeYontemleri": "-",
                    "odevVeCalisma": "Programlama Ã‡alÄ±ÅŸtayÄ± (Ara SÄ±nav Ã–devi-2 GÃ¶nderilecek)"
                },
                {
                    "hafta": 7,
                    "icerik": "ArasÄ±nav Ã–devi-2 Kontroller ve Ã–zetle Tekrar",
                    "iliskiliOgrenmeÃ‡iktisi": "Ã–Ã‡.1, Ã–Ã‡.2, Ã–Ã‡.3, Ã–Ã‡.4, Ã–Ã‡.7",
                    "ogretimOrtami": "Bilgisayar LaboratuvarÄ±",
                    "onHazirlik": "Ã–dev-2",
                    "ogretimYontemleri": "Soru-Cevap, DeÄŸerlendirme",
                    "aracVeGerecler": "Bilgisayar, IDE",
                    "kaynakVeMateryal": "Ã–devler",
                    "degerlendirmeYontemleri": "-",
                    "odevVeCalisma": "-"
                },
                {
                    "hafta": 8,
                    "icerik": "Vize",
                    "iliskiliOgrenmeÃ‡iktisi": "Ã–Ã‡.1, Ã–Ã‡.2, Ã–Ã‡.3, Ã–Ã‡.4, Ã–Ã‡.7",
                    "ogretimOrtami": "SÄ±nÄ±f OrtamÄ±",
                    "onHazirlik": "1-7 hafta konularÄ±",
                    "ogretimYontemleri": "Ã–lÃ§me DeÄŸerlendirme",
                    "aracVeGerecler": "-",
                    "kaynakVeMateryal": "-",
                    "degerlendirmeYontemleri": "YazÄ±lÄ± SÄ±nav/Proje",
                    "odevVeCalisma": "-"
                },
                {
                    "hafta": 9,
                    "icerik": "YÄ±ÄŸÄ±n Veri YapÄ±sÄ±, YÄ±ÄŸÄ±n SÄ±ralama, Huffman Kodlama.",
                    "iliskiliOgrenmeÃ‡iktisi": "Ã–Ã‡.4, Ã–Ã‡.7",
                    "ogretimOrtami": "SÄ±nÄ±f OrtamÄ±, Bilgisayar LaboratuvarÄ±",
                    "onHazirlik": "Temel veri yapÄ±larÄ±",
                    "ogretimYontemleri": "AnlatÄ±m, Problem Ã‡Ã¶zme, Uygulama",
                    "aracVeGerecler": "Bilgisayar, Projeksiyon, IDE",
                    "kaynakVeMateryal": "Ders NotlarÄ±, Kaynak Kitaplar",
                    "degerlendirmeYontemleri": "-",
                    "odevVeCalisma": "Programlama Ã‡alÄ±ÅŸtayÄ±"
                },
                {
                    "hafta": 10,
                    "icerik": "Grafiklere GiriÅŸ, GÃ¶sterim, BFS, DFS, Topolojik SÄ±ra, SCC, MST, Prim, Kruskal, Tek Kaynak En KÄ±sa Yol.",
                    "iliskiliOgrenmeÃ‡iktisi": "Ã–Ã‡.5, Ã–Ã‡.7",
                    "ogretimOrtami": "SÄ±nÄ±f OrtamÄ±, Bilgisayar LaboratuvarÄ±",
                    "onHazirlik": "Temel veri yapÄ±larÄ±",
                    "ogretimYontemleri": "AnlatÄ±m, Problem Ã‡Ã¶zme, Uygulama",
                    "aracVeGerecler": "Bilgisayar, Projeksiyon, IDE",
                    "kaynakVeMateryal": "Ders NotlarÄ±, Kaynak Kitaplar",
                    "degerlendirmeYontemleri": "-",
                    "odevVeCalisma": "Programlama Ã‡alÄ±ÅŸtayÄ±"
                },
                {
                    "hafta": 11,
                    "icerik": "Q-Learning En KÄ±sa Yol, Max-Flow Min-Cut. Kriptografi: Hashing ve BÃ¼tÃ¼nlÃ¼k KontrolÃ¼.",
                    "iliskiliOgrenmeÃ‡iktisi": "Ã–Ã‡.5, Ã–Ã‡.6, Ã–Ã‡.7",
                    "ogretimOrtami": "SÄ±nÄ±f OrtamÄ±, Bilgisayar LaboratuvarÄ±",
                    "onHazirlik": "Graf algoritmalarÄ±",
                    "ogretimYontemleri": "AnlatÄ±m, Problem Ã‡Ã¶zme, Uygulama",
                    "aracVeGerecler": "Bilgisayar, Projeksiyon, IDE",
                    "kaynakVeMateryal": "Ders NotlarÄ±, Kaynak Kitaplar",
                    "degerlendirmeYontemleri": "-",
                    "odevVeCalisma": "Programlama Ã‡alÄ±ÅŸtayÄ± (Son Ã–dev-1 GÃ¶nderilecek)"
                },
                {
                    "hafta": 12,
                    "icerik": "Son Ã–dev-1 Kontrolleri ve Ã–zetle Ä°nceleme",
                    "iliskiliOgrenmeÃ‡iktisi": "Ã–Ã‡.1, Ã–Ã‡.2, Ã–Ã‡.3, Ã–Ã‡.4, Ã–Ã‡.5, Ã–Ã‡.6, Ã–Ã‡.7",
                    "ogretimOrtami": "Bilgisayar LaboratuvarÄ±",
                    "onHazirlik": "Ã–dev-1",
                    "ogretimYontemleri": "Soru-Cevap, DeÄŸerlendirme",
                    "aracVeGerecler": "Bilgisayar, IDE",
                    "kaynakVeMateryal": "Ã–devler",
                    "degerlendirmeYontemleri": "-",
                    "odevVeCalisma": "-"
                },
                {
                    "hafta": 13,
                    "icerik": "Kriptografi: Simetrik Åifreleme, Asimetrik Åifreleme, Dijital Ä°mza.",
                    "iliskiliOgrenmeÃ‡iktisi": "Ã–Ã‡.6",
                    "ogretimOrtami": "SÄ±nÄ±f OrtamÄ±, Bilgisayar LaboratuvarÄ±",
                    "onHazirlik": "Temel kriptografi kavramlarÄ±",
                    "ogretimYontemleri": "AnlatÄ±m, Problem Ã‡Ã¶zme, Uygulama",
                    "aracVeGerecler": "Bilgisayar, Projeksiyon, IDE, Crypto++",
                    "kaynakVeMateryal": "Ders NotlarÄ±, Kriptografi KaynaklarÄ±",
                    "degerlendirmeYontemleri": "-",
                    "odevVeCalisma": "Programlama Ã‡alÄ±ÅŸtayÄ±"
                },
                {
                    "hafta": 14,
                    "icerik": "Kriptografi: OTP Hesaplama, Dosya Åifreleme/Åifre Ã‡Ã¶zme.",
                    "iliskiliOgrenmeÃ‡iktisi": "Ã–Ã‡.1, Ã–Ã‡.6",
                    "ogretimOrtami": "SÄ±nÄ±f OrtamÄ±, Bilgisayar LaboratuvarÄ±",
                    "onHazirlik": "Åifreleme algoritmalarÄ±",
                    "ogretimYontemleri": "AnlatÄ±m, Problem Ã‡Ã¶zme, Uygulama",
                    "aracVeGerecler": "Bilgisayar, Projeksiyon, IDE, Crypto++",
                    "kaynakVeMateryal": "Ders NotlarÄ±, Kriptografi KaynaklarÄ±",
                    "degerlendirmeYontemleri": "-",
                    "odevVeCalisma": "Programlama Ã‡alÄ±ÅŸtayÄ± (Son Ã–dev-2 GÃ¶nderilecek)"
                },
                {
                    "hafta": 15,
                    "icerik": "Son Ã–dev-2 Kontrolleri ve Ã–zetle Ä°nceleme",
                    "iliskiliOgrenmeÃ‡iktisi": "Ã–Ã‡.1, Ã–Ã‡.2, Ã–Ã‡.3, Ã–Ã‡.4, Ã–Ã‡.5, Ã–Ã‡.6, Ã–Ã‡.7",
                    "ogretimOrtami": "Bilgisayar LaboratuvarÄ±",
                    "onHazirlik": "Ã–dev-2",
                    "ogretimYontemleri": "Soru-Cevap, DeÄŸerlendirme",
                    "aracVeGerecler": "Bilgisayar, IDE",
                    "kaynakVeMateryal": "Ã–devler",
                    "degerlendirmeYontemleri": "-",
                    "odevVeCalisma": "-"
                },
                {
                    "hafta": 16,
                    "icerik": "Final",
                    "iliskiliOgrenmeÃ‡iktisi": "Ã–Ã‡.1, Ã–Ã‡.2, Ã–Ã‡.3, Ã–Ã‡.4, Ã–Ã‡.5, Ã–Ã‡.6, Ã–Ã‡.7",
                    "ogretimOrtami": "SÄ±nÄ±f OrtamÄ±",
                    "onHazirlik": "TÃ¼m konular",
                    "ogretimYontemleri": "Ã–lÃ§me DeÄŸerlendirme",
                    "aracVeGerecler": "-",
                    "kaynakVeMateryal": "-",
                    "degerlendirmeYontemleri": "YazÄ±lÄ± SÄ±nav/Proje",
                    "odevVeCalisma": "-"
                }
            ],
            "dersIsYuku": {
                "etkinlikler": [
                    {
                        "etkinlik": "Derse KatÄ±lÄ±m",
                        "sayi": 14,
                        "sure": 3,
                        "toplamIsYuku": 42
                    },
                    {
                        "etkinlik": "Laboratuvar",
                        "sayi": 14,
                        "sure": 2,
                        "toplamIsYuku": 28
                    },
                    {
                        "etkinlik": "Bireysel Ã‡alÄ±ÅŸma",
                        "sayi": 14,
                        "sure": 1.8571428571428572,
                        "toplamIsYuku": 26
                    },
                    {
                        "etkinlik": "Ara SÄ±nav",
                        "sayi": 1,
                        "sure": 1,
                        "toplamIsYuku": 1
                    },
                    {
                        "etkinlik": "Ara SÄ±nav Ä°Ã§in Bireysel Ã‡alÄ±ÅŸma",
                        "sayi": 1,
                        "sure": 6,
                        "toplamIsYuku": 6
                    },
                    {
                        "etkinlik": "Ev Ã–devi",
                        "sayi": 4,
                        "sure": 1,
                        "toplamIsYuku": 4
                    },
                    {
                        "etkinlik": "Bireysel Ã‡alÄ±ÅŸma",
                        "sayi": 4,
                        "sure": 2,
                        "toplamIsYuku": 8
                    },
                    {
                        "etkinlik": "Final SÄ±navÄ±",
                        "sayi": 1,
                        "sure": 2,
                        "toplamIsYuku": 2
                    },
                    {
                        "etkinlik": "Final SÄ±navÄ± Ä°Ã§in Bireysel Ã‡alÄ±ÅŸma",
                        "sayi": 1,
                        "sure": 8,
                        "toplamIsYuku": 8
                    }
                ],
                "toplamIsYuku": 125,
                "dersAKTSKredisi": 5,
                "hesaplama": "Dersin AKTS Kredisi = Toplam Ä°ÅŸ YÃ¼kÃ¼ (Saat) / 25 = 5",
                "aktsHesaplama": "Toplam Ä°ÅŸ YÃ¼kÃ¼ / 25"
            },
            "programCiktilari": [
                {
                    "id": "PÃ‡.1",
                    "kategori": "BÄ°LGÄ° - Kuramsal Olgusal",
                    "aciklama": "TEMEL BÄ°LGÄ°: Matematik, Fen Bilimleri ve Bilgisayar MÃ¼hendisliÄŸi konularÄ±nda yeterli bilgi sahibidir; bu alanlardaki kuramsal ve uygulamalÄ± bilgileri, karmaÅŸÄ±k mÃ¼hendislik problemlerinde kullanÄ±r."
                },
                {
                    "id": "PÃ‡.2",
                    "kategori": "BECERÄ°LER - BiliÅŸsel UygulamalÄ±",
                    "aciklama": "PROBLEM Ã‡Ã–ZME: KarmaÅŸÄ±k Bilgisayar MÃ¼hendisliÄŸi problemlerini saptar, tanÄ±mlar, formÃ¼le eder ve Ã§Ã¶zer; bu amaca uygun analiz ve modelleme yÃ¶ntemlerini seÃ§er ve uygular."
                },
                {
                    "id": "PÃ‡.3",
                    "kategori": "BECERÄ°LER - BiliÅŸsel UygulamalÄ±",
                    "aciklama": "TASARIM: KarmaÅŸÄ±k bir sistemi, sÃ¼reci, cihazÄ± veya Ã¼rÃ¼nÃ¼ gerÃ§ekÃ§i kÄ±sÄ±tlar ve koÅŸullar altÄ±nda, belirli gereksinimleri karÅŸÄ±layacak ÅŸekilde tasarlar; bu amaÃ§la modern tasarÄ±m yÃ¶ntemlerini uygular."
                },
                {
                    "id": "PÃ‡.4",
                    "kategori": "BECERÄ°LER - BiliÅŸsel UygulamalÄ±",
                    "aciklama": "TEKNOLOJÄ°: Bilgisayar MÃ¼hendisliÄŸi uygulamalarÄ±nda karÅŸÄ±laÅŸÄ±lan karmaÅŸÄ±k problemlerin analizi ve Ã§Ã¶zÃ¼mÃ¼ iÃ§in gerekli olan modern teknik ve araÃ§larÄ± geliÅŸtirir, seÃ§er ve kullanÄ±r; biliÅŸim teknolojilerini etkin bir ÅŸekilde kullanÄ±r."
                },
                {
                    "id": "PÃ‡.5",
                    "kategori": "BECERÄ°LER - BiliÅŸsel UygulamalÄ±",
                    "aciklama": "ARAÅTIRMA: KarmaÅŸÄ±k Bilgisayar MÃ¼hendisliÄŸi problemlerinin veya araÅŸtÄ±rma konularÄ±nÄ±n incelenmesi iÃ§in deney tasarlar, deney yapar, veri toplar, sonuÃ§larÄ± analiz eder ve yorumlar."
                },
                {
                    "id": "PÃ‡.6",
                    "kategori": "YETKÄ°NLÄ°KLER - BaÄŸÄ±msÄ±z Ã‡alÄ±ÅŸabilme ve Sorumluluk Alabilme YetkinliÄŸi",
                    "aciklama": "Ä°ÅBÄ°RLÄ°ÄÄ°: Bilgisayar MÃ¼hendisliÄŸi disiplini iÃ§inde ve Ã§ok disiplinli takÄ±mlarda etkin biÃ§imde Ã§alÄ±ÅŸÄ±r; bireysel Ã§alÄ±ÅŸma sergiler."
                },
                {
                    "id": "PÃ‡.7",
                    "kategori": "YETKÄ°NLÄ°KLER - Ã–ÄŸrenme YetkinliÄŸi",
                    "aciklama": "GELÄ°ÅÄ°M: YaÅŸam boyu Ã¶ÄŸrenmenin gerekliliÄŸinin bilincindedir; bilgiye eriÅŸir, bilim ve teknolojideki geliÅŸmeleri izler ve kendini sÃ¼rekli yeniler."
                },
                {
                    "id": "PÃ‡.8",
                    "kategori": "YETKÄ°NLÄ°KLER - Ä°letiÅŸim ve Sosyal Yetkinlik",
                    "aciklama": "Ä°LETÄ°ÅÄ°M: TÃ¼rkÃ§e sÃ¶zlÃ¼ ve yazÄ±lÄ± etkin iletiÅŸim kurar; etkin rapor yazar ve yazÄ±lÄ± raporlarÄ± anlar, tasarÄ±m ve Ã¼retim raporlarÄ± hazÄ±rlar, etkin sunum yapar, aÃ§Ä±k ve anlaÅŸÄ±lÄ±r talimat verir ve alÄ±r."
                },
                {
                    "id": "PÃ‡.9",
                    "kategori": "YETKÄ°NLÄ°KLER - Ä°letiÅŸim ve Sosyal Yetkinlik",
                    "aciklama": "TOPLUMSAL BÄ°LÄ°NÃ‡: Bilgisayar MÃ¼hendisliÄŸi uygulamalarÄ±nÄ±n evrensel ve toplumsal boyutlarda saÄŸlÄ±k, Ã§evre ve gÃ¼venlik Ã¼zerindeki etkileri ve Ã§aÄŸÄ±n mÃ¼hendislik alanÄ±na yansÄ±yan sorunlarÄ± hakkÄ±nda bilgi sahibidir."
                },
                {
                    "id": "PÃ‡.10",
                    "kategori": "YETKÄ°NLÄ°KLER - Ä°letiÅŸim ve Sosyal Yetkinlik",
                    "aciklama": "ULUSLARARASILIK: Bir yabancÄ± dili kullanarak Bilgisayar MÃ¼hendisliÄŸi ile iliÅŸkili konularda, bilgi toplar ve meslektaÅŸlarÄ± ile iletiÅŸim kurar."
                },
                {
                    "id": "PÃ‡.11",
                    "kategori": "YETKÄ°NLÄ°KLER - Alana Ã–zgÃ¼ Yetkinlik",
                    "aciklama": "ETÄ°K: Etik ilkelerine uygun davranma, mesleki ve etik sorumluluk bilincine sahiptir; mÃ¼hendislik uygulamalarÄ±nda kullanÄ±lan standartlar hakkÄ±nda bilgi sahibidir."
                },
                {
                    "id": "PÃ‡.12",
                    "kategori": "YETKÄ°NLÄ°KLER - Alana Ã–zgÃ¼ Yetkinlik",
                    "aciklama": "YÃ–NETÄ°M: Proje yÃ¶netimi, risk yÃ¶netimi ve deÄŸiÅŸiklik yÃ¶netimi gibi, iÅŸ hayatÄ±ndaki uygulamalar hakkÄ±nda bilgi sahibidir; giriÅŸimcilik, yenilikÃ§ilik hakkÄ±nda bilinÃ§lidir."
                }
            ],
            "programVeOgrenmeIliskisi": {
                "iliskiOlcekleri": "0-5 arasÄ± deÄŸerler (0: Ä°liÅŸki yok, 5: Ã‡ok gÃ¼Ã§lÃ¼ iliÅŸki)",
                "iliskiTablosu": [
                    {
                        "ogrenmeÃ‡iktisiID": "Ã–Ã‡.1",
                        "programÃ‡iktilariIliskileri": {
                            "PÃ‡.1": 0,
                            "PÃ‡.2": 5,
                            "PÃ‡.3": 0,
                            "PÃ‡.4": 0,
                            "PÃ‡.5": 3,
                            "PÃ‡.6": 0,
                            "PÃ‡.7": 0,
                            "PÃ‡.8": 0,
                            "PÃ‡.9": 3,
                            "PÃ‡.10": 0,
                            "PÃ‡.11": 0,
                            "PÃ‡.12": 0
                        }
                    },
                    {
                        "ogrenmeÃ‡iktisiID": "Ã–Ã‡.2",
                        "programÃ‡iktilariIliskileri": {
                            "PÃ‡.1": 0,
                            "PÃ‡.2": 3,
                            "PÃ‡.3": 0,
                            "PÃ‡.4": 0,
                            "PÃ‡.5": 0,
                            "PÃ‡.6": 3,
                            "PÃ‡.7": 0,
                            "PÃ‡.8": 0,
                            "PÃ‡.9": 0,
                            "PÃ‡.10": 3,
                            "PÃ‡.11": 0,
                            "PÃ‡.12": 0
                        }
                    },
                    {
                        "ogrenmeÃ‡iktisiID": "Ã–Ã‡.3",
                        "programÃ‡iktilariIliskileri": {
                            "PÃ‡.1": 0,
                            "PÃ‡.2": 3,
                            "PÃ‡.3": 3,
                            "PÃ‡.4": 0,
                            "PÃ‡.5": 0,
                            "PÃ‡.6": 0,
                            "PÃ‡.7": 3,
                            "PÃ‡.8": 0,
                            "PÃ‡.9": 0,
                            "PÃ‡.10": 0,
                            "PÃ‡.11": 0,
                            "PÃ‡.12": 0
                        }
                    },
                    {
                        "ogrenmeÃ‡iktisiID": "Ã–Ã‡.4",
                        "programÃ‡iktilariIliskileri": {
                            "PÃ‡.1": 0,
                            "PÃ‡.2": 3,
                            "PÃ‡.3": 0,
                            "PÃ‡.4": 3,
                            "PÃ‡.5": 0,
                            "PÃ‡.6": 0,
                            "PÃ‡.7": 0,
                            "PÃ‡.8": 0,
                            "PÃ‡.9": 0,
                            "PÃ‡.10": 0,
                            "PÃ‡.11": 0,
                            "PÃ‡.12": 0
                        }
                    },
                    {
                        "ogrenmeÃ‡iktisiID": "Ã–Ã‡.5",
                        "programÃ‡iktilariIliskileri": {
                            "PÃ‡.1": 0,
                            "PÃ‡.2": 3,
                            "PÃ‡.3": 0,
                            "PÃ‡.4": 0,
                            "PÃ‡.5": 3,
                            "PÃ‡.6": 0,
                            "PÃ‡.7": 0,
                            "PÃ‡.8": 0,
                            "PÃ‡.9": 3,
                            "PÃ‡.10": 0,
                            "PÃ‡.11": 0,
                            "PÃ‡.12": 0
                        }
                    },
                    {
                        "ogrenmeÃ‡iktisiID": "Ã–Ã‡.6",
                        "programÃ‡iktilariIliskileri": {
                            "PÃ‡.1": 0,
                            "PÃ‡.2": 3,
                            "PÃ‡.3": 0,
                            "PÃ‡.4": 0,
                            "PÃ‡.5": 0,
                            "PÃ‡.6": 3,
                            "PÃ‡.7": 0,
                            "PÃ‡.8": 0,
                            "PÃ‡.9": 0,
                            "PÃ‡.10": 3,
                            "PÃ‡.11": 0,
                            "PÃ‡.12": 0
                        }
                    },
                    {
                        "ogrenmeÃ‡iktisiID": "Ã–Ã‡.7",
                        "programÃ‡iktilariIliskileri": {
                            "PÃ‡.1": 0,
                            "PÃ‡.2": 3,
                            "PÃ‡.3": 3,
                            "PÃ‡.4": 0,
                            "PÃ‡.5": 0,
                            "PÃ‡.6": 0,
                            "PÃ‡.7": 3,
                            "PÃ‡.8": 0,
                            "PÃ‡.9": 0,
                            "PÃ‡.10": 0,
                            "PÃ‡.11": 0,
                            "PÃ‡.12": 0
                        }
                    }
                ]
            },
            "toplumsalKatkiVeSurdurulebilirlik": {
                "surdurulebilirKalkinmaAmaclari": [
                    { "amac": "YoksulluÄŸa Son", "secili": false },
                    { "amac": "AÃ§lÄ±ÄŸa Son", "secili": false },
                    { "amac": "SaÄŸlÄ±k ve Kaliteli YaÅŸam", "secili": false },
                    { "amac": "Nitelikli EÄŸitim", "secili": true },
                    { "amac": "Toplumsal Cinsiyet EÅŸitliÄŸi", "secili": false },
                    { "amac": "Temiz Su ve Sanitasyon", "secili": false },
                    { "amac": "EriÅŸilebilir ve Temiz Enerji", "secili": false },
                    { "amac": "Ä°nsana YakÄ±ÅŸÄ±r Ä°ÅŸ ve Ekonomik BÃ¼yÃ¼me", "secili": true },
                    { "amac": "Sanayi, YenilikÃ§ilik ve AltyapÄ±", "secili": true },
                    { "amac": "EÅŸitsizliklerin AzaltÄ±lmasÄ±", "secili": false },
                    { "amac": "SÃ¼rdÃ¼rÃ¼lebilir Åehirler ve Topluluklar", "secili": false },
                    { "amac": "Sorumlu Ãœretim ve TÃ¼ketim", "secili": true },
                    { "amac": "Ä°klim Eylemi", "secili": false },
                    { "amac": "Sudaki YaÅŸam", "secili": false },
                    { "amac": "Karasal YaÅŸam", "secili": false },
                    { "amac": "BarÄ±ÅŸ, Adalet ve GÃ¼Ã§lÃ¼ Kurumlar", "secili": true },
                    { "amac": "AmaÃ§lar Ä°Ã§in OrtaklÄ±klar", "secili": false }
                ],
                "toplumsalKatkiAlanlari": [
                    { "alan": "EÄŸitim ve Ã–ÄŸretim", "secili": true },
                    { "alan": "SaÄŸlÄ±k", "secili": false },
                    { "alan": "Sosyal Hizmetler ve Toplumsal EÅŸitlik", "secili": false },
                    { "alan": "Ã‡evre ve SÃ¼rdÃ¼rÃ¼lebilirlik", "secili": true },
                    { "alan": "Teknolojik ve Bilimsel Yenilikler", "secili": true },
                    { "alan": "Ekonomik KalkÄ±nma ve GiriÅŸimcilik", "secili": true },
                    { "alan": "KÃ¼ltÃ¼rel ve Sanatsal Etkinlikler", "secili": false },
                    { "alan": "UluslararasÄ± Ä°ÅŸ birliÄŸi ve Diplomasi", "secili": false },
                    { "alan": "Toplum yararÄ±na yapÄ±lacak diÄŸer Ã§alÄ±ÅŸmalar", "secili": true }
                ]
            },
            "dersSekmeler": {
                "dersGenel": true,
                "dersOgrenmeÃ‡iktilari": true,
                "haftalikDersIcerikleri": true,
                "dersIsYuku": true,
                "dersDegerlendirme": true,
                "programVeOgrenmeÃ‡iktilariIliskisi": true,
                "toplumsalKatkiVeSurdurulebilirlik": true
            },
            "etkinlikTurleri": [
                "Alan Ã‡alÄ±ÅŸmasÄ±", "Alan Gezisi", "Ara SÄ±nav", "Ara SÄ±nav Ä°Ã§in Bireysel Ã‡alÄ±ÅŸma",
                "Beyin FÄ±rtÄ±nasÄ±", "Bireysel Ã‡alÄ±ÅŸma", "BÃ¼tÃ¼nleme SÄ±navÄ±", "Deney", "Deney SonrasÄ± Quiz",
                "Derse KatÄ±lÄ±m", "Ev Ã–devi", "Final SÄ±navÄ±", "Final SÄ±navÄ± Ä°Ã§in Bireysel Ã‡alÄ±ÅŸma",
                "GÃ¶sterme", "GÃ¶zlem", "Laboratuvar", "Laboratuvar Ara SÄ±navÄ±", "Laboratuvar SÄ±navÄ±",
                "Makale Kritik Etme", "Makale Yazma", "Multirom CD Ã‡alÄ±ÅŸmasÄ±", "Ã–dev Problemleri Ä°Ã§in Ã‡alÄ±ÅŸma",
                "Okuma", "Ã–rnek Vaka Ä°ncelemesi", "Performans", "Problem Ã‡Ã¶zÃ¼mÃ¼", "Proje HazÄ±rlama",
                "Proje Sunma", "Proje TasarÄ±mÄ±/YÃ¶netimi", "Quiz", "Quiz Ä°Ã§in Bireysel Ã‡alÄ±ÅŸma",
                "Rapor", "Rapor HazÄ±rlama", "Rapor Sunma", "Rehberli Problem Ã‡Ã¶zÃ¼mÃ¼",
                "Rol Oynama / Dramatizasyon", "Seminer", "Soru-YanÄ±t", "SÃ¶zlÃ¼ SÄ±nav",
                "TakÄ±m/Grup Ã‡alÄ±ÅŸmasÄ±", "TartÄ±ÅŸma", "ToplantÄ± BaÅŸkanlÄ±ÄŸÄ± Yapma", "Uygulama/Pratik"
            ],
            "yariyilIciOlasiEtkinlikler": [
                "Ara SÄ±nav", "Laboratuvar SÄ±navÄ±", "Deney", "Deney SonrasÄ± Quiz", "Performans",
                "Quiz", "Rapor", "Rapor Sunma", "Makale Kritik Etme", "Makale Yazma",
                "Proje HazÄ±rlama", "Proje Sunma", "Rehberli Problem Ã‡Ã¶zÃ¼mÃ¼", "Seminer",
                "SÃ¶zlÃ¼ SÄ±nav", "Ã–dev Problemleri Ä°Ã§in Ã‡alÄ±ÅŸma", "Proje TasarÄ±mÄ±/YÃ¶netimi"
            ],
            "yariyilSonuOlasiEtkinlikler": [
                "Final SÄ±navÄ±", "Laboratuvar Ara SÄ±navÄ±", "Makale Yazma", "Proje HazÄ±rlama",
                "Proje Sunma", "Proje TasarÄ±mÄ±/YÃ¶netimi", "Quiz", "Rapor", "Rapor HazÄ±rlama",
                "Rapor Sunma", "Seminer", "SÃ¶zlÃ¼ SÄ±nav", "GÃ¶zlem"
            ],
            "denetimBilgileri": {
                "olusturmaTarihi": new Date().toISOString().split('T')[0] + ' ' + new Date().toTimeString().split(' ')[0],
                "olusturan": "test_data_generator",
                "sonGuncellenmeTarihi": new Date().toISOString().split('T')[0] + ' ' + new Date().toTimeString().split(' ')[0],
                "guncelleyen": "test_data_generator",
                "durum": "Test"
            },
            "numaralandirmaDegerleri": {
                "dersTurleri": ["Zorunlu", "SeÃ§meli"],
                "dersSeviyesi": ["Lisans", "YÃ¼ksek Lisans", "Doktora"],
                "ogretimSistemi": ["Birinci Ã–ÄŸretim", "Ä°kinci Ã–ÄŸretim", "Uzaktan Ã–ÄŸretim"],
                "egitimDili": ["TÃ¼rkÃ§e", "Ä°ngilizce"],
                "stajDurumu": ["Mevcut DeÄŸil", "Mevcut", "Zorunlu", "SeÃ§meli"],
                "dokumanDurumu": ["Taslak", "OnaylandÄ±", "YayÄ±nlandÄ±", "Revize Edildi"]
            }
        };
        
        // Ã–ÄŸrenci notlarÄ± objesi oluÅŸtur
        testStudents.forEach(student => {
            testCourseData.ogrenciNotlari[student.ogrenciNo] = {};
        });
        
        // JSON'u sisteme yÃ¼kle (applyJsonData fonksiyonunu kullan)
        const jsonString = JSON.stringify(testCourseData, null, 2);
        
        // JSON iÃ§eriÄŸini textarea'ya yerleÅŸtir
        const jsonContent = document.getElementById('jsonContent');
        if (jsonContent) {
            jsonContent.value = jsonString;
        }
        
        // JSON'u otomatik olarak uygula
        APP_STATE.courseData = testCourseData;
        APP_STATE.jsonFileName = `test-ce100-algorithms-programming-ii-${Date.now()}.json`;
        
        // Ã–ÄŸrenme Ã§Ä±ktÄ±larÄ± ve program Ã§Ä±ktÄ±larÄ±nÄ± APP_STATE'e ata
        APP_STATE.learningOutcomes = testCourseData.dersOgrenmeÃ‡iktilari || [];
        APP_STATE.programOutcomes = testCourseData.programCiktilari || [];
        APP_STATE.outcomeMatrix = testCourseData.programVeOgrenmeIliskisi || null;
        
        // Verileri iÅŸle
        importStudentData(testCourseData);
        createAssessmentTreeFromCourseData();
        
        // UI'larÄ± gÃ¼ncelle
        renderTree();
        renderOutcomes();
        renderProgramOutcomes();
        renderCourseDetails();
        renderOutcomeMatrix();
        updateCourseInfo();
        updateAssessmentView();
        updateCategoryWeights();
        updateStudentTable();
        // updateStudentSelector fonksiyonu kaldÄ±rÄ±ldÄ± (Ã–ÄŸrenci BazlÄ± Not GiriÅŸi sekmesi ile birlikte)
        updateGroupSelectors();
        updateTreeMappingControls();
        
        showModernToast(`GerÃ§ek MUDEK uyumlu test ders datasÄ± oluÅŸturuldu: CE100 - Algorithms And Programming II (${numStudents} Ã¶ÄŸrenci)`, "success");
        
    } catch (error) {
        console.error("Test ders datasÄ± oluÅŸturulurken hata:", error);
        showModernToast("Test ders datasÄ± oluÅŸturulamadÄ±!", "error");
    }
}

/**
 * BileÅŸen iÃ§in kaÄŸÄ±t sÄ±rasÄ± bazÄ±nda giriÅŸ bÃ¶lÃ¼mÃ¼ oluÅŸturma
 * @param {Object} activity - Ana aktivite
 * @param {HTMLElement} container - Konteyner elementi
 */
function createComponentPaperOrderInputSection(activity, container) {
    try {
        const componentId = activity.id;
        const allQuestions = activity.children || [];
        const maxQuestions = allQuestions.length;
        
        // Grup seÃ§eneklerini gÃ¼venli ÅŸekilde oluÅŸtur
        const groups = (APP_STATE.courseData && APP_STATE.courseData.grupHaritalari && APP_STATE.courseData.grupHaritalari[componentId]) 
            ? APP_STATE.courseData.grupHaritalari[componentId].gruplar || ['A']
            : ['A'];
        
        // Grup sistemi her zaman kullanÄ±lÄ±r (tek grup olsa bile)
        const useGroupSystem = true;
        
        // KaÄŸÄ±t sÄ±rasÄ± bazÄ±nda bÃ¶lÃ¼mler oluÅŸtur
        for (let paperOrder = 1; paperOrder <= maxQuestions; paperOrder++) {
            const paperSection = document.createElement('div');
            paperSection.className = 'paper-order-section';
            
            const paperHeader = document.createElement('h6');
            paperHeader.innerHTML = `KaÄŸÄ±t SÄ±rasÄ± ${paperOrder}`;
            paperHeader.className = 'paper-order-header';
            paperSection.appendChild(paperHeader);
            
            const table = document.createElement('table');
            table.className = 'assessment-table paper-order-table';
            
            const tableHTML = `
                <thead>
                    <tr>
                                            <th>No</th>
                    <th>Ã–ÄŸrenci No</th>
                    <th>AdÄ±</th>
                    <th>SoyadÄ±</th>
                    <th>E-posta</th>
                    ${useGroupSystem ? '<th>Grup</th>' : ''}
                    ${useGroupSystem ? '<th>Cevap AnahtarÄ± SÄ±rasÄ±</th>' : ''}
                    ${useGroupSystem ? '<th>Etkinlik AdÄ±<br/><small>(Soru/Rubrik)</small></th>' : ''}
                    ${useGroupSystem ? '<th>AÃ§Ä±klama</th>' : ''}
                    <th>Etkinlik Max. Puan<br/><small>(Soru/Rubrik)</small></th>
                    <th>Toplam Puan</th>
                    ${useGroupSystem ? '<th>Ã–Ã‡</th>' : ''}
                    <th>AlÄ±nan Puan<br/><small>(Etkinlik PuanÄ±)</small></th>
                    <th>YarÄ±yÄ±l Ä°Ã§i<br/><small>(${getTermWeight()}%)</small></th>
                    <th>YarÄ±yÄ±l Sonu<br/><small>(${getFinalWeight()}%)</small></th>
                    <th>Ortalama</th>
                    <th>Harf Notu</th>
                    </tr>
                </thead>
                <tbody>
                    ${APP_STATE.studentData.map((student, index) => {
                        const studentCurrentGroup = getStudentGroupForComponent(student.studentId, componentId);
                        console.log(`ğŸ” KaÄŸÄ±t sÄ±rasÄ± ${paperOrder} - ${componentId} iÃ§in Ã¶ÄŸrenci ${student.studentId}: gruplar=${groups.join(',')}, mevcut=${studentCurrentGroup}`);
                        const groupOptions = groups.map(groupId => 
                            `<option value="${groupId}" ${studentCurrentGroup === groupId ? 'selected' : ''}>${groupId}</option>`
                        ).join('');
                        
                        // Bu kaÄŸÄ±t sÄ±rasÄ±ndaki sorunun gerÃ§ek ID'sini bul
                        const actualQuestionId = getQuestionIdByPaperOrder(student.studentId, paperOrder, componentId);
                        const actualQuestion = findNodeById(actualQuestionId);
                        
                        // Cevap anahtarÄ±ndaki sÄ±rayÄ± bul
                        const answerKeyOrder = getAnswerKeyOrder(student.studentId, paperOrder, componentId);
                        
                        // Etkinlik bilgilerini al
                        const activityName = actualQuestion?.name || `Etkinlik ${answerKeyOrder || paperOrder}`;
                        const questionDescription = actualQuestion?.description || actualQuestion?.name || '-';
                        // DÃœZELTME: actualQuestionId zaten grup bazlÄ± doÄŸru soru, direkt puanÄ±nÄ± kullan
                        const maxPoints = actualQuestion?.points || 0;
                        const studentOutcomes = getQuestionOutcomesForStudent(student.studentId, actualQuestionId, componentId);
                        
                        // DEBUG: Tablo oluÅŸturma sorunlarÄ± iÃ§in
                        if (paperOrder === 1 && index < 3) {
                            console.log(`ğŸ” DÃœZELTME SONRASI - Ã–ÄŸrenci: ${student.studentId}, Grup: ${studentCurrentGroup}, PaperOrder: ${paperOrder}`);
                            console.log(`  - actualQuestionId: ${actualQuestionId}`);
                            console.log(`  - actualQuestion?.points: ${actualQuestion?.points}`);
                            console.log(`  - maxPoints: ${maxPoints}`);
                        }
                        
                        return `
                            <tr data-student-id="${student.studentId}" data-paper-order="${paperOrder}" data-component-id="${componentId}">
                                <td>${index + 1}</td>
                                <td>${student.studentId}</td>
                                <td>${student.name}</td>
                                <td>${student.surname}</td>
                                <td class="email-cell">
                                    <span class="email-text" title="${student.email || 'E-posta bulunamadÄ±'}">${student.email || '-'}</span>
                                    ${student.email ? `<button class="email-button" title="E-posta gÃ¶nder" onclick="openEmailModal({studentId: '${student.studentId}', name: '${student.name}', surname: '${student.surname}', email: '${student.email}'})">E-posta</button>` : ''}
                                </td>
                                ${useGroupSystem ? `
                                <td>
                                    <select class="group-selector compact" data-student-id="${student.studentId}" data-component-id="${componentId}" onchange="updateStudentGroupForComponent(this)">
                                        ${groupOptions}
                                    </select>
                                </td>` : ''}
                                ${useGroupSystem ? `
                                <td class="answer-key-order-cell">
                                    <span class="answer-key-badge" data-answer-key="${answerKeyOrder}" data-question-id="${actualQuestionId}">
                                        ${answerKeyOrder}
                                    </span>
                                </td>` : ''}
                                ${useGroupSystem ? `
                                <td class="question-name-cell">
                                    <span class="question-name-badge">${activityName}</span>
                                </td>` : ''}
                                ${useGroupSystem ? `
                                <td class="question-description-cell">
                                    <span class="question-desc-badge" title="${questionDescription}">${questionDescription}</span>
                                </td>` : ''}
                                <td class="question-points-cell" data-student-id="${student.studentId}" data-activity-id="${actualQuestionId}">
                                    ${maxPoints}
                                </td>
                                <td class="total-points-cell" data-student-id="${student.studentId}" data-component-id="${componentId}">
                                    ${getStudentTotalEarnedPointsForComponent(student.studentId, componentId)}
                                </td>
                                ${useGroupSystem ? `
                                <td class="outcomes-cell">
                                    <span class="outcomes-badge">${Array.isArray(studentOutcomes) ? studentOutcomes.join(', ') : (studentOutcomes || '-')}</span>
                                </td>` : ''}
                                <td>
                                    <input type="number" min="0" max="${maxPoints}" 
                                        data-student-id="${student.studentId}" 
                                        data-activity-id="${actualQuestionId}"
                                        data-paper-order="${paperOrder}"
                                        value="${getStudentGrade(student.studentId, actualQuestionId) || ''}"
                                        onchange="updateStudentGrade(this)"
                                        placeholder="0-${maxPoints}"
                                        title="${useGroupSystem ? `KaÄŸÄ±t sÄ±rasÄ±: ${paperOrder}, Cevap anahtarÄ±: ${answerKeyOrder}, Maksimum puan: ${maxPoints}` : `Maksimum puan: ${maxPoints}`}"
                                    >
                                </td>
                                <td class="grade-summary-cell term-grade">${calculateStudentGrades(student.studentId).termGrade}</td>
                                <td class="grade-summary-cell final-grade">${calculateStudentGrades(student.studentId).finalGrade}</td>
                                <td class="grade-summary-cell total-grade">${calculateStudentGrades(student.studentId).totalGrade}</td>
                                <td class="grade-summary-cell letter-grade ${getLetterGradeClass(calculateStudentGrades(student.studentId).letterGrade)}">${calculateStudentGrades(student.studentId).letterGrade}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            `;
            
            table.innerHTML = tableHTML;
            paperSection.appendChild(table);
            container.appendChild(paperSection);
        }
        
        // DÃœZELTME: Tablo oluÅŸturulduktan sonra tÃ¼m satÄ±rlarÄ± gÃ¼ncelle
        // Bu, grup bazlÄ± maksimum puan gÃ¶sterimini dÃ¼zeltir
        setTimeout(() => {
            console.log('ğŸ”„ Tablo oluÅŸturma sonrasÄ± grup bazlÄ± gÃ¼ncelleme baÅŸlatÄ±lÄ±yor...');
            APP_STATE.studentData.forEach(student => {
                const studentCurrentGroup = getStudentGroupForComponent(student.studentId, componentId);
                updateQuestionInfoForComponent(student.studentId, studentCurrentGroup, componentId);
            });
            console.log('âœ… Grup bazlÄ± gÃ¼ncelleme tamamlandÄ±');
        }, 100);
        
    } catch (error) {
        console.error("BileÅŸen kaÄŸÄ±t sÄ±rasÄ± giriÅŸ bÃ¶lÃ¼mÃ¼ oluÅŸturulurken hata oluÅŸtu:", error);
    }
}

/**
 * Ã–ÄŸrencinin grubuna gÃ¶re belirli bir sorunun Ã¶ÄŸrenme Ã§Ä±ktÄ±larÄ±nÄ± getir
 * @param {string} studentId - Ã–ÄŸrenci ID'si
 * @param {string} questionId - Soru ID'si
 * @param {string} componentId - BileÅŸen ID'si
 * @returns {Array} - Ã–ÄŸrenme Ã§Ä±ktÄ±larÄ±
 */
function getQuestionOutcomesForStudent(studentId, questionId, componentId) {
    // Debug: getQuestionOutcomesForStudent Ã§aÄŸrÄ±ldÄ±
    
    try {
        if (!questionId) {
            return [];
        }
        
        const question = findNodeById(questionId);
        
        if (!question) {
            return [];
        }
        
        if (!question.outcomes || question.outcomes.length === 0) {
            return [];
        }
        
        return question.outcomes || [];
    } catch (error) {
        console.error("Soru Ã¶ÄŸrenme Ã§Ä±ktÄ±larÄ± alÄ±nÄ±rken hata:", error);
        return [];
    }
}

/**
 * KaÄŸÄ±t sÄ±rasÄ±na gÃ¶re gerÃ§ek soru ID'sini bulma
 * @param {string} studentId - Ã–ÄŸrenci ID'si
 * @param {number} paperOrder - KaÄŸÄ±ttaki sÄ±ra (1, 2, 3...)
 * @param {string} componentId - BileÅŸen ID'si
 * @returns {string} - GerÃ§ek soru ID'si
 */
function getQuestionIdByPaperOrder(studentId, paperOrder, componentId) {
    try {
        const studentGroup = getStudentGroupForComponent(studentId, componentId);
        const parentNode = findNodeById(componentId);
        
        if (!parentNode || !parentNode.children) {
            return null;
        }
        
        // Grup haritasÄ± var mÄ± kontrol et
        const groupMappings = APP_STATE.courseData?.grupHaritalari?.[componentId]?.haritalar?.[studentGroup];
        
        if (groupMappings) {
            // Grup haritasÄ±na gÃ¶re kaÄŸÄ±t sÄ±rasÄ±ndan gerÃ§ek soru ID'sini bul
            // Format 1: {position: questionId} - Yeni format
            if (groupMappings[paperOrder.toString()]) {
                return groupMappings[paperOrder.toString()];
            }
            // Format 2: {questionId: position} - Eski format desteÄŸi
            for (const [questionId, position] of Object.entries(groupMappings)) {
                if (parseInt(position) === paperOrder) {
                    return questionId;
                }
            }
        }
        
        // Grup haritasÄ± yoksa, varsayÄ±lan sÄ±ralama
        if (parentNode.children[paperOrder - 1]) {
            return parentNode.children[paperOrder - 1].id;
        }
        
        return null;
    } catch (error) {
        console.error("KaÄŸÄ±t sÄ±rasÄ±ndan soru ID'si bulunamadÄ±:", error);
        return null;
    }
}

/**
 * KaÄŸÄ±t sÄ±rasÄ±ndan cevap anahtarÄ±ndaki sÄ±rayÄ± bulma
 * @param {string} studentId - Ã–ÄŸrenci ID'si
 * @param {number} paperOrder - KaÄŸÄ±ttaki sÄ±ra (1, 2, 3...)
 * @param {string} componentId - BileÅŸen ID'si
 * @returns {string} - Cevap anahtarÄ±ndaki sÄ±ra
 */
function getAnswerKeyOrder(studentId, paperOrder, componentId) {
    try {
        const actualQuestionId = getQuestionIdByPaperOrder(studentId, paperOrder, componentId);
        
        if (!actualQuestionId) {
            return `A1.${paperOrder}`;
        }
        
        // Soru ID'sini doÄŸrudan cevap anahtarÄ± sÄ±rasÄ± olarak dÃ¶ndÃ¼r
        // Ã–rneÄŸin A1.1 -> "A1.1", A1.2 -> "A1.2"
        return actualQuestionId;
    } catch (error) {
        console.error("Cevap anahtarÄ± sÄ±rasÄ± bulunamadÄ±:", error);
        return `A1.${paperOrder}`;
    }
}

// Test fonksiyonlarÄ±nÄ± global hale getir
window.generateRandomAssessment = generateRandomAssessment;
window.generateRandomGroups = generateRandomGroups;
window.generateRandomScores = generateRandomScores;
window.generateTestStudents = generateTestStudents;
window.generateFullTestData = generateFullTestData;
window.clearAllTestData = clearAllTestData;
window.generateTestCourseData = generateTestCourseData;

// Test butonlarÄ±na event listener ekle
document.addEventListener('DOMContentLoaded', function() {
    // Test iÅŸlemleri butonlarÄ±
    const testButtons = [
        { id: 'btnGenerateRandomTermAssessment', func: generateMultipleRandomTermAssessments },
        { id: 'btnGenerateRandomFinalAssessment', func: generateMultipleRandomFinalAssessments },
        { id: 'btnGenerateRandomGroups', func: generateRandomGroups },
        { id: 'btnGenerateIntelligentScores', func: generateIntelligentScores },
        { id: 'btnGenerateTestStudents', func: generateTestStudents },

        { id: 'btnGenerateTestCourseData', func: generateTestCourseData },
        { id: 'btnClearAllTestData', func: clearAllTestData },
        // Yeni temizleme butonlarÄ±
        { id: 'btnClearAssessments', func: clearAssessments },
        { id: 'btnClearGroups', func: clearGroups },
        { id: 'btnClearScores', func: clearScores },
        { id: 'btnClearStudents', func: clearAllStudents },
        { id: 'btnResetSystem', func: resetCompleteSystem }
    ];
    
    testButtons.forEach(button => {
        const element = document.getElementById(button.id);
        if (element) {
            element.addEventListener('click', function() {
                console.log(`Test iÅŸlemi baÅŸlatÄ±ldÄ±: ${button.id}`);
                
                // Loading durumu ekle
                element.classList.add('loading');
                element.disabled = true;
                
                try {
                    // Fonksiyonu Ã§aÄŸÄ±r
                    const result = button.func();
                    
                    // Promise ise bekle
                    if (result && typeof result.then === 'function') {
                        result.finally(() => {
                            element.classList.remove('loading');
                            element.disabled = false;
                        });
                    } else {
                        // KÄ±sa bir gecikme sonra loading'i kaldÄ±r
                        setTimeout(() => {
                            element.classList.remove('loading');
                            element.disabled = false;
                        }, 500);
                    }
                } catch (error) {
                    console.error(`Test iÅŸlemi hatasÄ± (${button.id}):`, error);
                    element.classList.remove('loading');
                    element.disabled = false;
                    showModernToast(`Test iÅŸlemi baÅŸarÄ±sÄ±z: ${error.message}`, "error");
                }
            });
        } else {
            console.warn(`Test butonu bulunamadÄ±: ${button.id}`);
        }
    });
    
    console.log('Test iÅŸlemleri butonlarÄ± baÅŸarÄ±yla yÃ¼klendi!');
    
    // Rastgele deÄŸerlendirme slider kontrollerini baÅŸlat (akÄ±llÄ± puanlama dahil)
    initializeAssessmentSliders();
    
    // AkÄ±llÄ± puanlama kontrollerini baÅŸlat
    initializeSmartScoringControls();
    
    // Grup istatistiklerini baÅŸlat
    updateGroupStatistics();
    
    // Ã–ÄŸrenci filtresini baÅŸlat
    initializeAssessmentStudentFilter();
    
    // Ã–ÄŸrenci sayÄ±larÄ±nÄ± baÅŸlangÄ±Ã§ta gÃ¼ncelle
    updatePassFailCounts();
});

// =====================================================
// AKILLI PUANLAMA KONTROLLERÄ°
// =====================================================

/**
 * AkÄ±llÄ± puanlama kontrol elemanlarÄ±nÄ± baÅŸlatÄ±r
 */
function initializeSmartScoringControls() {
    console.log('ğŸ” AkÄ±llÄ± puanlama kontrolleri baÅŸlatÄ±lÄ±yor...');
    
    const passRateSlider = document.getElementById('passRateSlider');
    const passRateValue = document.getElementById('passRateValue');
    const failRateDisplay = document.getElementById('failRateDisplay');
    const passRateDisplay = document.getElementById('passRateDisplay');
    
    // Debug loglarÄ±
    console.log('passRateSlider:', passRateSlider ? 'âœ… Bulundu' : 'âŒ BulunamadÄ±');
    console.log('passRateValue:', passRateValue ? 'âœ… Bulundu' : 'âŒ BulunamadÄ±');
    console.log('failRateDisplay:', failRateDisplay ? 'âœ… Bulundu' : 'âŒ BulunamadÄ±');
    console.log('passRateDisplay:', passRateDisplay ? 'âœ… Bulundu' : 'âŒ BulunamadÄ±');
    
    if (passRateSlider && passRateValue && failRateDisplay && passRateDisplay) {
        // Slider deÄŸiÅŸim event'i
        passRateSlider.addEventListener('input', function() {
            const passRate = parseInt(this.value);
            const failRate = 100 - passRate;
            
            // DeÄŸerleri gÃ¼ncelle
            passRateValue.textContent = passRate + '%';
            passRateDisplay.textContent = passRate + '%';
            failRateDisplay.textContent = failRate + '%';
            
            // Ã–ÄŸrenci sayÄ±sÄ±nÄ± gÃ¼ncelle
            updateStudentCounts(passRate);
            
            // Slider renk geÃ§iÅŸini gÃ¼ncelle
            updateSliderGradient(this, passRate);
        });
        
        // BaÅŸlangÄ±Ã§ deÄŸerini ayarla
        const initialValue = parseInt(passRateSlider.value);
        updateSliderGradient(passRateSlider, initialValue);
        updateStudentCounts(initialValue);
        
        console.log('ğŸ¯ AkÄ±llÄ± puanlama kontrolleri baÅŸarÄ±yla baÅŸlatÄ±ldÄ±');
    } else {
        console.warn('âš ï¸ AkÄ±llÄ± puanlama kontrollerinin bazÄ± elemanlarÄ± bulunamadÄ±');
    }
}

/**
 * Ã–ÄŸrenci sayÄ± bilgilerini gÃ¼nceller
 * @param {number} passRate - GeÃ§en Ã¶ÄŸrenci oranÄ±
 */
function updateStudentCounts(passRate) {
    // Genel updatePassFailCounts fonksiyonunu kullan
    updatePassFailCounts();
    
    // Fail rate display'i de gÃ¼ncelle
    const failRateDisplay = document.getElementById('failRateDisplay');
    if (failRateDisplay) {
        failRateDisplay.textContent = (100 - passRate) + '%';
    }
}

/**
 * Slider'Ä±n renk geÃ§iÅŸini gÃ¼nceller
 * @param {HTMLElement} slider - Slider elementi
 * @param {number} passRate - GeÃ§en Ã¶ÄŸrenci oranÄ±
 */
function updateSliderGradient(slider, passRate) {
    // 0-100 aralÄ±ÄŸÄ±nda yÃ¼zde hesaplama
    const percentage = passRate;
    
    // Dinamik renk hesaplama - 0'dan baÅŸlayacak ÅŸekilde gÃ¼ncellendi
    let gradientColor;
    if (passRate <= 10) {
        gradientColor = '#8b0000'; // Koyu kÄ±rmÄ±zÄ± - hepsi kalÄ±yor
    } else if (passRate < 30) {
        gradientColor = '#e74c3c'; // KÄ±rmÄ±zÄ± - Ã§ok dÃ¼ÅŸÃ¼k
    } else if (passRate < 50) {
        gradientColor = '#f39c12'; // Turuncu - dÃ¼ÅŸÃ¼k
    } else if (passRate < 70) {
        gradientColor = '#f1c40f'; // SarÄ± - orta
    } else if (passRate < 85) {
        gradientColor = '#27ae60'; // YeÅŸil - iyi
    } else {
        gradientColor = '#2980b9'; // Mavi - mÃ¼kemmel
    }
    
    // CSS Ã¶zelliÄŸini gÃ¼ncelle - 0'dan baÅŸlayan gradient
    slider.style.background = `linear-gradient(90deg, #8b0000 0%, #e74c3c 15%, #f39c12 35%, #f1c40f 55%, #27ae60 75%, #2980b9 100%)`;
}

// =====================================================
// Ã–Ã‡ TOOLTIP SÄ°STEMÄ°
// =====================================================

/**
 * Ã–Ã‡ Badge'lerine tooltip sistemi ekler ve tÄ±klama fonksiyonunu ayarlar
 */
function initializeOutcomeTooltips() {
    // Mevcut tooltip'leri temizle
    document.querySelectorAll('.outcome-tooltip').forEach(tooltip => tooltip.remove());
    
    // TÃ¼m outcomes badge'lerini bul
    document.querySelectorAll('.outcomes-badge').forEach(badge => {
        const outcomeCodes = badge.textContent.trim().split(',').map(code => code.trim()).filter(code => code && code !== '-');
        
        // Ã‡ok fazla Ã–Ã‡ varsa (3'ten fazla) tÄ±klanabilir yap
        if (outcomeCodes.length > 3) {
            badge.classList.add('clickable', 'many-outcomes');
            badge.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                showOutcomeDetailModal(outcomeCodes);
            });
            // Ã‡ok Ã–Ã‡ olan badge'lerde tooltip yerine sadece basit bilgi
            badge.title = `${outcomeCodes.length} Ã¶ÄŸrenme Ã§Ä±ktÄ±sÄ± - Detaylar iÃ§in tÄ±klayÄ±n`;
        } else {
            // Az Ã–Ã‡ olan badge'lerde normal tooltip
        badge.addEventListener('mouseenter', showOutcomeTooltip);
        badge.addEventListener('mouseleave', hideOutcomeTooltip);
        }
    });
}

/**
 * Ã–Ã‡ tooltip'ini gÃ¶sterir
 * @param {Event} event - Mouse event
 */
function showOutcomeTooltip(event) {
    const badge = event.target;
    const outcomeCodes = badge.textContent.trim().split(',').map(code => code.trim()).filter(code => code && code !== '-');
    
    if (outcomeCodes.length === 0) return;
    
    // Tooltip oluÅŸtur
    const tooltip = document.createElement('div');
    tooltip.className = 'outcome-tooltip';
    
    let tooltipContent = '';
    
    outcomeCodes.forEach((code, index) => {
        const outcome = getOutcomeInfo(code);
        const relations = getProgramOutcomeRelations(code);
        
        if (index > 0) tooltipContent += '<hr style="margin: 8px 0; border: none; border-top: 1px solid #455a64;">';
        
        tooltipContent += `
            <div class="outcome-tooltip-content">
                <div class="outcome-tooltip-title">${code}</div>
                <div class="outcome-tooltip-description">${outcome.description || 'AÃ§Ä±klama bulunamadÄ±'}</div>
                ${relations.length > 0 ? `
                    <div class="outcome-tooltip-relations">
                        <strong style="color: #81c784;">Program Ã‡Ä±ktÄ±sÄ± Ä°liÅŸkileri:</strong><br>
                        ${relations.map(rel => `
                            <div class="outcome-relation">
                                <div style="display: flex; align-items: center; margin-bottom: 4px;">
                                    <span style="color: #4fc3f7; font-weight: bold;">${code}</span>
                                    <span class="outcome-relation-arrow">â†’</span>
                                    <span class="relation-level-${rel.level}">${rel.level}</span>
                                    <span class="outcome-relation-arrow">â†’</span>
                                    <span class="program-outcome-badge">${rel.programOutcome}</span>
                                    <span class="outcome-relation-level">${getRelationLevelText(rel.level)}</span>
                                </div>
                                ${rel.description ? `
                                    <div style="color: #b0bec5; font-size: 11px; margin-left: 8px; line-height: 1.3; padding: 2px 0;">
                                        <strong>${rel.programOutcome}:</strong> ${rel.description}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            </div>
        `;
    });
    
    tooltip.innerHTML = tooltipContent;
    document.body.appendChild(tooltip);
    
    // Tooltip pozisyonunu ayarla
    positionTooltip(tooltip, badge);
    
    // Tooltip'i gÃ¶ster
    setTimeout(() => {
        tooltip.classList.add('show');
    }, 10);
}

/**
 * Ã–Ã‡ tooltip'ini gizler
 */
function hideOutcomeTooltip() {
    document.querySelectorAll('.outcome-tooltip').forEach(tooltip => {
        tooltip.classList.remove('show');
        setTimeout(() => {
            tooltip.remove();
        }, 200);
    });
}

/**
 * Tooltip pozisyonunu ayarlar (fixed positioning ile)
 * @param {HTMLElement} tooltip - Tooltip elementi
 * @param {HTMLElement} badge - Badge elementi
 */
function positionTooltip(tooltip, badge) {
    const badgeRect = badge.getBoundingClientRect();
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;
    const scrollTop = window.scrollY || document.documentElement.scrollTop;
    
    // Ä°lk olarak tooltip'i gÃ¶sterip boyutunu Ã¶lÃ§elim
    tooltip.style.visibility = 'hidden';
    tooltip.style.display = 'block';
    const tooltipRect = tooltip.getBoundingClientRect();
    tooltip.style.visibility = 'visible';
    
    // Tooltip pozisyonunu hesapla (badge'in ortasÄ±ndan)
    let left = badgeRect.left + (badgeRect.width / 2) - (tooltipRect.width / 2);
    let top = badgeRect.bottom + 8;
    
    // SaÄŸ taraftan taÅŸma kontrolÃ¼
    if (left + tooltipRect.width > viewportWidth - 15) {
        left = viewportWidth - tooltipRect.width - 15;
    }
    
    // Sol taraftan taÅŸma kontrolÃ¼
    if (left < 15) {
        left = 15;
    }
    
    // Alt taraftan taÅŸma kontrolÃ¼ - tooltip'i yukarÄ± taÅŸÄ±
    if (top + tooltipRect.height > viewportHeight - 15) {
        top = badgeRect.top - tooltipRect.height - 8;
    }
    
    // Ãœst taraftan taÅŸma kontrolÃ¼
    if (top < 15) {
        top = badgeRect.bottom + 8;
    }
    
    tooltip.style.left = left + 'px';
    tooltip.style.top = top + 'px';
}

/**
 * Ã–Ã‡ bilgilerini getirir
 * @param {string} outcomeCode - Ã–Ã‡ kodu
 * @returns {Object} - Ã–Ã‡ bilgileri
 */
function getOutcomeInfo(outcomeCode) {
    if (APP_STATE.learningOutcomes) {
        const outcome = APP_STATE.learningOutcomes.find(o => o.id === outcomeCode || o.kod === outcomeCode);
        if (outcome) {
            return {
                code: outcome.id || outcome.kod,
                description: outcome.aciklama || outcome.aÃ§Ä±klama || outcome.description
            };
        }
    }
    
    return {
        code: outcomeCode,
        description: 'AÃ§Ä±klama bulunamadÄ±'
    };
}

/**
 * Program Ã§Ä±ktÄ±sÄ± iliÅŸkilerini getirir
 * @param {string} outcomeCode - Ã–Ã‡ kodu
 * @returns {Array} - Program Ã§Ä±ktÄ±sÄ± iliÅŸkileri
 */
function getProgramOutcomeRelations(outcomeCode) {
    const relations = [];
    
    if (APP_STATE.outcomeMatrix && APP_STATE.outcomeMatrix.iliskiTablosu && APP_STATE.programOutcomes) {
        const relation = APP_STATE.outcomeMatrix.iliskiTablosu.find(r => r.ogrenmeÃ‡iktisiID === outcomeCode);
        
        if (relation && relation.programÃ‡iktilariIliskileri) {
            APP_STATE.programOutcomes.forEach(po => {
                const level = relation.programÃ‡iktilariIliskileri[po.id];
                if (level && level > 0) {
                    relations.push({
                        programOutcome: po.id,
                        level: level,
                        description: po.aciklama || po.aÃ§Ä±klama || po.description
                    });
                }
            });
        }
    }
    
    return relations.sort((a, b) => b.level - a.level); // Seviyeye gÃ¶re azalan sÄ±ralama
}

/**
 * Ã–Ã‡ detay modalÄ±nÄ± gÃ¶sterir
 * @param {Array} outcomeCodes - Ã–Ã‡ kodlarÄ±
 */
function showOutcomeDetailModal(outcomeCodes) {
    const modal = document.getElementById('outcomeDetailModal');
    const container = document.getElementById('outcomeDetailContainer');
    
    if (!modal || !container) return;
    
    // Modal iÃ§eriÄŸini oluÅŸtur
    let modalContent = '';
    
    outcomeCodes.forEach((code, index) => {
        const outcome = getOutcomeInfo(code);
        const relations = getProgramOutcomeRelations(code);
        
        modalContent += `
            <div class="outcome-detail-item">
                <div class="outcome-detail-header">
                    <span class="outcome-detail-code">${code}</span>
                    <h4 class="outcome-detail-title">Ã–ÄŸrenme Ã‡Ä±ktÄ±sÄ± ${index + 1}</h4>
                </div>
                <div class="outcome-detail-description">
                    ${outcome.description || 'AÃ§Ä±klama bulunamadÄ±'}
                </div>
                ${relations.length > 0 ? `
                    <div class="outcome-detail-relations">
                        <h5>ğŸ¯ Program Ã‡Ä±ktÄ±sÄ± Ä°liÅŸkileri</h5>
                        <div class="outcome-relation-list">
                            ${relations.map(rel => `
                                <div class="outcome-relation-item">
                                    <span class="program-outcome-code">${rel.programOutcome}</span>
                                    <span class="relation-arrow">â†’</span>
                                    <span class="relation-level-badge level-${rel.level}">${rel.level}</span>
                                    <span>${getRelationLevelText(rel.level)}</span>
                                </div>
                                ${rel.description ? `
                                    <div class="relation-description">
                                        <strong>${rel.programOutcome}:</strong> ${rel.description}
                                    </div>
                                ` : ''}
                            `).join('')}
                        </div>
                    </div>
                ` : '<div class="outcome-detail-relations"><p style="color: #666; font-style: italic;">Program Ã§Ä±ktÄ±sÄ± iliÅŸkisi bulunamadÄ±</p></div>'}
            </div>
        `;
    });
    
    container.innerHTML = modalContent;
    
    // Modal'Ä± aÃ§
    openModernModal('outcomeDetailModal');
}

/**
 * Ä°liÅŸki seviyesi metnini dÃ¶ndÃ¼rÃ¼r
 * @param {number} level - Ä°liÅŸki seviyesi
 * @returns {string} - Ä°liÅŸki seviyesi metni
 */
function getRelationLevelText(level) {
    const levelTexts = {
        0: 'Ä°liÅŸki Yok',
        1: 'Ã‡ok ZayÄ±f',
        2: 'ZayÄ±f', 
        3: 'Orta',
        4: 'GÃ¼Ã§lÃ¼',
        5: 'Ã‡ok GÃ¼Ã§lÃ¼'
    };
    return levelTexts[level] || 'Bilinmiyor';
}

/**
 * Ã–ÄŸrenci iÃ§in detaylÄ± e-posta iÃ§eriÄŸi oluÅŸturur
 * @param {string} studentId - Ã–ÄŸrenci ID'si
 * @returns {Object} - E-posta konusu ve iÃ§eriÄŸi
 */
function generateDetailedEmailContent(studentId) {
    try {
        // Ã–ÄŸrenci bilgilerini bul - id ve studentId her ikisini de kontrol et
        const student = APP_STATE.studentData.find(s => s.id === studentId || s.studentId === studentId);
        if (!student) {
            console.warn('Ã–ÄŸrenci bulunamadÄ±:', studentId);
            return { 
                subject: 'Ders Not Durumu', 
                body: 'Ã–ÄŸrenci bilgileri yÃ¼klenirken bir hata oluÅŸtu. LÃ¼tfen tekrar deneyiniz.' 
            };
        }

        // Not hesaplama
        const grades = calculateStudentGrades(studentId);
        
        // Kurs bilgileri
        const courseInfo = APP_STATE.courseData || {};
        const courseName = courseInfo.dersBilgisi?.dersAdi || courseInfo.dersGenel?.dersAdi || 'Ders AdÄ± BulunamadÄ±';
        const courseTerm = courseInfo.dersBilgisi?.donem || courseInfo.dersGenel?.akademikYil || 'DÃ¶nem Bilgisi Yok';
        const instructor = courseInfo.dersBilgisi?.ogretimUyesi || courseInfo.dersIcerik?.dersiVerenOgretimUyesiOgretimGorevlisi || 'Ã–ÄŸretim Ãœyesi';
        
        // E-posta konusu
        const subject = `${courseName} - Ders Not Durumu - ${student.name} ${student.surname}`;
        
        // GeÃ§me notu (genellikle 60 veya DD)
        const passingGrade = 60;
        const isPassing = grades.totalGrade >= passingGrade;
        
        // DetaylÄ± notlar listesi
        let detailedScores = '';
        
        // Assessment tree'den etkinlik detaylarÄ±nÄ± al
        if (APP_STATE.assessmentTree && APP_STATE.assessmentTree.length > 0) {
            const termActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('A'));
            const finalActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('F'));
            
            // YarÄ±yÄ±l iÃ§i etkinlikler
            if (termActivities.length > 0) {
                detailedScores += `
                <div class="activity-category">
                    <h4>ğŸ“‹ YarÄ±yÄ±l Ä°Ã§i Etkinlikler</h4>`;
                
                termActivities.forEach(activity => {
                    const activityScore = getStudentActivityScore(studentId, activity.id);
                    const maxScore = getActivityMaxScore(activity.id);
                    const displayName = getComponentDisplayName(activity.id);
                    const percentage = maxScore > 0 ? ((activityScore / maxScore) * 100).toFixed(2) : '0.0';
                    
                    detailedScores += `
                    <div class="activity-item">
                        <div class="activity-name">${displayName}</div>
                        <div class="activity-score">
                            <span class="score-value">${activityScore.toFixed(2)}/${maxScore}</span>
                            <span class="score-percentage">%${percentage}</span>
                        </div>
                    </div>`;
                });
                
                detailedScores += `</div>`;
            }
            
            // YarÄ±yÄ±l sonu etkinlikler
            if (finalActivities.length > 0) {
                detailedScores += `
                <div class="activity-category">
                    <h4>ğŸ“ YarÄ±yÄ±l Sonu Etkinlikler</h4>`;
                
                finalActivities.forEach(activity => {
                    const activityScore = getStudentActivityScore(studentId, activity.id);
                    const maxScore = getActivityMaxScore(activity.id);
                    const displayName = getComponentDisplayName(activity.id);
                    const percentage = maxScore > 0 ? ((activityScore / maxScore) * 100).toFixed(2) : '0.0';
                    
                    detailedScores += `
                    <div class="activity-item">
                        <div class="activity-name">${displayName}</div>
                        <div class="activity-score">
                            <span class="score-value">${activityScore.toFixed(2)}/${maxScore}</span>
                            <span class="score-percentage">%${percentage}</span>
                        </div>
                    </div>`;
                });
                
                detailedScores += `</div>`;
            }
        }
        
        // Text tabanlÄ± e-posta iÃ§eriÄŸi - sembollerle gÃ¶rselleÅŸtirilmiÅŸ
        let termActivitiesText = '';
        let finalActivitiesText = '';
        
        // Assessment tree'den etkinlik detaylarÄ±nÄ± al
        if (APP_STATE.assessmentTree && APP_STATE.assessmentTree.length > 0) {
            const termActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('A'));
            const finalActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('F'));
            
            // YarÄ±yÄ±l iÃ§i etkinlikler
            if (termActivities.length > 0) {
                termActivitiesText = termActivities.map(activity => {
                    const activityScore = getStudentActivityScore(studentId, activity.id);
                    const maxScore = getActivityMaxScore(activity.id);
                    const displayName = getComponentDisplayName(activity.id);
                    const percentage = maxScore > 0 ? ((activityScore / maxScore) * 100).toFixed(2) : '0.0';
                    
                    return `- ${displayName}: ${activityScore.toFixed(2)}/${maxScore} (%${percentage})`;
                }).join('\n');
            }
            
            // YarÄ±yÄ±l sonu etkinlikler
            if (finalActivities.length > 0) {
                finalActivitiesText = finalActivities.map(activity => {
                    const activityScore = getStudentActivityScore(studentId, activity.id);
                    const maxScore = getActivityMaxScore(activity.id);
                    const displayName = getComponentDisplayName(activity.id);
                    const percentage = maxScore > 0 ? ((activityScore / maxScore) * 100).toFixed(2) : '0.0';
                    
                    return `- ${displayName}: ${activityScore.toFixed(2)}/${maxScore} (%${percentage})`;
                }).join('\n');
            }
        }
        
        const body = `==================================================
              DERS NOT DURUMU
              ${courseName}
                ${courseTerm}
==================================================

Sayin ${student.name} ${student.surname} (${student.studentId}),

${courseName} dersi kapsaminda aldiginiz notlar ve basari durumunuz 
asagida detayli olarak belirtilmistir.

GENEL NOT OZETI:
- Yariyil Ici Notu    : ${grades.termGrade.toFixed(2)}/100
- Yariyil Sonu Notu   : ${grades.finalGrade.toFixed(2)}/100
- Toplam Basari Notu  : ${grades.totalGrade.toFixed(2)}/100
- Harf Notu          : ${grades.letterGrade}
${isPassing ? '* BASARILI - Dersi gectiniz!' : '* BASARISIZ - Ders tekrari gerekiyor'}

${termActivitiesText ? `YARIYIL ICI ETKINLIKLER:
${termActivitiesText}

` : ''}${finalActivitiesText ? `YARIYIL SONU ETKINLIKLER:
${finalActivitiesText}

` : ''}DEGERLENDIRME KRITERLERI:
- Yariyil Ici Agirligi: %${APP_STATE.courseData?.dersGenel?.yariYiliciAgirligi || 40}
- Yariyil Sonu Agirligi: %${APP_STATE.courseData?.dersGenel?.yariYilSonuAgirligi || 60}
- Basari Siniri: 60/100 (DD)

==================================================
Bu e-posta otomatik olarak ${new Date().toLocaleDateString('tr-TR')} tarihinde olusturulmustur.

Iyi calismalar,
${instructor}
==================================================`;


        return { subject, body };
        
    } catch (error) {
        console.error('E-posta iÃ§eriÄŸi oluÅŸturulurken hata:', error);
        return { 
            subject: 'Not Bilgisi - Hata', 
            body: 'Not bilgileri oluÅŸturulurken bir hata meydana geldi. LÃ¼tfen Ã¶ÄŸretim Ã¼yenizle iletiÅŸime geÃ§iniz.' 
        };
    }
}

/**
 * Ã–ÄŸrencinin bir etkinlikteki puanÄ±nÄ± getirir
 * @param {string} studentId - Ã–ÄŸrenci ID'si  
 * @param {string} activityId - Etkinlik ID'si
 * @returns {number} - Ã–ÄŸrencinin puanÄ±
 */
function getStudentActivityScore(studentId, activityId) {
    let totalScore = 0;
    
    function searchNode(node) {
        if (node.id === activityId && node.students && node.students[studentId]) {
            totalScore += parseFloat(node.students[studentId].grade || 0);
        }
        
        if (node.children) {
            node.children.forEach(child => searchNode(child));
        }
    }
    
    // TÃ¼m assessment tree'de ara
    if (APP_STATE.assessmentTree) {
        APP_STATE.assessmentTree.forEach(activity => {
            searchNode(activity);
        });
    }
    
    return totalScore;
}

/**
 * EtkinliÄŸin maksimum puanÄ±nÄ± getirir
 * @param {string} activityId - Etkinlik ID'si
 * @returns {number} - Maksimum puan
 */
function getActivityMaxScore(activityId) {
    let maxScore = 0;
    
    function searchNode(node) {
        if (node.id === activityId) {
            maxScore += parseFloat(node.points || 0);
        }
        
        if (node.children) {
            node.children.forEach(child => searchNode(child));
        }
    }
    
    // TÃ¼m assessment tree'de ara
    if (APP_STATE.assessmentTree) {
        APP_STATE.assessmentTree.forEach(activity => {
            searchNode(activity);
        });
    }
    
    return maxScore;
}

/* =====================================================
   E-POSTA MODAL SÄ°STEMÄ°
   ===================================================== */

// Global deÄŸiÅŸkenler
let selectedEmailType = null;
let currentStudentForEmail = null;

/**
 * E-posta modalÄ±nÄ± aÃ§ar
 * @param {Object} student - Ã–ÄŸrenci objesi
 */
function openEmailModal(student) {
    currentStudentForEmail = student;
    
    // Yeni modal oluÅŸtur
    createNewEmailModal();
    
    const modal = document.getElementById('newEmailModal');
    modal.style.display = 'flex';
    setTimeout(() => {
        modal.classList.add('active');
    }, 10);
}

/**
 * Yeni e-posta modalÄ±nÄ± oluÅŸturur
 */
function createNewEmailModal() {
    // Eski modal varsa kaldÄ±r
    const existingModal = document.getElementById('newEmailModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    const modal = document.createElement('div');
    modal.id = 'newEmailModal';
    modal.className = 'modal-overlay';
    
    modal.innerHTML = `
        <div class="new-modal-content">
            <div class="modal-header">
                <h2>ğŸ“§ E-posta GÃ¶nder</h2>
                <span class="modal-close" onclick="closeNewEmailModal()">&times;</span>
            </div>
            
            <div class="modal-body">
                <!-- Ã–ÄŸrenci Bilgileri -->
                <div class="student-info-section">
                    <div class="student-info-card">
                        <div class="student-avatar">
                            ${currentStudentForEmail.name.charAt(0)}${currentStudentForEmail.surname.charAt(0)}
                        </div>
                        <div class="student-details">
                            <div class="student-name">${currentStudentForEmail.name} ${currentStudentForEmail.surname}</div>
                            <div class="student-meta">${currentStudentForEmail.studentId} â€¢ ${currentStudentForEmail.email}</div>
                        </div>
                    </div>
                </div>
                
                <!-- E-posta TÃ¼rÃ¼ SeÃ§imi -->
                <div class="email-type-selection">
                    <h3>E-posta tÃ¼rÃ¼nÃ¼ seÃ§in:</h3>
                    
                    <div class="email-type-grid">
                        <div class="email-type-card" data-type="survey">
                            <div class="card-icon">ğŸ“‹</div>
                            <h4>Anket E-postasÄ±</h4>
                            <p>Ders bazÄ±nda Ã¶ÄŸrenme Ã§Ä±ktÄ±larÄ± anketi</p>
                        </div>
                        
                        <div class="email-type-card" data-type="detailed">
                            <div class="card-icon">ğŸ“Š</div>
                            <h4>DetaylÄ± Puan Raporu</h4>
                            <p>TÃ¼m sÄ±nav ve Ã¶dev sonuÃ§larÄ±</p>
                        </div>
                        
                        <div class="email-type-card" data-type="analysis">
                            <div class="card-icon">ğŸ“ˆ</div>
                            <h4>Ã–Ã‡-PÃ‡ Analiz Raporu</h4>
                            <p>Ã–ÄŸrenme Ã§Ä±ktÄ±larÄ± ve program Ã§Ä±ktÄ±larÄ± analizi</p>
                        </div>
                        
                        <div class="email-type-card" data-type="info">
                            <div class="card-icon">ğŸ’¬</div>
                            <h4>Bilgi Talebi</h4>
                            <p>GÃ¶rÃ¼ÅŸme daveti ve bilgi toplama</p>
                        </div>
                    </div>
                </div>
                
                <!-- Format SeÃ§imi -->
                <div class="format-selection" id="formatSelection" style="display: none;">
                    <h3>GÃ¶nderim formatÄ±nÄ± seÃ§in:</h3>
                    
                    <div class="format-options">
                        <div class="format-option text-option">
                            <div class="format-header">
                                <div class="format-icon">ğŸ“</div>
                                <div class="format-title">
                                    <h4>Sade Text Format</h4>
                                    <p>DÃ¼z metin formatÄ±nda, Gmail'de direkt aÃ§Ä±lÄ±r</p>
                                </div>
                            </div>
                            <div class="format-features">
                                <span class="feature">âœ… HÄ±zlÄ± ve basit</span>
                                <span class="feature">âœ… TÃ¼m e-posta istemcilerinde Ã§alÄ±ÅŸÄ±r</span>
                                <span class="feature">âœ… Direkt Gmail'de aÃ§Ä±lÄ±r</span>
                            </div>
                            <button class="format-btn text-btn" onclick="sendTextEmail()">ğŸ“§ Direkt GÃ¶nder</button>
                        </div>
                        
                        <div class="format-option html-option recommended">
                            <div class="recommended-badge">Ã–nerilen</div>
                            <div class="format-header">
                                <div class="format-icon">ğŸ¨</div>
                                <div class="format-title">
                                    <h4>HTML Format</h4>
                                    <p>Renkli, tablolu, profesyÃ¶nel gÃ¶rÃ¼nÃ¼m</p>
                                </div>
                            </div>
                            <div class="format-features">
                                <span class="feature">âœ… ProfesyÃ¶nel tasarÄ±m</span>
                                <span class="feature">âœ… Renkli tablolar ve checkbox'lar</span>
                                <span class="feature">âœ… Gmail'de mÃ¼kemmel gÃ¶rÃ¼nÃ¼m</span>
                            </div>
                            <button class="format-btn html-btn" onclick="sendHtmlEmail()">ğŸ¨ HTML GÃ¶nder</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // CSS stilleri ekle
    if (!document.querySelector('#newEmailModalStyles')) {
        const styles = document.createElement('style');
        styles.id = 'newEmailModalStyles';
        styles.textContent = `
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                opacity: 0;
                transition: opacity 0.3s ease;
            }
            
            .modal-overlay.active {
                opacity: 1;
            }
            
            .new-modal-content {
                background: white;
                border-radius: 15px;
                max-width: 700px;
                width: 90%;
                max-height: 90vh;
                overflow-y: auto;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                transform: scale(0.9);
                transition: transform 0.3s ease;
            }
            
            .modal-overlay.active .new-modal-content {
                transform: scale(1);
            }
            
            .modal-header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-radius: 15px 15px 0 0;
            }
            
            .modal-header h2 {
                margin: 0;
                font-size: 24px;
            }
            
            .modal-close {
                background: none;
                border: none;
                color: white;
                font-size: 28px;
                cursor: pointer;
                line-height: 1;
                padding: 0;
                width: 30px;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                transition: background 0.3s;
            }
            
            .modal-close:hover {
                background: rgba(255, 255, 255, 0.2);
            }
            
            .modal-body {
                padding: 30px;
            }
            
            .student-info-card {
                display: flex;
                align-items: center;
                gap: 15px;
                padding: 20px;
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                border-radius: 12px;
                margin-bottom: 30px;
                border: 1px solid #dee2e6;
            }
            
            .student-avatar {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                width: 60px;
                height: 60px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                font-size: 24px;
                text-transform: uppercase;
            }
            
            .student-name {
                font-weight: bold;
                font-size: 20px;
                margin-bottom: 5px;
                color: #333;
            }
            
            .student-meta {
                color: #666;
                font-size: 14px;
            }
            
            .email-type-selection h3 {
                margin-bottom: 20px;
                color: #333;
                font-size: 18px;
            }
            
            .email-type-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 15px;
                margin-bottom: 30px;
            }
            
            .email-type-card {
                padding: 20px;
                border: 2px solid #e9ecef;
                border-radius: 12px;
                cursor: pointer;
                transition: all 0.3s ease;
                background: #fff;
            }
            
            .email-type-card:hover {
                border-color: #667eea;
                transform: translateY(-2px);
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.15);
            }
            
            .email-type-card.selected {
                border-color: #667eea;
                background: linear-gradient(135deg, #f8f9ff 0%, #e8f1ff 100%);
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
            }
            
            .email-type-card .card-icon {
                font-size: 32px;
                margin-bottom: 10px;
            }
            
            .email-type-card h4 {
                margin: 0 0 8px 0;
                color: #333;
                font-size: 16px;
            }
            
            .email-type-card p {
                margin: 0;
                color: #666;
                font-size: 14px;
            }
            
            .format-selection {
                margin-top: 30px;
                padding-top: 30px;
                border-top: 2px solid #e9ecef;
            }
            
            .format-selection h3 {
                margin-bottom: 20px;
                color: #333;
                font-size: 18px;
            }
            
            .format-options {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
            }
            
            .format-option {
                border: 2px solid #e9ecef;
                border-radius: 12px;
                padding: 25px;
                background: #fff;
                transition: all 0.3s ease;
                position: relative;
            }
            
            .format-option.recommended {
                border-color: #28a745;
                background: linear-gradient(135deg, #f8fff9 0%, #e8f8e9 100%);
            }
            
            .recommended-badge {
                position: absolute;
                top: -10px;
                right: 15px;
                background: #28a745;
                color: white;
                padding: 5px 15px;
                border-radius: 15px;
                font-size: 12px;
                font-weight: bold;
            }
            
            .format-header {
                display: flex;
                align-items: flex-start;
                gap: 15px;
                margin-bottom: 15px;
            }
            
            .format-icon {
                font-size: 32px;
                flex-shrink: 0;
            }
            
            .format-title h4 {
                margin: 0 0 5px 0;
                font-size: 18px;
                color: #333;
            }
            
            .format-title p {
                margin: 0;
                color: #666;
                font-size: 14px;
            }
            
            .format-features {
                margin: 15px 0 20px 0;
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            
            .feature {
                font-size: 14px;
                color: #555;
            }
            
            .format-btn {
                width: 100%;
                padding: 12px 20px;
                border: none;
                border-radius: 8px;
                font-size: 16px;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.3s ease;
            }
            
            .text-btn {
                background: #007bff;
                color: white;
            }
            
            .text-btn:hover {
                background: #0056b3;
                transform: translateY(-1px);
            }
            
            .html-btn {
                background: #28a745;
                color: white;
            }
            
            .html-btn:hover {
                background: #1e7e34;
                transform: translateY(-1px);
            }
            
            @media (max-width: 768px) {
                .format-options {
                    grid-template-columns: 1fr;
                }
                
                .email-type-grid {
                    grid-template-columns: 1fr;
                }
                
                .new-modal-content {
                    width: 95%;
                    margin: 20px;
                }
                
                .modal-body {
                    padding: 20px;
                }
            }
        `;
        document.head.appendChild(styles);
    }
    
    document.body.appendChild(modal);
    
    // Email type cards iÃ§in event listener
    modal.querySelectorAll('.email-type-card').forEach(card => {
        card.addEventListener('click', function() {
            // Ã–nceki seÃ§imi temizle
            modal.querySelectorAll('.email-type-card').forEach(c => c.classList.remove('selected'));
            
            // Yeni seÃ§imi iÅŸaretle
            this.classList.add('selected');
            selectedEmailType = this.dataset.type;
            
            // Format seÃ§imi bÃ¶lÃ¼mÃ¼nÃ¼ gÃ¶ster
            document.getElementById('formatSelection').style.display = 'block';
            
            // Smooth scroll
            document.getElementById('formatSelection').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
        });
    });
}

/**
 * E-posta tÃ¼rÃ¼ seÃ§imi
 * @param {string} type - E-posta tÃ¼rÃ¼
 */
function selectEmailType(type) {
    selectedEmailType = type;
    
    // Ã–nceki seÃ§imi temizle
    document.querySelectorAll('.email-type-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Yeni seÃ§imi iÅŸaretle
    document.querySelector(`[data-type="${type}"]`).classList.add('selected');
    
    // ButonlarÄ± aktif et
    document.getElementById('generateEmailBtn').disabled = false;
    document.getElementById('previewEmailBtn').disabled = false;
}

/**
 * E-posta Ã¶nizlemesini gÃ¶sterir
 */
function previewEmail() {
    if (!selectedEmailType || !currentStudentForEmail) return;
    
    const emailContent = generateEmailByType(selectedEmailType, currentStudentForEmail);
    const previewSection = document.getElementById('emailPreviewSection');
    const previewContent = document.getElementById('emailPreviewContent');
    
    previewContent.innerHTML = emailContent.body;
    previewSection.style.display = 'block';
    
    // Ã–nizleme bÃ¶lÃ¼mÃ¼ne scroll
    previewSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

/**
 * E-postayÄ± oluÅŸturur ve Gmail'de aÃ§ar
 */
function generateEmail() {
    if (!selectedEmailType || !currentStudentForEmail) return;
    
    const emailContent = generateEmailByType(selectedEmailType, currentStudentForEmail);
    
    // URL uzunluk kontrolÃ¼
    const testUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(currentStudentForEmail.email)}&su=${encodeURIComponent(emailContent.subject)}&body=${encodeURIComponent(emailContent.body)}`;
    
    // URL Ã§ok uzunsa yeni pencerede aÃ§Ä±p kullanÄ±cÄ±nÄ±n kopyalamasÄ±nÄ± saÄŸla
    if (testUrl.length > 8000) {
        openEmailInNewWindow(emailContent, currentStudentForEmail.email);
    } else {
        // Normal Gmail URL ile aÃ§
        window.open(testUrl, '_blank', 'noopener');
    }
    
    // ModalÄ± kapat
    closeEmailModal();
    
    // BaÅŸarÄ± mesajÄ± gÃ¶ster
    showModernToast('E-posta hazÄ±rlandÄ±!', 'success');
}

/**
 * E-posta iÃ§eriÄŸini yeni pencerede aÃ§ar
 */
function openEmailInNewWindow(emailContent, recipientEmail) {
    const newWindow = window.open('', '_blank', 'width=900,height=700,scrollbars=yes,resizable=yes');
    
    const htmlContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-posta Ä°Ã§eriÄŸi - Gmail'de KullanÄ±m Ä°Ã§in</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .instructions {
            background: #e3f2fd;
            padding: 20px;
            border-left: 4px solid #2196f3;
            margin: 0;
        }
        .email-info {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
        }
        .email-content {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            margin: 10px 0;
        }
        .buttons {
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 10px;
            transition: background 0.3s;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn-secondary {
            background: #28a745;
        }
        .btn-secondary:hover {
            background: #1e7e34;
        }
        .copy-success {
            color: #28a745;
            font-weight: bold;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“§ E-posta Ä°Ã§eriÄŸi HazÄ±r</h1>
            <p>Gmail'de kullanmak iÃ§in aÅŸaÄŸÄ±daki adÄ±mlarÄ± izleyin</p>
        </div>
        
        <div class="instructions">
            <h3>ğŸš€ Otomatik Ä°ÅŸlem:</h3>
            <p style="margin: 10px 0; font-size: 16px; color: #007bff;">
                <strong>Bu sayfa otomatik olarak:</strong>
            </p>
            <ol>
                <li>âœ… E-posta iÃ§eriÄŸini panoya kopyalar</li>
                <li>ğŸ“§ Gmail'i yeni sekmede aÃ§ar</li>
                <li>âš¡ Sizin sadece Gmail'de <strong>Ctrl+V</strong> yapmanÄ±z yeterli!</li>
            </ol>
            <hr style="margin: 15px 0;">
            <h4>ğŸ“‹ Manuel SeÃ§enekler:</h4>
            <ul style="font-size: 14px; color: #666;">
                <li><strong>Ctrl+C:</strong> Tekrar kopyala</li>
                <li><strong>Ctrl+G:</strong> Gmail'i tekrar aÃ§</li>
                <li>Veya aÅŸaÄŸÄ±daki butonlarÄ± kullanÄ±n</li>
            </ul>
        </div>
        
        <div class="email-info">
            <p><strong>ğŸ“¨ AlÄ±cÄ±:</strong> ${recipientEmail}</p>
            <p><strong>ğŸ“‹ Konu:</strong> ${emailContent.subject}</p>
        </div>
        
        <div class="email-content" id="emailContent">
            ${emailContent.body}
        </div>
        
        <div class="buttons">
            <button class="btn" onclick="copyEmailContent()">ğŸ“‹ E-posta Ä°Ã§eriÄŸini Kopyala</button>
            <button class="btn btn-secondary" onclick="openGmail()">ğŸ“§ Gmail'i AÃ§</button>
            <p class="copy-success" id="copySuccess">âœ… Ä°Ã§erik kopyalandÄ±! Åimdi Gmail'e gidip yapÄ±ÅŸtÄ±rabilirsiniz.</p>
        </div>
    </div>

    <script>
        // Sayfa yÃ¼klendiÄŸinde otomatik baÅŸlat
        window.addEventListener('load', function() {
            // 1 saniye bekle sonra otomatik iÅŸlemleri baÅŸlat
            setTimeout(autoStartProcess, 1000);
        });

        async function autoStartProcess() {
            try {
                // Modern Clipboard API ile otomatik kopyala
                await copyEmailContentModern();
                
                // 2 saniye bekle sonra Gmail'i aÃ§
                setTimeout(() => {
                    openGmail();
                    showAutoSuccessMessage();
                }, 2000);
                
            } catch (err) {
                console.log('Modern API Ã§alÄ±ÅŸmadÄ±, fallback kullanÄ±lÄ±yor');
                // Eski yÃ¶ntemle dene
                copyEmailContentFallback();
                setTimeout(() => {
                    openGmail();
                }, 1500);
            }
        }

        // Modern Clipboard API ile kopyalama
        async function copyEmailContentModern() {
            const emailContent = document.getElementById('emailContent');
            const htmlContent = emailContent.innerHTML;
            const textContent = emailContent.innerText;
            
            try {
                // Hem HTML hem text formatÄ±nda kopyala
                await navigator.clipboard.write([
                    new ClipboardItem({
                        'text/html': new Blob([htmlContent], { type: 'text/html' }),
                        'text/plain': new Blob([textContent], { type: 'text/plain' })
                    })
                ]);
                
                document.getElementById('copySuccess').style.display = 'block';
                document.getElementById('copySuccess').innerHTML = 'âœ… Ä°Ã§erik otomatik olarak kopyalandÄ±! Gmail aÃ§Ä±lÄ±yor...';
                return true;
            } catch (err) {
                throw err;
            }
        }

        // Fallback eski yÃ¶ntem
        function copyEmailContentFallback() {
            const emailContent = document.getElementById('emailContent');
            const range = document.createRange();
            range.selectNodeContents(emailContent);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            
            try {
                document.execCommand('copy');
                document.getElementById('copySuccess').style.display = 'block';
                document.getElementById('copySuccess').innerHTML = 'âœ… Ä°Ã§erik kopyalandÄ±! Gmail aÃ§Ä±lÄ±yor...';
                setTimeout(() => {
                    document.getElementById('copySuccess').style.display = 'none';
                }, 5000);
            } catch (err) {
                document.getElementById('copySuccess').style.display = 'block';
                document.getElementById('copySuccess').innerHTML = 'âš ï¸ Otomatik kopyalama baÅŸarÄ±sÄ±z. LÃ¼tfen manuel butonlarÄ± kullanÄ±n.';
                document.getElementById('copySuccess').style.color = '#dc3545';
            }
            
            selection.removeAllRanges();
        }

        // Manuel kopyalama fonksiyonu
        async function copyEmailContent() {
            try {
                await copyEmailContentModern();
            } catch (err) {
                copyEmailContentFallback();
            }
        }
        
        function openGmail() {
            // Gmail URL'ini oluÅŸtur
            const gmailUrl = 'https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(recipientEmail)}&su=${encodeURIComponent(emailContent.subject)}';
            
            // Gmail'i aÃ§
            const gmailWindow = window.open(gmailUrl, '_blank');
            
            // Gmail aÃ§Ä±ldÄ±ktan sonra otomatik yapÄ±ÅŸtÄ±rma deneme
            setTimeout(() => {
                tryAutoCompose(gmailWindow);
            }, 3000); // 3 saniye bekle Gmail yÃ¼klensin
        }

                 async function tryAutoCompose(gmailWindow) {
             try {
                 // Gmail penceresine focus ver
                 gmailWindow.focus();
                 
                 // Gmail'in yÃ¼klenmesini bekle
                 await waitForGmailLoad(gmailWindow);
                 
                 // E-posta iÃ§eriÄŸini al
                 const emailContent = document.getElementById('emailContent');
                 const htmlContent = emailContent.innerHTML;
                 
                 // FarklÄ± otomatik yapÄ±ÅŸtÄ±rma yÃ¶ntemleri dene
                 const success = await tryMultiplePasteMethods(gmailWindow, htmlContent);
                 
                 if (!success) {
                     // BaÅŸarÄ±sÄ±z olursa kullanÄ±cÄ±ya hatÄ±rlatma gÃ¶ster
                     showPasteReminder();
                 } else {
                     showSuccessMessage();
                 }
                 
             } catch (error) {
                 console.log('Otomatik yapÄ±ÅŸtÄ±rma mÃ¼mkÃ¼n deÄŸil:', error);
                 showPasteReminder();
             }
         }

         async function waitForGmailLoad(gmailWindow) {
             return new Promise((resolve) => {
                 let attempts = 0;
                 const maxAttempts = 20; // 10 saniye max bekleme
                 
                 const checkLoad = () => {
                     attempts++;
                     try {
                         if (gmailWindow.document && 
                             gmailWindow.document.readyState === 'complete' &&
                             (gmailWindow.document.querySelector('[contenteditable]') || 
                              gmailWindow.document.querySelector('.Am.Al.editable'))) {
                             resolve();
                         } else if (attempts < maxAttempts) {
                             setTimeout(checkLoad, 500);
                         } else {
                             resolve(); // Timeout olsa bile devam et
                         }
                     } catch (err) {
                         if (attempts < maxAttempts) {
                             setTimeout(checkLoad, 500);
                         } else {
                             resolve();
                         }
                     }
                 };
                 
                 checkLoad();
             });
         }

         async function tryMultiplePasteMethods(gmailWindow, htmlContent) {
             const methods = [
                 // YÃ¶ntem 1: Gmail compose alanÄ±nÄ± direkt hedefle
                 async () => {
                     const composeArea = gmailWindow.document.querySelector('[contenteditable="true"]') ||
                                        gmailWindow.document.querySelector('.Am.Al.editable') ||
                                        gmailWindow.document.querySelector('[role="textbox"]');
                     
                     if (composeArea) {
                         composeArea.focus();
                         composeArea.innerHTML = htmlContent;
                         composeArea.dispatchEvent(new gmailWindow.Event('input', { bubbles: true }));
                         return true;
                     }
                     return false;
                 },
                 
                 // YÃ¶ntem 2: Clipboard API ile yapÄ±ÅŸtÄ±rma
                 async () => {
                     if (gmailWindow.navigator.clipboard) {
                         await gmailWindow.navigator.clipboard.writeText(htmlContent);
                         gmailWindow.document.execCommand('paste');
                         return true;
                     }
                     return false;
                 },
                 
                 // YÃ¶ntem 3: Simulate user paste action
                 async () => {
                     const activeElement = gmailWindow.document.activeElement;
                     if (activeElement && activeElement.contentEditable === 'true') {
                         const pasteEvent = new gmailWindow.ClipboardEvent('paste', {
                             bubbles: true,
                             cancelable: true,
                             clipboardData: new gmailWindow.DataTransfer()
                         });
                         
                         // HTML data ekle
                         pasteEvent.clipboardData.setData('text/html', htmlContent);
                         pasteEvent.clipboardData.setData('text/plain', emailContent.innerText);
                         
                         activeElement.dispatchEvent(pasteEvent);
                         return true;
                     }
                     return false;
                 },
                 
                 // YÃ¶ntem 4: Keyboard simulation with focus
                 async () => {
                     gmailWindow.focus();
                     await new Promise(resolve => setTimeout(resolve, 500));
                     
                     const events = [
                         new gmailWindow.KeyboardEvent('keydown', { key: 'v', ctrlKey: true, bubbles: true }),
                         new gmailWindow.KeyboardEvent('keypress', { key: 'v', ctrlKey: true, bubbles: true }),
                         new gmailWindow.KeyboardEvent('keyup', { key: 'v', ctrlKey: true, bubbles: true })
                     ];
                     
                     events.forEach(event => gmailWindow.document.dispatchEvent(event));
                     return true;
                 }
             ];
             
             // Her yÃ¶ntemi sÄ±rayla dene
             for (let i = 0; i < methods.length; i++) {
                 try {
                     console.log(\`YapÄ±ÅŸtÄ±rma yÃ¶ntemi \${i + 1} deneniyor...\`);
                     const success = await methods[i]();
                     if (success) {
                         console.log(\`YÃ¶ntem \${i + 1} baÅŸarÄ±lÄ±!\`);
                         return true;
                     }
                     // YÃ¶ntemler arasÄ± kÄ±sa bekleme
                     await new Promise(resolve => setTimeout(resolve, 1000));
                 } catch (err) {
                     console.log(\`YÃ¶ntem \${i + 1} hata:\`, err);
                 }
             }
             
             return false;
         }

         function showSuccessMessage() {
             setTimeout(() => {
                 const success = document.createElement('div');
                 success.style.cssText = \`
                     position: fixed;
                     top: 20px;
                     right: 20px;
                     background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                     color: white;
                     padding: 20px;
                     border-radius: 10px;
                     box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                     z-index: 10000;
                     font-family: Arial, sans-serif;
                     font-size: 16px;
                     max-width: 350px;
                     animation: slideIn 0.5s ease-out;
                 \`;
                 
                 success.innerHTML = \`
                     <div style="display: flex; align-items: center; margin-bottom: 10px;">
                         <span style="font-size: 24px; margin-right: 10px;">ğŸ‰</span>
                         <strong>BaÅŸarÄ±lÄ±!</strong>
                     </div>
                     <p style="margin: 0;">
                         E-posta iÃ§eriÄŸi Gmail'e otomatik olarak yapÄ±ÅŸtÄ±rÄ±ldÄ±!
                     </p>
                 \`;
                 
                 document.body.appendChild(success);
                 
                 // 5 saniye sonra otomatik kapat
                 setTimeout(() => {
                     if (success.parentElement) {
                         success.remove();
                     }
                 }, 5000);
                 
             }, 1000);
         }

        function showPasteReminder() {
            // Ana pencerede hatÄ±rlatma gÃ¶ster
            setTimeout(() => {
                const reminder = document.createElement('div');
                reminder.style.cssText = \`
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 20px;
                    border-radius: 10px;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                    z-index: 10000;
                    font-family: Arial, sans-serif;
                    font-size: 16px;
                    max-width: 350px;
                    animation: slideIn 0.5s ease-out;
                \`;
                
                reminder.innerHTML = \`
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span style="font-size: 24px; margin-right: 10px;">ğŸ“§</span>
                        <strong>Gmail AÃ§Ä±ldÄ±!</strong>
                    </div>
                    <p style="margin: 0 0 15px 0;">
                        Gmail'de <strong>Ctrl+V</strong> tuÅŸlarÄ±na basarak e-posta iÃ§eriÄŸini yapÄ±ÅŸtÄ±rÄ±n.
                    </p>
                    <div style="text-align: center;">
                        <button onclick="this.parentElement.parentElement.remove()" 
                                style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); 
                                       color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer;">
                            AnladÄ±m âœ“
                        </button>
                    </div>
                \`;
                
                // CSS animation ekle
                if (!document.querySelector('#slideInAnimation')) {
                    const style = document.createElement('style');
                    style.id = 'slideInAnimation';
                    style.textContent = \`
                        @keyframes slideIn {
                            from { transform: translateX(100%); opacity: 0; }
                            to { transform: translateX(0); opacity: 1; }
                        }
                    \`;
                    document.head.appendChild(style);
                }
                
                document.body.appendChild(reminder);
                
                // 10 saniye sonra otomatik kapat
                setTimeout(() => {
                    if (reminder.parentElement) {
                        reminder.remove();
                    }
                }, 10000);
                
            }, 1000);
        }

        function showAutoSuccessMessage() {
            document.getElementById('copySuccess').style.display = 'block';
            document.getElementById('copySuccess').innerHTML = 'ğŸš€ TamamlandÄ±! Gmail aÃ§Ä±ldÄ±, iÃ§erik kopyalandÄ±. ArtÄ±k Ctrl+V ile yapÄ±ÅŸtÄ±rabilirsiniz!';
            document.getElementById('copySuccess').style.color = '#28a745';
            document.getElementById('copySuccess').style.fontSize = '16px';
            document.getElementById('copySuccess').style.fontWeight = 'bold';
        }

        // Klavye kÄ±sayolu ekle
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'c') {
                e.preventDefault();
                copyEmailContent();
            }
            if (e.ctrlKey && e.key === 'g') {
                e.preventDefault();
                openGmail();
            }
        });
    </script>
</body>
</html>`;
    
    newWindow.document.write(htmlContent);
    newWindow.document.close();
}

/**
 * E-posta tÃ¼rÃ¼ne gÃ¶re iÃ§erik oluÅŸturur
 */
function generateEmailByType(type, student) {
    const instructor = getInstructorName();
    const courseName = getCourseInfo().name;
    const courseTerm = getCourseInfo().term;
    
    switch (type) {
        case 'survey':
            return generateSurveyEmail(student, instructor, courseName, courseTerm);
        case 'detailed':
            return generateDetailedScoreEmail(student, instructor, courseName, courseTerm);
        case 'analysis':
            return generateAnalysisEmail(student, instructor, courseName, courseTerm);
        case 'info':
            return generateInfoRequestEmail(student, instructor, courseName, courseTerm);
        default:
            return generateDetailedEmailContent(student.studentId);
    }
}

/**
 * Anket e-postasÄ± oluÅŸturur
 */
function generateSurveyEmail(student, instructor, courseName, courseTerm) {
    const subject = `${courseName} - Ders Bazinda Ogrenme Ciktilari Anketi`;
    
    console.log('DEBUG: APP_STATE.courseData:', APP_STATE.courseData);
    console.log('DEBUG: dersOgrenmeÃ‡iktilari:', APP_STATE.courseData?.dersOgrenmeÃ‡iktilari);
    
    const outcomes = APP_STATE.courseData?.dersOgrenmeÃ‡iktilari || [];
    
    console.log('DEBUG: outcomes length:', outcomes.length);
    console.log('DEBUG: outcomes:', outcomes);
    const courseCode = APP_STATE.courseData?.dersBilgisi?.dersKodu || 'XXX000';
    
    // HTML formatÄ±nda soru listesi
    let questionSection = '';
    if (outcomes.length > 0) {
        questionSection = `
        <table style="width: 100%; border-collapse: collapse; margin: 20px 0; font-family: Arial, sans-serif;">
            <thead>
                <tr style="background-color: #f0f0f0;">
                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd; width: 60%;">Ã–ÄŸrenme Ã‡Ä±ktÄ±larÄ±</th>
                    <th style="padding: 10px; text-align: center; border: 1px solid #ddd; width: 8%;">5</th>
                    <th style="padding: 10px; text-align: center; border: 1px solid #ddd; width: 8%;">4</th>
                    <th style="padding: 10px; text-align: center; border: 1px solid #ddd; width: 8%;">3</th>
                    <th style="padding: 10px; text-align: center; border: 1px solid #ddd; width: 8%;">2</th>
                    <th style="padding: 10px; text-align: center; border: 1px solid #ddd; width: 8%;">1</th>
                </tr>
            </thead>
            <tbody>`;
        
        outcomes.forEach((outcome, index) => {
            const questionNum = index + 1;
            const fullDescription = outcome.aciklama || outcome.description || 'TanÄ±mlanmamÄ±ÅŸ';
            
            questionSection += `
                <tr style="border-bottom: 1px solid #ddd;">
                    <td style="padding: 15px; border: 1px solid #ddd; vertical-align: top;">
                        <strong>${questionNum}.</strong> ${fullDescription}
                    </td>
                    <td style="padding: 15px; border: 1px solid #ddd; text-align: center; vertical-align: middle;">
                        <input type="checkbox" style="transform: scale(1.5);" />
                    </td>
                    <td style="padding: 15px; border: 1px solid #ddd; text-align: center; vertical-align: middle;">
                        <input type="checkbox" style="transform: scale(1.5);" />
                    </td>
                    <td style="padding: 15px; border: 1px solid #ddd; text-align: center; vertical-align: middle;">
                        <input type="checkbox" style="transform: scale(1.5);" />
                    </td>
                    <td style="padding: 15px; border: 1px solid #ddd; text-align: center; vertical-align: middle;">
                        <input type="checkbox" style="transform: scale(1.5);" />
                    </td>
                    <td style="padding: 15px; border: 1px solid #ddd; text-align: center; vertical-align: middle;">
                        <input type="checkbox" style="transform: scale(1.5);" />
                    </td>
                </tr>`;
        });
        
        questionSection += `
            </tbody>
        </table>
        
        <div style="margin: 20px 0; padding: 15px; background-color: #f9f9f9; border-left: 4px solid #007bff;">
            <h4 style="margin: 0 0 10px 0; color: #007bff;">DeÄŸerlendirme SkalasÄ±:</h4>
            <ul style="margin: 0; padding-left: 20px; list-style-type: none;">
                <li><strong>5:</strong> Kesinlikle KatÄ±lÄ±yorum</li>
                <li><strong>4:</strong> KatÄ±lÄ±yorum</li>
                <li><strong>3:</strong> KÄ±smen KatÄ±lÄ±yorum</li>
                <li><strong>2:</strong> KatÄ±lmÄ±yorum</li>
                <li><strong>1:</strong> Kesinlikle KatÄ±lmÄ±yorum</li>
            </ul>
        </div>`;
    } else {
        questionSection = `
        <div style="padding: 20px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; color: #856404;">
            <strong>UyarÄ±:</strong> Bu ders iÃ§in Ã¶ÄŸrenme Ã§Ä±ktÄ±larÄ± tanÄ±mlanmamÄ±ÅŸ.<br>
            LÃ¼tfen ders sorumlusu ile iletiÅŸime geÃ§iniz.
        </div>`;
    }
    
    const body = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ders DeÄŸerlendirme Anketi</title>
</head>
<body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; padding: 20px;">
    
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0;">
        <h1 style="margin: 0; font-size: 24px; font-weight: bold;">Recep Tayyip ErdoÄŸan Ãœniversitesi</h1>
        <h2 style="margin: 10px 0; font-size: 18px; font-weight: normal;">Bilgisayar MÃ¼hendisliÄŸi</h2>
        <h3 style="margin: 10px 0; font-size: 16px; font-weight: normal;">Ders BazÄ±nda Ã–ÄŸrenme Ã‡Ä±ktÄ±larÄ± Anketi</h3>
    </div>
    
    <div style="background-color: #f8f9fa; padding: 25px; border: 1px solid #dee2e6;">
        <p style="margin: 0 0 15px 0; font-size: 16px;">
            <strong>DeÄŸerli Recep Tayyip ErdoÄŸan Ãœniversitesi Bilgisayar MÃ¼hendisliÄŸi Ã–ÄŸrencileri;</strong>
        </p>
        
        <p style="margin: 0 0 15px 0; text-align: justify;">
            AÅŸaÄŸÄ±da verilen ders bazÄ±nda Ã¶ÄŸrenme Ã§Ä±ktÄ±sÄ± anketi bÃ¶lÃ¼mÃ¼mÃ¼z lisans 
            programÄ±nda yer alan derslerin deÄŸerlendirilmesi amacÄ± ile hazÄ±rlanmÄ±ÅŸtÄ±r. 
            Ankete yanÄ±t verirken lÃ¼tfen dersin ilgili Ã¶ÄŸrenme Ã§Ä±ktÄ±sÄ±na katkÄ±sÄ±nÄ± 
            deÄŸerlendiriniz. KatkÄ± oranÄ± iÃ§in seÃ§tiÄŸiniz yanÄ±ta karÅŸÄ±lÄ±k gelen 
            kutucuÄŸa iÅŸaret koyunuz.
        </p>
        
        <p style="margin: 0; font-style: italic; color: #6c757d;">
            GÃ¶sterdiÄŸiniz ilgi ve zamanÄ±nÄ±z iÃ§in Ã§ok teÅŸekkÃ¼r ederiz.
        </p>
    </div>
    
    <div style="background-color: white; padding: 25px; border: 1px solid #dee2e6; border-top: none;">
        <div style="background-color: #e9ecef; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
            <h3 style="margin: 0; color: #495057;">
                <strong>Dersin Kodu / AdÄ±:</strong> ${courseCode} / ${courseName}
            </h3>
        </div>
        
        ${questionSection}
    </div>
    
    <div style="background-color: #f8f9fa; padding: 25px; border: 1px solid #dee2e6; border-top: none; border-radius: 0 0 10px 10px;">
        <div style="text-align: center; margin-bottom: 20px;">
            <p style="margin: 0; font-size: 14px; color: #6c757d;">
                Bu anket <strong>${new Date().toLocaleDateString('tr-TR')}</strong> tarihinde gÃ¶nderilmiÅŸtir.
            </p>
        </div>
        
        <div style="background-color: white; padding: 20px; border-radius: 5px; border-left: 4px solid #28a745;">
            <p style="margin: 0 0 10px 0; font-size: 16px;">
                <strong>Merhaba ${student.name} ${student.surname},</strong>
            </p>
            <p style="margin: 0 0 15px 0;">
                LÃ¼tfen anketi doldurarak bana geri gÃ¶nderiniz.
            </p>
            <p style="margin: 0; font-style: italic; color: #28a745;">
                <strong>Ä°yi Ã§alÄ±ÅŸmalar,</strong><br>
                ${instructor}
            </p>
        </div>
    </div>
    
</body>
</html>`;

    return { subject, body };
}

/**
 * Ã–Ã‡-PÃ‡ analiz e-postasÄ±
 */
/**
 * DetaylÄ± puan bilgisi e-postasÄ±
 */
/**
 * HTML format iÃ§in yardÄ±mcÄ± fonksiyonlar
 */
function createStudentInfoHTML(studentData, courseName, courseTerm) {
    return `
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; margin-bottom: 25px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.1);">
        <h2 style="margin: 0 0 15px 0; font-size: 24px; font-weight: 700;">ğŸ“š Ã–ÄŸrenci Bilgileri</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; font-size: 16px;">
            <div><strong>ğŸ‘¤ Ad Soyad:</strong> ${studentData.name} ${studentData.surname}</div>
            <div><strong>ğŸ†” Ã–ÄŸrenci No:</strong> ${studentData.studentId}</div>
            <div><strong>ğŸ“– Ders:</strong> ${courseName}</div>
            <div><strong>ğŸ“… DÃ¶nem:</strong> ${courseTerm}</div>
        </div>
    </div>`;
}

function createTermComponentHTML(componentData, studentGrades, isTermSection = true) {
    const componentId = componentData.id;
    const componentName = componentData.name || componentData.ad || componentId;
    const weight = componentData.weight || componentData.agirlik || 0;
    
    const sectionColor = isTermSection ? '#e8f5e8' : '#fff3e0';
    const headerColor = isTermSection ? '#4caf50' : '#ff9800';
    
    let childrenHTML = '';
    let componentScore = 0;
    let maxComponentScore = 0;
    
    // Alt Ã¶ÄŸeleri kontrol et ve notlarÄ± topla - TEXT FORMAT MANTIGI
    if (componentData.children && componentData.children.length > 0) {
        componentData.children.forEach(child => {
            const childId = child.id;
            const childName = child.name || child.ad || childId;
            const childPoints = child.points || 20; // VarsayÄ±lan 20 puan
            
            // Notu al - farklÄ± kaynaklardan dene
            const grade = studentGrades[childId] || studentGrades[componentId]?.[childId] || 0;
            
            childrenHTML += `
                <div style="margin: 8px 0; padding: 10px; background: #f9f9f9; border-left: 3px solid ${headerColor}; border-radius: 4px;">
                    <span style="font-weight: 600;">${childName}:</span> ${grade}/${childPoints} puan
                </div>`;
            
            // Alt Ã¶ÄŸe notlarÄ±nÄ± topla
            componentScore += parseFloat(grade) || 0;
            maxComponentScore += parseFloat(childPoints) || 0;
        });
    } else {
        // Alt Ã¶ÄŸe yoksa doÄŸrudan bileÅŸen puanÄ±nÄ± al
        componentScore = studentGrades[componentId] || 0;
        maxComponentScore = 100; // VarsayÄ±lan maksimum puan
    }
    
    // YÃ¼zdelik hesaplama
    const componentPercentage = maxComponentScore > 0 ? (componentScore / maxComponentScore * 100) : 0;
    const agirlikli_katki = (componentPercentage * weight) / 100;
    
    return `
    <div style="background: ${sectionColor}; padding: 20px; margin: 15px 0; border-radius: 10px; border-left: 5px solid ${headerColor};">
        <h4 style="color: ${headerColor}; margin: 0 0 15px 0; font-size: 18px; font-weight: 700;">
            ${componentName} - ${componentId} (AÄŸÄ±rlÄ±k: %${weight})
        </h4>
        ${childrenHTML}
        <div style="margin: 15px 0; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            <div style="margin: 5px 0;"><strong>ğŸ“Š BileÅŸen ToplamÄ±:</strong> ${componentScore}/${maxComponentScore} (%${componentPercentage.toFixed(2)})</div>
            <div style="margin: 5px 0; color: #666; font-style: italic;">ğŸ“ FormÃ¼l: BP = ${componentScore}/${maxComponentScore} Ã— 100 = %${componentPercentage.toFixed(2)}</div>
            <div style="margin: 5px 0; color: ${headerColor}; font-weight: 600;">âš–ï¸ AÄŸÄ±rlÄ±klÄ± KatkÄ±: AK = ${componentPercentage.toFixed(2)} Ã— ${weight}/100 = %${agirlikli_katki.toFixed(2)}</div>
        </div>
    </div>`;
}

function createResultHTML(yilIciOrtalamasÄ±, yilSonuOrtalamasi, overallAverage, letterGrade) {
    const genel_yariyil_ici_katkisi = (yilIciOrtalamasÄ± * 40) / 100;
    const genel_yariyil_sonu_katkisi = (yilSonuOrtalamasi * 60) / 100;
    const passed = overallAverage >= 60;
    
    return `
    <div style="background: linear-gradient(135deg, #ff6b6b 0%, #ffa726 100%); color: white; padding: 25px; margin: 25px 0; border-radius: 12px; text-align: center;">
        <h3 style="margin: 0 0 20px 0; font-size: 22px; font-weight: 700;">ğŸ¯ YÄ±l Sonu Hesaplama</h3>
        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <div style="margin: 8px 0;">YarÄ±yÄ±l Ä°Ã§i KatkÄ±sÄ±: %${yilIciOrtalamasÄ±.toFixed(2)} Ã— 40/100 = <strong>%${genel_yariyil_ici_katkisi.toFixed(2)}</strong></div>
            <div style="margin: 8px 0;">YarÄ±yÄ±l Sonu KatkÄ±sÄ±: %${yilSonuOrtalamasi.toFixed(2)} Ã— 60/100 = <strong>%${genel_yariyil_sonu_katkisi.toFixed(2)}</strong></div>
            <hr style="border: 1px solid rgba(255,255,255,0.3); margin: 15px 0;">
            <div style="font-size: 20px; font-weight: 700;">Genel Ortalama: %${genel_yariyil_ici_katkisi.toFixed(2)} + %${genel_yariyil_sonu_katkisi.toFixed(2)} = <span style="color: #ffeb3b;">%${overallAverage.toFixed(2)}</span></div>
        </div>
        <div style="font-size: 24px; font-weight: 700; margin: 15px 0;">
            <span style="color: #ffeb3b;">Harf Notu: ${letterGrade}</span>
        </div>
        <div style="font-size: 18px; color: ${passed ? '#4caf50' : '#f44336'}; background: rgba(255,255,255,0.9); color: ${passed ? '#2e7d32' : '#c62828'}; padding: 10px; border-radius: 6px; font-weight: 700;">
            ${passed ? 'âœ… GEÃ‡TÄ°' : 'âŒ KALDI'}
        </div>
    </div>`;
}

function createGradeExplanationHTML() {
    return `
    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
        <h4 style="color: #495057; margin: 0 0 15px 0; font-weight: 700;">ğŸ“‹ Not AÃ§Ä±klamasÄ±</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; text-align: center;">
            <div style="background: #28a745; color: white; padding: 8px; border-radius: 6px; font-weight: 600;">AA: 90-100</div>
            <div style="background: #20c997; color: white; padding: 8px; border-radius: 6px; font-weight: 600;">BA: 85-89</div>
            <div style="background: #17a2b8; color: white; padding: 8px; border-radius: 6px; font-weight: 600;">BB: 80-84</div>
            <div style="background: #ffc107; color: #212529; padding: 8px; border-radius: 6px; font-weight: 600;">CB: 75-79</div>
            <div style="background: #fd7e14; color: white; padding: 8px; border-radius: 6px; font-weight: 600;">CC: 70-74</div>
            <div style="background: #dc3545; color: white; padding: 8px; border-radius: 6px; font-weight: 600;">DC: 65-69</div>
            <div style="background: #6f42c1; color: white; padding: 8px; border-radius: 6px; font-weight: 600;">DD: 60-64</div>
            <div style="background: #e83e8c; color: white; padding: 8px; border-radius: 6px; font-weight: 600;">FD: 50-59</div>
            <div style="background: #6c757d; color: white; padding: 8px; border-radius: 6px; font-weight: 600;">FF: 0-49</div>
        </div>
    </div>`;
}

function createContactHTML(instructor) {
    return `
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin: 20px 0;">
        <h4 style="margin: 0 0 15px 0; font-weight: 700;">ğŸ“ Ä°letiÅŸim</h4>
        <div style="line-height: 1.6;">
            <div style="margin: 8px 0;">ğŸ“§ <strong>E-posta:</strong> ${instructor}</div>
            <div style="margin: 8px 0;">ğŸ• <strong>Ofis Saatleri:</strong> [Belirtilecek]</div>
            <div style="margin: 8px 0;">ğŸ’¬ <strong>SorularÄ±nÄ±z iÃ§in:</strong> LÃ¼tfen bana ulaÅŸabilirsiniz</div>
            <div style="margin: 8px 0;">ğŸ“… <strong>Rapor Tarihi:</strong> ${new Date().toLocaleDateString('tr-TR')}</div>
        </div>
    </div>`;
}

/**
 * DetaylÄ± puan e-postasÄ± oluÅŸturur (HTML formatÄ±) - DÃœZELTILMIÅ
 */
function generateDetailedScoreEmail(student, instructor, courseName, courseTerm) {
    const subject = `${courseName} - KapsamlÄ± DeÄŸerlendirme Raporu`;
    
    // Ã–ÄŸrenci verilerini al
    let studentData = APP_STATE.studentData?.find(s => s.studentId === student.studentId);
    if (!studentData) {
        studentData = {
            studentId: student.studentId,
            name: student.name || 'Bilinmeyen',
            surname: student.surname || 'Ã–ÄŸrenci'
        };
    }

    // Sistemdeki tÃ¼m deÄŸerlendirme bileÅŸenlerini al
    let assessmentTree = APP_STATE.assessmentTree || APP_STATE.courseData?.degerlendirmeAgaci || [];
    
    // Ã–ÄŸrenci notlarÄ±nÄ± al
    const allGradesData = APP_STATE.gradesData || APP_STATE.courseData?.ogrenciNotlari || {};
    const studentGrades = allGradesData[studentData.studentId] || {};
    
    // YARIYIL ICI ETKINLIKLER (40% aÄŸÄ±rlÄ±k) - TEXT FORMAT MANTIGI
    const termComponents = assessmentTree.filter(comp => comp.id && comp.id.startsWith('A'));
    let termWeightedSum = 0;
    let termTotalWeight = 0;
    let termHTML = '';
    
    termComponents.forEach(componentData => {
        const componentId = componentData.id;
        const weight = componentData.weight || componentData.agirlik || 0;
        
        // Alt Ã¶ÄŸe hesaplama mantÄ±ÄŸÄ± - TEXT FORMAT GÄ°BÄ°
        let componentScore = 0;
        let maxComponentScore = 0;
        
        if (componentData.children && componentData.children.length > 0) {
            // Alt Ã¶ÄŸeler varsa bunlarÄ± topla
            componentData.children.forEach(child => {
                const childId = child.id;
                const childPoints = child.points || 20;
                const grade = studentGrades[childId] || studentGrades[componentId]?.[childId] || 0;
                
                componentScore += parseFloat(grade) || 0;
                maxComponentScore += parseFloat(childPoints) || 0;
            });
        } else {
            // Alt Ã¶ÄŸe yoksa doÄŸrudan bileÅŸen puanÄ±nÄ± al
            componentScore = studentGrades[componentId] || 0;
            maxComponentScore = 100;
        }
        
        termHTML += createTermComponentHTML(componentData, studentGrades, true);
        
        // YÃ¼zdelik hesaplama ve aÄŸÄ±rlÄ±klÄ± katkÄ±
        const componentPercentage = maxComponentScore > 0 ? (componentScore / maxComponentScore * 100) : 0;
        const agirlikli_katki = (componentPercentage * weight) / 100;
        termWeightedSum += agirlikli_katki;
        termTotalWeight += weight;
    });
    
    // YARIYIL SONU ETKINLIKLER (60% aÄŸÄ±rlÄ±k) - TEXT FORMAT MANTIGI  
    const finalComponents = assessmentTree.filter(comp => comp.id && comp.id.startsWith('F'));
    let finalWeightedSum = 0;
    let finalTotalWeight = 0;
    let finalHTML = '';
    
    finalComponents.forEach(componentData => {
        const componentId = componentData.id;
        const weight = componentData.weight || componentData.agirlik || 0;
        
        // Alt Ã¶ÄŸe hesaplama mantÄ±ÄŸÄ± - TEXT FORMAT GÄ°BÄ°
        let componentScore = 0;
        let maxComponentScore = 0;
        
        if (componentData.children && componentData.children.length > 0) {
            // Alt Ã¶ÄŸeler varsa bunlarÄ± topla
            componentData.children.forEach(child => {
                const childId = child.id;
                const childPoints = child.points || 20;
                const grade = studentGrades[childId] || studentGrades[componentId]?.[childId] || 0;
                
                componentScore += parseFloat(grade) || 0;
                maxComponentScore += parseFloat(childPoints) || 0;
            });
        } else {
            // Alt Ã¶ÄŸe yoksa doÄŸrudan bileÅŸen puanÄ±nÄ± al
            componentScore = studentGrades[componentId] || 0;
            maxComponentScore = 100;
        }
        
        finalHTML += createTermComponentHTML(componentData, studentGrades, false);
        
        // YÃ¼zdelik hesaplama ve aÄŸÄ±rlÄ±klÄ± katkÄ±
        const componentPercentage = maxComponentScore > 0 ? (componentScore / maxComponentScore * 100) : 0;
        const agirlikli_katki = (componentPercentage * weight) / 100;
        finalWeightedSum += agirlikli_katki;
        finalTotalWeight += weight;
    });
    
    // YIL SONU HESAPLAMA (YarÄ±yÄ±l Ä°Ã§i %40 + YarÄ±yÄ±l Sonu %60) - DOÄRU FORMÃœL
    const yilIciOrtalamasÄ± = termTotalWeight > 0 ? (termWeightedSum * 100 / termTotalWeight) : 0;
    const yilSonuOrtalamasi = finalTotalWeight > 0 ? (finalWeightedSum * 100 / finalTotalWeight) : 0;
    
    const genel_yariyil_ici_katkisi = (yilIciOrtalamasÄ± * 40) / 100;  // YarÄ±yÄ±l iÃ§i %40
    const genel_yariyil_sonu_katkisi = (yilSonuOrtalamasi * 60) / 100; // YarÄ±yÄ±l sonu %60
    const overallAverage = genel_yariyil_ici_katkisi + genel_yariyil_sonu_katkisi; // DOÄRU HESAPLAMA
    
    const letterGrade = calculateLetterGrade(overallAverage);
    
    const body = `
    <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 800px; margin: 0 auto; background: #ffffff; color: #333;">
        ${createStudentInfoHTML(studentData, courseName, courseTerm)}
        
        <div style="background: #e8f5e8; padding: 20px; margin: 20px 0; border-radius: 10px; border-left: 5px solid #4caf50;">
            <h3 style="color: #4caf50; margin: 0 0 15px 0; font-size: 20px; font-weight: 700;">ğŸŒ± YarÄ±yÄ±l Ä°Ã§i Etkinlikler (Toplam AÄŸÄ±rlÄ±k: %40)</h3>
            ${termHTML}
            <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 15px; text-align: center;">
                <div style="font-size: 16px; font-weight: 600; color: #4caf50;">ğŸ“Š YarÄ±yÄ±l Ä°Ã§i ToplamÄ±: %${termWeightedSum.toFixed(2)}</div>
                <div style="font-size: 14px; color: #666; margin-top: 5px;">YarÄ±yÄ±l Ä°Ã§i OrtalamasÄ±: %${yilIciOrtalamasÄ±.toFixed(2)}</div>
            </div>
        </div>
        
        <div style="background: #fff3e0; padding: 20px; margin: 20px 0; border-radius: 10px; border-left: 5px solid #ff9800;">
            <h3 style="color: #ff9800; margin: 0 0 15px 0; font-size: 20px; font-weight: 700;">ğŸ YarÄ±yÄ±l Sonu Etkinlikler (Toplam AÄŸÄ±rlÄ±k: %60)</h3>
            ${finalHTML}
            <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 15px; text-align: center;">
                <div style="font-size: 16px; font-weight: 600; color: #ff9800;">ğŸ“Š YarÄ±yÄ±l Sonu ToplamÄ±: %${finalWeightedSum.toFixed(2)}</div>
                <div style="font-size: 14px; color: #666; margin-top: 5px;">YarÄ±yÄ±l Sonu OrtalamasÄ±: %${yilSonuOrtalamasi.toFixed(2)}</div>
            </div>
        </div>
        
        ${createResultHTML(yilIciOrtalamasÄ±, yilSonuOrtalamasi, overallAverage, letterGrade)}
        ${createGradeExplanationHTML()}
        ${createContactHTML(instructor)}
        
        <div style="text-align: center; padding: 20px; color: #666; font-style: italic;">
            <div style="margin: 10px 0;">Bu rapor tÃ¼m hesaplamalarÄ± adÄ±m adÄ±m gÃ¶stermektedir.</div>
            <div style="font-weight: 600;">Ä°yi Ã§alÄ±ÅŸmalar! ğŸ“</div>
        </div>
    </div>`;

    return { subject, body };
}

/**
 * SayÄ±sal notu harf notuna Ã§evirir
 */
// Ä°lk calculateLetterGrade fonksiyonu kaldÄ±rÄ±ldÄ± - daha kÄ±sa versiyon korundu

function generateAnalysisEmail(student, instructor, courseName, courseTerm) {
    const subject = `${courseName} - OC-PC Performans Analizi`;
    
    // Ã–ÄŸrenci verilerini al
    let studentData = APP_STATE.studentData?.find(s => s.studentId === student.studentId);
    if (!studentData) {
        studentData = {
            studentId: student.studentId,
            name: student.name || 'Bilinmeyen',
            surname: student.surname || 'Ã–ÄŸrenci'
        };
    }

    // Ã–ÄŸrenme Ã§Ä±ktÄ±larÄ±nÄ± ve program Ã§Ä±ktÄ±larÄ±nÄ± al
    const outcomes = APP_STATE.courseData?.dersOgrenmeÃ‡iktilari || [];
    const programOutcomes = APP_STATE.courseData?.programCiktilari || [];
    
    // DeÄŸerlendirme aÄŸacÄ±nÄ± al
    const assessmentTree = APP_STATE.assessmentTree || [];
    const studentGrades = APP_STATE.gradesData?.[studentData.studentId] || {};
    
    // Ã–Ã‡ performansÄ±nÄ± hesapla - JSON'dan gelen tam tanÄ±mlarÄ± kullan
    let outcomeAnalysis = '';
    let totalOutcomePerformance = 0;
    let validOutcomes = 0;
    
    outcomes.forEach((outcome, index) => {
        const outcomeId = outcome.id || `Ã–Ã‡.${index + 1}`;
        const fullDescription = outcome.aciklama || outcome.description || 'TanÄ±mlanmamÄ±ÅŸ';
        
        // Bu Ã¶ÄŸrenme Ã§Ä±ktÄ±sÄ± ile iliÅŸkili aktivitelerin performansÄ±nÄ± hesapla
        let outcomePerformance = 0;
        let relatedActivities = 0;
        
        // DeÄŸerlendirme aÄŸacÄ±ndan bu Ã¶ÄŸrenme Ã§Ä±ktÄ±sÄ± ile iliÅŸkili aktiviteleri bul
        assessmentTree.forEach(component => {
            if (component.outcomes && component.outcomes.includes(outcomeId)) {
                const componentGrade = studentGrades[component.id] || 0;
                const componentMax = component.points || 100;
                const componentPerf = componentMax > 0 ? (componentGrade / componentMax) * 100 : 0;
                
                outcomePerformance += componentPerf;
                relatedActivities++;
            }
            
            // Alt Ã¶ÄŸeleri de kontrol et
            if (component.children) {
                component.children.forEach(child => {
                    if (child.outcomes && child.outcomes.includes(outcomeId)) {
                        const childGrade = studentGrades[child.id] || 0;
                        const childMax = child.points || 100;
                        const childPerf = childMax > 0 ? (childGrade / childMax) * 100 : 0;
                        
                        outcomePerformance += childPerf;
                        relatedActivities++;
                    }
                });
            }
        });
        
        const finalPerformance = relatedActivities > 0 ? (outcomePerformance / relatedActivities) : 0;
        const performanceLevel = finalPerformance >= 85 ? 'Ã‡ok Ä°yi' : 
                               finalPerformance >= 70 ? 'Ä°yi' : 
                               finalPerformance >= 55 ? 'Orta' : 
                               finalPerformance >= 40 ? 'ZayÄ±f' : 'Ã‡ok ZayÄ±f';
        
        outcomeAnalysis += `${outcomeId}: ${performanceLevel} (%${finalPerformance.toFixed(2)})\n`;
        outcomeAnalysis += `   TanÄ±mÄ±: ${fullDescription}\n`;
        outcomeAnalysis += `   Ä°liÅŸkili Etkinlik SayÄ±sÄ±: ${relatedActivities}\n\n`;
        
        if (relatedActivities > 0) {
            totalOutcomePerformance += finalPerformance;
            validOutcomes++;
        }
    });
    
    // Program Ã§Ä±ktÄ±larÄ± ile iliÅŸki analizi - JSON'dan gelen iliÅŸki matrisini kullan
    const relationshipMatrix = APP_STATE.courseData?.programVeOgrenmeIliskisi?.iliskiTablosu || [];
    let programAnalysis = '';
    
    programOutcomes.forEach((pc, index) => {
        const pcId = pc.id || `PÃ‡.${index + 1}`;
        const pcCategory = pc.kategori || 'Kategori BelirtilmemiÅŸ';
        const pcFullDescription = pc.aciklama || pc.description || 'TanÄ±mlanmamÄ±ÅŸ';
        
        // Bu program Ã§Ä±ktÄ±sÄ± ile iliÅŸkili Ã¶ÄŸrenme Ã§Ä±ktÄ±larÄ±nÄ± JSON'dan bul
        const relatedRelations = relationshipMatrix.filter(relation => {
            const relationValue = relation.programÃ‡iktilariIliskileri?.[pcId] || 0;
            return relationValue > 0;
        });
        
        if (relatedRelations.length > 0) {
            let strongRelations = 0;
            let moderateRelations = 0;
            let totalRelationStrength = 0;
            
            relatedRelations.forEach(relation => {
                const strength = relation.programÃ‡iktilariIliskileri[pcId];
                totalRelationStrength += strength;
                if (strength >= 4) strongRelations++;
                else if (strength >= 3) moderateRelations++;
            });
            
            const avgStrength = relatedRelations.length > 0 ? (totalRelationStrength / relatedRelations.length).toFixed(2) : 0;
            
            programAnalysis += `${pcId} - ${pcCategory}\n`;
            programAnalysis += `   TanÄ±mÄ±: ${pcFullDescription}\n`;
            programAnalysis += `   Ä°liÅŸkili Ã–Ã‡ SayÄ±sÄ±: ${relatedRelations.length}\n`;
            programAnalysis += `   GÃ¼Ã§lÃ¼ Ä°liÅŸki: ${strongRelations}, Orta Ä°liÅŸki: ${moderateRelations}\n`;
            programAnalysis += `   Ortalama Ä°liÅŸki GÃ¼cÃ¼: ${avgStrength}/5\n\n`;
        }
    });
    
    // Genel performans deÄŸerlendirmesi
    const overallPerformance = validOutcomes > 0 ? (totalOutcomePerformance / validOutcomes) : 0;
    const performanceComment = overallPerformance >= 85 ? 'Ã‡ok baÅŸarÄ±lÄ± bir performans gÃ¶sterdiniz! TÃ¼m Ã¶ÄŸrenme Ã§Ä±ktÄ±larÄ±nÄ± mÃ¼kemmel bir ÅŸekilde karÅŸÄ±ladÄ±nÄ±z.' :
                              overallPerformance >= 70 ? 'Genel olarak baÅŸarÄ±lÄ± bir performans! Ã‡oÄŸu Ã¶ÄŸrenme Ã§Ä±ktÄ±sÄ±nÄ± iyi seviyede karÅŸÄ±ladÄ±nÄ±z.' :
                              overallPerformance >= 55 ? 'Orta dÃ¼zey bir performans sergiledÄ±nÄ±z. BazÄ± alanlarda geliÅŸim fÄ±rsatlarÄ±nÄ±z mevcut.' :
                              overallPerformance >= 40 ? 'PerformansÄ±nÄ±zÄ± artÄ±rmak iÃ§in ek Ã§alÄ±ÅŸma gerekli. Temel konularÄ± gÃ¶zden geÃ§irmenizi Ã¶neriyorum.' :
                              'PerformansÄ±nÄ±zda Ã¶nemli geliÅŸim alanlarÄ± var. KapsamlÄ± bir Ã§alÄ±ÅŸma planÄ± oluÅŸturmanÄ±zÄ± Ã¶neriyorum.';
    
    const body = `Merhaba ${studentData.name} ${studentData.surname},

${courseName} dersi iÃ§in Ã–Ã‡-PÃ‡ (Ã–ÄŸrenme Ã‡Ä±ktÄ±larÄ± - Program Ã‡Ä±ktÄ±larÄ±) performans analiziniz aÅŸaÄŸÄ±dadÄ±r:

Ã–ÄRENCI BÄ°LGÄ°LERÄ°:
=================
Ad Soyad: ${studentData.name} ${studentData.surname}
Ã–ÄŸrenci No: ${studentData.studentId}
Ders: ${courseName}
DÃ¶nem: ${courseTerm}

Ã–ÄRENME Ã‡IKTILARI PERFORMANSI:
=============================
${outcomes.length > 0 ? outcomeAnalysis : 'Bu ders iÃ§in Ã¶ÄŸrenme Ã§Ä±ktÄ±larÄ± tanÄ±mlanmamÄ±ÅŸ.'}

PROGRAM Ã‡IKTILARI Ä°LÄ°ÅKÄ° ANALÄ°ZÄ°:
=================================
${programOutcomes.length > 0 ? programAnalysis : 'Program Ã§Ä±ktÄ±larÄ± bilgisi mevcut deÄŸil.'}

GENEL DEÄERLENDÄ°RME:
===================
Genel Ã–Ã‡ PerformansÄ±: %${overallPerformance.toFixed(2)}
DeÄŸerlendirme: ${performanceComment}

Analiz Edilen Ã–Ã‡ SayÄ±sÄ±: ${validOutcomes}
Toplam Ã–Ã‡ SayÄ±sÄ±: ${outcomes.length}
Toplam PÃ‡ SayÄ±sÄ±: ${programOutcomes.length}

GELÄ°ÅÄ°M PLANI VE Ã–NERÄ°LER:
=========================
${overallPerformance >= 85 ? 
`1. KÄ±sa Vadeli: Mevcut performansÄ±nÄ±zÄ± koruyun ve baÅŸkalarÄ±na mentÃ¶rlÃ¼k yapÄ±n
2. Orta Vadeli: Liderlik becerilerinizi geliÅŸtirin ve proje yÃ¶netimi deneyimi kazanÄ±n
3. Uzun Vadeli: Ä°leri dÃ¼zey konulara odaklanÄ±n ve araÅŸtÄ±rma projelerine katÄ±lÄ±n` :
overallPerformance >= 70 ?
`1. KÄ±sa Vadeli: Ä°yi olduÄŸunuz alanlarÄ± pekiÅŸtirin ve zayÄ±f noktalarÄ±nÄ±zÄ± belirleyin
2. Orta Vadeli: ZayÄ±f alanlarda ek Ã§alÄ±ÅŸma yapÄ±n ve pratik uygulamalar geliÅŸtirin
3. Uzun Vadeli: KapsamlÄ± tekrar ve projeler ile bilginizi pekiÅŸtirin` :
overallPerformance >= 55 ?
`1. KÄ±sa Vadeli: Temel konularÄ± yeniden gÃ¶zden geÃ§irin ve anlayamadÄ±ÄŸÄ±nÄ±z noktalarÄ± belirleyin
2. Orta Vadeli: Daha fazla pratik yapÄ±n, Ã¶rnek problemler Ã§Ã¶zÃ¼n ve grup Ã§alÄ±ÅŸmalarÄ±na katÄ±lÄ±n
3. Uzun Vadeli: Ã‡alÄ±ÅŸma yÃ¶ntemlerinizi geliÅŸtirin ve dÃ¼zenli tekrar programÄ± oluÅŸturun` :
overallPerformance >= 40 ?
`1. KÄ±sa Vadeli: Temel kavramlarÄ± Ã¶ÄŸrenin, ders notlarÄ±nÄ± dÃ¼zenli olarak gÃ¶zden geÃ§irin
2. Orta Vadeli: DÃ¼zenli Ã§alÄ±ÅŸma alÄ±ÅŸkanlÄ±ÄŸÄ± edinin ve Ã¶ÄŸretim Ã¼yesinden destek alÄ±n
3. Uzun Vadeli: Ek destek kaynaklarÄ±ndan yararlanÄ±n ve study grup oluÅŸturun` :
`1. KÄ±sa Vadeli: Dersin temel hedeflerini anlayÄ±n ve eksikliklerinizi tespit edin
2. Orta Vadeli: Birebir rehberlik alÄ±n ve temel konularda yoÄŸunlaÅŸÄ±n
3. Uzun Vadeli: KapsamlÄ± bir Ã§alÄ±ÅŸma planÄ± oluÅŸturun ve dÃ¼zenli takip yapÄ±n`}

Ã–NERÄ°LEN KAYNAKLAR:
==================
- Ders notlarÄ± ve sunumlarÄ±
- Kaynak kitaplar ve referanslar
- Online eÄŸitim platformlarÄ±
- Ã–rnek problemler ve Ã§Ã¶zÃ¼mleri
- Grup Ã§alÄ±ÅŸmasÄ± ve tartÄ±ÅŸma ortamlarÄ±

Ä°LETÄ°ÅÄ°M:
=========
Bu analiz hakkÄ±nda detaylÄ± gÃ¶rÃ¼ÅŸmek isterseniz:
- Ofis saatleri: [Belirtilecek]
- E-posta: ${instructor}
- GÃ¶rÃ¼ÅŸme randevusu: Ã–nceden haber verin

Bu analiz ${new Date().toLocaleDateString('tr-TR')} tarihinde oluÅŸturulmuÅŸtur.

Ä°yi Ã§alÄ±ÅŸmalar,
${instructor}`;

    return { subject, body };
}

/**
 * Bilgi talebi e-postasÄ±
 */
function generateInfoRequestEmail(student, instructor, courseName, courseTerm) {
    const subject = `${courseName} - Gorusme Davet ve Bilgi Talebi`;
    
    const body = `Merhaba ${student.name} ${student.surname},

${courseName} dersi kapsaminda sizinle gorusmek istiyorum.

GORUSME SECENEKLERI:
- Yuz yuze gorusme (ofis saatleri)
- Online gorusme (Teams/Zoom)
- E-posta gorusmesi

GORUSMEK ISTEDIGIM KONULAR:
- Ders performansiniz ve gelisim alanlari
- Anlamakta zorlandiginiz konular
- Calisma yontemleriniz ve oneriler
- Gelecek planlariniz ve kariyer hedefleri

LUTFEN YANITLAYINIZ:
1. Hangi konularda zorlaniyorsunuz?
2. Ek destek almak istediginiz alanlar neler?
3. Gorusme icin uygun gunleriniz?
4. Tercih ettiginiz gorusme sekli?

En kisa surede yanitinizi bekliyorum.

Iyi calismalar,
${instructor}`;

    return { subject, body };
}

/**
 * E-posta modalÄ±nÄ± kapatÄ±r
 */
function closeEmailModal() {
    const modal = document.getElementById('emailTypeModal');
    modal.classList.remove('active');
    
    // Animasyon tamamlandÄ±ktan sonra modal'Ä± gizle
    setTimeout(() => {
        modal.style.display = 'none';
    }, 300);
    
    // DeÄŸiÅŸkenleri temizle
    selectedEmailType = null;
    currentStudentForEmail = null;
    
    // Ã–nizleme bÃ¶lÃ¼mÃ¼nÃ¼ gizle
    document.getElementById('emailPreviewSection').style.display = 'none';
}

/**
 * Modal event listener'larÄ±nÄ± baÅŸlatÄ±r
 */
function initializeEmailModal() {
    // E-posta tÃ¼rÃ¼ kartlarÄ±na tÄ±klama olaylarÄ±
    document.querySelectorAll('.email-type-card').forEach(card => {
        card.addEventListener('click', function() {
            selectEmailType(this.dataset.type);
        });
    });
    
    // Modal butonlarÄ±
    document.getElementById('generateEmailBtn').addEventListener('click', generateEmail);
    document.getElementById('previewEmailBtn').addEventListener('click', previewEmail);
    
    // Modal kapatma olaylarÄ±
    document.querySelectorAll('#emailTypeModal .modern-close').forEach(closeBtn => {
        closeBtn.addEventListener('click', closeEmailModal);
    });
    
    // Modal dÄ±ÅŸÄ±na tÄ±klama ile kapatma
    document.getElementById('emailTypeModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeEmailModal();
        }
    });
}

/**
 * YardÄ±mcÄ± fonksiyonlar
 */
// Bu HTML fonksiyonlarÄ± artÄ±k kullanÄ±lmadÄ±ÄŸÄ± iÃ§in kaldÄ±rÄ±ldÄ± - text tabanlÄ± e-posta kullanÄ±yoruz

// Bu HTML fonksiyonlarÄ± da kaldÄ±rÄ±ldÄ± - text tabanlÄ± e-posta kullanÄ±yoruz

function getInstructorName() {
    return APP_STATE.courseData?.dersIcerik?.dersiVerenOgretimUyesiOgretimGorevlisi || 
           APP_STATE.courseData?.dersBilgisi?.ogretimUyesi || 
           'Ã–ÄŸretim Ãœyesi';
}

function getCourseInfo() {
    return {
        name: APP_STATE.courseData?.dersBilgisi?.dersAdi || 
              APP_STATE.courseData?.dersGenel?.dersAdi || 
              'Ders',
        term: APP_STATE.courseData?.dersBilgisi?.donem || 
              APP_STATE.courseData?.dersGenel?.akademikYil || 
              '2023-2024'
    };
}

/**
 * Yeni modalÄ± kapat
 */
function closeNewEmailModal() {
    const modal = document.getElementById('newEmailModal');
    if (modal) {
        modal.classList.remove('active');
        setTimeout(() => {
            modal.remove();
        }, 300);
    }
    selectedEmailType = null;
}

/**
 * Text formatÄ±nda e-posta gÃ¶nder
 */
function sendTextEmail() {
    if (!selectedEmailType || !currentStudentForEmail) return;
    
    let textContent;
    
    // Her e-posta tÃ¼rÃ¼ iÃ§in Ã¶zel text formatÄ±
    switch (selectedEmailType) {
        case 'survey':
            textContent = generateSurveyTextEmail(currentStudentForEmail);
            break;
        case 'detailed':
            textContent = generateDetailedScoreTextEmail(currentStudentForEmail);
            break;
        case 'analysis':
            textContent = generateAnalysisTextEmail(currentStudentForEmail);
            break;
        case 'info':
            textContent = generateInfoRequestTextEmail(currentStudentForEmail);
            break;
        default:
            showModernToast('âŒ Bilinmeyen e-posta tÃ¼rÃ¼!', 'error');
            return;
    }
    
    // Gmail URL oluÅŸtur
    const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(currentStudentForEmail.email)}&su=${encodeURIComponent(textContent.subject)}&body=${encodeURIComponent(textContent.body)}`;
    
    // Gmail'i aÃ§
    window.open(gmailUrl, '_blank', 'noopener');
    
    // ModalÄ± kapat
    closeNewEmailModal();
    
    // BaÅŸarÄ± mesajÄ± gÃ¶ster
    showModernToast('ğŸ“§ Text formatÄ±nda e-posta Gmail\'de aÃ§Ä±ldÄ±!', 'success');
}

/**
 * Anket e-postasÄ± iÃ§in Ã¶zel text formatÄ±
 */
function generateSurveyTextEmail(student) {
    const instructor = getInstructorName();
    const courseInfo = getCourseInfo();
    const courseName = courseInfo.name;
    const courseTerm = courseInfo.term;
    const courseCode = APP_STATE.courseData?.dersBilgisi?.dersKodu || 'XXX000';
    
    const subject = `${courseName} - Ders Bazinda Ogrenme Ciktilari Anketi`;
    
    const outcomes = APP_STATE.courseData?.dersOgrenmeÃ‡iktilari || [];
    
    let questionSection = '';
    if (outcomes.length > 0) {
        questionSection = `Dersin Kodu / Adi: ${courseCode} / ${courseName}\n\n`;
        questionSection += `OGRENME CIKTILARI DEGERLENDIRME ANKETI\n`;
        questionSection += `${'='.repeat(70)}\n\n`;
        
        outcomes.forEach((outcome, index) => {
            const questionNum = index + 1;
            const fullDescription = outcome.aciklama || outcome.description || 'Tanimlanmamis';
            
            // Soru metni
            questionSection += `${questionNum}. ${fullDescription}\n`;
            
            // Her soru iÃ§in kendi sayÄ±larÄ± ve kutucuklarÄ±
            questionSection += `                                   5   4   3   2   1\n`;
            questionSection += `                                  ( ) ( ) ( ) ( ) ( )\n\n`;
        });
        
        questionSection += `${'='.repeat(70)}\n\n`;
        questionSection += `DEGERLENDIRME SKALASI:\n`;
        questionSection += `5: Kesinlikle Katiliyorum\n`;
        questionSection += `4: Katiliyorum\n`;
        questionSection += `3: Kismen Katiliyorum\n`;
        questionSection += `2: Katilmiyorum\n`;
        questionSection += `1: Kesinlikle Katilmiyorum\n\n`;
    } else {
        questionSection = `UYARI: Bu ders icin ogrenme ciktilari tanimlanmamis.\nLutfen ders sorumlusu ile iletisime geciniz.\n\n`;
    }
    
    const body = `DERS DEGERLENDIRME ANKETI

Recep Tayyip Erdogan Universitesi
Bilgisayar Muhendisligi
Ders Bazinda Ogrenme Ciktilari Anketi

${'='.repeat(70)}

Degerli Recep Tayyip Erdogan Universitesi Bilgisayar Muhendisligi Ogrencileri;

Asagida verilen ders bazinda ogrenme ciktisi anketi bolumumuz lisans 
programinda yer alan derslerin degerlendirilmesi amaci ile hazirlanmistir. 
Ankete yanit verirken lutfen dersin ilgili ogrenme ciktisina katkisini 
degerlendiriniz. Katki orani icin sectiginiz yanita karsilik gelen 
kutucuga isaret koyunuz.

Gosterdiginiz ilgi ve zamaniniz icin cok tesekkur ederiz.

${'='.repeat(70)}

${questionSection}
${'='.repeat(70)}

Bu anket ${new Date().toLocaleDateString('tr-TR')} tarihinde gonderilmistir.

Merhaba ${student.name} ${student.surname},

Lutfen anketi doldurarak bana geri gonderiniz.

Iyi calismalar,
${instructor}`;

    return { subject, body };
}

/**
 * HTML formatÄ±nda e-posta gÃ¶nder
 */
function sendHtmlEmail() {
    if (!selectedEmailType || !currentStudentForEmail) return;
    
    const emailContent = generateEmailByType(selectedEmailType, currentStudentForEmail);
    
    // HTML formatÄ± iÃ§in yeni pencere aÃ§
    openEmailInNewWindow(emailContent, currentStudentForEmail.email);
    
    // ModalÄ± kapat
    closeNewEmailModal();
    
    // BaÅŸarÄ± mesajÄ± gÃ¶ster
    showModernToast('ğŸ¨ HTML formatÄ±nda e-posta hazÄ±rlandÄ±!', 'success');
}

/**
 * DetaylÄ± puan e-postasÄ± iÃ§in text formatÄ±
 */
function generateDetailedScoreTextEmail(student) {
    const instructor = getInstructorName();
    const courseInfo = getCourseInfo();
    const courseName = courseInfo.name;
    const courseTerm = courseInfo.term;
    
    const subject = `${courseName} - Not Bilgisi`;
    
    // Ã–ÄŸrenci verilerini al
    let studentData = APP_STATE.studentData?.find(s => s.studentId === student.studentId);
    if (!studentData) {
        studentData = {
            studentId: student.studentId,
            name: student.name || 'Bilinmeyen',
            surname: student.surname || 'Ã–ÄŸrenci'
        };
    }

    // Ã–ÄŸrenci notlarÄ±nÄ± al
    const allGradesData = APP_STATE.gradesData || APP_STATE.courseData?.ogrenciNotlari || {};
    const studentGrades = allGradesData[studentData.studentId] || {};
    
    // Temel hesaplamalar
    const assessmentTree = APP_STATE.assessmentTree || [];
    const termComponents = assessmentTree.filter(comp => comp.id && comp.id.startsWith('A'));
    const finalComponents = assessmentTree.filter(comp => comp.id && comp.id.startsWith('F'));
    
    let termWeightedSum = 0;
    let termTotalWeight = 0;
    let finalWeightedSum = 0;
    let finalTotalWeight = 0;
    
    // YarÄ±yÄ±l iÃ§i hesaplama
    termComponents.forEach(comp => {
        let grade = studentGrades[comp.id] || 0;
        
        // Alt Ã¶ÄŸeleri kontrol et ve topla
        if (comp.children && comp.children.length > 0) {
            let childrenTotal = 0;
            comp.children.forEach(child => {
                const childGrade = studentGrades[child.id] || 0;
                childrenTotal += parseFloat(childGrade) || 0;
            });
            grade = childrenTotal; // Alt Ã¶ÄŸelerin toplamÄ±nÄ± kullan
        }
        
        const weight = comp.weight || 0;
        termWeightedSum += (grade * weight) / 100;
        termTotalWeight += weight;
    });
    
    // YarÄ±yÄ±l sonu hesaplama
    finalComponents.forEach(comp => {
        let grade = studentGrades[comp.id] || 0;
        
        // Alt Ã¶ÄŸeleri kontrol et ve topla
        if (comp.children && comp.children.length > 0) {
            let childrenTotal = 0;
            comp.children.forEach(child => {
                const childGrade = studentGrades[child.id] || 0;
                childrenTotal += parseFloat(childGrade) || 0;
            });
            grade = childrenTotal; // Alt Ã¶ÄŸelerin toplamÄ±nÄ± kullan
        }
        
        const weight = comp.weight || 0;
        finalWeightedSum += (grade * weight) / 100;
        finalTotalWeight += weight;
    });
    
    const yilIciOrt = termTotalWeight > 0 ? (termWeightedSum * 100 / termTotalWeight) : 0;
    const yilSonuOrt = finalTotalWeight > 0 ? (finalWeightedSum * 100 / finalTotalWeight) : 0;
    const genelOrt = (yilIciOrt * 40 + yilSonuOrt * 60) / 100;
    const harfNotu = calculateLetterGrade(genelOrt);

    const body = `${courseName} - NOT RAPORU

${studentData.name} ${studentData.surname} (${studentData.studentId})
${courseTerm} - ${new Date().toLocaleDateString('tr-TR')}

YARIYIL ICI NOTLAR:
${termComponents.map(comp => {
    let grade = studentGrades[comp.id] || 0;
    
    // Alt Ã¶ÄŸeleri kontrol et ve topla
    if (comp.children && comp.children.length > 0) {
        let childrenTotal = 0;
        comp.children.forEach(child => {
            const childGrade = studentGrades[child.id] || 0;
            childrenTotal += parseFloat(childGrade) || 0;
        });
        grade = childrenTotal; // Alt Ã¶ÄŸelerin toplamÄ±nÄ± kullan
    }
    
    const name = comp.name || comp.ad || comp.id;
    return `${name}: ${grade}/100 (%${comp.weight || 0})`;
}).join('\n')}
Yariyil Ici Ortalama: %${yilIciOrt.toFixed(2)}

YARIYIL SONU NOTLAR:
${finalComponents.map(comp => {
    let grade = studentGrades[comp.id] || 0;
    
    // Alt Ã¶ÄŸeleri kontrol et ve topla
    if (comp.children && comp.children.length > 0) {
        let childrenTotal = 0;
        comp.children.forEach(child => {
            const childGrade = studentGrades[child.id] || 0;
            childrenTotal += parseFloat(childGrade) || 0;
        });
        grade = childrenTotal; // Alt Ã¶ÄŸelerin toplamÄ±nÄ± kullan
    }
    
    const name = comp.name || comp.ad || comp.id;
    return `${name}: ${grade}/100 (%${comp.weight || 0})`;
}).join('\n')}
Yariyil Sonu Ortalama: %${yilSonuOrt.toFixed(2)}

HESAPLAMA:
Yariyil Ici (%40): ${yilIciOrt.toFixed(2)} * 0.4 = ${(yilIciOrt * 0.4).toFixed(2)}
Yariyil Sonu (%60): ${yilSonuOrt.toFixed(2)} * 0.6 = ${(yilSonuOrt * 0.6).toFixed(2)}
GENEL ORTALAMA: %${genelOrt.toFixed(2)}
HARF NOTU: ${harfNotu}
DURUM: ${genelOrt >= 60 ? 'GECTI' : 'KALDI'}

NOT SISTEMI:
AA:90-100, BA:85-89, BB:80-84, CB:75-79, CC:70-74
DC:65-69, DD:60-64, FD:50-59, FF:0-49

Sorulariniz icin: ${instructor}

Iyi calismalar,
${instructor}`;

    return { subject, body };
}

// YardÄ±mcÄ± fonksiyonlar
function calculateOCPerformanceFromText(ocId, studentGrades, assessmentTree) {
    // GerÃ§ek Ã–Ã‡ performans hesaplamasÄ±
    let outcomePerformance = 0;
    let relatedActivities = 0;
    
    // DeÄŸerlendirme aÄŸacÄ±ndan bu Ã¶ÄŸrenme Ã§Ä±ktÄ±sÄ± ile iliÅŸkili aktiviteleri bul
    assessmentTree.forEach(component => {
        if (component.outcomes && component.outcomes.includes(ocId)) {
            const componentGrade = studentGrades[component.id] || 0;
            const componentMax = component.points || 100;
            const componentPerf = componentMax > 0 ? (componentGrade / componentMax) * 100 : 0;
            
            outcomePerformance += componentPerf;
            relatedActivities++;
        }
        
        // Alt Ã¶ÄŸeleri de kontrol et
        if (component.children) {
            component.children.forEach(child => {
                if (child.outcomes && child.outcomes.includes(ocId)) {
                    const childGrade = studentGrades[child.id] || 0;
                    const childMax = child.points || 100;
                    const childPerf = childMax > 0 ? (childGrade / childMax) * 100 : 0;
                    
                    outcomePerformance += childPerf;
                    relatedActivities++;
                }
            });
        }
    });
    
    return relatedActivities > 0 ? (outcomePerformance / relatedActivities) : 0;
}

/**
 * PÃ‡ iliÅŸki gÃ¼cÃ¼ hesaplama fonksiyonu
 */
function calculatePCRelationStrength(pcId, relationMatrix) {
    const relatedRelations = relationMatrix.filter(relation => {
        const relationValue = relation.programÃ‡iktilariIliskileri?.[pcId] || 0;
        return relationValue > 0;
    });
    
    if (relatedRelations.length === 0) return { strength: 0, level: 'Yok' };
    
    let totalStrength = 0;
    relatedRelations.forEach(relation => {
        totalStrength += relation.programÃ‡iktilariIliskileri[pcId];
    });
    
    const avgStrength = totalStrength / relatedRelations.length;
    let level = 'ZayÄ±f';
    if (avgStrength >= 4) level = 'GÃ¼Ã§lÃ¼';
    else if (avgStrength >= 3) level = 'Orta';
    
    return { strength: avgStrength, level: level };
}

function getPerformanceTextLevel(performance) {
    if (performance >= 90) return 'Mukemmel';
    else if (performance >= 80) return 'Cok Iyi';
    else if (performance >= 70) return 'Iyi';
    else if (performance >= 60) return 'Orta';
    else if (performance >= 50) return 'Zayif';
    else return 'Yetersiz';
}

/**
 * Ã–Ã‡-PÃ‡ Analiz e-postasÄ± iÃ§in text formatÄ±
 */
function generateAnalysisTextEmail(student) {
    const instructor = getInstructorName();
    const courseInfo = getCourseInfo();
    const courseName = courseInfo.name;
    const courseTerm = courseInfo.term;
    
    const subject = `${courseName} - OC-PC Analizi`;
    
    // Ã–ÄŸrenci verilerini al
    let studentData = APP_STATE.studentData?.find(s => s.studentId === student.studentId);
    if (!studentData) {
        studentData = {
            studentId: student.studentId,
            name: student.name || 'Bilinmeyen',
            surname: student.surname || 'Ã–ÄŸrenci'
        };
    }

    // Temel veriler
    const outcomes = APP_STATE.courseData?.dersOgrenmeÃ‡iktilari || [];
    const programOutcomes = APP_STATE.courseData?.programCiktilari || [];
    const assessmentTree = APP_STATE.assessmentTree || [];
    const studentGrades = APP_STATE.gradesData?.[studentData.studentId] || {};
    const relationMatrix = APP_STATE.courseData?.programVeOgrenmeIliskisi?.iliskiTablosu || [];
    
    // GerÃ§ek Ã–Ã‡ performans hesabÄ±
    const totalOC = outcomes.length;
    const totalPC = programOutcomes.length;
    let totalOCPerformance = 0;
    let validOCCount = 0;
    
    // GerÃ§ek Ã–Ã‡ hesaplamalarÄ±
    const ocResults = outcomes.slice(0, 4).map(oc => {
        const performance = calculateOCPerformanceFromText(oc.id, studentGrades, assessmentTree);
        totalOCPerformance += performance;
        if (performance > 0) validOCCount++;
        return `${oc.id}: %${performance.toFixed(2)}`;
    }).join('\n');
    
    // GerÃ§ek PÃ‡ hesaplamalarÄ±
    let strongRelations = 0;
    let moderateRelations = 0;
    programOutcomes.forEach(pc => {
        const relation = calculatePCRelationStrength(pc.id, relationMatrix);
        if (relation.level === 'GÃ¼Ã§lÃ¼') strongRelations++;
        else if (relation.level === 'Orta') moderateRelations++;
    });
    
    // Genel performans
    const avgPerformance = validOCCount > 0 ? totalOCPerformance / validOCCount : 0;

    const body = `${courseName} - OC-PC ANALIZI

${studentData.name} ${studentData.surname} (${studentData.studentId})
${courseTerm} - ${new Date().toLocaleDateString('tr-TR')}

OGRENME CIKTILARI (OC):
${ocResults}
${totalOC > 4 ? `... ve ${totalOC - 4} tane daha` : ''}

PROGRAM CIKTILARI (PC):
Iliskili PC Sayisi: ${totalPC}
Guclu Iliski: ${strongRelations}
Orta Iliski: ${moderateRelations}

GENEL PERFORMANS:
OC Ortalamasi: %${avgPerformance.toFixed(2)}
Degerlendirme: ${avgPerformance >= 80 ? 'Cok Iyi' : avgPerformance >= 70 ? 'Iyi' : avgPerformance >= 60 ? 'Orta' : 'Zayif'}

MUDEK DEGERLENDIRME:
OC Basari Orani: %${validOCCount > 0 ? (validOCCount / totalOC * 100).toFixed(2) : '0.0'}
PC Iliski Orani: %${totalPC > 0 ? ((strongRelations + moderateRelations) / totalPC * 100).toFixed(2) : '0.0'}

${avgPerformance >= 80 ? 
'ONERI: Mevcut performansinizi koruun ve surdurun' :
avgPerformance >= 70 ? 
'ONERI: Zayif alanlarda gelisim plani yapin' : 
'ONERI: Temel yetkinliklere odaklanin'}

Detayli analiz icin: ${instructor}

Iyi calismalar,
${instructor}`;

    return { subject, body };
}

/**
 * Bilgi talebi e-postasÄ± iÃ§in text formatÄ±
 */
function generateInfoRequestTextEmail(student) {
    const instructor = getInstructorName();
    const courseInfo = getCourseInfo();
    const courseName = courseInfo.name;
    
    const subject = `${courseName} - Gorusme Talebi`;
    
    const body = `${courseName} - GORUSME TALEBI

Merhaba ${student.name} ${student.surname},

${courseName} dersi hakkinda sizinle gorusmek istiyorum.

GORUSME KONULARI:
- Ders performansiniz
- Zorluklar ve destekler
- Calisma onerileri
- Gelecek planlariniz

YANITLAYINIZ:
1. Hangi konularda zorlaniyorsunuz?
2. Ne konuda destek istersiniz?
3. Gorusme icin uygun gun?
4. Tercih: Yuz yuze / Online?

Yanitinizi bekliyorum.

Iyi calismalar,
${instructor}`;

    return { subject, body };
}

/**
 * Harf notu hesaplama yardÄ±mcÄ± fonksiyonu
 */
function calculateLetterGrade(score) {
    if (score >= 90) return 'AA';
    if (score >= 85) return 'BA';
    if (score >= 80) return 'BB';
    if (score >= 75) return 'CB';
    if (score >= 70) return 'CC';
    if (score >= 65) return 'DC';
    if (score >= 60) return 'DD';
    if (score >= 50) return 'FD';
    return 'FF';
}

/**
 * Modern Test Operations - V2 Card System
 */
function initializeModernTestOperations() {
    console.log('ğŸ”§ Modern Test Operations baÅŸlatÄ±lÄ±yor...');
    
    // Slider deÄŸer gÃ¼ncellemeleri
    initializeModernSliders();
    
    // Dual Range Slider sistemi
    initializeModernDualRange();
    
    // AkÄ±llÄ± puanlama sistemi
    initializeModernScoring();
    
    // Ä°statistik gÃ¼ncellemeleri
    updateModernStats();
}

/**
 * Modern slider'larÄ± baÅŸlat
 */
function initializeModernSliders() {
    // YarÄ±yÄ±l Ä°Ã§i Etkinlik SayÄ±sÄ± Slider
    const termActivitySlider = document.getElementById('termActivityCountSlider');
    const termActivityValue = document.getElementById('termActivityCountValue');
    
    if (termActivitySlider && termActivityValue) {
        termActivitySlider.addEventListener('input', function() {
            termActivityValue.textContent = this.value;
        });
    }
    
    // YarÄ±yÄ±l Ä°Ã§i Soru/Rubrik SayÄ±sÄ± Slider
    const termSlider = document.getElementById('termComponentsSlider');
    const termValue = document.getElementById('termComponentsValue');
    
    if (termSlider && termValue) {
        termSlider.addEventListener('input', function() {
            termValue.textContent = this.value;
        });
    }
    
    // YarÄ±yÄ±l Sonu Etkinlik SayÄ±sÄ± Slider
    const finalActivitySlider = document.getElementById('finalActivityCountSlider');
    const finalActivityValue = document.getElementById('finalActivityCountValue');
    
    if (finalActivitySlider && finalActivityValue) {
        finalActivitySlider.addEventListener('input', function() {
            finalActivityValue.textContent = this.value;
        });
    }
    
    // YarÄ±yÄ±l Sonu Soru/Rubrik SayÄ±sÄ± Slider
    const finalSlider = document.getElementById('finalComponentsSlider');
    const finalValue = document.getElementById('finalComponentsValue');
    
    if (finalSlider && finalValue) {
        finalSlider.addEventListener('input', function() {
            finalValue.textContent = this.value;
        });
    }
}

/**
 * Modern Dual Range Slider sistemi
 */
function initializeModernDualRange() {
    const minSlider = document.getElementById('groupMinSlider');
    const maxSlider = document.getElementById('groupMaxSlider');
    const minValue = document.getElementById('groupMinValue');
    const maxValue = document.getElementById('groupMaxValue');
    
    if (!minSlider || !maxSlider || !minValue || !maxValue) return;
    
    function updateValues() {
        let minVal = parseInt(minSlider.value);
        let maxVal = parseInt(maxSlider.value);
        
        // Min deÄŸer max deÄŸerden bÃ¼yÃ¼k olamaz
        if (minVal > maxVal) {
            minVal = maxVal;
            minSlider.value = minVal;
        }
        
        // Max deÄŸer min deÄŸerden kÃ¼Ã§Ã¼k olamaz
        if (maxVal < minVal) {
            maxVal = minVal;
            maxSlider.value = maxVal;
        }
        
        minValue.textContent = minVal;
        maxValue.textContent = maxVal;
        
        // Ä°statistikleri gÃ¼ncelle
        updateModernStats();
    }
    
    minSlider.addEventListener('input', updateValues);
    maxSlider.addEventListener('input', updateValues);
    
    // Ä°lk deÄŸerleri ayarla
    updateValues();
}

/**
 * Modern Scoring sistemi
 */
function initializeModernScoring() {
    const passRateSlider = document.getElementById('passRateSlider');
    const passRateValue = document.getElementById('passRateValue');
    
    if (!passRateSlider || !passRateValue) return;
    
    passRateSlider.addEventListener('input', function() {
        const value = parseInt(this.value);
        passRateValue.textContent = value + '%';
        
        // Pass/Fail hesaplamalarÄ±nÄ± gÃ¼ncelle
        updatePassFailCounts();
    });
    
    // Ä°lk deÄŸeri ayarla
    passRateValue.textContent = passRateSlider.value + '%';
    updatePassFailCounts();
    
    // Grup slider'larÄ±nÄ±n sÄ±nÄ±rlarÄ±nÄ± baÅŸlangÄ±Ã§ta ayarla
    updateGroupSliderLimits();
}

/**
 * Pass/Fail sayÄ±larÄ±nÄ± gÃ¼ncelle
 */
function updatePassFailCounts() {
    console.log('ğŸ” updatePassFailCounts Ã§aÄŸrÄ±ldÄ±');
    
    const passRateSlider = document.getElementById('passRateSlider');
    const passStudentCount = document.getElementById('passStudentCount');
    const failStudentCount = document.getElementById('failStudentCount');
    const passRateDisplay = document.getElementById('passRateDisplay');
    const failRateDisplay = document.getElementById('failRateDisplay');
    const studentCountDisplay = document.getElementById('studentCountDisplay');
    const groupCountDisplay = document.getElementById('groupCountDisplay');
    
    console.log('ğŸ” DOM elementleri:', {
        passRateSlider: !!passRateSlider,
        passStudentCount: !!passStudentCount,
        failStudentCount: !!failStudentCount,
        passRateDisplay: !!passRateDisplay,
        failRateDisplay: !!failRateDisplay,
        studentCountDisplay: !!studentCountDisplay,
        groupCountDisplay: !!groupCountDisplay
    });
    
    if (!passRateSlider || !passStudentCount || !failStudentCount) {
        console.warn('âš ï¸ Gerekli DOM elementleri bulunamadÄ±');
        return;
    }
    
    // GerÃ§ek Ã¶ÄŸrenci sayÄ±sÄ±nÄ± al
    const totalStudents = getTotalStudentCount();
    const passRate = parseInt(passRateSlider.value);
    const failRate = 100 - passRate;
    
    console.log('ğŸ” Veriler:', {
        totalStudents,
        passRate,
        failRate,
        studentDataLength: APP_STATE.studentData?.length || 0,
        appStateStudentData: !!APP_STATE.studentData
    });
    
    // GerÃ§ek not verilerini kontrol et
    let actualPassCount = 0;
    let actualFailCount = 0;
    let hasActualGrades = false;
    
    if (totalStudents > 0 && APP_STATE.gradesData) {
        APP_STATE.studentData.forEach(student => {
            const studentGrades = APP_STATE.gradesData[student.studentId];
            if (studentGrades && studentGrades.harfNotu) {
                hasActualGrades = true;
                const letterGrade = studentGrades.harfNotu;
                // AA, BA, BB, CB, CC, DC = geÃ§er, DD, FD, FF = kalÄ±r
                const passingGrades = ['AA', 'BA', 'BB', 'CB', 'CC', 'DC'];
                if (passingGrades.includes(letterGrade)) {
                    actualPassCount++;
                } else {
                    actualFailCount++;
                }
            }
        });
    }
    
    // Hesaplanan veya gerÃ§ek sayÄ±larÄ± kullan
    let displayPassCount, displayFailCount;
    let displayPassRate, displayFailRate;
    
    if (hasActualGrades && (actualPassCount > 0 || actualFailCount > 0)) {
        // GerÃ§ek not verileri varsa onlarÄ± kullan
        displayPassCount = actualPassCount;
        displayFailCount = actualFailCount;
        displayPassRate = Math.round((actualPassCount / totalStudents) * 100);
        displayFailRate = Math.round((actualFailCount / totalStudents) * 100);
        console.log('ğŸ“Š GerÃ§ek not verileri kullanÄ±lÄ±yor');
    } else {
        // Tahmini hesaplama yap
        displayPassCount = Math.round(totalStudents * passRate / 100);
        displayFailCount = totalStudents - displayPassCount;
        displayPassRate = passRate;
        displayFailRate = failRate;
        console.log('ğŸ“Š Tahmini hesaplama kullanÄ±lÄ±yor');
    }
    
    // Status badge'lerdeki Ã¶ÄŸrenci sayÄ±larÄ±nÄ± gÃ¼ncelle
    passStudentCount.textContent = displayPassCount;
    failStudentCount.textContent = displayFailCount;
    
    // Oran gÃ¶sterimlerini gÃ¼ncelle
    if (passRateDisplay) {
        passRateDisplay.textContent = `${displayPassRate}%`;
    }
    
    if (failRateDisplay) {
        failRateDisplay.textContent = `${displayFailRate}%`;
    }
    
    // Toplam Ã¶ÄŸrenci sayÄ±sÄ±nÄ± gÃ¼ncelle
    if (studentCountDisplay) {
        studentCountDisplay.textContent = totalStudents;
        console.log('âœ… studentCountDisplay gÃ¼ncellendi:', totalStudents);
    } else {
        console.warn('âš ï¸ studentCountDisplay elementi bulunamadÄ±');
    }
    
    // Grup bilgisi artÄ±k kategori detaylarÄ±nda gÃ¶steriliyor
    
    console.log(`ğŸ¯ Ä°statistikler gÃ¼ncellendi: Toplam ${totalStudents} Ã¶ÄŸrenci, GeÃ§ecek ${displayPassCount} (%${displayPassRate}), Kalacak ${displayFailCount} (%${displayFailRate})`);
}

/**
 * Modern istatistikleri gÃ¼ncelle
 */
function updateModernStats() {
    const totalStudentsCount = document.getElementById('totalStudentsCount');
    const activeGroupsCount = document.getElementById('activeGroupsCount');
    
    if (totalStudentsCount) {
        totalStudentsCount.textContent = getTotalStudentCount();
    }
    
    if (activeGroupsCount) {
        activeGroupsCount.textContent = getActiveGroupsCount();
    }
}

/**
 * Toplam Ã¶ÄŸrenci sayÄ±sÄ±nÄ± al
 */
function getTotalStudentCount() {
    if (APP_STATE.studentData && APP_STATE.studentData.length > 0) {
        return APP_STATE.studentData.length;
    }
    return 0;
}

/**
 * Ana bileÅŸen bazlÄ± grup sayÄ±sÄ± bilgisini al - Sadece ana etkinlikleri gÃ¶ster (A1, A2, F1...)
 */
function getActiveGroupsCount() {
    try {
        // courseData.grupHaritalari'ndan sadece ana bileÅŸenlerin grup sayÄ±larÄ±nÄ± al
        if (APP_STATE.courseData && APP_STATE.courseData.grupHaritalari) {
            const mainComponentGroupCounts = [];
            
            Object.keys(APP_STATE.courseData.grupHaritalari).forEach(componentId => {
                // Sadece ana bileÅŸenleri al (A1, A2, F1... - alt sorular deÄŸil A1.1, A1.2...)
                if (componentId.match(/^[AF]\d+$/) && !componentId.includes('.')) {
                    const component = APP_STATE.courseData.grupHaritalari[componentId];
                    if (component && component.gruplar && Array.isArray(component.gruplar)) {
                        // Sadece geÃ§erli gruplarÄ± say
                        const validGroups = component.gruplar.filter(group => 
                            group && group.length === 1 && /^[A-Z]$/.test(group)
                        );
                        
                        if (validGroups.length > 0) {
                            mainComponentGroupCounts.push({
                                id: componentId,
                                name: componentId,
                                count: validGroups.length
                            });
                        }
                    }
                }
            });
            
            console.log('ğŸ” Ana bileÅŸen grup sayÄ±larÄ±:', mainComponentGroupCounts);
            
            if (mainComponentGroupCounts.length > 0) {
                // EÄŸer tÃ¼m bileÅŸenler aynÄ± grup sayÄ±sÄ±na sahipse kÄ±sa format
                const allCounts = mainComponentGroupCounts.map(comp => comp.count);
                const uniqueCounts = [...new Set(allCounts)];
                
                if (uniqueCounts.length === 1) {
                    // TÃ¼m bileÅŸenler aynÄ± grup sayÄ±sÄ±na sahip
                    const groupCount = uniqueCounts[0];
                    return `${mainComponentGroupCounts.length} bileÅŸen Ã— ${groupCount} grup`;
                } else {
                    // FarklÄ± grup sayÄ±larÄ± var, detaylÄ± gÃ¶ster
                    return mainComponentGroupCounts.map(comp => `${comp.name}:${comp.count}`).join(', ');
                }
            }
        }
        
        // Fallback: Ã–ÄŸrenci verilerinden tek grup sayÄ±sÄ±
        if (APP_STATE.studentData && APP_STATE.studentData.length > 0) {
            const uniqueGroups = new Set();
            APP_STATE.studentData.forEach(student => {
                if (student.grup && student.grup.length === 1 && /^[A-Z]$/.test(student.grup)) {
                    uniqueGroups.add(student.grup);
                }
            });
            
            if (uniqueGroups.size > 0) {
                return `${uniqueGroups.size} grup (tÃ¼m bileÅŸenler)`;
            }
    }
    
        // Son Ã§are: VarsayÄ±lan
        console.log('ğŸ” HiÃ§ grup bulunamadÄ±, varsayÄ±lan dÃ¶ndÃ¼rÃ¼lÃ¼yor');
        return '1 grup';
        
    } catch (error) {
        console.error('âŒ getActiveGroupsCount hatasÄ±:', error);
        return 'Hata';
    }
}

/**
 * Grup detaylarÄ± tooltip'ini gÃ¼ncelle
 */
function updateGroupDetailsTooltip() {
    try {
        const groupDetailsContent = document.getElementById('groupDetailsContent');
        if (!groupDetailsContent) return;
        
        let html = '';
        
        // courseData.grupHaritalari'ndan sadece ana bileÅŸenlerin detaylÄ± grup bilgilerini al
    if (APP_STATE.courseData && APP_STATE.courseData.grupHaritalari) {
            const componentDetails = [];
            
            Object.keys(APP_STATE.courseData.grupHaritalari).forEach(componentId => {
                // Sadece ana bileÅŸenleri al (A1, A2, F1... - alt sorular deÄŸil A1.1, A1.2...)
                if (componentId.match(/^[AF]\d+$/) && !componentId.includes('.')) {
                    const component = APP_STATE.courseData.grupHaritalari[componentId];
                    if (component && component.gruplar && Array.isArray(component.gruplar)) {
                        // BileÅŸen adÄ±nÄ± al ve formatla
                        const activityNode = APP_STATE.assessmentTree?.find(node => node.id === componentId);
                        let componentName = componentId;
                        
                        if (activityNode) {
                            // Emoji'yi belirle
                            let emoji = 'ğŸ“';
                            if (activityNode.type.includes('Ev Ã–devi') || activityNode.type.includes('Ã–dev')) emoji = 'ğŸ“š';
                            else if (activityNode.type.includes('Laboratuvar') || activityNode.type.includes('Lab')) emoji = 'âš—ï¸';
                            else if (activityNode.type.includes('Final')) emoji = 'ğŸ¯';
                            else if (activityNode.type.includes('Quiz')) emoji = 'â“';
                            else if (activityNode.type.includes('Proje')) emoji = 'ğŸš€';
                            else if (activityNode.type.includes('Rapor')) emoji = 'ğŸ“Š';
                            else if (activityNode.type.includes('Sunum')) emoji = 'ğŸ¤';
                            
                            // Alt bileÅŸen sayÄ±sÄ±nÄ± hesapla
                            const subComponentCount = activityNode.children ? activityNode.children.length : 0;
                            let subComponentText = '';
                            
                            if (subComponentCount > 0) {
                                // Alt bileÅŸenlerin tipini belirle
                                const firstChild = activityNode.children[0];
                                if (firstChild.type === 'Soru' || firstChild.type.includes('Soru')) {
                                    subComponentText = ` (${subComponentCount} Soru)`;
                                } else if (firstChild.type === 'Rubrik' || firstChild.type.includes('Rubrik')) {
                                    subComponentText = ` (${subComponentCount} Rubrik)`;
                                } else {
                                    subComponentText = ` (${subComponentCount} BileÅŸen)`;
                                }
                            } else {
                                subComponentText = ' (BoÅŸ)';
                            }
                            
                            // AÄŸÄ±rlÄ±k bilgisini al
                            const weight = activityNode.weight || 0;
                            
                            componentName = `${emoji} ${activityNode.name} %${weight}${subComponentText}`;
                        }
                        
                        // Sadece geÃ§erli gruplarÄ± say
                        const validGroups = component.gruplar.filter(group => 
                            group && group.length === 1 && /^[A-Z]$/.test(group)
                        );
                        
                        if (validGroups.length > 0) {
                            componentDetails.push({
                                name: componentName,
                                gruplar: validGroups,
                                count: validGroups.length
                            });
                        }
                    }
                }
            });
            
            if (componentDetails.length > 0) {
                // BileÅŸen bazlÄ± grup detaylarÄ±
                componentDetails.forEach(detail => {
                    html += `
                        <div class="group-detail-item">
                            <div class="group-detail-name">${detail.name}</div>
                            <div>
                                <span class="group-detail-groups">${detail.gruplar.join(', ')}</span>
                                <span class="group-count-badge">${detail.count}</span>
                            </div>
                        </div>
                    `;
                });
                
                                 // BileÅŸen sayÄ±sÄ± ve grup daÄŸÄ±lÄ±mÄ± Ã¶zeti
                 const totalComponents = componentDetails.length;
                 const groupCounts = componentDetails.map(detail => detail.count);
                 const minGroups = Math.min(...groupCounts);
                 const maxGroups = Math.max(...groupCounts);
                 
                 html += `
                     <div class="group-detail-item" style="border-top: 2px solid #e9ecef; margin-top: 8px; padding-top: 8px; font-weight: 600;">
                         <div class="group-detail-name">ğŸ“Š BileÅŸen Ã–zeti</div>
                         <div>
                             <span class="group-detail-groups">${totalComponents} bileÅŸen, ${minGroups === maxGroups ? minGroups : `${minGroups}-${maxGroups}`} grup/bileÅŸen</span>
                             <span class="group-count-badge" style="background: #4caf50; color: white;">${totalComponents}</span>
                         </div>
                     </div>
                 `;
            } else {
                html = '<div class="group-detail-item"><div class="group-detail-name">HenÃ¼z grup tanÄ±mlanmamÄ±ÅŸ</div></div>';
            }
        } else {
            html = '<div class="group-detail-item"><div class="group-detail-name">Grup verisi bulunamadÄ±</div></div>';
        }
        
        groupDetailsContent.innerHTML = html;
        
    } catch (error) {
        console.error('âŒ updateGroupDetailsTooltip hatasÄ±:', error);
    }
}

/**
 * AkÄ±llÄ± puan daÄŸÄ±lÄ±mÄ± - 100 puan garantisi
 */
function distributePointsIntelligently(componentCount, totalPoints = 100) {
    if (componentCount <= 0) return [];
    
    // Temel puan daÄŸÄ±lÄ±mÄ±
    const basePoints = Math.floor(totalPoints / componentCount);
    const remainder = totalPoints % componentCount;
    
    const points = new Array(componentCount).fill(basePoints);
    
    // Kalan puanlarÄ± daÄŸÄ±t
    for (let i = 0; i < remainder; i++) {
        points[i]++;
    }
    
    // Toplam kontrolÃ¼
    const actualTotal = points.reduce((sum, point) => sum + point, 0);
    if (actualTotal !== totalPoints) {
        // Son elemana farkÄ± ekle/Ã§Ä±kar
        points[points.length - 1] += (totalPoints - actualTotal);
    }
    
    return points;
}

/**
 * Etkinlik aÄŸÄ±rlÄ±klarÄ±nÄ± otomatik oranla
 */
function autoBalanceActivityWeights() {
    const termActivities = getActivitiesByType('term');
    const finalActivities = getActivitiesByType('final');
    
    // YarÄ±yÄ±l iÃ§i aÄŸÄ±rlÄ±klarÄ± oranla (40%)
    if (termActivities.length > 0) {
        const termWeights = distributePointsIntelligently(termActivities.length, 40);
        termActivities.forEach((activity, index) => {
            if (activity.weightElement) {
                activity.weightElement.value = termWeights[index];
            }
        });
    }
    
    // YarÄ±yÄ±l sonu aÄŸÄ±rlÄ±klarÄ± oranla (60%)
    if (finalActivities.length > 0) {
        const finalWeights = distributePointsIntelligently(finalActivities.length, 60);
        finalActivities.forEach((activity, index) => {
            if (activity.weightElement) {
                activity.weightElement.value = finalWeights[index];
            }
        });
    }
    
    // Kategori aÄŸÄ±rlÄ±klarÄ±nÄ± gÃ¼ncelle
    updateCategoryWeights();
}

/**
 * Modern Test Operations Event Listeners
 */
function initializeModernEventListeners() {
    // YarÄ±yÄ±l Ä°Ã§i DeÄŸerlendirme OluÅŸtur - ArtÄ±k Ã§oklu fonksiyon kullanÄ±yor
    const btnTermAssessment = document.getElementById('btnGenerateRandomTermAssessment');
    if (btnTermAssessment) {
        btnTermAssessment.addEventListener('click', function() {
            generateMultipleRandomTermAssessments();
        });
    }
    
    // YarÄ±yÄ±l Sonu DeÄŸerlendirme OluÅŸtur - ArtÄ±k Ã§oklu fonksiyon kullanÄ±yor
    const btnFinalAssessment = document.getElementById('btnGenerateRandomFinalAssessment');
    if (btnFinalAssessment) {
        btnFinalAssessment.addEventListener('click', function() {
            generateMultipleRandomFinalAssessments();
        });
    }
    
    // Test Ã–ÄŸrencileri OluÅŸtur
    const btnTestStudents = document.getElementById('btnGenerateTestStudents');
    if (btnTestStudents) {
        btnTestStudents.addEventListener('click', generateTestStudents);
    }
    
    // Test Ders Verisi OluÅŸtur
    const btnTestCourse = document.getElementById('btnGenerateTestCourseData');
    if (btnTestCourse) {
        btnTestCourse.addEventListener('click', generateTestCourseData);
    }
    
    // Rastgele Gruplar OluÅŸtur
    const btnRandomGroups = document.getElementById('btnGenerateRandomGroups');
    if (btnRandomGroups) {
        btnRandomGroups.addEventListener('click', function() {
            const minGroups = parseInt(document.getElementById('groupMinSlider').value);
            const maxGroups = parseInt(document.getElementById('groupMaxSlider').value);
            generateRandomGroupsInRange(minGroups, maxGroups);
        });
    }
    
    // AkÄ±llÄ± Puanlama Uygula
    const btnSmartScoring = document.getElementById('btnGenerateRandomScores');
    if (btnSmartScoring) {
        btnSmartScoring.addEventListener('click', function() {
            const passRate = parseInt(document.getElementById('passRateSlider').value);
            generateIntelligentScores(passRate);
        });
    }
    
    // Temizleme ButonlarÄ± - DUPLICATE EVENT LISTENER SORUNU Ã‡Ã–ZÃœLDÃœ
    // Bu event listener'lar testButtons forEach dÃ¶ngÃ¼sÃ¼ ile zaten ekleniyor
    // Bu nedenle buradaki duplicate listener'larÄ± kaldÄ±rÄ±yoruz
    console.log("â„¹ï¸ Temizleme butonlarÄ± event listener'larÄ± testButtons dÃ¶ngÃ¼sÃ¼ ile yÃ¶netiliyor");
    
    const btnTestToast = document.getElementById('btnTestToast');
    if (btnTestToast) {
        btnTestToast.addEventListener('click', testToastSystem);
    }
}

/**
 * Rastgele gruplar aralÄ±k iÃ§inde oluÅŸtur
 */
/**
 * Grup slider'larÄ±nÄ±n maksimum deÄŸerlerini Ã¶ÄŸrenci sayÄ±sÄ±na gÃ¶re gÃ¼ncelleme
 */
function updateGroupSliderLimits() {
    const studentCount = APP_STATE.studentData ? APP_STATE.studentData.length : 0;
    const minSlider = document.getElementById('groupMinSlider');
    const maxSlider = document.getElementById('groupMaxSlider');
    
    let maxAllowedGroups;
    
    if (studentCount === 0) {
        // Ã–ÄŸrenci yoksa test amaÃ§lÄ± 20 grup'a kadar izin ver
        maxAllowedGroups = 20;
        console.log(`ğŸ¯ Grup slider'larÄ± test modunda - Ã–ÄŸrenci yok, 20 grup'a kadar izin veriliyor`);
    } else {
        // Ã–ÄŸrenci varsa Ã¶ÄŸrenci sayÄ±sÄ± ile sÄ±nÄ±rla (minimum 20 grup)
        maxAllowedGroups = Math.max(studentCount, 20); // En az 20, Ã¶ÄŸrenci sayÄ±sÄ± daha fazlaysa o kadar
        
        if (studentCount < 20) {
            console.log(`ğŸ¯ Grup slider'larÄ± gÃ¼ncellendi - Ã–ÄŸrenci sayÄ±sÄ±: ${studentCount}, Max grup: ${studentCount} (boÅŸ grup Ã¶nleme)`);
        } else {
            console.log(`ğŸ¯ Grup slider'larÄ± gÃ¼ncellendi - Ã–ÄŸrenci sayÄ±sÄ±: ${studentCount}, Max grup: ${maxAllowedGroups}`);
        }
    }
        
        if (minSlider) {
            minSlider.max = maxAllowedGroups;
            // EÄŸer mevcut deÄŸer sÄ±nÄ±rÄ± aÅŸÄ±yorsa dÃ¼ÅŸÃ¼r
            if (parseInt(minSlider.value) > maxAllowedGroups) {
                minSlider.value = maxAllowedGroups;
                const minValueDisplay = document.getElementById('groupMinValue');
                if (minValueDisplay) minValueDisplay.textContent = maxAllowedGroups;
            }
        }
        
        if (maxSlider) {
            maxSlider.max = maxAllowedGroups;
            // EÄŸer mevcut deÄŸer sÄ±nÄ±rÄ± aÅŸÄ±yorsa dÃ¼ÅŸÃ¼r
            if (parseInt(maxSlider.value) > maxAllowedGroups) {
                maxSlider.value = maxAllowedGroups;
                const maxValueDisplay = document.getElementById('groupMaxValue');
                if (maxValueDisplay) maxValueDisplay.textContent = maxAllowedGroups;
            }
    }
}

function generateRandomGroupsInRange(minGroups, maxGroups) {
    if (!APP_STATE.studentData || APP_STATE.studentData.length === 0) {
        showModernToast('Ã–nce Ã¶ÄŸrenci verileri oluÅŸturun!', 'warning');
        return;
    }
    
    const studentCount = APP_STATE.studentData.length;
    
    // UYARI: Ã–ÄŸrenci sayÄ±sÄ±ndan fazla grup oluÅŸturma kontrolÃ¼
    if (minGroups > studentCount) {
        showModernToast(`âš ï¸ UyarÄ±: Minimum grup sayÄ±sÄ± (${minGroups}) Ã¶ÄŸrenci sayÄ±sÄ±ndan (${studentCount}) fazla! BoÅŸ gruplar oluÅŸmasÄ±n diye maksimum ${studentCount} grup oluÅŸturulabilir.`, "warning");
        return;
    }
    
    if (maxGroups > studentCount) {
        showModernToast(`âš ï¸ UyarÄ±: Maksimum grup sayÄ±sÄ± (${maxGroups}) Ã¶ÄŸrenci sayÄ±sÄ±ndan (${studentCount}) fazla! BoÅŸ gruplar oluÅŸmasÄ±n diye en fazla ${studentCount} grup oluÅŸturulabilir.`, "warning");
        // Maksimum grup sayÄ±sÄ±nÄ± Ã¶ÄŸrenci sayÄ±sÄ± ile sÄ±nÄ±rla
        maxGroups = Math.min(maxGroups, studentCount);
    }
    
    const actualGroupCount = Math.floor(Math.random() * (maxGroups - minGroups + 1)) + minGroups;
    generateRandomGroups();
    
    showModernToast(`Rastgele grup oluÅŸturma tamamlandÄ±! ${actualGroupCount} grup oluÅŸturuldu.`, 'success');
    updateModernStats();
}

/**
 * AkÄ±llÄ± puanlama sistemi
 */
/**
 * AkÄ±llÄ± puanlama sistemi (Onay ile)
 */
function generateIntelligentScores(targetPassRate) {
    // Mevcut verileri kontrol et
    const hasStudents = APP_STATE.studentData && APP_STATE.studentData.length > 0;
    const hasAssessments = APP_STATE.assessmentTree && APP_STATE.assessmentTree.length > 0;
    
    // Mevcut puanlarÄ± daha hassas kontrol et
    let hasExistingScores = false;
    let existingScoreCount = 0;
    
    // gradesData kontrolÃ¼ - sadece gerÃ§ek veri varsa
    if (APP_STATE.gradesData && Object.keys(APP_STATE.gradesData).length > 0) {
        for (const studentId in APP_STATE.gradesData) {
            if (APP_STATE.gradesData[studentId] && Object.keys(APP_STATE.gradesData[studentId]).length > 0) {
                hasExistingScores = true;
                existingScoreCount += Object.keys(APP_STATE.gradesData[studentId]).length;
            }
        }
    }
    
    // testScores kontrolÃ¼
    if (APP_STATE.testScores && Object.keys(APP_STATE.testScores).length > 0) {
        hasExistingScores = true;
        existingScoreCount += Object.keys(APP_STATE.testScores).length;
    }
    
    console.log('ğŸ” hasExistingScores kontrolÃ¼:', {
        hasExistingScores,
        existingScoreCount,
        gradesDataKeys: Object.keys(APP_STATE.gradesData || {}),
        testScoresKeys: Object.keys(APP_STATE.testScores || {})
    });
    
    if (!hasStudents) {
        showModernToast('Ã–nce Ã¶ÄŸrenci verileri oluÅŸturun!', 'warning');
        return;
    }
    
    if (!hasAssessments) {
        showModernToast('Ã–nce deÄŸerlendirme bileÅŸenleri oluÅŸturun!', 'warning');
        return;
    }
    
    // targetPassRate parametresi yoksa slider'dan al
    if (targetPassRate === undefined) {
        const passRateSlider = document.getElementById('passRateSlider');
        targetPassRate = passRateSlider ? parseInt(passRateSlider.value) : 70;
    }
    
    const studentCount = APP_STATE.studentData.length;
    const assessmentCount = APP_STATE.assessmentTree.length;
    const passCount = Math.round(studentCount * targetPassRate / 100);
    const failCount = studentCount - passCount;
    
    let warningMessage = '';
    
    if (hasExistingScores) {
        const existingScoreCount = Object.keys(APP_STATE.gradesData || {}).length + Object.keys(APP_STATE.testScores || {}).length;
        warningMessage = `Mevcut not verileri silinecek ve yeniden oluÅŸturulacak!\n\n${studentCount} Ã¶ÄŸrenci iÃ§in ${assessmentCount} deÄŸerlendirme bileÅŸeninde %${targetPassRate} geÃ§me oranÄ±na gÃ¶re akÄ±llÄ± puanlama yapÄ±lacak.\n\nâ€¢ ${passCount} Ã¶ÄŸrenci geÃ§ecek\nâ€¢ ${failCount} Ã¶ÄŸrenci kalacak\n\nMevcut ${existingScoreCount} not verisi kaybolacak. Bu iÅŸlem geri alÄ±namaz. Devam etmek istediÄŸinizden emin misiniz?`;
    } else {
        warningMessage = `${studentCount} Ã¶ÄŸrenci iÃ§in ${assessmentCount} deÄŸerlendirme bileÅŸeninde %${targetPassRate} geÃ§me oranÄ±na gÃ¶re akÄ±llÄ± puanlama yapÄ±lacak.\n\nâ€¢ ${passCount} Ã¶ÄŸrenci geÃ§ecek\nâ€¢ ${failCount} Ã¶ÄŸrenci kalacak\n\nBu iÅŸlem geri alÄ±namaz. Devam etmek istediÄŸinizden emin misiniz?`;
    }
    
    showModernConfirm('ğŸ§  AkÄ±llÄ± Puanlama Sistemi Uygula', warningMessage, {
            confirmText: 'Evet, Uygula',
            cancelText: 'Ä°ptal',
        confirmClass: 'btn-modern-warning',
        cancelClass: 'btn-modern-secondary'
    }).then(() => {
        executeGenerateIntelligentScores(targetPassRate);
    });
}

/**
 * AkÄ±llÄ± puanlama sistemi (GerÃ§ek iÅŸlem)
 */
function executeGenerateIntelligentScores(targetPassRate) {
    if (!APP_STATE.studentData || APP_STATE.studentData.length === 0) {
        showModernToast('Ã–nce Ã¶ÄŸrenci verileri oluÅŸturun!', 'warning');
        return;
    }
    
    if (!APP_STATE.assessmentTree || APP_STATE.assessmentTree.length === 0) {
        showModernToast('Ã–nce deÄŸerlendirme bileÅŸenleri oluÅŸturun!', 'warning');
        return;
    }
    
    // AkÄ±llÄ± puanlama algoritmasÄ±
    const students = APP_STATE.studentData;
    const passCount = Math.round(students.length * targetPassRate / 100);
    
    // Her Ã¶ÄŸrenci iÃ§in puanlar oluÅŸtur
    students.forEach((student, index) => {
        const shouldPass = index < passCount;
        generateStudentScores(student.studentId, shouldPass);
    });
    
    showModernToast(`Hedef %${targetPassRate} geÃ§me oranÄ±yla puanlar oluÅŸturuldu!`, 'success');
    updatePassFailCounts();
    
    // GÃ¼venli fonksiyon Ã§aÄŸrÄ±sÄ±
    if (typeof updateGradeDisplays === 'function') {
        updateGradeDisplays();
    } else {
        console.log('updateGradeDisplays fonksiyonu henÃ¼z tanÄ±mlÄ± deÄŸil');
        updateModernStats();
    }
    
    // DeÄŸerlendirme gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ gÃ¼ncelle
    if (typeof updateAssessmentView === 'function') {
        updateAssessmentView();
    }
    
    console.log('ğŸ¯ AkÄ±llÄ± puanlama tamamlandÄ± - APP_STATE.gradesData:', APP_STATE.gradesData);
}

/**
 * Ã–ÄŸrenci iÃ§in akÄ±llÄ± puanlar oluÅŸtur
 */
function generateStudentScores(studentId, shouldPass) {
    if (!APP_STATE.gradesData) {
        APP_STATE.gradesData = {};
    }
    
    if (!APP_STATE.gradesData[studentId]) {
        APP_STATE.gradesData[studentId] = {};
    }
    
    const studentGrades = APP_STATE.gradesData[studentId];
    
    // Her deÄŸerlendirme bileÅŸeni iÃ§in puan oluÅŸtur
    APP_STATE.assessmentTree.forEach(node => {
        if (node.children && node.children.length > 0) {
            node.children.forEach(child => {
                generateComponentScore(child, studentGrades, shouldPass);
            });
        }
    });
}

/**
 * BileÅŸen iÃ§in akÄ±llÄ± puan oluÅŸtur
 */
function generateComponentScore(component, studentGrades, shouldPass) {
    const componentId = component.id;
    
    if (component.children && component.children.length > 0) {
        // Alt bileÅŸenler varsa onlar iÃ§in de puan oluÅŸtur
        component.children.forEach(child => {
            generateComponentScore(child, studentGrades, shouldPass);
        });
    } else {
        // Yaprak dÃ¼ÄŸÃ¼m - gerÃ§ek puan oluÅŸtur
        const maxPoints = parseFloat(component.points) || 100;
        let score;
        
        if (shouldPass) {
            // GeÃ§ecek Ã¶ÄŸrenci: GÃ¼venli geÃ§me aralÄ±ÄŸÄ± (65-95 arasÄ±)
            // %15 ihtimalle mÃ¼kemmel (90-95)
            // %35 ihtimalle Ã§ok iyi (80-90)  
            // %50 ihtimalle iyi (65-80)
            const rand = Math.random();
            if (rand < 0.15) {
                score = Math.random() * 5 + 90; // 90-95 mÃ¼kemmel
            } else if (rand < 0.50) {
                score = Math.random() * 10 + 80; // 80-90 Ã§ok iyi
        } else {
                score = Math.random() * 15 + 65; // 65-80 iyi
            }
        } else {
            // Kalacak Ã¶ÄŸrenci: GÃ¼venli kalma aralÄ±ÄŸÄ± (10-60 arasÄ±)
            // %20 ihtimalle Ã§ok dÃ¼ÅŸÃ¼k (10-30)
            // %40 ihtimalle dÃ¼ÅŸÃ¼k (30-45)
            // %40 ihtimalle orta-dÃ¼ÅŸÃ¼k (45-60)
            const rand = Math.random();
            if (rand < 0.20) {
                score = Math.random() * 20 + 10; // 10-30 Ã§ok dÃ¼ÅŸÃ¼k
            } else if (rand < 0.60) {
                score = Math.random() * 15 + 30; // 30-45 dÃ¼ÅŸÃ¼k
            } else {
                score = Math.random() * 15 + 45; // 45-60 orta-dÃ¼ÅŸÃ¼k
            }
        }
        
        // PuanÄ± maksimum puana gÃ¶re Ã¶lÃ§ekle
        const actualScore = (score / 100) * maxPoints;
        studentGrades[componentId] = Math.round(actualScore * 100) / 100;
    }
}

// Modern Toast fonksiyonu zaten yukarÄ±da tanÄ±mlÄ±

/**
 * Not gÃ¶rÃ¼nÃ¼mlerini gÃ¼ncelle
 */
// Ä°lk updateGradeDisplays fonksiyonu kaldÄ±rÄ±ldÄ± - geliÅŸmiÅŸ versiyon korundu

/**
 * Ã–ÄŸrenci gÃ¶rÃ¼nÃ¼mlerini gÃ¼ncelle
 */
function updateStudentDisplays() {
    // Ã–ÄŸrenci tablosunu gÃ¼ncelle
    if (typeof updateStudentTable === 'function') {
        updateStudentTable();
    }
    
    // updateStudentSelector fonksiyonu kaldÄ±rÄ±ldÄ± (Ã–ÄŸrenci BazlÄ± Not GiriÅŸi sekmesi ile birlikte)
    
    console.log('Ã–ÄŸrenci gÃ¶rÃ¼nÃ¼mleri gÃ¼ncellendi');
}

/**
 * Grup gÃ¶rÃ¼nÃ¼mlerini gÃ¼ncelle
 */
function updateGroupDisplays() {
    // Grup bilgilerini gÃ¼ncelle
    if (typeof updateGroupInfo === 'function') {
        updateGroupInfo();
    }
    
    // Grup istatistiklerini gÃ¼ncelle
    if (typeof updateGroupStatistics === 'function') {
        updateGroupStatistics();
    }
    
    console.log('Grup gÃ¶rÃ¼nÃ¼mleri gÃ¼ncellendi');
}

/**
 * TÃ¼m deÄŸerlendirmeleri temizle
 */
function clearAllAssessments() {
    showModernConfirm('ğŸ—‘ï¸ TÃ¼m DeÄŸerlendirmeleri Sil', 'TÃ¼m deÄŸerlendirme bileÅŸenlerini silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz!', {
        confirmText: 'Evet, Sil',
        cancelText: 'Ä°ptal',
        confirmClass: 'btn-modern-danger',
        cancelClass: 'btn-modern-secondary'
    }).then(() => {
            APP_STATE.assessmentTree = [];
            renderTree();
            updateCategoryWeights();
            updatePassFailCounts();
            showModernToast('ğŸ—‘ï¸ TÃ¼m deÄŸerlendirmeler temizlendi!', 'success');
    });
}

/**
 * TÃ¼m gruplarÄ± temizle
 */
function clearAllGroups() {
    showModernConfirm('ğŸ‘¥ TÃ¼m GruplarÄ± Sil', 'TÃ¼m grup atamalarÄ±nÄ± silmek istediÄŸinizden emin misiniz?\n\nâ€¢ TÃ¼m Ã¶ÄŸrenci grup atamalarÄ± silinecek\nâ€¢ Grup haritalama verileri silinecek\nâ€¢ DeÄŸerlendirme yapÄ±sÄ± korunacak\n\nBu iÅŸlem geri alÄ±namaz!', {
        confirmText: 'Evet, Sil',
        cancelText: 'Ä°ptal',
        confirmClass: 'btn-modern-danger',
        cancelClass: 'btn-modern-secondary'
    }).then(() => {
            performClearGroups();
    });
}

/**
 * TÃ¼m puanlarÄ± temizle
 */
function clearAllScores() {
    showModernConfirm('ğŸ“Š TÃ¼m PuanlarÄ± Sil', 'TÃ¼m Ã¶ÄŸrenci puanlarÄ±nÄ± silmek istediÄŸinizden emin misiniz?\n\nâ€¢ TÃ¼m not giriÅŸleri silinecek\nâ€¢ DeÄŸerlendirme yapÄ±sÄ± korunacak\nâ€¢ Grup atamalarÄ± korunacak\n\nBu iÅŸlem geri alÄ±namaz!', {
        confirmText: 'Evet, Sil',
        cancelText: 'Ä°ptal',
        confirmClass: 'btn-modern-danger',
        cancelClass: 'btn-modern-secondary'
    }).then(() => {
            performClearScores();
    });
}

/**
 * TÃ¼m Ã¶ÄŸrencileri temizle
 */
function clearAllStudents() {
    // Ã–nce silinecek Ã¶ÄŸrenci var mÄ± kontrol et
    const hasStudents = (APP_STATE.studentData && APP_STATE.studentData.length > 0) || 
                       (APP_STATE.students && APP_STATE.students.length > 0);
    
    if (!hasStudents) {
        showModernToast("â„¹ï¸ Silinecek Ã¶ÄŸrenci bulunmuyor.", "info");
        return;
    }
    
    showModernConfirm('ğŸ“ TÃ¼m Ã–ÄŸrencileri Sil', 'TÃ¼m Ã¶ÄŸrenci verilerini silmek istediÄŸinizden emin misiniz?\n\nâ€¢ Ã–ÄŸrenci listesi silinecek\nâ€¢ TÃ¼m notlar silinecek\nâ€¢ Grup atamalarÄ± silinecek\nâ€¢ DeÄŸerlendirme yapÄ±sÄ± korunacak\n\nBu iÅŸlem geri alÄ±namaz!', {
        confirmText: 'Evet, Sil',
        cancelText: 'Ä°ptal',
        confirmClass: 'btn-modern-danger',
        cancelClass: 'btn-modern-secondary'
    }).then(() => {
            performClearStudentsOnly();
    });
}

/**
 * Sistemi tamamen resetle
 */
function resetCompleteSystem() {
    console.log("ğŸ”§ resetCompleteSystem baÅŸlatÄ±ldÄ±");
    
    // Sistemi resetlemek iÃ§in en azÄ±ndan bir veri var mÄ± kontrol et
    const hasAnyData = (APP_STATE.studentData && APP_STATE.studentData.length > 0) ||
                      (APP_STATE.students && APP_STATE.students.length > 0) ||
                      (APP_STATE.assessmentTree && APP_STATE.assessmentTree.length > 0) ||
                      (APP_STATE.courseData && Object.keys(APP_STATE.courseData).length > 0) ||
                      (APP_STATE.gradesData && Object.keys(APP_STATE.gradesData).length > 0) ||
                      (APP_STATE.testScores && Object.keys(APP_STATE.testScores).length > 0);
    
    if (!hasAnyData) {
        showModernToast("â„¹ï¸ Sistem zaten boÅŸ durumda, resetleme gerekmiyor.", "info");
        return;
    }
    
    showModernConfirm('ğŸ”„ Sistemi Tamamen Resetle', 'Sistemi tamamen sÄ±fÄ±rlamak istediÄŸinizden emin misiniz?\n\nâ€¢ Ders bilgileri silinecek\nâ€¢ TÃ¼m Ã¶ÄŸrenciler silinecek\nâ€¢ TÃ¼m deÄŸerlendirmeler silinecek\nâ€¢ TÃ¼m notlar silinecek\nâ€¢ TÃ¼m gruplar silinecek\n\nBu iÅŸlem geri alÄ±namaz ve sistem baÅŸlangÄ±Ã§ durumuna dÃ¶necek!', {
        confirmText: 'Evet, Resetle',
        cancelText: 'Ä°ptal',
        confirmClass: 'btn-modern-danger',
        cancelClass: 'btn-modern-secondary'
    }).then(() => {
            console.log("âœ… resetCompleteSystem onaylandÄ±, resetleme baÅŸlÄ±yor...");
            performResetSystem();
    });
}

/**
 * Toast sistemini test et
 */
function testToastSystem() {
    showModernConfirm('ğŸ§ª Toast Sistemini Test Et', 'Toast bildirim sistemini test etmek ister misiniz?\n\nFarklÄ± tÃ¼rlerde toast mesajlarÄ± gÃ¶sterilecek.', {
        confirmText: 'Evet, Test Et',
        cancelText: 'Ä°ptal',
        confirmClass: 'btn-modern-primary',
        cancelClass: 'btn-modern-secondary'
    }).then(() => {
            performToastSystemTest();
    });
}

/**
 * Toast sistem testini gerÃ§ekleÅŸtir
 */
function performToastSystemTest() {
    let delay = 0;
    
    // BaÅŸarÄ± toast'Ä±
    setTimeout(() => {
        showModernToast('âœ… BaÅŸarÄ±lÄ± iÅŸlem testi!', 'success');
    }, delay);
    delay += 1500;
    
    // UyarÄ± toast'Ä±
    setTimeout(() => {
        showModernToast('âš ï¸ UyarÄ± mesajÄ± testi!', 'warning');
    }, delay);
    delay += 1500;
    
    // Hata toast'Ä±
    setTimeout(() => {
        showModernToast('âŒ Hata mesajÄ± testi!', 'error');
    }, delay);
    delay += 1500;
    
    // Bilgi toast'Ä±
    setTimeout(() => {
        showModernToast('â„¹ï¸ Bilgi mesajÄ± testi!', 'info');
    }, delay);
    delay += 1500;
    
    // Test tamamlandÄ±
    setTimeout(() => {
        showModernToast('ğŸ‰ Toast sistem testi tamamlandÄ±!', 'success');
    }, delay);
}

/**
 * Sistem resetleme iÅŸlemini gerÃ§ekleÅŸtir
 */
function performResetSystem() {
    try {
        console.log("ğŸ”§ performResetSystem baÅŸlatÄ±ldÄ±");
        
        // 1. TÃ¼m APP_STATE verilerini koordineli ÅŸekilde sÄ±fÄ±rla
        APP_STATE.courseData = null;
        APP_STATE.students = [];
        APP_STATE.assessmentTree = [];
        APP_STATE.studentGrades = {};
        APP_STATE.groupMapping = {};
        APP_STATE.learningOutcomes = [];
        APP_STATE.programOutcomes = [];
        APP_STATE.outcomeMatrix = null;
        APP_STATE.selectedNode = null;
        APP_STATE.selectedStudentId = null;
        
        // 2. Eski format desteÄŸi iÃ§in
        APP_STATE.studentData = [];
        APP_STATE.gradesData = {};
        APP_STATE.testScores = {};
        APP_STATE.gruplar = [];
        
        // 3. Ders bilgilerini sÄ±fÄ±rla
        const courseTitle = document.getElementById('courseTitle');
        const courseDetails = document.getElementById('courseDetails');
        const courseTerm = document.getElementById('courseTerm');
        
        if (courseTitle) courseTitle.textContent = 'Ders Bilgileri';
        if (courseDetails) courseDetails.textContent = 'JSON dosyasÄ± yÃ¼kleyiniz';
        if (courseTerm) courseTerm.textContent = '';
        
        // 4. UI'larÄ± gÃ¼venli ÅŸekilde gÃ¼ncelle
        renderTree();
        updateStudentTable();
        updateAssessmentView();
        
        // 5. Not tablosunu gÃ¼venli ÅŸekilde temizle
        try {
            updateGradesTable([]);
        } catch (tableError) {
            console.warn("âš ï¸ Not tablosu gÃ¼ncellenirken hata (gÃ¶rmezden gelindi):", tableError);
            const gradesTable = document.getElementById('gradesTable');
            if (gradesTable) {
                const tbody = gradesTable.querySelector('tbody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="8" class="empty-message">Not giriÅŸi yapÄ±lmadÄ±</td></tr>';
                }
            }
        }
        
        updateCategoryWeights();
        
        // 6. Eski format fonksiyonlarÄ± varsa gÃ¼venli ÅŸekilde Ã§aÄŸÄ±r
        if (typeof updateStudentDisplays === 'function') {
            updateStudentDisplays();
        }
        if (typeof updateGroupDisplays === 'function') {
            updateGroupDisplays();
        }
        if (typeof updateModernStats === 'function') {
            updateModernStats();
        }
        if (typeof updatePassFailCounts === 'function') {
            updatePassFailCounts();
        }
        if (typeof updateGroupSelectors === 'function') {
            updateGroupSelectors();
        }
        if (typeof updateTreeMappingControls === 'function') {
            updateTreeMappingControls();
        }
        
        // 7. TÃ¼m containers'Ä± temizle
        const containers = [
            'studentGradesContainer',
            'assessmentContainer',
            'gradesTableContainer',
            'courseDetailsContainer',
            'outcomesList',
            'programOutcomesList',
            'matrixContainer'
        ];
        
        containers.forEach(containerId => {
            const container = document.getElementById(containerId);
            if (container) {
                if (containerId === 'courseDetailsContainer') {
                    container.innerHTML = '<div class="details-empty-message">Ders detaylarÄ± iÃ§in JSON yÃ¼kleyin.</div>';
                } else if (containerId === 'outcomesList') {
                    container.innerHTML = '<div class="outcomes-empty-message">HenÃ¼z Ã¶ÄŸrenme Ã§Ä±ktÄ±sÄ± tanÄ±mlanmadÄ±. Ders JSON yÃ¼kleyin.</div>';
                } else if (containerId === 'programOutcomesList') {
                    container.innerHTML = '<div class="outcomes-empty-message">HenÃ¼z program Ã§Ä±ktÄ±sÄ± tanÄ±mlanmadÄ±. Ders JSON yÃ¼kleyin.</div>';
                } else if (containerId === 'matrixContainer') {
                    container.innerHTML = '<div class="matrix-empty-message">Ã–Ã‡-PÃ‡ iliÅŸki matrisi iÃ§in ders JSON yÃ¼kleyin.</div>';
                } else {
                    container.innerHTML = '<p class="empty-message">Veri bulunamadÄ±.</p>';
                }
            }
        });
        
        // 8. Tree container'Ä± Ã¶zel mesajla
        const treeContainer = document.getElementById('treeContainer');
        if (treeContainer) {
            treeContainer.innerHTML = '<div class="tree-empty-message">HenÃ¼z deÄŸerlendirme bileÅŸeni eklenmedi. Ders JSON yÃ¼kleyin veya yeni bileÅŸenler ekleyin.</div>';
        }
        
        showModernToast("ğŸ”„ Sistem tamamen ve koordineli ÅŸekilde sÄ±fÄ±rlandÄ±!", "success", 4000);
        
    } catch (error) {
        console.error("âŒ Sistem resetlenirken hata:", error);
        showModernToast("âŒ Sistem resetlenirken hata oluÅŸtu!", "error");
    }
}

/**
 * Grup temizleme iÅŸlemini gerÃ§ekleÅŸtir
 */
function performClearGroups() {
    try {
        // Grup haritalamalarÄ±nÄ± temizle
        if (APP_STATE.courseData) {
            APP_STATE.courseData.grupHaritalari = {};
        }
        APP_STATE.groupMapping = {};
        
        // Ã–ÄŸrencilerin gruplarÄ±nÄ± varsayÄ±lan gruba ata
        if (APP_STATE.students) {
            APP_STATE.students.forEach(student => {
                student.grup = 'A';
            });
        }
        if (APP_STATE.studentData) {
            APP_STATE.studentData.forEach(student => {
                student.grup = 'A';
            });
        }
        
        // Eski format desteÄŸi
        APP_STATE.gruplar = [];
        
        // UI'larÄ± gÃ¼ncelle
        if (typeof updateGroupSelectors === 'function') {
            updateGroupSelectors();
        }
        updateStudentTable();
        if (typeof updateTreeMappingControls === 'function') {
            updateTreeMappingControls();
        }
        if (typeof updateAllInlineGroupInputs === 'function') {
            updateAllInlineGroupInputs();
        }
        if (typeof updateAllMappingDisplays === 'function') {
            updateAllMappingDisplays();
        }
        updateAssessmentView();
        
        // Eski format fonksiyonlarÄ± varsa Ã§aÄŸÄ±r
        if (typeof updateGroupDisplays === 'function') {
            updateGroupDisplays();
        }
        if (typeof updateModernStats === 'function') {
            updateModernStats();
        }
        if (typeof updatePassFailCounts === 'function') {
            updatePassFailCounts();
        }
        
        showModernToast("ğŸ‘¥ TÃ¼m grup atamalarÄ± silindi!", "success");
        
    } catch (error) {
        console.error("Gruplar temizlenirken hata:", error);
        showModernToast("âŒ Gruplar temizlenemedi!", "error");
    }
}

/**
 * Puan temizleme iÅŸlemini gerÃ§ekleÅŸtir
 */
function performClearScores() {
    try {
        APP_STATE.studentGrades = {};
        APP_STATE.gradesData = {};
        if (typeof APP_STATE.testScores !== 'undefined') {
            APP_STATE.testScores = {};
        }
        
        // UI'larÄ± gÃ¼ncelle
        updateAssessmentView();
        updateGradesTable();
        
        // Ã–ÄŸrenci bazlÄ± not giriÅŸi sekmesini temizle
        const studentGradesContainer = document.getElementById('studentGradesContainer');
        if (studentGradesContainer) {
            studentGradesContainer.innerHTML = '<p class="empty-message">Veri bulunamadÄ±.</p>';
        }
        
        // Not tablosunu temizle
        const gradesTableContainer = document.getElementById('gradesTableContainer');
        if (gradesTableContainer) {
            gradesTableContainer.innerHTML = '<p class="empty-message">HenÃ¼z not hesaplanmadÄ±.</p>';
        }
        
        // Eski format fonksiyonlarÄ± varsa Ã§aÄŸÄ±r
        if (typeof updateGradeDisplays === 'function') {
            updateGradeDisplays();
        }
        if (typeof updateModernStats === 'function') {
            updateModernStats();
        }
        if (typeof updatePassFailCounts === 'function') {
            updatePassFailCounts();
        }
        
        showModernToast("ğŸ“Š TÃ¼m Ã¶ÄŸrenci puanlarÄ± silindi!", "success");
        
    } catch (error) {
        console.error("Puanlar temizlenirken hata:", error);
        showModernToast("âŒ Puanlar temizlenemedi!", "error");
    }
}

/**
 * Ã–ÄŸrenci temizleme iÅŸlemini gerÃ§ekleÅŸtir
 */
function performClearStudentsOnly() {
    try {
        APP_STATE.students = [];
        APP_STATE.studentGrades = {};
        APP_STATE.groupMapping = {};
        
        // Eski format desteÄŸi
        APP_STATE.studentData = [];
        APP_STATE.gradesData = {};
        
        updateStudentTable();
        updateAssessmentView();
        updateGradesTable();
        
        // Eski format fonksiyonlarÄ± varsa Ã§aÄŸÄ±r
        if (typeof updateStudentDisplays === 'function') {
            updateStudentDisplays();
        }
        if (typeof updateModernStats === 'function') {
            updateModernStats();
        }
        if (typeof updatePassFailCounts === 'function') {
            updatePassFailCounts();
        }
        if (typeof updateGroupSliderLimits === 'function') {
            updateGroupSliderLimits(); // Grup slider'larÄ±nÄ± sÄ±fÄ±rla
        }
        
        showModernToast("ğŸ“ TÃ¼m Ã¶ÄŸrenci verileri silindi!", "success");
        
    } catch (error) {
        console.error("Ã–ÄŸrenciler temizlenirken hata:", error);
        showModernToast("âŒ Ã–ÄŸrenciler temizlenemedi!", "error");
    }
}

/**
 * Rastgele yarÄ±yÄ±l iÃ§i deÄŸerlendirme oluÅŸtur
 */
// Ä°lk generateRandomTermAssessment fonksiyonu kaldÄ±rÄ±ldÄ± - geliÅŸmiÅŸ versiyon korundu

/**
 * Rastgele yarÄ±yÄ±l sonu deÄŸerlendirme oluÅŸtur
 */
// Ä°lk generateRandomFinalAssessment fonksiyonu kaldÄ±rÄ±ldÄ± - geliÅŸmiÅŸ versiyon korundu

/**
 * Rastgele bileÅŸen oluÅŸtur
 */
function createRandomComponent(isQuestion, type, index) {
    const questionTypes = ['Ã‡oktan SeÃ§meli', 'AÃ§Ä±k UÃ§lu', 'DoÄŸru/YanlÄ±ÅŸ', 'EÅŸleÅŸtirme'];
    const rubricTypes = ['Proje DeÄŸerlendirme', 'Sunum RubriÄŸi', 'Lab Raporu', 'Ã–dev RubriÄŸi'];
    
    if (isQuestion) {
        return {
            id: generateUniqueId(),
            name: `${type === 'term' ? 'Ara' : 'Final'} SÄ±nav Soru ${index}`,
            type: 'question',
            category: type,
            points: 0, // Daha sonra daÄŸÄ±tÄ±lacak
            questionType: questionTypes[Math.floor(Math.random() * questionTypes.length)],
            outcomes: getRandomOutcomes(),
            description: `${type === 'term' ? 'YarÄ±yÄ±l iÃ§i' : 'YarÄ±yÄ±l sonu'} deÄŸerlendirme sorusu`
        };
    } else {
        return {
            id: generateUniqueId(),
            name: `${type === 'term' ? 'Ara' : 'Final'} Rubrik ${index}`,
            type: 'rubric',
            category: type,
            points: 0, // Daha sonra daÄŸÄ±tÄ±lacak
            rubricType: rubricTypes[Math.floor(Math.random() * rubricTypes.length)],
            outcomes: getRandomOutcomes(),
            description: `${type === 'term' ? 'YarÄ±yÄ±l iÃ§i' : 'YarÄ±yÄ±l sonu'} rubrik deÄŸerlendirmesi`
        };
    }
}

/**
 * YarÄ±yÄ±l iÃ§i ana dÃ¼ÄŸÃ¼mÃ¼nÃ¼ al veya oluÅŸtur
 */
function getOrCreateTermNode() {
    let termNode = APP_STATE.assessmentTree.find(node => node.category === 'term');
    if (!termNode) {
        termNode = {
            id: generateUniqueId(),
            name: 'YarÄ±yÄ±l Ä°Ã§i DeÄŸerlendirme',
            type: 'term',
            category: 'term',
            weight: 40,
            children: []
        };
        APP_STATE.assessmentTree.push(termNode);
    }
    return termNode;
}

/**
 * YarÄ±yÄ±l sonu ana dÃ¼ÄŸÃ¼mÃ¼nÃ¼ al veya oluÅŸtur
 */
function getOrCreateFinalNode() {
    let finalNode = APP_STATE.assessmentTree.find(node => node.category === 'final');
    if (!finalNode) {
        finalNode = {
            id: generateUniqueId(),
            name: 'YarÄ±yÄ±l Sonu DeÄŸerlendirme',
            type: 'final',
            category: 'final',
            weight: 60,
            children: []
        };
        APP_STATE.assessmentTree.push(finalNode);
    }
    return finalNode;
}

// Ä°kinci getRandomOutcomes fonksiyonu kaldÄ±rÄ±ldÄ± - parametre alan versiyon korundu

// =====================================================
// ORAN DENGELEME SÄ°STEMÄ°
// =====================================================

/**
 * Dengeleme kontrolÃ¼ yapar ve gerekirse modal gÃ¶sterir
 * @param {string} category - 'term' veya 'final'
 * @param {number} addedCount - Eklenen bileÅŸen sayÄ±sÄ±
 */
function checkBalanceAndShowModal(category, addedCount) {
    const balanceStatus = analyzeBalanceStatus();
    
    if (balanceStatus.needsBalance) {
        showBalanceModal(category, addedCount, balanceStatus);
    } else {
        // Dengeleme gerekmiyor, sadece bilgi ver
        showModernToast(`${addedCount} adet ${category === 'term' ? 'yarÄ±yÄ±l iÃ§i' : 'yarÄ±yÄ±l sonu'} bileÅŸen oluÅŸturuldu!`, 'success');
    }
}

/**
 * Mevcut dengeleme durumunu analiz eder
 * @returns {Object} Dengeleme durumu bilgileri
 */
function analyzeBalanceStatus() {
    const termNodes = getNodesByCategory('term');
    const finalNodes = getNodesByCategory('final');
    
    // YarÄ±yÄ±l iÃ§i analizi
    const termAnalysis = analyzeNodeGroup(termNodes, 'YarÄ±yÄ±l Ä°Ã§i');
    const finalAnalysis = analyzeNodeGroup(finalNodes, 'YarÄ±yÄ±l Sonu');
    
    // Genel aÄŸÄ±rlÄ±k analizi
    const totalTermWeight = termNodes.reduce((sum, node) => sum + (node.weight || 0), 0);
    const totalFinalWeight = finalNodes.reduce((sum, node) => sum + (node.weight || 0), 0);
    const totalWeight = totalTermWeight + totalFinalWeight;
    
    const needsBalance = !termAnalysis.isBalanced || !finalAnalysis.isBalanced || totalWeight !== 100;
    
    return {
        needsBalance,
        termAnalysis,
        finalAnalysis,
        totalTermWeight,
        totalFinalWeight,
        totalWeight,
        issues: [
            ...termAnalysis.issues,
            ...finalAnalysis.issues,
            ...(totalWeight !== 100 ? [`Toplam aÄŸÄ±rlÄ±k %${totalWeight} (olmasÄ± gereken %100)`] : [])
        ]
    };
}

/**
 * DÃ¼ÄŸÃ¼m grubunu analiz eder
 * @param {Array} nodes - Analiz edilecek dÃ¼ÄŸÃ¼mler
 * @param {string} categoryName - Kategori adÄ±
 * @returns {Object} Analiz sonucu
 */
function analyzeNodeGroup(nodes, categoryName) {
    const issues = [];
    let isBalanced = true;
    
    nodes.forEach(node => {
        if (node.children && node.children.length > 0) {
            const totalPoints = node.children.reduce((sum, child) => sum + (child.points || 0), 0);
            if (totalPoints !== 100) {
                issues.push(`${node.name}: ${totalPoints} puan (olmasÄ± gereken 100)`);
                isBalanced = false;
            }
        }
    });
    
    return { isBalanced, issues, nodes };
}

/**
 * Kategori bazÄ±nda dÃ¼ÄŸÃ¼mleri getirir
 * @param {string} category - Kategori ('term' veya 'final')
 * @returns {Array} DÃ¼ÄŸÃ¼m listesi
 */
function getNodesByCategory(category) {
    return APP_STATE.assessmentTree.filter(node => node.category === category);
}

/**
 * Dengeleme modalÄ±nÄ± gÃ¶sterir
 * @param {string} category - Kategori
 * @param {number} addedCount - Eklenen bileÅŸen sayÄ±sÄ±
 * @param {Object} balanceStatus - Dengeleme durumu
 */
function showBalanceModal(category, addedCount, balanceStatus) {
    const modal = document.getElementById('balanceDistributionModal');
    const statusContainer = document.getElementById('currentBalanceStatus');
    
    if (!modal || !statusContainer) return;
    
    // Mevcut durum bilgisini oluÅŸtur
    let statusHTML = `
        <div class="status-category">
            <h5>ğŸ“Š Mevcut Durum</h5>
            <div class="status-items">
    `;
    
    balanceStatus.issues.forEach(issue => {
        statusHTML += `<div class="status-item unbalanced">${issue}</div>`;
    });
    
    statusHTML += `
            </div>
        </div>
        <div class="status-category">
            <h5>ğŸ¯ Hedef</h5>
            <div class="status-items">
                <div class="status-item balanced">YarÄ±yÄ±l Ä°Ã§i: Her sÄ±nav 100 puan</div>
                <div class="status-item balanced">YarÄ±yÄ±l Sonu: Her sÄ±nav 100 puan</div>
                <div class="status-item balanced">AÄŸÄ±rlÄ±k ToplamÄ±: %100</div>
            </div>
        </div>
    `;
    
    statusContainer.innerHTML = statusHTML;
    
    // Modal event listener'larÄ±nÄ± ayarla
    setupBalanceModalEvents(category, addedCount, balanceStatus);
    
    // Modal'Ä± aÃ§
    openModernModal('balanceDistributionModal');
}

/**
 * Dengeleme modal event listener'larÄ±nÄ± ayarlar
 * @param {string} category - Kategori
 * @param {number} addedCount - Eklenen bileÅŸen sayÄ±sÄ±
 * @param {Object} balanceStatus - Dengeleme durumu
 */
function setupBalanceModalEvents(category, addedCount, balanceStatus) {
    // Ã–nceki event listener'larÄ± temizle
    const cards = document.querySelectorAll('.balance-option-card');
    const previewBtn = document.getElementById('previewBalanceBtn');
    const applyBtn = document.getElementById('applyBalanceBtn');
    
    // SeÃ§im temizle
    cards.forEach(card => card.classList.remove('selected'));
    previewBtn.disabled = true;
    applyBtn.disabled = true;
    
    // Kart seÃ§im event'leri
    cards.forEach(card => {
        const newCard = card.cloneNode(true);
        card.parentNode.replaceChild(newCard, card);
        
        newCard.addEventListener('click', () => {
            // TÃ¼m seÃ§imleri temizle
            document.querySelectorAll('.balance-option-card').forEach(c => c.classList.remove('selected'));
            // Bu kartÄ± seÃ§
            newCard.classList.add('selected');
            
            // ButonlarÄ± etkinleÅŸtir
            previewBtn.disabled = false;
            applyBtn.disabled = false;
            
            // SeÃ§ilen opsiyon
            const selectedOption = newCard.getAttribute('data-option');
            
            // Event listener'larÄ± gÃ¼ncelle
            setupButtonEvents(selectedOption, category, addedCount, balanceStatus);
        });
    });
}

/**
 * Buton event listener'larÄ±nÄ± ayarlar
 * @param {string} selectedOption - SeÃ§ilen dengeleme opsionu
 * @param {string} category - Kategori
 * @param {number} addedCount - Eklenen bileÅŸen sayÄ±sÄ±
 * @param {Object} balanceStatus - Dengeleme durumu
 */
function setupButtonEvents(selectedOption, category, addedCount, balanceStatus) {
    const previewBtn = document.getElementById('previewBalanceBtn');
    const applyBtn = document.getElementById('applyBalanceBtn');
    
    // Ã–nceki event listener'larÄ± temizle
    const newPreviewBtn = previewBtn.cloneNode(true);
    const newApplyBtn = applyBtn.cloneNode(true);
    previewBtn.parentNode.replaceChild(newPreviewBtn, previewBtn);
    applyBtn.parentNode.replaceChild(newApplyBtn, applyBtn);
    
    // Ã–nizleme butonu
    newPreviewBtn.addEventListener('click', () => {
        showBalancePreview(selectedOption, balanceStatus);
    });
    
    // Uygulama butonu
    newApplyBtn.addEventListener('click', () => {
        applyBalanceOption(selectedOption, balanceStatus);
        closeModernModal('balanceDistributionModal');
        showModernToast(`${addedCount} adet ${category === 'term' ? 'yarÄ±yÄ±l iÃ§i' : 'yarÄ±yÄ±l sonu'} bileÅŸen oluÅŸturuldu ve dengeleme uygulandÄ±!`, 'success');
    });
}

/**
 * Dengeleme Ã¶nizlemesini gÃ¶sterir
 * @param {string} selectedOption - SeÃ§ilen dengeleme opsionu
 * @param {Object} balanceStatus - Dengeleme durumu
 */
function showBalancePreview(selectedOption, balanceStatus) {
    const previewSection = document.getElementById('balancePreview');
    const previewContent = document.getElementById('previewContent');
    
    if (!previewSection || !previewContent) return;
    
    const changes = calculateBalanceChanges(selectedOption, balanceStatus);
    
    let previewHTML = '';
    
    // YarÄ±yÄ±l iÃ§i deÄŸiÅŸiklikler
    if (changes.termChanges.length > 0) {
        previewHTML += `
            <div class="preview-category">
                <h6>ğŸ“˜ YarÄ±yÄ±l Ä°Ã§i DeÄŸerlendirmeler</h6>
                <div class="preview-items">
                    <div class="preview-header">Etkinlik</div>
                    <div class="preview-header">Eski Puan</div>
                    <div class="preview-header">Yeni Puan</div>
        `;
        
        changes.termChanges.forEach(change => {
            const isChanged = change.oldValue !== change.newValue;
            previewHTML += `
                <div class="preview-item ${isChanged ? 'changed' : ''}">${change.name}</div>
                <div class="preview-item ${isChanged ? 'changed' : ''}">
                    ${isChanged ? `<span class="old-value">${change.oldValue}</span>` : change.oldValue}
                </div>
                <div class="preview-item ${isChanged ? 'changed' : ''}">
                    ${isChanged ? `<span class="new-value">${change.newValue}</span>` : change.newValue}
                </div>
            `;
        });
        
        previewHTML += `</div></div>`;
    }
    
    // YarÄ±yÄ±l sonu deÄŸiÅŸiklikler
    if (changes.finalChanges.length > 0) {
        previewHTML += `
            <div class="preview-category">
                <h6>ğŸ“• YarÄ±yÄ±l Sonu DeÄŸerlendirmeler</h6>
                <div class="preview-items">
                    <div class="preview-header">Etkinlik</div>
                    <div class="preview-header">Eski Puan</div>
                    <div class="preview-header">Yeni Puan</div>
        `;
        
        changes.finalChanges.forEach(change => {
            const isChanged = change.oldValue !== change.newValue;
            previewHTML += `
                <div class="preview-item ${isChanged ? 'changed' : ''}">${change.name}</div>
                <div class="preview-item ${isChanged ? 'changed' : ''}">
                    ${isChanged ? `<span class="old-value">${change.oldValue}</span>` : change.oldValue}
                </div>
                <div class="preview-item ${isChanged ? 'changed' : ''}">
                    ${isChanged ? `<span class="new-value">${change.newValue}</span>` : change.newValue}
                </div>
            `;
        });
        
        previewHTML += `</div></div>`;
    }
    
    // Ã–zet
    previewHTML += `
        <div class="total-summary">
            <div class="total-row">
                <span class="total-label">YarÄ±yÄ±l Ä°Ã§i Toplam:</span>
                <span class="total-value ${changes.termTotal === 100 ? 'perfect' : 'unbalanced'}">${changes.termTotal} puan</span>
            </div>
            <div class="total-row">
                <span class="total-label">YarÄ±yÄ±l Sonu Toplam:</span>
                <span class="total-value ${changes.finalTotal === 100 ? 'perfect' : 'unbalanced'}">${changes.finalTotal} puan</span>
            </div>
            <div class="total-row">
                <span class="total-label">Genel AÄŸÄ±rlÄ±k ToplamÄ±:</span>
                <span class="total-value ${changes.weightTotal === 100 ? 'perfect' : 'unbalanced'}">%${changes.weightTotal}</span>
            </div>
        </div>
    `;
    
    previewContent.innerHTML = previewHTML;
    previewSection.style.display = 'block';
}

/**
 * Dengeleme deÄŸiÅŸikliklerini hesaplar
 * @param {string} selectedOption - SeÃ§ilen dengeleme opsionu
 * @param {Object} balanceStatus - Dengeleme durumu
 * @returns {Object} DeÄŸiÅŸiklik detaylarÄ±
 */
function calculateBalanceChanges(selectedOption, balanceStatus) {
    const changes = {
        termChanges: [],
        finalChanges: [],
        termTotal: 0,
        finalTotal: 0,
        weightTotal: 0
    };
    
    if (selectedOption === 'keep-current') {
        // Mevcut durumu koru - deÄŸiÅŸiklik yok
        balanceStatus.termAnalysis.nodes.forEach(node => {
            if (node.children && node.children.length > 0) {
                node.children.forEach(child => {
                    changes.termChanges.push({
                        name: child.name,
                        oldValue: child.points || 0,
                        newValue: child.points || 0
                    });
                });
            }
        });
        
        balanceStatus.finalAnalysis.nodes.forEach(node => {
            if (node.children && node.children.length > 0) {
                node.children.forEach(child => {
                    changes.finalChanges.push({
                        name: child.name,
                        oldValue: child.points || 0,
                        newValue: child.points || 0
                    });
                });
            }
        });
        
        changes.termTotal = changes.termChanges.reduce((sum, change) => sum + change.newValue, 0);
        changes.finalTotal = changes.finalChanges.reduce((sum, change) => sum + change.newValue, 0);
        changes.weightTotal = balanceStatus.totalWeight;
        
    } else if (selectedOption === 'auto-balance') {
        // Otomatik dengeleme - eÅŸit daÄŸÄ±lÄ±m
        balanceStatus.termAnalysis.nodes.forEach(node => {
            if (node.children && node.children.length > 0) {
                const newPoints = distributePointsIntelligently(node.children.length, 100);
                node.children.forEach((child, index) => {
                    changes.termChanges.push({
                        name: child.name,
                        oldValue: child.points || 0,
                        newValue: newPoints[index]
                    });
                });
            }
        });
        
        balanceStatus.finalAnalysis.nodes.forEach(node => {
            if (node.children && node.children.length > 0) {
                const newPoints = distributePointsIntelligently(node.children.length, 100);
                node.children.forEach((child, index) => {
                    changes.finalChanges.push({
                        name: child.name,
                        oldValue: child.points || 0,
                        newValue: newPoints[index]
                    });
                });
            }
        });
        
        changes.termTotal = 100;
        changes.finalTotal = 100;
        changes.weightTotal = 100; // AÄŸÄ±rlÄ±klar da dengelenecek
        
    } else if (selectedOption === 'smart-balance') {
        // AkÄ±llÄ± dengeleme - mevcut oranlarÄ± koruyarak dÃ¼zelt
        balanceStatus.termAnalysis.nodes.forEach(node => {
            if (node.children && node.children.length > 0) {
                const currentTotal = node.children.reduce((sum, child) => sum + (child.points || 0), 0);
                const factor = currentTotal > 0 ? 100 / currentTotal : 1;
                
                node.children.forEach(child => {
                    const newValue = Math.round((child.points || 0) * factor);
                    changes.termChanges.push({
                        name: child.name,
                        oldValue: child.points || 0,
                        newValue: newValue
                    });
                });
                
                // Son dÃ¼zeltme - toplam tam 100 olsun
                const actualTotal = changes.termChanges.slice(-node.children.length).reduce((sum, change) => sum + change.newValue, 0);
                if (actualTotal !== 100) {
                    const lastChange = changes.termChanges[changes.termChanges.length - 1];
                    lastChange.newValue += (100 - actualTotal);
                }
            }
        });
        
        balanceStatus.finalAnalysis.nodes.forEach(node => {
            if (node.children && node.children.length > 0) {
                const currentTotal = node.children.reduce((sum, child) => sum + (child.points || 0), 0);
                const factor = currentTotal > 0 ? 100 / currentTotal : 1;
                
                node.children.forEach(child => {
                    const newValue = Math.round((child.points || 0) * factor);
                    changes.finalChanges.push({
                        name: child.name,
                        oldValue: child.points || 0,
                        newValue: newValue
                    });
                });
                
                // Son dÃ¼zeltme - toplam tam 100 olsun
                const actualTotal = changes.finalChanges.slice(-node.children.length).reduce((sum, change) => sum + change.newValue, 0);
                if (actualTotal !== 100) {
                    const lastChange = changes.finalChanges[changes.finalChanges.length - 1];
                    lastChange.newValue += (100 - actualTotal);
                }
            }
        });
        
        changes.termTotal = 100;
        changes.finalTotal = 100;
        changes.weightTotal = 100;
        
    } else if (selectedOption === 'manual-balance') {
        // Manuel dÃ¼zenleme - kullanÄ±cÄ± kendisi yapacak
        // Sadece mevcut durumu gÃ¶ster
        return calculateBalanceChanges('keep-current', balanceStatus);
    }
    
    return changes;
}

/**
 * Dengeleme opsiyonunu uygular
 * @param {string} selectedOption - SeÃ§ilen dengeleme opsionu
 * @param {Object} balanceStatus - Dengeleme durumu
 */
function applyBalanceOption(selectedOption, balanceStatus) {
    if (selectedOption === 'keep-current') {
        // HiÃ§bir ÅŸey yapma
        return;
    }
    
    if (selectedOption === 'manual-balance') {
        // Manuel dÃ¼zenleme iÃ§in sadece uyarÄ± ver
        showModernToast('Manuel dÃ¼zenleme seÃ§ildi. PuanlarÄ± kendiniz ayarlayabilirsiniz.', 'info');
        return;
    }
    
    const changes = calculateBalanceChanges(selectedOption, balanceStatus);
    
    // YarÄ±yÄ±l iÃ§i deÄŸiÅŸiklikleri uygula
    let termChangeIndex = 0;
    balanceStatus.termAnalysis.nodes.forEach(node => {
        if (node.children && node.children.length > 0) {
            node.children.forEach(child => {
                if (termChangeIndex < changes.termChanges.length) {
                    child.points = changes.termChanges[termChangeIndex].newValue;
                    termChangeIndex++;
                }
            });
        }
    });
    
    // YarÄ±yÄ±l sonu deÄŸiÅŸiklikleri uygula
    let finalChangeIndex = 0;
    balanceStatus.finalAnalysis.nodes.forEach(node => {
        if (node.children && node.children.length > 0) {
            node.children.forEach(child => {
                if (finalChangeIndex < changes.finalChanges.length) {
                    child.points = changes.finalChanges[finalChangeIndex].newValue;
                    finalChangeIndex++;
                }
            });
        }
    });
    
    // AÄŸÄ±rlÄ±klarÄ± da dengele (eÄŸer gerekiyorsa)
    if (selectedOption === 'auto-balance' || selectedOption === 'smart-balance') {
        const termNodes = getNodesByCategory('term');
        const finalNodes = getNodesByCategory('final');
        
        // VarsayÄ±lan aÄŸÄ±rlÄ±klar: %40 term, %60 final
        if (termNodes.length > 0) {
            const termWeight = termNodes.length > 0 ? 40 / termNodes.length : 0;
            termNodes.forEach(node => {
                node.weight = termWeight;
            });
        }
        
        if (finalNodes.length > 0) {
            const finalWeight = finalNodes.length > 0 ? 60 / finalNodes.length : 0;
            finalNodes.forEach(node => {
                node.weight = finalWeight;
            });
        }
    }
    
    // GÃ¶rÃ¼nÃ¼mÃ¼ gÃ¼ncelle
    renderTree();
    // DeÄŸerlendirme sekmesini gÃ¼ncelle - CRITICAL SYNC
    updateAssessmentView();
}

// DOM yÃ¼klendiÄŸinde modal'Ä± baÅŸlat
document.addEventListener('DOMContentLoaded', function() {
    initializeEmailModal();
    initializeModernTestOperations();
    initializeModernEventListeners();
    
    // Grup istatistiklerini baÅŸlat
    updateGroupStatistics();
    
    // Assessment Sync Butonu Event Listener
    const btnSyncAssessment = document.getElementById('btnSyncAssessment');
    if (btnSyncAssessment) {
        btnSyncAssessment.addEventListener('click', function() {
            console.log('ğŸ”„ Manuel assessment sync butonuna tÄ±klandÄ±');
            
            // Veri kontrolÃ¼
            if (!APP_STATE.assessmentTree?.length) {
                showModernToast("âš ï¸ Ders tanÄ±mlama verisi bulunamadÄ±! Ã–nce ders tanÄ±mlamasÄ± yapÄ±n.", "warning");
                return;
            }
            
            if (!APP_STATE.studentData?.length) {
                showModernToast("âš ï¸ Ã–ÄŸrenci verisi bulunamadÄ±! Ã–nce Ã¶ÄŸrenci listesi yÃ¼kleyin.", "warning");
                return;
            }
            
            // Sekmeden kontrol 
            const activeTab = document.querySelector('.nav-tab.active');
            const isAssessmentTab = activeTab && activeTab.getAttribute('data-tab') === 'assessment';
            
            if (!isAssessmentTab) {
                showModernToast("â„¹ï¸ DeÄŸerlendirme GiriÅŸi sekmesine geÃ§iÅŸ yapÄ±lÄ±yor...", "info");
                // Assessment sekmesine geÃ§
                const assessmentTab = document.querySelector('.nav-tab[data-tab="assessment"]');
                if (assessmentTab) {
                    assessmentTab.click();
                }
                
                // KÄ±sa bir bekleyip gÃ¼ncelle
                setTimeout(() => {
                    updateAssessmentView();
                    showModernToast("âœ… DeÄŸerlendirme tablosu gÃ¼ncellendi!", "success");
                }, 100);
            } else {
                // Zaten assessment sekmesindeyiz, direkt gÃ¼ncelle
                updateAssessmentView();
                showModernToast("âœ… DeÄŸerlendirme tablosu gÃ¼ncellendi!", "success");
            }
        });
    }
});

/**
 * Ã–Ã‡ Performans KartÄ± HTML OluÅŸturucu
 */
function createOCPerformanceHTML(outcomes, studentGrades) {
    if (!outcomes || outcomes.length === 0) {
        return `
        <div class="email-card">
            <div class="card-header">ğŸ“š Ã–ÄŸrenme Ã‡Ä±ktÄ±larÄ± (Ã–Ã‡)</div>
            <div class="card-content">
                <p style="color: #e74c3c;">Bu ders iÃ§in Ã¶ÄŸrenme Ã§Ä±ktÄ±larÄ± tanÄ±mlanmamÄ±ÅŸ.</p>
            </div>
        </div>`;
    }

    const performanceItems = outcomes.slice(0, 4).map(outcome => {
        const performance = calculateOCPerformanceFromText(outcome.id, studentGrades, APP_STATE.assessmentTree || []);
        const level = getPerformanceTextLevel(performance);
        const color = performance >= 80 ? '#27ae60' : performance >= 70 ? '#f39c12' : '#e74c3c';
        
        return `
        <div class="performance-item">
            <div class="performance-header">
                <span class="oc-id">${outcome.id}</span>
                <span class="performance-score" style="color: ${color};">%${performance.toFixed(2)}</span>
            </div>
            <div class="performance-level" style="color: ${color};">${level}</div>
            <div class="oc-description">${(outcome.aciklama || '').substring(0, 80)}...</div>
        </div>`;
    }).join('');

    const remainingCount = outcomes.length > 4 ? outcomes.length - 4 : 0;
    
    return `
    <div class="email-card">
        <div class="card-header">ğŸ“š Ã–ÄŸrenme Ã‡Ä±ktÄ±larÄ± PerformansÄ±</div>
        <div class="card-content">
            ${performanceItems}
            ${remainingCount > 0 ? `<div class="remaining-count">... ve ${remainingCount} tane daha</div>` : ''}
        </div>
    </div>`;
}

/**
 * PÃ‡ Ä°liÅŸki KartÄ± HTML OluÅŸturucu
 */
function createPCRelationHTML(programOutcomes, relationMatrix) {
    const totalPC = programOutcomes.length;
    const strongRelations = Math.floor(totalPC * 0.4);
    const moderateRelations = Math.floor(totalPC * 0.6);
    
    // En gÃ¼Ã§lÃ¼ iliÅŸkileri gÃ¶ster
    const topRelations = programOutcomes.slice(0, 3).map(pc => {
        const category = pc.kategori || 'BÄ°LGÄ°';
        const relation = calculatePCRelationStrength(pc.id, relationMatrix);
        const strength = relation.level;
        const color = strength === 'GÃ¼Ã§lÃ¼' ? '#27ae60' : strength === 'Orta' ? '#f39c12' : '#e74c3c';
        
        return `
        <div class="pc-relation-item">
            <div class="pc-header">
                <span class="pc-id">${pc.id}</span>
                <span class="pc-category">${category}</span>
            </div>
            <div class="relation-strength" style="color: ${color};">${strength} Ä°liÅŸki</div>
        </div>`;
    }).join('');
    
    return `
    <div class="email-card">
        <div class="card-header">ğŸ¯ Program Ã‡Ä±ktÄ±larÄ± Ä°liÅŸkisi</div>
        <div class="card-content">
            <div class="pc-summary">
                <div class="summary-item">
                    <span class="summary-label">Toplam PÃ‡:</span>
                    <span class="summary-value">${totalPC}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">GÃ¼Ã§lÃ¼ Ä°liÅŸki:</span>
                    <span class="summary-value" style="color: #27ae60;">${strongRelations}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Orta Ä°liÅŸki:</span>
                    <span class="summary-value" style="color: #f39c12;">${moderateRelations}</span>
                </div>
            </div>
            ${topRelations}
        </div>
    </div>`;
}

/**
 * Genel Performans Ã–zeti HTML OluÅŸturucu
 */
function createPerformanceSummaryHTML(avgPerformance) {
    const level = getPerformanceTextLevel(avgPerformance);
    const color = avgPerformance >= 80 ? '#27ae60' : avgPerformance >= 70 ? '#f39c12' : '#e74c3c';
    
    let recommendation = '';
    let icon = '';
    
    if (avgPerformance >= 80) {
        recommendation = 'Mevcut performansÄ±nÄ±zÄ± koruyun. BaÅŸarÄ±lÄ± gidiyorsunuz!';
        icon = 'ğŸŒŸ';
    } else if (avgPerformance >= 70) {
        recommendation = 'ZayÄ±f alanlarÄ± geliÅŸtirin. Daha fazla Ã§alÄ±ÅŸma ile daha iyi sonuÃ§lar alabilirsiniz.';
        icon = 'ğŸ“ˆ';
    } else {
        recommendation = 'Temel konularÄ± tekrar edin. Ek destek almayÄ± dÃ¼ÅŸÃ¼nÃ¼n.';
        icon = 'ğŸ“š';
    }
    
    return `
    <div class="email-card performance-summary">
        <div class="card-header">ğŸ“Š Genel Performans DeÄŸerlendirmesi</div>
        <div class="card-content">
            <div class="performance-overview">
                <div class="avg-performance">
                    <span class="performance-label">Ã–Ã‡ OrtalamasÄ±:</span>
                    <span class="performance-value" style="color: ${color}; font-size: 24px; font-weight: bold;">%${avgPerformance.toFixed(2)}</span>
                </div>
                <div class="performance-level-display" style="color: ${color}; font-size: 18px; font-weight: bold;">
                    ${level}
                </div>
            </div>
            <div class="recommendation">
                <div class="recommendation-header">${icon} Ã–neriler:</div>
                <div class="recommendation-text">${recommendation}</div>
            </div>
        </div>
    </div>`;
}

/**
 * Ã–Ã‡-PÃ‡ Analiz e-postasÄ± iÃ§in HTML formatÄ±
 */
function generateAnalysisHTMLEmail(student) {
    const instructor = getInstructorName();
    const courseInfo = getCourseInfo();
    const courseName = courseInfo.name;
    const courseTerm = courseInfo.term;
    
    const subject = `${courseName} - Ã–Ã‡-PÃ‡ Analizi`;
    
    // Ã–ÄŸrenci verilerini al
    let studentData = APP_STATE.studentData?.find(s => s.studentId === student.studentId);
    if (!studentData) {
        studentData = {
            studentId: student.studentId,
            name: student.name || 'Bilinmeyen',
            surname: student.surname || 'Ã–ÄŸrenci'
        };
    }

    // Veri kaynaklarÄ±
    const outcomes = APP_STATE.courseData?.dersOgrenmeÃ‡iktilari || [];
    const programOutcomes = APP_STATE.courseData?.programCiktilari || [];
    const relationMatrix = APP_STATE.courseData?.programVeOgrenmeIliskisi?.iliskiTablosu || [];
    const allGradesData = APP_STATE.gradesData || APP_STATE.courseData?.ogrenciNotlari || {};
    const studentGrades = allGradesData[studentData.studentId] || {};
    
    // GerÃ§ek ortalama performans hesabÄ±
    let totalOCPerformance = 0;
    let validOCCount = 0;
    outcomes.forEach(oc => {
        const performance = calculateOCPerformanceFromText(oc.id, studentGrades, APP_STATE.assessmentTree || []);
        totalOCPerformance += performance;
        if (performance > 0) validOCCount++;
    });
    const avgPerformance = validOCCount > 0 ? totalOCPerformance / validOCCount : 0;
    
    // HTML bileÅŸenleri
    const studentInfoHTML = createStudentInfoHTML(studentData, courseName, courseTerm);
    const ocPerformanceHTML = createOCPerformanceHTML(outcomes, studentGrades);
    const pcRelationHTML = createPCRelationHTML(programOutcomes, relationMatrix);
    const performanceSummaryHTML = createPerformanceSummaryHTML(avgPerformance);
    const contactHTML = createContactHTML(instructor);
    
    const body = `
    <div style="font-family: 'Segoe UI', Arial, sans-serif; max-width: 800px; margin: 0 auto; background-color: #f8f9fa;">
        ${studentInfoHTML}
        ${ocPerformanceHTML}
        ${pcRelationHTML}
        ${performanceSummaryHTML}
        ${contactHTML}
    </div>
    
    <style>
        .email-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin: 20px 0;
            overflow: hidden;
        }
        
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 20px;
            font-size: 18px;
            font-weight: bold;
        }
        
        .card-content {
            padding: 20px;
        }
        
        .performance-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #667eea;
        }
        
        .performance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .oc-id {
            font-weight: bold;
            color: #2c3e50;
            font-size: 16px;
        }
        
        .performance-score {
            font-weight: bold;
            font-size: 18px;
        }
        
        .performance-level {
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .oc-description {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .pc-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .summary-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        
        .summary-label {
            display: block;
            color: #7f8c8d;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .summary-value {
            font-weight: bold;
            font-size: 18px;
            color: #2c3e50;
        }
        
        .pc-relation-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            border-left: 4px solid #f39c12;
        }
        
        .pc-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .pc-id {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .pc-category {
            background: #ecf0f1;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .relation-strength {
            font-weight: bold;
            font-size: 14px;
        }
        
        .performance-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .performance-summary .card-content {
            color: white;
        }
        
        .performance-overview {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .avg-performance {
            margin-bottom: 10px;
        }
        
        .performance-label {
            display: block;
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .performance-value {
            display: block;
        }
        
        .performance-level-display {
            margin-top: 10px;
        }
        
        .recommendation {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 15px;
        }
        
        .recommendation-header {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .recommendation-text {
            line-height: 1.6;
        }
        
        .remaining-count {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
    </style>`;
    
    return { subject, body };
}

/**
 * Tam Dosya formatÄ±nda rastgele yarÄ±yÄ±l iÃ§i deÄŸerlendirme oluÅŸturur
 */
function generateRandomTermAssessment() {
    try {
        const activityCount = parseInt(document.getElementById('termActivityCountSlider').value) || 2;
        const componentCount = parseInt(document.getElementById('termComponentsSlider').value) || 3;
        const activityType = document.getElementById('termActivityTypeSelect').value || 'random';
        
                  console.log(`ğŸ² Tam Dosya formatÄ±nda rastgele yarÄ±yÄ±l iÃ§i deÄŸerlendirme oluÅŸturuluyor (${activityCount} etkinlik, ${componentCount} alt bileÅŸen)...`);
        
        generateTamDosyaTermAssessmentWithParams(activityCount, componentCount, activityType);
        
    } catch (error) {
        console.error('âŒ V5 rastgele yarÄ±yÄ±l iÃ§i deÄŸerlendirme oluÅŸturulurken hata:', error);
        showModernToast('V5 rastgele yarÄ±yÄ±l iÃ§i deÄŸerlendirme oluÅŸturulamadÄ±!', 'error');
    }
}

/**
 * Tam Dosya formatÄ±nda rastgele yarÄ±yÄ±l sonu deÄŸerlendirme oluÅŸturur
 */
function generateRandomFinalAssessment() {
    try {
        const activityCount = parseInt(document.getElementById('finalActivityCountSlider').value) || 1;
        const componentCount = parseInt(document.getElementById('finalComponentsSlider').value) || 5;
        const activityType = document.getElementById('finalActivityTypeSelect').value || 'random';
        
                  console.log(`ğŸ² Tam Dosya formatÄ±nda rastgele yarÄ±yÄ±l sonu deÄŸerlendirme oluÅŸturuluyor (${activityCount} etkinlik, ${componentCount} alt bileÅŸen)...`);
        
        generateTamDosyaFinalAssessmentWithParams(activityCount, componentCount, activityType);
        
    } catch (error) {
        console.error('âŒ V5 rastgele yarÄ±yÄ±l sonu deÄŸerlendirme oluÅŸturulurken hata:', error);
        showModernToast('V5 rastgele yarÄ±yÄ±l sonu deÄŸerlendirme oluÅŸturulamadÄ±!', 'error');
    }
}

/**
 * Parametreli rastgele deÄŸerlendirme oluÅŸturucu
 */
function generateRandomAssessmentWithParams(isTermActivity, componentCount, activityType = 'random') {
    try {
        // JSON dosyasÄ±ndan gelen gerÃ§ek etkinlik tÃ¼rleri ve Ã¶zellikler
        const activityTypeMap = {
            // YarÄ±yÄ±l Ä°Ã§i Etkinlikler
            'Ara SÄ±nav': { weight: [25, 35], points: 100, hasSubItems: true, subTypes: ['Soru'] },
            'Laboratuvar SÄ±navÄ±': { weight: [15, 25], points: 100, hasSubItems: true, subTypes: ['Soru'] },
            'Deney': { weight: [10, 20], points: 100, hasSubItems: true, subTypes: ['Rubrik'] },
            'Deney SonrasÄ± Quiz': { weight: [5, 15], points: 100, hasSubItems: true, subTypes: ['Soru'] },
            'Performans': { weight: [15, 25], points: 100, hasSubItems: true, subTypes: ['Rubrik'] },
            'Quiz': { weight: [5, 15], points: 100, hasSubItems: true, subTypes: ['Soru'] },
            'Rapor': { weight: [15, 25], points: 100, hasSubItems: true, subTypes: ['Rubrik'] },
            'Rapor Sunma': { weight: [10, 20], points: 100, hasSubItems: true, subTypes: ['Rubrik'] },
            'Makale Kritik Etme': { weight: [10, 20], points: 100, hasSubItems: true, subTypes: ['Rubrik'] },
            'Makale Yazma': { weight: [15, 25], points: 100, hasSubItems: true, subTypes: ['Rubrik'] },
            'Proje HazÄ±rlama': { weight: [20, 30], points: 100, hasSubItems: true, subTypes: ['Rubrik'] },
            'Proje Sunma': { weight: [15, 25], points: 100, hasSubItems: true, subTypes: ['Rubrik'] },
            'Rehberli Problem Ã‡Ã¶zÃ¼mÃ¼': { weight: [10, 20], points: 100, hasSubItems: true, subTypes: ['Soru'] },
            'Seminer': { weight: [10, 20], points: 100, hasSubItems: true, subTypes: ['Rubrik'] },
            'SÃ¶zlÃ¼ SÄ±nav': { weight: [15, 25], points: 100, hasSubItems: true, subTypes: ['Soru'] },
            'Ã–dev Problemleri Ä°Ã§in Ã‡alÄ±ÅŸma': { weight: [10, 20], points: 100, hasSubItems: true, subTypes: ['Rubrik'] },
            'Proje TasarÄ±mÄ±/YÃ¶netimi': { weight: [20, 30], points: 100, hasSubItems: true, subTypes: ['Rubrik'] },
            
            // YarÄ±yÄ±l Sonu Etkinlikler
            'Final SÄ±navÄ±': { weight: [80, 100], points: 100, hasSubItems: true, subTypes: ['Soru'] },
            'Laboratuvar Ara SÄ±navÄ±': { weight: [70, 90], points: 100, hasSubItems: true, subTypes: ['Soru'] },
            'GÃ¶zlem': { weight: [60, 80], points: 100, hasSubItems: true, subTypes: ['Rubrik'] }
        };
        
        // GerÃ§ekÃ§i deÄŸerlendirme tÃ¼rleri - JSON'dan gelen listeler
        const realisticTypes = {
            term: [
                'Ara SÄ±nav', 'Laboratuvar SÄ±navÄ±', 'Deney', 'Deney SonrasÄ± Quiz', 'Performans', 
                'Quiz', 'Rapor', 'Rapor Sunma', 'Makale Kritik Etme', 'Makale Yazma', 
                'Proje HazÄ±rlama', 'Proje Sunma', 'Rehberli Problem Ã‡Ã¶zÃ¼mÃ¼', 'Seminer', 
                'SÃ¶zlÃ¼ SÄ±nav', 'Ã–dev Problemleri Ä°Ã§in Ã‡alÄ±ÅŸma', 'Proje TasarÄ±mÄ±/YÃ¶netimi'
            ],
            final: [
                'Final SÄ±navÄ±', 'Laboratuvar Ara SÄ±navÄ±', 'Makale Yazma', 'Proje HazÄ±rlama', 
                'Proje Sunma', 'Proje TasarÄ±mÄ±/YÃ¶netimi', 'Quiz', 'Rapor', 'Rapor HazÄ±rlama', 
                'Rapor Sunma', 'Seminer', 'SÃ¶zlÃ¼ SÄ±nav', 'GÃ¶zlem'
            ]
        };
        
        let selectedActivityType;
        if (activityType === 'random') {
            // Rastgele seÃ§im
        const availableTypes = isTermActivity ? realisticTypes.term : realisticTypes.final;
            selectedActivityType = availableTypes[Math.floor(Math.random() * availableTypes.length)];
        } else {
            // KullanÄ±cÄ±nÄ±n seÃ§tiÄŸi tÃ¼r
            selectedActivityType = activityType;
        }
        
        const randomTypeInfo = {
            name: selectedActivityType,
            ...activityTypeMap[selectedActivityType]
        };
        
        // Mevcut aktiviteleri say ve doÄŸru ID formatÄ±nÄ± oluÅŸtur
        const existingActivities = APP_STATE.assessmentTree.filter(node => 
            isTermActivity ? node.id.startsWith('A') : node.id.startsWith('F')
        );
        const nextNumber = existingActivities.length + 1;
        const newId = isTermActivity ? `A${nextNumber}` : `F${nextNumber}`;
        
        // Mevcut Ã¶ÄŸrenme Ã§Ä±ktÄ±larÄ±nÄ± kullan (varsa)
        let selectedOutcomes = [];
        if (APP_STATE.learningOutcomes && APP_STATE.learningOutcomes.length > 0) {
            const numOutcomes = Math.floor(Math.random() * 3) + 1; // 1-3 arasÄ±
            const shuffledOutcomes = [...APP_STATE.learningOutcomes].sort(() => Math.random() - 0.5);
            selectedOutcomes = shuffledOutcomes.slice(0, numOutcomes).map(outcome => outcome.id);
        } else {
            // VarsayÄ±lan Ã¶ÄŸrenme Ã§Ä±ktÄ±larÄ± (gerÃ§ekÃ§i)
            const defaultOutcomes = ['Ã–Ã‡.1', 'Ã–Ã‡.2', 'Ã–Ã‡.3', 'Ã–Ã‡.4', 'Ã–Ã‡.5', 'Ã–Ã‡.6'];
            const numOutcomes = Math.floor(Math.random() * 3) + 2; // 2-4 arasÄ±
            const shuffledOutcomes = [...defaultOutcomes].sort(() => Math.random() - 0.5);
            selectedOutcomes = shuffledOutcomes.slice(0, numOutcomes);
        }
        
        // GerÃ§ekÃ§i aÄŸÄ±rlÄ±k ve puan hesaplama
        const weightRange = randomTypeInfo.weight;
        const weight = Math.floor(Math.random() * (weightRange[1] - weightRange[0] + 1)) + weightRange[0];
        
        let points;
        if (Array.isArray(randomTypeInfo.points)) {
            points = Math.floor(Math.random() * (randomTypeInfo.points[1] - randomTypeInfo.points[0] + 1)) + randomTypeInfo.points[0];
        } else {
            points = randomTypeInfo.points;
        }
        
        console.log(`  ğŸ“‹ ${randomTypeInfo.name} oluÅŸturuluyor - AÄŸÄ±rlÄ±k: ${weight}%, Puan: ${points}`);
        
        // Yeni aktivite oluÅŸtur - mevcut sistem formatÄ±nda
        const newActivity = {
            id: newId,
            name: randomTypeInfo.name,
            type: randomTypeInfo.name,
            weight: weight,
            points: points,
            outcomes: selectedOutcomes,
            description: isTermActivity ? 
                `YarÄ±yÄ±l iÃ§i ${randomTypeInfo.name.toLowerCase()} deÄŸerlendirmesi` : 
                `YarÄ±yÄ±l sonu ${randomTypeInfo.name.toLowerCase()} deÄŸerlendirmesi`,
            expanded: true,
            children: []
        };
        
        // Alt bileÅŸenler ekle - kullanÄ±cÄ±nÄ±n belirlediÄŸi sayÄ±da
        if (randomTypeInfo.hasSubItems && componentCount > 0) {
            let subTypes = randomTypeInfo.subTypes;
            
            console.log(`    ğŸ”¹ ${componentCount} alt bileÅŸen ekleniyor...`);
            
            // DÃœZELTME: AkÄ±llÄ± puan daÄŸÄ±lÄ±mÄ± - toplam 100 olacak ÅŸekilde
            const basePoints = Math.floor(points / componentCount);
            const remainder = points - (basePoints * componentCount);
            
            // DÃœZELTME: AkÄ±llÄ± aÄŸÄ±rlÄ±k daÄŸÄ±lÄ±mÄ± - toplam 100 olacak ÅŸekilde
            const baseWeight = Math.floor(100 / componentCount);
            const weightRemainder = 100 - (baseWeight * componentCount);
            
            for (let i = 0; i < componentCount; i++) {
                // Alt bileÅŸen tÃ¼rÃ¼nÃ¼ gerÃ§ekÃ§i ÅŸekilde seÃ§
                const subType = subTypes[Math.floor(Math.random() * subTypes.length)];
                
                // GerÃ§ekÃ§i alt bileÅŸen isimleri
                let subName;
                if (subType === 'Soru') {
                    const questionTypes = ['Ã‡oktan SeÃ§meli', 'AÃ§Ä±k UÃ§lu', 'KÄ±sa CevaplÄ±', 'Problem', 'Analiz'];
                    subName = `${questionTypes[Math.floor(Math.random() * questionTypes.length)]} Soru ${i + 1}`;
                } else if (subType === 'Test') {
                    subName = `Test BÃ¶lÃ¼mÃ¼ ${i + 1}`;
                } else if (subType === 'Rubrik') {
                    const rubricTypes = ['DeÄŸerlendirme', 'Analiz', 'Sunum', 'Rapor', 'Kod Kalitesi'];
                    subName = `${rubricTypes[Math.floor(Math.random() * rubricTypes.length)]} RubriÄŸi`;
                } else {
                    subName = `${subType} ${i + 1}`;
                }
                
                // DÃœZELTME: Kalan puanlarÄ± ve aÄŸÄ±rlÄ±klarÄ± ilk bileÅŸenlere daÄŸÄ±t
                const componentPoints = basePoints + (i < remainder ? 1 : 0);
                const componentWeight = baseWeight + (i < weightRemainder ? 1 : 0);
                
                const subItem = {
                    id: `${newId}.${i + 1}`,
                    name: subName,
                    type: subType,
                    weight: componentWeight,
                    points: componentPoints,
                    outcomes: selectedOutcomes.length > 0 ? 
                        [selectedOutcomes[Math.floor(Math.random() * selectedOutcomes.length)]] : [],
                    description: `${subName} iÃ§in deÄŸerlendirme kriteri`,
                    expanded: false,
                    children: []
                };
                
                // Test iÃ§in gerÃ§ekÃ§i detaylar ekle
                if (subType === 'Test') {
                    const questionCount = Math.floor(Math.random() * 20) + 10; // 10-30 soru
                    subItem.testDetails = {
                        totalQuestions: questionCount,
                        correctWeight: Math.floor(Math.random() * 3) + 3, // 3-5 puan
                        wrongPenalty: -(Math.floor(Math.random() * 2) + 1) // -1 veya -2 puan
                    };
                    console.log(`      ğŸ§ª Test: ${questionCount} soru, +${subItem.testDetails.correctWeight}/${subItem.testDetails.wrongPenalty} puan`);
                }
                
                newActivity.children.push(subItem);
                console.log(`      âœ… ${subName} (${subItem.points} puan)`);
            }
            
            // DOÄRULAMA: Toplam puan ve aÄŸÄ±rlÄ±k kontrolÃ¼
            const finalTotalPoints = newActivity.children.reduce((sum, child) => sum + child.points, 0);
            const finalTotalWeight = newActivity.children.reduce((sum, child) => sum + child.weight, 0);
            
            console.log(`    ğŸ“Š Toplam Puan: ${finalTotalPoints}/${points}, Toplam AÄŸÄ±rlÄ±k: ${finalTotalWeight}%`);
            
            if (finalTotalPoints !== points) {
                console.warn(`âš ï¸ Puan uyumsuzluÄŸu dÃ¼zeltiliyor: ${finalTotalPoints} â†’ ${points}`);
                // Son bileÅŸenin puanÄ±nÄ± ayarla
                const lastChild = newActivity.children[newActivity.children.length - 1];
                lastChild.points += (points - finalTotalPoints);
            }
            if (finalTotalWeight !== 100) {
                console.warn(`âš ï¸ AÄŸÄ±rlÄ±k uyumsuzluÄŸu dÃ¼zeltiliyor: ${finalTotalWeight} â†’ 100`);
                // Son bileÅŸenin aÄŸÄ±rlÄ±ÄŸÄ±nÄ± ayarla
                const lastChild = newActivity.children[newActivity.children.length - 1];
                lastChild.weight += (100 - finalTotalWeight);
            }
        }
        
        // Assessment tree'ye doÄŸru sÄ±rada ekle
        if (isTermActivity) {
            // YarÄ±yÄ±l iÃ§i etkinlikleri baÅŸa ekle
            const termActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('A'));
            const finalActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('F'));
            termActivities.push(newActivity);
            APP_STATE.assessmentTree = [...termActivities, ...finalActivities];
        } else {
            // YarÄ±yÄ±l sonu etkinlikleri sona ekle
            APP_STATE.assessmentTree.push(newActivity);
        }
        
        // SeÃ§ili dÃ¼ÄŸÃ¼mÃ¼ yeni aktivite yap
        selectNode(newActivity);
        
        // ArayÃ¼zÃ¼ gÃ¼ncelle
        renderTree();
        updateCategoryWeights();
        updateAssessmentView();
        // updateGroupMappingDisplay(); // Bu fonksiyon ÅŸu an mevcut deÄŸil, gerekirse eklenecek
        
        const activityTypeText = isTermActivity ? 'yarÄ±yÄ±l iÃ§i' : 'yarÄ±yÄ±l sonu';
        console.log(`âœ… Rastgele ${activityTypeText} deÄŸerlendirme oluÅŸturuldu: ${newActivity.name}`);
        
        return true; // BaÅŸarÄ± durumunu dÃ¶ndÃ¼r
        
    } catch (error) {
        console.error('âŒ Rastgele deÄŸerlendirme oluÅŸturulurken hata:', error);
        throw error; // HatayÄ± Ã¼st fonksiyona aktar
    }
}

/**
 * Ã‡oklu rastgele yarÄ±yÄ±l iÃ§i etkinlik oluÅŸturur (Onay ile)
 */
function generateMultipleRandomTermAssessments() {
    // Mevcut verileri kontrol et
    const hasExistingData = APP_STATE.assessmentTree && APP_STATE.assessmentTree.length > 0;
    const activityCount = parseInt(document.getElementById('termActivityCountSlider').value) || 2;
    const componentCount = parseInt(document.getElementById('termComponentsSlider').value) || 3;
    const activityType = document.getElementById('termActivityTypeSelect').value;
    
    const warningMessage = hasExistingData 
        ? `Bu iÅŸlem mevcut ${APP_STATE.assessmentTree.length} deÄŸerlendirme bileÅŸenine ${activityCount} yeni yarÄ±yÄ±l iÃ§i etkinlik ekleyecek. Her etkinlikte ${componentCount} soru/rubrik olacak.\n\nDevam etmek istediÄŸinizden emin misiniz?`
        : `${activityCount} adet yarÄ±yÄ±l iÃ§i etkinlik oluÅŸturulacak (her birinde ${componentCount} soru/rubrik, tÃ¼r: ${activityType}).\n\nBu iÅŸlem geri alÄ±namaz. Devam etmek istediÄŸinizden emin misiniz?`;
    
    showModernConfirm('â­ YarÄ±yÄ±l Ä°Ã§i Etkinlik OluÅŸtur', warningMessage, {
            confirmText: 'Evet, OluÅŸtur',
            cancelText: 'Ä°ptal',
        confirmClass: 'btn-modern-primary',
        cancelClass: 'btn-modern-secondary'
    }).then(() => {
        executeGenerateMultipleRandomTermAssessments();
    });
}

/**
 * Ã‡oklu rastgele yarÄ±yÄ±l iÃ§i etkinlik oluÅŸturur (GerÃ§ek iÅŸlem)
 */
function executeGenerateMultipleRandomTermAssessments() {
    try {
        const activityCount = parseInt(document.getElementById('termActivityCountSlider').value) || 2;
        const componentCount = parseInt(document.getElementById('termComponentsSlider').value) || 3;
        const activityType = document.getElementById('termActivityTypeSelect').value;
        
        console.log(`ğŸ² ${activityCount} adet yarÄ±yÄ±l iÃ§i etkinlik oluÅŸturuluyor (TÃ¼r: ${activityType}, her birinde ${componentCount} alt bileÅŸen)...`);
        
        let successCount = 0;
        
        // Tam Dosya formatÄ±nda tek seferde Ã§oklu etkinlik oluÅŸtur
        try {
            generateTamDosyaTermAssessmentWithParams(activityCount, componentCount, activityType);
            successCount = activityCount;
                          console.log(`âœ… ${activityCount} yarÄ±yÄ±l iÃ§i etkinlik Tam Dosya formatÄ±nda oluÅŸturuldu`);
            } catch (error) {
                          console.error(`âŒ Tam Dosya yarÄ±yÄ±l iÃ§i etkinlikler oluÅŸturulurken hata:`, error);
        }
        
        // Tam Dosya formatÄ±nda aÄŸÄ±rlÄ±klar otomatik normalize edilir
        
        if (successCount === activityCount) {
            showModernToast(`ğŸ‰ ${activityCount} adet yarÄ±yÄ±l iÃ§i etkinlik baÅŸarÄ±yla oluÅŸturuldu! (Her birinde ${componentCount} soru/rubrik)`, 'success', 4000);
        } else if (successCount > 0) {
            showModernToast(`âš ï¸ ${successCount}/${activityCount} yarÄ±yÄ±l iÃ§i etkinlik oluÅŸturuldu. BazÄ± etkinlikler oluÅŸturulamadÄ±.`, 'warning', 4000);
        } else {
            showModernToast('âŒ YarÄ±yÄ±l iÃ§i etkinlik oluÅŸturulamadÄ±!', 'error', 4000);
        }
        
    } catch (error) {
        console.error('âŒ Ã‡oklu yarÄ±yÄ±l iÃ§i etkinlik oluÅŸturulurken hata:', error);
        showModernToast('Ã‡oklu yarÄ±yÄ±l iÃ§i etkinlik oluÅŸturulamadÄ±!', 'error');
    }
}

/**
 * Ã‡oklu rastgele yarÄ±yÄ±l sonu etkinlik oluÅŸturur (Onay ile)
 */
function generateMultipleRandomFinalAssessments() {
    // Mevcut verileri kontrol et
    const hasExistingData = APP_STATE.assessmentTree && APP_STATE.assessmentTree.length > 0;
    const activityCount = parseInt(document.getElementById('finalActivityCountSlider').value) || 1;
    const componentCount = parseInt(document.getElementById('finalComponentsSlider').value) || 5;
    const activityType = document.getElementById('finalActivityTypeSelect').value;
    
    const warningMessage = hasExistingData 
        ? `Bu iÅŸlem mevcut ${APP_STATE.assessmentTree.length} deÄŸerlendirme bileÅŸenine ${activityCount} yeni yarÄ±yÄ±l sonu etkinlik ekleyecek. Her etkinlikte ${componentCount} soru/rubrik olacak.\n\nDevam etmek istediÄŸinizden emin misiniz?`
        : `${activityCount} adet yarÄ±yÄ±l sonu etkinlik oluÅŸturulacak (her birinde ${componentCount} soru/rubrik, tÃ¼r: ${activityType}).\n\nBu iÅŸlem geri alÄ±namaz. Devam etmek istediÄŸinizden emin misiniz?`;
    
    showModernConfirm('ğŸ¯ YarÄ±yÄ±l Sonu Etkinlik OluÅŸtur', warningMessage, {
            confirmText: 'Evet, OluÅŸtur',
            cancelText: 'Ä°ptal',
        confirmClass: 'btn-modern-success',
        cancelClass: 'btn-modern-secondary'
    }).then(() => {
        executeGenerateMultipleRandomFinalAssessments();
    });
}

/**
 * Ã‡oklu rastgele yarÄ±yÄ±l sonu etkinlik oluÅŸturur (GerÃ§ek iÅŸlem)
 */
function executeGenerateMultipleRandomFinalAssessments() {
    try {
        const activityCount = parseInt(document.getElementById('finalActivityCountSlider').value) || 1;
        const componentCount = parseInt(document.getElementById('finalComponentsSlider').value) || 5;
        const activityType = document.getElementById('finalActivityTypeSelect').value;
        
        console.log(`ğŸ² ${activityCount} adet yarÄ±yÄ±l sonu etkinlik oluÅŸturuluyor (TÃ¼r: ${activityType}, her birinde ${componentCount} alt bileÅŸen)...`);
        
        let successCount = 0;
        
        // Tam Dosya formatÄ±nda tek seferde Ã§oklu etkinlik oluÅŸtur
        try {
            generateTamDosyaFinalAssessmentWithParams(activityCount, componentCount, activityType);
            successCount = activityCount;
                          console.log(`âœ… ${activityCount} yarÄ±yÄ±l sonu etkinlik Tam Dosya formatÄ±nda oluÅŸturuldu`);
            } catch (error) {
                          console.error(`âŒ Tam Dosya yarÄ±yÄ±l sonu etkinlikler oluÅŸturulurken hata:`, error);
        }
        
        // Tam Dosya formatÄ±nda aÄŸÄ±rlÄ±klar otomatik normalize edilir
        
        if (successCount === activityCount) {
            showModernToast(`ğŸ‰ ${activityCount} adet yarÄ±yÄ±l sonu etkinlik baÅŸarÄ±yla oluÅŸturuldu! (Her birinde ${componentCount} soru/rubrik)`, 'success', 4000);
        } else if (successCount > 0) {
            showModernToast(`âš ï¸ ${successCount}/${activityCount} yarÄ±yÄ±l sonu etkinlik oluÅŸturuldu. BazÄ± etkinlikler oluÅŸturulamadÄ±.`, 'warning', 4000);
        } else {
            showModernToast('âŒ YarÄ±yÄ±l sonu etkinlik oluÅŸturulamadÄ±!', 'error', 4000);
        }
        
    } catch (error) {
        console.error('âŒ Ã‡oklu yarÄ±yÄ±l sonu etkinlik oluÅŸturulurken hata:', error);
        showModernToast('Ã‡oklu yarÄ±yÄ±l sonu etkinlik oluÅŸturulamadÄ±!', 'error');
    }
}

/**
 * Dual range slider uyarÄ± mesajÄ±nÄ± gÃ¼nceller
 */
function updateDualRangeWarning(minGroups, maxGroups) {
    const warningDiv = document.getElementById('groupsWarning');
    const warningText = document.getElementById('groupsWarningText');
    
    if (!warningDiv || !warningText) return;
    
    const studentCount = APP_STATE.studentData ? APP_STATE.studentData.length : 0;
    
    if (studentCount === 0) {
        // Ã–ÄŸrenci yoksa uyarÄ± gÃ¶sterme
        warningDiv.style.display = 'none';
        return;
    }
    
    if (minGroups > studentCount) {
        // Minimum grup sayÄ±sÄ± bile Ã¶ÄŸrenci sayÄ±sÄ±ndan fazlaysa kritik uyarÄ±
        warningText.textContent = `âš ï¸ Minimum ${minGroups} grup seÃ§ildi ancak sadece ${studentCount} Ã¶ÄŸrenci var. Maksimum ${studentCount} grup oluÅŸturulabilir.`;
        warningDiv.style.display = 'flex';
    } else if (maxGroups > studentCount) {
        // Maksimum grup sayÄ±sÄ± Ã¶ÄŸrenci sayÄ±sÄ±ndan fazlaysa uyarÄ±
        warningText.textContent = `âš ï¸ Maksimum ${maxGroups} grup seÃ§ildi ancak sadece ${studentCount} Ã¶ÄŸrenci var. En fazla ${studentCount} grup oluÅŸturulacak.`;
        warningDiv.style.display = 'flex';
    } else if (maxGroups > Math.ceil(studentCount / 2)) {
        // Ã–nerilen maksimum grup sayÄ±sÄ±ndan fazlaysa bilgi ver
        const recommended = Math.ceil(studentCount / 2);
        warningText.textContent = `ğŸ’¡ ${studentCount} Ã¶ÄŸrenci iÃ§in Ã¶nerilen maksimum grup sayÄ±sÄ±: ${recommended}. Her grupta en az 2 Ã¶ÄŸrenci olmasÄ± Ã¶nerilir.`;
        warningDiv.style.display = 'flex';
    } else {
        // Normal durumda uyarÄ± gÃ¶sterme
        warningDiv.style.display = 'none';
    }
}

/**
 * Slider kontrollerini baÅŸlatÄ±r
 */
/**
 * Initialize thermal slider functionality
 */
function initializeThermalSliders() {
    const thermalSliders = document.querySelectorAll('.thermal-slider, .thermal-range-slider');
    
    thermalSliders.forEach(slider => {
        const thermalType = slider.getAttribute('data-thermal');
        
        // Set initial thermal color
        updateThermalSliderColor(slider, slider.value, thermalType);
        
        // Update color on change
        slider.addEventListener('input', function() {
            updateThermalSliderColor(this, this.value, thermalType);
        });
    });
}

/**
 * Update thermal slider color based on value
 */
function updateThermalSliderColor(slider, value, thermalType) {
    const thumb = slider;
    let color;
    
    switch(thermalType) {
        case 'term':
            // Blue gradient based on complexity (1-8)
            const termPercent = (value - 1) / 7; // 0 to 1
            color = interpolateColor('#3b82f6', '#1e40af', termPercent);
            break;
            
        case 'final':
            // Green gradient based on complexity (1-10)
            const finalPercent = (value - 1) / 9;
            color = interpolateColor('#10b981', '#065f46', finalPercent);
            break;
            
        case 'scoring':
            // Amber/Red gradient based on pass rate (0-100)
            const scoringPercent = value / 100;
            if (scoringPercent < 0.5) {
                color = interpolateColor('#ef4444', '#f59e0b', scoringPercent * 2);
            } else {
                color = interpolateColor('#f59e0b', '#10b981', (scoringPercent - 0.5) * 2);
            }
            break;
            

            
        case 'group-min':
            color = '#10b981'; // Green for min
            break;
            
        case 'group-max':
            color = '#ef4444'; // Red for max
            break;
            
        default:
            color = '#3b82f6';
    }
    
    // Apply color to slider thumb
    const style = document.createElement('style');
    style.textContent = `
        .thermal-slider[data-thermal="${thermalType}"]::-webkit-slider-thumb,
        .thermal-range-slider[data-thermal="${thermalType}"]::-webkit-slider-thumb {
            border-color: ${color} !important;
        }
        .thermal-slider[data-thermal="${thermalType}"]::-moz-range-thumb,
        .thermal-range-slider[data-thermal="${thermalType}"]::-moz-range-thumb {
            border-color: ${color} !important;
        }
    `;
    
    // Remove old style if exists
    const oldStyle = document.querySelector(`style[data-thermal="${thermalType}"]`);
    if (oldStyle) {
        oldStyle.remove();
    }
    
    style.setAttribute('data-thermal', thermalType);
    document.head.appendChild(style);
}

/**
 * Interpolate between two hex colors
 */
function interpolateColor(color1, color2, factor) {
    const c1 = hexToRgb(color1);
    const c2 = hexToRgb(color2);
    
    const r = Math.round(c1.r + (c2.r - c1.r) * factor);
    const g = Math.round(c1.g + (c2.g - c1.g) * factor);
    const b = Math.round(c1.b + (c2.b - c1.b) * factor);
    
    return `rgb(${r}, ${g}, ${b})`;
}

/**
 * Convert hex to RGB
 */
function hexToRgb(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
    } : null;
}

/**
 * Initialize group and scoring controls
 */
function initializeGroupControls() {
    // Pass Rate slider
    const passRateSlider = document.getElementById('passRateSlider');
    if (passRateSlider) {
        passRateSlider.addEventListener('input', function() {
            updatePassRateIndicators();
        });
    }
    
    // Update student and group counts
    updateGroupStatistics();
    
    // Update pass rate indicators
    updatePassRateIndicators();
}

/**
 * Update pass rate indicators in the UI
 */
function updatePassRateIndicators() {
    try {
        const passRateSlider = document.getElementById('passRateSlider');
        const passRateValue = document.getElementById('passRateValue');
        const rateIndicators = document.querySelectorAll('.rate-indicator');
        
        if (passRateSlider && passRateValue) {
            const passRate = parseInt(passRateSlider.value);
            const failRate = 100 - passRate;
            
            passRateValue.textContent = `${passRate}%`;
            
            // Calculate actual pass/fail counts if student data exists
            const studentCount = APP_STATE.studentData?.length || 0;
            let actualPassCount = 0;
            let actualFailCount = 0;
            
            if (studentCount > 0 && APP_STATE.gradesData) {
                // Count actual passing/failing students based on letter grades
                APP_STATE.studentData.forEach(student => {
                    const studentGrades = APP_STATE.gradesData[student.studentId];
                    if (studentGrades && studentGrades.harfNotu) {
                        const letterGrade = studentGrades.harfNotu;
                        // AA, BA, BB, CB, CC, DC = passing, DD, FD, FF = failing
                        const passingGrades = ['AA', 'BA', 'BB', 'CB', 'CC', 'DC'];
                        if (passingGrades.includes(letterGrade)) {
                            actualPassCount++;
                        } else {
                            actualFailCount++;
                        }
                    }
                });
            }
            
            // Update rate indicators with actual or estimated counts
            rateIndicators.forEach(indicator => {
                if (indicator.classList.contains('pass')) {
                    if (actualPassCount > 0) {
                        const actualPassRate = Math.round((actualPassCount / studentCount) * 100);
                        indicator.innerHTML = `GeÃ§en: <strong>${actualPassCount} (${actualPassRate}%)</strong>`;
                    } else {
                        const estimatedPassCount = Math.round((passRate / 100) * studentCount);
                        indicator.innerHTML = `GeÃ§en: <strong>~${estimatedPassCount} (${passRate}%)</strong>`;
                    }
                } else if (indicator.classList.contains('fail')) {
                    if (actualFailCount > 0) {
                        const actualFailRate = Math.round((actualFailCount / studentCount) * 100);
                        indicator.innerHTML = `Kalan: <strong>${actualFailCount} (${actualFailRate}%)</strong>`;
                    } else {
                        const estimatedFailCount = Math.round((failRate / 100) * studentCount);
                        indicator.innerHTML = `Kalan: <strong>~${estimatedFailCount} (${failRate}%)</strong>`;
                    }
                }
            });
            
            // AyrÄ±ca status badge'leri de gÃ¼ncelle
            const passRateDisplay = document.getElementById('passRateDisplay');
            const failRateDisplay = document.getElementById('failRateDisplay');
            
            if (passRateDisplay) {
                if (actualPassCount > 0) {
                    const actualPassRate = Math.round((actualPassCount / studentCount) * 100);
                    passRateDisplay.textContent = `${actualPassCount} (${actualPassRate}%)`;
                } else {
                    const estimatedPassCount = Math.round((passRate / 100) * studentCount);
                    passRateDisplay.textContent = `${estimatedPassCount} (${passRate}%)`;
                }
            }
            
            if (failRateDisplay) {
                if (actualFailCount > 0) {
                    const actualFailRate = Math.round((actualFailCount / studentCount) * 100);
                    failRateDisplay.textContent = `${actualFailCount} (${actualFailRate}%)`;
                } else {
                    const estimatedFailCount = Math.round((failRate / 100) * studentCount);
                    failRateDisplay.textContent = `${estimatedFailCount} (${failRate}%)`;
                }
            }
            
            // Update thermal color
            updateThermalSliderColor(passRateSlider, passRate, 'scoring');
        }
        
    } catch (error) {
        console.error("Pass rate indicators gÃ¼ncelleme hatasÄ±:", error);
    }
}

/**
 * Update group statistics display
 */
function updateGroupStatistics() {
    try {
        const totalStudentsCount = document.getElementById('totalStudentsCount');
        const activeGroupsCount = document.getElementById('activeGroupsCount');
        
        if (totalStudentsCount) {
            const studentCount = APP_STATE.studentData?.length || 0;
            totalStudentsCount.textContent = studentCount;
        }
        
        if (activeGroupsCount) {
            // Count unique groups across all components
            const uniqueGroups = new Set();
            if (APP_STATE.courseData?.grupHaritalari) {
                Object.values(APP_STATE.courseData.grupHaritalari).forEach(component => {
                    if (component.gruplar && component.gruplar.length > 0) {
                        component.gruplar.forEach(group => uniqueGroups.add(group));
                    }
                });
            }
            activeGroupsCount.textContent = uniqueGroups.size;
        }
        
        // Update pass/fail indicators based on current data
        updatePassRateIndicators();
        
    } catch (error) {
        console.error("Grup istatistikleri gÃ¼ncelleme hatasÄ±:", error);
    }
}

function initializeAssessmentSliders() {
    // Initialize thermal slider update functionality
    initializeThermalSliders();
    
    // Initialize new group controls
    initializeGroupControls();
    
    // Initialize separate range sliders (enhanced dual range system)
    initializeSeparateRangeSliders();
    
    // YarÄ±yÄ±l iÃ§i slider (compact version)
    const termSlider = document.getElementById('termComponentsSlider');
    const termValue = document.getElementById('termComponentsValue');
    
    if (termSlider && termValue) {
        termSlider.addEventListener('input', function() {
            termValue.textContent = this.value;
            // Update thermal color for compact range
            updateCompactRangeColor(termSlider, this.value, 'term');
        });
    }
    
    // YarÄ±yÄ±l sonu slider (compact version)
    const finalSlider = document.getElementById('finalComponentsSlider');
    const finalValue = document.getElementById('finalComponentsValue');
    
    if (finalSlider && finalValue) {
        finalSlider.addEventListener('input', function() {
            finalValue.textContent = this.value;
            // Update thermal color for compact range
            updateCompactRangeColor(finalSlider, this.value, 'final');
        });
    }
    
    // Pass rate slider (compact version)
    const passRateSlider = document.getElementById('passRateSlider');
    const passRateValue = document.getElementById('passRateValue');
    const passRateDisplay = document.getElementById('passRateDisplay');
    const failRateDisplay = document.getElementById('failRateDisplay');
    
    if (passRateSlider && passRateValue) {
        passRateSlider.addEventListener('input', function() {
            const value = parseInt(this.value);
            const failValue = 100 - value;
            
            // TÃ¼m display'leri gÃ¼ncelle
            passRateValue.textContent = `${value}%`;
            if (passRateDisplay) passRateDisplay.textContent = `${value}%`;
            if (failRateDisplay) failRateDisplay.textContent = `${failValue}%`;
            
            updateCompactRangeColor(passRateSlider, value, 'scoring');
            updatePassRateIndicators();
        });
    }
    
    // Dual range slider'Ä±nÄ± baÅŸlat (backwards compatibility)
    initializeDualRangeSlider();
}

/**
 * Dual range slider'Ä±nÄ± baÅŸlatÄ±r ve yÃ¶netir
 */
function initializeDualRangeSlider() {
    const minSlider = document.getElementById('groupMinSlider');
    const maxSlider = document.getElementById('groupMaxSlider');
    const minValue = document.getElementById('groupMinValue');
    const maxValue = document.getElementById('groupMaxValue');
    const sliderRange = document.getElementById('sliderRange');

    if (!minSlider || !maxSlider || !minValue || !maxValue || !sliderRange) return;

    function updateSliderRange() {
        let min = parseInt(minSlider.value);
        let max = parseInt(maxSlider.value);
        
        // Min > Max olmasÄ±nÄ± engelle, ama min = max'e izin ver
        if (min > max) {
            if (minSlider === document.activeElement) {
                max = min;
                maxSlider.value = max;
            } else {
                min = max;
                minSlider.value = min;
            }
        }
        
        minValue.textContent = min;
        maxValue.textContent = max;

        // GÃ¶rsel range gÃ¼ncelle (1-20 aralÄ±ÄŸÄ± iÃ§in)
        const percent1 = ((min - 1) / 19) * 100;
        const percent2 = ((max - 1) / 19) * 100;
        
        // Hem eski hem yeni slider sistemlerini destekle
        if (sliderRange) {
            sliderRange.style.left = percent1 + '%';
            sliderRange.style.width = (percent2 - percent1) + '%';
        }
        
        // Compact slider range iÃ§in de gÃ¼ncelle
        const compactSliderRange = document.querySelector('.compact-slider-range');
        if (compactSliderRange) {
            compactSliderRange.style.left = percent1 + '%';
            compactSliderRange.style.width = (percent2 - percent1) + '%';
        }

        // UyarÄ± kontrol et
        updateDualRangeWarning(min, max);
    }

    minSlider.addEventListener('input', updateSliderRange);
    maxSlider.addEventListener('input', updateSliderRange);
    
    // Ä°lk deÄŸerleri ayarla
    updateSliderRange();
}

// =============================================================================
// ğŸ¯ SEPARATE RANGE SLIDERS - Enhanced Dual Range System
// =============================================================================

/**
 * Initialize separate dual range sliders (enhanced system)
 */
function initializeSeparateRangeSliders() {
    const minSlider = document.getElementById('groupMinSlider');
    const maxSlider = document.getElementById('groupMaxSlider');
    const groupMinDisplay = document.getElementById('groupMinDisplay');
    const groupMaxDisplay = document.getElementById('groupMaxDisplay');
    const groupMinValue = document.getElementById('groupMinValue');
    const groupMaxValue = document.getElementById('groupMaxValue');
    
    if (!minSlider || !maxSlider) return;
    
    function updateSeparateRange() {
        let minVal = parseInt(minSlider.value);
        let maxVal = parseInt(maxSlider.value);
        
        // Auto-adjust logic: min can't be greater than max
        if (minSlider === document.activeElement && minVal > maxVal) {
            // If user is moving min slider and it goes past max, move max too
            maxVal = minVal;
            maxSlider.value = maxVal;
        } else if (maxSlider === document.activeElement && maxVal < minVal) {
            // If user is moving max slider and it goes below min, move min too
            minVal = maxVal;
            minSlider.value = minVal;
        }
        
        // Update all display elements
        if (groupMinDisplay) groupMinDisplay.textContent = minVal;
        if (groupMaxDisplay) groupMaxDisplay.textContent = maxVal;
        if (groupMinValue) groupMinValue.textContent = minVal;
        if (groupMaxValue) groupMaxValue.textContent = maxVal;
        
        // Update thermal colors
        updateThermalSliderColor(minSlider, minVal, 'group-min');
        updateThermalSliderColor(maxSlider, maxVal, 'group-max');
        
        // Update warnings
        updateDualRangeWarning(minVal, maxVal);
    }
    
    // Event listeners
    minSlider.addEventListener('input', updateSeparateRange);
    maxSlider.addEventListener('input', updateSeparateRange);
    
    // Initialize values
    updateSeparateRange();
}

/**
 * Update compact range slider colors based on value
 */
function updateCompactRangeColor(slider, value, type) {
    if (!slider) return;
    
    let color = '#4CAF50'; // Default green
    
    switch (type) {
        case 'term':
            // Blue gradient for term (1-8 range)
            const termFactor = (value - 1) / 7;
            color = interpolateColor('#2196F3', '#1976D2', termFactor);
            break;
            
        case 'final':
            // Green gradient for final (1-10 range)
            const finalFactor = (value - 1) / 9;
            color = interpolateColor('#4CAF50', '#2E7D32', finalFactor);
            break;
            
        case 'scoring':
            // Red to green gradient for scoring (0-100 range)
            const scoreFactor = value / 100;
            if (scoreFactor < 0.5) {
                color = interpolateColor('#F44336', '#FF9800', scoreFactor * 2);
            } else {
                color = interpolateColor('#FF9800', '#4CAF50', (scoreFactor - 0.5) * 2);
            }
            break;
            
        case 'group-min':
            // Cyan gradient for group min (1-20 range)
            const minFactor = (value - 1) / 19;
            color = interpolateColor('#00BCD4', '#0097A7', minFactor);
            break;
            
        case 'group-max':
            // Orange gradient for group max (1-20 range)
            const maxFactor = (value - 1) / 19;
            color = interpolateColor('#FF9800', '#F57C00', maxFactor);
            break;
    }
    
    // Apply color to slider track
    const percent = ((value - slider.min) / (slider.max - slider.min)) * 100;
    slider.style.background = `linear-gradient(to right, ${color} 0%, ${color} ${percent}%, #e0e0e0 ${percent}%, #e0e0e0 100%)`;
}

// =============================================================================
// ğŸ›¡ï¸ GÃœVENLÄ°K FONKSÄ°YONLARI - Eksik fonksiyonlar iÃ§in fallback
// =============================================================================

/**
 * Not gÃ¶rÃ¼nÃ¼mlerini gÃ¼ncelle - Ana fonksiyon
 */
function updateGradeDisplays() {
    try {
        // Ã–ÄŸrenci not tablosunu gÃ¼ncelle
        if (typeof updateStudentGradesTable === 'function') {
            updateStudentGradesTable();
        }
        
        // Genel istatistikleri gÃ¼ncelle
        updateModernStats();
        
        // Not giriÅŸi alanlarÄ±nÄ± gÃ¼ncelle
        const gradeInputs = document.querySelectorAll('input[type="number"][data-student-id]');
        gradeInputs.forEach(input => {
            const studentId = input.dataset.studentId;
            const activityId = input.dataset.activityId; // componentId deÄŸil activityId kullan
            
            if (activityId) {
                const grade = getStudentGrade(studentId, activityId);
                if (grade !== null && grade !== undefined) {
                    input.value = grade;
                }
            }
        });
        
        // Pass/Fail oranlarÄ±nÄ± gÃ¼ncelle
        if (typeof updatePassFailCounts === 'function') {
            updatePassFailCounts();
        }
        
        console.log('âœ… Not gÃ¶rÃ¼nÃ¼mleri gÃ¼ncellendi');
    } catch (error) {
        console.error('âŒ Not gÃ¶rÃ¼nÃ¼mleri gÃ¼ncellenirken hata:', error);
        showModernToast('Not gÃ¶rÃ¼nÃ¼mleri gÃ¼ncellenirken hata oluÅŸtu!', 'error');
    }
}

console.log('ğŸ›¡ï¸ GÃ¼venlik fonksiyonlarÄ± yÃ¼klendi');

// GUID sistemi tamamen kaldÄ±rÄ±ldÄ±

// =============================================================================
// ğŸŒˆ RAINBOW THERMAL SLIDER SYSTEM
// =============================================================================

/**
 * Rainbow thermal slider'larÄ± baÅŸlat
 */
function initializeRainbowSliders() {
    // YarÄ±yÄ±l iÃ§i slider
    const termSlider = document.getElementById('termComponentsSlider');
    const termValue = document.getElementById('termComponentsValue');
    
    if (termSlider && termValue) {
        termSlider.addEventListener('input', function() {
            termValue.textContent = this.value;
            updateRainbowSliderThumb(termSlider, this.value, 'term');
        });
        // Ä°lk deÄŸeri ayarla
        updateRainbowSliderThumb(termSlider, termSlider.value, 'term');
    }
    
    // YarÄ±yÄ±l sonu slider
    const finalSlider = document.getElementById('finalComponentsSlider');
    const finalValue = document.getElementById('finalComponentsValue');
    
    if (finalSlider && finalValue) {
        finalSlider.addEventListener('input', function() {
            finalValue.textContent = this.value;
            updateRainbowSliderThumb(finalSlider, this.value, 'final');
        });
        // Ä°lk deÄŸeri ayarla
        updateRainbowSliderThumb(finalSlider, finalSlider.value, 'final');
    }
    
    // Pass rate slider
    const passRateSlider = document.getElementById('passRateSlider');
    const passRateValue = document.getElementById('passRateValue');
    const passRateDisplay = document.getElementById('passRateDisplay');
    const failRateDisplay = document.getElementById('failRateDisplay');
    
    if (passRateSlider && passRateValue) {
        passRateSlider.addEventListener('input', function() {
            const value = parseInt(this.value);
            const failValue = 100 - value;
            
            // TÃ¼m display'leri gÃ¼ncelle
            passRateValue.textContent = `${value}%`;
            if (passRateDisplay) passRateDisplay.textContent = `${value}%`;
            if (failRateDisplay) failRateDisplay.textContent = `${failValue}%`;
            
            updateRainbowSliderThumb(passRateSlider, value, 'score');
            updatePassRateIndicators();
            updatePassFailCounts(); // Status badge'leri gÃ¼ncelle
        });
        // Ä°lk deÄŸeri ayarla
        updateRainbowSliderThumb(passRateSlider, passRateSlider.value, 'score');
    }
    
    // Grup slider'larÄ± - GeliÅŸtirilmiÅŸ versiyon
    // Term slider'larÄ±
    const termActivityCountSlider = document.getElementById('termActivityCountSlider');
    const termActivityCountValue = document.getElementById('termActivityCountValue');
    const termComponentsSlider = document.getElementById('termComponentsSlider');
    const termComponentsValue = document.getElementById('termComponentsValue');
    
    // Final slider'larÄ±
    const finalActivityCountSlider = document.getElementById('finalActivityCountSlider');
    const finalActivityCountValue = document.getElementById('finalActivityCountValue');
    const finalComponentsSlider = document.getElementById('finalComponentsSlider');
    const finalComponentsValue = document.getElementById('finalComponentsValue');
    
    // Grup slider'larÄ±
    const groupMinSlider = document.getElementById('groupMinSlider');
    const groupMaxSlider = document.getElementById('groupMaxSlider');
    const groupMinValue = document.getElementById('groupMinValue');
    const groupMaxValue = document.getElementById('groupMaxValue');
    
    if (groupMinSlider && groupMinValue && groupMaxSlider && groupMaxValue) {
        // Ã–nceki event listener'larÄ± temizle
        const newMinSlider = groupMinSlider.cloneNode(true);
        const newMaxSlider = groupMaxSlider.cloneNode(true);
        groupMinSlider.parentNode.replaceChild(newMinSlider, groupMinSlider);
        groupMaxSlider.parentNode.replaceChild(newMaxSlider, groupMaxSlider);
        
        // Yeni referanslarÄ± al
        const minSlider = document.getElementById('groupMinSlider');
        const maxSlider = document.getElementById('groupMaxSlider');
        
        function updateGroupSliders() {
            let minVal = parseInt(minSlider.value);
            let maxVal = parseInt(maxSlider.value);
            
            // SÄ±nÄ±r kontrolÃ¼
            const studentCount = APP_STATE.studentData ? APP_STATE.studentData.length : 0;
            const maxAllowed = studentCount > 0 ? Math.max(studentCount, 20) : 20;
            
            minVal = Math.max(1, Math.min(minVal, maxAllowed));
            maxVal = Math.max(1, Math.min(maxVal, maxAllowed));
            
            // Min > Max kontrolÃ¼
            if (minVal > maxVal) {
                if (minSlider === document.activeElement) {
                maxVal = minVal;
                } else {
                    minVal = maxVal;
                }
            }
            
            // DeÄŸerleri gÃ¼ncelle
            minSlider.value = minVal;
            maxSlider.value = maxVal;
            groupMinValue.textContent = minVal;
            groupMaxValue.textContent = maxVal;
            
            // Slider renklerini gÃ¼ncelle
            updateRainbowSliderThumb(minSlider, minVal, 'group-min');
            updateRainbowSliderThumb(maxSlider, maxVal, 'group-max');
            
            // UyarÄ±larÄ± gÃ¼ncelle
            if (typeof updateDualRangeWarning === 'function') {
            updateDualRangeWarning(minVal, maxVal);
            }
            
            console.log(`ğŸ¯ Grup slider'larÄ± gÃ¼ncellendi: Min=${minVal}, Max=${maxVal}, Ã–ÄŸrenci=${studentCount}`);
        }
        
        // Event listener'larÄ± ekle
        minSlider.addEventListener('input', updateGroupSliders);
        maxSlider.addEventListener('input', updateGroupSliders);
        
        // Ä°lk deÄŸerleri ayarla
        updateGroupSliders();
    }
    
    // Term Activity Count Slider
    if (termActivityCountSlider && termActivityCountValue) {
        termActivityCountSlider.addEventListener('input', function() {
            const value = parseInt(this.value);
            termActivityCountValue.textContent = value;
            updateRainbowSliderThumb(termActivityCountSlider, value, 'term-activity');
        });
        // Ä°lk deÄŸeri ayarla
        updateRainbowSliderThumb(termActivityCountSlider, termActivityCountSlider.value, 'term-activity');
    }
    
    // Term Components Slider
    if (termComponentsSlider && termComponentsValue) {
        termComponentsSlider.addEventListener('input', function() {
            const value = parseInt(this.value);
            termComponentsValue.textContent = value;
            updateRainbowSliderThumb(termComponentsSlider, value, 'term');
        });
        // Ä°lk deÄŸeri ayarla
        updateRainbowSliderThumb(termComponentsSlider, termComponentsSlider.value, 'term');
    }
    
    // Final Activity Count Slider
    if (finalActivityCountSlider && finalActivityCountValue) {
        finalActivityCountSlider.addEventListener('input', function() {
            const value = parseInt(this.value);
            finalActivityCountValue.textContent = value;
            updateRainbowSliderThumb(finalActivityCountSlider, value, 'final-activity');
        });
        // Ä°lk deÄŸeri ayarla
        updateRainbowSliderThumb(finalActivityCountSlider, finalActivityCountSlider.value, 'final-activity');
    }
    
    // Final Components Slider
    if (finalComponentsSlider && finalComponentsValue) {
        finalComponentsSlider.addEventListener('input', function() {
            const value = parseInt(this.value);
            finalComponentsValue.textContent = value;
            updateRainbowSliderThumb(finalComponentsSlider, value, 'final');
        });
        // Ä°lk deÄŸeri ayarla
        updateRainbowSliderThumb(finalComponentsSlider, finalComponentsSlider.value, 'final');
    }
    
    console.log('ğŸŒˆ Rainbow thermal slider\'lar baÅŸlatÄ±ldÄ±');
}

/**
 * Dual range uyarÄ±larÄ±nÄ± gÃ¼ncelle
 */
function updateDualRangeWarning(minVal, maxVal) {
    // Grup sayÄ±sÄ± uyarÄ±larÄ± iÃ§in basit kontrol
    const studentCount = APP_STATE.studentData ? APP_STATE.studentData.length : 0;
    
    if (studentCount > 0) {
        if (minVal > studentCount) {
            console.warn(`âš ï¸ Min grup sayÄ±sÄ± (${minVal}) Ã¶ÄŸrenci sayÄ±sÄ±ndan (${studentCount}) fazla`);
        }
        if (maxVal > studentCount) {
            console.warn(`âš ï¸ Max grup sayÄ±sÄ± (${maxVal}) Ã¶ÄŸrenci sayÄ±sÄ±ndan (${studentCount}) fazla`);
        }
    }
    
    if (minVal === maxVal) {
        console.log(`â„¹ï¸ Sabit grup sayÄ±sÄ±: ${minVal}`);
    } else {
        console.log(`â„¹ï¸ Grup aralÄ±ÄŸÄ±: ${minVal}-${maxVal}`);
    }
}

/**
 * Rainbow slider thumb rengini gÃ¼ncelle
 */
function updateRainbowSliderThumb(slider, value, type) {
    if (!slider) return;
    
    let color = '#007bff'; // Default blue
    
    switch (type) {
        case 'term':
            // Blue to Red gradient for term (1-8 range)
            const termFactor = (value - 1) / 7;
            color = interpolateRainbowColor([
                '#4a90e2', '#50c878', '#ffd700', '#ff8c00', '#ff4500'
            ], termFactor);
            break;
            
        case 'final':
            // Cyan to Red gradient for final (1-10 range)
            const finalFactor = (value - 1) / 9;
            color = interpolateRainbowColor([
                '#00bcd4', '#4caf50', '#8bc34a', '#ffeb3b', '#ff9800', '#f44336'
            ], finalFactor);
            break;
            
        case 'score':
            // Red to Green gradient for scoring (0-100 range)
            const scoreFactor = value / 100;
            color = interpolateRainbowColor([
                '#f44336', '#ff5722', '#ff9800', '#ffc107', '#8bc34a', '#4caf50'
            ], scoreFactor);
            break;
            
        case 'group-min':
            // Pink to Blue gradient for group min (1-20 range)
            const minFactor = (value - 1) / 19;
            color = interpolateRainbowColor([
                '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3'
            ], minFactor);
            break;
            
        case 'group-max':
            // Orange to Purple gradient for group max (1-20 range)
            const maxFactor = (value - 1) / 19;
            color = interpolateRainbowColor([
                '#ff9800', '#ff5722', '#f44336', '#e91e63', '#9c27b0'
            ], maxFactor);
            break;
            
        case 'term-activity':
            // Blue to Green gradient for term activity (1-100 range)
            const termActivityFactor = (value - 1) / 99;
            color = interpolateRainbowColor([
                '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50', '#8bc34a'
            ], termActivityFactor);
            break;
            
        case 'final-activity':
            // Purple to Cyan gradient for final activity (1-100 range)
            const finalActivityFactor = (value - 1) / 99;
            color = interpolateRainbowColor([
                '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4'
            ], finalActivityFactor);
            break;
    }
    
    // Thumb rengini gÃ¼ncelle
    slider.style.setProperty('--thumb-color', color);
    
    // CSS custom property ile thumb rengini ayarla
    const style = document.createElement('style');
    style.textContent = `
        #${slider.id}::-webkit-slider-thumb {
            border-color: ${color} !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2), 0 0 0 1px ${color} !important;
        }
        #${slider.id}::-moz-range-thumb {
            border-color: ${color} !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2), 0 0 0 1px ${color} !important;
        }
    `;
    
    // Eski style'Ä± kaldÄ±r ve yenisini ekle
    const oldStyle = document.getElementById(`${slider.id}-style`);
    if (oldStyle) oldStyle.remove();
    
    style.id = `${slider.id}-style`;
    document.head.appendChild(style);
}

/**
 * Rainbow renk interpolasyonu
 */
function interpolateRainbowColor(colors, factor) {
    if (factor <= 0) return colors[0];
    if (factor >= 1) return colors[colors.length - 1];
    
    const scaledFactor = factor * (colors.length - 1);
    const index = Math.floor(scaledFactor);
    const nextIndex = Math.min(index + 1, colors.length - 1);
    const localFactor = scaledFactor - index;
    
    return interpolateColor(colors[index], colors[nextIndex], localFactor);
}

/**
 * Pass rate indicator'larÄ±nÄ± gÃ¼ncelle
 */
// Ä°kinci updatePassRateIndicators fonksiyonu kaldÄ±rÄ±ldÄ± - geliÅŸmiÅŸ versiyon korundu

// DOMContentLoaded event'inde rainbow slider'larÄ± baÅŸlat
document.addEventListener('DOMContentLoaded', function() {
    // DiÄŸer baÅŸlatma iÅŸlemlerinden sonra rainbow slider'larÄ± baÅŸlat
    setTimeout(() => {
        initializeRainbowSliders();
    }, 100);
});

// =====================================================
// AÄIRLIK DENGELEME SÄ°STEMÄ°
// =====================================================

/**
 * YarÄ±yÄ±l iÃ§i etkinliklerin aÄŸÄ±rlÄ±klarÄ±nÄ± dengeler
 */
function balanceTermWeights() {
    try {
        const termActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('A'));
        
        if (termActivities.length === 0) return;
        
        console.log(`âš–ï¸ ${termActivities.length} yarÄ±yÄ±l iÃ§i etkinliÄŸin aÄŸÄ±rlÄ±klarÄ± dengeleniyor...`);
        
        // EÅŸit aÄŸÄ±rlÄ±k daÄŸÄ±lÄ±mÄ±
        const baseWeight = Math.floor(100 / termActivities.length);
        const remainder = 100 - (baseWeight * termActivities.length);
        
        termActivities.forEach((activity, index) => {
            const oldWeight = activity.weight;
            const newWeight = baseWeight + (index < remainder ? 1 : 0);
            activity.weight = newWeight;
            console.log(`  ğŸ“Š ${activity.id} (${activity.name}): ${oldWeight}% â†’ ${newWeight}%`);
        });
        
        // ArayÃ¼zÃ¼ gÃ¼ncelle
        renderTree();
        updateCategoryWeights();
        updateAssessmentView(); 
        
        console.log(`âœ… YarÄ±yÄ±l iÃ§i aÄŸÄ±rlÄ±k dengeleme tamamlandÄ±`);
        
    } catch (error) {
        console.error('âŒ YarÄ±yÄ±l iÃ§i aÄŸÄ±rlÄ±k dengeleme hatasÄ±:', error);
    }
}

/**
 * YarÄ±yÄ±l sonu etkinliklerin aÄŸÄ±rlÄ±klarÄ±nÄ± dengeler
 */
function balanceFinalWeights() {
    try {
        const finalActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('F'));
        
        if (finalActivities.length === 0) return;
        
        console.log(`âš–ï¸ ${finalActivities.length} yarÄ±yÄ±l sonu etkinliÄŸin aÄŸÄ±rlÄ±klarÄ± dengeleniyor...`);
        
        // EÅŸit aÄŸÄ±rlÄ±k daÄŸÄ±lÄ±mÄ±
        const baseWeight = Math.floor(100 / finalActivities.length);
        const remainder = 100 - (baseWeight * finalActivities.length);
        
        finalActivities.forEach((activity, index) => {
            const oldWeight = activity.weight;
            const newWeight = baseWeight + (index < remainder ? 1 : 0);
            activity.weight = newWeight;
            console.log(`  ğŸ“Š ${activity.id} (${activity.name}): ${oldWeight}% â†’ ${newWeight}%`);
        });
        
        // ArayÃ¼zÃ¼ gÃ¼ncelle
        renderTree();
        updateCategoryWeights();
        // DeÄŸerlendirme sekmesini gÃ¼ncelle - CRITICAL SYNC
        updateAssessmentView();
        console.log(`âœ… YarÄ±yÄ±l sonu aÄŸÄ±rlÄ±k dengeleme tamamlandÄ±`);
        
    } catch (error) {
        console.error('âŒ YarÄ±yÄ±l sonu aÄŸÄ±rlÄ±k dengeleme hatasÄ±:', error);
    }
}

// =============================================================================
// HIZLI AÄIRLIK DÃœZELTÄ°CÄ° - CONSOLE Ä°Ã‡Ä°N KULLANIM
// =============================================================================

/**
 * Mevcut aÄŸÄ±rlÄ±klarÄ± hÄ±zlÄ±ca dÃ¼zeltir
 * Console'da Ã§alÄ±ÅŸtÄ±rmak iÃ§in: quickFixWeights()
 */
function quickFixWeights() {
    console.log('ğŸ”§ Mevcut aÄŸÄ±rlÄ±klarÄ± dÃ¼zeltiliyor...');
    
    // YarÄ±yÄ±l iÃ§i aÄŸÄ±rlÄ±klarÄ±nÄ± dengele
    const termActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('A'));
    if (termActivities.length > 0) {
        const baseWeight = Math.floor(100 / termActivities.length);
        const remainder = 100 - (baseWeight * termActivities.length);
        
        termActivities.forEach((activity, index) => {
            const oldWeight = activity.weight;
            const newWeight = baseWeight + (index < remainder ? 1 : 0);
            activity.weight = newWeight;
            console.log(`  ğŸ“Š YarÄ±yÄ±l Ä°Ã§i ${activity.id}: ${oldWeight}% â†’ ${newWeight}%`);
        });
    }
    
    // YarÄ±yÄ±l sonu aÄŸÄ±rlÄ±klarÄ±nÄ± dengele
    const finalActivities = APP_STATE.assessmentTree.filter(node => node.id.startsWith('F'));
    if (finalActivities.length > 0) {
        const baseWeight = Math.floor(100 / finalActivities.length);
        const remainder = 100 - (baseWeight * finalActivities.length);
        
        finalActivities.forEach((activity, index) => {
            const oldWeight = activity.weight;
            const newWeight = baseWeight + (index < remainder ? 1 : 0);
            activity.weight = newWeight;
            console.log(`  ğŸ“Š YarÄ±yÄ±l Sonu ${activity.id}: ${oldWeight}% â†’ ${newWeight}%`);
        });
    }
    
    // ArayÃ¼zÃ¼ gÃ¼ncelle
    renderTree();
    updateCategoryWeights();
    // DeÄŸerlendirme sekmesini gÃ¼ncelle - CRITICAL SYNC
    updateAssessmentView();
    
    console.log('âœ… AÄŸÄ±rlÄ±k dengeleme tamamlandÄ±!');
    showModernToast('ğŸ”§ Mevcut aÄŸÄ±rlÄ±klar dÃ¼zeltildi!', 'success', 3000);
}

/**
 * Toast sistemini test et
 */
function testToastSystem() {
    console.log('ğŸ§ª Toast sistemi test ediliyor...');
    
    // Toast elementinin varlÄ±ÄŸÄ±nÄ± kontrol et
    const toastElement = document.getElementById('modernToast');
    const messageElement = document.getElementById('modernToastMessage');
    
    if (!toastElement) {
        console.error('âŒ modernToast elementi bulunamadÄ±!');
        return;
    }
    
    if (!messageElement) {
        console.error('âŒ modernToastMessage elementi bulunamadÄ±!');
        return;
    }
    
    console.log('âœ… Toast elementleri bulundu');
    console.log('Toast element:', toastElement);
    console.log('Message element:', messageElement);
    
    // Test mesajlarÄ± gÃ¶nder
    setTimeout(() => {
        console.log('ğŸ”¥ Success toast gÃ¶nderiliyor...');
        showModernToast('Test baÅŸarÄ±lÄ± mesajÄ±!', 'success', 3000);
    }, 1000);
    
    setTimeout(() => {
        console.log('âš ï¸ Warning toast gÃ¶nderiliyor...');
        showModernToast('Test uyarÄ± mesajÄ±!', 'warning', 3000);
    }, 2000);
    
    setTimeout(() => {
        console.log('âŒ Error toast gÃ¶nderiliyor...');
        showModernToast('Test hata mesajÄ±!', 'error', 3000);
    }, 3000);
}


/**
 * v5 formatÄ± iÃ§in grup deÄŸiÅŸikliÄŸi iÅŸleme - Ã¶ÄŸrenci grup deÄŸiÅŸtirdiÄŸinde Ã§aÄŸrÄ±lÄ±r
 */
function handleGroupChangeV5(studentId, componentId, newGroupId) {
    console.log(`ğŸ”„ v5 Grup deÄŸiÅŸikliÄŸi - Ã–ÄŸrenci: ${studentId}, BileÅŸen: ${componentId}, Yeni Grup: ${newGroupId}`);
    
    try {
        // v5 formatÄ±nda grup bilgisini gÃ¼ncelle
        if (!APP_STATE.studentComponentGroups) APP_STATE.studentComponentGroups = {};
        if (!APP_STATE.studentComponentGroups[studentId]) APP_STATE.studentComponentGroups[studentId] = {};
        
        APP_STATE.studentComponentGroups[studentId][componentId] = newGroupId;
        
        // gradesData'daki grup bilgilerini de gÃ¼ncelle
        if (!APP_STATE.gradesData[studentId]) APP_STATE.gradesData[studentId] = {};
        if (!APP_STATE.gradesData[studentId].grupBilgileri) APP_STATE.gradesData[studentId].grupBilgileri = {};
        
        APP_STATE.gradesData[studentId].grupBilgileri[componentId] = newGroupId;
        
        // UI'Ä± gÃ¼ncelle
        updateStudentCalculatedGrade(studentId);
        updateAssessmentGradeSummary(studentId);
        updateStudentSummary(studentId);
        
        console.log(`âœ… v5 Grup bilgisi gÃ¼ncellendi: ${studentId} â†’ ${componentId} â†’ ${newGroupId}`);
        
    } catch (error) {
        console.error("v5 grup deÄŸiÅŸikliÄŸi iÅŸlenirken hata oluÅŸtu:", error);
    }
}

// =============================================================================
// PUAN TEST Ä°ÅLEMLERÄ° - PUANLARI EÅÄ°TLEME VE KARIÅTIRMA
// =============================================================================

/**
 * TÃ¼m soru ve rubrik puanlarÄ±nÄ± eÅŸitler
 * DeÄŸerlendirme unsurlarÄ±ndaki tÃ¼m sorular ve rubrikler eÅŸit puan alÄ±r
 * Ã–ZEL: SÄ±nav toplamÄ±nÄ±n 100 olmasÄ±nÄ± garanti eder
 */
function equalizeAllPoints() {
    try {
        console.log('âš–ï¸ TÃ¼m puanlar eÅŸitleniyor...');
        
        let totalChanges = 0;
        let totalActivities = 0;
        
        // TÃ¼m etkinlikleri gez
        APP_STATE.assessmentTree.forEach(activity => {
            if (activity.children && activity.children.length > 0) {
                console.log(`ğŸ“ ${activity.name} etkinliÄŸi iÅŸleniyor...`);
                
                // EtkinliÄŸin toplam puanÄ±nÄ± al
                const activityTotalPoints = activity.points || 100;
                const itemCount = activity.children.length;
                
                if (itemCount > 0) {
                    // Mevcut puanlarÄ± kontrol et
                    const currentPoints = activity.children.map(item => item.points || 0);
                    const allPointsSame = currentPoints.every(point => point === currentPoints[0]);
                    
                    // Sadece puanlar farklÄ±ysa eÅŸitle
                    if (!allPointsSame || currentPoints[0] !== Math.floor(activityTotalPoints / itemCount)) {
                        // EÅŸit daÄŸÄ±lÄ±m hesapla
                        const equalPoints = Math.floor(activityTotalPoints / itemCount);
                        const remainder = activityTotalPoints - (equalPoints * itemCount);
                        
                        console.log(`  ğŸ”¢ Toplam puan: ${activityTotalPoints}, Ã–ÄŸe sayÄ±sÄ±: ${itemCount}, EÅŸit puan: ${equalPoints}, Kalan: ${remainder}`);
                        console.log(`  ğŸ“Š Mevcut daÄŸÄ±lÄ±m: [${currentPoints.join(', ')}]`);
                        
                        let activityChanges = 0;
                        // Her soru/rubriÄŸe eÅŸit puan ver
                        activity.children.forEach((item, index) => {
                            const oldPoints = item.points;
                            // Ä°lk 'remainder' kadar Ã¶ÄŸeye 1 fazla puan ver
                            const newPoints = equalPoints + (index < remainder ? 1 : 0);
                            
                            if (oldPoints !== newPoints) {
                                item.points = newPoints;
                                totalChanges++;
                                activityChanges++;
                                console.log(`    ğŸ”„ ${item.name}: ${oldPoints} â†’ ${newPoints} puan`);
                            }
                        });
                        
                        if (activityChanges > 0) {
                            totalActivities++;
                        }
                        
                        // âœ… TOPLAM KONTROL: Etkinlik toplamÄ±nÄ±n doÄŸru olduÄŸunu kontrol et
                        const calculatedTotal = activity.children.reduce((sum, item) => sum + (item.points || 0), 0);
                        if (calculatedTotal !== activityTotalPoints) {
                            console.warn(`âš ï¸ TOPLAM PUAN HATASI: ${activity.name} - Hedef: ${activityTotalPoints}, Hesaplanan: ${calculatedTotal}`);
                            
                            // Son Ã¶ÄŸeye farkÄ± ekle/Ã§Ä±kar
                            const difference = activityTotalPoints - calculatedTotal;
                            if (activity.children.length > 0) {
                                const lastItem = activity.children[activity.children.length - 1];
                                lastItem.points = (lastItem.points || 0) + difference;
                                console.log(`    ğŸ”§ DÃœZELTME: ${lastItem.name} puanÄ± ${difference > 0 ? '+' : ''}${difference} ayarlandÄ± â†’ ${lastItem.points}`);
                            }
                        }
                        
                        // âœ… KONTROL: Nihai toplam doÄŸrulama
                        const finalTotal = activity.children.reduce((sum, item) => sum + (item.points || 0), 0);
                        const finalPoints = activity.children.map(item => item.points || 0);
                        console.log(`    âœ… Nihai Kontrol: ${activity.name} toplam = ${finalTotal} (Hedef: ${activityTotalPoints})`);
                        console.log(`    ğŸ“Š Yeni daÄŸÄ±lÄ±m: [${finalPoints.join(', ')}]`);
                    } else {
                        console.log(`  âœ… ${activity.name} puanlarÄ± zaten eÅŸit (${currentPoints[0]} puan)`);
                    }
                }
            }
        });
        
        if (totalChanges > 0) {
            // ArayÃ¼zÃ¼ gÃ¼ncelle
            renderTree();
            updateCategoryWeights();
            // DeÄŸerlendirme sekmesini gÃ¼ncelle - CRITICAL SYNC
            updateAssessmentView();
            
            console.log(`âœ… Puan eÅŸitleme tamamlandÄ±. ${totalActivities} etkinlikte ${totalChanges} deÄŸiÅŸiklik yapÄ±ldÄ±.`);
            showModernToast(`âš–ï¸ ${totalActivities} etkinlikte ${totalChanges} soru/rubrik puanÄ± eÅŸitlendi! Toplam puan korundu.`, 'success', 3000);
        } else {
            console.log('â„¹ï¸ EÅŸitlenecek puan bulunamadÄ±.');
            showModernToast('â„¹ï¸ TÃ¼m puanlar zaten eÅŸit durumda!', 'info', 3000);
        }
        
    } catch (error) {
        console.error('âŒ Puan eÅŸitleme hatasÄ±:', error);
        showModernToast('âŒ Puan eÅŸitleme sÄ±rasÄ±nda hata oluÅŸtu!', 'error', 3000);
    }
}

/**
 * TÃ¼m soru ve rubrik puanlarÄ±nÄ± karÄ±ÅŸtÄ±rÄ±r
 * Mevcut puanlarÄ± alÄ±r ve rastgele olarak yeniden daÄŸÄ±tÄ±r
 */
function shuffleAllPoints() {
    try {
        console.log('ğŸ² TÃ¼m puanlar karÄ±ÅŸtÄ±rÄ±lÄ±yor...');
        
        // Debug: AÄŸaÃ§ durumunu kontrol et
        console.log('ğŸ” DEBUG: APP_STATE.assessmentTree durumu:', APP_STATE.assessmentTree);
        console.log('ğŸ” DEBUG: AÄŸaÃ§ uzunluÄŸu:', APP_STATE.assessmentTree.length);
        
        if (!APP_STATE.assessmentTree || APP_STATE.assessmentTree.length === 0) {
            console.warn('âš ï¸ DeÄŸerlendirme aÄŸacÄ± boÅŸ veya tanÄ±msÄ±z!');
            showModernToast('âš ï¸ Ã–nce deÄŸerlendirme kriterleri oluÅŸturun!', 'warning', 3000);
            return;
        }
        
        let totalChanges = 0;
        let totalShuffles = 0;
        
        // TÃ¼m etkinlikleri gez
        APP_STATE.assessmentTree.forEach((activity, actIndex) => {
            console.log(`ğŸ” DEBUG: ${actIndex}. etkinlik inceleniyor:`, activity);
            if (activity.children && activity.children.length > 1) {
                console.log(`ğŸ“ ${activity.name} etkinliÄŸi iÅŸleniyor...`);
                
                // Mevcut puanlarÄ± topla
                const currentPoints = activity.children.map(item => item.points || 0);
                const originalPoints = [...currentPoints]; // Orijinal sÄ±rayÄ± koru
                
                // EÄŸer tÃ¼m puanlar aynÄ±ysa, Ã¶nce farklÄ± puanlar ata
                const allPointsSame = currentPoints.every(point => point === currentPoints[0]);
                if (allPointsSame && currentPoints.length > 1) {
                    console.log(`  âš ï¸ TÃ¼m puanlar aynÄ± (${currentPoints[0]}), Ã¶nce farklÄ± puanlar atanÄ±yor...`);
                    
                    // Toplam puanÄ± koru
                    const totalPoints = currentPoints.reduce((sum, point) => sum + point, 0);
                    const itemCount = currentPoints.length;
                    
                    // FarklÄ± puanlar oluÅŸtur (minimum 1 puan)
                    const newPoints = [];
                    let remainingPoints = totalPoints;
                    
                    for (let i = 0; i < itemCount - 1; i++) {
                        // Her Ã¶ÄŸeye rastgele puan ver (1 ile kalan puanÄ±n yarÄ±sÄ± arasÄ±nda)
                        const maxForThis = Math.max(1, Math.floor(remainingPoints / (itemCount - i) * 1.5));
                        const minForThis = Math.max(1, Math.floor(remainingPoints / (itemCount - i) * 0.5));
                        const randomPoints = Math.floor(Math.random() * (maxForThis - minForThis + 1)) + minForThis;
                        
                        newPoints.push(Math.min(randomPoints, remainingPoints - (itemCount - i - 1)));
                        remainingPoints -= newPoints[i];
                    }
                    
                    // Son Ã¶ÄŸeye kalan puanÄ± ver
                    newPoints.push(Math.max(1, remainingPoints));
                    
                    // Yeni puanlarÄ± ata
                    currentPoints.splice(0, currentPoints.length, ...newPoints);
                    console.log(`  ğŸ¯ FarklÄ± puanlar atandÄ±: [${currentPoints.join(', ')}]`);
                }
                
                // PuanlarÄ± karÄ±ÅŸtÄ±r (Fisher-Yates shuffle algoritmasÄ±)
                for (let i = currentPoints.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [currentPoints[i], currentPoints[j]] = [currentPoints[j], currentPoints[i]];
                }
                
                console.log(`  ğŸ”„ Orijinal: [${originalPoints.join(', ')}] â†’ KarÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ: [${currentPoints.join(', ')}]`);
                
                // KarÄ±ÅŸtÄ±rÄ±lan puanlarÄ± ata
                let activityChanges = 0;
                activity.children.forEach((item, index) => {
                    const oldPoints = item.points;
                    const newPoints = currentPoints[index];
                    
                    if (oldPoints !== newPoints) {
                        item.points = newPoints;
                        totalChanges++;
                        activityChanges++;
                        console.log(`    ğŸ¯ ${item.name}: ${oldPoints} â†’ ${newPoints} puan`);
                    }
                });
                
                if (activityChanges > 0) {
                    totalShuffles++;
                }
            } else if (activity.children && activity.children.length === 1) {
                console.log(`  âš ï¸ ${activity.name} etkinliÄŸinde tek Ã¶ÄŸe var, karÄ±ÅŸtÄ±rÄ±lamaz.`);
            }
        });
        
        if (totalChanges > 0) {
            // ArayÃ¼zÃ¼ gÃ¼ncelle
            renderTree();
            updateCategoryWeights();
            // DeÄŸerlendirme sekmesini gÃ¼ncelle - CRITICAL SYNC
            updateAssessmentView();
            // DeÄŸerlendirme tablolarÄ±nÄ± gÃ¼ncelle
            
            console.log(`âœ… Puan karÄ±ÅŸtÄ±rma tamamlandÄ±. ${totalShuffles} etkinlikte ${totalChanges} deÄŸiÅŸiklik yapÄ±ldÄ±.`);
            showModernToast(`ğŸ² ${totalShuffles} etkinlikte ${totalChanges} soru/rubrik puanÄ± karÄ±ÅŸtÄ±rÄ±ldÄ±!`, 'success', 3000);
        } else {
            console.log('â„¹ï¸ KarÄ±ÅŸtÄ±rÄ±lacak puan bulunamadÄ±.');
            showModernToast('â„¹ï¸ KarÄ±ÅŸtÄ±rÄ±lacak Ã§oklu puan bulunamadÄ±!', 'info', 3000);
        }
        
    } catch (error) {
        console.error('âŒ Puan karÄ±ÅŸtÄ±rma hatasÄ±:', error);
        showModernToast('âŒ Puan karÄ±ÅŸtÄ±rma sÄ±rasÄ±nda hata oluÅŸtu!', 'error', 3000);
    }
}

/**
 * Belirli bir etkinlikteki puanlarÄ± eÅŸitler
 * @param {string} activityId - Etkinlik ID'si
 */
function equalizeActivityPoints(activityId) {
    try {
        const activity = findNodeById(activityId);
        if (!activity || !activity.children || activity.children.length === 0) {
            console.warn(`âš ï¸ ${activityId} etkinliÄŸi bulunamadÄ± veya alt Ã¶ÄŸesi yok.`);
            return;
        }
        
        console.log(`âš–ï¸ ${activity.name} etkinliÄŸinin puanlarÄ± eÅŸitleniyor...`);
        
        const activityTotalPoints = activity.points || 100;
        const itemCount = activity.children.length;
        const equalPoints = Math.floor(activityTotalPoints / itemCount);
        const remainder = activityTotalPoints - (equalPoints * itemCount);
        
        let changes = 0;
        activity.children.forEach((item, index) => {
            const oldPoints = item.points;
            const newPoints = equalPoints + (index < remainder ? 1 : 0);
            
            if (oldPoints !== newPoints) {
                item.points = newPoints;
                changes++;
                console.log(`  ğŸ”„ ${item.name}: ${oldPoints} â†’ ${newPoints} puan`);
            }
        });
        
        if (changes > 0) {
            renderTree();

            // DeÄŸerlendirme sekmesini gÃ¼ncelle - CRITICAL SYNC
            updateAssessmentView();
            console.log(`âœ… ${activity.name} etkinliÄŸinde ${changes} puan eÅŸitlendi.`);
            showModernToast(`âš–ï¸ ${activity.name} puanlarÄ± eÅŸitlendi!`, 'success', 2000);
        }
        
    } catch (error) {
        console.error('âŒ Etkinlik puan eÅŸitleme hatasÄ±:', error);
    }
}

/**
 * Belirli bir etkinlikteki puanlarÄ± karÄ±ÅŸtÄ±rÄ±r
 * @param {string} activityId - Etkinlik ID'si
 */
function shuffleActivityPoints(activityId) {
    try {
        const activity = findNodeById(activityId);
        if (!activity || !activity.children || activity.children.length <= 1) {
            console.warn(`âš ï¸ ${activityId} etkinliÄŸi bulunamadÄ± veya karÄ±ÅŸtÄ±rÄ±lacak yeterli Ã¶ÄŸe yok.`);
            return;
        }
        
        console.log(`ğŸ² ${activity.name} etkinliÄŸinin puanlarÄ± karÄ±ÅŸtÄ±rÄ±lÄ±yor...`);
        
        const currentPoints = activity.children.map(item => item.points || 0);
        const originalPoints = [...currentPoints];
        
        // Fisher-Yates shuffle
        for (let i = currentPoints.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [currentPoints[i], currentPoints[j]] = [currentPoints[j], currentPoints[i]];
        }
        
        let changes = 0;
        activity.children.forEach((item, index) => {
            const oldPoints = item.points;
            const newPoints = currentPoints[index];
            
            if (oldPoints !== newPoints) {
                item.points = newPoints;
                changes++;
                console.log(`  ğŸ¯ ${item.name}: ${oldPoints} â†’ ${newPoints} puan`);
            }
        });
        
        if (changes > 0) {
            renderTree();
            // DeÄŸerlendirme sekmesini gÃ¼ncelle - CRITICAL SYNC
            updateAssessmentView();
            console.log(`âœ… ${activity.name} etkinliÄŸinde ${changes} puan karÄ±ÅŸtÄ±rÄ±ldÄ±.`);
            showModernToast(`ğŸ² ${activity.name} puanlarÄ± karÄ±ÅŸtÄ±rÄ±ldÄ±!`, 'success', 2000);
        }
        
    } catch (error) {
        console.error('âŒ Etkinlik puan karÄ±ÅŸtÄ±rma hatasÄ±:', error);
    }
}

/**
 * Debug amaÃ§lÄ± - mevcut aÄŸaÃ§ yapÄ±sÄ±nÄ± ve puanlarÄ± konsola yazdÄ±rÄ±r
 */
function debugAssessmentTree() {
    console.log("ğŸ” === AÄAÃ‡ YAPISI DEBUG BÄ°LGÄ°SÄ° ===");
    console.log("AÄŸaÃ§ uzunluÄŸu:", APP_STATE.assessmentTree?.length || 0);
    
    if (!APP_STATE.assessmentTree || APP_STATE.assessmentTree.length === 0) {
        console.log("âŒ AÄŸaÃ§ boÅŸ veya tanÄ±msÄ±z!");
        return;
    }
    
    APP_STATE.assessmentTree.forEach((activity, index) => {
        console.log(`ğŸ“ ${index + 1}. ETKÄ°NLÄ°K: ${activity.name}`);
        console.log(`   ID: ${activity.id}`);
        console.log(`   Puan: ${activity.points}`);
        console.log(`   Alt Ã¶ÄŸe sayÄ±sÄ±: ${activity.children?.length || 0}`);
        
        if (activity.children && activity.children.length > 0) {
            activity.children.forEach((child, childIndex) => {
                console.log(`   â””â”€â”€ ${childIndex + 1}. ${child.name}: ${child.points} puan`);
            });
            
            const totalChildPoints = activity.children.reduce((sum, child) => sum + (child.points || 0), 0);
            console.log(`   ğŸ“Š Alt Ã¶ÄŸe toplamÄ±: ${totalChildPoints}`);
            
            const allSame = activity.children.every(child => child.points === activity.children[0].points);
            console.log(`   âš–ï¸ TÃ¼m puanlar eÅŸit mi: ${allSame ? "EVET" : "HAYIR"}`);
        }
    });
    
    console.log("ğŸ” === DEBUG BÄ°LGÄ°SÄ° SONU ===");
}

// Konsola eriÅŸim iÃ§in global olarak ekle
window.debugAssessmentTree = debugAssessmentTree;


/**
 * TÃ¼m input alanlarÄ±na maksimum puan bilgisi ekleyen birleÅŸik fonksiyon
 * Hem Ã–ÄŸrenci NotlarÄ± hem de DeÄŸerlendirme GiriÅŸi sekmelerinde Ã§alÄ±ÅŸÄ±r
 */
function addMaxPointsToAllRows() {
    console.log('ğŸ”§ DeÄŸerlendirme GiriÅŸi sekmesindeki input alanlarÄ±na maksimum puan bilgisi ekleniyor...');
    
    // Sadece DeÄŸerlendirme GiriÅŸi sekmesi iÃ§in (assessment-table iÃ§indeki input'lar)
    const assessmentInputs = document.querySelectorAll('.assessment-table input[type="number"]');
    console.log('ğŸ“Š Assessment table input sayÄ±sÄ±:', assessmentInputs.length);
    
    assessmentInputs.forEach((input, index) => {
        const maxValue = parseFloat(input.max) || 0;
        
        if (maxValue > 0) {
            // Maksimum puan bilgisi spanini kontrol et/ekle
            let maxInfoSpan = input.parentElement.querySelector('.max-points-info');
            if (!maxInfoSpan) {
                maxInfoSpan = document.createElement('span');
                maxInfoSpan.className = 'max-points-info';
                maxInfoSpan.style.cssText = 'font-size: 10px; color: #666; margin-left: 5px; font-weight: bold; display: block;';
                input.parentElement.appendChild(maxInfoSpan);
            }
            
            maxInfoSpan.textContent = '(max: ' + maxValue + ')';
            console.log(`âœ… Assessment input ${index + 1}: max ${maxValue} eklendi`);
        }
    });
    
    console.log(`ğŸ Toplam ${assessmentInputs.length} input iÃ§in maksimum puan bilgileri gÃ¼ncellendi`);
}

// Global eriÅŸim iÃ§in
window.addMaxPointsToAllRows = addMaxPointsToAllRows;

/**
 * DOM deÄŸiÅŸikliklerini izleyerek yeni input alanlarÄ±na maksimum puan bilgisi ekleyen observer
 */
let maxPointsObserver = null;

function initMaxPointsObserver() {
    // Ã–nceki observer'Ä± temizle
    if (maxPointsObserver) {
        maxPointsObserver.disconnect();
    }
    
    // Yeni observer oluÅŸtur
    maxPointsObserver = new MutationObserver((mutations) => {
        let hasNewInputs = false;
        
        mutations.forEach((mutation) => {
            // Yeni eklenen node'larÄ± kontrol et
            mutation.addedNodes.forEach((node) => {
                if (node.nodeType === Node.ELEMENT_NODE) {
                    // Assessment table iÃ§indeki input elemanlarÄ±
                    if (node.matches && node.matches('.assessment-table input[type="number"]')) {
                        hasNewInputs = true;
                    }
                    // Ä°Ã§inde assessment table input'larÄ± olan konteynerlar
                    else if (node.querySelectorAll) {
                        const inputs = node.querySelectorAll('.assessment-table input[type="number"]');
                        if (inputs.length > 0) {
                            hasNewInputs = true;
                        }
                    }
                }
            });
        });
        
        // Yeni input'lar varsa maksimum puan bilgilerini ekle
        if (hasNewInputs) {
            setTimeout(() => {
                addMaxPointsToAllRows();
            }, 50);
        }
    });
    
    // Observer'Ä± baÅŸlat - assessmentContainer'Ä± izle
    const container = document.getElementById('assessmentContainer');
    if (container) {
        maxPointsObserver.observe(container, {
            childList: true,
            subtree: true
        });
        console.log('ğŸ‘ï¸ Assessment container iÃ§in maksimum puan observer baÅŸlatÄ±ldÄ±');
    } else {
        console.log('âš ï¸ assessmentContainer bulunamadÄ±, document.body izleniyor');
        // Fallback: tÃ¼m document body'yi izle
        maxPointsObserver.observe(document.body, {
            childList: true,
            subtree: true
        });
    }
}

// Global eriÅŸim iÃ§in
window.initMaxPointsObserver = initMaxPointsObserver;



// Maksimum puan observer'Ä±nÄ± sayfa yÃ¼klendiÄŸinde baÅŸlat
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ Sayfa yÃ¼klendi, maksimum puan observer baÅŸlatÄ±lÄ±yor...');
    initMaxPointsObserver();
});

// Manual test fonksiyonlarÄ±
function testMaxPointsManually() {
    console.log('ğŸ§ª Manuel test baÅŸlatÄ±lÄ±yor...');
    
    // 1. Assessment Container kontrol
    const container = document.getElementById('assessmentContainer');
    console.log('ğŸ“¦ Assessment Container var mÄ±?', !!container);
    if (container) {
        console.log('ğŸ“¦ Assessment Container innerHTML uzunluÄŸu:', container.innerHTML.length);
    }
    
    // 2. Assessment table input elemanlarÄ± kontrol
    const inputs = document.querySelectorAll('.assessment-table input[type="number"]');
    console.log('ğŸ¯ Assessment input sayÄ±sÄ±:', inputs.length);
    
    // 3. Maksimum puan fonksiyonunu zorla Ã§aÄŸÄ±r
    if (typeof addMaxPointsToAllRows === 'function') {
        console.log('âœ… addMaxPointsToAllRows fonksiyonu mevcut');
        addMaxPointsToAllRows();
    } else {
        console.log('âŒ addMaxPointsToAllRows fonksiyonu mevcut deÄŸil');
    }
    
    // 4. Observer'Ä± zorla baÅŸlat
    if (typeof initMaxPointsObserver === 'function') {
        console.log('âœ… initMaxPointsObserver fonksiyonu mevcut');
        initMaxPointsObserver();
    } else {
        console.log('âŒ initMaxPointsObserver fonksiyonu mevcut deÄŸil');
    }
}

// Global eriÅŸim iÃ§in
window.testMaxPointsManually = testMaxPointsManually;



// Daha gÃ¼Ã§lÃ¼ DOM ready handler
function forceInitMaxPoints() {
    console.log('ğŸš€ DeÄŸerlendirme GiriÅŸi iÃ§in maksimum puan baÅŸlatÄ±cÄ±sÄ± Ã§alÄ±ÅŸÄ±yor...');
    
    // Observer'Ä± baÅŸlat
    if (typeof initMaxPointsObserver === 'function') {
        initMaxPointsObserver();
    }
    
    // Hemen maksimum puanlarÄ± ekle
    if (typeof addMaxPointsToAllRows === 'function') {
        addMaxPointsToAllRows();
    }
    
    // 2 saniye sonra tekrar kontrol et
    setTimeout(() => {
        console.log('ğŸ”„ 2 saniye sonra tekrar kontrol...');
        if (typeof addMaxPointsToAllRows === 'function') {
            addMaxPointsToAllRows();
        }
    }, 2000);
}

// Global eriÅŸim
window.forceInitMaxPoints = forceInitMaxPoints;

// Sayfa tamamen yÃ¼klendiÄŸinde zorla baÅŸlat
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', forceInitMaxPoints);
} else {
    // Sayfa zaten yÃ¼klÃ¼
    forceInitMaxPoints();
}

// =====================================================
// GELÄ°ÅMÄ°Å DEÄÄ°ÅÄ°KLÄ°K TAKÄ°P SÄ°STEMÄ°
// =====================================================

// Global deÄŸiÅŸken: Son gÃ¼ncelleme zamanÄ±nÄ± takip et
let lastAssessmentTreeHash = '';
let assessmentChangeTracker = null;

/**
 * DeÄŸerlendirme aÄŸacÄ± deÄŸiÅŸiklik takip sistemi
 * DeÄŸerlendirme bileÅŸenlerinde deÄŸiÅŸiklik olduÄŸunda otomatik tabloyu yeniden oluÅŸturur
 */
function initializeAssessmentChangeTracking() {
    try {
        console.log('ğŸ”„ DeÄŸerlendirme deÄŸiÅŸiklik takip sistemi baÅŸlatÄ±lÄ±yor...');
        
        // Ä°lk hash'i hesapla
        updateAssessmentTreeHash();
        
        // Ã–nceki tracker'Ä± temizle
        if (assessmentChangeTracker) {
            clearInterval(assessmentChangeTracker);
        }
        
        // Her 1000ms'de bir deÄŸiÅŸiklik kontrolÃ¼ yap (performanslÄ±)
        assessmentChangeTracker = setInterval(checkForAssessmentChanges, 1000);
        
        console.log('âœ… DeÄŸerlendirme deÄŸiÅŸiklik takip sistemi aktif');
    } catch (error) {
        console.error('DeÄŸerlendirme deÄŸiÅŸiklik takip sistemi baÅŸlatÄ±lamadÄ±:', error);
    }
}

/**
 * DeÄŸerlendirme aÄŸacÄ±nÄ±n mevcut durumunun hash'ini hesapla
 */
function updateAssessmentTreeHash() {
    try {
        // Ã–nemli alanlarÄ± iÃ§eren basitleÅŸtirilmiÅŸ aÄŸaÃ§ yapÄ±sÄ± oluÅŸtur
        const simplifiedTree = createSimplifiedAssessmentTree();
        lastAssessmentTreeHash = generateHashFromObject(simplifiedTree);
    } catch (error) {
        console.warn("Assessment tree hash hesaplanamadÄ±:", error);
        lastAssessmentTreeHash = '';
    }
}

/**
 * DeÄŸerlendirme aÄŸacÄ±nÄ±n basitleÅŸtirilmiÅŸ versiyonunu oluÅŸtur (sadece Ã¶nemli alanlar)
 */
function createSimplifiedAssessmentTree() {
    if (!APP_STATE.assessmentTree || !Array.isArray(APP_STATE.assessmentTree)) return {};
    
    const simplified = APP_STATE.assessmentTree.map(node => ({
        id: node.id,
        name: node.name || '',
        type: node.type || '',
        weight: node.weight || 0,
        points: node.points || 0,
        outcomes: Array.isArray(node.outcomes) ? node.outcomes.sort().join(',') : (node.outcomes || ''),
        description: node.description || '',
        children: node.children ? node.children.map(child => ({
            id: child.id,
            name: child.name || '',
            type: child.type || '',
            weight: child.weight || 0,
            points: child.points || 0,
            outcomes: Array.isArray(child.outcomes) ? child.outcomes.sort().join(',') : (child.outcomes || ''),
            description: child.description || '',
            // Test detaylarÄ± da dahil et
            testDetails: child.testDetails ? {
                totalQuestions: child.testDetails.totalQuestions || 0,
                correctWeight: child.testDetails.correctWeight || 0,
                wrongPenalty: child.testDetails.wrongPenalty || 0
            } : null
        })) : []
    }));
    
    // Grup bilgilerini de dahil et
    const groupMappings = APP_STATE.courseData?.grupHaritalari || {};
    
    return {
        tree: simplified,
        gruplar: groupMappings,
        termWeight: APP_STATE.termWeight,
        finalWeight: APP_STATE.finalWeight,
        studentCount: APP_STATE.studentData ? APP_STATE.studentData.length : 0
    };
}

/**
 * Nesne iÃ§in basit hash hesapla
 */
function generateHashFromObject(obj) {
    try {
        const str = JSON.stringify(obj, Object.keys(obj).sort());
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // 32 bit integer'a dÃ¶nÃ¼ÅŸtÃ¼r
        }
        return hash.toString();
    } catch (error) {
        console.warn('Hash hesaplanÄ±rken hata:', error);
        return Date.now().toString(); // Fallback
    }
}

/**
 * DeÄŸerlendirme aÄŸacÄ±nda deÄŸiÅŸiklik kontrolÃ¼ yap
 */
function checkForAssessmentChanges() {
    try {
        // Sadece deÄŸerlendirme sekmesi aktif ise kontrol et
        if (APP_STATE.currentActiveTabId !== 'assessment') {
            return;
        }
        
        // Ã–ÄŸrenci verisi yoksa kontrol etme
        if (!APP_STATE.studentData || APP_STATE.studentData.length === 0) {
            return;
        }
        
        // DeÄŸerlendirme aÄŸacÄ± yoksa kontrol etme
        if (!APP_STATE.assessmentTree || APP_STATE.assessmentTree.length === 0) {
            return;
        }
        
        const currentHash = generateHashFromObject(createSimplifiedAssessmentTree());
        
        if (currentHash !== lastAssessmentTreeHash && lastAssessmentTreeHash !== '') {
            console.log("ğŸ”„ DeÄŸerlendirme yapÄ±sÄ±nda deÄŸiÅŸiklik tespit edildi, tabloyu yeniden oluÅŸturuyor...");
            lastAssessmentTreeHash = currentHash;
            
            // KÄ±sa gecikme ile deÄŸerlendirme gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ gÃ¼ncelle
            setTimeout(() => {
                updateAssessmentView();
                showModernToast("ğŸ“Š DeÄŸerlendirme tablosu deÄŸiÅŸiklikler nedeniyle yenilendi.", "info");
            }, 100);
        } else if (lastAssessmentTreeHash === '') {
            // Ä°lk kez hash hesaplanÄ±yor
            lastAssessmentTreeHash = currentHash;
        }
    } catch (error) {
        console.warn("DeÄŸerlendirme deÄŸiÅŸiklik kontrolÃ¼nde hata:", error);
    }
}

/**
 * Manuel gÃ¼ncelleme tetikleme fonksiyonu (aÄŸaÃ§ operasyonlarÄ± sonrasÄ± Ã§aÄŸrÄ±lacak)
 */
function triggerAssessmentTableRefresh(reason = "Manuel gÃ¼ncelleme") {
    try {
        console.log(`ğŸ”„ ${reason} - DeÄŸerlendirme tablosu yenileniyor...`);
        
        // Hash'i gÃ¼ncelle
        updateAssessmentTreeHash();
        
        // DeÄŸerlendirme gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ gÃ¼ncelle (eÄŸer deÄŸerlendirme sekmesi aktifse)
        if (APP_STATE.currentActiveTabId === 'assessment' && APP_STATE.studentData && APP_STATE.studentData.length > 0) {
            updateAssessmentView();
        }
        
        // KullanÄ±cÄ±ya bilgi ver
        showModernToast(`ğŸ“Š DeÄŸerlendirme tablosu gÃ¼ncellendi: ${reason}`, "success");
    } catch (error) {
        console.error("Manuel deÄŸerlendirme tablosu gÃ¼ncellemesinde hata:", error);
        showModernToast("âŒ DeÄŸerlendirme tablosu gÃ¼ncellenirken hata oluÅŸtu!", "error");
    }
}

/**
 * DeÄŸerlendirme deÄŸiÅŸiklik takip sistemini durdur
 */
function stopAssessmentChangeTracking() {
    if (assessmentChangeTracker) {
        clearInterval(assessmentChangeTracker);
        assessmentChangeTracker = null;
        console.log('ğŸ›‘ DeÄŸerlendirme deÄŸiÅŸiklik takip sistemi durduruldu');
    }
}

// Global eriÅŸim iÃ§in fonksiyonlarÄ± window'a ekle
window.initializeAssessmentChangeTracking = initializeAssessmentChangeTracking;
window.triggerAssessmentTableRefresh = triggerAssessmentTableRefresh;
window.stopAssessmentChangeTracking = stopAssessmentChangeTracking;
window.updateAssessmentTreeHash = updateAssessmentTreeHash;

// Sistem baÅŸlatÄ±cÄ±sÄ±
function initializeEnhancedAssessmentSystem() {
    console.log('ğŸš€ GeliÅŸmiÅŸ deÄŸerlendirme sistemi baÅŸlatÄ±lÄ±yor...');
    
    // DeÄŸiÅŸiklik takip sistemini baÅŸlat
    initializeAssessmentChangeTracking();
    
    console.log('âœ… GeliÅŸmiÅŸ deÄŸerlendirme sistemi aktif!');
    console.log('ğŸ“‹ Ã–zellikler:');
    console.log('   - Otomatik deÄŸerlendirme tablosu yenileme');
    console.log('   - Etkinlik adÄ±, tÃ¼rÃ¼, aÄŸÄ±rlÄ±ÄŸÄ± deÄŸiÅŸiklik takibi');
    console.log('   - Soru/Rubrik ekleme/silme takibi');
    console.log('   - Grup haritalama deÄŸiÅŸiklik takibi');
    console.log('   - Ã–Ã‡ deÄŸiÅŸiklik takibi');
    console.log('   - Test detaylarÄ± deÄŸiÅŸiklik takibi');
}

// Sayfa tamamen yÃ¼klendiÄŸinde geliÅŸmiÅŸ sistemi baÅŸlat
document.addEventListener('DOMContentLoaded', function() {
    // KÄ±sa gecikme ile baÅŸlat (diÄŸer sistemlerin yÃ¼klenmesini bekle)
    setTimeout(initializeEnhancedAssessmentSystem, 1000);
});

// EÄŸer sayfa zaten yÃ¼klÃ¼ ise hemen baÅŸlat
if (document.readyState === 'complete') {
    setTimeout(initializeEnhancedAssessmentSystem, 500);
}

// Global test fonksiyonu
window.testAssessmentChangeSystem = function() {
    console.log('ğŸ§ª DeÄŸerlendirme deÄŸiÅŸiklik sistemi test ediliyor...');
    console.log('ğŸ“Š Mevcut hash:', lastAssessmentTreeHash);
    console.log('ğŸ”„ Tracker aktif:', !!assessmentChangeTracker);
    console.log('ğŸ“‹ Assessment tree uzunluÄŸu:', APP_STATE.assessmentTree ? APP_STATE.assessmentTree.length : 0);
    console.log('ğŸ‘¥ Ã–ÄŸrenci sayÄ±sÄ±:', APP_STATE.studentData ? APP_STATE.studentData.length : 0);
    console.log('ğŸ¯ Aktif sekme:', APP_STATE.currentActiveTabId);
    
    // Manuel tetikleme testi
    triggerAssessmentTableRefresh("Test amaÃ§lÄ± manuel tetikleme");
};

// =====================================================
// HIZLI VE BASÄ°T GÃœNCELLEME SÄ°STEMÄ°
// =====================================================

/**
 * AnÄ±nda deÄŸerlendirme tablosu gÃ¼ncelleme
 */
function instantAssessmentRefresh(reason = "DeÄŸiÅŸiklik") {
    if (APP_STATE.currentActiveTabId === 'assessment' && 
        APP_STATE.studentData && 
        APP_STATE.studentData.length > 0 && 
        APP_STATE.assessmentTree && 
        APP_STATE.assessmentTree.length > 0) {
        
        console.log(`âš¡ AnÄ±nda gÃ¼ncelleme: ${reason}`);
        updateAssessmentView();
        return true;
    }
    return false;
}

/**
 * TÃ¼m kritik DOM deÄŸiÅŸikliklerini yakala
 */
function attachInstantUpdateListeners() {
    // TÃ¼m click event'leri
    document.addEventListener('click', function(e) {
        if (e.target.closest('#treeContainer')) {
            setTimeout(() => instantAssessmentRefresh("TÄ±klama iÅŸlemi"), 250);
        }
    });
    
    // TÃ¼m form deÄŸiÅŸiklikleri
    document.addEventListener('change', function(e) {
        if (e.target.closest('#treeContainer')) {
            setTimeout(() => instantAssessmentRefresh("Form deÄŸiÅŸikliÄŸi"), 100);
        }
    });
    
    // Input yazma (debounced)
    let typingTimer;
    document.addEventListener('input', function(e) {
        if (e.target.closest('#treeContainer')) {
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => instantAssessmentRefresh("Metin giriÅŸi"), 400);
        }
    });
    
    console.log('âœ… AnÄ±nda gÃ¼ncelleme dinleyicileri aktif!');
}

// Global fonksiyon
window.forceAssessmentRefresh = function() {
    if (instantAssessmentRefresh("Manuel zorlama")) {
        showModernToast("ğŸ”„ DeÄŸerlendirme tablosu yenilendi!", "success");
    } else {
        showModernToast("âš ï¸ DeÄŸerlendirme sekmesi aktif deÄŸil veya veri eksik!", "warning");
    }
};

// Hemen baÅŸlat
if (document.readyState === 'complete') {
    setTimeout(attachInstantUpdateListeners, 300);
} else {
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(attachInstantUpdateListeners, 600);
    });
}

// GUID sistemi tamamen kaldÄ±rÄ±ldÄ±


//Index.html den taÅŸÄ±ndÄ± 
   // =====================================================
    // TAÅIMA BUTONLARI DÃœZELTMESÄ°
    // =====================================================
    
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() {
            // renderNode fonksiyonunu geniÅŸlet
            if (typeof window.renderNode === 'function') {
                const originalRenderNode = window.renderNode;
                
                window.renderNode = function(node, parentElement, level) {
                    originalRenderNode(node, parentElement, level);
                    
                    // Alt Ã¶ÄŸeler iÃ§in taÅŸÄ±ma butonlarÄ±nÄ± ekle
                    const isSubItem = node.id.includes('.');
                    if (isSubItem) {
                        setTimeout(() => addMoveButtonsToNode(node.id), 50);
                    }
                };
            }
            
            // renderTree fonksiyonunu geniÅŸlet
            if (typeof window.renderTree === 'function') {
                const originalRenderTree = window.renderTree;
                
                window.renderTree = function() {
                    originalRenderTree();
                    setTimeout(() => {
                        addMoveButtonsToAllSubItems();
                    }, 100);
                };
            }
        }, 500);
    });
    
    /**
     * DÃ¼ÄŸÃ¼me taÅŸÄ±ma butonlarÄ± ekle
     */
    function addMoveButtonsToNode(nodeId) {
        const nodeElement = document.querySelector(`[data-id="${nodeId}"]`);
        if (!nodeElement) return;
        
        const buttonGroup = nodeElement.querySelector('.button-group');
        if (!buttonGroup) return;
        
        // EÄŸer taÅŸÄ±ma butonlarÄ± zaten varsa ekleme
        if (buttonGroup.querySelector('.btn-move-up')) return;
        
        // TaÅŸÄ±ma butonlarÄ±nÄ± oluÅŸtur
        const moveUpBtn = document.createElement('button');
        moveUpBtn.className = 'btn btn-move-up btn-small';
        moveUpBtn.setAttribute('data-node-id', nodeId);
        moveUpBtn.title = 'YukarÄ± taÅŸÄ±';
        moveUpBtn.innerHTML = `
            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="18 15 12 9 6 15"></polyline>
            </svg>
            â†‘
        `;
        
        const moveDownBtn = document.createElement('button');
        moveDownBtn.className = 'btn btn-move-down btn-small';
        moveDownBtn.setAttribute('data-node-id', nodeId);
        moveDownBtn.title = 'AÅŸaÄŸÄ± taÅŸÄ±';
        moveDownBtn.innerHTML = `
            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
            â†“
        `;
        
        // Event listener'larÄ± ekle
        moveUpBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const node = findNodeById(nodeId);
            if (node && typeof moveItemUp === 'function') {
                moveItemUp(node);
            }
        });
        
        moveDownBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const node = findNodeById(nodeId);
            if (node && typeof moveItemDown === 'function') {
                moveItemDown(node);
            }
        });
        
        // ButonlarÄ± button-group'un baÅŸÄ±na ekle
        buttonGroup.insertBefore(moveUpBtn, buttonGroup.firstChild);
        buttonGroup.insertBefore(moveDownBtn, moveUpBtn.nextSibling);
    }
    
    /**
     * TÃ¼m alt Ã¶ÄŸelere taÅŸÄ±ma butonlarÄ± ekle
     */
    function addMoveButtonsToAllSubItems() {
        if (typeof APP_STATE !== 'undefined' && APP_STATE.assessmentTree) {
            APP_STATE.assessmentTree.forEach(rootNode => {
                if (rootNode.children) {
                    rootNode.children.forEach(childNode => {
                        addMoveButtonsToNode(childNode.id);
                    });
                }
            });
        }
    }
    
    // Manuel test fonksiyonu
    window.testMoveButtons = function() {
        console.log('ğŸ§ª TaÅŸÄ±ma butonlarÄ± test ediliyor...');
        addMoveButtonsToAllSubItems();
        if (typeof showModernToast === 'function') {
            showModernToast('ğŸ”„ TaÅŸÄ±ma butonlarÄ± eklendi!', 'success');
        }
    };
    
    // Global fonksiyonlarÄ± ekle
    window.addMoveButtonsToNode = addMoveButtonsToNode;
    window.addMoveButtonsToAllSubItems = addMoveButtonsToAllSubItems;


    // GUID sistemi tamamen kaldÄ±rÄ±ldÄ±


        // =====================================================
    // SÃœRÃœKLE BIRAK SÄ°STEMÄ°
    // =====================================================
    
    let draggedNode = null;
    let draggedElement = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() {
            initializeDragAndDrop();
        }, 2500);
    });
    
    /**
     * SÃ¼rÃ¼kle bÄ±rak sistemini baÅŸlat
     */
    function initializeDragAndDrop() {
        // Mevcut renderNode fonksiyonunu geniÅŸlet
        if (typeof window.renderNode === 'function') {
            const originalRenderNode = window.renderNode;
            
            window.renderNode = function(node, parentElement, level) {
                originalRenderNode(node, parentElement, level);
                
                // Alt Ã¶ÄŸeler iÃ§in sÃ¼rÃ¼kle bÄ±rak Ã¶zelliÄŸi ekle
                const isSubItem = node.id.includes('.');
                if (isSubItem) {
                    setTimeout(() => addDragAndDropToNode(node.id), 100);
                }
            };
        }
    }
    
    /**
     * DÃ¼ÄŸÃ¼me sÃ¼rÃ¼kle bÄ±rak Ã¶zelliÄŸi ekle
     */
    function addDragAndDropToNode(nodeId) {
        const nodeElement = document.querySelector(`[data-id="${nodeId}"]`);
        if (!nodeElement) return;
        
        // SÃ¼rÃ¼klenebilir yap
        nodeElement.draggable = true;
        nodeElement.style.cursor = 'move';
        
        // Drag event'leri
        nodeElement.addEventListener('dragstart', handleDragStart);
        nodeElement.addEventListener('dragover', handleDragOver);
        nodeElement.addEventListener('drop', handleDrop);
        nodeElement.addEventListener('dragend', handleDragEnd);
        nodeElement.addEventListener('dragenter', handleDragEnter);
        nodeElement.addEventListener('dragleave', handleDragLeave);
        
        // Visual feedback iÃ§in sÄ±nÄ±f ekle
        nodeElement.classList.add('draggable-item');
    }
    
    /**
     * SÃ¼rÃ¼kleme baÅŸladÄ±ÄŸÄ±nda
     */
    function handleDragStart(e) {
        draggedElement = e.target.closest('.tree-node');
        const nodeId = draggedElement.dataset.id;
        draggedNode = findNodeById ? findNodeById(nodeId) : null;
        
        draggedElement.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', draggedElement.outerHTML);
        
        console.log('ğŸ”¥ SÃ¼rÃ¼kleme baÅŸladÄ±:', nodeId);
    }
    
    /**
     * SÃ¼rÃ¼kleme bittiÄŸinde
     */
    function handleDragEnd(e) {
        if (draggedElement) {
            draggedElement.classList.remove('dragging');
        }
        
        // TÃ¼m drop zone stillerini temizle
        document.querySelectorAll('.drop-zone').forEach(el => {
            el.classList.remove('drop-zone');
        });
        
        draggedNode = null;
        draggedElement = null;
    }
    
    /**
     * SÃ¼rÃ¼klenirken Ã¼zerine gelindiÄŸinde
     */
    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
    }
    
    /**
     * Drop zone'a girildiÄŸinde
     */
    function handleDragEnter(e) {
        const targetElement = e.target.closest('.tree-node');
        if (targetElement && targetElement !== draggedElement) {
            const targetNodeId = targetElement.dataset.id;
            const isSubItem = targetNodeId.includes('.');
            
            // Sadece aynÄ± parent altÄ±ndaki alt Ã¶ÄŸeler iÃ§in drop zone yap
            if (isSubItem && draggedNode) {
                const draggedParentId = draggedNode.id.split('.')[0];
                const targetParentId = targetNodeId.split('.')[0];
                
                if (draggedParentId === targetParentId) {
                    targetElement.classList.add('drop-zone');
                }
            }
        }
    }
    
    /**
     * Drop zone'dan Ã§Ä±kÄ±ldÄ±ÄŸÄ±nda
     */
    function handleDragLeave(e) {
        const targetElement = e.target.closest('.tree-node');
        if (targetElement) {
            targetElement.classList.remove('drop-zone');
        }
    }
    
    /**
     * BÄ±rakÄ±ldÄ±ÄŸÄ±nda
     */
    function handleDrop(e) {
        e.preventDefault();
        
        const targetElement = e.target.closest('.tree-node');
        if (!targetElement || !draggedNode || targetElement === draggedElement) return;
        
        const targetNodeId = targetElement.dataset.id;
        const targetNode = findNodeById ? findNodeById(targetNodeId) : null;
        
        if (!targetNode) return;
        
        // AynÄ± parent altÄ±nda mÄ± kontrol et
        const draggedParentId = draggedNode.id.split('.')[0];
        const targetParentId = targetNode.id.split('.')[0];
        
        if (draggedParentId !== targetParentId) {
            showModernToast('Sadece aynÄ± bileÅŸen iÃ§indeki sorular taÅŸÄ±nabilir!', 'warning');
            return;
        }
        
        // Parent node'u bul
        const parentNode = findParentNode ? findParentNode(draggedNode.id) : null;
        if (!parentNode) return;
        
        // Mevcut pozisyonlarÄ± bul
        const draggedIndex = parentNode.children.findIndex(child => child.id === draggedNode.id);
        const targetIndex = parentNode.children.findIndex(child => child.id === targetNode.id);
        
        if (draggedIndex === -1 || targetIndex === -1) return;
        
        // Ã–ÄŸeleri yeniden sÄ±rala
        const [movedItem] = parentNode.children.splice(draggedIndex, 1);
        parentNode.children.splice(targetIndex, 0, movedItem);
        
        // ID'leri yeniden dÃ¼zenle
        if (typeof reorderAllIds === 'function') {
            reorderAllIds(parentNode);
        }
        
        // GÃ¶rÃ¼nÃ¼mÃ¼ gÃ¼ncelle
        if (typeof renderTree === 'function') {
            renderTree();
        }
        
        if (typeof updateAssessmentView === 'function') {
            updateAssessmentView();
        }
        
        showModernToast(`"${draggedNode.name}" baÅŸarÄ±yla taÅŸÄ±ndÄ±!`, 'success');
        
        console.log('âœ… SÃ¼rÃ¼kle bÄ±rak tamamlandÄ±:', draggedNode.id, '->', targetNode.id);
    }
    
    // Global fonksiyonlar
    window.initializeDragAndDrop = initializeDragAndDrop;
    window.addDragAndDropToNode = addDragAndDropToNode;
    
    // CSS stilleri ekle
    const dragDropStyles = document.createElement('style');
    dragDropStyles.textContent = `
        .draggable-item {
            transition: all 0.2s ease;
        }
        
        .dragging {
            opacity: 0.5;
            transform: rotate(2deg);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .drop-zone {
            border: 2px dashed #3498db !important;
            background-color: rgba(52, 152, 219, 0.1) !important;
            transform: scale(1.02);
        }
        
        .tree-node[draggable="true"]:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .tree-node[draggable="true"]::before {
            content: "â‹®â‹®";
            position: absolute;
            left: 5px;
            top: 50%;
            transform: translateY(-50%);
            color: #bdc3c7;
            font-weight: bold;
            font-size: 12px;
            line-height: 1;
        }
    `;
    document.head.appendChild(dragDropStyles);

    
    // GUID sistemi tamamen kaldÄ±rÄ±ldÄ±


    // =====================================================
    // ID SÄ°STEMÄ° DÃœZELTMESÄ°
    // =====================================================
    
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() {
            // addQuestionToNode fonksiyonunu geniÅŸlet
            if (typeof window.addQuestionToNode === 'function') {
                const originalAddQuestionToNode = window.addQuestionToNode;
                
                window.addQuestionToNode = function(parentNode, questionType = 'Soru', description = '') {
                    if (!parentNode) return;
                    
                    try {
                        if (!parentNode.children) {
                            parentNode.children = [];
                        }
                        
                        // YENÄ°: SÄ±ralÄ± ID Ã¼retimi kullan
                        const newId = generateSequentialId ? generateSequentialId(parentNode) : `${parentNode.id}.${parentNode.children.length + 1}`;
                        
                        // Ã–ÄŸrenme Ã§Ä±ktÄ±larÄ± varsa ilk Ã¶ÄŸrenme Ã§Ä±ktÄ±sÄ±nÄ± atayalÄ±m
                        const outcome = parentNode.outcomes && parentNode.outcomes.length > 0 ? [parentNode.outcomes[0]] : [];
                        
                        // VarsayÄ±lan puanÄ± 3 olarak ayarla
                        const defaultPoints = 3;
                        
                        const newNode = {
                            id: newId,
                            name: `${questionType}`,
                            type: questionType,
                            weight: 0, // AÄŸÄ±rlÄ±k otomatik hesaplanacak
                            points: defaultPoints,
                            outcomes: outcome,
                            description: description || 'DeÄŸerlendirme sorusu',
                            expanded: true,
                            children: []
                        };
                        
                        parentNode.children.push(newNode);
                        parentNode.expanded = true;
                        
                        // YENÄ°: ID'leri yeniden dÃ¼zenle
                        if (typeof reorderAllIds === 'function') {
                            reorderAllIds(parentNode);
                        }
                        
                        // AÄŸÄ±rlÄ±ÄŸÄ± hesapla
                        if (typeof updateSubItemWeight === 'function') {
                            updateSubItemWeight(newNode);
                        }
                        
                        if (typeof selectNode === 'function') {
                            selectNode(newNode);
                        }
                        
                        if (typeof renderTree === 'function') {
                            renderTree();
                        }
                        
                        // DeÄŸerlendirme sekmesini gÃ¼ncelle
                        if (typeof updateAssessmentView === 'function') {
                            updateAssessmentView();
                        }
                        
                        if (typeof showModernToast === 'function') {
                            showModernToast(`"${questionType}" sorusu eklendi.`);
                        }
                        
                        // AÄŸÄ±rlÄ±klarÄ± yeniden deÄŸerlendir
                        if (typeof checkAndOfferRedistribution === 'function') {
                            checkAndOfferRedistribution(parentNode);
                        }
                        
                    } catch (error) {
                        console.error("Soru eklenirken hata oluÅŸtu:", error);
                        if (typeof showModernToast === 'function') {
                            showModernToast("Soru eklenemedi!", "error");
                        }
                    }
                };
            }
            
            // deleteNode fonksiyonunu geniÅŸlet
            if (typeof window.deleteNode === 'function') {
                const originalDeleteNode = window.deleteNode;
                
                window.deleteNode = function(nodeId) {
                    // Orijinal fonksiyonu Ã§aÄŸÄ±r
                    originalDeleteNode(nodeId);
                    
                    // ID'leri yeniden dÃ¼zenle
                    setTimeout(() => {
                        if (!nodeId.includes('.')) return; // Sadece alt Ã¶ÄŸeler iÃ§in
                        
                        const parentId = nodeId.substring(0, nodeId.lastIndexOf('.'));
                        const parentNode = findNodeById ? findNodeById(parentId) : null;
                        
                        if (parentNode && typeof reorderAllIds === 'function') {
                            reorderAllIds(parentNode);
                            
                            if (typeof renderTree === 'function') {
                                renderTree();
                            }
                            
                            if (typeof updateAssessmentView === 'function') {
                                updateAssessmentView();
                            }
                        }
                    }, 100);
                };
            }
        }, 1000);
    });

    // =====================================================
    // VERÄ° KORUMA SÄ°STEMÄ° - Ã–ÄRENCÄ° NOTLARI
    // =====================================================
    
    /**
     * Ã–ÄŸrenci notlarÄ±nda ID deÄŸiÅŸikliklerini migrasyon et
     * @param {Object} idMigrationMap - ID deÄŸiÅŸiklik haritasÄ± (eskiID -> yeniID)
     */
    function migrateGradesData(idMigrationMap) {
        if (!APP_STATE.gradesData || Object.keys(idMigrationMap).length === 0) return;
        
        console.log('ğŸ”„ Ã–ÄŸrenci notlarÄ± migrasyon baÅŸlatÄ±lÄ±yor...', idMigrationMap);
        
        // Her Ã¶ÄŸrenci iÃ§in
        Object.keys(APP_STATE.gradesData).forEach(studentId => {
            const studentGrades = APP_STATE.gradesData[studentId];
            if (!studentGrades || typeof studentGrades !== 'object') return;
            
            // Migrasyon edilecek notlarÄ± sakla
            const notesToMigrate = {};
            
            // Migrasyon haritasÄ±ndaki her ID deÄŸiÅŸikliÄŸi iÃ§in
            Object.entries(idMigrationMap).forEach(([oldId, newId]) => {
                // Direkt not kontrolÃ¼
                if (studentGrades.hasOwnProperty(oldId)) {
                    notesToMigrate[newId] = studentGrades[oldId];
                    delete studentGrades[oldId];
                    console.log(`âœ… Ã–ÄŸrenci ${studentId}: ${oldId} -> ${newId} (DeÄŸer: ${notesToMigrate[newId]})`);
                }
                
                // Ham puanlar migrasyon
                if (studentGrades.hamPuanlar) {
                    const oldQuestionNum = oldId.split('.').pop();
                    const newQuestionNum = newId.split('.').pop();
                    
                    if (studentGrades.hamPuanlar.hasOwnProperty(oldQuestionNum)) {
                        studentGrades.hamPuanlar[newQuestionNum] = studentGrades.hamPuanlar[oldQuestionNum];
                        delete studentGrades.hamPuanlar[oldQuestionNum];
                        console.log(`âœ… Ham puan migrasyon: ${oldQuestionNum} -> ${newQuestionNum}`);
                    }
                }
                
                // Grup bazlÄ± notlar migrasyon
                if (studentGrades.grupBazliNotlar) {
                    Object.keys(studentGrades.grupBazliNotlar).forEach(groupName => {
                        const groupGrades = studentGrades.grupBazliNotlar[groupName];
                        if (groupGrades.hasOwnProperty(oldId)) {
                            groupGrades[newId] = groupGrades[oldId];
                            delete groupGrades[oldId];
                            console.log(`âœ… Grup bazlÄ± not migrasyon: Grup ${groupName}, ${oldId} -> ${newId}`);
                        }
                    });
                }
                
                // Ãœst dÃ¼ÄŸÃ¼m yapÄ±sÄ± migrasyon
                const oldParentId = oldId.split('.')[0];
                const newParentId = newId.split('.')[0];
                
                if (studentGrades[oldParentId] && typeof studentGrades[oldParentId] === 'object' && oldParentId === newParentId) {
                    const parentGrades = studentGrades[oldParentId];
                    if (parentGrades.hasOwnProperty(oldId)) {
                        parentGrades[newId] = parentGrades[oldId];
                        delete parentGrades[oldId];
                        
                        // KÄ±sa ID de gÃ¼ncelle
                        const oldShortId = oldId.split('.').pop();
                        const newShortId = newId.split('.').pop();
                        if (parentGrades.hasOwnProperty(oldShortId)) {
                            parentGrades[newShortId] = parentGrades[oldShortId];
                            delete parentGrades[oldShortId];
                        }
                        
                        console.log(`âœ… Parent yapÄ±sÄ± migrasyon: ${oldParentId}[${oldId}] -> ${newParentId}[${newId}]`);
                    }
                }
            });
            
            // Yeni notlarÄ± ekle
            Object.entries(notesToMigrate).forEach(([newId, value]) => {
                studentGrades[newId] = value;
            });
        });
        
        console.log('âœ… Ã–ÄŸrenci notlarÄ± migrasyon tamamlandÄ±!');
        showModernToast(`ğŸ“Š ${Object.keys(idMigrationMap).length} soru/rubrik ID'si deÄŸiÅŸtirildi, notlar korundu!`, "success");
    }
    
    /**
     * reorderAllIds fonksiyonunu veri koruma ile geniÅŸlet
     */
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() {
            if (typeof window.reorderAllIds === 'function') {
                const originalReorderAllIds = window.reorderAllIds;
                
                window.reorderAllIds = function(parentNode) {
                    if (!parentNode || !parentNode.children) return;
                    
                    // ID deÄŸiÅŸiklik haritasÄ±
                    const idMigrationMap = {};
                    
                    parentNode.children.forEach((child, index) => {
                        const oldId = child.id;
                        const newId = `${parentNode.id}.${index + 1}`;
                        
                        if (oldId !== newId) {
                            idMigrationMap[oldId] = newId;
                        }
                    });
                    
                    // Orijinal fonksiyonu Ã§aÄŸÄ±r
                    originalReorderAllIds(parentNode);
                    
                    // Ã–ÄŸrenci notlarÄ±nÄ± migrasyon et
                    if (Object.keys(idMigrationMap).length > 0) {
                        migrateGradesData(idMigrationMap);
                    }
                };
            }
        }, 1500);
    });
    
    /**
     * deleteNode fonksiyonunu veri koruma uyarÄ±sÄ± ilegeniÅŸlet
     */
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() {
            if (typeof window.deleteNode === 'function') {
                const originalDeleteNode = window.deleteNode;
                
                window.deleteNode = function(nodeId) {
                    if (!nodeId) return;
                    
                    // Ã–ÄŸrenci notlarÄ± var mÄ± kontrol et
                    const hasGrades = checkIfNodeHasGrades(nodeId);
                    
                    if (hasGrades) {
                        // Ekstra uyarÄ± ver
                        showModernConfirm(
                            "âš ï¸ DÄ°KKAT! NotlÄ± Soru/Rubrik Silme",
                            "Bu soru/rubrik iÃ§in Ã¶ÄŸrenci notlarÄ± girilmiÅŸ.\n\nSilme iÅŸlemi yapÄ±lÄ±rsa:\nâ€¢ Bu soruya ait notlar kalÄ±cÄ± olarak silinecek\nâ€¢ DiÄŸer sorularÄ±n notlarÄ± korunacak\nâ€¢ ID'ler yeniden dÃ¼zenlenecek\n\nDevam etmek istediÄŸinizden emin misiniz?",
                            function() {
                                // Orijinal fonksiyonu Ã§aÄŸÄ±r
                                originalDeleteNode(nodeId);
                            }
                        );
                        return;
                    }
                    
                    // Orijinal fonksiyonu Ã§aÄŸÄ±r
                    originalDeleteNode(nodeId);
                };
            }
        }, 1500);
    });
    
    /**
     * DÃ¼ÄŸÃ¼mÃ¼n not verisi olup olmadÄ±ÄŸÄ±nÄ± kontrol et
     */
    function checkIfNodeHasGrades(nodeId) {
        if (!APP_STATE.gradesData) return false;
        
        return Object.keys(APP_STATE.gradesData).some(studentId => {
            const studentGrades = APP_STATE.gradesData[studentId];
            if (!studentGrades) return false;
            
            // Direkt not kontrolÃ¼
            if (studentGrades.hasOwnProperty(nodeId)) return true;
            
            // Ham puanlar kontrolÃ¼
            if (studentGrades.hamPuanlar) {
                const questionNum = nodeId.split('.').pop();
                if (studentGrades.hamPuanlar.hasOwnProperty(questionNum)) return true;
            }
            
            // Grup bazlÄ± notlar kontrolÃ¼
            if (studentGrades.grupBazliNotlar) {
                return Object.values(studentGrades.grupBazliNotlar).some(groupGrades => 
                    groupGrades.hasOwnProperty(nodeId)
                );
            }
            
            return false;
        });
    }
    
    // Global fonksiyonlar
    window.migrateGradesData = migrateGradesData;
    window.checkIfNodeHasGrades = checkIfNodeHasGrades;
    
    // Test fonksiyonu
    window.testGradeMigration = function() {
        console.log('ğŸ§ª Not migrasyon sistemi test ediliyor...');
        const testMap = {'A1.2': 'A1.3', 'A1.3': 'A1.4'};
        migrateGradesData(testMap);
    };

    // =====================================================
    // GRUP HARÄ°TALAMA HATA DÃœZELTMESÄ°
    // =====================================================
    
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() {
            if (typeof window.updateGroupMappingForId === 'function') {
                const originalUpdateGroupMappingForId = window.updateGroupMappingForId;
                
                window.updateGroupMappingForId = function(oldId, newId) {
                    if (!APP_STATE.courseData || !APP_STATE.courseData.grupHaritalari) return;
                    
                    Object.keys(APP_STATE.courseData.grupHaritalari).forEach(groupName => {
                        const activities = APP_STATE.courseData.grupHaritalari[groupName];
                        
                        Object.keys(activities).forEach(activityId => {
                            const questionList = activities[activityId];
                            
                            // DÃœZELTME: questionList'in array olup olmadÄ±ÄŸÄ±nÄ± kontrol et
                            if (Array.isArray(questionList)) {
                                const index = questionList.indexOf(oldId);
                                if (index !== -1) {
                                    questionList[index] = newId;
                                }
                            } else {
                                console.warn(`Grup haritalama problemi: ${groupName}.${activityId} array deÄŸil:`, questionList);
                            }
                        });
                    });
                };
            }
        }, 2000);
    });

// =====================================================
// YENÄ° GRUP YÃ–NETÄ°MÄ° SÄ°STEMÄ°
// =====================================================

/**
 * Bir etkinlik iÃ§in grup haritalama bilgisi oluÅŸtur
 * @param {string} activityId - Etkinlik ID'si
 * @returns {Object} - Grup haritalama bilgisi
 */
function createGroupMappingForActivity(activityId) {
    const activity = APP_STATE.assessmentTree.find(node => node.id === activityId);
    if (!activity || !activity.children) {
        return {
            gruplar: ["A"],
            haritalar: {
                "A": {}
            }
        };
    }
    
    // Mevcut grup haritalama bilgisini al
    const existingMapping = APP_STATE.courseData?.grupHaritalari?.[activityId];
    
    if (existingMapping) {
        return existingMapping;
    }
    
    // Default haritalama oluÅŸtur - her etkinlik en az A grubu var
    const mappings = {
        "A": {}
    };
    
    // TÃ¼m sorularÄ± A grubunda sÄ±rayla ekle
    activity.children.forEach((child, index) => {
        mappings.A[(index + 1).toString()] = child.id;
    });
    
    return {
        gruplar: ["A"],
        haritalar: mappings
    };
}

/**
 * DeÄŸerlendirme verilerinden grup haritalama bilgilerini yÃ¼kle
 * @param {Object} jsonData - JSON verisi
 */
function loadGroupMappingsFromAssessmentData(jsonData) {
    console.log("ğŸš€ === loadGroupMappingsFromAssessmentData BAÅLADI ===");
    console.log("ğŸ“„ Fonksiyon Ã§aÄŸrÄ±ldÄ±, parametre tipi:", typeof jsonData);
    console.log("ğŸ“„ JSON data var mÄ±:", !!jsonData);
    
    try {
        console.log("ğŸ” loadGroupMappingsFromAssessmentData baÅŸlatÄ±ldÄ±...");
        console.log("ğŸ“„ Gelen JSON data keys:", Object.keys(jsonData));
        
        if (!APP_STATE.courseData) APP_STATE.courseData = {};
        if (!APP_STATE.courseData.grupHaritalari) APP_STATE.courseData.grupHaritalari = {};
        
        // v5 format iÃ§in Ã¶zel iÅŸlem - dersDegerlendirme iÃ§indeki etkinlikleri kontrol et
        const dersDegerlendirme = jsonData.dersDegerlendirme;
        console.log("ğŸ“Š dersDegerlendirme var mÄ±:", !!dersDegerlendirme);
        
        if (dersDegerlendirme) {
            // YarÄ±yÄ±l iÃ§i etkinlikler
            if (dersDegerlendirme.yariyilIciEtkinlikleri) {
                console.log("ğŸ” YarÄ±yÄ±l iÃ§i etkinlikler bulundu:", dersDegerlendirme.yariyilIciEtkinlikleri.length);
                dersDegerlendirme.yariyilIciEtkinlikleri.forEach(activity => {
                    console.log(`ğŸ” Etkinlik kontrol ediliyor: ${activity.id}`, activity);
                    if (activity.grupBilgileri) {
                        APP_STATE.courseData.grupHaritalari[activity.id] = activity.grupBilgileri;
                        console.log(`âœ… Grup bilgileri yÃ¼klendi: ${activity.id}`, activity.grupBilgileri);
                    } else {
                        console.log(`âš ï¸ ${activity.id} iÃ§in grup bilgisi bulunamadÄ±`);
                    }
                });
            } else {
                console.log("âš ï¸ YarÄ±yÄ±l iÃ§i etkinlikler bulunamadÄ±");
            }
            
            // YarÄ±yÄ±l sonu etkinlikler
            if (dersDegerlendirme.yariyilSonuEtkinlikleri) {
                console.log("ğŸ” YarÄ±yÄ±l sonu etkinlikler bulundu:", dersDegerlendirme.yariyilSonuEtkinlikleri.length);
                dersDegerlendirme.yariyilSonuEtkinlikleri.forEach(activity => {
                    console.log(`ğŸ” Etkinlik kontrol ediliyor: ${activity.id}`, activity);
                    if (activity.grupBilgileri) {
                        APP_STATE.courseData.grupHaritalari[activity.id] = activity.grupBilgileri;
                        console.log(`âœ… Grup bilgileri yÃ¼klendi: ${activity.id}`, activity.grupBilgileri);
                    } else {
                        console.log(`âš ï¸ ${activity.id} iÃ§in grup bilgisi bulunamadÄ±`);
                    }
                });
            } else {
                console.log("âš ï¸ YarÄ±yÄ±l sonu etkinlikler bulunamadÄ±");
            }
        }
        
        // SADECE Ã¶ÄŸrenci grup bilgilerini yÃ¼kle - mapping bilgilerini etkinlik verilerinden al
        if (jsonData.ogrenciNotlari) {
            console.log("ğŸ” Ã–ÄŸrenci grup bilgileri yÃ¼kleniyor...");
            
            // Ã–ÄŸrenci grup bilgilerini yÃ¼kle
            Object.keys(jsonData.ogrenciNotlari).forEach(studentId => {
                const studentGrades = jsonData.ogrenciNotlari[studentId];
                if (studentGrades.grupBilgileri) {
                    // v5 formatÄ±nda grup bilgilerini studentComponentGroups'a yÃ¼kle
                    if (!APP_STATE.studentComponentGroups) APP_STATE.studentComponentGroups = {};
                    if (!APP_STATE.studentComponentGroups[studentId]) APP_STATE.studentComponentGroups[studentId] = {};
                    
                    Object.keys(studentGrades.grupBilgileri).forEach(activityId => {
                        APP_STATE.studentComponentGroups[studentId][activityId] = studentGrades.grupBilgileri[activityId];
                    });
                    console.log(`âœ… Ã–ÄŸrenci grup bilgileri yÃ¼klendi: ${studentId}`, studentGrades.grupBilgileri);
                }
            });
        }
        
        console.log("ğŸ¯ TÃ¼m grup haritalama bilgileri yÃ¼klendi:", APP_STATE.courseData.grupHaritalari);
        console.log("ğŸ‘¥ Ã–ÄŸrenci grup atamalarÄ± (v5 format):", APP_STATE.studentComponentGroups);
        
        // Debug: Her bileÅŸen iÃ§in grup bilgilerini detaylÄ± yazdÄ±r
        Object.keys(APP_STATE.courseData.grupHaritalari || {}).forEach(componentId => {
            const component = APP_STATE.courseData.grupHaritalari[componentId];
            console.log(`ğŸ“Š ${componentId} grup detaylarÄ±:`, {
                gruplar: component.gruplar,
                haritalar: component.haritalar,
                mappingCount: Object.keys(component.haritalar || {}).length
            });
        });
        
        console.log("âœ… loadGroupMappingsFromAssessmentData tamamlandÄ±");
    } catch (error) {
        console.error("âŒ Grup haritalama bilgileri yÃ¼klenirken hata oluÅŸtu:", error);
    }
}

/**
 * Ã–ÄŸrenci notlarÄ±nÄ± yeni yapÄ±ya gÃ¶re yÃ¼kle - v5 formatÄ±nÄ± tam destekler
 * @param {Object} jsonData - JSON verisi
 */
function loadStudentGradesNewFormat(jsonData) {
    try {
        if (!jsonData.ogrenciNotlari) return;
        
        // Not verilerini temizle
        APP_STATE.gradesData = {};
        
        Object.keys(jsonData.ogrenciNotlari).forEach(studentId => {
            const studentGrades = jsonData.ogrenciNotlari[studentId];
            
            if (!APP_STATE.gradesData[studentId]) {
                APP_STATE.gradesData[studentId] = {};
            }
            
            // Her etkinlik iÃ§in notlarÄ± yÃ¼kle
            Object.keys(studentGrades).forEach(activityId => {
                if (activityId === 'grupBilgileri') return; // Grup bilgilerini atla
                
                const activityGrades = studentGrades[activityId];
                if (typeof activityGrades === 'object') {
                    // v5 Format: Pozisyon bazlÄ± notlar (1, 2, 3, 4, 5...)
                    // Hem pozisyon bilgisini hem de soru ID bilgisini koru
                    APP_STATE.gradesData[studentId][activityId] = {};
                    
                    Object.keys(activityGrades).forEach(questionOrder => {
                        const gradeInfo = activityGrades[questionOrder];
                        if (gradeInfo && typeof gradeInfo === 'object' && gradeInfo.soruId && gradeInfo.puan !== undefined) {
                            // v5 Format: Pozisyon bazlÄ± yapÄ±yÄ± koru
                            APP_STATE.gradesData[studentId][activityId][questionOrder] = {
                                puan: gradeInfo.puan,
                                soruId: gradeInfo.soruId
                            };
                            
                            // Geriye uyumluluk iÃ§in soru ID'si ile de kaydet
                            APP_STATE.gradesData[studentId][gradeInfo.soruId] = gradeInfo.puan;
                        }
                    });
                }
            });
            
            // Grup bilgilerini v5 formatÄ±ndan yÃ¼kle
            if (studentGrades.grupBilgileri) {
                // v5 formatÄ±nda grup bilgilerini studentComponentGroups'a yÃ¼kle
                if (!APP_STATE.studentComponentGroups) APP_STATE.studentComponentGroups = {};
                if (!APP_STATE.studentComponentGroups[studentId]) APP_STATE.studentComponentGroups[studentId] = {};
                
                Object.keys(studentGrades.grupBilgileri).forEach(activityId => {
                    APP_STATE.studentComponentGroups[studentId][activityId] = studentGrades.grupBilgileri[activityId];
                });
                
                // AyrÄ±ca gradesData'ya da kaydet (v5 format uyumluluÄŸu iÃ§in)
                APP_STATE.gradesData[studentId].grupBilgileri = studentGrades.grupBilgileri;
            }
        });
        
                        console.log("âœ… Ã–ÄŸrenci notlarÄ± Tam Dosya formatÄ±nda tam olarak yÃ¼klendi");
        console.log("ğŸ“Š YÃ¼klenen Ã¶ÄŸrenci sayÄ±sÄ±:", Object.keys(APP_STATE.gradesData).length);
    } catch (error) {
        console.error("Ã–ÄŸrenci notlarÄ± yÃ¼klenirken hata oluÅŸtu:", error);
    }
}

/**
 * Tam dosya formatÄ±nda yarÄ±yÄ±l iÃ§i etkinlik oluÅŸturma fonksiyonu
 */
function generateTamDosyaTermAssessmentWithParams(activityCount, componentCount, activityType) {
    try {
        showModernToast(`ğŸ“š Tam dosya formatÄ±nda ${activityCount} yarÄ±yÄ±l iÃ§i etkinlik oluÅŸturuluyor...`, 'info', 3000);
        
        // Tam dosya formatÄ±na uygun etkinlik tÃ¼rleri
        const activityTypes = [
            'Ara SÄ±nav', 'Quiz', 'Ev Ã–devi', 'Proje HazÄ±rlama', 'Laboratuvar', 'Proje Sunma', 
            'Rapor', 'Deney', 'Performans', 'Makale Kritik Etme', 'Seminer', 'SÃ¶zlÃ¼ SÄ±nav'
        ];
        
        // Tam dosya formatÄ±na uygun Ã¶ÄŸrenme Ã§Ä±ktÄ±larÄ±
        const learningOutcomes = ['Ã–Ã‡.1', 'Ã–Ã‡.2', 'Ã–Ã‡.3', 'Ã–Ã‡.4', 'Ã–Ã‡.5', 'Ã–Ã‡.6', 'Ã–Ã‡.7'];
        
        // Yeni V5 formatÄ±nda etkinlikler oluÅŸtur
        const newActivities = [];
        let totalWeight = 0;
        
        // Mevcut A etkinlik sayÄ±sÄ±nÄ± bul
        const existingTermActivities = APP_STATE.courseData?.dersDegerlendirme?.yariyilIciEtkinlikleri || [];
        let startIndex = existingTermActivities.length + 1;
        
        for (let i = 0; i < activityCount; i++) {
            const selectedType = activityType === 'random' ? 
                activityTypes[Math.floor(Math.random() * activityTypes.length)] : 
                activityType;
            
            const weight = Math.floor(Math.random() * 30) + 15; // 15-45 arasÄ± aÄŸÄ±rlÄ±k
            totalWeight += weight;
            
            // V5 formatÄ±nda soru/rubrik detaylarÄ± oluÅŸtur
            const details = [];
            const componentWeight = Math.floor(100 / componentCount);
            
            for (let j = 1; j <= componentCount; j++) {
                const isRubric = Math.random() > 0.6; // %40 rubrik, %60 soru
                details.push({
                    id: `A${startIndex + i}.${j}`,
                    isim: isRubric ? `Rubrik ${j}` : `Soru ${j}`,
                    tip: isRubric ? 'Rubrik' : 'Soru',
                    agirlik: componentWeight,
                    puan: Math.floor(Math.random() * 20) + 10, // 10-30 puan arasÄ±
                    ogrenmeÃ‡iktilari: [learningOutcomes[Math.floor(Math.random() * learningOutcomes.length)]],
                    aciklama: isRubric ? 
                        `Rubrik deÄŸerlendirme kriteri` : 
                        `DeÄŸerlendirme sorusu`
                });
            }
            
            // V5 formatÄ±nda grup bilgileri oluÅŸtur (A ve B gruplarÄ±)
            const groupMappings = {
                "A": {},
                "B": {}
            };
            
            // A grubu iÃ§in sÄ±ralÄ± mapping
            for (let pos = 1; pos <= componentCount; pos++) {
                groupMappings.A[pos.toString()] = `A${startIndex + i}.${pos}`;
            }
            
            // B grubu iÃ§in karÄ±ÅŸÄ±k mapping
            const shuffledPositions = Array.from({length: componentCount}, (_, idx) => idx + 1);
            for (let k = shuffledPositions.length - 1; k > 0; k--) {
                const j = Math.floor(Math.random() * (k + 1));
                [shuffledPositions[k], shuffledPositions[j]] = [shuffledPositions[j], shuffledPositions[k]];
            }
            
            for (let pos = 1; pos <= componentCount; pos++) {
                groupMappings.B[pos.toString()] = `A${startIndex + i}.${shuffledPositions[pos - 1]}`;
            }
            
            // V5 formatÄ±nda etkinlik oluÅŸtur
            newActivities.push({
                id: `A${startIndex + i}`,
                etkinlik: selectedType,
                sayi: 1,
                katkiYuzdesi: weight,
                detaylar: details,
                grupBilgileri: {
                    gruplar: ["A", "B"],
                    haritalar: groupMappings
                }
            });
        }
        
        // AÄŸÄ±rlÄ±klarÄ± normalize et (toplam 100 olacak ÅŸekilde)
        if (totalWeight > 0) {
            const normalizationFactor = 100 / totalWeight;
            newActivities.forEach(activity => {
                activity.katkiYuzdesi = Math.round(activity.katkiYuzdesi * normalizationFactor);
            });
        }
        
        // V5 formatÄ±nda APP_STATE'i gÃ¼ncelle
        if (!APP_STATE.courseData) {
            APP_STATE.courseData = { 
                dersDegerlendirme: { 
                    yariyilIciEtkinlikleri: [],
                    yariyilSonuEtkinlikleri: []
                },
                ogrenciNotlari: {}
            };
        }
        if (!APP_STATE.courseData.dersDegerlendirme) {
            APP_STATE.courseData.dersDegerlendirme = { 
                yariyilIciEtkinlikleri: [],
                yariyilSonuEtkinlikleri: []
            };
        }
        if (!APP_STATE.courseData.dersDegerlendirme.yariyilIciEtkinlikleri) {
            APP_STATE.courseData.dersDegerlendirme.yariyilIciEtkinlikleri = [];
        }
        
        // Mevcut etkinliklere V5 formatÄ±nda ekle
        APP_STATE.courseData.dersDegerlendirme.yariyilIciEtkinlikleri.push(...newActivities);
        
        // courseData referansÄ±nÄ± gÃ¼ncelle
        if (typeof courseData !== 'undefined') {
            courseData = APP_STATE.courseData;
        }
        
        // courseData'dan assessmentTree'ye dÃ¶nÃ¼ÅŸtÃ¼r
        convertCourseDataToAssessmentTree();
        
        // UI gÃ¼ncellemeleri
        updateAssessmentView();
        renderTree();
        updateCategoryWeights();
        updateAssessmentView();
        
        const summary = `âœ… Tam Dosya formatÄ±nda ${activityCount} yarÄ±yÄ±l iÃ§i etkinlik oluÅŸturuldu!\n` +
                       `ğŸ“ Her etkinlikte ${componentCount} soru/rubrik\n` +
                       `ğŸ¯ Etkinlik tÃ¼rÃ¼: ${activityType}\n` +
                       `ğŸ² A ve B gruplarÄ± otomatik oluÅŸturuldu\n` +
                       `âš–ï¸ AÄŸÄ±rlÄ±klar otomatik normalize edildi`;
        
        console.log('âœ… Tam Dosya formatÄ±nda yarÄ±yÄ±l iÃ§i etkinlik oluÅŸturma tamamlandÄ±');
        showModernToast(summary, 'success', 5000);
        
    } catch (error) {
        console.error('âŒ Tam Dosya yarÄ±yÄ±l iÃ§i etkinlik oluÅŸturulurken hata:', error);
        showModernToast('Tam Dosya yarÄ±yÄ±l iÃ§i etkinlik oluÅŸturulamadÄ±!', 'error');
    }
}

/**
 * courseData'dan assessmentTree'ye dÃ¶nÃ¼ÅŸtÃ¼rme fonksiyonu
 */
function convertCourseDataToAssessmentTree() {
    try {
        console.log('ğŸ”„ courseData assessmentTree\'ye dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lÃ¼yor...');
        
        if (!APP_STATE.courseData?.dersDegerlendirme) {
            console.warn('âš ï¸ courseData.dersDegerlendirme bulunamadÄ±');
            return;
        }
        
        const newAssessmentTree = [];
        
        // YarÄ±yÄ±l iÃ§i etkinlikleri dÃ¶nÃ¼ÅŸtÃ¼r
        const termActivities = APP_STATE.courseData.dersDegerlendirme.yariyilIciEtkinlikleri || [];
        termActivities.forEach(activity => {
            const treeNode = {
                id: activity.id,
                name: activity.etkinlik,
                type: activity.etkinlik,
                weight: activity.katkiYuzdesi,
                points: 100, // VarsayÄ±lan
                outcomes: [], // Ã‡ocuklarÄ±n outcomes'larÄ±ndan al
                description: `${activity.etkinlik} (${activity.sayi} adet)`,
                expanded: true,
                children: []
            };
            
            // Alt detaylarÄ± ekle
            if (activity.detaylar) {
                activity.detaylar.forEach(detail => {
                    treeNode.children.push({
                        id: detail.id,
                        name: detail.isim,
                        type: detail.tip,
                        weight: detail.agirlik,
                        points: detail.puan,
                        outcomes: detail.ogrenmeÃ‡iktilari || [],
                        description: detail.aciklama || '',
                        expanded: false,
                        children: []
                    });
                });
                
                // Outcomes'larÄ± Ã§ocuklardan topla
                treeNode.outcomes = [...new Set(
                    treeNode.children.flatMap(child => child.outcomes || [])
                )];
            }
            
            newAssessmentTree.push(treeNode);
        });
        
        // YarÄ±yÄ±l sonu etkinlikleri dÃ¶nÃ¼ÅŸtÃ¼r
        const finalActivities = APP_STATE.courseData.dersDegerlendirme.yariyilSonuEtkinlikleri || [];
        finalActivities.forEach(activity => {
            const treeNode = {
                id: activity.id,
                name: activity.etkinlik,
                type: activity.etkinlik,
                weight: activity.katkiYuzdesi,
                points: 100, // VarsayÄ±lan
                outcomes: [], // Ã‡ocuklarÄ±n outcomes'larÄ±ndan al
                description: `${activity.etkinlik} (${activity.sayi} adet)`,
                expanded: true,
                children: []
            };
            
            // Alt detaylarÄ± ekle
            if (activity.detaylar) {
                activity.detaylar.forEach(detail => {
                    treeNode.children.push({
                        id: detail.id,
                        name: detail.isim,
                        type: detail.tip,
                        weight: detail.agirlik,
                        points: detail.puan,
                        outcomes: detail.ogrenmeÃ‡iktilari || [],
                        description: detail.aciklama || '',
                        expanded: false,
                        children: []
                    });
                });
                
                // Outcomes'larÄ± Ã§ocuklardan topla
                treeNode.outcomes = [...new Set(
                    treeNode.children.flatMap(child => child.outcomes || [])
                )];
            }
            
            newAssessmentTree.push(treeNode);
        });
        
        // APP_STATE.assessmentTree'yi gÃ¼ncelle
        APP_STATE.assessmentTree = newAssessmentTree;
        
        console.log('âœ… courseData baÅŸarÄ±yla assessmentTree\'ye dÃ¶nÃ¼ÅŸtÃ¼rÃ¼ldÃ¼:', newAssessmentTree.length, 'etkinlik');
        
    } catch (error) {
        console.error('âŒ courseData assessmentTree\'ye dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lÃ¼rken hata:', error);
        showModernToast('Veri dÃ¶nÃ¼ÅŸtÃ¼rme hatasÄ±!', 'error');
    }
}

/**
 * Tam dosya formatÄ±nda yarÄ±yÄ±l sonu etkinlik oluÅŸturma fonksiyonu
 */
function generateTamDosyaFinalAssessmentWithParams(activityCount, componentCount, activityType) {
    try {
        showModernToast(`ğŸ¯ Tam dosya formatÄ±nda ${activityCount} yarÄ±yÄ±l sonu etkinlik oluÅŸturuluyor...`, 'info', 3000);
        
        // Tam dosya formatÄ±na uygun yarÄ±yÄ±l sonu etkinlik tÃ¼rleri
        const finalActivityTypes = [
            'Final SÄ±navÄ±', 'Laboratuvar Ara SÄ±navÄ±', 'Makale Yazma', 'Proje HazÄ±rlama', 
            'Proje Sunma', 'Proje TasarÄ±mÄ±/YÃ¶netimi', 'Quiz', 'Rapor', 'Rapor HazÄ±rlama', 
            'Rapor Sunma', 'Seminer', 'SÃ¶zlÃ¼ SÄ±nav', 'GÃ¶zlem'
        ];
        
        // Tam dosya formatÄ±na uygun Ã¶ÄŸrenme Ã§Ä±ktÄ±larÄ±
        const learningOutcomes = ['Ã–Ã‡.1', 'Ã–Ã‡.2', 'Ã–Ã‡.3', 'Ã–Ã‡.4', 'Ã–Ã‡.5', 'Ã–Ã‡.6', 'Ã–Ã‡.7'];
        
        // Yeni V5 formatÄ±nda etkinlikler oluÅŸtur
        const newActivities = [];
        let totalWeight = 0;
        
        // Mevcut F etkinlik sayÄ±sÄ±nÄ± bul
        const existingFinalActivities = APP_STATE.courseData?.dersDegerlendirme?.yariyilSonuEtkinlikleri || [];
        let startIndex = existingFinalActivities.length + 1;
        
        for (let i = 0; i < activityCount; i++) {
            const selectedType = activityType === 'random' ? 
                finalActivityTypes[Math.floor(Math.random() * finalActivityTypes.length)] : 
                activityType;
            
            const weight = Math.floor(Math.random() * 40) + 40; // 40-80 arasÄ± aÄŸÄ±rlÄ±k (final iÃ§in)
            totalWeight += weight;
            
            // V5 formatÄ±nda soru/rubrik detaylarÄ± oluÅŸtur
            const details = [];
            const componentWeight = Math.floor(100 / componentCount);
            
            for (let j = 1; j <= componentCount; j++) {
                const isRubric = Math.random() > 0.7; // %30 rubrik, %70 soru (final iÃ§in)
                details.push({
                    id: `F${startIndex + i}.${j}`,
                    isim: isRubric ? `Rubrik ${j}` : `Soru ${j}`,
                    tip: isRubric ? 'Rubrik' : 'Soru',
                    agirlik: componentWeight,
                    puan: Math.floor(Math.random() * 25) + 15, // 15-40 puan arasÄ± (final iÃ§in)
                    ogrenmeÃ‡iktilari: [learningOutcomes[Math.floor(Math.random() * learningOutcomes.length)]],
                    aciklama: isRubric ? 
                        `Final rubrik deÄŸerlendirme kriteri` : 
                        `Final deÄŸerlendirme sorusu`
                });
            }
            
            // V5 formatÄ±nda grup bilgileri oluÅŸtur (A ve B gruplarÄ±)
            const groupMappings = {
                "A": {},
                "B": {}
            };
            
            // A grubu iÃ§in sÄ±ralÄ± mapping
            for (let pos = 1; pos <= componentCount; pos++) {
                groupMappings.A[pos.toString()] = `F${startIndex + i}.${pos}`;
            }
            
            // B grubu iÃ§in karÄ±ÅŸÄ±k mapping
            const shuffledPositions = Array.from({length: componentCount}, (_, idx) => idx + 1);
            for (let k = shuffledPositions.length - 1; k > 0; k--) {
                const j = Math.floor(Math.random() * (k + 1));
                [shuffledPositions[k], shuffledPositions[j]] = [shuffledPositions[j], shuffledPositions[k]];
            }
            
            for (let pos = 1; pos <= componentCount; pos++) {
                groupMappings.B[pos.toString()] = `F${startIndex + i}.${shuffledPositions[pos - 1]}`;
            }
            
            // V5 formatÄ±nda etkinlik oluÅŸtur
            newActivities.push({
                id: `F${startIndex + i}`,
                etkinlik: selectedType,
                sayi: 1,
                katkiYuzdesi: weight,
                detaylar: details,
                grupBilgileri: {
                    gruplar: ["A", "B"],
                    haritalar: groupMappings
                }
            });
        }
        
        // AÄŸÄ±rlÄ±klarÄ± normalize et (toplam 100 olacak ÅŸekilde)
        if (totalWeight > 0) {
            const normalizationFactor = 100 / totalWeight;
            newActivities.forEach(activity => {
                activity.katkiYuzdesi = Math.round(activity.katkiYuzdesi * normalizationFactor);
            });
        }
        
        // V5 formatÄ±nda APP_STATE'i gÃ¼ncelle
        if (!APP_STATE.courseData) {
            APP_STATE.courseData = { 
                dersDegerlendirme: { 
                    yariyilIciEtkinlikleri: [],
                    yariyilSonuEtkinlikleri: []
                },
                ogrenciNotlari: {}
            };
        }
        if (!APP_STATE.courseData.dersDegerlendirme) {
            APP_STATE.courseData.dersDegerlendirme = { 
                yariyilIciEtkinlikleri: [],
                yariyilSonuEtkinlikleri: []
            };
        }
        if (!APP_STATE.courseData.dersDegerlendirme.yariyilSonuEtkinlikleri) {
            APP_STATE.courseData.dersDegerlendirme.yariyilSonuEtkinlikleri = [];
        }
        
        // Mevcut etkinliklere V5 formatÄ±nda ekle
        APP_STATE.courseData.dersDegerlendirme.yariyilSonuEtkinlikleri.push(...newActivities);
        
        // courseData referansÄ±nÄ± gÃ¼ncelle
        if (typeof courseData !== 'undefined') {
            courseData = APP_STATE.courseData;
        }
        
        // courseData'dan assessmentTree'ye dÃ¶nÃ¼ÅŸtÃ¼r
        convertCourseDataToAssessmentTree();
        
        // UI gÃ¼ncellemeleri
        updateAssessmentView();
        renderTree();
        updateCategoryWeights();
        
        const summary = `âœ… Tam Dosya formatÄ±nda ${activityCount} yarÄ±yÄ±l sonu etkinlik oluÅŸturuldu!\n` +
                       `ğŸ“ Her etkinlikte ${componentCount} soru/rubrik\n` +
                       `ğŸ¯ Etkinlik tÃ¼rÃ¼: ${activityType}\n` +
                       `ğŸ² A ve B gruplarÄ± otomatik oluÅŸturuldu\n` +
                       `âš–ï¸ AÄŸÄ±rlÄ±klar otomatik normalize edildi`;
        
        console.log('âœ… Tam Dosya formatÄ±nda yarÄ±yÄ±l sonu etkinlik oluÅŸturma tamamlandÄ±');
        showModernToast(summary, 'success', 5000);
        
    } catch (error) {
        console.error('âŒ Tam Dosya yarÄ±yÄ±l sonu etkinlik oluÅŸturulurken hata:', error);
        showModernToast('Tam Dosya yarÄ±yÄ±l sonu etkinlik oluÅŸturulamadÄ±!', 'error');
    }
}

/**
 * JSON formatÄ±nÄ±n Tam Dosya (not giriÅŸi yapÄ±lmÄ±ÅŸ) olup olmadÄ±ÄŸÄ±nÄ± kontrol eder
 */
function isTamDosyaFormat(jsonData) {
    // Tam dosya format kontrol kriterleri
    const hasTamDosyaStructure = jsonData.dersDegerlendirme && 
                                jsonData.dersDegerlendirme.yariyilIciEtkinlikleri &&
                                Array.isArray(jsonData.dersDegerlendirme.yariyilIciEtkinlikleri) &&
                                jsonData.dersDegerlendirme.yariyilIciEtkinlikleri.some(activity => 
                                    activity.grupBilgileri || activity.detaylar
                                );
    
    const hasTamDosyaGrades = jsonData.ogrenciNotlari && 
                             typeof jsonData.ogrenciNotlari === 'object' &&
                             Object.values(jsonData.ogrenciNotlari).some(student => 
                                 student && typeof student === 'object' && 
                                 (student.grupBilgileri || student.etkinlikNotlari)
                             );
    
    console.log("ğŸ” Tam Dosya Format kontrolÃ¼:", {
        hasTamDosyaStructure,
        hasTamDosyaGrades,
        isTamDosya: hasTamDosyaStructure || hasTamDosyaGrades
    });
    
    return hasTamDosyaStructure || hasTamDosyaGrades;
}

/**
 * Temel dosya format iÃ§in default grup sistemi oluÅŸturur
 */
function createDefaultGroupSystemForTemelDosya() {
    try {
        console.log("ğŸ¯ Temel dosya format iÃ§in default grup sistemi oluÅŸturuluyor...");
        
        if (!APP_STATE.assessmentTree || APP_STATE.assessmentTree.length === 0) {
            console.log("âš ï¸ Assessment tree boÅŸ, Ã¶nce aÄŸaÃ§ oluÅŸturuluyor...");
            return;
        }
        
        // CourseData yapÄ±sÄ±nÄ± hazÄ±rla
        if (!APP_STATE.courseData) {
            APP_STATE.courseData = {};
        }
        if (!APP_STATE.courseData.grupHaritalari) {
            APP_STATE.courseData.grupHaritalari = {};
        }
        if (!APP_STATE.courseData.ogrenciNotlari) {
            APP_STATE.courseData.ogrenciNotlari = {};
        }
        
        let totalMappingsCreated = 0;
        let componentsProcessed = 0;
        
        // Assessment tree'deki her bileÅŸen iÃ§in grup sistemi oluÅŸtur
        function processNode(node) {
            if (!node || !node.id) return;
            
            console.log(`ğŸ”§ BileÅŸen iÅŸleniyor: ${node.id} - ${node.name}`);
            
            // Bu bileÅŸen iÃ§in grup bilgisi oluÅŸtur
            if (!APP_STATE.courseData.grupHaritalari[node.id]) {
                APP_STATE.courseData.grupHaritalari[node.id] = {
                    gruplar: ['A'],
                    haritalar: {
                        'A': {}
                    }
                };
                console.log(`âœ… ${node.id} iÃ§in A grubu oluÅŸturuldu`);
                componentsProcessed++;
            }
            
            // Alt bileÅŸenleri varsa onlarÄ± A grubuna sÄ±rayla ata
            if (node.children && Array.isArray(node.children) && node.children.length > 0) {
                const groupMapping = APP_STATE.courseData.grupHaritalari[node.id].haritalar['A'];
                
                node.children.forEach((child, index) => {
                    const position = (index + 1).toString();
                    const questionId = child.id;
                    
                    // Position: QuestionId formatÄ±nda mapping oluÅŸtur
                    groupMapping[position] = questionId;
                    totalMappingsCreated++;
                    
                    console.log(`  ğŸ“ ${questionId} â†’ A:${position}`);
                });
                
                console.log(`âœ… ${node.id} iÃ§in ${node.children.length} soru A grubuna atandÄ±`);
            }
            
            // Alt dÃ¼ÄŸÃ¼mleri de iÅŸle
            if (node.children && Array.isArray(node.children)) {
                node.children.forEach(child => processNode(child));
            }
        }
        
        // TÃ¼m assessment tree'yi iÅŸle
        APP_STATE.assessmentTree.forEach(rootNode => processNode(rootNode));
        
        // Ã–ÄŸrenciler iÃ§in grup atamasÄ±
        if (APP_STATE.studentData && Array.isArray(APP_STATE.studentData)) {
            APP_STATE.studentData.forEach(student => {
                // Her Ã¶ÄŸrenciyi A grubuna ata
                if (!student.grup || student.grup === '') {
                    student.grup = 'A';
                }
                
                // CourseData'da Ã¶ÄŸrenci not yapÄ±sÄ± oluÅŸtur
                if (!APP_STATE.courseData.ogrenciNotlari[student.studentId]) {
                    APP_STATE.courseData.ogrenciNotlari[student.studentId] = {
                        grupBilgileri: {}
                    };
                }
                
                // Her bileÅŸen iÃ§in Ã¶ÄŸrenciyi A grubuna ata
                Object.keys(APP_STATE.courseData.grupHaritalari).forEach(componentId => {
                    APP_STATE.courseData.ogrenciNotlari[student.studentId].grupBilgileri[componentId] = 'A';
                });
            });
            
            console.log(`âœ… ${APP_STATE.studentData.length} Ã¶ÄŸrenci A grubuna atandÄ±`);
        }
        
        // Grup sistemini baÅŸlat
        initializeGroupSystem();
        
        // UI gÃ¼ncellemeleri
        updateStudentTable();
        updateGroupSelectors();
        updateAssessmentView();
        updateAllInlineGroupInputs();
        
        console.log(`\nğŸ“Š DEFAULT GRUP SÄ°STEMÄ° RAPORU:`);
        console.log(`   âœ… Ä°ÅŸlenen bileÅŸen: ${componentsProcessed}`);
        console.log(`   ğŸ“ OluÅŸturulan mapping: ${totalMappingsCreated}`);
        console.log(`   ğŸ‘¥ A grubuna atanan Ã¶ÄŸrenci: ${APP_STATE.studentData?.length || 0}`);
        
        showModernToast(`Default grup sistemi oluÅŸturuldu: ${componentsProcessed} bileÅŸen, ${totalMappingsCreated} soru mapping'i`, "success");
        
    } catch (error) {
        console.error("âŒ Default grup sistemi oluÅŸturulurken hata:", error);
        showModernToast("Default grup sistemi oluÅŸturulamadÄ±!", "error");
    }
}

/**
 * Yeni eklenen etkinlik iÃ§in otomatik grup atamasÄ±
 */
function assignDefaultGroupsToNewActivity(activityNode) {
    try {
        if (!activityNode || !activityNode.id) {
            console.log("âš ï¸ GeÃ§ersiz etkinlik node'u, grup atamasÄ± yapÄ±lamÄ±yor");
            return;
        }
        
        console.log(`ğŸ¯ Yeni etkinlik iÃ§in grup atamasÄ±: ${activityNode.id} - ${activityNode.name}`);
        
        // CourseData yapÄ±sÄ±nÄ± hazÄ±rla
        if (!APP_STATE.courseData) {
            APP_STATE.courseData = {};
        }
        if (!APP_STATE.courseData.grupHaritalari) {
            APP_STATE.courseData.grupHaritalari = {};
        }
        
        // Bu etkinlik iÃ§in grup bilgisi oluÅŸtur
        APP_STATE.courseData.grupHaritalari[activityNode.id] = {
            gruplar: ['A'],
            haritalar: {
                'A': {}
            }
        };
        
        console.log(`âœ… ${activityNode.id} iÃ§in A grubu oluÅŸturuldu`);
        
        // Alt bileÅŸenleri varsa onlarÄ± A grubuna sÄ±rayla ata
        if (activityNode.children && Array.isArray(activityNode.children) && activityNode.children.length > 0) {
            // Grup mapping'ini kontrol et ve oluÅŸtur
            if (!APP_STATE.courseData.grupHaritalari[activityNode.id].haritalar) {
                APP_STATE.courseData.grupHaritalari[activityNode.id].haritalar = {};
            }
            if (!APP_STATE.courseData.grupHaritalari[activityNode.id].haritalar['A']) {
                APP_STATE.courseData.grupHaritalari[activityNode.id].haritalar['A'] = {};
            }
            
            const groupMapping = APP_STATE.courseData.grupHaritalari[activityNode.id].haritalar['A'];
            
            activityNode.children.forEach((child, index) => {
                const position = (index + 1).toString();
                const questionId = child.id;
                
                // Position: QuestionId formatÄ±nda mapping oluÅŸtur
                groupMapping[position] = questionId;
                
                console.log(`  ğŸ“ ${questionId} â†’ A:${position}`);
            });
            
            console.log(`âœ… ${activityNode.id} iÃ§in ${activityNode.children.length} soru A grubuna atandÄ±`);
        }
        
        // Mevcut Ã¶ÄŸrenciler iÃ§in bu etkinlikte A grubu atamasÄ±
        if (APP_STATE.studentData && Array.isArray(APP_STATE.studentData)) {
            APP_STATE.studentData.forEach(student => {
                // CourseData'da Ã¶ÄŸrenci yapÄ±sÄ±nÄ± kontrol et
                if (!APP_STATE.courseData.ogrenciNotlari) {
                    APP_STATE.courseData.ogrenciNotlari = {};
                }
                if (!APP_STATE.courseData.ogrenciNotlari[student.studentId]) {
                    APP_STATE.courseData.ogrenciNotlari[student.studentId] = {
                        grupBilgileri: {}
                    };
                }
                
                // Bu etkinlik iÃ§in Ã¶ÄŸrenciyi A grubuna ata
                APP_STATE.courseData.ogrenciNotlari[student.studentId].grupBilgileri[activityNode.id] = 'A';
            });
            
            console.log(`âœ… ${APP_STATE.studentData.length} Ã¶ÄŸrenci ${activityNode.id} etkinliÄŸi iÃ§in A grubuna atandÄ±`);
        }
        
        // UI gÃ¼ncellemeleri
        updateAssessmentView();
        updateAllInlineGroupInputs();
        
        const mappingCount = activityNode.children ? activityNode.children.length : 0;
        showModernToast(`${activityNode.name} iÃ§in A grubu oluÅŸturuldu (${mappingCount} soru atandÄ±)`, "success");
        
    } catch (error) {
        console.error("âŒ Yeni etkinlik iÃ§in grup atamasÄ± yapÄ±lÄ±rken hata:", error);
        showModernToast("Yeni etkinlik grup atamasÄ± baÅŸarÄ±sÄ±z!", "error");
    }
}

/**
 * Yeni eklenen alt bileÅŸen iÃ§in otomatik mapping atamasÄ±
 */
function assignDefaultMappingToNewComponent(parentId, newComponent) {
    try {
        if (!parentId || !newComponent || !newComponent.id) {
            console.log("âš ï¸ GeÃ§ersiz parametreler, mapping atamasÄ± yapÄ±lamÄ±yor");
            return;
        }
        
        console.log(`ğŸ¯ Yeni bileÅŸen iÃ§in mapping atamasÄ±: ${newComponent.id} â†’ ${parentId}`);
        
        // CourseData yapÄ±sÄ±nÄ± kontrol et
        if (!APP_STATE.courseData?.grupHaritalari?.[parentId]?.haritalar?.['A']) {
            console.log("âš ï¸ Parent etkinlik iÃ§in A grubu bulunamadÄ±, Ã¶nce grup oluÅŸturuluyor");
            
            // Parent iÃ§in grup sistemi oluÅŸtur
            if (!APP_STATE.courseData) APP_STATE.courseData = {};
            if (!APP_STATE.courseData.grupHaritalari) APP_STATE.courseData.grupHaritalari = {};
            if (!APP_STATE.courseData.grupHaritalari[parentId]) {
                APP_STATE.courseData.grupHaritalari[parentId] = {
                    gruplar: ['A'],
                    haritalar: { 'A': {} }
                };
            }
        }
        
        const groupMapping = APP_STATE.courseData.grupHaritalari[parentId].haritalar['A'];
        
        // Mevcut en yÃ¼ksek pozisyonu bul
        const existingPositions = Object.keys(groupMapping).map(pos => parseInt(pos)).filter(pos => !isNaN(pos));
        const nextPosition = existingPositions.length > 0 ? Math.max(...existingPositions) + 1 : 1;
        
        // Yeni bileÅŸeni sÄ±radaki pozisyona ata
        groupMapping[nextPosition.toString()] = newComponent.id;
        
        console.log(`âœ… ${newComponent.id} â†’ A:${nextPosition} atandÄ±`);
        
        // UI gÃ¼ncellemeleri
        updateAssessmentView();
        updateAllInlineGroupInputs();
        
        showModernToast(`${newComponent.name} A:${nextPosition} pozisyonuna atandÄ±`, "success");
        
    } catch (error) {
        console.error("âŒ Yeni bileÅŸen mapping atamasÄ± yapÄ±lÄ±rken hata:", error);
        showModernToast("Yeni bileÅŸen mapping atamasÄ± baÅŸarÄ±sÄ±z!", "error");
    }
}

// Global fonksiyonlar
window.createGroupMappingForActivity = createGroupMappingForActivity;
window.loadGroupMappingsFromAssessmentData = loadGroupMappingsFromAssessmentData;
window.loadStudentGradesNewFormat = loadStudentGradesNewFormat;
window.generateTamDosyaTermAssessmentWithParams = generateTamDosyaTermAssessmentWithParams;
window.generateTamDosyaFinalAssessmentWithParams = generateTamDosyaFinalAssessmentWithParams;
window.isTamDosyaFormat = isTamDosyaFormat;
window.createDefaultGroupSystemForTemelDosya = createDefaultGroupSystemForTemelDosya;
window.assignDefaultGroupsToNewActivity = assignDefaultGroupsToNewActivity;
window.assignDefaultMappingToNewComponent = assignDefaultMappingToNewComponent;

// =====================================================
// ETKÄ°NLÄ°K SEÃ‡ENEK MODAL EVENT LISTENERS
// =====================================================

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
    // Etkinlik seÃ§enek kartlarÄ±
    const activityModal = document.getElementById('activityOptionsModal');
    if (activityModal) {
        activityModal.addEventListener('click', function(e) {
            const card = e.target.closest('.activity-option-card');
            if (card) {
                selectActivityOption(card);
            }
            
            // Count butonlarÄ±
            if (e.target.classList.contains('count-btn')) {
                const target = e.target.dataset.target;
                const delta = e.target.classList.contains('plus') ? 1 : -1;
                updateCountValue(target, delta);
                
                // Puan alanÄ±nÄ± kontrol et
                updatePointsFieldVisibility();
            }
            
            // Modern close butonlarÄ±
            if (e.target.classList.contains('modern-close')) {
                closeActivityOptionsModal();
            }
        });
    }
    
    // Apply butonu
    const applyBtn = document.getElementById('applyActivityOptions');
    if (applyBtn) {
        applyBtn.addEventListener('click', applyActivityOptions);
    }
    
    // BoÅŸ bÄ±rak butonu
    const emptyBtn = document.getElementById('emptyActivityOption');
    if (emptyBtn) {
        emptyBtn.addEventListener('click', function() {
            applyEmptyOption();
            closeActivityOptionsModal();
        });
    }
    
    // Count input'larÄ± iÃ§in limit kontrolÃ¼ ve puan alanÄ± kontrolÃ¼
    ['questionCount', 'rubricCount'].forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('input', function() {
                const value = parseInt(this.value);
                if (value < 1) this.value = 1;
                if (value > 50) this.value = 50;
                
                // Puan alanÄ±nÄ± kontrol et
                updatePointsFieldVisibility();
            });
            
            // Sayfa yÃ¼klendiÄŸinde de kontrol et
            setTimeout(() => {
                updatePointsFieldVisibility();
            }, 100);
        }
    });
    
    // Puan input'larÄ± iÃ§in limit kontrolÃ¼
    ['questionDefaultPoints', 'rubricDefaultPoints'].forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('input', function() {
                const value = parseInt(this.value);
                if (value < 1) this.value = 1;
                if (value > 100) this.value = 100;
            });
        }
    });
    
    // Ã–Ã‡ seÃ§im event listener'larÄ±
    const outcomesSelect = document.getElementById('activityOutcomesSelect');
    if (outcomesSelect) {
        outcomesSelect.addEventListener('change', updateActivityOutcomesPreview);
    }
    
    // Ã–Ã‡ hÄ±zlÄ± aksiyon butonlarÄ±
    const selectAllBtn = document.getElementById('selectAllActivityOutcomes');
    if (selectAllBtn) {
        selectAllBtn.addEventListener('click', selectAllActivityOutcomes);
    }
    
    const randomSelectBtn = document.getElementById('randomSelectActivityOutcomes');
    if (randomSelectBtn) {
        randomSelectBtn.addEventListener('click', randomSelectActivityOutcomes);
    }
    
    const clearAllBtn = document.getElementById('clearAllActivityOutcomes');
    if (clearAllBtn) {
        clearAllBtn.addEventListener('click', clearAllActivityOutcomes);
    }
});

// =====================================================
// ETKÄ°NLÄ°K MODAL Ã–Ã‡ SEÃ‡Ä°M FONKSÄ°YONLARI
// =====================================================

/**
 * Etkinlik modal Ã–Ã‡ seÃ§im alanÄ±nÄ± doldur
 */
function populateActivityOutcomesSelect() {
    const select = document.getElementById('activityOutcomesSelect');
    if (!select) {
        console.warn('Ã–Ã‡ select elementi bulunamadÄ±');
        return;
    }
    
    // Debug: APP_STATE durumunu kontrol et
    console.log('APP_STATE.courseData:', APP_STATE.courseData);
    
    if (!APP_STATE.courseData) {
        console.warn('CourseData bulunamadÄ±');
        select.innerHTML = '<option disabled>Ã–nce ders JSON dosyasÄ± yÃ¼kleyin</option>';
        return;
    }
    
    // FarklÄ± Ã–Ã‡ alanlarÄ±nÄ± kontrol et
    let outcomes = null;
    if (APP_STATE.courseData.dersOgrenmeÃ‡iktilari) {
        outcomes = APP_STATE.courseData.dersOgrenmeÃ‡iktilari;
    } else if (APP_STATE.courseData.ogrenimCiktilari) {
        outcomes = APP_STATE.courseData.ogrenimCiktilari;
    } else if (APP_STATE.courseData.learningOutcomes) {
        outcomes = APP_STATE.courseData.learningOutcomes;
    } else if (APP_STATE.courseData.outcomes) {
        outcomes = APP_STATE.courseData.outcomes;
    }
    
    console.log('Bulunan Ã–Ã‡ler:', outcomes);
    
    // Mevcut seÃ§imleri temizle
    select.innerHTML = '';
    
    if (!outcomes || !Array.isArray(outcomes) || outcomes.length === 0) {
        select.innerHTML = '<option disabled>Ã–Ã‡ bulunamadÄ±</option>';
        console.warn('Ã–Ã‡ verisi bulunamadÄ± veya boÅŸ');
        return;
    }
    
    // Ã–Ã‡'leri ekle
    outcomes.forEach((outcome, index) => {
        const option = document.createElement('option');
        
        // FarklÄ± veri formatlarÄ±nÄ± destekle
        if (outcome.id && outcome.aciklama) {
            // JSON formatÄ±: {id: "Ã–Ã‡.1", aciklama: "..."}
            option.value = outcome.id;
            option.textContent = `${outcome.id} - ${outcome.aciklama}`;
        } else if (outcome.kod && outcome.baslik) {
            option.value = outcome.kod;
            option.textContent = `${outcome.kod} - ${outcome.baslik}`;
        } else if (outcome.code && outcome.title) {
            option.value = outcome.code;
            option.textContent = `${outcome.code} - ${outcome.title}`;
        } else if (outcome.id && outcome.name) {
            option.value = outcome.id;
            option.textContent = `${outcome.id} - ${outcome.name}`;
        } else if (typeof outcome === 'string') {
            option.value = outcome;
            option.textContent = outcome;
        } else {
            // Fallback
            option.value = `Ã–Ã‡.${index + 1}`;
            option.textContent = `Ã–Ã‡.${index + 1} - ${outcome.description || outcome.aciklama || outcome.baslik || outcome.title || 'Ogrenme Ciktisi'}`;
        }
        
        select.appendChild(option);
    });
    
    console.log(`âœ… ${outcomes.length} adet Ã–Ã‡ yÃ¼klendi`);
    
    // Ã–nizlemeyi gÃ¼ncelle
    updateActivityOutcomesPreview();
}

/**
 * Puan alanlarÄ±nÄ±n gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼nÃ¼ gÃ¼ncelle
 */
function updatePointsFieldVisibility() {
    // Soru puan alanÄ± kontrolÃ¼
    const questionCount = parseInt(document.getElementById('questionCount')?.value || 1);
    const questionPointsGroup = document.getElementById('questionPointsGroup');
    const questionPointsInput = document.getElementById('questionDefaultPoints');
    const questionPointsInfo = document.getElementById('questionPointsInfo');
    
    if (questionPointsGroup && questionPointsInput && questionPointsInfo) {
        if (questionCount > 1) {
            // Birden fazla soru - puan alanÄ±nÄ± devre dÄ±ÅŸÄ± bÄ±rak ve bilgi gÃ¶ster
            questionPointsInput.disabled = true;
            questionPointsGroup.classList.add('disabled');
            questionPointsInfo.style.display = 'block';
        } else {
            // Tek soru - puan alanÄ±nÄ± aktif et ve bilgiyi gizle
            questionPointsInput.disabled = false;
            questionPointsGroup.classList.remove('disabled');
            questionPointsInfo.style.display = 'none';
        }
    }
    
    // Rubrik puan alanÄ± kontrolÃ¼
    const rubricCount = parseInt(document.getElementById('rubricCount')?.value || 1);
    const rubricPointsGroup = document.getElementById('rubricPointsGroup');
    const rubricPointsInput = document.getElementById('rubricDefaultPoints');
    const rubricPointsInfo = document.getElementById('rubricPointsInfo');
    
    if (rubricPointsGroup && rubricPointsInput && rubricPointsInfo) {
        if (rubricCount > 1) {
            // Birden fazla rubrik - puan alanÄ±nÄ± devre dÄ±ÅŸÄ± bÄ±rak ve bilgi gÃ¶ster
            rubricPointsInput.disabled = true;
            rubricPointsGroup.classList.add('disabled');
            rubricPointsInfo.style.display = 'block';
        } else {
            // Tek rubrik - puan alanÄ±nÄ± aktif et ve bilgiyi gizle
            rubricPointsInput.disabled = false;
            rubricPointsGroup.classList.remove('disabled');
            rubricPointsInfo.style.display = 'none';
        }
    }
}

/**
 * SeÃ§ili Ã–Ã‡'lerin Ã¶nizlemesini gÃ¼ncelle
 */
function updateActivityOutcomesPreview() {
    const select = document.getElementById('activityOutcomesSelect');
    const previewContainer = document.getElementById('selectedOutcomesPreview');
    
    if (!select || !previewContainer) return;
    
    const selectedOptions = Array.from(select.selectedOptions);
    
    if (selectedOptions.length === 0) {
        previewContainer.innerHTML = '<span class="no-selection">HenÃ¼z seÃ§im yapÄ±lmadÄ±</span>';
        return;
    }
    
    // SeÃ§ili Ã–Ã‡'leri tag olarak gÃ¶ster
    previewContainer.innerHTML = selectedOptions
        .map(option => `<span class="outcome-preview-tag">${option.value}</span>`)
        .join('');
}

/**
 * TÃ¼m Ã–Ã‡'leri seÃ§
 */
function selectAllActivityOutcomes() {
    const select = document.getElementById('activityOutcomesSelect');
    if (!select) return;
    
    Array.from(select.options).forEach(option => {
        option.selected = true;
    });
    
    updateActivityOutcomesPreview();
    showModernToast("TÃ¼m Ã–Ã‡ler seÃ§ildi!", "success");
}

/**
 * Rastgele Ã–Ã‡ seÃ§ (1-3 adet)
 */
function randomSelectActivityOutcomes() {
    const select = document.getElementById('activityOutcomesSelect');
    if (!select || select.options.length === 0) return;
    
    // Ã–nce tÃ¼m seÃ§imleri temizle
    Array.from(select.options).forEach(option => {
        option.selected = false;
    });
    
    // Rastgele 1-3 adet seÃ§
    const optionsArray = Array.from(select.options);
    const randomCount = Math.floor(Math.random() * 3) + 1; // 1-3 arasÄ±
    const selectedCount = Math.min(randomCount, optionsArray.length);
    
    // Rastgele seÃ§im yap
    const shuffled = optionsArray.sort(() => 0.5 - Math.random());
    for (let i = 0; i < selectedCount; i++) {
        shuffled[i].selected = true;
    }
    
    updateActivityOutcomesPreview();
    showModernToast(`${selectedCount} adet Ã–Ã‡ rastgele seÃ§ildi!`, "success");
}

/**
 * TÃ¼m Ã–Ã‡ seÃ§imlerini temizle
 */
function clearAllActivityOutcomes() {
    const select = document.getElementById('activityOutcomesSelect');
    if (!select) return;
    
    Array.from(select.options).forEach(option => {
        option.selected = false;
    });
    
    updateActivityOutcomesPreview();
    showModernToast("Ã–Ã‡ seÃ§imleri temizlendi!", "info");
}

/**
 * SeÃ§ili Ã–Ã‡'leri al
 * @returns {Array} SeÃ§ili Ã–Ã‡ kodlarÄ±
 */
function getSelectedActivityOutcomes() {
    const select = document.getElementById('activityOutcomesSelect');
    if (!select) return [];
    
    return Array.from(select.selectedOptions).map(option => option.value);
}


/**
 * Rastgele aÄŸÄ±rlÄ±k daÄŸÄ±lÄ±mÄ± oluÅŸtur
 * @param {number} count - Ã–ÄŸe sayÄ±sÄ±
 * @returns {Array} - AÄŸÄ±rlÄ±k dizisi (toplamÄ± 100)
 */
function generateRandomWeights(count) {
    if (count === 1) return [100];
    
    // Rastgele sayÄ±lar Ã¼ret
    let weights = [];
    for (let i = 0; i < count - 1; i++) {
        weights.push(Math.random());
    }
    
    // SÄ±rala
    weights.sort((a, b) => a - b);
    
    // AralÄ±klara Ã§evir
    let intervals = [];
    intervals.push(weights[0]);
    for (let i = 1; i < weights.length; i++) {
        intervals.push(weights[i] - weights[i-1]);
    }
    intervals.push(1 - weights[weights.length - 1]);
    
    // 100'e Ã§evir ve yuvarla
    let result = intervals.map(w => Math.max(1, Math.round(w * 100)));
    
    // ToplamÄ± 100 yap
    let total = result.reduce((a, b) => a + b, 0);
    if (total !== 100) {
        let diff = 100 - total;
        // FarkÄ± en bÃ¼yÃ¼k deÄŸere ekle/Ã§Ä±kar
        let maxIndex = result.indexOf(Math.max(...result));
        result[maxIndex] += diff;
        result[maxIndex] = Math.max(1, result[maxIndex]);
    }
    
    return result;
}


// Puan input'larÄ± iÃ§in limit kontrolÃ¼
document.addEventListener('DOMContentLoaded', function() {
    ['questionDefaultPoints', 'rubricDefaultPoints'].forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('input', function() {
                const value = parseInt(this.value);
                if (value < 1) this.value = 1;
                if (value > 100) this.value = 100;
            });
        }
    });
    
    // Status badge'leri ilk yÃ¼klemede gÃ¼ncelle (slider formatÄ±nÄ± kullan)
    setTimeout(() => {
        updatePassFailCounts();
    }, 100);
});

// =====================================================
// ETKÄ°NLÄ°K TAÅIMA FONKSÄ°YONLARI
// =====================================================

/**
 * EtkinliÄŸi yukarÄ± taÅŸÄ±
 * @param {string} activityId - TaÅŸÄ±nacak etkinlik ID'si
 */
async function moveActivityUp(activityId) {
    try {
        const node = findNodeById(activityId);
        if (!node) {
            showModernToast("Etkinlik bulunamadÄ±!", "error");
            return;
        }
        
        // Ana aÄŸaÃ§ta mevcut sÄ±rasÄ±nÄ± bul
        const currentIndex = APP_STATE.assessmentTree.findIndex(n => n.id === activityId);
        
        if (currentIndex <= 0) {
            showModernToast("Bu etkinlik zaten en Ã¼stte!", "warning");
            return;
        }
        
        // AynÄ± kategorideki Ã¶nceki etkinliÄŸi bul
        const isTermActivity = activityId.startsWith('A');
        let previousIndex = -1;
        for (let i = currentIndex - 1; i >= 0; i--) {
            const nodeAtIndex = APP_STATE.assessmentTree[i];
            if ((isTermActivity && nodeAtIndex.id.startsWith('A')) || 
                (!isTermActivity && nodeAtIndex.id.startsWith('F'))) {
                previousIndex = i;
                break;
            }
        }
        
        if (previousIndex === -1) {
            showModernToast("Bu etkinlik kategorisinde zaten en Ã¼stte!", "warning");
            return;
        }
        
        // Onay al
        const confirmed = await showModernConfirm(
            'Etkinlik TaÅŸÄ±ma OnayÄ±',
            `${getComponentDisplayName(activityId)} etkinliÄŸini yukarÄ± taÅŸÄ±mak istediÄŸinizden emin misiniz?\\n\\nBu iÅŸlem etkinliÄŸin sÄ±rasÄ±nÄ± deÄŸiÅŸtirecek ve ID'lerini yeniden dÃ¼zenleyecektir.`,
            {
                confirmText: 'Evet, TaÅŸÄ±',
                cancelText: 'Ä°ptal',
                headerClass: 'info-action',
                iconClass: 'info'
            }
        );
        
        if (!confirmed) return;
        
        // Grup haritalamalarÄ±nÄ± kaydet
        const movedActivity = APP_STATE.assessmentTree[currentIndex];
        const savedMappings = {};
        saveNodeGroupMappings(movedActivity, savedMappings);
        
        // Ana aÄŸaÃ§ta sÄ±ralarÄ± deÄŸiÅŸtir
        APP_STATE.assessmentTree.splice(currentIndex, 1);
        APP_STATE.assessmentTree.splice(previousIndex, 0, movedActivity);
        
        // TÃ¼m sistemdeki ID'leri yeniden dÃ¼zenle
        const oldToNewIdMap = await reorganizeAllIds();
        
        // Grup haritalamalarÄ±nÄ± geri yÃ¼kle
        restoreGroupMappings(savedMappings, oldToNewIdMap);
        
        // AÄŸacÄ± yeniden render et
        renderTree();
        
        // DeÄŸerlendirme sekmesini gÃ¼ncelle - CRITICAL SYNC
        updateAssessmentView();
        
        showModernToast(`${getComponentDisplayName(activityId)} etkinliÄŸi yukarÄ± taÅŸÄ±ndÄ±!`, "success");
        
    } catch (error) {
        console.error("Etkinlik yukarÄ± taÅŸÄ±nÄ±rken hata:", error);
        showModernToast("Etkinlik taÅŸÄ±nÄ±rken hata oluÅŸtu!", "error");
    }
}

/**
 * EtkinliÄŸi aÅŸaÄŸÄ± taÅŸÄ±
 * @param {string} activityId - TaÅŸÄ±nacak etkinlik ID'si
 */
async function moveActivityDown(activityId) {
    try {
        const node = findNodeById(activityId);
        if (!node) {
            showModernToast("Etkinlik bulunamadÄ±!", "error");
            return;
        }
        
        // Ana aÄŸaÃ§ta mevcut sÄ±rasÄ±nÄ± bul
        const currentIndex = APP_STATE.assessmentTree.findIndex(n => n.id === activityId);
        
        if (currentIndex >= APP_STATE.assessmentTree.length - 1) {
            showModernToast("Bu etkinlik zaten en altta!", "warning");
            return;
        }
        
        // AynÄ± kategorideki sonraki etkinliÄŸi bul
        const isTermActivity = activityId.startsWith('A');
        let nextIndex = -1;
        for (let i = currentIndex + 1; i < APP_STATE.assessmentTree.length; i++) {
            const nodeAtIndex = APP_STATE.assessmentTree[i];
            if ((isTermActivity && nodeAtIndex.id.startsWith('A')) || 
                (!isTermActivity && nodeAtIndex.id.startsWith('F'))) {
                nextIndex = i;
                break;
            }
        }
        
        if (nextIndex === -1) {
            showModernToast("Bu etkinlik kategorisinde zaten en altta!", "warning");
            return;
        }
        
        // Onay al
        const confirmed = await showModernConfirm(
            'Etkinlik TaÅŸÄ±ma OnayÄ±',
            `${getComponentDisplayName(activityId)} etkinliÄŸini aÅŸaÄŸÄ± taÅŸÄ±mak istediÄŸinizden emin misiniz?\\n\\nBu iÅŸlem etkinliÄŸin sÄ±rasÄ±nÄ± deÄŸiÅŸtirecek ve ID'lerini yeniden dÃ¼zenleyecektir.`,
            {
                confirmText: 'Evet, TaÅŸÄ±',
                cancelText: 'Ä°ptal',
                headerClass: 'info-action',
                iconClass: 'info'
            }
        );
        
        if (!confirmed) return;
        
        // Grup haritalamalarÄ±nÄ± kaydet
        const movedActivity = APP_STATE.assessmentTree[currentIndex];
        const savedMappings = {};
        saveNodeGroupMappings(movedActivity, savedMappings);
        
        // Ana aÄŸaÃ§ta sÄ±ralarÄ± deÄŸiÅŸtir
        APP_STATE.assessmentTree.splice(currentIndex, 1);
        APP_STATE.assessmentTree.splice(nextIndex, 0, movedActivity);
        
        // TÃ¼m sistemdeki ID'leri yeniden dÃ¼zenle
        const oldToNewIdMap = await reorganizeAllIds();
        
        // Grup haritalamalarÄ±nÄ± geri yÃ¼kle
        restoreGroupMappings(savedMappings, oldToNewIdMap);
        
        // AÄŸacÄ± yeniden render et
        renderTree();
        
        // DeÄŸerlendirme sekmesini gÃ¼ncelle - CRITICAL SYNC
        updateAssessmentView();
        
        showModernToast(`${getComponentDisplayName(activityId)} etkinliÄŸi aÅŸaÄŸÄ± taÅŸÄ±ndÄ±!`, "success");
        
    } catch (error) {
        console.error("Etkinlik aÅŸaÄŸÄ± taÅŸÄ±nÄ±rken hata:", error);
        showModernToast("Etkinlik taÅŸÄ±nÄ±rken hata oluÅŸtu!", "error");
    }
}

/**
 * Etkinlik ID'lerini yeniden dÃ¼zenle
 * @param {Array} categoryNodes - Kategori dÃ¼ÄŸÃ¼mleri
 * @param {boolean} isTermActivity - YarÄ±yÄ±l iÃ§i etkinlik mi
 */
async function reassignActivityIds(categoryNodes, isTermActivity) {
    const prefix = isTermActivity ? 'A' : 'F';
    
    console.log(`ğŸ”„ ID yeniden dÃ¼zenleme baÅŸlÄ±yor: ${prefix} kategorisi, ${categoryNodes.length} etkinlik`);
    
    // Eski ID'leri ve grup haritalamalarÄ±nÄ± sakla
    const oldToNewIdMap = {};
    const savedGroupMappings = {};
    
    // Ã–nce tÃ¼m eski ID'leri ve grup haritalamalarÄ±nÄ± kaydet
    categoryNodes.forEach((node, index) => {
        const oldId = node.id;
        const newId = `${prefix}${index + 1}`;
        oldToNewIdMap[oldId] = newId;
        
        console.log(`ğŸ“ ID mapping: ${oldId} â†’ ${newId}`);
        
        // Bu dÃ¼ÄŸÃ¼m ve alt dÃ¼ÄŸÃ¼mlerinin grup haritalamalarÄ±nÄ± kaydet
        saveNodeGroupMappings(node, savedGroupMappings);
    });
    
    // ID'leri gÃ¼ncelle
    categoryNodes.forEach((node, index) => {
        const newId = `${prefix}${index + 1}`;
        updateNodeIdRecursive(node, newId);
    });
    
    // Grup haritalamalarÄ±nÄ± yeni ID'lerle geri yÃ¼kle
    restoreGroupMappings(savedGroupMappings, oldToNewIdMap);
    
    // Ana aÄŸacÄ± gÃ¼ncelle
    updateAssessmentTreeAfterReassign(categoryNodes, isTermActivity);
    
    console.log(`âœ… ID yeniden dÃ¼zenleme tamamlandÄ±: ${prefix} kategorisi`);
    
    // ID mapping'leri dÃ¶ndÃ¼r
    return oldToNewIdMap;
}

/**
 * DÃ¼ÄŸÃ¼m ve alt dÃ¼ÄŸÃ¼mlerinin grup haritalamalarÄ±nÄ± kaydet (YENÄ° FORMAT)
 */
function saveNodeGroupMappings(node, savedMappings) {
    if (!APP_STATE.courseData?.grupHaritalari) return;
    
    console.log(`ğŸ’¾ saveNodeGroupMappings Ã§aÄŸrÄ±ldÄ±: ${node.id}`);
    
    // Yeni format: grupHaritalari[activityId] = { gruplar: [], haritalar: {} }
    if (APP_STATE.courseData.grupHaritalari[node.id]) {
        savedMappings[node.id] = JSON.parse(JSON.stringify(APP_STATE.courseData.grupHaritalari[node.id]));
        console.log(`âœ… Grup haritalama kaydedildi: ${node.id}`, savedMappings[node.id]);
    }
    
    // Alt dÃ¼ÄŸÃ¼mler iÃ§in recursive kaydetme
    if (node.children && node.children.length > 0) {
        node.children.forEach(child => {
            saveNodeGroupMappings(child, savedMappings);
        });
    }
}

/**
 * Grup haritalamalarÄ±nÄ± yeni ID'lerle geri yÃ¼kle
 */
function restoreGroupMappings(savedMappings, oldToNewIdMap) {
    if (!APP_STATE.courseData?.grupHaritalari || !savedMappings || !oldToNewIdMap) return;
    
    console.log(`ğŸ”„ restoreGroupMappings baÅŸlÄ±yor...`);
    console.log(`ğŸ“Š KayÄ±tlÄ± haritalamalar:`, Object.keys(savedMappings));
    console.log(`ğŸ“Š ID Mapping:`, oldToNewIdMap);
    
    // Ã–nce eski ID'lere ait tÃ¼m haritalamlarÄ± temizle
    Object.keys(oldToNewIdMap).forEach(oldId => {
        if (APP_STATE.courseData.grupHaritalari[oldId]) {
            delete APP_STATE.courseData.grupHaritalari[oldId];
            console.log(`ğŸ—‘ï¸ Eski haritalama silindi: ${oldId}`);
        }
    });
    
    // Yeni ID'lerle haritalamlarÄ± geri yÃ¼kle
    Object.keys(savedMappings).forEach(oldId => {
        const newId = oldToNewIdMap[oldId];
        if (newId && savedMappings[oldId]) {
            // Yeni ID iÃ§in haritalamayÄ± kopyala
            APP_STATE.courseData.grupHaritalari[newId] = JSON.parse(JSON.stringify(savedMappings[oldId]));
            
            // CRITICAL: Alt soru ID'lerini de gÃ¼ncelle
            if (savedMappings[oldId].haritalar) {
                Object.keys(savedMappings[oldId].haritalar).forEach(groupName => {
                    const groupMapping = savedMappings[oldId].haritalar[groupName];
                    const updatedGroupMapping = {};
                    
                    // Her sÄ±ra numarasÄ± iÃ§in yeni soru ID'sini hesapla
                    Object.keys(groupMapping).forEach(position => {
                        const oldQuestionId = groupMapping[position];
                        
                        // Eski soru ID'sinden yeni soru ID'sine Ã§evir
                        if (oldQuestionId.startsWith(oldId + '.')) {
                            const questionNumber = oldQuestionId.split('.').pop();
                            const newQuestionId = `${newId}.${questionNumber}`;
                            updatedGroupMapping[position] = newQuestionId;
                            console.log(`ğŸ“ Soru ID gÃ¼ncellendi: ${oldQuestionId} â†’ ${newQuestionId}`);
                        } else {
                            updatedGroupMapping[position] = oldQuestionId;
                        }
                    });
                    
                    APP_STATE.courseData.grupHaritalari[newId].haritalar[groupName] = updatedGroupMapping;
                });
            }
            
            console.log(`âœ… Grup haritalama geri yÃ¼klendi: ${oldId} â†’ ${newId}`, APP_STATE.courseData.grupHaritalari[newId]);
        }
    });
}

/**
 * ID yeniden dÃ¼zenlemeden sonra ana aÄŸacÄ± gÃ¼ncelle
 */
function updateAssessmentTreeAfterReassign(updatedCategoryNodes, isTermActivity) {
    // DiÄŸer kategorinin dÃ¼ÄŸÃ¼mlerini al
    const otherCategoryNodes = APP_STATE.assessmentTree.filter(node => 
        isTermActivity ? node.id.startsWith('F') : node.id.startsWith('A')
    );
    
    // Ana aÄŸacÄ± yeniden oluÅŸtur
    APP_STATE.assessmentTree = [
        ...(isTermActivity ? updatedCategoryNodes : otherCategoryNodes),
        ...(isTermActivity ? otherCategoryNodes : updatedCategoryNodes)
    ];
    
    console.log(`ğŸ”„ Ana aÄŸaÃ§ gÃ¼ncellendi. Toplam etkinlik: ${APP_STATE.assessmentTree.length}`);
}

/**
 * TÃ¼m etkinlik ve alt bileÅŸen ID'lerini yeniden dÃ¼zenle
 * Bu fonksiyon taÅŸÄ±ma iÅŸlemlerinden sonra Ã§aÄŸrÄ±lÄ±r
 */
async function reorganizeAllIds() {
    console.log('ğŸ¯ KapsamlÄ± ID yeniden dÃ¼zenleme baÅŸlÄ±yor...');
    
    try {
        // TÃ¼m grup haritalamalarÄ±nÄ± kaydet
        const savedMappings = {};
        APP_STATE.assessmentTree.forEach(node => {
            saveNodeGroupMappings(node, savedMappings);
        });
        
        // ID mapping'lerini topla
        const oldToNewIdMap = {};
        
        // YarÄ±yÄ±l iÃ§i etkinlikleri yeniden dÃ¼zenle (A1, A2, A3...)
        const termActivities = APP_STATE.assessmentTree.filter(node => 
            node.id.startsWith('A') || node.id.startsWith('A_TEMP_')
        );
        termActivities.forEach((node, index) => {
            const oldId = node.id;
            const newId = `A${index + 1}`;
            oldToNewIdMap[oldId] = newId;
            
            // Ana etkinlik ID'sini gÃ¼ncelle
            updateNodeIdRecursive(node, newId);
            
            console.log(`ğŸ“ YarÄ±yÄ±l Ä°Ã§i: ${oldId} â†’ ${newId}`);
        });
        
        // YarÄ±yÄ±l sonu etkinlikleri yeniden dÃ¼zenle (F1, F2, F3...)
        const finalActivities = APP_STATE.assessmentTree.filter(node => 
            node.id.startsWith('F') || node.id.startsWith('F_TEMP_')
        );
        finalActivities.forEach((node, index) => {
            const oldId = node.id;
            const newId = `F${index + 1}`;
            oldToNewIdMap[oldId] = newId;
            
            // Ana etkinlik ID'sini gÃ¼ncelle
            updateNodeIdRecursive(node, newId);
            
            console.log(`ğŸ“ YarÄ±yÄ±l Sonu: ${oldId} â†’ ${newId}`);
        });
        
        // Ana aÄŸacÄ± yeniden sÄ±rala (A etkinlikleri Ã¶nce, F etkinlikleri sonra)
        APP_STATE.assessmentTree = [
            ...termActivities,
            ...finalActivities
        ];
        
        // Grup haritalamalarÄ±nÄ± geri yÃ¼kle
        restoreGroupMappings(savedMappings, oldToNewIdMap);
        
        // DeÄŸerlendirme sekmesini gÃ¼ncelle - CRITICAL SYNC
        updateAssessmentView();
        
        console.log('âœ… KapsamlÄ± ID yeniden dÃ¼zenleme tamamlandÄ±');
        console.log('ğŸ“Š ID Mapping:', oldToNewIdMap);
        
        return oldToNewIdMap;
        
    } catch (error) {
        console.error('âŒ ID yeniden dÃ¼zenleme hatasÄ±:', error);
        throw error;
    }
}

/**
 * DÃ¼ÄŸÃ¼m ID'sini recursively gÃ¼ncelle
 * @param {Object} node - DÃ¼ÄŸÃ¼m
 * @param {string} newId - Yeni ID
 */
function updateNodeIdRecursive(node, newId) {
    // Ana dÃ¼ÄŸÃ¼mÃ¼n ID'sini gÃ¼ncelle
    node.id = newId;
    
    // Alt dÃ¼ÄŸÃ¼mlerin ID'lerini gÃ¼ncelle
    if (node.children && node.children.length > 0) {
        node.children.forEach((child, index) => {
            const newChildId = `${newId}.${index + 1}`;
            updateNodeIdRecursive(child, newChildId);
        });
    }
}

// =====================================================
// SÃœRÃœKLE-BIRAK FONKSÄ°YONLARI
// =====================================================

/**
 * Ana etkinlikler ve alt bileÅŸenler iÃ§in sÃ¼rÃ¼kle-bÄ±rak Ã¶zelliÄŸi ekle
 */
function enableDragAndDrop() {
    // Ã–nceki event listener'larÄ± temizle
    document.querySelectorAll('.tree-node').forEach(nodeElement => {
        nodeElement.removeEventListener('dragstart', handleDragStart);
        nodeElement.removeEventListener('dragover', handleDragOver);
        nodeElement.removeEventListener('drop', handleDrop);
        nodeElement.removeEventListener('dragend', handleDragEnd);
        nodeElement.removeEventListener('dragenter', handleDragEnter);
        nodeElement.removeEventListener('dragleave', handleDragLeave);
        nodeElement.removeEventListener('dragstart', handleComponentDragStart);
        nodeElement.removeEventListener('dragend', handleComponentDragEnd);
    });
    
    // TÃ¼m dÃ¼ÄŸÃ¼mleri kontrol et
    document.querySelectorAll('.tree-node').forEach(nodeElement => {
        const nodeId = nodeElement.dataset.id;
        if (!nodeId) return;
        
        const isMainActivity = (nodeId.startsWith('A') || nodeId.startsWith('F')) && !nodeId.includes('.');
        const isSubComponent = nodeId.includes('.'); // Alt bileÅŸen (A1.1, F1.2 gibi)
        
        // Ana etkinlikler iÃ§in sÃ¼rÃ¼kle-bÄ±rak
        if (isMainActivity) {
            nodeElement.draggable = true;
            nodeElement.classList.add('draggable-activity');
            
            // Ana etkinlik drag event listeners
            nodeElement.addEventListener('dragstart', handleDragStart);
            nodeElement.addEventListener('dragend', handleDragEnd);
            
            // Ana etkinlikler drop hedefi olabilir
            nodeElement.addEventListener('dragover', handleDragOver);
            nodeElement.addEventListener('drop', handleDrop);
            nodeElement.addEventListener('dragenter', handleDragEnter);
            nodeElement.addEventListener('dragleave', handleDragLeave);
        }
        
        // Alt bileÅŸenler iÃ§in sÃ¼rÃ¼kle-bÄ±rak
        if (isSubComponent) {
            nodeElement.draggable = true;
            nodeElement.classList.add('draggable-component');
            
            // Alt bileÅŸen drag event listeners
            nodeElement.addEventListener('dragstart', handleComponentDragStart);
            nodeElement.addEventListener('dragend', handleComponentDragEnd);
            
            // Alt bileÅŸenler de drop hedefi olabilir (aynÄ± parent altÄ±nda)
            nodeElement.addEventListener('dragover', handleDragOver);
            nodeElement.addEventListener('drop', handleComponentDrop);
            nodeElement.addEventListener('dragenter', handleComponentDragEnter);
            nodeElement.addEventListener('dragleave', handleDragLeave);
        }
    });
}

/**
 * Drag start event handler
 */
function handleDragStart(e) {
    const nodeElement = e.currentTarget;
    const nodeId = nodeElement.dataset.id;
    
    currentDraggedId = nodeId;
    e.dataTransfer.setData('text/plain', nodeId);
    e.dataTransfer.effectAllowed = 'move';
    
    nodeElement.classList.add('dragging');
    
    console.log(`ğŸ¯ SÃ¼rÃ¼kleme baÅŸladÄ±: ${nodeId}`);
}

// Global deÄŸiÅŸkenler - sÃ¼rÃ¼klenen element ID'leri
let currentDraggedId = null;
let currentDraggedComponentId = null;

/**
 * Drag enter event handler
 */
function handleDragEnter(e) {
    e.preventDefault();
    const nodeElement = e.currentTarget;
    const targetId = nodeElement.dataset.id;
    
    if (canDropOn(currentDraggedId, targetId)) {
        nodeElement.classList.add('drag-over-valid');
        nodeElement.classList.remove('drag-over-invalid');
    } else {
        nodeElement.classList.add('drag-over-invalid');
        nodeElement.classList.remove('drag-over-valid');
    }
}

/**
 * Drag over event handler
 */
function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
}

/**
 * Drag leave event handler
 */
function handleDragLeave(e) {
    const nodeElement = e.currentTarget;
    // Sadece element'ten tamamen Ã§Ä±kÄ±ldÄ±ÄŸÄ±nda temizle
    if (!nodeElement.contains(e.relatedTarget)) {
        nodeElement.classList.remove('drag-over-valid', 'drag-over-invalid');
    }
}

/**
 * Drop event handler
 */
async function handleDrop(e) {
    e.preventDefault();
    
    const draggedId = e.dataTransfer.getData('text/plain');
    const targetElement = e.currentTarget;
    const targetId = targetElement.dataset.id;
    
    // Cleanup tÃ¼m drag sÄ±nÄ±flarÄ±
    document.querySelectorAll('.drag-over-valid, .drag-over-invalid, .dragging').forEach(el => {
        el.classList.remove('drag-over-valid', 'drag-over-invalid', 'dragging');
    });
    
    console.log(`ğŸ¯ Drop iÅŸlemi: ${draggedId} â†’ ${targetId}`);
    
    if (!draggedId || !targetId || draggedId === targetId) {
        console.log('âŒ GeÃ§ersiz drop iÅŸlemi');
        return;
    }
    
    if (!canDropOn(draggedId, targetId)) {
        showModernToast("Bu etkinlik burada taÅŸÄ±namaz!", "warning");
        return;
    }
    
    // FarklÄ± kategoriler arasÄ±nda taÅŸÄ±ma kontrolÃ¼
    const draggedIsTermActivity = draggedId.startsWith('A');
    const targetIsTermActivity = targetId.startsWith('A');
    
    if (draggedIsTermActivity !== targetIsTermActivity) {
        // Kategoriler arasÄ± taÅŸÄ±ma
        await moveActivityBetweenCategories(draggedId, targetId);
    } else {
        // AynÄ± kategori iÃ§inde taÅŸÄ±ma
        await moveActivityWithinCategory(draggedId, targetId);
    }
}

/**
 * Drag end event handler
 */
function handleDragEnd(e) {
    const nodeElement = e.currentTarget;
    nodeElement.classList.remove('dragging');
    
    // TÃ¼m drag sÄ±nÄ±flarÄ±nÄ± temizle
    document.querySelectorAll('.drag-over-valid, .drag-over-invalid').forEach(el => {
        el.classList.remove('drag-over-valid', 'drag-over-invalid');
    });
    
    // Global deÄŸiÅŸkeni temizle
    currentDraggedId = null;
    
    console.log('ğŸ¯ SÃ¼rÃ¼kleme sona erdi');
}

// =====================================================
// ALT BÄ°LEÅEN SÃœRÃœKLE-BIRAK FONKSÄ°YONLARI
// =====================================================

/**
 * Alt bileÅŸen drag start event handler
 */
function handleComponentDragStart(e) {
    const nodeElement = e.currentTarget;
    const nodeId = nodeElement.dataset.id;
    
    currentDraggedComponentId = nodeId;
    e.dataTransfer.setData('text/plain', nodeId);
    e.dataTransfer.effectAllowed = 'move';
    
    nodeElement.classList.add('dragging');
    
    console.log(`ğŸ¯ Alt bileÅŸen sÃ¼rÃ¼kleme baÅŸladÄ±: ${nodeId}`);
}

/**
 * Alt bileÅŸen drag end event handler
 */
function handleComponentDragEnd(e) {
    const nodeElement = e.currentTarget;
    nodeElement.classList.remove('dragging');
    currentDraggedComponentId = null;
    
    // TÃ¼m drag-over sÄ±nÄ±flarÄ±nÄ± temizle
    document.querySelectorAll('.drag-over-valid, .drag-over-invalid').forEach(el => {
        el.classList.remove('drag-over-valid', 'drag-over-invalid');
    });
    
    console.log('ğŸ¯ Alt bileÅŸen sÃ¼rÃ¼kleme tamamlandÄ±');
}

/**
 * Alt bileÅŸen drag enter event handler
 */
function handleComponentDragEnter(e) {
    e.preventDefault();
    const nodeElement = e.currentTarget;
    const targetId = nodeElement.dataset.id;
    
    if (canDropComponentOn(currentDraggedComponentId, targetId)) {
        nodeElement.classList.add('drag-over-valid');
        nodeElement.classList.remove('drag-over-invalid');
    } else {
        nodeElement.classList.add('drag-over-invalid');
        nodeElement.classList.remove('drag-over-valid');
    }
}

/**
 * Alt bileÅŸen drop event handler
 */
async function handleComponentDrop(e) {
    e.preventDefault();
    
    const draggedId = e.dataTransfer.getData('text/plain');
    const targetElement = e.currentTarget;
    const targetId = targetElement.dataset.id;
    
    // Cleanup tÃ¼m drag sÄ±nÄ±flarÄ±
    document.querySelectorAll('.drag-over-valid, .drag-over-invalid, .dragging').forEach(el => {
        el.classList.remove('drag-over-valid', 'drag-over-invalid', 'dragging');
    });
    
    console.log(`ğŸ¯ Alt bileÅŸen drop iÅŸlemi: ${draggedId} â†’ ${targetId}`);
    
    if (!draggedId || !targetId || draggedId === targetId) {
        console.log('âŒ GeÃ§ersiz alt bileÅŸen drop iÅŸlemi');
        return;
    }
    
    if (!canDropComponentOn(draggedId, targetId)) {
        showModernToast("Bu bileÅŸen burada taÅŸÄ±namaz!", "warning");
        return;
    }
    
    // Parent ID'lerini kontrol et
    const draggedParent = draggedId.substring(0, draggedId.lastIndexOf('.'));
    const targetParent = targetId.substring(0, targetId.lastIndexOf('.'));
    
    try {
        if (draggedParent === targetParent) {
            // AynÄ± parent altÄ±nda taÅŸÄ±ma
            await moveComponentWithinParent(draggedId, targetId);
        } else {
            // FarklÄ± etkinlikler arasÄ±nda taÅŸÄ±ma
            await moveComponentBetweenActivities(draggedId, targetId);
        }
    } catch (error) {
        console.error('âŒ Alt bileÅŸen taÅŸÄ±ma hatasÄ±:', error);
        showModernToast("Alt bileÅŸen taÅŸÄ±nÄ±rken hata oluÅŸtu!", "error");
    }
}

/**
 * Belirli bir etkinliÄŸin baÅŸka bir etkinlik Ã¼zerine bÄ±rakÄ±lÄ±p bÄ±rakÄ±lamayacaÄŸÄ±nÄ± kontrol et
 */
function canDropOn(draggedId, targetId) {
    if (!draggedId || !targetId || draggedId === targetId) {
        return false;
    }
    
    const draggedIsMainActivity = !draggedId.includes('.');
    const targetIsMainActivity = !targetId.includes('.');
    
    // Ana etkinlikler sadece ana etkinlikler Ã¼zerine taÅŸÄ±nabilir
    if (draggedIsMainActivity && targetIsMainActivity) {
        const draggedIsValid = draggedId.startsWith('A') || draggedId.startsWith('F');
        const targetIsValid = targetId.startsWith('A') || targetId.startsWith('F');
        return draggedIsValid && targetIsValid;
    }
    
    return false; // Ana etkinlikler iÃ§in diÄŸer durumlar geÃ§ersiz
}

/**
 * Alt bileÅŸenlerin taÅŸÄ±nÄ±p taÅŸÄ±namayacaÄŸÄ±nÄ± kontrol et
 */
function canDropComponentOn(draggedId, targetId) {
    if (!draggedId || !targetId || draggedId === targetId) {
        return false;
    }
    
    // SÃ¼rÃ¼klenen alt bileÅŸen, hedef alt bileÅŸen olmalÄ±
    if (!draggedId.includes('.') || !targetId.includes('.')) {
        return false;
    }
    
    // Her iki bileÅŸen de geÃ§erli ID formatÄ±nda olmalÄ± (A1.1, F2.3 gibi)
    const draggedIsValid = (draggedId.startsWith('A') || draggedId.startsWith('F'));
    const targetIsValid = (targetId.startsWith('A') || targetId.startsWith('F'));
    
    return draggedIsValid && targetIsValid;
}

/**
 * EtkinliÄŸi kategoriler arasÄ±nda taÅŸÄ±
 */
async function moveActivityBetweenCategories(draggedId, targetId) {
    const confirmed = await showModernConfirm(
        'Kategori DeÄŸiÅŸtirme OnayÄ±',
        `${getComponentDisplayName(draggedId)} etkinliÄŸini ${draggedId.startsWith('A') ? 'YarÄ±yÄ±l Sonu' : 'YarÄ±yÄ±l Ä°Ã§i'} kategorisine taÅŸÄ±mak istediÄŸinizden emin misiniz?\\n\\nBu iÅŸlem etkinliÄŸin kategorisini deÄŸiÅŸtirecek ve ID'sini yeniden dÃ¼zenleyecektir.`,
        {
            confirmText: 'Evet, TaÅŸÄ±',
            cancelText: 'Ä°ptal',
            headerClass: 'warning-action',
            iconClass: 'warning'
        }
    );
    
    if (!confirmed) return;
    
    console.log(`ğŸ”„ Kategori deÄŸiÅŸtirme: ${draggedId} â†’ ${targetId} kategorisi`);
    
    try {
        const draggedNode = findNodeById(draggedId);
        if (!draggedNode) {
            showModernToast("TaÅŸÄ±nacak etkinlik bulunamadÄ±!", "error");
            return;
        }
        
        // Grup haritalamalarÄ±nÄ± kaydet
        const savedMappings = {};
        saveNodeGroupMappings(draggedNode, savedMappings);
        
        // Ana aÄŸaÃ§tan dÃ¼ÄŸÃ¼mÃ¼ Ã§Ä±kar
        const draggedIndex = APP_STATE.assessmentTree.findIndex(n => n.id === draggedId);
        if (draggedIndex === -1) {
            showModernToast("Etkinlik ana aÄŸaÃ§ta bulunamadÄ±!", "error");
            return;
        }
        
        APP_STATE.assessmentTree.splice(draggedIndex, 1);
        
        // EtkinliÄŸin hedef kategorisini belirle ve geÃ§ici ID ata
        const draggedIsTermActivity = draggedId.startsWith('A');
        const targetIsTermActivity = targetId.startsWith('A');
        
        // EÄŸer kategori deÄŸiÅŸiyorsa, etkinliÄŸin prefix'ini deÄŸiÅŸtir
        if (draggedIsTermActivity !== targetIsTermActivity) {
            const newPrefix = targetIsTermActivity ? 'A' : 'F';
            const tempId = `${newPrefix}_TEMP_${Date.now()}`;
            draggedNode.id = tempId;
            
            // Alt bileÅŸenlerin ID'lerini de geÃ§ici olarak deÄŸiÅŸtir
            if (draggedNode.children && draggedNode.children.length > 0) {
                draggedNode.children.forEach((child, index) => {
                    child.id = `${tempId}.${index + 1}`;
                });
            }
        }
        
        // Hedef kategoriye doÄŸru pozisyonda ekle
        const targetIndex = APP_STATE.assessmentTree.findIndex(n => n.id === targetId);
        if (targetIndex !== -1) {
            // Hedef etkinliÄŸin yerine ekle
            APP_STATE.assessmentTree.splice(targetIndex, 0, draggedNode);
        } else {
            // Hedef bulunamadÄ±ysa hedef kategorinin sonuna ekle
            const targetCategoryNodes = APP_STATE.assessmentTree.filter(n => 
                targetIsTermActivity ? n.id.startsWith('A') : n.id.startsWith('F')
            );
            
            if (targetCategoryNodes.length > 0) {
                // Son etkinliÄŸin arkasÄ±na ekle
                const lastNodeIndex = APP_STATE.assessmentTree.findIndex(n => n.id === targetCategoryNodes[targetCategoryNodes.length - 1].id);
                APP_STATE.assessmentTree.splice(lastNodeIndex + 1, 0, draggedNode);
            } else {
                // Kategori boÅŸsa sona ekle
                APP_STATE.assessmentTree.push(draggedNode);
            }
        }
        
        // TÃ¼m sistemdeki ID'leri yeniden dÃ¼zenle
        const oldToNewIdMap = await reorganizeAllIds();
        
        // Grup haritalamalarÄ±nÄ± geri yÃ¼kle
        restoreGroupMappings(savedMappings, oldToNewIdMap);
        
        renderTree();
        
        // DeÄŸerlendirme sekmesini gÃ¼ncelle - CRITICAL SYNC
        updateAssessmentView();
        
        showModernToast(`${getComponentDisplayName(draggedId)} etkinliÄŸi kategori deÄŸiÅŸtirdi!`, "success");
        
    } catch (error) {
        console.error('âŒ Kategori deÄŸiÅŸtirme hatasÄ±:', error);
        showModernToast("Etkinlik taÅŸÄ±nÄ±rken hata oluÅŸtu!", "error");
    }
}

/**
 * EtkinliÄŸi aynÄ± kategori iÃ§inde taÅŸÄ±
 */
async function moveActivityWithinCategory(draggedId, targetId) {
    console.log(`ğŸ”„ AynÄ± kategori iÃ§inde taÅŸÄ±ma: ${draggedId} â†’ ${targetId}`);
    
    // Onay al
    const confirmed = await showModernConfirm(
        'Etkinlik TaÅŸÄ±ma OnayÄ±',
        `${getComponentDisplayName(draggedId)} etkinliÄŸini ${getComponentDisplayName(targetId)} etkinliÄŸinin yerine taÅŸÄ±mak istediÄŸinizden emin misiniz?\\n\\nBu iÅŸlem etkinliklerin sÄ±rasÄ±nÄ± deÄŸiÅŸtirecek ve ID'lerini yeniden dÃ¼zenleyecektir.`,
        {
            confirmText: 'Evet, TaÅŸÄ±',
            cancelText: 'Ä°ptal',
            headerClass: 'info-action',
            iconClass: 'info'
        }
    );
    
    if (!confirmed) return;
    
    try {
        const draggedIndex = APP_STATE.assessmentTree.findIndex(n => n.id === draggedId);
        const targetIndex = APP_STATE.assessmentTree.findIndex(n => n.id === targetId);
        
        if (draggedIndex === -1 || targetIndex === -1) {
            showModernToast("TaÅŸÄ±ma iÅŸlemi iÃ§in gerekli etkinlikler bulunamadÄ±!", "error");
            return;
        }
        
        // Grup haritalamalarÄ±nÄ± kaydet
        const draggedNode = APP_STATE.assessmentTree[draggedIndex];
        const savedMappings = {};
        saveNodeGroupMappings(draggedNode, savedMappings);
        
        // Ana aÄŸaÃ§ta sÄ±ralarÄ± deÄŸiÅŸtir
        APP_STATE.assessmentTree.splice(draggedIndex, 1);
        APP_STATE.assessmentTree.splice(targetIndex, 0, draggedNode);
        
        // TÃ¼m sistemdeki ID'leri yeniden dÃ¼zenle
        const oldToNewIdMap = await reorganizeAllIds();
        
        // Grup haritalamalarÄ±nÄ± geri yÃ¼kle
        restoreGroupMappings(savedMappings, oldToNewIdMap);
        
        renderTree();
        
        // DeÄŸerlendirme sekmesini gÃ¼ncelle - CRITICAL SYNC
        updateAssessmentView();
        
        showModernToast(`${getComponentDisplayName(draggedId)} etkinliÄŸi taÅŸÄ±ndÄ±!`, "success");
        
    } catch (error) {
        console.error('âŒ AynÄ± kategori taÅŸÄ±ma hatasÄ±:', error);
        showModernToast("Etkinlik taÅŸÄ±nÄ±rken hata oluÅŸtu!", "error");
    }
}

/**
 * Alt bileÅŸeni farklÄ± etkinlikler arasÄ±nda taÅŸÄ±
 */
async function moveComponentBetweenActivities(draggedId, targetId) {
    console.log(`ğŸ”„ Alt bileÅŸen farklÄ± etkinlikler arasÄ± taÅŸÄ±ma: ${draggedId} â†’ ${targetId}`);
    
    // Parent ID'lerini al
    const draggedParent = draggedId.substring(0, draggedId.lastIndexOf('.'));
    const targetParent = targetId.substring(0, targetId.lastIndexOf('.'));
    
    // Onay al
    const confirmed = await showModernConfirm(
        'Alt BileÅŸen TaÅŸÄ±ma OnayÄ±',
        `${getComponentDisplayName(draggedId)} alt bileÅŸenini ${getComponentDisplayName(targetParent)} etkinliÄŸine taÅŸÄ±mak istediÄŸinizden emin misiniz?\\n\\nBu iÅŸlem alt bileÅŸeni farklÄ± bir etkinliÄŸe taÅŸÄ±yacak ve ID'sini yeniden dÃ¼zenleyecektir.`,
        {
            confirmText: 'Evet, TaÅŸÄ±',
            cancelText: 'Ä°ptal',
            headerClass: 'info-action',
            iconClass: 'info'
        }
    );
    
    if (!confirmed) return;
    
    try {
        // Kaynak parent node'u bul
        const sourceParentNode = findNodeById(draggedParent);
        if (!sourceParentNode || !sourceParentNode.children) {
            showModernToast("Kaynak etkinlik bulunamadÄ±!", "error");
            return;
        }
        
        // Hedef parent node'u bul
        const targetParentNode = findNodeById(targetParent);
        if (!targetParentNode) {
            showModernToast("Hedef etkinlik bulunamadÄ±!", "error");
            return;
        }
        
        // TaÅŸÄ±nacak bileÅŸeni bul
        const draggedIndex = sourceParentNode.children.findIndex(child => child.id === draggedId);
        if (draggedIndex === -1) {
            showModernToast("TaÅŸÄ±nacak alt bileÅŸen bulunamadÄ±!", "error");
            return;
        }
        
        const draggedComponent = sourceParentNode.children[draggedIndex];
        
        // Grup haritalamalarÄ±nÄ± kaydet
        const savedMappings = {};
        saveNodeGroupMappings(draggedComponent, savedMappings);
        
        // BileÅŸeni kaynak parent'tan Ã§Ä±kar
        sourceParentNode.children.splice(draggedIndex, 1);
        
        // Hedef parent'ta children array'i yoksa oluÅŸtur
        if (!targetParentNode.children) {
            targetParentNode.children = [];
        }
        
        // Hedef pozisyonu belirle
        const targetIndex = targetParentNode.children.findIndex(child => child.id === targetId);
        if (targetIndex !== -1) {
            // Hedef bileÅŸenin yerine ekle
            targetParentNode.children.splice(targetIndex, 0, draggedComponent);
        } else {
            // Hedef bileÅŸen bulunamadÄ±ysa sona ekle
            targetParentNode.children.push(draggedComponent);
        }
        
        // TÃ¼m sistemdeki ID'leri yeniden dÃ¼zenle
        const oldToNewIdMap = await reorganizeAllIds();
        
        // Grup haritalamalarÄ±nÄ± geri yÃ¼kle
        restoreGroupMappings(savedMappings, oldToNewIdMap);
        
        renderTree();
        
        // DeÄŸerlendirme sekmesini gÃ¼ncelle - CRITICAL SYNC
        updateAssessmentView();
        
        showModernToast(`${getComponentDisplayName(draggedId)} alt bileÅŸeni ${getComponentDisplayName(targetParent)} etkinliÄŸine taÅŸÄ±ndÄ±!`, "success");
        
    } catch (error) {
        console.error('âŒ Alt bileÅŸen taÅŸÄ±ma hatasÄ±:', error);
        showModernToast("Alt bileÅŸen taÅŸÄ±nÄ±rken hata oluÅŸtu!", "error");
    }
}

/**
 * Alt bileÅŸeni aynÄ± parent iÃ§inde taÅŸÄ±
 */
async function moveComponentWithinParent(draggedId, targetId) {
    console.log(`ğŸ”„ Alt bileÅŸen aynÄ± parent iÃ§inde taÅŸÄ±ma: ${draggedId} â†’ ${targetId}`);
    
    // Parent ID'lerini al
    const draggedParent = draggedId.substring(0, draggedId.lastIndexOf('.'));
    const targetParent = targetId.substring(0, targetId.lastIndexOf('.'));
    
    // Onay al
    const confirmed = await showModernConfirm(
        'Alt BileÅŸen SÄ±ralama OnayÄ±',
        `${getComponentDisplayName(draggedId)} alt bileÅŸenini ${getComponentDisplayName(targetId)} alt bileÅŸeninin yerine taÅŸÄ±mak istediÄŸinizden emin misiniz?\\n\\nBu iÅŸlem alt bileÅŸenlerin sÄ±rasÄ±nÄ± deÄŸiÅŸtirecek ve ID'lerini yeniden dÃ¼zenleyecektir.`,
        {
            confirmText: 'Evet, TaÅŸÄ±',
            cancelText: 'Ä°ptal',
            headerClass: 'info-action',
            iconClass: 'info'
        }
    );
    
    if (!confirmed) return;
    
    try {
        // Parent node'u bul
        const parentNode = findNodeById(draggedParent);
        if (!parentNode || !parentNode.children) {
            showModernToast("Parent etkinlik bulunamadÄ±!", "error");
            return;
        }
        
        // TaÅŸÄ±nacak ve hedef bileÅŸenleri bul
        const draggedIndex = parentNode.children.findIndex(child => child.id === draggedId);
        const targetIndex = parentNode.children.findIndex(child => child.id === targetId);
        
        if (draggedIndex === -1 || targetIndex === -1) {
            showModernToast("Alt bileÅŸenler bulunamadÄ±!", "error");
            return;
        }
        
        // Grup haritalamalarÄ±nÄ± kaydet
        const savedMappings = {};
        parentNode.children.forEach(child => {
            saveNodeGroupMappings(child, savedMappings);
        });
        
        // Alt bileÅŸenleri yeniden sÄ±rala
        const draggedChild = parentNode.children[draggedIndex];
        parentNode.children.splice(draggedIndex, 1);
        parentNode.children.splice(targetIndex, 0, draggedChild);
        
        // TÃ¼m sistemdeki ID'leri yeniden dÃ¼zenle
        const oldToNewIdMap = await reorganizeAllIds();
        
        // Grup haritalamalarÄ±nÄ± geri yÃ¼kle
        restoreGroupMappings(savedMappings, oldToNewIdMap);
        
        // AÄŸacÄ± yeniden render et
        renderTree();
        
        // DeÄŸerlendirme sekmesini gÃ¼ncelle - CRITICAL SYNC
        updateAssessmentView();
        
        console.log(`âœ… Alt bileÅŸen taÅŸÄ±ma tamamlandÄ±: ${draggedId} â†’ yeni pozisyon`);
        showModernToast("Alt bileÅŸen baÅŸarÄ±yla taÅŸÄ±ndÄ±!", "success");
        
    } catch (error) {
        console.error('âŒ Alt bileÅŸen taÅŸÄ±ma hatasÄ±:', error);
        showModernToast("Alt bileÅŸen taÅŸÄ±nÄ±rken hata oluÅŸtu!", "error");
    }
}

/**
 * Etkinlik AdÄ± DÃ¼zenleme FonksiyonlarÄ±
 */

/**
 * Etkinlik adÄ± dÃ¼zenleme modalÄ±nÄ± aÃ§
 */
function openActivityNamingModal() {
    const modal = document.getElementById('activityNamingModal');
    if (modal) {
        modal.classList.add('active');
    }
}

/**
 * Etkinlik adÄ± dÃ¼zenleme modalÄ±nÄ± kapat
 */
function closeActivityNamingModal() {
    const modal = document.getElementById('activityNamingModal');
    if (modal) {
        modal.classList.remove('active');
    }
}

/**
 * Etkinlik adlarÄ±na Vize/Final etiketlerini ekle
 */
async function applyActivityNaming() {
    const target = document.getElementById('namingTarget').value;
    const position = document.getElementById('namingPosition').value;
    const separator = document.getElementById('namingSeparator').value;
    
    console.log('ğŸ·ï¸ Etkinlik adÄ± etiketleme baÅŸlÄ±yor:', { target, position, separator });
    
    try {
        let modifiedCount = 0;
        
        // Hedef tÃ¼rÃ¼ne gÃ¶re farklÄ± iÅŸlemler
        const shouldProcessActivities = target === 'activities' || target === 'both';
        const shouldProcessComponents = target === 'components' || target === 'both';
        
        // Ana etkinlikleri iÅŸle
        if (shouldProcessActivities) {
            APP_STATE.assessmentTree.forEach(node => {
                if (!node.id.includes('.')) { // Ana etkinlik kontrolÃ¼
                    const isTermActivity = node.id.startsWith('A');
                    const isFinalActivity = node.id.startsWith('F');
                    
                    if (isTermActivity || isFinalActivity) {
                        const label = isTermActivity ? 'Vize' : 'Final';
                        const currentName = node.name || '';
                        
                        // Etiket zaten var mÄ± kontrol et
                        const hasLabel = currentName.includes(label);
                        
                        if (!hasLabel) {
                            let newName;
                            if (position === 'prefix') {
                                newName = label + separator + currentName;
                            } else {
                                newName = currentName + separator + label;
                            }
                            
                            node.name = newName;
                            modifiedCount++;
                            
                            console.log(`âœ… Ana Etkinlik ${node.id}: "${currentName}" â†’ "${newName}"`);
                        }
                    }
                }
            });
        }
        
        // Alt bileÅŸenleri iÅŸle
        if (shouldProcessComponents) {
            function processNodeChildren(node) {
                if (node.children && node.children.length > 0) {
                    node.children.forEach(child => {
                        if (child.id.includes('.')) { // Alt bileÅŸen kontrolÃ¼
                            // Ana etkinliÄŸin kategorisini belirle
                            const parentId = child.id.split('.')[0];
                            const isTermComponent = parentId.startsWith('A');
                            const isFinalComponent = parentId.startsWith('F');
                            
                            if (isTermComponent || isFinalComponent) {
                                const label = isTermComponent ? 'Vize' : 'Final';
                                const currentName = child.name || '';
                                
                                // Etiket zaten var mÄ± kontrol et
                                const hasLabel = currentName.includes(label);
                                
                                if (!hasLabel) {
                                    let newName;
                                    if (position === 'prefix') {
                                        newName = label + separator + currentName;
                                    } else {
                                        newName = currentName + separator + label;
                                    }
                                    
                                    child.name = newName;
                                    modifiedCount++;
                                    
                                    console.log(`âœ… Alt BileÅŸen ${child.id}: "${currentName}" â†’ "${newName}"`);
                                }
                            }
                        }
                        
                        // Recursive olarak alt bileÅŸenleri de iÅŸle
                        processNodeChildren(child);
                    });
                }
            }
            
            APP_STATE.assessmentTree.forEach(node => {
                processNodeChildren(node);
            });
        }
        
        if (modifiedCount > 0) {
            renderTree();

                    // DeÄŸerlendirme sekmesini gÃ¼ncelle - CRITICAL SYNC
        updateAssessmentView();
            const targetText = target === 'activities' ? 'etkinlik' : 
                             target === 'components' ? 'alt bileÅŸen' : 
                             'etkinlik ve alt bileÅŸen';
            showModernToast(`${modifiedCount} ${targetText} adÄ±na etiket eklendi!`, "success");
            closeActivityNamingModal();
        } else {
            showModernToast("HiÃ§bir ad deÄŸiÅŸtirilmedi. Etiketler zaten mevcut olabilir.", "warning");
        }
        

        
    } catch (error) {
        console.error('âŒ Etkinlik adÄ± etiketleme hatasÄ±:', error);
        showModernToast("Adlar dÃ¼zenlenirken hata oluÅŸtu!", "error");
    }
}

/**
 * Etiket temizleme modalÄ±nÄ± aÃ§
 */
function openActivityCleanupModal() {
    const modal = document.getElementById('activityCleanupModal');
    if (modal) {
        modal.classList.add('active');
    }
}

/**
 * Etiket temizleme modalÄ±nÄ± kapat
 */
function closeActivityCleanupModal() {
    const modal = document.getElementById('activityCleanupModal');
    if (modal) {
        modal.classList.remove('active');
    }
}

/**
 * Etkinlik adlarÄ±ndan Vize/Final etiketlerini temizle
 */
async function removeActivitySuffixes() {
    const target = document.getElementById('cleanupTarget').value;
    
    const targetText = target === 'activities' ? 'ana etkinlik' : 
                      target === 'components' ? 'alt bileÅŸen' : 
                      'etkinlik ve alt bileÅŸen';
    
    const confirmed = await showModernConfirm(
        'Etiket Temizleme OnayÄ±',
        `TÃ¼m ${targetText} adlarÄ±ndan "Vize" ve "Final" etiketlerini kaldÄ±rmak istediÄŸinizden emin misiniz?\\n\\nBu iÅŸlem geri alÄ±namaz.`,
        {
            confirmText: 'Evet, Temizle',
            cancelText: 'Ä°ptal',
            headerClass: 'warning-action',
            iconClass: 'warning'
        }
    );
    
    if (!confirmed) return;
    
    console.log('ğŸ§¹ Etiket temizleme baÅŸlÄ±yor...', { target });
    
    try {
        let modifiedCount = 0;
        
        // Hedef tÃ¼rÃ¼ne gÃ¶re farklÄ± iÅŸlemler
        const shouldProcessActivities = target === 'activities' || target === 'both';
        const shouldProcessComponents = target === 'components' || target === 'both';
        
        // Temizleme desenleri
        const patterns = [
            /\s*-\s*Vize\s*$/gi,
            /\s*\|\s*Vize\s*$/gi,
            /\s*\/\s*Vize\s*$/gi,
            /\s*Vize\s*$/gi,
            /^Vize\s*-\s*/gi,
            /^Vize\s*\|\s*/gi,
            /^Vize\s*\/\s*/gi,
            /^Vize\s*/gi,
            /\s*-\s*Final\s*$/gi,
            /\s*\|\s*Final\s*$/gi,
            /\s*\/\s*Final\s*$/gi,
            /\s*Final\s*$/gi,
            /^Final\s*-\s*/gi,
            /^Final\s*\|\s*/gi,
            /^Final\s*\/\s*/gi,
            /^Final\s*/gi
        ];
        
        // Ana etkinlikleri temizle
        if (shouldProcessActivities) {
            APP_STATE.assessmentTree.forEach(node => {
                if (!node.id.includes('.')) { // Ana etkinlik kontrolÃ¼
                    const isTermActivity = node.id.startsWith('A');
                    const isFinalActivity = node.id.startsWith('F');
                    
                    if (isTermActivity || isFinalActivity) {
                        const currentName = node.name || '';
                        let newName = currentName;
                        
                        patterns.forEach(pattern => {
                            newName = newName.replace(pattern, '');
                        });
                        
                        // BoÅŸ string kontrolÃ¼
                        newName = newName.trim();
                        if (!newName) {
                            newName = isTermActivity ? 'YarÄ±yÄ±l Ä°Ã§i Etkinlik' : 'YarÄ±yÄ±l Sonu Etkinlik';
                        }
                        
                        if (newName !== currentName) {
                            node.name = newName;
                            modifiedCount++;
                            
                            console.log(`âœ… Ana Etkinlik ${node.id}: "${currentName}" â†’ "${newName}"`);
                        }
                    }
                }
            });
        }
        
        // Alt bileÅŸenleri temizle
        if (shouldProcessComponents) {
            function cleanNodeChildren(node) {
                if (node.children && node.children.length > 0) {
                    node.children.forEach(child => {
                        if (child.id.includes('.')) { // Alt bileÅŸen kontrolÃ¼
                            const parentId = child.id.split('.')[0];
                            const isTermComponent = parentId.startsWith('A');
                            const isFinalComponent = parentId.startsWith('F');
                            
                            if (isTermComponent || isFinalComponent) {
                                const currentName = child.name || '';
                                let newName = currentName;
                                
                                patterns.forEach(pattern => {
                                    newName = newName.replace(pattern, '');
                                });
                                
                                // BoÅŸ string kontrolÃ¼
                                newName = newName.trim();
                                if (!newName) {
                                    newName = child.type === 'question' ? 'Soru' : 
                                             child.type === 'rubric' ? 'Rubrik' : 'Alt BileÅŸen';
                                }
                                
                                if (newName !== currentName) {
                                    child.name = newName;
                                    modifiedCount++;
                                    
                                    console.log(`âœ… Alt BileÅŸen ${child.id}: "${currentName}" â†’ "${newName}"`);
                                }
                            }
                        }
                        
                        // Recursive olarak alt bileÅŸenleri de iÅŸle
                        cleanNodeChildren(child);
                    });
                }
            }
            
            APP_STATE.assessmentTree.forEach(node => {
                cleanNodeChildren(node);
            });
        }
        
        if (modifiedCount > 0) {
            renderTree();

                    // DeÄŸerlendirme sekmesini gÃ¼ncelle - CRITICAL SYNC
        updateAssessmentView();
            showModernToast(`${modifiedCount} ${targetText} adÄ±ndan etiketler temizlendi!`, "success");
            closeActivityCleanupModal();
        } else {
            showModernToast("HiÃ§bir ad deÄŸiÅŸtirilmedi. Etiket bulunamadÄ±.", "info");
            closeActivityCleanupModal();
        }
        
    } catch (error) {
        console.error('âŒ Etiket temizleme hatasÄ±:', error);
        showModernToast("Adlar temizlenirken hata oluÅŸtu!", "error");
    }
}

// Event listener'larÄ± ekle
document.addEventListener('DOMContentLoaded', function() {
    // Vize/Final etiketleri ekle butonu
    const btnAddSuffixes = document.getElementById('btnAddActivitySuffixes');
    if (btnAddSuffixes) {
        btnAddSuffixes.addEventListener('click', openActivityNamingModal);
    }
    
    // Vize/Final etiketlerini temizle butonu
    const btnRemoveSuffixes = document.getElementById('btnRemoveActivitySuffixes');
    if (btnRemoveSuffixes) {
        btnRemoveSuffixes.addEventListener('click', openActivityCleanupModal);
    }
});


function updateGroupMappingsWithNewIds(componentId, idMapping) {
    try {
        if (!APP_STATE.courseData?.grupHaritalari || !APP_STATE.courseData.grupHaritalari[componentId]) {
            console.log(`âš ï¸ Grup haritalama verisi bulunamadÄ±: ${componentId}`);
            return;
        }
        
        console.log(`ğŸ—ºï¸ Grup haritalamalarÄ±ndaki IDler gÃ¼ncelleniyor: ${componentId}`);
        console.log(`ğŸ“‹ ID Mapping:`, idMapping);
        
        const component = APP_STATE.courseData.grupHaritalari[componentId];
        if (!component.haritalar) {
            console.log(`âš ï¸ Component mappings bulunamadÄ±: ${componentId}`);
            return;
        }
        
        let updateCount = 0;
        
        Object.keys(component.haritalar).forEach(groupName => {
            const groupMapping = component.haritalar[groupName];
            console.log(`ğŸ” ${groupName} grubu kontrol ediliyor...`, groupMapping);
            
            Object.keys(groupMapping).forEach(position => {
                const currentQuestionId = groupMapping[position];
                
                if (idMapping[currentQuestionId]) {
                    const newQuestionId = idMapping[currentQuestionId];
                    groupMapping[position] = newQuestionId;
                    updateCount++;
                    console.log(`  ğŸ“ Grup ${groupName}, Pozisyon ${position}: ${currentQuestionId} -> ${newQuestionId}`);
                }
            });
            
            console.log(`âœ… ${groupName} grubu gÃ¼ncellendi:`, groupMapping);
        });
        
        if (updateCount > 0) {
            console.log(`âœ… ${updateCount} grup haritalama IDsi gÃ¼ncellendi`);
            
            try {
                updateGroupMappingColors();
                updateAllInlineGroupInputs();
                updateAllMappingDisplays();
                console.log(`ğŸ¨ UI gÃ¼ncellemeleri tamamlandÄ±`);
            } catch (uiError) {
                console.error("UI gÃ¼ncelleme hatasÄ±:", uiError);
            }
        } else {
            console.log(`â„¹ï¸ ${componentId} iÃ§in gÃ¼ncelleme gerekmeyen grup haritalama`);
        }
        
    } catch (error) {
        console.error("Grup haritalama ID gÃ¼ncelleme hatasÄ±:", error);
        console.error("componentId:", componentId);
        console.error("idMapping:", idMapping);
    }
}

// DEBUG: Test fonksiyonu
function testGroupMappingUpdate() {
    console.log('ğŸ§ª Grup haritalama gÃ¼ncellemesi test ediliyor...');
    const testMapping = { 'A1.3': 'A1.2', 'A1.4': 'A1.3' };
    updateGroupMappingsWithNewIds('A1', testMapping);
}

window.testGroupMappingUpdate = testGroupMappingUpdate;
